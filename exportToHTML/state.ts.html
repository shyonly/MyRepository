<html>
<head>
<title>state.ts</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #6aab73;}
.s3 { color: #bcbec4;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
state.ts</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">config from </span><span class="s2">'../config'</span>
<span class="s0">import </span><span class="s1">Watcher from </span><span class="s2">'../observer/watcher'</span>
<span class="s0">import </span><span class="s1">Dep</span><span class="s3">, { </span><span class="s1">pushTarget</span><span class="s3">, </span><span class="s1">popTarget </span><span class="s3">} </span><span class="s1">from </span><span class="s2">'../observer/dep'</span>
<span class="s0">import </span><span class="s3">{ </span><span class="s1">isUpdatingChildComponent </span><span class="s3">} </span><span class="s1">from </span><span class="s2">'./lifecycle'</span>
<span class="s0">import </span><span class="s3">{ </span><span class="s1">initSetup </span><span class="s3">} </span><span class="s1">from </span><span class="s2">'v3/apiSetup'</span>

<span class="s0">import </span><span class="s3">{</span>
  <span class="s1">set</span><span class="s3">,</span>
  <span class="s1">del</span><span class="s3">,</span>
  <span class="s1">observe</span><span class="s3">,</span>
  <span class="s1">defineReactive</span><span class="s3">,</span>
  <span class="s1">toggleObserving</span>
<span class="s3">} </span><span class="s1">from </span><span class="s2">'../observer/index'</span>

<span class="s0">import </span><span class="s3">{</span>
  <span class="s1">warn</span><span class="s3">,</span>
  <span class="s1">bind</span><span class="s3">,</span>
  <span class="s1">noop</span><span class="s3">,</span>
  <span class="s1">hasOwn</span><span class="s3">,</span>
  <span class="s1">isArray</span><span class="s3">,</span>
  <span class="s1">hyphenate</span><span class="s3">,</span>
  <span class="s1">isReserved</span><span class="s3">,</span>
  <span class="s1">handleError</span><span class="s3">,</span>
  <span class="s1">nativeWatch</span><span class="s3">,</span>
  <span class="s1">validateProp</span><span class="s3">,</span>
  <span class="s1">isPlainObject</span><span class="s3">,</span>
  <span class="s1">isServerRendering</span><span class="s3">,</span>
  <span class="s1">isReservedAttribute</span><span class="s3">,</span>
  <span class="s1">invokeWithErrorHandling</span><span class="s3">,</span>
  <span class="s1">isFunction</span>
<span class="s3">} </span><span class="s1">from </span><span class="s2">'../util/index'</span>
<span class="s0">import </span><span class="s1">type </span><span class="s3">{ </span><span class="s1">Component </span><span class="s3">} </span><span class="s1">from </span><span class="s2">'types/component'</span>
<span class="s0">import </span><span class="s3">{ </span><span class="s1">shallowReactive</span><span class="s3">, </span><span class="s1">TrackOpTypes </span><span class="s3">} </span><span class="s1">from </span><span class="s2">'v3'</span>

<span class="s0">const </span><span class="s1">sharedPropertyDefinition </span><span class="s3">= {</span>
  <span class="s1">enumerable</span><span class="s3">: </span><span class="s0">true</span><span class="s3">,</span>
  <span class="s1">configurable</span><span class="s3">: </span><span class="s0">true</span><span class="s3">,</span>
  <span class="s1">get</span><span class="s3">: </span><span class="s1">noop</span><span class="s3">,</span>
  <span class="s1">set</span><span class="s3">: </span><span class="s1">noop</span>
<span class="s3">}</span>

<span class="s0">export function </span><span class="s1">proxy</span><span class="s3">(</span><span class="s1">target</span><span class="s3">: </span><span class="s1">Object</span><span class="s3">, </span><span class="s1">sourceKey</span><span class="s3">: </span><span class="s1">string</span><span class="s3">, </span><span class="s1">key</span><span class="s3">: </span><span class="s1">string</span><span class="s3">) {</span>
  <span class="s1">sharedPropertyDefinition</span><span class="s3">.</span><span class="s1">get </span><span class="s3">= </span><span class="s0">function </span><span class="s1">proxyGetter</span><span class="s3">() {</span>
    <span class="s0">return this</span><span class="s3">[</span><span class="s1">sourceKey</span><span class="s3">][</span><span class="s1">key</span><span class="s3">]</span>
  <span class="s3">}</span>
  <span class="s1">sharedPropertyDefinition</span><span class="s3">.</span><span class="s1">set </span><span class="s3">= </span><span class="s0">function </span><span class="s1">proxySetter</span><span class="s3">(</span><span class="s1">val</span><span class="s3">) {</span>
    <span class="s0">this</span><span class="s3">[</span><span class="s1">sourceKey</span><span class="s3">][</span><span class="s1">key</span><span class="s3">] = </span><span class="s1">val</span>
  <span class="s3">}</span>
  <span class="s1">Object</span><span class="s3">.</span><span class="s1">defineProperty</span><span class="s3">(</span><span class="s1">target</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s1">sharedPropertyDefinition</span><span class="s3">)</span>
<span class="s3">}</span>

<span class="s0">export function </span><span class="s1">initState</span><span class="s3">(</span><span class="s1">vm</span><span class="s3">: </span><span class="s1">Component</span><span class="s3">) {</span>
  <span class="s0">const </span><span class="s1">opts </span><span class="s3">= </span><span class="s1">vm</span><span class="s3">.</span><span class="s1">$options</span>
  <span class="s0">if </span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">props</span><span class="s3">) </span><span class="s1">initProps</span><span class="s3">(</span><span class="s1">vm</span><span class="s3">, </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">props</span><span class="s3">)</span>

  <span class="s4">// Composition API</span>
  <span class="s1">initSetup</span><span class="s3">(</span><span class="s1">vm</span><span class="s3">)</span>

  <span class="s0">if </span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">methods</span><span class="s3">) </span><span class="s1">initMethods</span><span class="s3">(</span><span class="s1">vm</span><span class="s3">, </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">methods</span><span class="s3">)</span>
  <span class="s0">if </span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">data</span><span class="s3">) {</span>
    <span class="s1">initData</span><span class="s3">(</span><span class="s1">vm</span><span class="s3">)</span>
  <span class="s3">} </span><span class="s0">else </span><span class="s3">{</span>
    <span class="s0">const </span><span class="s1">ob </span><span class="s3">= </span><span class="s1">observe</span><span class="s3">((</span><span class="s1">vm</span><span class="s3">.</span><span class="s1">_data </span><span class="s3">= {}))</span>
    <span class="s1">ob </span><span class="s3">&amp;&amp; </span><span class="s1">ob</span><span class="s3">.</span><span class="s1">vmCount</span><span class="s3">++</span>
  <span class="s3">}</span>
  <span class="s0">if </span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">computed</span><span class="s3">) </span><span class="s1">initComputed</span><span class="s3">(</span><span class="s1">vm</span><span class="s3">, </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">computed</span><span class="s3">)</span>
  <span class="s0">if </span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">watch </span><span class="s3">&amp;&amp; </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">watch </span><span class="s3">!== </span><span class="s1">nativeWatch</span><span class="s3">) {</span>
    <span class="s1">initWatch</span><span class="s3">(</span><span class="s1">vm</span><span class="s3">, </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">watch</span><span class="s3">)</span>
  <span class="s3">}</span>
<span class="s3">}</span>

<span class="s0">function </span><span class="s1">initProps</span><span class="s3">(</span><span class="s1">vm</span><span class="s3">: </span><span class="s1">Component</span><span class="s3">, </span><span class="s1">propsOptions</span><span class="s3">: </span><span class="s1">Object</span><span class="s3">) {</span>
  <span class="s0">const </span><span class="s1">propsData </span><span class="s3">= </span><span class="s1">vm</span><span class="s3">.</span><span class="s1">$options</span><span class="s3">.</span><span class="s1">propsData </span><span class="s3">|| {}</span>
  <span class="s0">const </span><span class="s1">props </span><span class="s3">= (</span><span class="s1">vm</span><span class="s3">.</span><span class="s1">_props </span><span class="s3">= </span><span class="s1">shallowReactive</span><span class="s3">({}))</span>
  <span class="s4">// cache prop keys so that future props updates can iterate using Array</span>
  <span class="s4">// instead of dynamic object key enumeration.</span>
  <span class="s0">const </span><span class="s1">keys</span><span class="s3">: </span><span class="s1">string</span><span class="s3">[] = (</span><span class="s1">vm</span><span class="s3">.</span><span class="s1">$options</span><span class="s3">.</span><span class="s1">_propKeys </span><span class="s3">= [])</span>
  <span class="s0">const </span><span class="s1">isRoot </span><span class="s3">= !</span><span class="s1">vm</span><span class="s3">.</span><span class="s1">$parent</span>
  <span class="s4">// root instance props should be converted</span>
  <span class="s0">if </span><span class="s3">(!</span><span class="s1">isRoot</span><span class="s3">) {</span>
    <span class="s1">toggleObserving</span><span class="s3">(</span><span class="s0">false</span><span class="s3">)</span>
  <span class="s3">}</span>
  <span class="s0">for </span><span class="s3">(</span><span class="s0">const </span><span class="s1">key </span><span class="s0">in </span><span class="s1">propsOptions</span><span class="s3">) {</span>
    <span class="s1">keys</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">key</span><span class="s3">)</span>
    <span class="s0">const </span><span class="s1">value </span><span class="s3">= </span><span class="s1">validateProp</span><span class="s3">(</span><span class="s1">key</span><span class="s3">, </span><span class="s1">propsOptions</span><span class="s3">, </span><span class="s1">propsData</span><span class="s3">, </span><span class="s1">vm</span><span class="s3">)</span>
    <span class="s4">/* istanbul ignore else */</span>
    <span class="s0">if </span><span class="s3">(</span><span class="s1">__DEV__</span><span class="s3">) {</span>
      <span class="s0">const </span><span class="s1">hyphenatedKey </span><span class="s3">= </span><span class="s1">hyphenate</span><span class="s3">(</span><span class="s1">key</span><span class="s3">)</span>
      <span class="s0">if </span><span class="s3">(</span>
        <span class="s1">isReservedAttribute</span><span class="s3">(</span><span class="s1">hyphenatedKey</span><span class="s3">) ||</span>
        <span class="s1">config</span><span class="s3">.</span><span class="s1">isReservedAttr</span><span class="s3">(</span><span class="s1">hyphenatedKey</span><span class="s3">)</span>
      <span class="s3">) {</span>
        <span class="s1">warn</span><span class="s3">(</span>
          <span class="s2">`&quot;</span><span class="s1">$</span><span class="s3">{</span><span class="s1">hyphenatedKey</span><span class="s3">}</span><span class="s2">&quot; is a reserved attribute and cannot be used as component prop.`</span><span class="s3">,</span>
          <span class="s1">vm</span>
        <span class="s3">)</span>
      <span class="s3">}</span>
      <span class="s1">defineReactive</span><span class="s3">(</span><span class="s1">props</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s1">value</span><span class="s3">, () =&gt; {</span>
        <span class="s0">if </span><span class="s3">(!</span><span class="s1">isRoot </span><span class="s3">&amp;&amp; !</span><span class="s1">isUpdatingChildComponent</span><span class="s3">) {</span>
          <span class="s1">warn</span><span class="s3">(</span>
            <span class="s2">`Avoid mutating a prop directly since the value will be ` </span><span class="s3">+</span>
              <span class="s2">`overwritten whenever the parent component re-renders. ` </span><span class="s3">+</span>
              <span class="s2">`Instead, use a data or computed property based on the prop's ` </span><span class="s3">+</span>
              <span class="s2">`value. Prop being mutated: &quot;</span><span class="s1">$</span><span class="s3">{</span><span class="s1">key</span><span class="s3">}</span><span class="s2">&quot;`</span><span class="s3">,</span>
            <span class="s1">vm</span>
          <span class="s3">)</span>
        <span class="s3">}</span>
      <span class="s3">})</span>
    <span class="s3">} </span><span class="s0">else </span><span class="s3">{</span>
      <span class="s1">defineReactive</span><span class="s3">(</span><span class="s1">props</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s1">value</span><span class="s3">)</span>
    <span class="s3">}</span>
    <span class="s4">// static props are already proxied on the component's prototype</span>
    <span class="s4">// during Vue.extend(). We only need to proxy props defined at</span>
    <span class="s4">// instantiation here.</span>
    <span class="s0">if </span><span class="s3">(!(</span><span class="s1">key </span><span class="s0">in </span><span class="s1">vm</span><span class="s3">)) {</span>
      <span class="s1">proxy</span><span class="s3">(</span><span class="s1">vm</span><span class="s3">, </span><span class="s2">`_props`</span><span class="s3">, </span><span class="s1">key</span><span class="s3">)</span>
    <span class="s3">}</span>
  <span class="s3">}</span>
  <span class="s1">toggleObserving</span><span class="s3">(</span><span class="s0">true</span><span class="s3">)</span>
<span class="s3">}</span>

<span class="s0">function </span><span class="s1">initData</span><span class="s3">(</span><span class="s1">vm</span><span class="s3">: </span><span class="s1">Component</span><span class="s3">) {</span>
  <span class="s0">let </span><span class="s1">data</span><span class="s3">: </span><span class="s1">any </span><span class="s3">= </span><span class="s1">vm</span><span class="s3">.</span><span class="s1">$options</span><span class="s3">.</span><span class="s1">data</span>
  <span class="s1">data </span><span class="s3">= </span><span class="s1">vm</span><span class="s3">.</span><span class="s1">_data </span><span class="s3">= </span><span class="s1">isFunction</span><span class="s3">(</span><span class="s1">data</span><span class="s3">) ? </span><span class="s1">getData</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">vm</span><span class="s3">) : </span><span class="s1">data </span><span class="s3">|| {}</span>
  <span class="s0">if </span><span class="s3">(!</span><span class="s1">isPlainObject</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)) {</span>
    <span class="s1">data </span><span class="s3">= {}</span>
    <span class="s1">__DEV__ </span><span class="s3">&amp;&amp;</span>
      <span class="s1">warn</span><span class="s3">(</span>
        <span class="s2">'data functions should return an object:</span><span class="s0">\n</span><span class="s2">' </span><span class="s3">+</span>
          <span class="s2">'https://v2.vuejs.org/v2/guide/components.html#data-Must-Be-a-Function'</span><span class="s3">,</span>
        <span class="s1">vm</span>
      <span class="s3">)</span>
  <span class="s3">}</span>
  <span class="s4">// proxy data on instance</span>
  <span class="s0">const </span><span class="s1">keys </span><span class="s3">= </span><span class="s1">Object</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>
  <span class="s0">const </span><span class="s1">props </span><span class="s3">= </span><span class="s1">vm</span><span class="s3">.</span><span class="s1">$options</span><span class="s3">.</span><span class="s1">props</span>
  <span class="s0">const </span><span class="s1">methods </span><span class="s3">= </span><span class="s1">vm</span><span class="s3">.</span><span class="s1">$options</span><span class="s3">.</span><span class="s1">methods</span>
  <span class="s0">let </span><span class="s1">i </span><span class="s3">= </span><span class="s1">keys</span><span class="s3">.</span><span class="s1">length</span>
  <span class="s0">while </span><span class="s3">(</span><span class="s1">i</span><span class="s3">--) {</span>
    <span class="s0">const </span><span class="s1">key </span><span class="s3">= </span><span class="s1">keys</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]</span>
    <span class="s0">if </span><span class="s3">(</span><span class="s1">__DEV__</span><span class="s3">) {</span>
      <span class="s0">if </span><span class="s3">(</span><span class="s1">methods </span><span class="s3">&amp;&amp; </span><span class="s1">hasOwn</span><span class="s3">(</span><span class="s1">methods</span><span class="s3">, </span><span class="s1">key</span><span class="s3">)) {</span>
        <span class="s1">warn</span><span class="s3">(</span><span class="s2">`Method &quot;</span><span class="s1">$</span><span class="s3">{</span><span class="s1">key</span><span class="s3">}</span><span class="s2">&quot; has already been defined as a data property.`</span><span class="s3">, </span><span class="s1">vm</span><span class="s3">)</span>
      <span class="s3">}</span>
    <span class="s3">}</span>
    <span class="s0">if </span><span class="s3">(</span><span class="s1">props </span><span class="s3">&amp;&amp; </span><span class="s1">hasOwn</span><span class="s3">(</span><span class="s1">props</span><span class="s3">, </span><span class="s1">key</span><span class="s3">)) {</span>
      <span class="s1">__DEV__ </span><span class="s3">&amp;&amp;</span>
        <span class="s1">warn</span><span class="s3">(</span>
          <span class="s2">`The data property &quot;</span><span class="s1">$</span><span class="s3">{</span><span class="s1">key</span><span class="s3">}</span><span class="s2">&quot; is already declared as a prop. ` </span><span class="s3">+</span>
            <span class="s2">`Use prop default value instead.`</span><span class="s3">,</span>
          <span class="s1">vm</span>
        <span class="s3">)</span>
    <span class="s3">} </span><span class="s0">else if </span><span class="s3">(!</span><span class="s1">isReserved</span><span class="s3">(</span><span class="s1">key</span><span class="s3">)) {</span>
      <span class="s1">proxy</span><span class="s3">(</span><span class="s1">vm</span><span class="s3">, </span><span class="s2">`_data`</span><span class="s3">, </span><span class="s1">key</span><span class="s3">)</span>
    <span class="s3">}</span>
  <span class="s3">}</span>
  <span class="s4">// observe data</span>
  <span class="s0">const </span><span class="s1">ob </span><span class="s3">= </span><span class="s1">observe</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>
  <span class="s1">ob </span><span class="s3">&amp;&amp; </span><span class="s1">ob</span><span class="s3">.</span><span class="s1">vmCount</span><span class="s3">++</span>
<span class="s3">}</span>

<span class="s0">export function </span><span class="s1">getData</span><span class="s3">(</span><span class="s1">data</span><span class="s3">: </span><span class="s1">Function</span><span class="s3">, </span><span class="s1">vm</span><span class="s3">: </span><span class="s1">Component</span><span class="s3">): </span><span class="s1">any </span><span class="s3">{</span>
  <span class="s4">// #7573 disable dep collection when invoking data getters</span>
  <span class="s1">pushTarget</span><span class="s3">()</span>
  <span class="s0">try </span><span class="s3">{</span>
    <span class="s0">return </span><span class="s1">data</span><span class="s3">.</span><span class="s1">call</span><span class="s3">(</span><span class="s1">vm</span><span class="s3">, </span><span class="s1">vm</span><span class="s3">)</span>
  <span class="s3">} </span><span class="s0">catch </span><span class="s3">(</span><span class="s1">e</span><span class="s3">: </span><span class="s1">any</span><span class="s3">) {</span>
    <span class="s1">handleError</span><span class="s3">(</span><span class="s1">e</span><span class="s3">, </span><span class="s1">vm</span><span class="s3">, </span><span class="s2">`data()`</span><span class="s3">)</span>
    <span class="s0">return </span><span class="s3">{}</span>
  <span class="s3">} </span><span class="s0">finally </span><span class="s3">{</span>
    <span class="s1">popTarget</span><span class="s3">()</span>
  <span class="s3">}</span>
<span class="s3">}</span>

<span class="s0">const </span><span class="s1">computedWatcherOptions </span><span class="s3">= { </span><span class="s1">lazy</span><span class="s3">: </span><span class="s0">true </span><span class="s3">}</span>

<span class="s0">function </span><span class="s1">initComputed</span><span class="s3">(</span><span class="s1">vm</span><span class="s3">: </span><span class="s1">Component</span><span class="s3">, </span><span class="s1">computed</span><span class="s3">: </span><span class="s1">Object</span><span class="s3">) {</span>
  <span class="s4">// $flow-disable-line</span>
  <span class="s0">const </span><span class="s1">watchers </span><span class="s3">= (</span><span class="s1">vm</span><span class="s3">.</span><span class="s1">_computedWatchers </span><span class="s3">= </span><span class="s1">Object</span><span class="s3">.</span><span class="s1">create</span><span class="s3">(</span><span class="s0">null</span><span class="s3">))</span>
  <span class="s4">// computed properties are just getters during SSR</span>
  <span class="s0">const </span><span class="s1">isSSR </span><span class="s3">= </span><span class="s1">isServerRendering</span><span class="s3">()</span>

  <span class="s0">for </span><span class="s3">(</span><span class="s0">const </span><span class="s1">key </span><span class="s0">in </span><span class="s1">computed</span><span class="s3">) {</span>
    <span class="s0">const </span><span class="s1">userDef </span><span class="s3">= </span><span class="s1">computed</span><span class="s3">[</span><span class="s1">key</span><span class="s3">]</span>
    <span class="s0">const </span><span class="s1">getter </span><span class="s3">= </span><span class="s1">isFunction</span><span class="s3">(</span><span class="s1">userDef</span><span class="s3">) ? </span><span class="s1">userDef </span><span class="s3">: </span><span class="s1">userDef</span><span class="s3">.</span><span class="s1">get</span>
    <span class="s0">if </span><span class="s3">(</span><span class="s1">__DEV__ </span><span class="s3">&amp;&amp; </span><span class="s1">getter </span><span class="s3">== </span><span class="s0">null</span><span class="s3">) {</span>
      <span class="s1">warn</span><span class="s3">(</span><span class="s2">`Getter is missing for computed property &quot;</span><span class="s1">$</span><span class="s3">{</span><span class="s1">key</span><span class="s3">}</span><span class="s2">&quot;.`</span><span class="s3">, </span><span class="s1">vm</span><span class="s3">)</span>
    <span class="s3">}</span>

    <span class="s0">if </span><span class="s3">(!</span><span class="s1">isSSR</span><span class="s3">) {</span>
      <span class="s4">// create internal watcher for the computed property.</span>
      <span class="s1">watchers</span><span class="s3">[</span><span class="s1">key</span><span class="s3">] = </span><span class="s0">new </span><span class="s1">Watcher</span><span class="s3">(</span>
        <span class="s1">vm</span><span class="s3">,</span>
        <span class="s1">getter </span><span class="s3">|| </span><span class="s1">noop</span><span class="s3">,</span>
        <span class="s1">noop</span><span class="s3">,</span>
        <span class="s1">computedWatcherOptions</span>
      <span class="s3">)</span>
    <span class="s3">}</span>

    <span class="s4">// component-defined computed properties are already defined on the</span>
    <span class="s4">// component prototype. We only need to define computed properties defined</span>
    <span class="s4">// at instantiation here.</span>
    <span class="s0">if </span><span class="s3">(!(</span><span class="s1">key </span><span class="s0">in </span><span class="s1">vm</span><span class="s3">)) {</span>
      <span class="s1">defineComputed</span><span class="s3">(</span><span class="s1">vm</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s1">userDef</span><span class="s3">)</span>
    <span class="s3">} </span><span class="s0">else if </span><span class="s3">(</span><span class="s1">__DEV__</span><span class="s3">) {</span>
      <span class="s0">if </span><span class="s3">(</span><span class="s1">key </span><span class="s0">in </span><span class="s1">vm</span><span class="s3">.</span><span class="s1">$data</span><span class="s3">) {</span>
        <span class="s1">warn</span><span class="s3">(</span><span class="s2">`The computed property &quot;</span><span class="s1">$</span><span class="s3">{</span><span class="s1">key</span><span class="s3">}</span><span class="s2">&quot; is already defined in data.`</span><span class="s3">, </span><span class="s1">vm</span><span class="s3">)</span>
      <span class="s3">} </span><span class="s0">else if </span><span class="s3">(</span><span class="s1">vm</span><span class="s3">.</span><span class="s1">$options</span><span class="s3">.</span><span class="s1">props </span><span class="s3">&amp;&amp; </span><span class="s1">key </span><span class="s0">in </span><span class="s1">vm</span><span class="s3">.</span><span class="s1">$options</span><span class="s3">.</span><span class="s1">props</span><span class="s3">) {</span>
        <span class="s1">warn</span><span class="s3">(</span><span class="s2">`The computed property &quot;</span><span class="s1">$</span><span class="s3">{</span><span class="s1">key</span><span class="s3">}</span><span class="s2">&quot; is already defined as a prop.`</span><span class="s3">, </span><span class="s1">vm</span><span class="s3">)</span>
      <span class="s3">} </span><span class="s0">else if </span><span class="s3">(</span><span class="s1">vm</span><span class="s3">.</span><span class="s1">$options</span><span class="s3">.</span><span class="s1">methods </span><span class="s3">&amp;&amp; </span><span class="s1">key </span><span class="s0">in </span><span class="s1">vm</span><span class="s3">.</span><span class="s1">$options</span><span class="s3">.</span><span class="s1">methods</span><span class="s3">) {</span>
        <span class="s1">warn</span><span class="s3">(</span>
          <span class="s2">`The computed property &quot;</span><span class="s1">$</span><span class="s3">{</span><span class="s1">key</span><span class="s3">}</span><span class="s2">&quot; is already defined as a method.`</span><span class="s3">,</span>
          <span class="s1">vm</span>
        <span class="s3">)</span>
      <span class="s3">}</span>
    <span class="s3">}</span>
  <span class="s3">}</span>
<span class="s3">}</span>

<span class="s0">export function </span><span class="s1">defineComputed</span><span class="s3">(</span>
  <span class="s1">target</span><span class="s3">: </span><span class="s1">any</span><span class="s3">,</span>
  <span class="s1">key</span><span class="s3">: </span><span class="s1">string</span><span class="s3">,</span>
  <span class="s1">userDef</span><span class="s3">: </span><span class="s1">Record</span><span class="s3">&lt;</span><span class="s1">string</span><span class="s3">, </span><span class="s1">any</span><span class="s3">&gt; | (() =&gt; </span><span class="s1">any</span><span class="s3">)</span>
<span class="s3">) {</span>
  <span class="s0">const </span><span class="s1">shouldCache </span><span class="s3">= !</span><span class="s1">isServerRendering</span><span class="s3">()</span>
  <span class="s0">if </span><span class="s3">(</span><span class="s1">isFunction</span><span class="s3">(</span><span class="s1">userDef</span><span class="s3">)) {</span>
    <span class="s1">sharedPropertyDefinition</span><span class="s3">.</span><span class="s1">get </span><span class="s3">= </span><span class="s1">shouldCache</span>
      <span class="s3">? </span><span class="s1">createComputedGetter</span><span class="s3">(</span><span class="s1">key</span><span class="s3">)</span>
      <span class="s3">: </span><span class="s1">createGetterInvoker</span><span class="s3">(</span><span class="s1">userDef</span><span class="s3">)</span>
    <span class="s1">sharedPropertyDefinition</span><span class="s3">.</span><span class="s1">set </span><span class="s3">= </span><span class="s1">noop</span>
  <span class="s3">} </span><span class="s0">else </span><span class="s3">{</span>
    <span class="s1">sharedPropertyDefinition</span><span class="s3">.</span><span class="s1">get </span><span class="s3">= </span><span class="s1">userDef</span><span class="s3">.</span><span class="s1">get</span>
      <span class="s3">? </span><span class="s1">shouldCache </span><span class="s3">&amp;&amp; </span><span class="s1">userDef</span><span class="s3">.</span><span class="s1">cache </span><span class="s3">!== </span><span class="s0">false</span>
        <span class="s3">? </span><span class="s1">createComputedGetter</span><span class="s3">(</span><span class="s1">key</span><span class="s3">)</span>
        <span class="s3">: </span><span class="s1">createGetterInvoker</span><span class="s3">(</span><span class="s1">userDef</span><span class="s3">.</span><span class="s1">get</span><span class="s3">)</span>
      <span class="s3">: </span><span class="s1">noop</span>
    <span class="s1">sharedPropertyDefinition</span><span class="s3">.</span><span class="s1">set </span><span class="s3">= </span><span class="s1">userDef</span><span class="s3">.</span><span class="s1">set </span><span class="s3">|| </span><span class="s1">noop</span>
  <span class="s3">}</span>
  <span class="s0">if </span><span class="s3">(</span><span class="s1">__DEV__ </span><span class="s3">&amp;&amp; </span><span class="s1">sharedPropertyDefinition</span><span class="s3">.</span><span class="s1">set </span><span class="s3">=== </span><span class="s1">noop</span><span class="s3">) {</span>
    <span class="s1">sharedPropertyDefinition</span><span class="s3">.</span><span class="s1">set </span><span class="s3">= </span><span class="s0">function </span><span class="s3">() {</span>
      <span class="s1">warn</span><span class="s3">(</span>
        <span class="s2">`Computed property &quot;</span><span class="s1">$</span><span class="s3">{</span><span class="s1">key</span><span class="s3">}</span><span class="s2">&quot; was assigned to but it has no setter.`</span><span class="s3">,</span>
        <span class="s0">this</span>
      <span class="s3">)</span>
    <span class="s3">}</span>
  <span class="s3">}</span>
  <span class="s1">Object</span><span class="s3">.</span><span class="s1">defineProperty</span><span class="s3">(</span><span class="s1">target</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s1">sharedPropertyDefinition</span><span class="s3">)</span>
<span class="s3">}</span>

<span class="s0">function </span><span class="s1">createComputedGetter</span><span class="s3">(</span><span class="s1">key</span><span class="s3">) {</span>
  <span class="s0">return function </span><span class="s1">computedGetter</span><span class="s3">() {</span>
    <span class="s0">const </span><span class="s1">watcher </span><span class="s3">= </span><span class="s0">this</span><span class="s3">.</span><span class="s1">_computedWatchers </span><span class="s3">&amp;&amp; </span><span class="s0">this</span><span class="s3">.</span><span class="s1">_computedWatchers</span><span class="s3">[</span><span class="s1">key</span><span class="s3">]</span>
    <span class="s0">if </span><span class="s3">(</span><span class="s1">watcher</span><span class="s3">) {</span>
      <span class="s0">if </span><span class="s3">(</span><span class="s1">watcher</span><span class="s3">.</span><span class="s1">dirty</span><span class="s3">) {</span>
        <span class="s1">watcher</span><span class="s3">.</span><span class="s1">evaluate</span><span class="s3">()</span>
      <span class="s3">}</span>
      <span class="s0">if </span><span class="s3">(</span><span class="s1">Dep</span><span class="s3">.</span><span class="s1">target</span><span class="s3">) {</span>
        <span class="s0">if </span><span class="s3">(</span><span class="s1">__DEV__ </span><span class="s3">&amp;&amp; </span><span class="s1">Dep</span><span class="s3">.</span><span class="s1">target</span><span class="s3">.</span><span class="s1">onTrack</span><span class="s3">) {</span>
          <span class="s1">Dep</span><span class="s3">.</span><span class="s1">target</span><span class="s3">.</span><span class="s1">onTrack</span><span class="s3">({</span>
            <span class="s1">effect</span><span class="s3">: </span><span class="s1">Dep</span><span class="s3">.</span><span class="s1">target</span><span class="s3">,</span>
            <span class="s1">target</span><span class="s3">: </span><span class="s0">this</span><span class="s3">,</span>
            <span class="s1">type</span><span class="s3">: </span><span class="s1">TrackOpTypes</span><span class="s3">.</span><span class="s1">GET</span><span class="s3">,</span>
            <span class="s1">key</span>
          <span class="s3">})</span>
        <span class="s3">}</span>
        <span class="s1">watcher</span><span class="s3">.</span><span class="s1">depend</span><span class="s3">()</span>
      <span class="s3">}</span>
      <span class="s0">return </span><span class="s1">watcher</span><span class="s3">.</span><span class="s1">value</span>
    <span class="s3">}</span>
  <span class="s3">}</span>
<span class="s3">}</span>

<span class="s0">function </span><span class="s1">createGetterInvoker</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">) {</span>
  <span class="s0">return function </span><span class="s1">computedGetter</span><span class="s3">() {</span>
    <span class="s0">return </span><span class="s1">fn</span><span class="s3">.</span><span class="s1">call</span><span class="s3">(</span><span class="s0">this</span><span class="s3">, </span><span class="s0">this</span><span class="s3">)</span>
  <span class="s3">}</span>
<span class="s3">}</span>

<span class="s0">function </span><span class="s1">initMethods</span><span class="s3">(</span><span class="s1">vm</span><span class="s3">: </span><span class="s1">Component</span><span class="s3">, </span><span class="s1">methods</span><span class="s3">: </span><span class="s1">Object</span><span class="s3">) {</span>
  <span class="s0">const </span><span class="s1">props </span><span class="s3">= </span><span class="s1">vm</span><span class="s3">.</span><span class="s1">$options</span><span class="s3">.</span><span class="s1">props</span>
  <span class="s0">for </span><span class="s3">(</span><span class="s0">const </span><span class="s1">key </span><span class="s0">in </span><span class="s1">methods</span><span class="s3">) {</span>
    <span class="s0">if </span><span class="s3">(</span><span class="s1">__DEV__</span><span class="s3">) {</span>
      <span class="s0">if </span><span class="s3">(</span><span class="s0">typeof </span><span class="s1">methods</span><span class="s3">[</span><span class="s1">key</span><span class="s3">] !== </span><span class="s2">'function'</span><span class="s3">) {</span>
        <span class="s1">warn</span><span class="s3">(</span>
          <span class="s2">`Method &quot;</span><span class="s1">$</span><span class="s3">{</span><span class="s1">key</span><span class="s3">}</span><span class="s2">&quot; has type &quot;</span><span class="s1">$</span><span class="s3">{</span><span class="s0">typeof </span><span class="s1">methods</span><span class="s3">[</span>
            <span class="s1">key</span>
          <span class="s3">]}</span><span class="s2">&quot; in the component definition. ` </span><span class="s3">+</span>
            <span class="s2">`Did you reference the function correctly?`</span><span class="s3">,</span>
          <span class="s1">vm</span>
        <span class="s3">)</span>
      <span class="s3">}</span>
      <span class="s0">if </span><span class="s3">(</span><span class="s1">props </span><span class="s3">&amp;&amp; </span><span class="s1">hasOwn</span><span class="s3">(</span><span class="s1">props</span><span class="s3">, </span><span class="s1">key</span><span class="s3">)) {</span>
        <span class="s1">warn</span><span class="s3">(</span><span class="s2">`Method &quot;</span><span class="s1">$</span><span class="s3">{</span><span class="s1">key</span><span class="s3">}</span><span class="s2">&quot; has already been defined as a prop.`</span><span class="s3">, </span><span class="s1">vm</span><span class="s3">)</span>
      <span class="s3">}</span>
      <span class="s0">if </span><span class="s3">(</span><span class="s1">key </span><span class="s0">in </span><span class="s1">vm </span><span class="s3">&amp;&amp; </span><span class="s1">isReserved</span><span class="s3">(</span><span class="s1">key</span><span class="s3">)) {</span>
        <span class="s1">warn</span><span class="s3">(</span>
          <span class="s2">`Method &quot;</span><span class="s1">$</span><span class="s3">{</span><span class="s1">key</span><span class="s3">}</span><span class="s2">&quot; conflicts with an existing Vue instance method. ` </span><span class="s3">+</span>
            <span class="s2">`Avoid defining component methods that start with _ or $.`</span>
        <span class="s3">)</span>
      <span class="s3">}</span>
    <span class="s3">}</span>
    <span class="s1">vm</span><span class="s3">[</span><span class="s1">key</span><span class="s3">] = </span><span class="s0">typeof </span><span class="s1">methods</span><span class="s3">[</span><span class="s1">key</span><span class="s3">] !== </span><span class="s2">'function' </span><span class="s3">? </span><span class="s1">noop </span><span class="s3">: </span><span class="s1">bind</span><span class="s3">(</span><span class="s1">methods</span><span class="s3">[</span><span class="s1">key</span><span class="s3">], </span><span class="s1">vm</span><span class="s3">)</span>
  <span class="s3">}</span>
<span class="s3">}</span>

<span class="s0">function </span><span class="s1">initWatch</span><span class="s3">(</span><span class="s1">vm</span><span class="s3">: </span><span class="s1">Component</span><span class="s3">, </span><span class="s1">watch</span><span class="s3">: </span><span class="s1">Object</span><span class="s3">) {</span>
  <span class="s0">for </span><span class="s3">(</span><span class="s0">const </span><span class="s1">key </span><span class="s0">in </span><span class="s1">watch</span><span class="s3">) {</span>
    <span class="s0">const </span><span class="s1">handler </span><span class="s3">= </span><span class="s1">watch</span><span class="s3">[</span><span class="s1">key</span><span class="s3">]</span>
    <span class="s0">if </span><span class="s3">(</span><span class="s1">isArray</span><span class="s3">(</span><span class="s1">handler</span><span class="s3">)) {</span>
      <span class="s0">for </span><span class="s3">(</span><span class="s0">let </span><span class="s1">i </span><span class="s3">= </span><span class="s5">0</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">handler</span><span class="s3">.</span><span class="s1">length</span><span class="s3">; </span><span class="s1">i</span><span class="s3">++) {</span>
        <span class="s1">createWatcher</span><span class="s3">(</span><span class="s1">vm</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s1">handler</span><span class="s3">[</span><span class="s1">i</span><span class="s3">])</span>
      <span class="s3">}</span>
    <span class="s3">} </span><span class="s0">else </span><span class="s3">{</span>
      <span class="s1">createWatcher</span><span class="s3">(</span><span class="s1">vm</span><span class="s3">, </span><span class="s1">key</span><span class="s3">, </span><span class="s1">handler</span><span class="s3">)</span>
    <span class="s3">}</span>
  <span class="s3">}</span>
<span class="s3">}</span>

<span class="s0">function </span><span class="s1">createWatcher</span><span class="s3">(</span>
  <span class="s1">vm</span><span class="s3">: </span><span class="s1">Component</span><span class="s3">,</span>
  <span class="s1">expOrFn</span><span class="s3">: </span><span class="s1">string </span><span class="s3">| (() =&gt; </span><span class="s1">any</span><span class="s3">),</span>
  <span class="s1">handler</span><span class="s3">: </span><span class="s1">any</span><span class="s3">,</span>
  <span class="s1">options</span><span class="s3">?: </span><span class="s1">Object</span>
<span class="s3">) {</span>
  <span class="s0">if </span><span class="s3">(</span><span class="s1">isPlainObject</span><span class="s3">(</span><span class="s1">handler</span><span class="s3">)) {</span>
    <span class="s1">options </span><span class="s3">= </span><span class="s1">handler</span>
    <span class="s1">handler </span><span class="s3">= </span><span class="s1">handler</span><span class="s3">.</span><span class="s1">handler</span>
  <span class="s3">}</span>
  <span class="s0">if </span><span class="s3">(</span><span class="s0">typeof </span><span class="s1">handler </span><span class="s3">=== </span><span class="s2">'string'</span><span class="s3">) {</span>
    <span class="s1">handler </span><span class="s3">= </span><span class="s1">vm</span><span class="s3">[</span><span class="s1">handler</span><span class="s3">]</span>
  <span class="s3">}</span>
  <span class="s0">return </span><span class="s1">vm</span><span class="s3">.</span><span class="s1">$watch</span><span class="s3">(</span><span class="s1">expOrFn</span><span class="s3">, </span><span class="s1">handler</span><span class="s3">, </span><span class="s1">options</span><span class="s3">)</span>
<span class="s3">}</span>

<span class="s0">export function </span><span class="s1">stateMixin</span><span class="s3">(</span><span class="s1">Vue</span><span class="s3">: </span><span class="s0">typeof </span><span class="s1">Component</span><span class="s3">) {</span>
  <span class="s4">// flow somehow has problems with directly declared definition object</span>
  <span class="s4">// when using Object.defineProperty, so we have to procedurally build up</span>
  <span class="s4">// the object here.</span>
  <span class="s0">const </span><span class="s1">dataDef</span><span class="s3">: </span><span class="s1">any </span><span class="s3">= {}</span>
  <span class="s1">dataDef</span><span class="s3">.</span><span class="s1">get </span><span class="s3">= </span><span class="s0">function </span><span class="s3">() {</span>
    <span class="s0">return this</span><span class="s3">.</span><span class="s1">_data</span>
  <span class="s3">}</span>
  <span class="s0">const </span><span class="s1">propsDef</span><span class="s3">: </span><span class="s1">any </span><span class="s3">= {}</span>
  <span class="s1">propsDef</span><span class="s3">.</span><span class="s1">get </span><span class="s3">= </span><span class="s0">function </span><span class="s3">() {</span>
    <span class="s0">return this</span><span class="s3">.</span><span class="s1">_props</span>
  <span class="s3">}</span>
  <span class="s0">if </span><span class="s3">(</span><span class="s1">__DEV__</span><span class="s3">) {</span>
    <span class="s1">dataDef</span><span class="s3">.</span><span class="s1">set </span><span class="s3">= </span><span class="s0">function </span><span class="s3">() {</span>
      <span class="s1">warn</span><span class="s3">(</span>
        <span class="s2">'Avoid replacing instance root $data. ' </span><span class="s3">+</span>
          <span class="s2">'Use nested data properties instead.'</span><span class="s3">,</span>
        <span class="s0">this</span>
      <span class="s3">)</span>
    <span class="s3">}</span>
    <span class="s1">propsDef</span><span class="s3">.</span><span class="s1">set </span><span class="s3">= </span><span class="s0">function </span><span class="s3">() {</span>
      <span class="s1">warn</span><span class="s3">(</span><span class="s2">`$props is readonly.`</span><span class="s3">, </span><span class="s0">this</span><span class="s3">)</span>
    <span class="s3">}</span>
  <span class="s3">}</span>
  <span class="s1">Object</span><span class="s3">.</span><span class="s1">defineProperty</span><span class="s3">(</span><span class="s1">Vue</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">, </span><span class="s2">'$data'</span><span class="s3">, </span><span class="s1">dataDef</span><span class="s3">)</span>
  <span class="s1">Object</span><span class="s3">.</span><span class="s1">defineProperty</span><span class="s3">(</span><span class="s1">Vue</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">, </span><span class="s2">'$props'</span><span class="s3">, </span><span class="s1">propsDef</span><span class="s3">)</span>

  <span class="s1">Vue</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">$set </span><span class="s3">= </span><span class="s1">set</span>
  <span class="s1">Vue</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">$delete </span><span class="s3">= </span><span class="s1">del</span>

  <span class="s1">Vue</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">$watch </span><span class="s3">= </span><span class="s0">function </span><span class="s3">(</span>
    <span class="s1">expOrFn</span><span class="s3">: </span><span class="s1">string </span><span class="s3">| (() =&gt; </span><span class="s1">any</span><span class="s3">),</span>
    <span class="s1">cb</span><span class="s3">: </span><span class="s1">any</span><span class="s3">,</span>
    <span class="s1">options</span><span class="s3">?: </span><span class="s1">Record</span><span class="s3">&lt;</span><span class="s1">string</span><span class="s3">, </span><span class="s1">any</span><span class="s3">&gt;</span>
  <span class="s3">): </span><span class="s1">Function </span><span class="s3">{</span>
    <span class="s0">const </span><span class="s1">vm</span><span class="s3">: </span><span class="s1">Component </span><span class="s3">= </span><span class="s0">this</span>
    <span class="s0">if </span><span class="s3">(</span><span class="s1">isPlainObject</span><span class="s3">(</span><span class="s1">cb</span><span class="s3">)) {</span>
      <span class="s0">return </span><span class="s1">createWatcher</span><span class="s3">(</span><span class="s1">vm</span><span class="s3">, </span><span class="s1">expOrFn</span><span class="s3">, </span><span class="s1">cb</span><span class="s3">, </span><span class="s1">options</span><span class="s3">)</span>
    <span class="s3">}</span>
    <span class="s1">options </span><span class="s3">= </span><span class="s1">options </span><span class="s3">|| {}</span>
    <span class="s1">options</span><span class="s3">.</span><span class="s1">user </span><span class="s3">= </span><span class="s0">true</span>
    <span class="s0">const </span><span class="s1">watcher </span><span class="s3">= </span><span class="s0">new </span><span class="s1">Watcher</span><span class="s3">(</span><span class="s1">vm</span><span class="s3">, </span><span class="s1">expOrFn</span><span class="s3">, </span><span class="s1">cb</span><span class="s3">, </span><span class="s1">options</span><span class="s3">)</span>
    <span class="s0">if </span><span class="s3">(</span><span class="s1">options</span><span class="s3">.</span><span class="s1">immediate</span><span class="s3">) {</span>
      <span class="s0">const </span><span class="s1">info </span><span class="s3">= </span><span class="s2">`callback for immediate watcher &quot;</span><span class="s1">$</span><span class="s3">{</span><span class="s1">watcher</span><span class="s3">.</span><span class="s1">expression</span><span class="s3">}</span><span class="s2">&quot;`</span>
      <span class="s1">pushTarget</span><span class="s3">()</span>
      <span class="s1">invokeWithErrorHandling</span><span class="s3">(</span><span class="s1">cb</span><span class="s3">, </span><span class="s1">vm</span><span class="s3">, [</span><span class="s1">watcher</span><span class="s3">.</span><span class="s1">value</span><span class="s3">], </span><span class="s1">vm</span><span class="s3">, </span><span class="s1">info</span><span class="s3">)</span>
      <span class="s1">popTarget</span><span class="s3">()</span>
    <span class="s3">}</span>
    <span class="s0">return function </span><span class="s1">unwatchFn</span><span class="s3">() {</span>
      <span class="s1">watcher</span><span class="s3">.</span><span class="s1">teardown</span><span class="s3">()</span>
    <span class="s3">}</span>
  <span class="s3">}</span>
<span class="s3">}</span>
</pre>
</body>
</html>