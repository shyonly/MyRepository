<html>
<head>
<title>web.url.constructor.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #6aab73;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #cf8e6d;}
.s5 { color: #42c3d4;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
web.url.constructor.js</font>
</center></td></tr></table>
<pre><span class="s0">'use strict'</span><span class="s1">;</span>
<span class="s3">// TODO: in core-js@4, move /modules/ dependencies to public entries for better optimization by tools like `preset-env`</span>
<span class="s2">require</span><span class="s1">(</span><span class="s0">'../modules/es.string.iterator'</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">$ </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/export'</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">DESCRIPTORS </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/descriptors'</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">USE_NATIVE_URL </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/url-constructor-detection'</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">global </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/global'</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">bind </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/function-bind-context'</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">uncurryThis </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/function-uncurry-this'</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">defineBuiltIn </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/define-built-in'</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">defineBuiltInAccessor </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/define-built-in-accessor'</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">anInstance </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/an-instance'</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">hasOwn </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/has-own-property'</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">assign </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/object-assign'</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">arrayFrom </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/array-from'</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">arraySlice </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/array-slice'</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">codeAt </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/string-multibyte'</span><span class="s1">).</span><span class="s2">codeAt</span><span class="s1">;</span>
<span class="s4">var </span><span class="s2">toASCII </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/string-punycode-to-ascii'</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">$toString </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/to-string'</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">setToStringTag </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/set-to-string-tag'</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">validateArgumentsLength </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/validate-arguments-length'</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">URLSearchParamsModule </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../modules/web.url-search-params.constructor'</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">InternalStateModule </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/internal-state'</span><span class="s1">);</span>

<span class="s4">var </span><span class="s2">setInternalState </span><span class="s1">= </span><span class="s2">InternalStateModule</span><span class="s1">.</span><span class="s2">set</span><span class="s1">;</span>
<span class="s4">var </span><span class="s2">getInternalURLState </span><span class="s1">= </span><span class="s2">InternalStateModule</span><span class="s1">.</span><span class="s2">getterFor</span><span class="s1">(</span><span class="s0">'URL'</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">URLSearchParams </span><span class="s1">= </span><span class="s2">URLSearchParamsModule</span><span class="s1">.</span><span class="s2">URLSearchParams</span><span class="s1">;</span>
<span class="s4">var </span><span class="s2">getInternalSearchParamsState </span><span class="s1">= </span><span class="s2">URLSearchParamsModule</span><span class="s1">.</span><span class="s2">getState</span><span class="s1">;</span>

<span class="s4">var </span><span class="s2">NativeURL </span><span class="s1">= </span><span class="s2">global</span><span class="s1">.</span><span class="s2">URL</span><span class="s1">;</span>
<span class="s4">var </span><span class="s2">TypeError </span><span class="s1">= </span><span class="s2">global</span><span class="s1">.</span><span class="s2">TypeError</span><span class="s1">;</span>
<span class="s4">var </span><span class="s2">parseInt </span><span class="s1">= </span><span class="s2">global</span><span class="s1">.</span><span class="s2">parseInt</span><span class="s1">;</span>
<span class="s4">var </span><span class="s2">floor </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">floor</span><span class="s1">;</span>
<span class="s4">var </span><span class="s2">pow </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">pow</span><span class="s1">;</span>
<span class="s4">var </span><span class="s2">charAt </span><span class="s1">= </span><span class="s2">uncurryThis</span><span class="s1">(</span><span class="s0">''</span><span class="s1">.</span><span class="s2">charAt</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">exec </span><span class="s1">= </span><span class="s2">uncurryThis</span><span class="s1">(</span><span class="s5">/./</span><span class="s1">.</span><span class="s2">exec</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">join </span><span class="s1">= </span><span class="s2">uncurryThis</span><span class="s1">([].</span><span class="s2">join</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">numberToString </span><span class="s1">= </span><span class="s2">uncurryThis</span><span class="s1">(</span><span class="s6">1.0</span><span class="s1">.</span><span class="s2">toString</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">pop </span><span class="s1">= </span><span class="s2">uncurryThis</span><span class="s1">([].</span><span class="s2">pop</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">push </span><span class="s1">= </span><span class="s2">uncurryThis</span><span class="s1">([].</span><span class="s2">push</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">replace </span><span class="s1">= </span><span class="s2">uncurryThis</span><span class="s1">(</span><span class="s0">''</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">shift </span><span class="s1">= </span><span class="s2">uncurryThis</span><span class="s1">([].</span><span class="s2">shift</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">split </span><span class="s1">= </span><span class="s2">uncurryThis</span><span class="s1">(</span><span class="s0">''</span><span class="s1">.</span><span class="s2">split</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">stringSlice </span><span class="s1">= </span><span class="s2">uncurryThis</span><span class="s1">(</span><span class="s0">''</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">toLowerCase </span><span class="s1">= </span><span class="s2">uncurryThis</span><span class="s1">(</span><span class="s0">''</span><span class="s1">.</span><span class="s2">toLowerCase</span><span class="s1">);</span>
<span class="s4">var </span><span class="s2">unshift </span><span class="s1">= </span><span class="s2">uncurryThis</span><span class="s1">([].</span><span class="s2">unshift</span><span class="s1">);</span>

<span class="s4">var </span><span class="s2">INVALID_AUTHORITY </span><span class="s1">= </span><span class="s0">'Invalid authority'</span><span class="s1">;</span>
<span class="s4">var </span><span class="s2">INVALID_SCHEME </span><span class="s1">= </span><span class="s0">'Invalid scheme'</span><span class="s1">;</span>
<span class="s4">var </span><span class="s2">INVALID_HOST </span><span class="s1">= </span><span class="s0">'Invalid host'</span><span class="s1">;</span>
<span class="s4">var </span><span class="s2">INVALID_PORT </span><span class="s1">= </span><span class="s0">'Invalid port'</span><span class="s1">;</span>

<span class="s4">var </span><span class="s2">ALPHA </span><span class="s1">= </span><span class="s5">/[a-z]/i</span><span class="s1">;</span>
<span class="s3">// eslint-disable-next-line regexp/no-obscure-range -- safe</span>
<span class="s4">var </span><span class="s2">ALPHANUMERIC </span><span class="s1">= </span><span class="s5">/[\d+-.a-z]/i</span><span class="s1">;</span>
<span class="s4">var </span><span class="s2">DIGIT </span><span class="s1">= </span><span class="s5">/\d/</span><span class="s1">;</span>
<span class="s4">var </span><span class="s2">HEX_START </span><span class="s1">= </span><span class="s5">/^0x/i</span><span class="s1">;</span>
<span class="s4">var </span><span class="s2">OCT </span><span class="s1">= </span><span class="s5">/^[0-7]+$/</span><span class="s1">;</span>
<span class="s4">var </span><span class="s2">DEC </span><span class="s1">= </span><span class="s5">/^\d+$/</span><span class="s1">;</span>
<span class="s4">var </span><span class="s2">HEX </span><span class="s1">= </span><span class="s5">/^[\da-f]+$/i</span><span class="s1">;</span>
<span class="s3">/* eslint-disable regexp/no-control-character -- safe */</span>
<span class="s4">var </span><span class="s2">FORBIDDEN_HOST_CODE_POINT </span><span class="s1">= </span><span class="s5">/[\0\t\n\r #%/:&lt;&gt;?@[\\\]^|]/</span><span class="s1">;</span>
<span class="s4">var </span><span class="s2">FORBIDDEN_HOST_CODE_POINT_EXCLUDING_PERCENT </span><span class="s1">= </span><span class="s5">/[\0\t\n\r #/:&lt;&gt;?@[\\\]^|]/</span><span class="s1">;</span>
<span class="s4">var </span><span class="s2">LEADING_C0_CONTROL_OR_SPACE </span><span class="s1">= </span><span class="s5">/^[\u0000-\u0020]+/</span><span class="s1">;</span>
<span class="s4">var </span><span class="s2">TRAILING_C0_CONTROL_OR_SPACE </span><span class="s1">= </span><span class="s5">/(^|[^\u0000-\u0020])[\u0000-\u0020]+$/</span><span class="s1">;</span>
<span class="s4">var </span><span class="s2">TAB_AND_NEW_LINE </span><span class="s1">= </span><span class="s5">/[\t\n\r]/g</span><span class="s1">;</span>
<span class="s3">/* eslint-enable regexp/no-control-character -- safe */</span>
<span class="s4">var </span><span class="s2">EOF</span><span class="s1">;</span>

<span class="s3">// https://url.spec.whatwg.org/#ipv4-number-parser</span>
<span class="s4">var </span><span class="s2">parseIPv4 </span><span class="s1">= </span><span class="s4">function </span><span class="s1">(</span><span class="s2">input</span><span class="s1">) {</span>
  <span class="s4">var </span><span class="s2">parts </span><span class="s1">= </span><span class="s2">split</span><span class="s1">(</span><span class="s2">input</span><span class="s1">, </span><span class="s0">'.'</span><span class="s1">);</span>
  <span class="s4">var </span><span class="s2">partsLength</span><span class="s1">, </span><span class="s2">numbers</span><span class="s1">, </span><span class="s2">index</span><span class="s1">, </span><span class="s2">part</span><span class="s1">, </span><span class="s2">radix</span><span class="s1">, </span><span class="s2">number</span><span class="s1">, </span><span class="s2">ipv4</span><span class="s1">;</span>
  <span class="s4">if </span><span class="s1">(</span><span class="s2">parts</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&amp;&amp; </span><span class="s2">parts</span><span class="s1">[</span><span class="s2">parts</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s6">1</span><span class="s1">] === </span><span class="s0">''</span><span class="s1">) {</span>
    <span class="s2">parts</span><span class="s1">.</span><span class="s2">length</span><span class="s1">--;</span>
  <span class="s1">}</span>
  <span class="s2">partsLength </span><span class="s1">= </span><span class="s2">parts</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
  <span class="s4">if </span><span class="s1">(</span><span class="s2">partsLength </span><span class="s1">&gt; </span><span class="s6">4</span><span class="s1">) </span><span class="s4">return </span><span class="s2">input</span><span class="s1">;</span>
  <span class="s2">numbers </span><span class="s1">= [];</span>
  <span class="s4">for </span><span class="s1">(</span><span class="s2">index </span><span class="s1">= </span><span class="s6">0</span><span class="s1">; </span><span class="s2">index </span><span class="s1">&lt; </span><span class="s2">partsLength</span><span class="s1">; </span><span class="s2">index</span><span class="s1">++) {</span>
    <span class="s2">part </span><span class="s1">= </span><span class="s2">parts</span><span class="s1">[</span><span class="s2">index</span><span class="s1">];</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s2">part </span><span class="s1">=== </span><span class="s0">''</span><span class="s1">) </span><span class="s4">return </span><span class="s2">input</span><span class="s1">;</span>
    <span class="s2">radix </span><span class="s1">= </span><span class="s6">10</span><span class="s1">;</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s2">part</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s6">1 </span><span class="s1">&amp;&amp; </span><span class="s2">charAt</span><span class="s1">(</span><span class="s2">part</span><span class="s1">, </span><span class="s6">0</span><span class="s1">) === </span><span class="s0">'0'</span><span class="s1">) {</span>
      <span class="s2">radix </span><span class="s1">= </span><span class="s2">exec</span><span class="s1">(</span><span class="s2">HEX_START</span><span class="s1">, </span><span class="s2">part</span><span class="s1">) ? </span><span class="s6">16 </span><span class="s1">: </span><span class="s6">8</span><span class="s1">;</span>
      <span class="s2">part </span><span class="s1">= </span><span class="s2">stringSlice</span><span class="s1">(</span><span class="s2">part</span><span class="s1">, </span><span class="s2">radix </span><span class="s1">=== </span><span class="s6">8 </span><span class="s1">? </span><span class="s6">1 </span><span class="s1">: </span><span class="s6">2</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s2">part </span><span class="s1">=== </span><span class="s0">''</span><span class="s1">) {</span>
      <span class="s2">number </span><span class="s1">= </span><span class="s6">0</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
      <span class="s4">if </span><span class="s1">(!</span><span class="s2">exec</span><span class="s1">(</span><span class="s2">radix </span><span class="s1">=== </span><span class="s6">10 </span><span class="s1">? </span><span class="s2">DEC </span><span class="s1">: </span><span class="s2">radix </span><span class="s1">=== </span><span class="s6">8 </span><span class="s1">? </span><span class="s2">OCT </span><span class="s1">: </span><span class="s2">HEX</span><span class="s1">, </span><span class="s2">part</span><span class="s1">)) </span><span class="s4">return </span><span class="s2">input</span><span class="s1">;</span>
      <span class="s2">number </span><span class="s1">= </span><span class="s2">parseInt</span><span class="s1">(</span><span class="s2">part</span><span class="s1">, </span><span class="s2">radix</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s2">push</span><span class="s1">(</span><span class="s2">numbers</span><span class="s1">, </span><span class="s2">number</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s4">for </span><span class="s1">(</span><span class="s2">index </span><span class="s1">= </span><span class="s6">0</span><span class="s1">; </span><span class="s2">index </span><span class="s1">&lt; </span><span class="s2">partsLength</span><span class="s1">; </span><span class="s2">index</span><span class="s1">++) {</span>
    <span class="s2">number </span><span class="s1">= </span><span class="s2">numbers</span><span class="s1">[</span><span class="s2">index</span><span class="s1">];</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s2">index </span><span class="s1">=== </span><span class="s2">partsLength </span><span class="s1">- </span><span class="s6">1</span><span class="s1">) {</span>
      <span class="s4">if </span><span class="s1">(</span><span class="s2">number </span><span class="s1">&gt;= </span><span class="s2">pow</span><span class="s1">(</span><span class="s6">256</span><span class="s1">, </span><span class="s6">5 </span><span class="s1">- </span><span class="s2">partsLength</span><span class="s1">)) </span><span class="s4">return null</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">number </span><span class="s1">&gt; </span><span class="s6">255</span><span class="s1">) </span><span class="s4">return null</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s2">ipv4 </span><span class="s1">= </span><span class="s2">pop</span><span class="s1">(</span><span class="s2">numbers</span><span class="s1">);</span>
  <span class="s4">for </span><span class="s1">(</span><span class="s2">index </span><span class="s1">= </span><span class="s6">0</span><span class="s1">; </span><span class="s2">index </span><span class="s1">&lt; </span><span class="s2">numbers</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">index</span><span class="s1">++) {</span>
    <span class="s2">ipv4 </span><span class="s1">+= </span><span class="s2">numbers</span><span class="s1">[</span><span class="s2">index</span><span class="s1">] * </span><span class="s2">pow</span><span class="s1">(</span><span class="s6">256</span><span class="s1">, </span><span class="s6">3 </span><span class="s1">- </span><span class="s2">index</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s4">return </span><span class="s2">ipv4</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s3">// https://url.spec.whatwg.org/#concept-ipv6-parser</span>
<span class="s3">// eslint-disable-next-line max-statements -- TODO</span>
<span class="s4">var </span><span class="s2">parseIPv6 </span><span class="s1">= </span><span class="s4">function </span><span class="s1">(</span><span class="s2">input</span><span class="s1">) {</span>
  <span class="s4">var </span><span class="s2">address </span><span class="s1">= [</span><span class="s6">0</span><span class="s1">, </span><span class="s6">0</span><span class="s1">, </span><span class="s6">0</span><span class="s1">, </span><span class="s6">0</span><span class="s1">, </span><span class="s6">0</span><span class="s1">, </span><span class="s6">0</span><span class="s1">, </span><span class="s6">0</span><span class="s1">, </span><span class="s6">0</span><span class="s1">];</span>
  <span class="s4">var </span><span class="s2">pieceIndex </span><span class="s1">= </span><span class="s6">0</span><span class="s1">;</span>
  <span class="s4">var </span><span class="s2">compress </span><span class="s1">= </span><span class="s4">null</span><span class="s1">;</span>
  <span class="s4">var </span><span class="s2">pointer </span><span class="s1">= </span><span class="s6">0</span><span class="s1">;</span>
  <span class="s4">var </span><span class="s2">value</span><span class="s1">, </span><span class="s2">length</span><span class="s1">, </span><span class="s2">numbersSeen</span><span class="s1">, </span><span class="s2">ipv4Piece</span><span class="s1">, </span><span class="s2">number</span><span class="s1">, </span><span class="s2">swaps</span><span class="s1">, </span><span class="s2">swap</span><span class="s1">;</span>

  <span class="s4">var </span><span class="s2">chr </span><span class="s1">= </span><span class="s4">function </span><span class="s1">() {</span>
    <span class="s4">return </span><span class="s2">charAt</span><span class="s1">(</span><span class="s2">input</span><span class="s1">, </span><span class="s2">pointer</span><span class="s1">);</span>
  <span class="s1">};</span>

  <span class="s4">if </span><span class="s1">(</span><span class="s2">chr</span><span class="s1">() === </span><span class="s0">':'</span><span class="s1">) {</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s2">charAt</span><span class="s1">(</span><span class="s2">input</span><span class="s1">, </span><span class="s6">1</span><span class="s1">) !== </span><span class="s0">':'</span><span class="s1">) </span><span class="s4">return</span><span class="s1">;</span>
    <span class="s2">pointer </span><span class="s1">+= </span><span class="s6">2</span><span class="s1">;</span>
    <span class="s2">pieceIndex</span><span class="s1">++;</span>
    <span class="s2">compress </span><span class="s1">= </span><span class="s2">pieceIndex</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s4">while </span><span class="s1">(</span><span class="s2">chr</span><span class="s1">()) {</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s2">pieceIndex </span><span class="s1">=== </span><span class="s6">8</span><span class="s1">) </span><span class="s4">return</span><span class="s1">;</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s2">chr</span><span class="s1">() === </span><span class="s0">':'</span><span class="s1">) {</span>
      <span class="s4">if </span><span class="s1">(</span><span class="s2">compress </span><span class="s1">!== </span><span class="s4">null</span><span class="s1">) </span><span class="s4">return</span><span class="s1">;</span>
      <span class="s2">pointer</span><span class="s1">++;</span>
      <span class="s2">pieceIndex</span><span class="s1">++;</span>
      <span class="s2">compress </span><span class="s1">= </span><span class="s2">pieceIndex</span><span class="s1">;</span>
      <span class="s4">continue</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">value </span><span class="s1">= </span><span class="s2">length </span><span class="s1">= </span><span class="s6">0</span><span class="s1">;</span>
    <span class="s4">while </span><span class="s1">(</span><span class="s2">length </span><span class="s1">&lt; </span><span class="s6">4 </span><span class="s1">&amp;&amp; </span><span class="s2">exec</span><span class="s1">(</span><span class="s2">HEX</span><span class="s1">, </span><span class="s2">chr</span><span class="s1">())) {</span>
      <span class="s2">value </span><span class="s1">= </span><span class="s2">value </span><span class="s1">* </span><span class="s6">16 </span><span class="s1">+ </span><span class="s2">parseInt</span><span class="s1">(</span><span class="s2">chr</span><span class="s1">(), </span><span class="s6">16</span><span class="s1">);</span>
      <span class="s2">pointer</span><span class="s1">++;</span>
      <span class="s2">length</span><span class="s1">++;</span>
    <span class="s1">}</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s2">chr</span><span class="s1">() === </span><span class="s0">'.'</span><span class="s1">) {</span>
      <span class="s4">if </span><span class="s1">(</span><span class="s2">length </span><span class="s1">=== </span><span class="s6">0</span><span class="s1">) </span><span class="s4">return</span><span class="s1">;</span>
      <span class="s2">pointer </span><span class="s1">-= </span><span class="s2">length</span><span class="s1">;</span>
      <span class="s4">if </span><span class="s1">(</span><span class="s2">pieceIndex </span><span class="s1">&gt; </span><span class="s6">6</span><span class="s1">) </span><span class="s4">return</span><span class="s1">;</span>
      <span class="s2">numbersSeen </span><span class="s1">= </span><span class="s6">0</span><span class="s1">;</span>
      <span class="s4">while </span><span class="s1">(</span><span class="s2">chr</span><span class="s1">()) {</span>
        <span class="s2">ipv4Piece </span><span class="s1">= </span><span class="s4">null</span><span class="s1">;</span>
        <span class="s4">if </span><span class="s1">(</span><span class="s2">numbersSeen </span><span class="s1">&gt; </span><span class="s6">0</span><span class="s1">) {</span>
          <span class="s4">if </span><span class="s1">(</span><span class="s2">chr</span><span class="s1">() === </span><span class="s0">'.' </span><span class="s1">&amp;&amp; </span><span class="s2">numbersSeen </span><span class="s1">&lt; </span><span class="s6">4</span><span class="s1">) </span><span class="s2">pointer</span><span class="s1">++;</span>
          <span class="s4">else return</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s4">if </span><span class="s1">(!</span><span class="s2">exec</span><span class="s1">(</span><span class="s2">DIGIT</span><span class="s1">, </span><span class="s2">chr</span><span class="s1">())) </span><span class="s4">return</span><span class="s1">;</span>
        <span class="s4">while </span><span class="s1">(</span><span class="s2">exec</span><span class="s1">(</span><span class="s2">DIGIT</span><span class="s1">, </span><span class="s2">chr</span><span class="s1">())) {</span>
          <span class="s2">number </span><span class="s1">= </span><span class="s2">parseInt</span><span class="s1">(</span><span class="s2">chr</span><span class="s1">(), </span><span class="s6">10</span><span class="s1">);</span>
          <span class="s4">if </span><span class="s1">(</span><span class="s2">ipv4Piece </span><span class="s1">=== </span><span class="s4">null</span><span class="s1">) </span><span class="s2">ipv4Piece </span><span class="s1">= </span><span class="s2">number</span><span class="s1">;</span>
          <span class="s4">else if </span><span class="s1">(</span><span class="s2">ipv4Piece </span><span class="s1">=== </span><span class="s6">0</span><span class="s1">) </span><span class="s4">return</span><span class="s1">;</span>
          <span class="s4">else </span><span class="s2">ipv4Piece </span><span class="s1">= </span><span class="s2">ipv4Piece </span><span class="s1">* </span><span class="s6">10 </span><span class="s1">+ </span><span class="s2">number</span><span class="s1">;</span>
          <span class="s4">if </span><span class="s1">(</span><span class="s2">ipv4Piece </span><span class="s1">&gt; </span><span class="s6">255</span><span class="s1">) </span><span class="s4">return</span><span class="s1">;</span>
          <span class="s2">pointer</span><span class="s1">++;</span>
        <span class="s1">}</span>
        <span class="s2">address</span><span class="s1">[</span><span class="s2">pieceIndex</span><span class="s1">] = </span><span class="s2">address</span><span class="s1">[</span><span class="s2">pieceIndex</span><span class="s1">] * </span><span class="s6">256 </span><span class="s1">+ </span><span class="s2">ipv4Piece</span><span class="s1">;</span>
        <span class="s2">numbersSeen</span><span class="s1">++;</span>
        <span class="s4">if </span><span class="s1">(</span><span class="s2">numbersSeen </span><span class="s1">=== </span><span class="s6">2 </span><span class="s1">|| </span><span class="s2">numbersSeen </span><span class="s1">=== </span><span class="s6">4</span><span class="s1">) </span><span class="s2">pieceIndex</span><span class="s1">++;</span>
      <span class="s1">}</span>
      <span class="s4">if </span><span class="s1">(</span><span class="s2">numbersSeen </span><span class="s1">!== </span><span class="s6">4</span><span class="s1">) </span><span class="s4">return</span><span class="s1">;</span>
      <span class="s4">break</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">chr</span><span class="s1">() === </span><span class="s0">':'</span><span class="s1">) {</span>
      <span class="s2">pointer</span><span class="s1">++;</span>
      <span class="s4">if </span><span class="s1">(!</span><span class="s2">chr</span><span class="s1">()) </span><span class="s4">return</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">chr</span><span class="s1">()) </span><span class="s4">return</span><span class="s1">;</span>
    <span class="s2">address</span><span class="s1">[</span><span class="s2">pieceIndex</span><span class="s1">++] = </span><span class="s2">value</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s4">if </span><span class="s1">(</span><span class="s2">compress </span><span class="s1">!== </span><span class="s4">null</span><span class="s1">) {</span>
    <span class="s2">swaps </span><span class="s1">= </span><span class="s2">pieceIndex </span><span class="s1">- </span><span class="s2">compress</span><span class="s1">;</span>
    <span class="s2">pieceIndex </span><span class="s1">= </span><span class="s6">7</span><span class="s1">;</span>
    <span class="s4">while </span><span class="s1">(</span><span class="s2">pieceIndex </span><span class="s1">!== </span><span class="s6">0 </span><span class="s1">&amp;&amp; </span><span class="s2">swaps </span><span class="s1">&gt; </span><span class="s6">0</span><span class="s1">) {</span>
      <span class="s2">swap </span><span class="s1">= </span><span class="s2">address</span><span class="s1">[</span><span class="s2">pieceIndex</span><span class="s1">];</span>
      <span class="s2">address</span><span class="s1">[</span><span class="s2">pieceIndex</span><span class="s1">--] = </span><span class="s2">address</span><span class="s1">[</span><span class="s2">compress </span><span class="s1">+ </span><span class="s2">swaps </span><span class="s1">- </span><span class="s6">1</span><span class="s1">];</span>
      <span class="s2">address</span><span class="s1">[</span><span class="s2">compress </span><span class="s1">+ --</span><span class="s2">swaps</span><span class="s1">] = </span><span class="s2">swap</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">pieceIndex </span><span class="s1">!== </span><span class="s6">8</span><span class="s1">) </span><span class="s4">return</span><span class="s1">;</span>
  <span class="s4">return </span><span class="s2">address</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s4">var </span><span class="s2">findLongestZeroSequence </span><span class="s1">= </span><span class="s4">function </span><span class="s1">(</span><span class="s2">ipv6</span><span class="s1">) {</span>
  <span class="s4">var </span><span class="s2">maxIndex </span><span class="s1">= </span><span class="s4">null</span><span class="s1">;</span>
  <span class="s4">var </span><span class="s2">maxLength </span><span class="s1">= </span><span class="s6">1</span><span class="s1">;</span>
  <span class="s4">var </span><span class="s2">currStart </span><span class="s1">= </span><span class="s4">null</span><span class="s1">;</span>
  <span class="s4">var </span><span class="s2">currLength </span><span class="s1">= </span><span class="s6">0</span><span class="s1">;</span>
  <span class="s4">var </span><span class="s2">index </span><span class="s1">= </span><span class="s6">0</span><span class="s1">;</span>
  <span class="s4">for </span><span class="s1">(; </span><span class="s2">index </span><span class="s1">&lt; </span><span class="s6">8</span><span class="s1">; </span><span class="s2">index</span><span class="s1">++) {</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s2">ipv6</span><span class="s1">[</span><span class="s2">index</span><span class="s1">] !== </span><span class="s6">0</span><span class="s1">) {</span>
      <span class="s4">if </span><span class="s1">(</span><span class="s2">currLength </span><span class="s1">&gt; </span><span class="s2">maxLength</span><span class="s1">) {</span>
        <span class="s2">maxIndex </span><span class="s1">= </span><span class="s2">currStart</span><span class="s1">;</span>
        <span class="s2">maxLength </span><span class="s1">= </span><span class="s2">currLength</span><span class="s1">;</span>
      <span class="s1">}</span>
      <span class="s2">currStart </span><span class="s1">= </span><span class="s4">null</span><span class="s1">;</span>
      <span class="s2">currLength </span><span class="s1">= </span><span class="s6">0</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
      <span class="s4">if </span><span class="s1">(</span><span class="s2">currStart </span><span class="s1">=== </span><span class="s4">null</span><span class="s1">) </span><span class="s2">currStart </span><span class="s1">= </span><span class="s2">index</span><span class="s1">;</span>
      <span class="s1">++</span><span class="s2">currLength</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
  <span class="s4">if </span><span class="s1">(</span><span class="s2">currLength </span><span class="s1">&gt; </span><span class="s2">maxLength</span><span class="s1">) {</span>
    <span class="s2">maxIndex </span><span class="s1">= </span><span class="s2">currStart</span><span class="s1">;</span>
    <span class="s2">maxLength </span><span class="s1">= </span><span class="s2">currLength</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s4">return </span><span class="s2">maxIndex</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s3">// https://url.spec.whatwg.org/#host-serializing</span>
<span class="s4">var </span><span class="s2">serializeHost </span><span class="s1">= </span><span class="s4">function </span><span class="s1">(</span><span class="s2">host</span><span class="s1">) {</span>
  <span class="s4">var </span><span class="s2">result</span><span class="s1">, </span><span class="s2">index</span><span class="s1">, </span><span class="s2">compress</span><span class="s1">, </span><span class="s2">ignore0</span><span class="s1">;</span>
  <span class="s3">// ipv4</span>
  <span class="s4">if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">host </span><span class="s1">== </span><span class="s0">'number'</span><span class="s1">) {</span>
    <span class="s2">result </span><span class="s1">= [];</span>
    <span class="s4">for </span><span class="s1">(</span><span class="s2">index </span><span class="s1">= </span><span class="s6">0</span><span class="s1">; </span><span class="s2">index </span><span class="s1">&lt; </span><span class="s6">4</span><span class="s1">; </span><span class="s2">index</span><span class="s1">++) {</span>
      <span class="s2">unshift</span><span class="s1">(</span><span class="s2">result</span><span class="s1">, </span><span class="s2">host </span><span class="s1">% </span><span class="s6">256</span><span class="s1">);</span>
      <span class="s2">host </span><span class="s1">= </span><span class="s2">floor</span><span class="s1">(</span><span class="s2">host </span><span class="s1">/ </span><span class="s6">256</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s4">return </span><span class="s2">join</span><span class="s1">(</span><span class="s2">result</span><span class="s1">, </span><span class="s0">'.'</span><span class="s1">);</span>
  <span class="s3">// ipv6</span>
  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s4">typeof </span><span class="s2">host </span><span class="s1">== </span><span class="s0">'object'</span><span class="s1">) {</span>
    <span class="s2">result </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
    <span class="s2">compress </span><span class="s1">= </span><span class="s2">findLongestZeroSequence</span><span class="s1">(</span><span class="s2">host</span><span class="s1">);</span>
    <span class="s4">for </span><span class="s1">(</span><span class="s2">index </span><span class="s1">= </span><span class="s6">0</span><span class="s1">; </span><span class="s2">index </span><span class="s1">&lt; </span><span class="s6">8</span><span class="s1">; </span><span class="s2">index</span><span class="s1">++) {</span>
      <span class="s4">if </span><span class="s1">(</span><span class="s2">ignore0 </span><span class="s1">&amp;&amp; </span><span class="s2">host</span><span class="s1">[</span><span class="s2">index</span><span class="s1">] === </span><span class="s6">0</span><span class="s1">) </span><span class="s4">continue</span><span class="s1">;</span>
      <span class="s4">if </span><span class="s1">(</span><span class="s2">ignore0</span><span class="s1">) </span><span class="s2">ignore0 </span><span class="s1">= </span><span class="s4">false</span><span class="s1">;</span>
      <span class="s4">if </span><span class="s1">(</span><span class="s2">compress </span><span class="s1">=== </span><span class="s2">index</span><span class="s1">) {</span>
        <span class="s2">result </span><span class="s1">+= </span><span class="s2">index </span><span class="s1">? </span><span class="s0">':' </span><span class="s1">: </span><span class="s0">'::'</span><span class="s1">;</span>
        <span class="s2">ignore0 </span><span class="s1">= </span><span class="s4">true</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
        <span class="s2">result </span><span class="s1">+= </span><span class="s2">numberToString</span><span class="s1">(</span><span class="s2">host</span><span class="s1">[</span><span class="s2">index</span><span class="s1">], </span><span class="s6">16</span><span class="s1">);</span>
        <span class="s4">if </span><span class="s1">(</span><span class="s2">index </span><span class="s1">&lt; </span><span class="s6">7</span><span class="s1">) </span><span class="s2">result </span><span class="s1">+= </span><span class="s0">':'</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s4">return </span><span class="s0">'[' </span><span class="s1">+ </span><span class="s2">result </span><span class="s1">+ </span><span class="s0">']'</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s4">return </span><span class="s2">host</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s4">var </span><span class="s2">C0ControlPercentEncodeSet </span><span class="s1">= {};</span>
<span class="s4">var </span><span class="s2">fragmentPercentEncodeSet </span><span class="s1">= </span><span class="s2">assign</span><span class="s1">({}, </span><span class="s2">C0ControlPercentEncodeSet</span><span class="s1">, {</span>
  <span class="s0">' '</span><span class="s1">: </span><span class="s6">1</span><span class="s1">, </span><span class="s0">'&quot;'</span><span class="s1">: </span><span class="s6">1</span><span class="s1">, </span><span class="s0">'&lt;'</span><span class="s1">: </span><span class="s6">1</span><span class="s1">, </span><span class="s0">'&gt;'</span><span class="s1">: </span><span class="s6">1</span><span class="s1">, </span><span class="s0">'`'</span><span class="s1">: </span><span class="s6">1</span>
<span class="s1">});</span>
<span class="s4">var </span><span class="s2">pathPercentEncodeSet </span><span class="s1">= </span><span class="s2">assign</span><span class="s1">({}, </span><span class="s2">fragmentPercentEncodeSet</span><span class="s1">, {</span>
  <span class="s0">'#'</span><span class="s1">: </span><span class="s6">1</span><span class="s1">, </span><span class="s0">'?'</span><span class="s1">: </span><span class="s6">1</span><span class="s1">, </span><span class="s0">'{'</span><span class="s1">: </span><span class="s6">1</span><span class="s1">, </span><span class="s0">'}'</span><span class="s1">: </span><span class="s6">1</span>
<span class="s1">});</span>
<span class="s4">var </span><span class="s2">userinfoPercentEncodeSet </span><span class="s1">= </span><span class="s2">assign</span><span class="s1">({}, </span><span class="s2">pathPercentEncodeSet</span><span class="s1">, {</span>
  <span class="s0">'/'</span><span class="s1">: </span><span class="s6">1</span><span class="s1">, </span><span class="s0">':'</span><span class="s1">: </span><span class="s6">1</span><span class="s1">, </span><span class="s0">';'</span><span class="s1">: </span><span class="s6">1</span><span class="s1">, </span><span class="s0">'='</span><span class="s1">: </span><span class="s6">1</span><span class="s1">, </span><span class="s0">'@'</span><span class="s1">: </span><span class="s6">1</span><span class="s1">, </span><span class="s0">'['</span><span class="s1">: </span><span class="s6">1</span><span class="s1">, </span><span class="s0">'</span><span class="s4">\\</span><span class="s0">'</span><span class="s1">: </span><span class="s6">1</span><span class="s1">, </span><span class="s0">']'</span><span class="s1">: </span><span class="s6">1</span><span class="s1">, </span><span class="s0">'^'</span><span class="s1">: </span><span class="s6">1</span><span class="s1">, </span><span class="s0">'|'</span><span class="s1">: </span><span class="s6">1</span>
<span class="s1">});</span>

<span class="s4">var </span><span class="s2">percentEncode </span><span class="s1">= </span><span class="s4">function </span><span class="s1">(</span><span class="s2">chr</span><span class="s1">, </span><span class="s2">set</span><span class="s1">) {</span>
  <span class="s4">var </span><span class="s2">code </span><span class="s1">= </span><span class="s2">codeAt</span><span class="s1">(</span><span class="s2">chr</span><span class="s1">, </span><span class="s6">0</span><span class="s1">);</span>
  <span class="s4">return </span><span class="s2">code </span><span class="s1">&gt; </span><span class="s6">0x20 </span><span class="s1">&amp;&amp; </span><span class="s2">code </span><span class="s1">&lt; </span><span class="s6">0x7F </span><span class="s1">&amp;&amp; !</span><span class="s2">hasOwn</span><span class="s1">(</span><span class="s2">set</span><span class="s1">, </span><span class="s2">chr</span><span class="s1">) ? </span><span class="s2">chr </span><span class="s1">: </span><span class="s2">encodeURIComponent</span><span class="s1">(</span><span class="s2">chr</span><span class="s1">);</span>
<span class="s1">};</span>

<span class="s3">// https://url.spec.whatwg.org/#special-scheme</span>
<span class="s4">var </span><span class="s2">specialSchemes </span><span class="s1">= {</span>
  <span class="s2">ftp</span><span class="s1">: </span><span class="s6">21</span><span class="s1">,</span>
  <span class="s2">file</span><span class="s1">: </span><span class="s4">null</span><span class="s1">,</span>
  <span class="s2">http</span><span class="s1">: </span><span class="s6">80</span><span class="s1">,</span>
  <span class="s2">https</span><span class="s1">: </span><span class="s6">443</span><span class="s1">,</span>
  <span class="s2">ws</span><span class="s1">: </span><span class="s6">80</span><span class="s1">,</span>
  <span class="s2">wss</span><span class="s1">: </span><span class="s6">443</span>
<span class="s1">};</span>

<span class="s3">// https://url.spec.whatwg.org/#windows-drive-letter</span>
<span class="s4">var </span><span class="s2">isWindowsDriveLetter </span><span class="s1">= </span><span class="s4">function </span><span class="s1">(</span><span class="s2">string</span><span class="s1">, </span><span class="s2">normalized</span><span class="s1">) {</span>
  <span class="s4">var </span><span class="s2">second</span><span class="s1">;</span>
  <span class="s4">return </span><span class="s2">string</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s6">2 </span><span class="s1">&amp;&amp; </span><span class="s2">exec</span><span class="s1">(</span><span class="s2">ALPHA</span><span class="s1">, </span><span class="s2">charAt</span><span class="s1">(</span><span class="s2">string</span><span class="s1">, </span><span class="s6">0</span><span class="s1">))</span>
    <span class="s1">&amp;&amp; ((</span><span class="s2">second </span><span class="s1">= </span><span class="s2">charAt</span><span class="s1">(</span><span class="s2">string</span><span class="s1">, </span><span class="s6">1</span><span class="s1">)) === </span><span class="s0">':' </span><span class="s1">|| (!</span><span class="s2">normalized </span><span class="s1">&amp;&amp; </span><span class="s2">second </span><span class="s1">=== </span><span class="s0">'|'</span><span class="s1">));</span>
<span class="s1">};</span>

<span class="s3">// https://url.spec.whatwg.org/#start-with-a-windows-drive-letter</span>
<span class="s4">var </span><span class="s2">startsWithWindowsDriveLetter </span><span class="s1">= </span><span class="s4">function </span><span class="s1">(</span><span class="s2">string</span><span class="s1">) {</span>
  <span class="s4">var </span><span class="s2">third</span><span class="s1">;</span>
  <span class="s4">return </span><span class="s2">string</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s6">1 </span><span class="s1">&amp;&amp; </span><span class="s2">isWindowsDriveLetter</span><span class="s1">(</span><span class="s2">stringSlice</span><span class="s1">(</span><span class="s2">string</span><span class="s1">, </span><span class="s6">0</span><span class="s1">, </span><span class="s6">2</span><span class="s1">)) &amp;&amp; (</span>
    <span class="s2">string</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s6">2 </span><span class="s1">||</span>
    <span class="s1">((</span><span class="s2">third </span><span class="s1">= </span><span class="s2">charAt</span><span class="s1">(</span><span class="s2">string</span><span class="s1">, </span><span class="s6">2</span><span class="s1">)) === </span><span class="s0">'/' </span><span class="s1">|| </span><span class="s2">third </span><span class="s1">=== </span><span class="s0">'</span><span class="s4">\\</span><span class="s0">' </span><span class="s1">|| </span><span class="s2">third </span><span class="s1">=== </span><span class="s0">'?' </span><span class="s1">|| </span><span class="s2">third </span><span class="s1">=== </span><span class="s0">'#'</span><span class="s1">)</span>
  <span class="s1">);</span>
<span class="s1">};</span>

<span class="s3">// https://url.spec.whatwg.org/#single-dot-path-segment</span>
<span class="s4">var </span><span class="s2">isSingleDot </span><span class="s1">= </span><span class="s4">function </span><span class="s1">(</span><span class="s2">segment</span><span class="s1">) {</span>
  <span class="s4">return </span><span class="s2">segment </span><span class="s1">=== </span><span class="s0">'.' </span><span class="s1">|| </span><span class="s2">toLowerCase</span><span class="s1">(</span><span class="s2">segment</span><span class="s1">) === </span><span class="s0">'%2e'</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s3">// https://url.spec.whatwg.org/#double-dot-path-segment</span>
<span class="s4">var </span><span class="s2">isDoubleDot </span><span class="s1">= </span><span class="s4">function </span><span class="s1">(</span><span class="s2">segment</span><span class="s1">) {</span>
  <span class="s2">segment </span><span class="s1">= </span><span class="s2">toLowerCase</span><span class="s1">(</span><span class="s2">segment</span><span class="s1">);</span>
  <span class="s4">return </span><span class="s2">segment </span><span class="s1">=== </span><span class="s0">'..' </span><span class="s1">|| </span><span class="s2">segment </span><span class="s1">=== </span><span class="s0">'%2e.' </span><span class="s1">|| </span><span class="s2">segment </span><span class="s1">=== </span><span class="s0">'.%2e' </span><span class="s1">|| </span><span class="s2">segment </span><span class="s1">=== </span><span class="s0">'%2e%2e'</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s3">// States:</span>
<span class="s4">var </span><span class="s2">SCHEME_START </span><span class="s1">= {};</span>
<span class="s4">var </span><span class="s2">SCHEME </span><span class="s1">= {};</span>
<span class="s4">var </span><span class="s2">NO_SCHEME </span><span class="s1">= {};</span>
<span class="s4">var </span><span class="s2">SPECIAL_RELATIVE_OR_AUTHORITY </span><span class="s1">= {};</span>
<span class="s4">var </span><span class="s2">PATH_OR_AUTHORITY </span><span class="s1">= {};</span>
<span class="s4">var </span><span class="s2">RELATIVE </span><span class="s1">= {};</span>
<span class="s4">var </span><span class="s2">RELATIVE_SLASH </span><span class="s1">= {};</span>
<span class="s4">var </span><span class="s2">SPECIAL_AUTHORITY_SLASHES </span><span class="s1">= {};</span>
<span class="s4">var </span><span class="s2">SPECIAL_AUTHORITY_IGNORE_SLASHES </span><span class="s1">= {};</span>
<span class="s4">var </span><span class="s2">AUTHORITY </span><span class="s1">= {};</span>
<span class="s4">var </span><span class="s2">HOST </span><span class="s1">= {};</span>
<span class="s4">var </span><span class="s2">HOSTNAME </span><span class="s1">= {};</span>
<span class="s4">var </span><span class="s2">PORT </span><span class="s1">= {};</span>
<span class="s4">var </span><span class="s2">FILE </span><span class="s1">= {};</span>
<span class="s4">var </span><span class="s2">FILE_SLASH </span><span class="s1">= {};</span>
<span class="s4">var </span><span class="s2">FILE_HOST </span><span class="s1">= {};</span>
<span class="s4">var </span><span class="s2">PATH_START </span><span class="s1">= {};</span>
<span class="s4">var </span><span class="s2">PATH </span><span class="s1">= {};</span>
<span class="s4">var </span><span class="s2">CANNOT_BE_A_BASE_URL_PATH </span><span class="s1">= {};</span>
<span class="s4">var </span><span class="s2">QUERY </span><span class="s1">= {};</span>
<span class="s4">var </span><span class="s2">FRAGMENT </span><span class="s1">= {};</span>

<span class="s4">var </span><span class="s2">URLState </span><span class="s1">= </span><span class="s4">function </span><span class="s1">(</span><span class="s2">url</span><span class="s1">, </span><span class="s2">isBase</span><span class="s1">, </span><span class="s2">base</span><span class="s1">) {</span>
  <span class="s4">var </span><span class="s2">urlString </span><span class="s1">= </span><span class="s2">$toString</span><span class="s1">(</span><span class="s2">url</span><span class="s1">);</span>
  <span class="s4">var </span><span class="s2">baseState</span><span class="s1">, </span><span class="s2">failure</span><span class="s1">, </span><span class="s2">searchParams</span><span class="s1">;</span>
  <span class="s4">if </span><span class="s1">(</span><span class="s2">isBase</span><span class="s1">) {</span>
    <span class="s2">failure </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">parse</span><span class="s1">(</span><span class="s2">urlString</span><span class="s1">);</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s2">failure</span><span class="s1">) </span><span class="s4">throw new </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s2">failure</span><span class="s1">);</span>
    <span class="s4">this</span><span class="s1">.</span><span class="s2">searchParams </span><span class="s1">= </span><span class="s4">null</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s2">base </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) </span><span class="s2">baseState </span><span class="s1">= </span><span class="s4">new </span><span class="s2">URLState</span><span class="s1">(</span><span class="s2">base</span><span class="s1">, </span><span class="s4">true</span><span class="s1">);</span>
    <span class="s2">failure </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">parse</span><span class="s1">(</span><span class="s2">urlString</span><span class="s1">, </span><span class="s4">null</span><span class="s1">, </span><span class="s2">baseState</span><span class="s1">);</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s2">failure</span><span class="s1">) </span><span class="s4">throw new </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s2">failure</span><span class="s1">);</span>
    <span class="s2">searchParams </span><span class="s1">= </span><span class="s2">getInternalSearchParamsState</span><span class="s1">(</span><span class="s4">new </span><span class="s2">URLSearchParams</span><span class="s1">());</span>
    <span class="s2">searchParams</span><span class="s1">.</span><span class="s2">bindURL</span><span class="s1">(</span><span class="s4">this</span><span class="s1">);</span>
    <span class="s4">this</span><span class="s1">.</span><span class="s2">searchParams </span><span class="s1">= </span><span class="s2">searchParams</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">};</span>

<span class="s2">URLState</span><span class="s1">.</span><span class="s2">prototype </span><span class="s1">= {</span>
  <span class="s2">type</span><span class="s1">: </span><span class="s0">'URL'</span><span class="s1">,</span>
  <span class="s3">// https://url.spec.whatwg.org/#url-parsing</span>
  <span class="s3">// eslint-disable-next-line max-statements -- TODO</span>
  <span class="s2">parse</span><span class="s1">: </span><span class="s4">function </span><span class="s1">(</span><span class="s2">input</span><span class="s1">, </span><span class="s2">stateOverride</span><span class="s1">, </span><span class="s2">base</span><span class="s1">) {</span>
    <span class="s4">var </span><span class="s2">url </span><span class="s1">= </span><span class="s4">this</span><span class="s1">;</span>
    <span class="s4">var </span><span class="s2">state </span><span class="s1">= </span><span class="s2">stateOverride </span><span class="s1">|| </span><span class="s2">SCHEME_START</span><span class="s1">;</span>
    <span class="s4">var </span><span class="s2">pointer </span><span class="s1">= </span><span class="s6">0</span><span class="s1">;</span>
    <span class="s4">var </span><span class="s2">buffer </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
    <span class="s4">var </span><span class="s2">seenAt </span><span class="s1">= </span><span class="s4">false</span><span class="s1">;</span>
    <span class="s4">var </span><span class="s2">seenBracket </span><span class="s1">= </span><span class="s4">false</span><span class="s1">;</span>
    <span class="s4">var </span><span class="s2">seenPasswordToken </span><span class="s1">= </span><span class="s4">false</span><span class="s1">;</span>
    <span class="s4">var </span><span class="s2">codePoints</span><span class="s1">, </span><span class="s2">chr</span><span class="s1">, </span><span class="s2">bufferCodePoints</span><span class="s1">, </span><span class="s2">failure</span><span class="s1">;</span>

    <span class="s2">input </span><span class="s1">= </span><span class="s2">$toString</span><span class="s1">(</span><span class="s2">input</span><span class="s1">);</span>

    <span class="s4">if </span><span class="s1">(!</span><span class="s2">stateOverride</span><span class="s1">) {</span>
      <span class="s2">url</span><span class="s1">.</span><span class="s2">scheme </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
      <span class="s2">url</span><span class="s1">.</span><span class="s2">username </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
      <span class="s2">url</span><span class="s1">.</span><span class="s2">password </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
      <span class="s2">url</span><span class="s1">.</span><span class="s2">host </span><span class="s1">= </span><span class="s4">null</span><span class="s1">;</span>
      <span class="s2">url</span><span class="s1">.</span><span class="s2">port </span><span class="s1">= </span><span class="s4">null</span><span class="s1">;</span>
      <span class="s2">url</span><span class="s1">.</span><span class="s2">path </span><span class="s1">= [];</span>
      <span class="s2">url</span><span class="s1">.</span><span class="s2">query </span><span class="s1">= </span><span class="s4">null</span><span class="s1">;</span>
      <span class="s2">url</span><span class="s1">.</span><span class="s2">fragment </span><span class="s1">= </span><span class="s4">null</span><span class="s1">;</span>
      <span class="s2">url</span><span class="s1">.</span><span class="s2">cannotBeABaseURL </span><span class="s1">= </span><span class="s4">false</span><span class="s1">;</span>
      <span class="s2">input </span><span class="s1">= </span><span class="s2">replace</span><span class="s1">(</span><span class="s2">input</span><span class="s1">, </span><span class="s2">LEADING_C0_CONTROL_OR_SPACE</span><span class="s1">, </span><span class="s0">''</span><span class="s1">);</span>
      <span class="s2">input </span><span class="s1">= </span><span class="s2">replace</span><span class="s1">(</span><span class="s2">input</span><span class="s1">, </span><span class="s2">TRAILING_C0_CONTROL_OR_SPACE</span><span class="s1">, </span><span class="s0">'$1'</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s2">input </span><span class="s1">= </span><span class="s2">replace</span><span class="s1">(</span><span class="s2">input</span><span class="s1">, </span><span class="s2">TAB_AND_NEW_LINE</span><span class="s1">, </span><span class="s0">''</span><span class="s1">);</span>

    <span class="s2">codePoints </span><span class="s1">= </span><span class="s2">arrayFrom</span><span class="s1">(</span><span class="s2">input</span><span class="s1">);</span>

    <span class="s4">while </span><span class="s1">(</span><span class="s2">pointer </span><span class="s1">&lt;= </span><span class="s2">codePoints</span><span class="s1">.</span><span class="s2">length</span><span class="s1">) {</span>
      <span class="s2">chr </span><span class="s1">= </span><span class="s2">codePoints</span><span class="s1">[</span><span class="s2">pointer</span><span class="s1">];</span>
      <span class="s4">switch </span><span class="s1">(</span><span class="s2">state</span><span class="s1">) {</span>
        <span class="s4">case </span><span class="s2">SCHEME_START</span><span class="s1">:</span>
          <span class="s4">if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">&amp;&amp; </span><span class="s2">exec</span><span class="s1">(</span><span class="s2">ALPHA</span><span class="s1">, </span><span class="s2">chr</span><span class="s1">)) {</span>
            <span class="s2">buffer </span><span class="s1">+= </span><span class="s2">toLowerCase</span><span class="s1">(</span><span class="s2">chr</span><span class="s1">);</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">SCHEME</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">else if </span><span class="s1">(!</span><span class="s2">stateOverride</span><span class="s1">) {</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">NO_SCHEME</span><span class="s1">;</span>
            <span class="s4">continue</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">else return </span><span class="s2">INVALID_SCHEME</span><span class="s1">;</span>
          <span class="s4">break</span><span class="s1">;</span>

        <span class="s4">case </span><span class="s2">SCHEME</span><span class="s1">:</span>
          <span class="s4">if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">&amp;&amp; (</span><span class="s2">exec</span><span class="s1">(</span><span class="s2">ALPHANUMERIC</span><span class="s1">, </span><span class="s2">chr</span><span class="s1">) || </span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'+' </span><span class="s1">|| </span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'-' </span><span class="s1">|| </span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'.'</span><span class="s1">)) {</span>
            <span class="s2">buffer </span><span class="s1">+= </span><span class="s2">toLowerCase</span><span class="s1">(</span><span class="s2">chr</span><span class="s1">);</span>
          <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">':'</span><span class="s1">) {</span>
            <span class="s4">if </span><span class="s1">(</span><span class="s2">stateOverride </span><span class="s1">&amp;&amp; (</span>
              <span class="s1">(</span><span class="s2">url</span><span class="s1">.</span><span class="s2">isSpecial</span><span class="s1">() !== </span><span class="s2">hasOwn</span><span class="s1">(</span><span class="s2">specialSchemes</span><span class="s1">, </span><span class="s2">buffer</span><span class="s1">)) ||</span>
              <span class="s1">(</span><span class="s2">buffer </span><span class="s1">=== </span><span class="s0">'file' </span><span class="s1">&amp;&amp; (</span><span class="s2">url</span><span class="s1">.</span><span class="s2">includesCredentials</span><span class="s1">() || </span><span class="s2">url</span><span class="s1">.</span><span class="s2">port </span><span class="s1">!== </span><span class="s4">null</span><span class="s1">)) ||</span>
              <span class="s1">(</span><span class="s2">url</span><span class="s1">.</span><span class="s2">scheme </span><span class="s1">=== </span><span class="s0">'file' </span><span class="s1">&amp;&amp; !</span><span class="s2">url</span><span class="s1">.</span><span class="s2">host</span><span class="s1">)</span>
            <span class="s1">)) </span><span class="s4">return</span><span class="s1">;</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">scheme </span><span class="s1">= </span><span class="s2">buffer</span><span class="s1">;</span>
            <span class="s4">if </span><span class="s1">(</span><span class="s2">stateOverride</span><span class="s1">) {</span>
              <span class="s4">if </span><span class="s1">(</span><span class="s2">url</span><span class="s1">.</span><span class="s2">isSpecial</span><span class="s1">() &amp;&amp; </span><span class="s2">specialSchemes</span><span class="s1">[</span><span class="s2">url</span><span class="s1">.</span><span class="s2">scheme</span><span class="s1">] === </span><span class="s2">url</span><span class="s1">.</span><span class="s2">port</span><span class="s1">) </span><span class="s2">url</span><span class="s1">.</span><span class="s2">port </span><span class="s1">= </span><span class="s4">null</span><span class="s1">;</span>
              <span class="s4">return</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s2">buffer </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
            <span class="s4">if </span><span class="s1">(</span><span class="s2">url</span><span class="s1">.</span><span class="s2">scheme </span><span class="s1">=== </span><span class="s0">'file'</span><span class="s1">) {</span>
              <span class="s2">state </span><span class="s1">= </span><span class="s2">FILE</span><span class="s1">;</span>
            <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">url</span><span class="s1">.</span><span class="s2">isSpecial</span><span class="s1">() &amp;&amp; </span><span class="s2">base </span><span class="s1">&amp;&amp; </span><span class="s2">base</span><span class="s1">.</span><span class="s2">scheme </span><span class="s1">=== </span><span class="s2">url</span><span class="s1">.</span><span class="s2">scheme</span><span class="s1">) {</span>
              <span class="s2">state </span><span class="s1">= </span><span class="s2">SPECIAL_RELATIVE_OR_AUTHORITY</span><span class="s1">;</span>
            <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">url</span><span class="s1">.</span><span class="s2">isSpecial</span><span class="s1">()) {</span>
              <span class="s2">state </span><span class="s1">= </span><span class="s2">SPECIAL_AUTHORITY_SLASHES</span><span class="s1">;</span>
            <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">codePoints</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">+ </span><span class="s6">1</span><span class="s1">] === </span><span class="s0">'/'</span><span class="s1">) {</span>
              <span class="s2">state </span><span class="s1">= </span><span class="s2">PATH_OR_AUTHORITY</span><span class="s1">;</span>
              <span class="s2">pointer</span><span class="s1">++;</span>
            <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
              <span class="s2">url</span><span class="s1">.</span><span class="s2">cannotBeABaseURL </span><span class="s1">= </span><span class="s4">true</span><span class="s1">;</span>
              <span class="s2">push</span><span class="s1">(</span><span class="s2">url</span><span class="s1">.</span><span class="s2">path</span><span class="s1">, </span><span class="s0">''</span><span class="s1">);</span>
              <span class="s2">state </span><span class="s1">= </span><span class="s2">CANNOT_BE_A_BASE_URL_PATH</span><span class="s1">;</span>
            <span class="s1">}</span>
          <span class="s1">} </span><span class="s4">else if </span><span class="s1">(!</span><span class="s2">stateOverride</span><span class="s1">) {</span>
            <span class="s2">buffer </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">NO_SCHEME</span><span class="s1">;</span>
            <span class="s2">pointer </span><span class="s1">= </span><span class="s6">0</span><span class="s1">;</span>
            <span class="s4">continue</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">else return </span><span class="s2">INVALID_SCHEME</span><span class="s1">;</span>
          <span class="s4">break</span><span class="s1">;</span>

        <span class="s4">case </span><span class="s2">NO_SCHEME</span><span class="s1">:</span>
          <span class="s4">if </span><span class="s1">(!</span><span class="s2">base </span><span class="s1">|| (</span><span class="s2">base</span><span class="s1">.</span><span class="s2">cannotBeABaseURL </span><span class="s1">&amp;&amp; </span><span class="s2">chr </span><span class="s1">!== </span><span class="s0">'#'</span><span class="s1">)) </span><span class="s4">return </span><span class="s2">INVALID_SCHEME</span><span class="s1">;</span>
          <span class="s4">if </span><span class="s1">(</span><span class="s2">base</span><span class="s1">.</span><span class="s2">cannotBeABaseURL </span><span class="s1">&amp;&amp; </span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'#'</span><span class="s1">) {</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">scheme </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">scheme</span><span class="s1">;</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">path </span><span class="s1">= </span><span class="s2">arraySlice</span><span class="s1">(</span><span class="s2">base</span><span class="s1">.</span><span class="s2">path</span><span class="s1">);</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">query </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">query</span><span class="s1">;</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">fragment </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">cannotBeABaseURL </span><span class="s1">= </span><span class="s4">true</span><span class="s1">;</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">FRAGMENT</span><span class="s1">;</span>
            <span class="s4">break</span><span class="s1">;</span>
          <span class="s1">}</span>
          <span class="s2">state </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">scheme </span><span class="s1">=== </span><span class="s0">'file' </span><span class="s1">? </span><span class="s2">FILE </span><span class="s1">: </span><span class="s2">RELATIVE</span><span class="s1">;</span>
          <span class="s4">continue</span><span class="s1">;</span>

        <span class="s4">case </span><span class="s2">SPECIAL_RELATIVE_OR_AUTHORITY</span><span class="s1">:</span>
          <span class="s4">if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'/' </span><span class="s1">&amp;&amp; </span><span class="s2">codePoints</span><span class="s1">[</span><span class="s2">pointer </span><span class="s1">+ </span><span class="s6">1</span><span class="s1">] === </span><span class="s0">'/'</span><span class="s1">) {</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">SPECIAL_AUTHORITY_IGNORE_SLASHES</span><span class="s1">;</span>
            <span class="s2">pointer</span><span class="s1">++;</span>
          <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">RELATIVE</span><span class="s1">;</span>
            <span class="s4">continue</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">break</span><span class="s1">;</span>

        <span class="s4">case </span><span class="s2">PATH_OR_AUTHORITY</span><span class="s1">:</span>
          <span class="s4">if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'/'</span><span class="s1">) {</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">AUTHORITY</span><span class="s1">;</span>
            <span class="s4">break</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">PATH</span><span class="s1">;</span>
            <span class="s4">continue</span><span class="s1">;</span>
          <span class="s1">}</span>

        <span class="s4">case </span><span class="s2">RELATIVE</span><span class="s1">:</span>
          <span class="s2">url</span><span class="s1">.</span><span class="s2">scheme </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">scheme</span><span class="s1">;</span>
          <span class="s4">if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">=== </span><span class="s2">EOF</span><span class="s1">) {</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">username </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">username</span><span class="s1">;</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">password </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">password</span><span class="s1">;</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">host </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">host</span><span class="s1">;</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">port </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">port</span><span class="s1">;</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">path </span><span class="s1">= </span><span class="s2">arraySlice</span><span class="s1">(</span><span class="s2">base</span><span class="s1">.</span><span class="s2">path</span><span class="s1">);</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">query </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">query</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'/' </span><span class="s1">|| (</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'</span><span class="s4">\\</span><span class="s0">' </span><span class="s1">&amp;&amp; </span><span class="s2">url</span><span class="s1">.</span><span class="s2">isSpecial</span><span class="s1">())) {</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">RELATIVE_SLASH</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'?'</span><span class="s1">) {</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">username </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">username</span><span class="s1">;</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">password </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">password</span><span class="s1">;</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">host </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">host</span><span class="s1">;</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">port </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">port</span><span class="s1">;</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">path </span><span class="s1">= </span><span class="s2">arraySlice</span><span class="s1">(</span><span class="s2">base</span><span class="s1">.</span><span class="s2">path</span><span class="s1">);</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">query </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">QUERY</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'#'</span><span class="s1">) {</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">username </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">username</span><span class="s1">;</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">password </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">password</span><span class="s1">;</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">host </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">host</span><span class="s1">;</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">port </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">port</span><span class="s1">;</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">path </span><span class="s1">= </span><span class="s2">arraySlice</span><span class="s1">(</span><span class="s2">base</span><span class="s1">.</span><span class="s2">path</span><span class="s1">);</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">query </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">query</span><span class="s1">;</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">fragment </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">FRAGMENT</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">username </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">username</span><span class="s1">;</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">password </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">password</span><span class="s1">;</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">host </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">host</span><span class="s1">;</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">port </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">port</span><span class="s1">;</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">path </span><span class="s1">= </span><span class="s2">arraySlice</span><span class="s1">(</span><span class="s2">base</span><span class="s1">.</span><span class="s2">path</span><span class="s1">);</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">path</span><span class="s1">.</span><span class="s2">length</span><span class="s1">--;</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">PATH</span><span class="s1">;</span>
            <span class="s4">continue</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">break</span><span class="s1">;</span>

        <span class="s4">case </span><span class="s2">RELATIVE_SLASH</span><span class="s1">:</span>
          <span class="s4">if </span><span class="s1">(</span><span class="s2">url</span><span class="s1">.</span><span class="s2">isSpecial</span><span class="s1">() &amp;&amp; (</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'/' </span><span class="s1">|| </span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'</span><span class="s4">\\</span><span class="s0">'</span><span class="s1">)) {</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">SPECIAL_AUTHORITY_IGNORE_SLASHES</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'/'</span><span class="s1">) {</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">AUTHORITY</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">username </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">username</span><span class="s1">;</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">password </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">password</span><span class="s1">;</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">host </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">host</span><span class="s1">;</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">port </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">port</span><span class="s1">;</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">PATH</span><span class="s1">;</span>
            <span class="s4">continue</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">break</span><span class="s1">;</span>

        <span class="s4">case </span><span class="s2">SPECIAL_AUTHORITY_SLASHES</span><span class="s1">:</span>
          <span class="s2">state </span><span class="s1">= </span><span class="s2">SPECIAL_AUTHORITY_IGNORE_SLASHES</span><span class="s1">;</span>
          <span class="s4">if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">!== </span><span class="s0">'/' </span><span class="s1">|| </span><span class="s2">charAt</span><span class="s1">(</span><span class="s2">buffer</span><span class="s1">, </span><span class="s2">pointer </span><span class="s1">+ </span><span class="s6">1</span><span class="s1">) !== </span><span class="s0">'/'</span><span class="s1">) </span><span class="s4">continue</span><span class="s1">;</span>
          <span class="s2">pointer</span><span class="s1">++;</span>
          <span class="s4">break</span><span class="s1">;</span>

        <span class="s4">case </span><span class="s2">SPECIAL_AUTHORITY_IGNORE_SLASHES</span><span class="s1">:</span>
          <span class="s4">if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">!== </span><span class="s0">'/' </span><span class="s1">&amp;&amp; </span><span class="s2">chr </span><span class="s1">!== </span><span class="s0">'</span><span class="s4">\\</span><span class="s0">'</span><span class="s1">) {</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">AUTHORITY</span><span class="s1">;</span>
            <span class="s4">continue</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">break</span><span class="s1">;</span>

        <span class="s4">case </span><span class="s2">AUTHORITY</span><span class="s1">:</span>
          <span class="s4">if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'@'</span><span class="s1">) {</span>
            <span class="s4">if </span><span class="s1">(</span><span class="s2">seenAt</span><span class="s1">) </span><span class="s2">buffer </span><span class="s1">= </span><span class="s0">'%40' </span><span class="s1">+ </span><span class="s2">buffer</span><span class="s1">;</span>
            <span class="s2">seenAt </span><span class="s1">= </span><span class="s4">true</span><span class="s1">;</span>
            <span class="s2">bufferCodePoints </span><span class="s1">= </span><span class="s2">arrayFrom</span><span class="s1">(</span><span class="s2">buffer</span><span class="s1">);</span>
            <span class="s4">for </span><span class="s1">(</span><span class="s4">var </span><span class="s2">i </span><span class="s1">= </span><span class="s6">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">bufferCodePoints</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">i</span><span class="s1">++) {</span>
              <span class="s4">var </span><span class="s2">codePoint </span><span class="s1">= </span><span class="s2">bufferCodePoints</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>
              <span class="s4">if </span><span class="s1">(</span><span class="s2">codePoint </span><span class="s1">=== </span><span class="s0">':' </span><span class="s1">&amp;&amp; !</span><span class="s2">seenPasswordToken</span><span class="s1">) {</span>
                <span class="s2">seenPasswordToken </span><span class="s1">= </span><span class="s4">true</span><span class="s1">;</span>
                <span class="s4">continue</span><span class="s1">;</span>
              <span class="s1">}</span>
              <span class="s4">var </span><span class="s2">encodedCodePoints </span><span class="s1">= </span><span class="s2">percentEncode</span><span class="s1">(</span><span class="s2">codePoint</span><span class="s1">, </span><span class="s2">userinfoPercentEncodeSet</span><span class="s1">);</span>
              <span class="s4">if </span><span class="s1">(</span><span class="s2">seenPasswordToken</span><span class="s1">) </span><span class="s2">url</span><span class="s1">.</span><span class="s2">password </span><span class="s1">+= </span><span class="s2">encodedCodePoints</span><span class="s1">;</span>
              <span class="s4">else </span><span class="s2">url</span><span class="s1">.</span><span class="s2">username </span><span class="s1">+= </span><span class="s2">encodedCodePoints</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s2">buffer </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span>
            <span class="s2">chr </span><span class="s1">=== </span><span class="s2">EOF </span><span class="s1">|| </span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'/' </span><span class="s1">|| </span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'?' </span><span class="s1">|| </span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'#' </span><span class="s1">||</span>
            <span class="s1">(</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'</span><span class="s4">\\</span><span class="s0">' </span><span class="s1">&amp;&amp; </span><span class="s2">url</span><span class="s1">.</span><span class="s2">isSpecial</span><span class="s1">())</span>
          <span class="s1">) {</span>
            <span class="s4">if </span><span class="s1">(</span><span class="s2">seenAt </span><span class="s1">&amp;&amp; </span><span class="s2">buffer </span><span class="s1">=== </span><span class="s0">''</span><span class="s1">) </span><span class="s4">return </span><span class="s2">INVALID_AUTHORITY</span><span class="s1">;</span>
            <span class="s2">pointer </span><span class="s1">-= </span><span class="s2">arrayFrom</span><span class="s1">(</span><span class="s2">buffer</span><span class="s1">).</span><span class="s2">length </span><span class="s1">+ </span><span class="s6">1</span><span class="s1">;</span>
            <span class="s2">buffer </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">HOST</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">else </span><span class="s2">buffer </span><span class="s1">+= </span><span class="s2">chr</span><span class="s1">;</span>
          <span class="s4">break</span><span class="s1">;</span>

        <span class="s4">case </span><span class="s2">HOST</span><span class="s1">:</span>
        <span class="s4">case </span><span class="s2">HOSTNAME</span><span class="s1">:</span>
          <span class="s4">if </span><span class="s1">(</span><span class="s2">stateOverride </span><span class="s1">&amp;&amp; </span><span class="s2">url</span><span class="s1">.</span><span class="s2">scheme </span><span class="s1">=== </span><span class="s0">'file'</span><span class="s1">) {</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">FILE_HOST</span><span class="s1">;</span>
            <span class="s4">continue</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">':' </span><span class="s1">&amp;&amp; !</span><span class="s2">seenBracket</span><span class="s1">) {</span>
            <span class="s4">if </span><span class="s1">(</span><span class="s2">buffer </span><span class="s1">=== </span><span class="s0">''</span><span class="s1">) </span><span class="s4">return </span><span class="s2">INVALID_HOST</span><span class="s1">;</span>
            <span class="s2">failure </span><span class="s1">= </span><span class="s2">url</span><span class="s1">.</span><span class="s2">parseHost</span><span class="s1">(</span><span class="s2">buffer</span><span class="s1">);</span>
            <span class="s4">if </span><span class="s1">(</span><span class="s2">failure</span><span class="s1">) </span><span class="s4">return </span><span class="s2">failure</span><span class="s1">;</span>
            <span class="s2">buffer </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">PORT</span><span class="s1">;</span>
            <span class="s4">if </span><span class="s1">(</span><span class="s2">stateOverride </span><span class="s1">=== </span><span class="s2">HOSTNAME</span><span class="s1">) </span><span class="s4">return</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span>
            <span class="s2">chr </span><span class="s1">=== </span><span class="s2">EOF </span><span class="s1">|| </span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'/' </span><span class="s1">|| </span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'?' </span><span class="s1">|| </span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'#' </span><span class="s1">||</span>
            <span class="s1">(</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'</span><span class="s4">\\</span><span class="s0">' </span><span class="s1">&amp;&amp; </span><span class="s2">url</span><span class="s1">.</span><span class="s2">isSpecial</span><span class="s1">())</span>
          <span class="s1">) {</span>
            <span class="s4">if </span><span class="s1">(</span><span class="s2">url</span><span class="s1">.</span><span class="s2">isSpecial</span><span class="s1">() &amp;&amp; </span><span class="s2">buffer </span><span class="s1">=== </span><span class="s0">''</span><span class="s1">) </span><span class="s4">return </span><span class="s2">INVALID_HOST</span><span class="s1">;</span>
            <span class="s4">if </span><span class="s1">(</span><span class="s2">stateOverride </span><span class="s1">&amp;&amp; </span><span class="s2">buffer </span><span class="s1">=== </span><span class="s0">'' </span><span class="s1">&amp;&amp; (</span><span class="s2">url</span><span class="s1">.</span><span class="s2">includesCredentials</span><span class="s1">() || </span><span class="s2">url</span><span class="s1">.</span><span class="s2">port </span><span class="s1">!== </span><span class="s4">null</span><span class="s1">)) </span><span class="s4">return</span><span class="s1">;</span>
            <span class="s2">failure </span><span class="s1">= </span><span class="s2">url</span><span class="s1">.</span><span class="s2">parseHost</span><span class="s1">(</span><span class="s2">buffer</span><span class="s1">);</span>
            <span class="s4">if </span><span class="s1">(</span><span class="s2">failure</span><span class="s1">) </span><span class="s4">return </span><span class="s2">failure</span><span class="s1">;</span>
            <span class="s2">buffer </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">PATH_START</span><span class="s1">;</span>
            <span class="s4">if </span><span class="s1">(</span><span class="s2">stateOverride</span><span class="s1">) </span><span class="s4">return</span><span class="s1">;</span>
            <span class="s4">continue</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
            <span class="s4">if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'['</span><span class="s1">) </span><span class="s2">seenBracket </span><span class="s1">= </span><span class="s4">true</span><span class="s1">;</span>
            <span class="s4">else if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">']'</span><span class="s1">) </span><span class="s2">seenBracket </span><span class="s1">= </span><span class="s4">false</span><span class="s1">;</span>
            <span class="s2">buffer </span><span class="s1">+= </span><span class="s2">chr</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">break</span><span class="s1">;</span>

        <span class="s4">case </span><span class="s2">PORT</span><span class="s1">:</span>
          <span class="s4">if </span><span class="s1">(</span><span class="s2">exec</span><span class="s1">(</span><span class="s2">DIGIT</span><span class="s1">, </span><span class="s2">chr</span><span class="s1">)) {</span>
            <span class="s2">buffer </span><span class="s1">+= </span><span class="s2">chr</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span>
            <span class="s2">chr </span><span class="s1">=== </span><span class="s2">EOF </span><span class="s1">|| </span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'/' </span><span class="s1">|| </span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'?' </span><span class="s1">|| </span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'#' </span><span class="s1">||</span>
            <span class="s1">(</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'</span><span class="s4">\\</span><span class="s0">' </span><span class="s1">&amp;&amp; </span><span class="s2">url</span><span class="s1">.</span><span class="s2">isSpecial</span><span class="s1">()) ||</span>
            <span class="s2">stateOverride</span>
          <span class="s1">) {</span>
            <span class="s4">if </span><span class="s1">(</span><span class="s2">buffer </span><span class="s1">!== </span><span class="s0">''</span><span class="s1">) {</span>
              <span class="s4">var </span><span class="s2">port </span><span class="s1">= </span><span class="s2">parseInt</span><span class="s1">(</span><span class="s2">buffer</span><span class="s1">, </span><span class="s6">10</span><span class="s1">);</span>
              <span class="s4">if </span><span class="s1">(</span><span class="s2">port </span><span class="s1">&gt; </span><span class="s6">0xFFFF</span><span class="s1">) </span><span class="s4">return </span><span class="s2">INVALID_PORT</span><span class="s1">;</span>
              <span class="s2">url</span><span class="s1">.</span><span class="s2">port </span><span class="s1">= (</span><span class="s2">url</span><span class="s1">.</span><span class="s2">isSpecial</span><span class="s1">() &amp;&amp; </span><span class="s2">port </span><span class="s1">=== </span><span class="s2">specialSchemes</span><span class="s1">[</span><span class="s2">url</span><span class="s1">.</span><span class="s2">scheme</span><span class="s1">]) ? </span><span class="s4">null </span><span class="s1">: </span><span class="s2">port</span><span class="s1">;</span>
              <span class="s2">buffer </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s4">if </span><span class="s1">(</span><span class="s2">stateOverride</span><span class="s1">) </span><span class="s4">return</span><span class="s1">;</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">PATH_START</span><span class="s1">;</span>
            <span class="s4">continue</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">else return </span><span class="s2">INVALID_PORT</span><span class="s1">;</span>
          <span class="s4">break</span><span class="s1">;</span>

        <span class="s4">case </span><span class="s2">FILE</span><span class="s1">:</span>
          <span class="s2">url</span><span class="s1">.</span><span class="s2">scheme </span><span class="s1">= </span><span class="s0">'file'</span><span class="s1">;</span>
          <span class="s4">if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'/' </span><span class="s1">|| </span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'</span><span class="s4">\\</span><span class="s0">'</span><span class="s1">) </span><span class="s2">state </span><span class="s1">= </span><span class="s2">FILE_SLASH</span><span class="s1">;</span>
          <span class="s4">else if </span><span class="s1">(</span><span class="s2">base </span><span class="s1">&amp;&amp; </span><span class="s2">base</span><span class="s1">.</span><span class="s2">scheme </span><span class="s1">=== </span><span class="s0">'file'</span><span class="s1">) {</span>
            <span class="s4">switch </span><span class="s1">(</span><span class="s2">chr</span><span class="s1">) {</span>
              <span class="s4">case </span><span class="s2">EOF</span><span class="s1">:</span>
                <span class="s2">url</span><span class="s1">.</span><span class="s2">host </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">host</span><span class="s1">;</span>
                <span class="s2">url</span><span class="s1">.</span><span class="s2">path </span><span class="s1">= </span><span class="s2">arraySlice</span><span class="s1">(</span><span class="s2">base</span><span class="s1">.</span><span class="s2">path</span><span class="s1">);</span>
                <span class="s2">url</span><span class="s1">.</span><span class="s2">query </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">query</span><span class="s1">;</span>
                <span class="s4">break</span><span class="s1">;</span>
              <span class="s4">case </span><span class="s0">'?'</span><span class="s1">:</span>
                <span class="s2">url</span><span class="s1">.</span><span class="s2">host </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">host</span><span class="s1">;</span>
                <span class="s2">url</span><span class="s1">.</span><span class="s2">path </span><span class="s1">= </span><span class="s2">arraySlice</span><span class="s1">(</span><span class="s2">base</span><span class="s1">.</span><span class="s2">path</span><span class="s1">);</span>
                <span class="s2">url</span><span class="s1">.</span><span class="s2">query </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
                <span class="s2">state </span><span class="s1">= </span><span class="s2">QUERY</span><span class="s1">;</span>
                <span class="s4">break</span><span class="s1">;</span>
              <span class="s4">case </span><span class="s0">'#'</span><span class="s1">:</span>
                <span class="s2">url</span><span class="s1">.</span><span class="s2">host </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">host</span><span class="s1">;</span>
                <span class="s2">url</span><span class="s1">.</span><span class="s2">path </span><span class="s1">= </span><span class="s2">arraySlice</span><span class="s1">(</span><span class="s2">base</span><span class="s1">.</span><span class="s2">path</span><span class="s1">);</span>
                <span class="s2">url</span><span class="s1">.</span><span class="s2">query </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">query</span><span class="s1">;</span>
                <span class="s2">url</span><span class="s1">.</span><span class="s2">fragment </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
                <span class="s2">state </span><span class="s1">= </span><span class="s2">FRAGMENT</span><span class="s1">;</span>
                <span class="s4">break</span><span class="s1">;</span>
              <span class="s4">default</span><span class="s1">:</span>
                <span class="s4">if </span><span class="s1">(!</span><span class="s2">startsWithWindowsDriveLetter</span><span class="s1">(</span><span class="s2">join</span><span class="s1">(</span><span class="s2">arraySlice</span><span class="s1">(</span><span class="s2">codePoints</span><span class="s1">, </span><span class="s2">pointer</span><span class="s1">), </span><span class="s0">''</span><span class="s1">))) {</span>
                  <span class="s2">url</span><span class="s1">.</span><span class="s2">host </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">host</span><span class="s1">;</span>
                  <span class="s2">url</span><span class="s1">.</span><span class="s2">path </span><span class="s1">= </span><span class="s2">arraySlice</span><span class="s1">(</span><span class="s2">base</span><span class="s1">.</span><span class="s2">path</span><span class="s1">);</span>
                  <span class="s2">url</span><span class="s1">.</span><span class="s2">shortenPath</span><span class="s1">();</span>
                <span class="s1">}</span>
                <span class="s2">state </span><span class="s1">= </span><span class="s2">PATH</span><span class="s1">;</span>
                <span class="s4">continue</span><span class="s1">;</span>
            <span class="s1">}</span>
          <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">PATH</span><span class="s1">;</span>
            <span class="s4">continue</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">break</span><span class="s1">;</span>

        <span class="s4">case </span><span class="s2">FILE_SLASH</span><span class="s1">:</span>
          <span class="s4">if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'/' </span><span class="s1">|| </span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'</span><span class="s4">\\</span><span class="s0">'</span><span class="s1">) {</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">FILE_HOST</span><span class="s1">;</span>
            <span class="s4">break</span><span class="s1">;</span>
          <span class="s1">}</span>
          <span class="s4">if </span><span class="s1">(</span><span class="s2">base </span><span class="s1">&amp;&amp; </span><span class="s2">base</span><span class="s1">.</span><span class="s2">scheme </span><span class="s1">=== </span><span class="s0">'file' </span><span class="s1">&amp;&amp; !</span><span class="s2">startsWithWindowsDriveLetter</span><span class="s1">(</span><span class="s2">join</span><span class="s1">(</span><span class="s2">arraySlice</span><span class="s1">(</span><span class="s2">codePoints</span><span class="s1">, </span><span class="s2">pointer</span><span class="s1">), </span><span class="s0">''</span><span class="s1">))) {</span>
            <span class="s4">if </span><span class="s1">(</span><span class="s2">isWindowsDriveLetter</span><span class="s1">(</span><span class="s2">base</span><span class="s1">.</span><span class="s2">path</span><span class="s1">[</span><span class="s6">0</span><span class="s1">], </span><span class="s4">true</span><span class="s1">)) </span><span class="s2">push</span><span class="s1">(</span><span class="s2">url</span><span class="s1">.</span><span class="s2">path</span><span class="s1">, </span><span class="s2">base</span><span class="s1">.</span><span class="s2">path</span><span class="s1">[</span><span class="s6">0</span><span class="s1">]);</span>
            <span class="s4">else </span><span class="s2">url</span><span class="s1">.</span><span class="s2">host </span><span class="s1">= </span><span class="s2">base</span><span class="s1">.</span><span class="s2">host</span><span class="s1">;</span>
          <span class="s1">}</span>
          <span class="s2">state </span><span class="s1">= </span><span class="s2">PATH</span><span class="s1">;</span>
          <span class="s4">continue</span><span class="s1">;</span>

        <span class="s4">case </span><span class="s2">FILE_HOST</span><span class="s1">:</span>
          <span class="s4">if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">=== </span><span class="s2">EOF </span><span class="s1">|| </span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'/' </span><span class="s1">|| </span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'</span><span class="s4">\\</span><span class="s0">' </span><span class="s1">|| </span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'?' </span><span class="s1">|| </span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'#'</span><span class="s1">) {</span>
            <span class="s4">if </span><span class="s1">(!</span><span class="s2">stateOverride </span><span class="s1">&amp;&amp; </span><span class="s2">isWindowsDriveLetter</span><span class="s1">(</span><span class="s2">buffer</span><span class="s1">)) {</span>
              <span class="s2">state </span><span class="s1">= </span><span class="s2">PATH</span><span class="s1">;</span>
            <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">buffer </span><span class="s1">=== </span><span class="s0">''</span><span class="s1">) {</span>
              <span class="s2">url</span><span class="s1">.</span><span class="s2">host </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
              <span class="s4">if </span><span class="s1">(</span><span class="s2">stateOverride</span><span class="s1">) </span><span class="s4">return</span><span class="s1">;</span>
              <span class="s2">state </span><span class="s1">= </span><span class="s2">PATH_START</span><span class="s1">;</span>
            <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
              <span class="s2">failure </span><span class="s1">= </span><span class="s2">url</span><span class="s1">.</span><span class="s2">parseHost</span><span class="s1">(</span><span class="s2">buffer</span><span class="s1">);</span>
              <span class="s4">if </span><span class="s1">(</span><span class="s2">failure</span><span class="s1">) </span><span class="s4">return </span><span class="s2">failure</span><span class="s1">;</span>
              <span class="s4">if </span><span class="s1">(</span><span class="s2">url</span><span class="s1">.</span><span class="s2">host </span><span class="s1">=== </span><span class="s0">'localhost'</span><span class="s1">) </span><span class="s2">url</span><span class="s1">.</span><span class="s2">host </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
              <span class="s4">if </span><span class="s1">(</span><span class="s2">stateOverride</span><span class="s1">) </span><span class="s4">return</span><span class="s1">;</span>
              <span class="s2">buffer </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
              <span class="s2">state </span><span class="s1">= </span><span class="s2">PATH_START</span><span class="s1">;</span>
            <span class="s1">} </span><span class="s4">continue</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">else </span><span class="s2">buffer </span><span class="s1">+= </span><span class="s2">chr</span><span class="s1">;</span>
          <span class="s4">break</span><span class="s1">;</span>

        <span class="s4">case </span><span class="s2">PATH_START</span><span class="s1">:</span>
          <span class="s4">if </span><span class="s1">(</span><span class="s2">url</span><span class="s1">.</span><span class="s2">isSpecial</span><span class="s1">()) {</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">PATH</span><span class="s1">;</span>
            <span class="s4">if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">!== </span><span class="s0">'/' </span><span class="s1">&amp;&amp; </span><span class="s2">chr </span><span class="s1">!== </span><span class="s0">'</span><span class="s4">\\</span><span class="s0">'</span><span class="s1">) </span><span class="s4">continue</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">else if </span><span class="s1">(!</span><span class="s2">stateOverride </span><span class="s1">&amp;&amp; </span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'?'</span><span class="s1">) {</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">query </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">QUERY</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">else if </span><span class="s1">(!</span><span class="s2">stateOverride </span><span class="s1">&amp;&amp; </span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'#'</span><span class="s1">) {</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">fragment </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">FRAGMENT</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">!== </span><span class="s2">EOF</span><span class="s1">) {</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">PATH</span><span class="s1">;</span>
            <span class="s4">if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">!== </span><span class="s0">'/'</span><span class="s1">) </span><span class="s4">continue</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">break</span><span class="s1">;</span>

        <span class="s4">case </span><span class="s2">PATH</span><span class="s1">:</span>
          <span class="s4">if </span><span class="s1">(</span>
            <span class="s2">chr </span><span class="s1">=== </span><span class="s2">EOF </span><span class="s1">|| </span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'/' </span><span class="s1">||</span>
            <span class="s1">(</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'</span><span class="s4">\\</span><span class="s0">' </span><span class="s1">&amp;&amp; </span><span class="s2">url</span><span class="s1">.</span><span class="s2">isSpecial</span><span class="s1">()) ||</span>
            <span class="s1">(!</span><span class="s2">stateOverride </span><span class="s1">&amp;&amp; (</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'?' </span><span class="s1">|| </span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'#'</span><span class="s1">))</span>
          <span class="s1">) {</span>
            <span class="s4">if </span><span class="s1">(</span><span class="s2">isDoubleDot</span><span class="s1">(</span><span class="s2">buffer</span><span class="s1">)) {</span>
              <span class="s2">url</span><span class="s1">.</span><span class="s2">shortenPath</span><span class="s1">();</span>
              <span class="s4">if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">!== </span><span class="s0">'/' </span><span class="s1">&amp;&amp; !(</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'</span><span class="s4">\\</span><span class="s0">' </span><span class="s1">&amp;&amp; </span><span class="s2">url</span><span class="s1">.</span><span class="s2">isSpecial</span><span class="s1">())) {</span>
                <span class="s2">push</span><span class="s1">(</span><span class="s2">url</span><span class="s1">.</span><span class="s2">path</span><span class="s1">, </span><span class="s0">''</span><span class="s1">);</span>
              <span class="s1">}</span>
            <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">isSingleDot</span><span class="s1">(</span><span class="s2">buffer</span><span class="s1">)) {</span>
              <span class="s4">if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">!== </span><span class="s0">'/' </span><span class="s1">&amp;&amp; !(</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'</span><span class="s4">\\</span><span class="s0">' </span><span class="s1">&amp;&amp; </span><span class="s2">url</span><span class="s1">.</span><span class="s2">isSpecial</span><span class="s1">())) {</span>
                <span class="s2">push</span><span class="s1">(</span><span class="s2">url</span><span class="s1">.</span><span class="s2">path</span><span class="s1">, </span><span class="s0">''</span><span class="s1">);</span>
              <span class="s1">}</span>
            <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
              <span class="s4">if </span><span class="s1">(</span><span class="s2">url</span><span class="s1">.</span><span class="s2">scheme </span><span class="s1">=== </span><span class="s0">'file' </span><span class="s1">&amp;&amp; !</span><span class="s2">url</span><span class="s1">.</span><span class="s2">path</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&amp;&amp; </span><span class="s2">isWindowsDriveLetter</span><span class="s1">(</span><span class="s2">buffer</span><span class="s1">)) {</span>
                <span class="s4">if </span><span class="s1">(</span><span class="s2">url</span><span class="s1">.</span><span class="s2">host</span><span class="s1">) </span><span class="s2">url</span><span class="s1">.</span><span class="s2">host </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
                <span class="s2">buffer </span><span class="s1">= </span><span class="s2">charAt</span><span class="s1">(</span><span class="s2">buffer</span><span class="s1">, </span><span class="s6">0</span><span class="s1">) + </span><span class="s0">':'</span><span class="s1">; </span><span class="s3">// normalize windows drive letter</span>
              <span class="s1">}</span>
              <span class="s2">push</span><span class="s1">(</span><span class="s2">url</span><span class="s1">.</span><span class="s2">path</span><span class="s1">, </span><span class="s2">buffer</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s2">buffer </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
            <span class="s4">if </span><span class="s1">(</span><span class="s2">url</span><span class="s1">.</span><span class="s2">scheme </span><span class="s1">=== </span><span class="s0">'file' </span><span class="s1">&amp;&amp; (</span><span class="s2">chr </span><span class="s1">=== </span><span class="s2">EOF </span><span class="s1">|| </span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'?' </span><span class="s1">|| </span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'#'</span><span class="s1">)) {</span>
              <span class="s4">while </span><span class="s1">(</span><span class="s2">url</span><span class="s1">.</span><span class="s2">path</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s6">1 </span><span class="s1">&amp;&amp; </span><span class="s2">url</span><span class="s1">.</span><span class="s2">path</span><span class="s1">[</span><span class="s6">0</span><span class="s1">] === </span><span class="s0">''</span><span class="s1">) {</span>
                <span class="s2">shift</span><span class="s1">(</span><span class="s2">url</span><span class="s1">.</span><span class="s2">path</span><span class="s1">);</span>
              <span class="s1">}</span>
            <span class="s1">}</span>
            <span class="s4">if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'?'</span><span class="s1">) {</span>
              <span class="s2">url</span><span class="s1">.</span><span class="s2">query </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
              <span class="s2">state </span><span class="s1">= </span><span class="s2">QUERY</span><span class="s1">;</span>
            <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'#'</span><span class="s1">) {</span>
              <span class="s2">url</span><span class="s1">.</span><span class="s2">fragment </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
              <span class="s2">state </span><span class="s1">= </span><span class="s2">FRAGMENT</span><span class="s1">;</span>
            <span class="s1">}</span>
          <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
            <span class="s2">buffer </span><span class="s1">+= </span><span class="s2">percentEncode</span><span class="s1">(</span><span class="s2">chr</span><span class="s1">, </span><span class="s2">pathPercentEncodeSet</span><span class="s1">);</span>
          <span class="s1">} </span><span class="s4">break</span><span class="s1">;</span>

        <span class="s4">case </span><span class="s2">CANNOT_BE_A_BASE_URL_PATH</span><span class="s1">:</span>
          <span class="s4">if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'?'</span><span class="s1">) {</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">query </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">QUERY</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'#'</span><span class="s1">) {</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">fragment </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">FRAGMENT</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">!== </span><span class="s2">EOF</span><span class="s1">) {</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">path</span><span class="s1">[</span><span class="s6">0</span><span class="s1">] += </span><span class="s2">percentEncode</span><span class="s1">(</span><span class="s2">chr</span><span class="s1">, </span><span class="s2">C0ControlPercentEncodeSet</span><span class="s1">);</span>
          <span class="s1">} </span><span class="s4">break</span><span class="s1">;</span>

        <span class="s4">case </span><span class="s2">QUERY</span><span class="s1">:</span>
          <span class="s4">if </span><span class="s1">(!</span><span class="s2">stateOverride </span><span class="s1">&amp;&amp; </span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'#'</span><span class="s1">) {</span>
            <span class="s2">url</span><span class="s1">.</span><span class="s2">fragment </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
            <span class="s2">state </span><span class="s1">= </span><span class="s2">FRAGMENT</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">!== </span><span class="s2">EOF</span><span class="s1">) {</span>
            <span class="s4">if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">&quot;'&quot; </span><span class="s1">&amp;&amp; </span><span class="s2">url</span><span class="s1">.</span><span class="s2">isSpecial</span><span class="s1">()) </span><span class="s2">url</span><span class="s1">.</span><span class="s2">query </span><span class="s1">+= </span><span class="s0">'%27'</span><span class="s1">;</span>
            <span class="s4">else if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">=== </span><span class="s0">'#'</span><span class="s1">) </span><span class="s2">url</span><span class="s1">.</span><span class="s2">query </span><span class="s1">+= </span><span class="s0">'%23'</span><span class="s1">;</span>
            <span class="s4">else </span><span class="s2">url</span><span class="s1">.</span><span class="s2">query </span><span class="s1">+= </span><span class="s2">percentEncode</span><span class="s1">(</span><span class="s2">chr</span><span class="s1">, </span><span class="s2">C0ControlPercentEncodeSet</span><span class="s1">);</span>
          <span class="s1">} </span><span class="s4">break</span><span class="s1">;</span>

        <span class="s4">case </span><span class="s2">FRAGMENT</span><span class="s1">:</span>
          <span class="s4">if </span><span class="s1">(</span><span class="s2">chr </span><span class="s1">!== </span><span class="s2">EOF</span><span class="s1">) </span><span class="s2">url</span><span class="s1">.</span><span class="s2">fragment </span><span class="s1">+= </span><span class="s2">percentEncode</span><span class="s1">(</span><span class="s2">chr</span><span class="s1">, </span><span class="s2">fragmentPercentEncodeSet</span><span class="s1">);</span>
          <span class="s4">break</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s2">pointer</span><span class="s1">++;</span>
    <span class="s1">}</span>
  <span class="s1">},</span>
  <span class="s3">// https://url.spec.whatwg.org/#host-parsing</span>
  <span class="s2">parseHost</span><span class="s1">: </span><span class="s4">function </span><span class="s1">(</span><span class="s2">input</span><span class="s1">) {</span>
    <span class="s4">var </span><span class="s2">result</span><span class="s1">, </span><span class="s2">codePoints</span><span class="s1">, </span><span class="s2">index</span><span class="s1">;</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s2">charAt</span><span class="s1">(</span><span class="s2">input</span><span class="s1">, </span><span class="s6">0</span><span class="s1">) === </span><span class="s0">'['</span><span class="s1">) {</span>
      <span class="s4">if </span><span class="s1">(</span><span class="s2">charAt</span><span class="s1">(</span><span class="s2">input</span><span class="s1">, </span><span class="s2">input</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s6">1</span><span class="s1">) !== </span><span class="s0">']'</span><span class="s1">) </span><span class="s4">return </span><span class="s2">INVALID_HOST</span><span class="s1">;</span>
      <span class="s2">result </span><span class="s1">= </span><span class="s2">parseIPv6</span><span class="s1">(</span><span class="s2">stringSlice</span><span class="s1">(</span><span class="s2">input</span><span class="s1">, </span><span class="s6">1</span><span class="s1">, -</span><span class="s6">1</span><span class="s1">));</span>
      <span class="s4">if </span><span class="s1">(!</span><span class="s2">result</span><span class="s1">) </span><span class="s4">return </span><span class="s2">INVALID_HOST</span><span class="s1">;</span>
      <span class="s4">this</span><span class="s1">.</span><span class="s2">host </span><span class="s1">= </span><span class="s2">result</span><span class="s1">;</span>
    <span class="s3">// opaque host</span>
    <span class="s1">} </span><span class="s4">else if </span><span class="s1">(!</span><span class="s4">this</span><span class="s1">.</span><span class="s2">isSpecial</span><span class="s1">()) {</span>
      <span class="s4">if </span><span class="s1">(</span><span class="s2">exec</span><span class="s1">(</span><span class="s2">FORBIDDEN_HOST_CODE_POINT_EXCLUDING_PERCENT</span><span class="s1">, </span><span class="s2">input</span><span class="s1">)) </span><span class="s4">return </span><span class="s2">INVALID_HOST</span><span class="s1">;</span>
      <span class="s2">result </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
      <span class="s2">codePoints </span><span class="s1">= </span><span class="s2">arrayFrom</span><span class="s1">(</span><span class="s2">input</span><span class="s1">);</span>
      <span class="s4">for </span><span class="s1">(</span><span class="s2">index </span><span class="s1">= </span><span class="s6">0</span><span class="s1">; </span><span class="s2">index </span><span class="s1">&lt; </span><span class="s2">codePoints</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">index</span><span class="s1">++) {</span>
        <span class="s2">result </span><span class="s1">+= </span><span class="s2">percentEncode</span><span class="s1">(</span><span class="s2">codePoints</span><span class="s1">[</span><span class="s2">index</span><span class="s1">], </span><span class="s2">C0ControlPercentEncodeSet</span><span class="s1">);</span>
      <span class="s1">}</span>
      <span class="s4">this</span><span class="s1">.</span><span class="s2">host </span><span class="s1">= </span><span class="s2">result</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
      <span class="s2">input </span><span class="s1">= </span><span class="s2">toASCII</span><span class="s1">(</span><span class="s2">input</span><span class="s1">);</span>
      <span class="s4">if </span><span class="s1">(</span><span class="s2">exec</span><span class="s1">(</span><span class="s2">FORBIDDEN_HOST_CODE_POINT</span><span class="s1">, </span><span class="s2">input</span><span class="s1">)) </span><span class="s4">return </span><span class="s2">INVALID_HOST</span><span class="s1">;</span>
      <span class="s2">result </span><span class="s1">= </span><span class="s2">parseIPv4</span><span class="s1">(</span><span class="s2">input</span><span class="s1">);</span>
      <span class="s4">if </span><span class="s1">(</span><span class="s2">result </span><span class="s1">=== </span><span class="s4">null</span><span class="s1">) </span><span class="s4">return </span><span class="s2">INVALID_HOST</span><span class="s1">;</span>
      <span class="s4">this</span><span class="s1">.</span><span class="s2">host </span><span class="s1">= </span><span class="s2">result</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">},</span>
  <span class="s3">// https://url.spec.whatwg.org/#cannot-have-a-username-password-port</span>
  <span class="s2">cannotHaveUsernamePasswordPort</span><span class="s1">: </span><span class="s4">function </span><span class="s1">() {</span>
    <span class="s4">return </span><span class="s1">!</span><span class="s4">this</span><span class="s1">.</span><span class="s2">host </span><span class="s1">|| </span><span class="s4">this</span><span class="s1">.</span><span class="s2">cannotBeABaseURL </span><span class="s1">|| </span><span class="s4">this</span><span class="s1">.</span><span class="s2">scheme </span><span class="s1">=== </span><span class="s0">'file'</span><span class="s1">;</span>
  <span class="s1">},</span>
  <span class="s3">// https://url.spec.whatwg.org/#include-credentials</span>
  <span class="s2">includesCredentials</span><span class="s1">: </span><span class="s4">function </span><span class="s1">() {</span>
    <span class="s4">return this</span><span class="s1">.</span><span class="s2">username </span><span class="s1">!== </span><span class="s0">'' </span><span class="s1">|| </span><span class="s4">this</span><span class="s1">.</span><span class="s2">password </span><span class="s1">!== </span><span class="s0">''</span><span class="s1">;</span>
  <span class="s1">},</span>
  <span class="s3">// https://url.spec.whatwg.org/#is-special</span>
  <span class="s2">isSpecial</span><span class="s1">: </span><span class="s4">function </span><span class="s1">() {</span>
    <span class="s4">return </span><span class="s2">hasOwn</span><span class="s1">(</span><span class="s2">specialSchemes</span><span class="s1">, </span><span class="s4">this</span><span class="s1">.</span><span class="s2">scheme</span><span class="s1">);</span>
  <span class="s1">},</span>
  <span class="s3">// https://url.spec.whatwg.org/#shorten-a-urls-path</span>
  <span class="s2">shortenPath</span><span class="s1">: </span><span class="s4">function </span><span class="s1">() {</span>
    <span class="s4">var </span><span class="s2">path </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">path</span><span class="s1">;</span>
    <span class="s4">var </span><span class="s2">pathSize </span><span class="s1">= </span><span class="s2">path</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s2">pathSize </span><span class="s1">&amp;&amp; (</span><span class="s4">this</span><span class="s1">.</span><span class="s2">scheme </span><span class="s1">!== </span><span class="s0">'file' </span><span class="s1">|| </span><span class="s2">pathSize </span><span class="s1">!== </span><span class="s6">1 </span><span class="s1">|| !</span><span class="s2">isWindowsDriveLetter</span><span class="s1">(</span><span class="s2">path</span><span class="s1">[</span><span class="s6">0</span><span class="s1">], </span><span class="s4">true</span><span class="s1">))) {</span>
      <span class="s2">path</span><span class="s1">.</span><span class="s2">length</span><span class="s1">--;</span>
    <span class="s1">}</span>
  <span class="s1">},</span>
  <span class="s3">// https://url.spec.whatwg.org/#concept-url-serializer</span>
  <span class="s2">serialize</span><span class="s1">: </span><span class="s4">function </span><span class="s1">() {</span>
    <span class="s4">var </span><span class="s2">url </span><span class="s1">= </span><span class="s4">this</span><span class="s1">;</span>
    <span class="s4">var </span><span class="s2">scheme </span><span class="s1">= </span><span class="s2">url</span><span class="s1">.</span><span class="s2">scheme</span><span class="s1">;</span>
    <span class="s4">var </span><span class="s2">username </span><span class="s1">= </span><span class="s2">url</span><span class="s1">.</span><span class="s2">username</span><span class="s1">;</span>
    <span class="s4">var </span><span class="s2">password </span><span class="s1">= </span><span class="s2">url</span><span class="s1">.</span><span class="s2">password</span><span class="s1">;</span>
    <span class="s4">var </span><span class="s2">host </span><span class="s1">= </span><span class="s2">url</span><span class="s1">.</span><span class="s2">host</span><span class="s1">;</span>
    <span class="s4">var </span><span class="s2">port </span><span class="s1">= </span><span class="s2">url</span><span class="s1">.</span><span class="s2">port</span><span class="s1">;</span>
    <span class="s4">var </span><span class="s2">path </span><span class="s1">= </span><span class="s2">url</span><span class="s1">.</span><span class="s2">path</span><span class="s1">;</span>
    <span class="s4">var </span><span class="s2">query </span><span class="s1">= </span><span class="s2">url</span><span class="s1">.</span><span class="s2">query</span><span class="s1">;</span>
    <span class="s4">var </span><span class="s2">fragment </span><span class="s1">= </span><span class="s2">url</span><span class="s1">.</span><span class="s2">fragment</span><span class="s1">;</span>
    <span class="s4">var </span><span class="s2">output </span><span class="s1">= </span><span class="s2">scheme </span><span class="s1">+ </span><span class="s0">':'</span><span class="s1">;</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s2">host </span><span class="s1">!== </span><span class="s4">null</span><span class="s1">) {</span>
      <span class="s2">output </span><span class="s1">+= </span><span class="s0">'//'</span><span class="s1">;</span>
      <span class="s4">if </span><span class="s1">(</span><span class="s2">url</span><span class="s1">.</span><span class="s2">includesCredentials</span><span class="s1">()) {</span>
        <span class="s2">output </span><span class="s1">+= </span><span class="s2">username </span><span class="s1">+ (</span><span class="s2">password </span><span class="s1">? </span><span class="s0">':' </span><span class="s1">+ </span><span class="s2">password </span><span class="s1">: </span><span class="s0">''</span><span class="s1">) + </span><span class="s0">'@'</span><span class="s1">;</span>
      <span class="s1">}</span>
      <span class="s2">output </span><span class="s1">+= </span><span class="s2">serializeHost</span><span class="s1">(</span><span class="s2">host</span><span class="s1">);</span>
      <span class="s4">if </span><span class="s1">(</span><span class="s2">port </span><span class="s1">!== </span><span class="s4">null</span><span class="s1">) </span><span class="s2">output </span><span class="s1">+= </span><span class="s0">':' </span><span class="s1">+ </span><span class="s2">port</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s2">scheme </span><span class="s1">=== </span><span class="s0">'file'</span><span class="s1">) </span><span class="s2">output </span><span class="s1">+= </span><span class="s0">'//'</span><span class="s1">;</span>
    <span class="s2">output </span><span class="s1">+= </span><span class="s2">url</span><span class="s1">.</span><span class="s2">cannotBeABaseURL </span><span class="s1">? </span><span class="s2">path</span><span class="s1">[</span><span class="s6">0</span><span class="s1">] : </span><span class="s2">path</span><span class="s1">.</span><span class="s2">length </span><span class="s1">? </span><span class="s0">'/' </span><span class="s1">+ </span><span class="s2">join</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s0">'/'</span><span class="s1">) : </span><span class="s0">''</span><span class="s1">;</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s2">query </span><span class="s1">!== </span><span class="s4">null</span><span class="s1">) </span><span class="s2">output </span><span class="s1">+= </span><span class="s0">'?' </span><span class="s1">+ </span><span class="s2">query</span><span class="s1">;</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s2">fragment </span><span class="s1">!== </span><span class="s4">null</span><span class="s1">) </span><span class="s2">output </span><span class="s1">+= </span><span class="s0">'#' </span><span class="s1">+ </span><span class="s2">fragment</span><span class="s1">;</span>
    <span class="s4">return </span><span class="s2">output</span><span class="s1">;</span>
  <span class="s1">},</span>
  <span class="s3">// https://url.spec.whatwg.org/#dom-url-href</span>
  <span class="s2">setHref</span><span class="s1">: </span><span class="s4">function </span><span class="s1">(</span><span class="s2">href</span><span class="s1">) {</span>
    <span class="s4">var </span><span class="s2">failure </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">parse</span><span class="s1">(</span><span class="s2">href</span><span class="s1">);</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s2">failure</span><span class="s1">) </span><span class="s4">throw new </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s2">failure</span><span class="s1">);</span>
    <span class="s4">this</span><span class="s1">.</span><span class="s2">searchParams</span><span class="s1">.</span><span class="s2">update</span><span class="s1">();</span>
  <span class="s1">},</span>
  <span class="s3">// https://url.spec.whatwg.org/#dom-url-origin</span>
  <span class="s2">getOrigin</span><span class="s1">: </span><span class="s4">function </span><span class="s1">() {</span>
    <span class="s4">var </span><span class="s2">scheme </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">scheme</span><span class="s1">;</span>
    <span class="s4">var </span><span class="s2">port </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">port</span><span class="s1">;</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s2">scheme </span><span class="s1">=== </span><span class="s0">'blob'</span><span class="s1">) </span><span class="s4">try </span><span class="s1">{</span>
      <span class="s4">return new </span><span class="s2">URLConstructor</span><span class="s1">(</span><span class="s2">scheme</span><span class="s1">.</span><span class="s2">path</span><span class="s1">[</span><span class="s6">0</span><span class="s1">]).</span><span class="s2">origin</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s4">catch </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) {</span>
      <span class="s4">return </span><span class="s0">'null'</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s2">scheme </span><span class="s1">=== </span><span class="s0">'file' </span><span class="s1">|| !</span><span class="s4">this</span><span class="s1">.</span><span class="s2">isSpecial</span><span class="s1">()) </span><span class="s4">return </span><span class="s0">'null'</span><span class="s1">;</span>
    <span class="s4">return </span><span class="s2">scheme </span><span class="s1">+ </span><span class="s0">'://' </span><span class="s1">+ </span><span class="s2">serializeHost</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">host</span><span class="s1">) + (</span><span class="s2">port </span><span class="s1">!== </span><span class="s4">null </span><span class="s1">? </span><span class="s0">':' </span><span class="s1">+ </span><span class="s2">port </span><span class="s1">: </span><span class="s0">''</span><span class="s1">);</span>
  <span class="s1">},</span>
  <span class="s3">// https://url.spec.whatwg.org/#dom-url-protocol</span>
  <span class="s2">getProtocol</span><span class="s1">: </span><span class="s4">function </span><span class="s1">() {</span>
    <span class="s4">return this</span><span class="s1">.</span><span class="s2">scheme </span><span class="s1">+ </span><span class="s0">':'</span><span class="s1">;</span>
  <span class="s1">},</span>
  <span class="s2">setProtocol</span><span class="s1">: </span><span class="s4">function </span><span class="s1">(</span><span class="s2">protocol</span><span class="s1">) {</span>
    <span class="s4">this</span><span class="s1">.</span><span class="s2">parse</span><span class="s1">(</span><span class="s2">$toString</span><span class="s1">(</span><span class="s2">protocol</span><span class="s1">) + </span><span class="s0">':'</span><span class="s1">, </span><span class="s2">SCHEME_START</span><span class="s1">);</span>
  <span class="s1">},</span>
  <span class="s3">// https://url.spec.whatwg.org/#dom-url-username</span>
  <span class="s2">getUsername</span><span class="s1">: </span><span class="s4">function </span><span class="s1">() {</span>
    <span class="s4">return this</span><span class="s1">.</span><span class="s2">username</span><span class="s1">;</span>
  <span class="s1">},</span>
  <span class="s2">setUsername</span><span class="s1">: </span><span class="s4">function </span><span class="s1">(</span><span class="s2">username</span><span class="s1">) {</span>
    <span class="s4">var </span><span class="s2">codePoints </span><span class="s1">= </span><span class="s2">arrayFrom</span><span class="s1">(</span><span class="s2">$toString</span><span class="s1">(</span><span class="s2">username</span><span class="s1">));</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">cannotHaveUsernamePasswordPort</span><span class="s1">()) </span><span class="s4">return</span><span class="s1">;</span>
    <span class="s4">this</span><span class="s1">.</span><span class="s2">username </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
    <span class="s4">for </span><span class="s1">(</span><span class="s4">var </span><span class="s2">i </span><span class="s1">= </span><span class="s6">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">codePoints</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">i</span><span class="s1">++) {</span>
      <span class="s4">this</span><span class="s1">.</span><span class="s2">username </span><span class="s1">+= </span><span class="s2">percentEncode</span><span class="s1">(</span><span class="s2">codePoints</span><span class="s1">[</span><span class="s2">i</span><span class="s1">], </span><span class="s2">userinfoPercentEncodeSet</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">},</span>
  <span class="s3">// https://url.spec.whatwg.org/#dom-url-password</span>
  <span class="s2">getPassword</span><span class="s1">: </span><span class="s4">function </span><span class="s1">() {</span>
    <span class="s4">return this</span><span class="s1">.</span><span class="s2">password</span><span class="s1">;</span>
  <span class="s1">},</span>
  <span class="s2">setPassword</span><span class="s1">: </span><span class="s4">function </span><span class="s1">(</span><span class="s2">password</span><span class="s1">) {</span>
    <span class="s4">var </span><span class="s2">codePoints </span><span class="s1">= </span><span class="s2">arrayFrom</span><span class="s1">(</span><span class="s2">$toString</span><span class="s1">(</span><span class="s2">password</span><span class="s1">));</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">cannotHaveUsernamePasswordPort</span><span class="s1">()) </span><span class="s4">return</span><span class="s1">;</span>
    <span class="s4">this</span><span class="s1">.</span><span class="s2">password </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
    <span class="s4">for </span><span class="s1">(</span><span class="s4">var </span><span class="s2">i </span><span class="s1">= </span><span class="s6">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">codePoints</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">i</span><span class="s1">++) {</span>
      <span class="s4">this</span><span class="s1">.</span><span class="s2">password </span><span class="s1">+= </span><span class="s2">percentEncode</span><span class="s1">(</span><span class="s2">codePoints</span><span class="s1">[</span><span class="s2">i</span><span class="s1">], </span><span class="s2">userinfoPercentEncodeSet</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">},</span>
  <span class="s3">// https://url.spec.whatwg.org/#dom-url-host</span>
  <span class="s2">getHost</span><span class="s1">: </span><span class="s4">function </span><span class="s1">() {</span>
    <span class="s4">var </span><span class="s2">host </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">host</span><span class="s1">;</span>
    <span class="s4">var </span><span class="s2">port </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">port</span><span class="s1">;</span>
    <span class="s4">return </span><span class="s2">host </span><span class="s1">=== </span><span class="s4">null </span><span class="s1">? </span><span class="s0">''</span>
      <span class="s1">: </span><span class="s2">port </span><span class="s1">=== </span><span class="s4">null </span><span class="s1">? </span><span class="s2">serializeHost</span><span class="s1">(</span><span class="s2">host</span><span class="s1">)</span>
      <span class="s1">: </span><span class="s2">serializeHost</span><span class="s1">(</span><span class="s2">host</span><span class="s1">) + </span><span class="s0">':' </span><span class="s1">+ </span><span class="s2">port</span><span class="s1">;</span>
  <span class="s1">},</span>
  <span class="s2">setHost</span><span class="s1">: </span><span class="s4">function </span><span class="s1">(</span><span class="s2">host</span><span class="s1">) {</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">cannotBeABaseURL</span><span class="s1">) </span><span class="s4">return</span><span class="s1">;</span>
    <span class="s4">this</span><span class="s1">.</span><span class="s2">parse</span><span class="s1">(</span><span class="s2">host</span><span class="s1">, </span><span class="s2">HOST</span><span class="s1">);</span>
  <span class="s1">},</span>
  <span class="s3">// https://url.spec.whatwg.org/#dom-url-hostname</span>
  <span class="s2">getHostname</span><span class="s1">: </span><span class="s4">function </span><span class="s1">() {</span>
    <span class="s4">var </span><span class="s2">host </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">host</span><span class="s1">;</span>
    <span class="s4">return </span><span class="s2">host </span><span class="s1">=== </span><span class="s4">null </span><span class="s1">? </span><span class="s0">'' </span><span class="s1">: </span><span class="s2">serializeHost</span><span class="s1">(</span><span class="s2">host</span><span class="s1">);</span>
  <span class="s1">},</span>
  <span class="s2">setHostname</span><span class="s1">: </span><span class="s4">function </span><span class="s1">(</span><span class="s2">hostname</span><span class="s1">) {</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">cannotBeABaseURL</span><span class="s1">) </span><span class="s4">return</span><span class="s1">;</span>
    <span class="s4">this</span><span class="s1">.</span><span class="s2">parse</span><span class="s1">(</span><span class="s2">hostname</span><span class="s1">, </span><span class="s2">HOSTNAME</span><span class="s1">);</span>
  <span class="s1">},</span>
  <span class="s3">// https://url.spec.whatwg.org/#dom-url-port</span>
  <span class="s2">getPort</span><span class="s1">: </span><span class="s4">function </span><span class="s1">() {</span>
    <span class="s4">var </span><span class="s2">port </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">port</span><span class="s1">;</span>
    <span class="s4">return </span><span class="s2">port </span><span class="s1">=== </span><span class="s4">null </span><span class="s1">? </span><span class="s0">'' </span><span class="s1">: </span><span class="s2">$toString</span><span class="s1">(</span><span class="s2">port</span><span class="s1">);</span>
  <span class="s1">},</span>
  <span class="s2">setPort</span><span class="s1">: </span><span class="s4">function </span><span class="s1">(</span><span class="s2">port</span><span class="s1">) {</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">cannotHaveUsernamePasswordPort</span><span class="s1">()) </span><span class="s4">return</span><span class="s1">;</span>
    <span class="s2">port </span><span class="s1">= </span><span class="s2">$toString</span><span class="s1">(</span><span class="s2">port</span><span class="s1">);</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s2">port </span><span class="s1">=== </span><span class="s0">''</span><span class="s1">) </span><span class="s4">this</span><span class="s1">.</span><span class="s2">port </span><span class="s1">= </span><span class="s4">null</span><span class="s1">;</span>
    <span class="s4">else this</span><span class="s1">.</span><span class="s2">parse</span><span class="s1">(</span><span class="s2">port</span><span class="s1">, </span><span class="s2">PORT</span><span class="s1">);</span>
  <span class="s1">},</span>
  <span class="s3">// https://url.spec.whatwg.org/#dom-url-pathname</span>
  <span class="s2">getPathname</span><span class="s1">: </span><span class="s4">function </span><span class="s1">() {</span>
    <span class="s4">var </span><span class="s2">path </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">path</span><span class="s1">;</span>
    <span class="s4">return this</span><span class="s1">.</span><span class="s2">cannotBeABaseURL </span><span class="s1">? </span><span class="s2">path</span><span class="s1">[</span><span class="s6">0</span><span class="s1">] : </span><span class="s2">path</span><span class="s1">.</span><span class="s2">length </span><span class="s1">? </span><span class="s0">'/' </span><span class="s1">+ </span><span class="s2">join</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s0">'/'</span><span class="s1">) : </span><span class="s0">''</span><span class="s1">;</span>
  <span class="s1">},</span>
  <span class="s2">setPathname</span><span class="s1">: </span><span class="s4">function </span><span class="s1">(</span><span class="s2">pathname</span><span class="s1">) {</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.</span><span class="s2">cannotBeABaseURL</span><span class="s1">) </span><span class="s4">return</span><span class="s1">;</span>
    <span class="s4">this</span><span class="s1">.</span><span class="s2">path </span><span class="s1">= [];</span>
    <span class="s4">this</span><span class="s1">.</span><span class="s2">parse</span><span class="s1">(</span><span class="s2">pathname</span><span class="s1">, </span><span class="s2">PATH_START</span><span class="s1">);</span>
  <span class="s1">},</span>
  <span class="s3">// https://url.spec.whatwg.org/#dom-url-search</span>
  <span class="s2">getSearch</span><span class="s1">: </span><span class="s4">function </span><span class="s1">() {</span>
    <span class="s4">var </span><span class="s2">query </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">query</span><span class="s1">;</span>
    <span class="s4">return </span><span class="s2">query </span><span class="s1">? </span><span class="s0">'?' </span><span class="s1">+ </span><span class="s2">query </span><span class="s1">: </span><span class="s0">''</span><span class="s1">;</span>
  <span class="s1">},</span>
  <span class="s2">setSearch</span><span class="s1">: </span><span class="s4">function </span><span class="s1">(</span><span class="s2">search</span><span class="s1">) {</span>
    <span class="s2">search </span><span class="s1">= </span><span class="s2">$toString</span><span class="s1">(</span><span class="s2">search</span><span class="s1">);</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s2">search </span><span class="s1">=== </span><span class="s0">''</span><span class="s1">) {</span>
      <span class="s4">this</span><span class="s1">.</span><span class="s2">query </span><span class="s1">= </span><span class="s4">null</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
      <span class="s4">if </span><span class="s1">(</span><span class="s2">charAt</span><span class="s1">(</span><span class="s2">search</span><span class="s1">, </span><span class="s6">0</span><span class="s1">) === </span><span class="s0">'?'</span><span class="s1">) </span><span class="s2">search </span><span class="s1">= </span><span class="s2">stringSlice</span><span class="s1">(</span><span class="s2">search</span><span class="s1">, </span><span class="s6">1</span><span class="s1">);</span>
      <span class="s4">this</span><span class="s1">.</span><span class="s2">query </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
      <span class="s4">this</span><span class="s1">.</span><span class="s2">parse</span><span class="s1">(</span><span class="s2">search</span><span class="s1">, </span><span class="s2">QUERY</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s4">this</span><span class="s1">.</span><span class="s2">searchParams</span><span class="s1">.</span><span class="s2">update</span><span class="s1">();</span>
  <span class="s1">},</span>
  <span class="s3">// https://url.spec.whatwg.org/#dom-url-searchparams</span>
  <span class="s2">getSearchParams</span><span class="s1">: </span><span class="s4">function </span><span class="s1">() {</span>
    <span class="s4">return this</span><span class="s1">.</span><span class="s2">searchParams</span><span class="s1">.</span><span class="s2">facade</span><span class="s1">;</span>
  <span class="s1">},</span>
  <span class="s3">// https://url.spec.whatwg.org/#dom-url-hash</span>
  <span class="s2">getHash</span><span class="s1">: </span><span class="s4">function </span><span class="s1">() {</span>
    <span class="s4">var </span><span class="s2">fragment </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">fragment</span><span class="s1">;</span>
    <span class="s4">return </span><span class="s2">fragment </span><span class="s1">? </span><span class="s0">'#' </span><span class="s1">+ </span><span class="s2">fragment </span><span class="s1">: </span><span class="s0">''</span><span class="s1">;</span>
  <span class="s1">},</span>
  <span class="s2">setHash</span><span class="s1">: </span><span class="s4">function </span><span class="s1">(</span><span class="s2">hash</span><span class="s1">) {</span>
    <span class="s2">hash </span><span class="s1">= </span><span class="s2">$toString</span><span class="s1">(</span><span class="s2">hash</span><span class="s1">);</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s2">hash </span><span class="s1">=== </span><span class="s0">''</span><span class="s1">) {</span>
      <span class="s4">this</span><span class="s1">.</span><span class="s2">fragment </span><span class="s1">= </span><span class="s4">null</span><span class="s1">;</span>
      <span class="s4">return</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s2">charAt</span><span class="s1">(</span><span class="s2">hash</span><span class="s1">, </span><span class="s6">0</span><span class="s1">) === </span><span class="s0">'#'</span><span class="s1">) </span><span class="s2">hash </span><span class="s1">= </span><span class="s2">stringSlice</span><span class="s1">(</span><span class="s2">hash</span><span class="s1">, </span><span class="s6">1</span><span class="s1">);</span>
    <span class="s4">this</span><span class="s1">.</span><span class="s2">fragment </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
    <span class="s4">this</span><span class="s1">.</span><span class="s2">parse</span><span class="s1">(</span><span class="s2">hash</span><span class="s1">, </span><span class="s2">FRAGMENT</span><span class="s1">);</span>
  <span class="s1">},</span>
  <span class="s2">update</span><span class="s1">: </span><span class="s4">function </span><span class="s1">() {</span>
    <span class="s4">this</span><span class="s1">.</span><span class="s2">query </span><span class="s1">= </span><span class="s4">this</span><span class="s1">.</span><span class="s2">searchParams</span><span class="s1">.</span><span class="s2">serialize</span><span class="s1">() || </span><span class="s4">null</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">};</span>

<span class="s3">// `URL` constructor</span>
<span class="s3">// https://url.spec.whatwg.org/#url-class</span>
<span class="s4">var </span><span class="s2">URLConstructor </span><span class="s1">= </span><span class="s4">function </span><span class="s2">URL</span><span class="s1">(</span><span class="s2">url </span><span class="s3">/* , base */</span><span class="s1">) {</span>
  <span class="s4">var </span><span class="s2">that </span><span class="s1">= </span><span class="s2">anInstance</span><span class="s1">(</span><span class="s4">this</span><span class="s1">, </span><span class="s2">URLPrototype</span><span class="s1">);</span>
  <span class="s4">var </span><span class="s2">base </span><span class="s1">= </span><span class="s2">validateArgumentsLength</span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">length</span><span class="s1">, </span><span class="s6">1</span><span class="s1">) &gt; </span><span class="s6">1 </span><span class="s1">? </span><span class="s2">arguments</span><span class="s1">[</span><span class="s6">1</span><span class="s1">] : </span><span class="s2">undefined</span><span class="s1">;</span>
  <span class="s4">var </span><span class="s2">state </span><span class="s1">= </span><span class="s2">setInternalState</span><span class="s1">(</span><span class="s2">that</span><span class="s1">, </span><span class="s4">new </span><span class="s2">URLState</span><span class="s1">(</span><span class="s2">url</span><span class="s1">, </span><span class="s4">false</span><span class="s1">, </span><span class="s2">base</span><span class="s1">));</span>
  <span class="s4">if </span><span class="s1">(!</span><span class="s2">DESCRIPTORS</span><span class="s1">) {</span>
    <span class="s2">that</span><span class="s1">.</span><span class="s2">href </span><span class="s1">= </span><span class="s2">state</span><span class="s1">.</span><span class="s2">serialize</span><span class="s1">();</span>
    <span class="s2">that</span><span class="s1">.</span><span class="s2">origin </span><span class="s1">= </span><span class="s2">state</span><span class="s1">.</span><span class="s2">getOrigin</span><span class="s1">();</span>
    <span class="s2">that</span><span class="s1">.</span><span class="s2">protocol </span><span class="s1">= </span><span class="s2">state</span><span class="s1">.</span><span class="s2">getProtocol</span><span class="s1">();</span>
    <span class="s2">that</span><span class="s1">.</span><span class="s2">username </span><span class="s1">= </span><span class="s2">state</span><span class="s1">.</span><span class="s2">getUsername</span><span class="s1">();</span>
    <span class="s2">that</span><span class="s1">.</span><span class="s2">password </span><span class="s1">= </span><span class="s2">state</span><span class="s1">.</span><span class="s2">getPassword</span><span class="s1">();</span>
    <span class="s2">that</span><span class="s1">.</span><span class="s2">host </span><span class="s1">= </span><span class="s2">state</span><span class="s1">.</span><span class="s2">getHost</span><span class="s1">();</span>
    <span class="s2">that</span><span class="s1">.</span><span class="s2">hostname </span><span class="s1">= </span><span class="s2">state</span><span class="s1">.</span><span class="s2">getHostname</span><span class="s1">();</span>
    <span class="s2">that</span><span class="s1">.</span><span class="s2">port </span><span class="s1">= </span><span class="s2">state</span><span class="s1">.</span><span class="s2">getPort</span><span class="s1">();</span>
    <span class="s2">that</span><span class="s1">.</span><span class="s2">pathname </span><span class="s1">= </span><span class="s2">state</span><span class="s1">.</span><span class="s2">getPathname</span><span class="s1">();</span>
    <span class="s2">that</span><span class="s1">.</span><span class="s2">search </span><span class="s1">= </span><span class="s2">state</span><span class="s1">.</span><span class="s2">getSearch</span><span class="s1">();</span>
    <span class="s2">that</span><span class="s1">.</span><span class="s2">searchParams </span><span class="s1">= </span><span class="s2">state</span><span class="s1">.</span><span class="s2">getSearchParams</span><span class="s1">();</span>
    <span class="s2">that</span><span class="s1">.</span><span class="s2">hash </span><span class="s1">= </span><span class="s2">state</span><span class="s1">.</span><span class="s2">getHash</span><span class="s1">();</span>
  <span class="s1">}</span>
<span class="s1">};</span>

<span class="s4">var </span><span class="s2">URLPrototype </span><span class="s1">= </span><span class="s2">URLConstructor</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">;</span>

<span class="s4">var </span><span class="s2">accessorDescriptor </span><span class="s1">= </span><span class="s4">function </span><span class="s1">(</span><span class="s2">getter</span><span class="s1">, </span><span class="s2">setter</span><span class="s1">) {</span>
  <span class="s4">return </span><span class="s1">{</span>
    <span class="s2">get</span><span class="s1">: </span><span class="s4">function </span><span class="s1">() {</span>
      <span class="s4">return </span><span class="s2">getInternalURLState</span><span class="s1">(</span><span class="s4">this</span><span class="s1">)[</span><span class="s2">getter</span><span class="s1">]();</span>
    <span class="s1">},</span>
    <span class="s2">set</span><span class="s1">: </span><span class="s2">setter </span><span class="s1">&amp;&amp; </span><span class="s4">function </span><span class="s1">(</span><span class="s2">value</span><span class="s1">) {</span>
      <span class="s4">return </span><span class="s2">getInternalURLState</span><span class="s1">(</span><span class="s4">this</span><span class="s1">)[</span><span class="s2">setter</span><span class="s1">](</span><span class="s2">value</span><span class="s1">);</span>
    <span class="s1">},</span>
    <span class="s2">configurable</span><span class="s1">: </span><span class="s4">true</span><span class="s1">,</span>
    <span class="s2">enumerable</span><span class="s1">: </span><span class="s4">true</span>
  <span class="s1">};</span>
<span class="s1">};</span>

<span class="s4">if </span><span class="s1">(</span><span class="s2">DESCRIPTORS</span><span class="s1">) {</span>
  <span class="s3">// `URL.prototype.href` accessors pair</span>
  <span class="s3">// https://url.spec.whatwg.org/#dom-url-href</span>
  <span class="s2">defineBuiltInAccessor</span><span class="s1">(</span><span class="s2">URLPrototype</span><span class="s1">, </span><span class="s0">'href'</span><span class="s1">, </span><span class="s2">accessorDescriptor</span><span class="s1">(</span><span class="s0">'serialize'</span><span class="s1">, </span><span class="s0">'setHref'</span><span class="s1">));</span>
  <span class="s3">// `URL.prototype.origin` getter</span>
  <span class="s3">// https://url.spec.whatwg.org/#dom-url-origin</span>
  <span class="s2">defineBuiltInAccessor</span><span class="s1">(</span><span class="s2">URLPrototype</span><span class="s1">, </span><span class="s0">'origin'</span><span class="s1">, </span><span class="s2">accessorDescriptor</span><span class="s1">(</span><span class="s0">'getOrigin'</span><span class="s1">));</span>
  <span class="s3">// `URL.prototype.protocol` accessors pair</span>
  <span class="s3">// https://url.spec.whatwg.org/#dom-url-protocol</span>
  <span class="s2">defineBuiltInAccessor</span><span class="s1">(</span><span class="s2">URLPrototype</span><span class="s1">, </span><span class="s0">'protocol'</span><span class="s1">, </span><span class="s2">accessorDescriptor</span><span class="s1">(</span><span class="s0">'getProtocol'</span><span class="s1">, </span><span class="s0">'setProtocol'</span><span class="s1">));</span>
  <span class="s3">// `URL.prototype.username` accessors pair</span>
  <span class="s3">// https://url.spec.whatwg.org/#dom-url-username</span>
  <span class="s2">defineBuiltInAccessor</span><span class="s1">(</span><span class="s2">URLPrototype</span><span class="s1">, </span><span class="s0">'username'</span><span class="s1">, </span><span class="s2">accessorDescriptor</span><span class="s1">(</span><span class="s0">'getUsername'</span><span class="s1">, </span><span class="s0">'setUsername'</span><span class="s1">));</span>
  <span class="s3">// `URL.prototype.password` accessors pair</span>
  <span class="s3">// https://url.spec.whatwg.org/#dom-url-password</span>
  <span class="s2">defineBuiltInAccessor</span><span class="s1">(</span><span class="s2">URLPrototype</span><span class="s1">, </span><span class="s0">'password'</span><span class="s1">, </span><span class="s2">accessorDescriptor</span><span class="s1">(</span><span class="s0">'getPassword'</span><span class="s1">, </span><span class="s0">'setPassword'</span><span class="s1">));</span>
  <span class="s3">// `URL.prototype.host` accessors pair</span>
  <span class="s3">// https://url.spec.whatwg.org/#dom-url-host</span>
  <span class="s2">defineBuiltInAccessor</span><span class="s1">(</span><span class="s2">URLPrototype</span><span class="s1">, </span><span class="s0">'host'</span><span class="s1">, </span><span class="s2">accessorDescriptor</span><span class="s1">(</span><span class="s0">'getHost'</span><span class="s1">, </span><span class="s0">'setHost'</span><span class="s1">));</span>
  <span class="s3">// `URL.prototype.hostname` accessors pair</span>
  <span class="s3">// https://url.spec.whatwg.org/#dom-url-hostname</span>
  <span class="s2">defineBuiltInAccessor</span><span class="s1">(</span><span class="s2">URLPrototype</span><span class="s1">, </span><span class="s0">'hostname'</span><span class="s1">, </span><span class="s2">accessorDescriptor</span><span class="s1">(</span><span class="s0">'getHostname'</span><span class="s1">, </span><span class="s0">'setHostname'</span><span class="s1">));</span>
  <span class="s3">// `URL.prototype.port` accessors pair</span>
  <span class="s3">// https://url.spec.whatwg.org/#dom-url-port</span>
  <span class="s2">defineBuiltInAccessor</span><span class="s1">(</span><span class="s2">URLPrototype</span><span class="s1">, </span><span class="s0">'port'</span><span class="s1">, </span><span class="s2">accessorDescriptor</span><span class="s1">(</span><span class="s0">'getPort'</span><span class="s1">, </span><span class="s0">'setPort'</span><span class="s1">));</span>
  <span class="s3">// `URL.prototype.pathname` accessors pair</span>
  <span class="s3">// https://url.spec.whatwg.org/#dom-url-pathname</span>
  <span class="s2">defineBuiltInAccessor</span><span class="s1">(</span><span class="s2">URLPrototype</span><span class="s1">, </span><span class="s0">'pathname'</span><span class="s1">, </span><span class="s2">accessorDescriptor</span><span class="s1">(</span><span class="s0">'getPathname'</span><span class="s1">, </span><span class="s0">'setPathname'</span><span class="s1">));</span>
  <span class="s3">// `URL.prototype.search` accessors pair</span>
  <span class="s3">// https://url.spec.whatwg.org/#dom-url-search</span>
  <span class="s2">defineBuiltInAccessor</span><span class="s1">(</span><span class="s2">URLPrototype</span><span class="s1">, </span><span class="s0">'search'</span><span class="s1">, </span><span class="s2">accessorDescriptor</span><span class="s1">(</span><span class="s0">'getSearch'</span><span class="s1">, </span><span class="s0">'setSearch'</span><span class="s1">));</span>
  <span class="s3">// `URL.prototype.searchParams` getter</span>
  <span class="s3">// https://url.spec.whatwg.org/#dom-url-searchparams</span>
  <span class="s2">defineBuiltInAccessor</span><span class="s1">(</span><span class="s2">URLPrototype</span><span class="s1">, </span><span class="s0">'searchParams'</span><span class="s1">, </span><span class="s2">accessorDescriptor</span><span class="s1">(</span><span class="s0">'getSearchParams'</span><span class="s1">));</span>
  <span class="s3">// `URL.prototype.hash` accessors pair</span>
  <span class="s3">// https://url.spec.whatwg.org/#dom-url-hash</span>
  <span class="s2">defineBuiltInAccessor</span><span class="s1">(</span><span class="s2">URLPrototype</span><span class="s1">, </span><span class="s0">'hash'</span><span class="s1">, </span><span class="s2">accessorDescriptor</span><span class="s1">(</span><span class="s0">'getHash'</span><span class="s1">, </span><span class="s0">'setHash'</span><span class="s1">));</span>
<span class="s1">}</span>

<span class="s3">// `URL.prototype.toJSON` method</span>
<span class="s3">// https://url.spec.whatwg.org/#dom-url-tojson</span>
<span class="s2">defineBuiltIn</span><span class="s1">(</span><span class="s2">URLPrototype</span><span class="s1">, </span><span class="s0">'toJSON'</span><span class="s1">, </span><span class="s4">function </span><span class="s2">toJSON</span><span class="s1">() {</span>
  <span class="s4">return </span><span class="s2">getInternalURLState</span><span class="s1">(</span><span class="s4">this</span><span class="s1">).</span><span class="s2">serialize</span><span class="s1">();</span>
<span class="s1">}, { </span><span class="s2">enumerable</span><span class="s1">: </span><span class="s4">true </span><span class="s1">});</span>

<span class="s3">// `URL.prototype.toString` method</span>
<span class="s3">// https://url.spec.whatwg.org/#URL-stringification-behavior</span>
<span class="s2">defineBuiltIn</span><span class="s1">(</span><span class="s2">URLPrototype</span><span class="s1">, </span><span class="s0">'toString'</span><span class="s1">, </span><span class="s4">function </span><span class="s2">toString</span><span class="s1">() {</span>
  <span class="s4">return </span><span class="s2">getInternalURLState</span><span class="s1">(</span><span class="s4">this</span><span class="s1">).</span><span class="s2">serialize</span><span class="s1">();</span>
<span class="s1">}, { </span><span class="s2">enumerable</span><span class="s1">: </span><span class="s4">true </span><span class="s1">});</span>

<span class="s4">if </span><span class="s1">(</span><span class="s2">NativeURL</span><span class="s1">) {</span>
  <span class="s4">var </span><span class="s2">nativeCreateObjectURL </span><span class="s1">= </span><span class="s2">NativeURL</span><span class="s1">.</span><span class="s2">createObjectURL</span><span class="s1">;</span>
  <span class="s4">var </span><span class="s2">nativeRevokeObjectURL </span><span class="s1">= </span><span class="s2">NativeURL</span><span class="s1">.</span><span class="s2">revokeObjectURL</span><span class="s1">;</span>
  <span class="s3">// `URL.createObjectURL` method</span>
  <span class="s3">// https://developer.mozilla.org/en-US/docs/Web/API/URL/createObjectURL</span>
  <span class="s4">if </span><span class="s1">(</span><span class="s2">nativeCreateObjectURL</span><span class="s1">) </span><span class="s2">defineBuiltIn</span><span class="s1">(</span><span class="s2">URLConstructor</span><span class="s1">, </span><span class="s0">'createObjectURL'</span><span class="s1">, </span><span class="s2">bind</span><span class="s1">(</span><span class="s2">nativeCreateObjectURL</span><span class="s1">, </span><span class="s2">NativeURL</span><span class="s1">));</span>
  <span class="s3">// `URL.revokeObjectURL` method</span>
  <span class="s3">// https://developer.mozilla.org/en-US/docs/Web/API/URL/revokeObjectURL</span>
  <span class="s4">if </span><span class="s1">(</span><span class="s2">nativeRevokeObjectURL</span><span class="s1">) </span><span class="s2">defineBuiltIn</span><span class="s1">(</span><span class="s2">URLConstructor</span><span class="s1">, </span><span class="s0">'revokeObjectURL'</span><span class="s1">, </span><span class="s2">bind</span><span class="s1">(</span><span class="s2">nativeRevokeObjectURL</span><span class="s1">, </span><span class="s2">NativeURL</span><span class="s1">));</span>
<span class="s1">}</span>

<span class="s2">setToStringTag</span><span class="s1">(</span><span class="s2">URLConstructor</span><span class="s1">, </span><span class="s0">'URL'</span><span class="s1">);</span>

<span class="s2">$</span><span class="s1">({ </span><span class="s2">global</span><span class="s1">: </span><span class="s4">true</span><span class="s1">, </span><span class="s2">constructor</span><span class="s1">: </span><span class="s4">true</span><span class="s1">, </span><span class="s2">forced</span><span class="s1">: !</span><span class="s2">USE_NATIVE_URL</span><span class="s1">, </span><span class="s2">sham</span><span class="s1">: !</span><span class="s2">DESCRIPTORS </span><span class="s1">}, {</span>
  <span class="s2">URL</span><span class="s1">: </span><span class="s2">URLConstructor</span>
<span class="s1">});</span>
</pre>
</body>
</html>