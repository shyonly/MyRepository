<html>
<head>
<title>resolver_sync.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #42c3d4;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
resolver_sync.js</font>
</center></td></tr></table>
<pre><span class="s0">var </span><span class="s1">path </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'path'</span><span class="s2">);</span>
<span class="s0">var </span><span class="s1">fs </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'fs'</span><span class="s2">);</span>
<span class="s0">var </span><span class="s1">test </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'tape'</span><span class="s2">);</span>

<span class="s0">var </span><span class="s1">resolve </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'../'</span><span class="s2">);</span>
<span class="s0">var </span><span class="s1">sync </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'../sync'</span><span class="s2">);</span>

<span class="s0">var </span><span class="s1">requireResolveSupportsPaths </span><span class="s2">= </span><span class="s1">require</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s4">1</span>
    <span class="s2">&amp;&amp; !(</span><span class="s5">/^v12\.[012]\./</span><span class="s2">).</span><span class="s1">test</span><span class="s2">(</span><span class="s1">process</span><span class="s2">.</span><span class="s1">version</span><span class="s2">); </span><span class="s6">// broken in v12.0-12.2, see https://github.com/nodejs/node/issues/27794</span>

<span class="s0">var </span><span class="s1">requireResolveDefaultPathsBroken </span><span class="s2">= (</span><span class="s5">/^v8\.9\.|^v9\.[01]\.0|^v9\.2\./</span><span class="s2">).</span><span class="s1">test</span><span class="s2">(</span><span class="s1">process</span><span class="s2">.</span><span class="s1">version</span><span class="s2">);</span>
<span class="s6">// broken in node v8.9.x, v9.0, v9.1, v9.2.x. see https://github.com/nodejs/node/pull/17113</span>

<span class="s1">test</span><span class="s2">(</span><span class="s3">'`./sync` entry point'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">t</span><span class="s2">) {</span>
    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span><span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">, </span><span class="s1">sync</span><span class="s2">, </span><span class="s3">'`./sync` entry point is the same as `.sync` on `main`'</span><span class="s2">);</span>
    <span class="s1">t</span><span class="s2">.</span><span class="s1">end</span><span class="s2">();</span>
<span class="s2">});</span>

<span class="s1">test</span><span class="s2">(</span><span class="s3">'foo'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">t</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">dir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">__dirname</span><span class="s2">, </span><span class="s3">'resolver'</span><span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./foo'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir </span><span class="s2">}),</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'foo.js'</span><span class="s2">),</span>
        <span class="s3">'./foo'</span>
    <span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">requireResolveSupportsPaths</span><span class="s2">) {</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
            <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./foo'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir </span><span class="s2">}),</span>
            <span class="s1">require</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s3">'./foo'</span><span class="s2">, { </span><span class="s1">paths</span><span class="s2">: [</span><span class="s1">dir</span><span class="s2">] }),</span>
            <span class="s3">'./foo: resolve.sync === require.resolve'</span>
        <span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./foo.js'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir </span><span class="s2">}),</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'foo.js'</span><span class="s2">),</span>
        <span class="s3">'./foo.js'</span>
    <span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">requireResolveSupportsPaths</span><span class="s2">) {</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
            <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./foo.js'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir </span><span class="s2">}),</span>
            <span class="s1">require</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s3">'./foo.js'</span><span class="s2">, { </span><span class="s1">paths</span><span class="s2">: [</span><span class="s1">dir</span><span class="s2">] }),</span>
            <span class="s3">'./foo.js: resolve.sync === require.resolve'</span>
        <span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./foo.js'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">: </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'bar.js'</span><span class="s2">) }),</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'foo.js'</span><span class="s2">)</span>
    <span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">throws</span><span class="s2">(</span><span class="s0">function </span><span class="s2">() {</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'foo'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir </span><span class="s2">});</span>
    <span class="s2">});</span>

    <span class="s6">// Test that filename is reported as the &quot;from&quot; value when passed.</span>
    <span class="s1">t</span><span class="s2">.</span><span class="s1">throws</span><span class="s2">(</span>
        <span class="s0">function </span><span class="s2">() {</span>
            <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'foo'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir</span><span class="s2">, </span><span class="s1">filename</span><span class="s2">: </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'bar.js'</span><span class="s2">) });</span>
        <span class="s2">},</span>
        <span class="s2">{</span>
            <span class="s1">name</span><span class="s2">: </span><span class="s3">'Error'</span><span class="s2">,</span>
            <span class="s1">message</span><span class="s2">: </span><span class="s3">&quot;Cannot find module 'foo' from '&quot; </span><span class="s2">+ </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'bar.js'</span><span class="s2">) + </span><span class="s3">&quot;'&quot;</span>
        <span class="s2">}</span>
    <span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">end</span><span class="s2">();</span>
<span class="s2">});</span>

<span class="s1">test</span><span class="s2">(</span><span class="s3">'bar'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">t</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">dir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">__dirname</span><span class="s2">, </span><span class="s3">'resolver'</span><span class="s2">);</span>

    <span class="s0">var </span><span class="s1">basedir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'bar'</span><span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'foo'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">basedir </span><span class="s2">}),</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'bar/node_modules/foo/index.js'</span><span class="s2">),</span>
        <span class="s3">'foo in bar'</span>
    <span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(!</span><span class="s1">requireResolveDefaultPathsBroken </span><span class="s2">&amp;&amp; </span><span class="s1">requireResolveSupportsPaths</span><span class="s2">) {</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
            <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'foo'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">basedir </span><span class="s2">}),</span>
            <span class="s1">require</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s3">'foo'</span><span class="s2">, { </span><span class="s1">paths</span><span class="s2">: [</span><span class="s1">basedir</span><span class="s2">] }),</span>
            <span class="s3">'foo in bar: resolve.sync === require.resolve'</span>
        <span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">end</span><span class="s2">();</span>
<span class="s2">});</span>

<span class="s1">test</span><span class="s2">(</span><span class="s3">'baz'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">t</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">dir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">__dirname</span><span class="s2">, </span><span class="s3">'resolver'</span><span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./baz'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir </span><span class="s2">}),</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'baz/quux.js'</span><span class="s2">),</span>
        <span class="s3">'./baz'</span>
    <span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">requireResolveSupportsPaths</span><span class="s2">) {</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
            <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./baz'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir </span><span class="s2">}),</span>
            <span class="s1">require</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s3">'./baz'</span><span class="s2">, { </span><span class="s1">paths</span><span class="s2">: [</span><span class="s1">dir</span><span class="s2">] }),</span>
            <span class="s3">'./baz: resolve.sync === require.resolve'</span>
        <span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">end</span><span class="s2">();</span>
<span class="s2">});</span>

<span class="s1">test</span><span class="s2">(</span><span class="s3">'biz'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">t</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">dir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">__dirname</span><span class="s2">, </span><span class="s3">'resolver/biz/node_modules'</span><span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./grux'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir </span><span class="s2">}),</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'grux/index.js'</span><span class="s2">)</span>
    <span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">requireResolveSupportsPaths</span><span class="s2">) {</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
            <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./grux'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir </span><span class="s2">}),</span>
            <span class="s1">require</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s3">'./grux'</span><span class="s2">, { </span><span class="s1">paths</span><span class="s2">: [</span><span class="s1">dir</span><span class="s2">] }),</span>
            <span class="s3">'./grux: resolve.sync === require.resolve'</span>
        <span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s0">var </span><span class="s1">tivDir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'grux'</span><span class="s2">);</span>
    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'tiv'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">tivDir </span><span class="s2">}),</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'tiv/index.js'</span><span class="s2">)</span>
    <span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(!</span><span class="s1">requireResolveDefaultPathsBroken </span><span class="s2">&amp;&amp; </span><span class="s1">requireResolveSupportsPaths</span><span class="s2">) {</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
            <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'tiv'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">tivDir </span><span class="s2">}),</span>
            <span class="s1">require</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s3">'tiv'</span><span class="s2">, { </span><span class="s1">paths</span><span class="s2">: [</span><span class="s1">tivDir</span><span class="s2">] }),</span>
            <span class="s3">'tiv: resolve.sync === require.resolve'</span>
        <span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s0">var </span><span class="s1">gruxDir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'tiv'</span><span class="s2">);</span>
    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'grux'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">gruxDir </span><span class="s2">}),</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'grux/index.js'</span><span class="s2">)</span>
    <span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(!</span><span class="s1">requireResolveDefaultPathsBroken </span><span class="s2">&amp;&amp; </span><span class="s1">requireResolveSupportsPaths</span><span class="s2">) {</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
            <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'grux'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">gruxDir </span><span class="s2">}),</span>
            <span class="s1">require</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s3">'grux'</span><span class="s2">, { </span><span class="s1">paths</span><span class="s2">: [</span><span class="s1">gruxDir</span><span class="s2">] }),</span>
            <span class="s3">'grux: resolve.sync === require.resolve'</span>
        <span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">end</span><span class="s2">();</span>
<span class="s2">});</span>

<span class="s1">test</span><span class="s2">(</span><span class="s3">'normalize'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">t</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">dir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">__dirname</span><span class="s2">, </span><span class="s3">'resolver/biz/node_modules/grux'</span><span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'../grux'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir </span><span class="s2">}),</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'index.js'</span><span class="s2">)</span>
    <span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">requireResolveSupportsPaths</span><span class="s2">) {</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
            <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'../grux'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir </span><span class="s2">}),</span>
            <span class="s1">require</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s3">'../grux'</span><span class="s2">, { </span><span class="s1">paths</span><span class="s2">: [</span><span class="s1">dir</span><span class="s2">] }),</span>
            <span class="s3">'../grux: resolve.sync === require.resolve'</span>
        <span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">end</span><span class="s2">();</span>
<span class="s2">});</span>

<span class="s1">test</span><span class="s2">(</span><span class="s3">'cup'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">t</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">dir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">__dirname</span><span class="s2">, </span><span class="s3">'resolver'</span><span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./cup'</span><span class="s2">, {</span>
            <span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir</span><span class="s2">,</span>
            <span class="s1">extensions</span><span class="s2">: [</span><span class="s3">'.js'</span><span class="s2">, </span><span class="s3">'.coffee'</span><span class="s2">]</span>
        <span class="s2">}),</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'cup.coffee'</span><span class="s2">),</span>
        <span class="s3">'./cup -&gt; ./cup.coffee'</span>
    <span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./cup.coffee'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir </span><span class="s2">}),</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'cup.coffee'</span><span class="s2">),</span>
        <span class="s3">'./cup.coffee'</span>
    <span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">throws</span><span class="s2">(</span><span class="s0">function </span><span class="s2">() {</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./cup'</span><span class="s2">, {</span>
            <span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir</span><span class="s2">,</span>
            <span class="s1">extensions</span><span class="s2">: [</span><span class="s3">'.js'</span><span class="s2">]</span>
        <span class="s2">});</span>
    <span class="s2">});</span>

    <span class="s0">if </span><span class="s2">(</span><span class="s1">requireResolveSupportsPaths</span><span class="s2">) {</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
            <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./cup.coffee'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir</span><span class="s2">, </span><span class="s1">extensions</span><span class="s2">: [</span><span class="s3">'.js'</span><span class="s2">, </span><span class="s3">'.coffee'</span><span class="s2">] }),</span>
            <span class="s1">require</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s3">'./cup.coffee'</span><span class="s2">, { </span><span class="s1">paths</span><span class="s2">: [</span><span class="s1">dir</span><span class="s2">] }),</span>
            <span class="s3">'./cup.coffee: resolve.sync === require.resolve'</span>
        <span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">end</span><span class="s2">();</span>
<span class="s2">});</span>

<span class="s1">test</span><span class="s2">(</span><span class="s3">'mug'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">t</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">dir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">__dirname</span><span class="s2">, </span><span class="s3">'resolver'</span><span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./mug'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir </span><span class="s2">}),</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'mug.js'</span><span class="s2">),</span>
        <span class="s3">'./mug -&gt; ./mug.js'</span>
    <span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">requireResolveSupportsPaths</span><span class="s2">) {</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
            <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./mug'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir </span><span class="s2">}),</span>
            <span class="s1">require</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s3">'./mug'</span><span class="s2">, { </span><span class="s1">paths</span><span class="s2">: [</span><span class="s1">dir</span><span class="s2">] }),</span>
            <span class="s3">'./mug: resolve.sync === require.resolve'</span>
        <span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./mug'</span><span class="s2">, {</span>
            <span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir</span><span class="s2">,</span>
            <span class="s1">extensions</span><span class="s2">: [</span><span class="s3">'.coffee'</span><span class="s2">, </span><span class="s3">'.js'</span><span class="s2">]</span>
        <span class="s2">}),</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'mug.coffee'</span><span class="s2">),</span>
        <span class="s3">'./mug -&gt; ./mug.coffee'</span>
    <span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./mug'</span><span class="s2">, {</span>
            <span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir</span><span class="s2">,</span>
            <span class="s1">extensions</span><span class="s2">: [</span><span class="s3">'.js'</span><span class="s2">, </span><span class="s3">'.coffee'</span><span class="s2">]</span>
        <span class="s2">}),</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'mug.js'</span><span class="s2">),</span>
        <span class="s3">'./mug -&gt; ./mug.js'</span>
    <span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">end</span><span class="s2">();</span>
<span class="s2">});</span>

<span class="s1">test</span><span class="s2">(</span><span class="s3">'other path'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">t</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">resolverDir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">__dirname</span><span class="s2">, </span><span class="s3">'resolver'</span><span class="s2">);</span>
    <span class="s0">var </span><span class="s1">dir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">resolverDir</span><span class="s2">, </span><span class="s3">'bar'</span><span class="s2">);</span>
    <span class="s0">var </span><span class="s1">otherDir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">resolverDir</span><span class="s2">, </span><span class="s3">'other_path'</span><span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'root'</span><span class="s2">, {</span>
            <span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir</span><span class="s2">,</span>
            <span class="s1">paths</span><span class="s2">: [</span><span class="s1">otherDir</span><span class="s2">]</span>
        <span class="s2">}),</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">resolverDir</span><span class="s2">, </span><span class="s3">'other_path/root.js'</span><span class="s2">)</span>
    <span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'lib/other-lib'</span><span class="s2">, {</span>
            <span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir</span><span class="s2">,</span>
            <span class="s1">paths</span><span class="s2">: [</span><span class="s1">otherDir</span><span class="s2">]</span>
        <span class="s2">}),</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">resolverDir</span><span class="s2">, </span><span class="s3">'other_path/lib/other-lib.js'</span><span class="s2">)</span>
    <span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">throws</span><span class="s2">(</span><span class="s0">function </span><span class="s2">() {</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'root'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir </span><span class="s2">});</span>
    <span class="s2">});</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">throws</span><span class="s2">(</span><span class="s0">function </span><span class="s2">() {</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'zzz'</span><span class="s2">, {</span>
            <span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir</span><span class="s2">,</span>
            <span class="s1">paths</span><span class="s2">: [</span><span class="s1">otherDir</span><span class="s2">]</span>
        <span class="s2">});</span>
    <span class="s2">});</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">end</span><span class="s2">();</span>
<span class="s2">});</span>

<span class="s1">test</span><span class="s2">(</span><span class="s3">'path iterator'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">t</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">resolverDir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">__dirname</span><span class="s2">, </span><span class="s3">'resolver'</span><span class="s2">);</span>

    <span class="s0">var </span><span class="s1">exactIterator </span><span class="s2">= </span><span class="s0">function </span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">start</span><span class="s2">, </span><span class="s1">getPackageCandidates</span><span class="s2">, </span><span class="s1">opts</span><span class="s2">) {</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">resolverDir</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)];</span>
    <span class="s2">};</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'baz'</span><span class="s2">, { </span><span class="s1">packageIterator</span><span class="s2">: </span><span class="s1">exactIterator </span><span class="s2">}),</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">resolverDir</span><span class="s2">, </span><span class="s3">'baz/quux.js'</span><span class="s2">)</span>
    <span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">end</span><span class="s2">();</span>
<span class="s2">});</span>

<span class="s1">test</span><span class="s2">(</span><span class="s3">'incorrect main'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">t</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">resolverDir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">__dirname</span><span class="s2">, </span><span class="s3">'resolver'</span><span class="s2">);</span>
    <span class="s0">var </span><span class="s1">dir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">resolverDir</span><span class="s2">, </span><span class="s3">'incorrect_main'</span><span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./incorrect_main'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">resolverDir </span><span class="s2">}),</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'index.js'</span><span class="s2">)</span>
    <span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">requireResolveSupportsPaths</span><span class="s2">) {</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
            <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./incorrect_main'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">resolverDir </span><span class="s2">}),</span>
            <span class="s1">require</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s3">'./incorrect_main'</span><span class="s2">, { </span><span class="s1">paths</span><span class="s2">: [</span><span class="s1">resolverDir</span><span class="s2">] }),</span>
            <span class="s3">'./incorrect_main: resolve.sync === require.resolve'</span>
        <span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">end</span><span class="s2">();</span>
<span class="s2">});</span>

<span class="s1">test</span><span class="s2">(</span><span class="s3">'missing index'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">t</span><span class="s2">) {</span>
    <span class="s1">t</span><span class="s2">.</span><span class="s1">plan</span><span class="s2">(</span><span class="s1">requireResolveSupportsPaths </span><span class="s2">? </span><span class="s4">2 </span><span class="s2">: </span><span class="s4">1</span><span class="s2">);</span>

    <span class="s0">var </span><span class="s1">resolverDir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">__dirname</span><span class="s2">, </span><span class="s3">'resolver'</span><span class="s2">);</span>
    <span class="s0">try </span><span class="s2">{</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./missing_index'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">resolverDir </span><span class="s2">});</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">fail</span><span class="s2">(</span><span class="s3">'did not fail'</span><span class="s2">);</span>
    <span class="s2">} </span><span class="s0">catch </span><span class="s2">(</span><span class="s1">err</span><span class="s2">) {</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span><span class="s1">err </span><span class="s2">&amp;&amp; </span><span class="s1">err</span><span class="s2">.</span><span class="s1">code</span><span class="s2">, </span><span class="s3">'MODULE_NOT_FOUND'</span><span class="s2">, </span><span class="s3">'error has correct error code'</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">requireResolveSupportsPaths</span><span class="s2">) {</span>
        <span class="s0">try </span><span class="s2">{</span>
            <span class="s1">require</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s3">'./missing_index'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">resolverDir </span><span class="s2">});</span>
            <span class="s1">t</span><span class="s2">.</span><span class="s1">fail</span><span class="s2">(</span><span class="s3">'require.resolve did not fail'</span><span class="s2">);</span>
        <span class="s2">} </span><span class="s0">catch </span><span class="s2">(</span><span class="s1">err</span><span class="s2">) {</span>
            <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span><span class="s1">err </span><span class="s2">&amp;&amp; </span><span class="s1">err</span><span class="s2">.</span><span class="s1">code</span><span class="s2">, </span><span class="s3">'MODULE_NOT_FOUND'</span><span class="s2">, </span><span class="s3">'error has correct error code'</span><span class="s2">);</span>
        <span class="s2">}</span>
    <span class="s2">}</span>
<span class="s2">});</span>

<span class="s1">test</span><span class="s2">(</span><span class="s3">'missing main'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">t</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">resolverDir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">__dirname</span><span class="s2">, </span><span class="s3">'resolver'</span><span class="s2">);</span>

    <span class="s0">try </span><span class="s2">{</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./missing_main'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">resolverDir </span><span class="s2">});</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">fail</span><span class="s2">(</span><span class="s3">'require.resolve did not fail'</span><span class="s2">);</span>
    <span class="s2">} </span><span class="s0">catch </span><span class="s2">(</span><span class="s1">err</span><span class="s2">) {</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span><span class="s1">err </span><span class="s2">&amp;&amp; </span><span class="s1">err</span><span class="s2">.</span><span class="s1">code</span><span class="s2">, </span><span class="s3">'MODULE_NOT_FOUND'</span><span class="s2">, </span><span class="s3">'error has correct error code'</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">requireResolveSupportsPaths</span><span class="s2">) {</span>
        <span class="s0">try </span><span class="s2">{</span>
            <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./missing_main'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">resolverDir </span><span class="s2">});</span>
            <span class="s1">t</span><span class="s2">.</span><span class="s1">fail</span><span class="s2">(</span><span class="s3">'require.resolve did not fail'</span><span class="s2">);</span>
        <span class="s2">} </span><span class="s0">catch </span><span class="s2">(</span><span class="s1">err</span><span class="s2">) {</span>
            <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span><span class="s1">err </span><span class="s2">&amp;&amp; </span><span class="s1">err</span><span class="s2">.</span><span class="s1">code</span><span class="s2">, </span><span class="s3">'MODULE_NOT_FOUND'</span><span class="s2">, </span><span class="s3">'error has correct error code'</span><span class="s2">);</span>
        <span class="s2">}</span>
    <span class="s2">}</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">end</span><span class="s2">();</span>
<span class="s2">});</span>

<span class="s1">test</span><span class="s2">(</span><span class="s3">'null main'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">t</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">resolverDir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">__dirname</span><span class="s2">, </span><span class="s3">'resolver'</span><span class="s2">);</span>

    <span class="s0">try </span><span class="s2">{</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./null_main'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">resolverDir </span><span class="s2">});</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">fail</span><span class="s2">(</span><span class="s3">'require.resolve did not fail'</span><span class="s2">);</span>
    <span class="s2">} </span><span class="s0">catch </span><span class="s2">(</span><span class="s1">err</span><span class="s2">) {</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span><span class="s1">err </span><span class="s2">&amp;&amp; </span><span class="s1">err</span><span class="s2">.</span><span class="s1">code</span><span class="s2">, </span><span class="s3">'MODULE_NOT_FOUND'</span><span class="s2">, </span><span class="s3">'error has correct error code'</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">requireResolveSupportsPaths</span><span class="s2">) {</span>
        <span class="s0">try </span><span class="s2">{</span>
            <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./null_main'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">resolverDir </span><span class="s2">});</span>
            <span class="s1">t</span><span class="s2">.</span><span class="s1">fail</span><span class="s2">(</span><span class="s3">'require.resolve did not fail'</span><span class="s2">);</span>
        <span class="s2">} </span><span class="s0">catch </span><span class="s2">(</span><span class="s1">err</span><span class="s2">) {</span>
            <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span><span class="s1">err </span><span class="s2">&amp;&amp; </span><span class="s1">err</span><span class="s2">.</span><span class="s1">code</span><span class="s2">, </span><span class="s3">'MODULE_NOT_FOUND'</span><span class="s2">, </span><span class="s3">'error has correct error code'</span><span class="s2">);</span>
        <span class="s2">}</span>
    <span class="s2">}</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">end</span><span class="s2">();</span>
<span class="s2">});</span>

<span class="s1">test</span><span class="s2">(</span><span class="s3">'main: false'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">t</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">basedir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">__dirname</span><span class="s2">, </span><span class="s3">'resolver'</span><span class="s2">);</span>
    <span class="s0">var </span><span class="s1">dir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">basedir</span><span class="s2">, </span><span class="s3">'false_main'</span><span class="s2">);</span>
    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./false_main'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">basedir </span><span class="s2">}),</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'index.js'</span><span class="s2">),</span>
        <span class="s3">'`&quot;main&quot;: false`: resolves to `index.js`'</span>
    <span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">requireResolveSupportsPaths</span><span class="s2">) {</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
            <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./false_main'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">basedir </span><span class="s2">}),</span>
            <span class="s1">require</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s3">'./false_main'</span><span class="s2">, { </span><span class="s1">paths</span><span class="s2">: [</span><span class="s1">basedir</span><span class="s2">] }),</span>
            <span class="s3">'`&quot;main&quot;: false`: resolve.sync === require.resolve'</span>
        <span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">end</span><span class="s2">();</span>
<span class="s2">});</span>

<span class="s0">var </span><span class="s1">stubStatSync </span><span class="s2">= </span><span class="s0">function </span><span class="s1">stubStatSync</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">statSync </span><span class="s2">= </span><span class="s1">fs</span><span class="s2">.</span><span class="s1">statSync</span><span class="s2">;</span>
    <span class="s0">try </span><span class="s2">{</span>
        <span class="s1">fs</span><span class="s2">.</span><span class="s1">statSync </span><span class="s2">= </span><span class="s0">function </span><span class="s2">() {</span>
            <span class="s0">throw new </span><span class="s1">EvalError</span><span class="s2">(</span><span class="s3">'Unknown Error'</span><span class="s2">);</span>
        <span class="s2">};</span>
        <span class="s0">return </span><span class="s1">fn</span><span class="s2">();</span>
    <span class="s2">} </span><span class="s0">finally </span><span class="s2">{</span>
        <span class="s1">fs</span><span class="s2">.</span><span class="s1">statSync </span><span class="s2">= </span><span class="s1">statSync</span><span class="s2">;</span>
    <span class="s2">}</span>
<span class="s2">};</span>

<span class="s1">test</span><span class="s2">(</span><span class="s3">'#79 - re-throw non ENOENT errors from stat'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">t</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">dir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">__dirname</span><span class="s2">, </span><span class="s3">'resolver'</span><span class="s2">);</span>

    <span class="s1">stubStatSync</span><span class="s2">(</span><span class="s0">function </span><span class="s2">() {</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">throws</span><span class="s2">(</span><span class="s0">function </span><span class="s2">() {</span>
            <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'foo'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir </span><span class="s2">});</span>
        <span class="s2">}, </span><span class="s5">/Unknown Error/</span><span class="s2">);</span>
    <span class="s2">});</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">end</span><span class="s2">();</span>
<span class="s2">});</span>

<span class="s1">test</span><span class="s2">(</span><span class="s3">'#52 - incorrectly resolves module-paths like &quot;./someFolder/&quot; when there is a file of the same name'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">t</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">dir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">__dirname</span><span class="s2">, </span><span class="s3">'resolver'</span><span class="s2">);</span>
    <span class="s0">var </span><span class="s1">basedir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'same_names'</span><span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./foo'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">basedir </span><span class="s2">}),</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'same_names/foo.js'</span><span class="s2">)</span>
    <span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">requireResolveSupportsPaths</span><span class="s2">) {</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
            <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./foo'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">basedir </span><span class="s2">}),</span>
            <span class="s1">require</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s3">'./foo'</span><span class="s2">, { </span><span class="s1">paths</span><span class="s2">: [</span><span class="s1">basedir</span><span class="s2">] }),</span>
            <span class="s3">'./foo: resolve.sync === require.resolve'</span>
        <span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./foo/'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">basedir </span><span class="s2">}),</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'same_names/foo/index.js'</span><span class="s2">)</span>
    <span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">requireResolveSupportsPaths</span><span class="s2">) {</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
            <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./foo/'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">basedir </span><span class="s2">}),</span>
            <span class="s1">require</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s3">'./foo/'</span><span class="s2">, { </span><span class="s1">paths</span><span class="s2">: [</span><span class="s1">basedir</span><span class="s2">] }),</span>
            <span class="s3">'./foo/: resolve.sync === require.resolve'</span>
        <span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">end</span><span class="s2">();</span>
<span class="s2">});</span>

<span class="s1">test</span><span class="s2">(</span><span class="s3">'#211 - incorrectly resolves module-paths like &quot;.&quot; when from inside a folder with a sibling file of the same name'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">t</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">dir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">__dirname</span><span class="s2">, </span><span class="s3">'resolver'</span><span class="s2">);</span>
    <span class="s0">var </span><span class="s1">basedir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'same_names/foo'</span><span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">basedir </span><span class="s2">}),</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'same_names/foo/index.js'</span><span class="s2">),</span>
        <span class="s3">'./'</span>
    <span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">requireResolveSupportsPaths</span><span class="s2">) {</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
            <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">basedir </span><span class="s2">}),</span>
            <span class="s1">require</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s3">'./'</span><span class="s2">, { </span><span class="s1">paths</span><span class="s2">: [</span><span class="s1">basedir</span><span class="s2">] }),</span>
            <span class="s3">'./: resolve.sync === require.resolve'</span>
        <span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'.'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">basedir </span><span class="s2">}),</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'same_names/foo/index.js'</span><span class="s2">),</span>
        <span class="s3">'.'</span>
    <span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">requireResolveSupportsPaths</span><span class="s2">) {</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
            <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'.'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">basedir </span><span class="s2">}),</span>
            <span class="s1">require</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s3">'.'</span><span class="s2">, { </span><span class="s1">paths</span><span class="s2">: [</span><span class="s1">basedir</span><span class="s2">] }),</span>
            <span class="s3">'.: resolve.sync === require.resolve'</span><span class="s2">,</span>
            <span class="s2">{ </span><span class="s1">todo</span><span class="s2">: </span><span class="s0">true </span><span class="s2">}</span>
        <span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">end</span><span class="s2">();</span>
<span class="s2">});</span>

<span class="s1">test</span><span class="s2">(</span><span class="s3">'sync: #121 - treating an existing file as a dir when no basedir'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">t</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">testFile </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">basename</span><span class="s2">(</span><span class="s1">__filename</span><span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s3">'sanity check'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">st</span><span class="s2">) {</span>
        <span class="s1">st</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
            <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./' </span><span class="s2">+ </span><span class="s1">testFile</span><span class="s2">),</span>
            <span class="s1">__filename</span><span class="s2">,</span>
            <span class="s3">'sanity check'</span>
        <span class="s2">);</span>
        <span class="s1">st</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
            <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./' </span><span class="s2">+ </span><span class="s1">testFile</span><span class="s2">),</span>
            <span class="s1">require</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s3">'./' </span><span class="s2">+ </span><span class="s1">testFile</span><span class="s2">),</span>
            <span class="s3">'sanity check: resolve.sync === require.resolve'</span>
        <span class="s2">);</span>

        <span class="s1">st</span><span class="s2">.</span><span class="s1">end</span><span class="s2">();</span>
    <span class="s2">});</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">test</span><span class="s2">(</span><span class="s3">'with a fake directory'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">st</span><span class="s2">) {</span>
        <span class="s0">function </span><span class="s1">run</span><span class="s2">() { </span><span class="s0">return </span><span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./' </span><span class="s2">+ </span><span class="s1">testFile </span><span class="s2">+ </span><span class="s3">'/blah'</span><span class="s2">); }</span>

        <span class="s1">st</span><span class="s2">.</span><span class="s1">throws</span><span class="s2">(</span><span class="s1">run</span><span class="s2">, </span><span class="s3">'throws an error'</span><span class="s2">);</span>

        <span class="s0">try </span><span class="s2">{</span>
            <span class="s1">run</span><span class="s2">();</span>
        <span class="s2">} </span><span class="s0">catch </span><span class="s2">(</span><span class="s1">e</span><span class="s2">) {</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span><span class="s1">e</span><span class="s2">.</span><span class="s1">code</span><span class="s2">, </span><span class="s3">'MODULE_NOT_FOUND'</span><span class="s2">, </span><span class="s3">'error code matches require.resolve'</span><span class="s2">);</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
                <span class="s1">e</span><span class="s2">.</span><span class="s1">message</span><span class="s2">,</span>
                <span class="s3">'Cannot find module </span><span class="s0">\'</span><span class="s3">./' </span><span class="s2">+ </span><span class="s1">testFile </span><span class="s2">+ </span><span class="s3">'/blah</span><span class="s0">\' </span><span class="s3">from </span><span class="s0">\'</span><span class="s3">' </span><span class="s2">+ </span><span class="s1">__dirname </span><span class="s2">+ </span><span class="s3">'</span><span class="s0">\'</span><span class="s3">'</span><span class="s2">,</span>
                <span class="s3">'can not find nonexistent module'</span>
            <span class="s2">);</span>
        <span class="s2">}</span>

        <span class="s1">st</span><span class="s2">.</span><span class="s1">end</span><span class="s2">();</span>
    <span class="s2">});</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">end</span><span class="s2">();</span>
<span class="s2">});</span>

<span class="s1">test</span><span class="s2">(</span><span class="s3">'sync dot main'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">t</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">start </span><span class="s2">= </span><span class="s0">new </span><span class="s1">Date</span><span class="s2">();</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./resolver/dot_main'</span><span class="s2">),</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">__dirname</span><span class="s2">, </span><span class="s3">'resolver/dot_main/index.js'</span><span class="s2">),</span>
        <span class="s3">'./resolver/dot_main'</span>
    <span class="s2">);</span>
    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./resolver/dot_main'</span><span class="s2">),</span>
        <span class="s1">require</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s3">'./resolver/dot_main'</span><span class="s2">),</span>
        <span class="s3">'./resolver/dot_main: resolve.sync === require.resolve'</span>
    <span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">ok</span><span class="s2">(</span><span class="s0">new </span><span class="s1">Date</span><span class="s2">() - </span><span class="s1">start </span><span class="s2">&lt; </span><span class="s4">50</span><span class="s2">, </span><span class="s3">'resolve.sync timedout'</span><span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">end</span><span class="s2">();</span>
<span class="s2">});</span>

<span class="s1">test</span><span class="s2">(</span><span class="s3">'sync dot slash main'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">t</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">start </span><span class="s2">= </span><span class="s0">new </span><span class="s1">Date</span><span class="s2">();</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./resolver/dot_slash_main'</span><span class="s2">),</span>
        <span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">__dirname</span><span class="s2">, </span><span class="s3">'resolver/dot_slash_main/index.js'</span><span class="s2">)</span>
    <span class="s2">);</span>
    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./resolver/dot_slash_main'</span><span class="s2">),</span>
        <span class="s1">require</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s3">'./resolver/dot_slash_main'</span><span class="s2">),</span>
        <span class="s3">'./resolver/dot_slash_main: resolve.sync === require.resolve'</span>
    <span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">ok</span><span class="s2">(</span><span class="s0">new </span><span class="s1">Date</span><span class="s2">() - </span><span class="s1">start </span><span class="s2">&lt; </span><span class="s4">50</span><span class="s2">, </span><span class="s3">'resolve.sync timedout'</span><span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">end</span><span class="s2">();</span>
<span class="s2">});</span>

<span class="s1">test</span><span class="s2">(</span><span class="s3">'not a directory'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">t</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">path </span><span class="s2">= </span><span class="s3">'./foo'</span><span class="s2">;</span>
    <span class="s0">try </span><span class="s2">{</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">__filename </span><span class="s2">});</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">fail</span><span class="s2">();</span>
    <span class="s2">} </span><span class="s0">catch </span><span class="s2">(</span><span class="s1">err</span><span class="s2">) {</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">ok</span><span class="s2">(</span><span class="s1">err</span><span class="s2">, </span><span class="s3">'a non-directory errors'</span><span class="s2">);</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span><span class="s1">err </span><span class="s2">&amp;&amp; </span><span class="s1">err</span><span class="s2">.</span><span class="s1">message</span><span class="s2">, </span><span class="s3">'Cannot find module </span><span class="s0">\'</span><span class="s3">' </span><span class="s2">+ </span><span class="s1">path </span><span class="s2">+ </span><span class="s3">&quot;' from '&quot; </span><span class="s2">+ </span><span class="s1">__filename </span><span class="s2">+ </span><span class="s3">&quot;'&quot;</span><span class="s2">);</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span><span class="s1">err </span><span class="s2">&amp;&amp; </span><span class="s1">err</span><span class="s2">.</span><span class="s1">code</span><span class="s2">, </span><span class="s3">'MODULE_NOT_FOUND'</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s1">t</span><span class="s2">.</span><span class="s1">end</span><span class="s2">();</span>
<span class="s2">});</span>

<span class="s1">test</span><span class="s2">(</span><span class="s3">'non-string &quot;main&quot; field in package.json'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">t</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">dir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">__dirname</span><span class="s2">, </span><span class="s3">'resolver'</span><span class="s2">);</span>
    <span class="s0">try </span><span class="s2">{</span>
        <span class="s0">var </span><span class="s1">result </span><span class="s2">= </span><span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./invalid_main'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir </span><span class="s2">});</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">undefined</span><span class="s2">, </span><span class="s3">'result should not exist'</span><span class="s2">);</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">fail</span><span class="s2">(</span><span class="s3">'should not get here'</span><span class="s2">);</span>
    <span class="s2">} </span><span class="s0">catch </span><span class="s2">(</span><span class="s1">err</span><span class="s2">) {</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">ok</span><span class="s2">(</span><span class="s1">err</span><span class="s2">, </span><span class="s3">'errors on non-string main'</span><span class="s2">);</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span><span class="s1">err</span><span class="s2">.</span><span class="s1">message</span><span class="s2">, </span><span class="s3">'package invalid_main `main` must be a string'</span><span class="s2">);</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span><span class="s1">err</span><span class="s2">.</span><span class="s1">code</span><span class="s2">, </span><span class="s3">'INVALID_PACKAGE_MAIN'</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s1">t</span><span class="s2">.</span><span class="s1">end</span><span class="s2">();</span>
<span class="s2">});</span>

<span class="s1">test</span><span class="s2">(</span><span class="s3">'non-string &quot;main&quot; field in package.json'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">t</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">dir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">__dirname</span><span class="s2">, </span><span class="s3">'resolver'</span><span class="s2">);</span>
    <span class="s0">try </span><span class="s2">{</span>
        <span class="s0">var </span><span class="s1">result </span><span class="s2">= </span><span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./invalid_main'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir </span><span class="s2">});</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">undefined</span><span class="s2">, </span><span class="s3">'result should not exist'</span><span class="s2">);</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">fail</span><span class="s2">(</span><span class="s3">'should not get here'</span><span class="s2">);</span>
    <span class="s2">} </span><span class="s0">catch </span><span class="s2">(</span><span class="s1">err</span><span class="s2">) {</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">ok</span><span class="s2">(</span><span class="s1">err</span><span class="s2">, </span><span class="s3">'errors on non-string main'</span><span class="s2">);</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span><span class="s1">err</span><span class="s2">.</span><span class="s1">message</span><span class="s2">, </span><span class="s3">'package invalid_main `main` must be a string'</span><span class="s2">);</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span><span class="s1">err</span><span class="s2">.</span><span class="s1">code</span><span class="s2">, </span><span class="s3">'INVALID_PACKAGE_MAIN'</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s1">t</span><span class="s2">.</span><span class="s1">end</span><span class="s2">();</span>
<span class="s2">});</span>

<span class="s1">test</span><span class="s2">(</span><span class="s3">'browser field in package.json'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">t</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">dir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">__dirname</span><span class="s2">, </span><span class="s3">'resolver'</span><span class="s2">);</span>
    <span class="s0">var </span><span class="s1">res </span><span class="s2">= </span><span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./browser_field'</span><span class="s2">, {</span>
        <span class="s1">basedir</span><span class="s2">: </span><span class="s1">dir</span><span class="s2">,</span>
        <span class="s1">packageFilter</span><span class="s2">: </span><span class="s0">function </span><span class="s1">packageFilter</span><span class="s2">(</span><span class="s1">pkg</span><span class="s2">) {</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">pkg</span><span class="s2">.</span><span class="s1">browser</span><span class="s2">) {</span>
                <span class="s1">pkg</span><span class="s2">.</span><span class="s1">main </span><span class="s2">= </span><span class="s1">pkg</span><span class="s2">.</span><span class="s1">browser</span><span class="s2">; </span><span class="s6">// eslint-disable-line no-param-reassign</span>
                <span class="s0">delete </span><span class="s1">pkg</span><span class="s2">.</span><span class="s1">browser</span><span class="s2">; </span><span class="s6">// eslint-disable-line no-param-reassign</span>
            <span class="s2">}</span>
            <span class="s0">return </span><span class="s1">pkg</span><span class="s2">;</span>
        <span class="s2">}</span>
    <span class="s2">});</span>
    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">dir</span><span class="s2">, </span><span class="s3">'browser_field'</span><span class="s2">, </span><span class="s3">'b.js'</span><span class="s2">));</span>
    <span class="s1">t</span><span class="s2">.</span><span class="s1">end</span><span class="s2">();</span>
<span class="s2">});</span>

<span class="s1">test</span><span class="s2">(</span><span class="s3">'absolute paths'</span><span class="s2">, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">t</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">extensionless </span><span class="s2">= </span><span class="s1">__filename</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, -</span><span class="s1">path</span><span class="s2">.</span><span class="s1">extname</span><span class="s2">(</span><span class="s1">__filename</span><span class="s2">).</span><span class="s1">length</span><span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s1">__filename</span><span class="s2">),</span>
        <span class="s1">__filename</span><span class="s2">,</span>
        <span class="s3">'absolute path to this file resolves'</span>
    <span class="s2">);</span>
    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s1">__filename</span><span class="s2">),</span>
        <span class="s1">require</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s1">__filename</span><span class="s2">),</span>
        <span class="s3">'absolute path to this file: resolve.sync === require.resolve'</span>
    <span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s1">extensionless</span><span class="s2">),</span>
        <span class="s1">__filename</span><span class="s2">,</span>
        <span class="s3">'extensionless absolute path to this file resolves'</span>
    <span class="s2">);</span>
    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s1">__filename</span><span class="s2">),</span>
        <span class="s1">require</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s1">__filename</span><span class="s2">),</span>
        <span class="s3">'absolute path to this file: resolve.sync === require.resolve'</span>
    <span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s1">__filename</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">process</span><span class="s2">.</span><span class="s1">cwd</span><span class="s2">() }),</span>
        <span class="s1">__filename</span><span class="s2">,</span>
        <span class="s3">'absolute path to this file with a basedir resolves'</span>
    <span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">requireResolveSupportsPaths</span><span class="s2">) {</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
            <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s1">__filename</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">process</span><span class="s2">.</span><span class="s1">cwd</span><span class="s2">() }),</span>
            <span class="s1">require</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s1">__filename</span><span class="s2">, { </span><span class="s1">paths</span><span class="s2">: [</span><span class="s1">process</span><span class="s2">.</span><span class="s1">cwd</span><span class="s2">()] }),</span>
            <span class="s3">'absolute path to this file + basedir: resolve.sync === require.resolve'</span>
        <span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s1">extensionless</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">process</span><span class="s2">.</span><span class="s1">cwd</span><span class="s2">() }),</span>
        <span class="s1">__filename</span><span class="s2">,</span>
        <span class="s3">'extensionless absolute path to this file with a basedir resolves'</span>
    <span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">requireResolveSupportsPaths</span><span class="s2">) {</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
            <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s1">extensionless</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">process</span><span class="s2">.</span><span class="s1">cwd</span><span class="s2">() }),</span>
            <span class="s1">require</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s1">extensionless</span><span class="s2">, { </span><span class="s1">paths</span><span class="s2">: [</span><span class="s1">process</span><span class="s2">.</span><span class="s1">cwd</span><span class="s2">()] }),</span>
            <span class="s3">'extensionless absolute path to this file + basedir: resolve.sync === require.resolve'</span>
        <span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">end</span><span class="s2">();</span>
<span class="s2">});</span>

<span class="s0">var </span><span class="s1">malformedDir </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">__dirname</span><span class="s2">, </span><span class="s3">'resolver/malformed_package_json'</span><span class="s2">);</span>
<span class="s1">test</span><span class="s2">(</span><span class="s3">'malformed package.json'</span><span class="s2">, { </span><span class="s1">skip</span><span class="s2">: !</span><span class="s1">fs</span><span class="s2">.</span><span class="s1">existsSync</span><span class="s2">(</span><span class="s1">malformedDir</span><span class="s2">) }, </span><span class="s0">function </span><span class="s2">(</span><span class="s1">t</span><span class="s2">) {</span>
    <span class="s1">t</span><span class="s2">.</span><span class="s1">plan</span><span class="s2">(</span><span class="s4">5 </span><span class="s2">+ (</span><span class="s1">requireResolveSupportsPaths </span><span class="s2">? </span><span class="s4">1 </span><span class="s2">: </span><span class="s4">0</span><span class="s2">));</span>

    <span class="s0">var </span><span class="s1">basedir </span><span class="s2">= </span><span class="s1">malformedDir</span><span class="s2">;</span>
    <span class="s0">var </span><span class="s1">expected </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">basedir</span><span class="s2">, </span><span class="s3">'index.js'</span><span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./index.js'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">basedir </span><span class="s2">}),</span>
        <span class="s1">expected</span><span class="s2">,</span>
        <span class="s3">'malformed package.json is silently ignored'</span>
    <span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">requireResolveSupportsPaths</span><span class="s2">) {</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
            <span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span><span class="s3">'./index.js'</span><span class="s2">, { </span><span class="s1">basedir</span><span class="s2">: </span><span class="s1">basedir </span><span class="s2">}),</span>
            <span class="s1">require</span><span class="s2">.</span><span class="s1">resolve</span><span class="s2">(</span><span class="s3">'./index.js'</span><span class="s2">, { </span><span class="s1">paths</span><span class="s2">: [</span><span class="s1">basedir</span><span class="s2">] }),</span>
            <span class="s3">'malformed package.json: resolve.sync === require.resolve'</span>
        <span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s0">var </span><span class="s1">res1 </span><span class="s2">= </span><span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span>
        <span class="s3">'./index.js'</span><span class="s2">,</span>
        <span class="s2">{</span>
            <span class="s1">basedir</span><span class="s2">: </span><span class="s1">basedir</span><span class="s2">,</span>
            <span class="s1">packageFilter</span><span class="s2">: </span><span class="s0">function </span><span class="s2">(</span><span class="s1">pkg</span><span class="s2">, </span><span class="s1">pkgfile</span><span class="s2">, </span><span class="s1">dir</span><span class="s2">) {</span>
                <span class="s1">t</span><span class="s2">.</span><span class="s1">fail</span><span class="s2">(</span><span class="s3">'should not reach here'</span><span class="s2">);</span>
            <span class="s2">}</span>
        <span class="s2">}</span>
    <span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">res1</span><span class="s2">,</span>
        <span class="s1">expected</span><span class="s2">,</span>
        <span class="s3">'with packageFilter: malformed package.json is silently ignored'</span>
    <span class="s2">);</span>

    <span class="s0">var </span><span class="s1">res2 </span><span class="s2">= </span><span class="s1">resolve</span><span class="s2">.</span><span class="s1">sync</span><span class="s2">(</span>
        <span class="s3">'./index.js'</span><span class="s2">,</span>
        <span class="s2">{</span>
            <span class="s1">basedir</span><span class="s2">: </span><span class="s1">basedir</span><span class="s2">,</span>
            <span class="s1">readPackageSync</span><span class="s2">: </span><span class="s0">function </span><span class="s2">(</span><span class="s1">readFileSync</span><span class="s2">, </span><span class="s1">pkgfile</span><span class="s2">) {</span>
                <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span><span class="s1">pkgfile</span><span class="s2">, </span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">basedir</span><span class="s2">, </span><span class="s3">'package.json'</span><span class="s2">), </span><span class="s3">'readPackageSync: `pkgfile` is package.json path'</span><span class="s2">);</span>
                <span class="s0">var </span><span class="s1">result </span><span class="s2">= </span><span class="s1">String</span><span class="s2">(</span><span class="s1">readFileSync</span><span class="s2">(</span><span class="s1">pkgfile</span><span class="s2">));</span>
                <span class="s0">try </span><span class="s2">{</span>
                    <span class="s0">return </span><span class="s1">JSON</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s1">result</span><span class="s2">);</span>
                <span class="s2">} </span><span class="s0">catch </span><span class="s2">(</span><span class="s1">e</span><span class="s2">) {</span>
                    <span class="s1">t</span><span class="s2">.</span><span class="s1">ok</span><span class="s2">(</span><span class="s1">e </span><span class="s0">instanceof </span><span class="s1">SyntaxError</span><span class="s2">, </span><span class="s3">'readPackageSync: malformed package.json parses as a syntax error'</span><span class="s2">);</span>
                <span class="s2">}</span>
            <span class="s2">}</span>
        <span class="s2">}</span>
    <span class="s2">);</span>

    <span class="s1">t</span><span class="s2">.</span><span class="s1">equal</span><span class="s2">(</span>
        <span class="s1">res2</span><span class="s2">,</span>
        <span class="s1">expected</span><span class="s2">,</span>
        <span class="s3">'with readPackageSync: malformed package.json is silently ignored'</span>
    <span class="s2">);</span>
<span class="s2">});</span>
</pre>
</body>
</html>