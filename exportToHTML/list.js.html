<html>
<head>
<title>List.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
List.js</font>
</center></td></tr></table>
<pre><span class="s0">//</span>
<span class="s0">//                              list</span>
<span class="s0">//                            ┌──────┐</span>
<span class="s0">//             ┌──────────────┼─head │</span>
<span class="s0">//             │              │ tail─┼──────────────┐</span>
<span class="s0">//             │              └──────┘              │</span>
<span class="s0">//             ▼                                    ▼</span>
<span class="s0">//            item        item        item        item</span>
<span class="s0">//          ┌──────┐    ┌──────┐    ┌──────┐    ┌──────┐</span>
<span class="s0">//  null ◀──┼─prev │◀───┼─prev │◀───┼─prev │◀───┼─prev │</span>
<span class="s0">//          │ next─┼───▶│ next─┼───▶│ next─┼───▶│ next─┼──▶ null</span>
<span class="s0">//          ├──────┤    ├──────┤    ├──────┤    ├──────┤</span>
<span class="s0">//          │ data │    │ data │    │ data │    │ data │</span>
<span class="s0">//          └──────┘    └──────┘    └──────┘    └──────┘</span>
<span class="s0">//</span>

<span class="s2">function </span><span class="s1">createItem</span><span class="s3">(</span><span class="s1">data</span><span class="s3">) {</span>
    <span class="s2">return </span><span class="s3">{</span>
        <span class="s1">prev</span><span class="s3">: </span><span class="s2">null</span><span class="s3">,</span>
        <span class="s1">next</span><span class="s3">: </span><span class="s2">null</span><span class="s3">,</span>
        <span class="s1">data</span><span class="s3">: </span><span class="s1">data</span>
    <span class="s3">};</span>
<span class="s3">}</span>

<span class="s2">function </span><span class="s1">allocateCursor</span><span class="s3">(</span><span class="s1">node</span><span class="s3">, </span><span class="s1">prev</span><span class="s3">, </span><span class="s1">next</span><span class="s3">) {</span>
    <span class="s2">var </span><span class="s1">cursor</span><span class="s3">;</span>

    <span class="s2">if </span><span class="s3">(</span><span class="s1">cursors </span><span class="s3">!== </span><span class="s2">null</span><span class="s3">) {</span>
        <span class="s1">cursor </span><span class="s3">= </span><span class="s1">cursors</span><span class="s3">;</span>
        <span class="s1">cursors </span><span class="s3">= </span><span class="s1">cursors</span><span class="s3">.</span><span class="s1">cursor</span><span class="s3">;</span>
        <span class="s1">cursor</span><span class="s3">.</span><span class="s1">prev </span><span class="s3">= </span><span class="s1">prev</span><span class="s3">;</span>
        <span class="s1">cursor</span><span class="s3">.</span><span class="s1">next </span><span class="s3">= </span><span class="s1">next</span><span class="s3">;</span>
        <span class="s1">cursor</span><span class="s3">.</span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">node</span><span class="s3">.</span><span class="s1">cursor</span><span class="s3">;</span>
    <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
        <span class="s1">cursor </span><span class="s3">= {</span>
            <span class="s1">prev</span><span class="s3">: </span><span class="s1">prev</span><span class="s3">,</span>
            <span class="s1">next</span><span class="s3">: </span><span class="s1">next</span><span class="s3">,</span>
            <span class="s1">cursor</span><span class="s3">: </span><span class="s1">node</span><span class="s3">.</span><span class="s1">cursor</span>
        <span class="s3">};</span>
    <span class="s3">}</span>

    <span class="s1">node</span><span class="s3">.</span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">cursor</span><span class="s3">;</span>

    <span class="s2">return </span><span class="s1">cursor</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s2">function </span><span class="s1">releaseCursor</span><span class="s3">(</span><span class="s1">node</span><span class="s3">) {</span>
    <span class="s2">var </span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">node</span><span class="s3">.</span><span class="s1">cursor</span><span class="s3">;</span>

    <span class="s1">node</span><span class="s3">.</span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">cursor</span><span class="s3">;</span>
    <span class="s1">cursor</span><span class="s3">.</span><span class="s1">prev </span><span class="s3">= </span><span class="s2">null</span><span class="s3">;</span>
    <span class="s1">cursor</span><span class="s3">.</span><span class="s1">next </span><span class="s3">= </span><span class="s2">null</span><span class="s3">;</span>
    <span class="s1">cursor</span><span class="s3">.</span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">cursors</span><span class="s3">;</span>
    <span class="s1">cursors </span><span class="s3">= </span><span class="s1">cursor</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s2">var </span><span class="s1">cursors </span><span class="s3">= </span><span class="s2">null</span><span class="s3">;</span>
<span class="s2">var </span><span class="s1">List </span><span class="s3">= </span><span class="s2">function</span><span class="s3">() {</span>
    <span class="s2">this</span><span class="s3">.</span><span class="s1">cursor </span><span class="s3">= </span><span class="s2">null</span><span class="s3">;</span>
    <span class="s2">this</span><span class="s3">.</span><span class="s1">head </span><span class="s3">= </span><span class="s2">null</span><span class="s3">;</span>
    <span class="s2">this</span><span class="s3">.</span><span class="s1">tail </span><span class="s3">= </span><span class="s2">null</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">createItem </span><span class="s3">= </span><span class="s1">createItem</span><span class="s3">;</span>
<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">createItem </span><span class="s3">= </span><span class="s1">createItem</span><span class="s3">;</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">updateCursors </span><span class="s3">= </span><span class="s2">function</span><span class="s3">(</span><span class="s1">prevOld</span><span class="s3">, </span><span class="s1">prevNew</span><span class="s3">, </span><span class="s1">nextOld</span><span class="s3">, </span><span class="s1">nextNew</span><span class="s3">) {</span>
    <span class="s2">var </span><span class="s1">cursor </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">cursor</span><span class="s3">;</span>

    <span class="s2">while </span><span class="s3">(</span><span class="s1">cursor </span><span class="s3">!== </span><span class="s2">null</span><span class="s3">) {</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">prev </span><span class="s3">=== </span><span class="s1">prevOld</span><span class="s3">) {</span>
            <span class="s1">cursor</span><span class="s3">.</span><span class="s1">prev </span><span class="s3">= </span><span class="s1">prevNew</span><span class="s3">;</span>
        <span class="s3">}</span>

        <span class="s2">if </span><span class="s3">(</span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">next </span><span class="s3">=== </span><span class="s1">nextOld</span><span class="s3">) {</span>
            <span class="s1">cursor</span><span class="s3">.</span><span class="s1">next </span><span class="s3">= </span><span class="s1">nextNew</span><span class="s3">;</span>
        <span class="s3">}</span>

        <span class="s1">cursor </span><span class="s3">= </span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">cursor</span><span class="s3">;</span>
    <span class="s3">}</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">getSize </span><span class="s3">= </span><span class="s2">function</span><span class="s3">() {</span>
    <span class="s2">var </span><span class="s1">size </span><span class="s3">= </span><span class="s4">0</span><span class="s3">;</span>
    <span class="s2">var </span><span class="s1">cursor </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">head</span><span class="s3">;</span>

    <span class="s2">while </span><span class="s3">(</span><span class="s1">cursor</span><span class="s3">) {</span>
        <span class="s1">size</span><span class="s3">++;</span>
        <span class="s1">cursor </span><span class="s3">= </span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">next</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s2">return </span><span class="s1">size</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">fromArray </span><span class="s3">= </span><span class="s2">function</span><span class="s3">(</span><span class="s1">array</span><span class="s3">) {</span>
    <span class="s2">var </span><span class="s1">cursor </span><span class="s3">= </span><span class="s2">null</span><span class="s3">;</span>

    <span class="s2">this</span><span class="s3">.</span><span class="s1">head </span><span class="s3">= </span><span class="s2">null</span><span class="s3">;</span>

    <span class="s2">for </span><span class="s3">(</span><span class="s2">var </span><span class="s1">i </span><span class="s3">= </span><span class="s4">0</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">array</span><span class="s3">.</span><span class="s1">length</span><span class="s3">; </span><span class="s1">i</span><span class="s3">++) {</span>
        <span class="s2">var </span><span class="s1">item </span><span class="s3">= </span><span class="s1">createItem</span><span class="s3">(</span><span class="s1">array</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]);</span>

        <span class="s2">if </span><span class="s3">(</span><span class="s1">cursor </span><span class="s3">!== </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s1">cursor</span><span class="s3">.</span><span class="s1">next </span><span class="s3">= </span><span class="s1">item</span><span class="s3">;</span>
        <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
            <span class="s2">this</span><span class="s3">.</span><span class="s1">head </span><span class="s3">= </span><span class="s1">item</span><span class="s3">;</span>
        <span class="s3">}</span>

        <span class="s1">item</span><span class="s3">.</span><span class="s1">prev </span><span class="s3">= </span><span class="s1">cursor</span><span class="s3">;</span>
        <span class="s1">cursor </span><span class="s3">= </span><span class="s1">item</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s2">this</span><span class="s3">.</span><span class="s1">tail </span><span class="s3">= </span><span class="s1">cursor</span><span class="s3">;</span>

    <span class="s2">return this</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">toArray </span><span class="s3">= </span><span class="s2">function</span><span class="s3">() {</span>
    <span class="s2">var </span><span class="s1">cursor </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">head</span><span class="s3">;</span>
    <span class="s2">var </span><span class="s1">result </span><span class="s3">= [];</span>

    <span class="s2">while </span><span class="s3">(</span><span class="s1">cursor</span><span class="s3">) {</span>
        <span class="s1">result</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">data</span><span class="s3">);</span>
        <span class="s1">cursor </span><span class="s3">= </span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">next</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s2">return </span><span class="s1">result</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">toJSON </span><span class="s3">= </span><span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">toArray</span><span class="s3">;</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">isEmpty </span><span class="s3">= </span><span class="s2">function</span><span class="s3">() {</span>
    <span class="s2">return this</span><span class="s3">.</span><span class="s1">head </span><span class="s3">=== </span><span class="s2">null</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">first </span><span class="s3">= </span><span class="s2">function</span><span class="s3">() {</span>
    <span class="s2">return this</span><span class="s3">.</span><span class="s1">head </span><span class="s3">&amp;&amp; </span><span class="s2">this</span><span class="s3">.</span><span class="s1">head</span><span class="s3">.</span><span class="s1">data</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">last </span><span class="s3">= </span><span class="s2">function</span><span class="s3">() {</span>
    <span class="s2">return this</span><span class="s3">.</span><span class="s1">tail </span><span class="s3">&amp;&amp; </span><span class="s2">this</span><span class="s3">.</span><span class="s1">tail</span><span class="s3">.</span><span class="s1">data</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">each </span><span class="s3">= </span><span class="s2">function</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">, </span><span class="s1">context</span><span class="s3">) {</span>
    <span class="s2">var </span><span class="s1">item</span><span class="s3">;</span>

    <span class="s2">if </span><span class="s3">(</span><span class="s1">context </span><span class="s3">=== </span><span class="s1">undefined</span><span class="s3">) {</span>
        <span class="s1">context </span><span class="s3">= </span><span class="s2">this</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s0">// push cursor</span>
    <span class="s2">var </span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">allocateCursor</span><span class="s3">(</span><span class="s2">this</span><span class="s3">, </span><span class="s2">null</span><span class="s3">, </span><span class="s2">this</span><span class="s3">.</span><span class="s1">head</span><span class="s3">);</span>

    <span class="s2">while </span><span class="s3">(</span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">next </span><span class="s3">!== </span><span class="s2">null</span><span class="s3">) {</span>
        <span class="s1">item </span><span class="s3">= </span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">next</span><span class="s3">;</span>
        <span class="s1">cursor</span><span class="s3">.</span><span class="s1">next </span><span class="s3">= </span><span class="s1">item</span><span class="s3">.</span><span class="s1">next</span><span class="s3">;</span>

        <span class="s1">fn</span><span class="s3">.</span><span class="s1">call</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">item</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">item</span><span class="s3">, </span><span class="s2">this</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s0">// pop cursor</span>
    <span class="s1">releaseCursor</span><span class="s3">(</span><span class="s2">this</span><span class="s3">);</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">forEach </span><span class="s3">= </span><span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">each</span><span class="s3">;</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">eachRight </span><span class="s3">= </span><span class="s2">function</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">, </span><span class="s1">context</span><span class="s3">) {</span>
    <span class="s2">var </span><span class="s1">item</span><span class="s3">;</span>

    <span class="s2">if </span><span class="s3">(</span><span class="s1">context </span><span class="s3">=== </span><span class="s1">undefined</span><span class="s3">) {</span>
        <span class="s1">context </span><span class="s3">= </span><span class="s2">this</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s0">// push cursor</span>
    <span class="s2">var </span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">allocateCursor</span><span class="s3">(</span><span class="s2">this</span><span class="s3">, </span><span class="s2">this</span><span class="s3">.</span><span class="s1">tail</span><span class="s3">, </span><span class="s2">null</span><span class="s3">);</span>

    <span class="s2">while </span><span class="s3">(</span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">prev </span><span class="s3">!== </span><span class="s2">null</span><span class="s3">) {</span>
        <span class="s1">item </span><span class="s3">= </span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">prev</span><span class="s3">;</span>
        <span class="s1">cursor</span><span class="s3">.</span><span class="s1">prev </span><span class="s3">= </span><span class="s1">item</span><span class="s3">.</span><span class="s1">prev</span><span class="s3">;</span>

        <span class="s1">fn</span><span class="s3">.</span><span class="s1">call</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">item</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">item</span><span class="s3">, </span><span class="s2">this</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s0">// pop cursor</span>
    <span class="s1">releaseCursor</span><span class="s3">(</span><span class="s2">this</span><span class="s3">);</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">forEachRight </span><span class="s3">= </span><span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">eachRight</span><span class="s3">;</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">reduce </span><span class="s3">= </span><span class="s2">function</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">, </span><span class="s1">initialValue</span><span class="s3">, </span><span class="s1">context</span><span class="s3">) {</span>
    <span class="s2">var </span><span class="s1">item</span><span class="s3">;</span>

    <span class="s2">if </span><span class="s3">(</span><span class="s1">context </span><span class="s3">=== </span><span class="s1">undefined</span><span class="s3">) {</span>
        <span class="s1">context </span><span class="s3">= </span><span class="s2">this</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s0">// push cursor</span>
    <span class="s2">var </span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">allocateCursor</span><span class="s3">(</span><span class="s2">this</span><span class="s3">, </span><span class="s2">null</span><span class="s3">, </span><span class="s2">this</span><span class="s3">.</span><span class="s1">head</span><span class="s3">);</span>
    <span class="s2">var </span><span class="s1">acc </span><span class="s3">= </span><span class="s1">initialValue</span><span class="s3">;</span>

    <span class="s2">while </span><span class="s3">(</span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">next </span><span class="s3">!== </span><span class="s2">null</span><span class="s3">) {</span>
        <span class="s1">item </span><span class="s3">= </span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">next</span><span class="s3">;</span>
        <span class="s1">cursor</span><span class="s3">.</span><span class="s1">next </span><span class="s3">= </span><span class="s1">item</span><span class="s3">.</span><span class="s1">next</span><span class="s3">;</span>

        <span class="s1">acc </span><span class="s3">= </span><span class="s1">fn</span><span class="s3">.</span><span class="s1">call</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">acc</span><span class="s3">, </span><span class="s1">item</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">item</span><span class="s3">, </span><span class="s2">this</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s0">// pop cursor</span>
    <span class="s1">releaseCursor</span><span class="s3">(</span><span class="s2">this</span><span class="s3">);</span>

    <span class="s2">return </span><span class="s1">acc</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">reduceRight </span><span class="s3">= </span><span class="s2">function</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">, </span><span class="s1">initialValue</span><span class="s3">, </span><span class="s1">context</span><span class="s3">) {</span>
    <span class="s2">var </span><span class="s1">item</span><span class="s3">;</span>

    <span class="s2">if </span><span class="s3">(</span><span class="s1">context </span><span class="s3">=== </span><span class="s1">undefined</span><span class="s3">) {</span>
        <span class="s1">context </span><span class="s3">= </span><span class="s2">this</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s0">// push cursor</span>
    <span class="s2">var </span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">allocateCursor</span><span class="s3">(</span><span class="s2">this</span><span class="s3">, </span><span class="s2">this</span><span class="s3">.</span><span class="s1">tail</span><span class="s3">, </span><span class="s2">null</span><span class="s3">);</span>
    <span class="s2">var </span><span class="s1">acc </span><span class="s3">= </span><span class="s1">initialValue</span><span class="s3">;</span>

    <span class="s2">while </span><span class="s3">(</span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">prev </span><span class="s3">!== </span><span class="s2">null</span><span class="s3">) {</span>
        <span class="s1">item </span><span class="s3">= </span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">prev</span><span class="s3">;</span>
        <span class="s1">cursor</span><span class="s3">.</span><span class="s1">prev </span><span class="s3">= </span><span class="s1">item</span><span class="s3">.</span><span class="s1">prev</span><span class="s3">;</span>

        <span class="s1">acc </span><span class="s3">= </span><span class="s1">fn</span><span class="s3">.</span><span class="s1">call</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">acc</span><span class="s3">, </span><span class="s1">item</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">item</span><span class="s3">, </span><span class="s2">this</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s0">// pop cursor</span>
    <span class="s1">releaseCursor</span><span class="s3">(</span><span class="s2">this</span><span class="s3">);</span>

    <span class="s2">return </span><span class="s1">acc</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">nextUntil </span><span class="s3">= </span><span class="s2">function</span><span class="s3">(</span><span class="s1">start</span><span class="s3">, </span><span class="s1">fn</span><span class="s3">, </span><span class="s1">context</span><span class="s3">) {</span>
    <span class="s2">if </span><span class="s3">(</span><span class="s1">start </span><span class="s3">=== </span><span class="s2">null</span><span class="s3">) {</span>
        <span class="s2">return</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s2">var </span><span class="s1">item</span><span class="s3">;</span>

    <span class="s2">if </span><span class="s3">(</span><span class="s1">context </span><span class="s3">=== </span><span class="s1">undefined</span><span class="s3">) {</span>
        <span class="s1">context </span><span class="s3">= </span><span class="s2">this</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s0">// push cursor</span>
    <span class="s2">var </span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">allocateCursor</span><span class="s3">(</span><span class="s2">this</span><span class="s3">, </span><span class="s2">null</span><span class="s3">, </span><span class="s1">start</span><span class="s3">);</span>

    <span class="s2">while </span><span class="s3">(</span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">next </span><span class="s3">!== </span><span class="s2">null</span><span class="s3">) {</span>
        <span class="s1">item </span><span class="s3">= </span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">next</span><span class="s3">;</span>
        <span class="s1">cursor</span><span class="s3">.</span><span class="s1">next </span><span class="s3">= </span><span class="s1">item</span><span class="s3">.</span><span class="s1">next</span><span class="s3">;</span>

        <span class="s2">if </span><span class="s3">(</span><span class="s1">fn</span><span class="s3">.</span><span class="s1">call</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">item</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">item</span><span class="s3">, </span><span class="s2">this</span><span class="s3">)) {</span>
            <span class="s2">break</span><span class="s3">;</span>
        <span class="s3">}</span>
    <span class="s3">}</span>

    <span class="s0">// pop cursor</span>
    <span class="s1">releaseCursor</span><span class="s3">(</span><span class="s2">this</span><span class="s3">);</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">prevUntil </span><span class="s3">= </span><span class="s2">function</span><span class="s3">(</span><span class="s1">start</span><span class="s3">, </span><span class="s1">fn</span><span class="s3">, </span><span class="s1">context</span><span class="s3">) {</span>
    <span class="s2">if </span><span class="s3">(</span><span class="s1">start </span><span class="s3">=== </span><span class="s2">null</span><span class="s3">) {</span>
        <span class="s2">return</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s2">var </span><span class="s1">item</span><span class="s3">;</span>

    <span class="s2">if </span><span class="s3">(</span><span class="s1">context </span><span class="s3">=== </span><span class="s1">undefined</span><span class="s3">) {</span>
        <span class="s1">context </span><span class="s3">= </span><span class="s2">this</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s0">// push cursor</span>
    <span class="s2">var </span><span class="s1">cursor </span><span class="s3">= </span><span class="s1">allocateCursor</span><span class="s3">(</span><span class="s2">this</span><span class="s3">, </span><span class="s1">start</span><span class="s3">, </span><span class="s2">null</span><span class="s3">);</span>

    <span class="s2">while </span><span class="s3">(</span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">prev </span><span class="s3">!== </span><span class="s2">null</span><span class="s3">) {</span>
        <span class="s1">item </span><span class="s3">= </span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">prev</span><span class="s3">;</span>
        <span class="s1">cursor</span><span class="s3">.</span><span class="s1">prev </span><span class="s3">= </span><span class="s1">item</span><span class="s3">.</span><span class="s1">prev</span><span class="s3">;</span>

        <span class="s2">if </span><span class="s3">(</span><span class="s1">fn</span><span class="s3">.</span><span class="s1">call</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">item</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">item</span><span class="s3">, </span><span class="s2">this</span><span class="s3">)) {</span>
            <span class="s2">break</span><span class="s3">;</span>
        <span class="s3">}</span>
    <span class="s3">}</span>

    <span class="s0">// pop cursor</span>
    <span class="s1">releaseCursor</span><span class="s3">(</span><span class="s2">this</span><span class="s3">);</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">some </span><span class="s3">= </span><span class="s2">function</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">, </span><span class="s1">context</span><span class="s3">) {</span>
    <span class="s2">var </span><span class="s1">cursor </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">head</span><span class="s3">;</span>

    <span class="s2">if </span><span class="s3">(</span><span class="s1">context </span><span class="s3">=== </span><span class="s1">undefined</span><span class="s3">) {</span>
        <span class="s1">context </span><span class="s3">= </span><span class="s2">this</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s2">while </span><span class="s3">(</span><span class="s1">cursor </span><span class="s3">!== </span><span class="s2">null</span><span class="s3">) {</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">fn</span><span class="s3">.</span><span class="s1">call</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">cursor</span><span class="s3">, </span><span class="s2">this</span><span class="s3">)) {</span>
            <span class="s2">return true</span><span class="s3">;</span>
        <span class="s3">}</span>

        <span class="s1">cursor </span><span class="s3">= </span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">next</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s2">return false</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">map </span><span class="s3">= </span><span class="s2">function</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">, </span><span class="s1">context</span><span class="s3">) {</span>
    <span class="s2">var </span><span class="s1">result </span><span class="s3">= </span><span class="s2">new </span><span class="s1">List</span><span class="s3">();</span>
    <span class="s2">var </span><span class="s1">cursor </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">head</span><span class="s3">;</span>

    <span class="s2">if </span><span class="s3">(</span><span class="s1">context </span><span class="s3">=== </span><span class="s1">undefined</span><span class="s3">) {</span>
        <span class="s1">context </span><span class="s3">= </span><span class="s2">this</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s2">while </span><span class="s3">(</span><span class="s1">cursor </span><span class="s3">!== </span><span class="s2">null</span><span class="s3">) {</span>
        <span class="s1">result</span><span class="s3">.</span><span class="s1">appendData</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">.</span><span class="s1">call</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">cursor</span><span class="s3">, </span><span class="s2">this</span><span class="s3">));</span>
        <span class="s1">cursor </span><span class="s3">= </span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">next</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s2">return </span><span class="s1">result</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">filter </span><span class="s3">= </span><span class="s2">function</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">, </span><span class="s1">context</span><span class="s3">) {</span>
    <span class="s2">var </span><span class="s1">result </span><span class="s3">= </span><span class="s2">new </span><span class="s1">List</span><span class="s3">();</span>
    <span class="s2">var </span><span class="s1">cursor </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">head</span><span class="s3">;</span>

    <span class="s2">if </span><span class="s3">(</span><span class="s1">context </span><span class="s3">=== </span><span class="s1">undefined</span><span class="s3">) {</span>
        <span class="s1">context </span><span class="s3">= </span><span class="s2">this</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s2">while </span><span class="s3">(</span><span class="s1">cursor </span><span class="s3">!== </span><span class="s2">null</span><span class="s3">) {</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">fn</span><span class="s3">.</span><span class="s1">call</span><span class="s3">(</span><span class="s1">context</span><span class="s3">, </span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">cursor</span><span class="s3">, </span><span class="s2">this</span><span class="s3">)) {</span>
            <span class="s1">result</span><span class="s3">.</span><span class="s1">appendData</span><span class="s3">(</span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">data</span><span class="s3">);</span>
        <span class="s3">}</span>
        <span class="s1">cursor </span><span class="s3">= </span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">next</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s2">return </span><span class="s1">result</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">clear </span><span class="s3">= </span><span class="s2">function</span><span class="s3">() {</span>
    <span class="s2">this</span><span class="s3">.</span><span class="s1">head </span><span class="s3">= </span><span class="s2">null</span><span class="s3">;</span>
    <span class="s2">this</span><span class="s3">.</span><span class="s1">tail </span><span class="s3">= </span><span class="s2">null</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">copy </span><span class="s3">= </span><span class="s2">function</span><span class="s3">() {</span>
    <span class="s2">var </span><span class="s1">result </span><span class="s3">= </span><span class="s2">new </span><span class="s1">List</span><span class="s3">();</span>
    <span class="s2">var </span><span class="s1">cursor </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">head</span><span class="s3">;</span>

    <span class="s2">while </span><span class="s3">(</span><span class="s1">cursor </span><span class="s3">!== </span><span class="s2">null</span><span class="s3">) {</span>
        <span class="s1">result</span><span class="s3">.</span><span class="s1">insert</span><span class="s3">(</span><span class="s1">createItem</span><span class="s3">(</span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">data</span><span class="s3">));</span>
        <span class="s1">cursor </span><span class="s3">= </span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">next</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s2">return </span><span class="s1">result</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">prepend </span><span class="s3">= </span><span class="s2">function</span><span class="s3">(</span><span class="s1">item</span><span class="s3">) {</span>
    <span class="s0">//      head</span>
    <span class="s0">//    ^</span>
    <span class="s0">// item</span>
    <span class="s2">this</span><span class="s3">.</span><span class="s1">updateCursors</span><span class="s3">(</span><span class="s2">null</span><span class="s3">, </span><span class="s1">item</span><span class="s3">, </span><span class="s2">this</span><span class="s3">.</span><span class="s1">head</span><span class="s3">, </span><span class="s1">item</span><span class="s3">);</span>

    <span class="s0">// insert to the beginning of the list</span>
    <span class="s2">if </span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">head </span><span class="s3">!== </span><span class="s2">null</span><span class="s3">) {</span>
        <span class="s0">// new item &lt;- first item</span>
        <span class="s2">this</span><span class="s3">.</span><span class="s1">head</span><span class="s3">.</span><span class="s1">prev </span><span class="s3">= </span><span class="s1">item</span><span class="s3">;</span>

        <span class="s0">// new item -&gt; first item</span>
        <span class="s1">item</span><span class="s3">.</span><span class="s1">next </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">head</span><span class="s3">;</span>
    <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
        <span class="s0">// if list has no head, then it also has no tail</span>
        <span class="s0">// in this case tail points to the new item</span>
        <span class="s2">this</span><span class="s3">.</span><span class="s1">tail </span><span class="s3">= </span><span class="s1">item</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s0">// head always points to new item</span>
    <span class="s2">this</span><span class="s3">.</span><span class="s1">head </span><span class="s3">= </span><span class="s1">item</span><span class="s3">;</span>

    <span class="s2">return this</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">prependData </span><span class="s3">= </span><span class="s2">function</span><span class="s3">(</span><span class="s1">data</span><span class="s3">) {</span>
    <span class="s2">return this</span><span class="s3">.</span><span class="s1">prepend</span><span class="s3">(</span><span class="s1">createItem</span><span class="s3">(</span><span class="s1">data</span><span class="s3">));</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">append </span><span class="s3">= </span><span class="s2">function</span><span class="s3">(</span><span class="s1">item</span><span class="s3">) {</span>
    <span class="s2">return this</span><span class="s3">.</span><span class="s1">insert</span><span class="s3">(</span><span class="s1">item</span><span class="s3">);</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">appendData </span><span class="s3">= </span><span class="s2">function</span><span class="s3">(</span><span class="s1">data</span><span class="s3">) {</span>
    <span class="s2">return this</span><span class="s3">.</span><span class="s1">insert</span><span class="s3">(</span><span class="s1">createItem</span><span class="s3">(</span><span class="s1">data</span><span class="s3">));</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">insert </span><span class="s3">= </span><span class="s2">function</span><span class="s3">(</span><span class="s1">item</span><span class="s3">, </span><span class="s1">before</span><span class="s3">) {</span>
    <span class="s2">if </span><span class="s3">(</span><span class="s1">before </span><span class="s3">!== </span><span class="s1">undefined </span><span class="s3">&amp;&amp; </span><span class="s1">before </span><span class="s3">!== </span><span class="s2">null</span><span class="s3">) {</span>
        <span class="s0">// prev   before</span>
        <span class="s0">//      ^</span>
        <span class="s0">//     item</span>
        <span class="s2">this</span><span class="s3">.</span><span class="s1">updateCursors</span><span class="s3">(</span><span class="s1">before</span><span class="s3">.</span><span class="s1">prev</span><span class="s3">, </span><span class="s1">item</span><span class="s3">, </span><span class="s1">before</span><span class="s3">, </span><span class="s1">item</span><span class="s3">);</span>

        <span class="s2">if </span><span class="s3">(</span><span class="s1">before</span><span class="s3">.</span><span class="s1">prev </span><span class="s3">=== </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s0">// insert to the beginning of list</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">head </span><span class="s3">!== </span><span class="s1">before</span><span class="s3">) {</span>
                <span class="s2">throw new </span><span class="s1">Error</span><span class="s3">(</span><span class="s5">'before doesn</span><span class="s2">\'</span><span class="s5">t belong to list'</span><span class="s3">);</span>
            <span class="s3">}</span>

            <span class="s0">// since head points to before therefore list doesn't empty</span>
            <span class="s0">// no need to check tail</span>
            <span class="s2">this</span><span class="s3">.</span><span class="s1">head </span><span class="s3">= </span><span class="s1">item</span><span class="s3">;</span>
            <span class="s1">before</span><span class="s3">.</span><span class="s1">prev </span><span class="s3">= </span><span class="s1">item</span><span class="s3">;</span>
            <span class="s1">item</span><span class="s3">.</span><span class="s1">next </span><span class="s3">= </span><span class="s1">before</span><span class="s3">;</span>

            <span class="s2">this</span><span class="s3">.</span><span class="s1">updateCursors</span><span class="s3">(</span><span class="s2">null</span><span class="s3">, </span><span class="s1">item</span><span class="s3">);</span>
        <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>

            <span class="s0">// insert between two items</span>
            <span class="s1">before</span><span class="s3">.</span><span class="s1">prev</span><span class="s3">.</span><span class="s1">next </span><span class="s3">= </span><span class="s1">item</span><span class="s3">;</span>
            <span class="s1">item</span><span class="s3">.</span><span class="s1">prev </span><span class="s3">= </span><span class="s1">before</span><span class="s3">.</span><span class="s1">prev</span><span class="s3">;</span>

            <span class="s1">before</span><span class="s3">.</span><span class="s1">prev </span><span class="s3">= </span><span class="s1">item</span><span class="s3">;</span>
            <span class="s1">item</span><span class="s3">.</span><span class="s1">next </span><span class="s3">= </span><span class="s1">before</span><span class="s3">;</span>
        <span class="s3">}</span>
    <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
        <span class="s0">// tail</span>
        <span class="s0">//      ^</span>
        <span class="s0">//      item</span>
        <span class="s2">this</span><span class="s3">.</span><span class="s1">updateCursors</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">tail</span><span class="s3">, </span><span class="s1">item</span><span class="s3">, </span><span class="s2">null</span><span class="s3">, </span><span class="s1">item</span><span class="s3">);</span>

        <span class="s0">// insert to the ending of the list</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">tail </span><span class="s3">!== </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s0">// last item -&gt; new item</span>
            <span class="s2">this</span><span class="s3">.</span><span class="s1">tail</span><span class="s3">.</span><span class="s1">next </span><span class="s3">= </span><span class="s1">item</span><span class="s3">;</span>

            <span class="s0">// last item &lt;- new item</span>
            <span class="s1">item</span><span class="s3">.</span><span class="s1">prev </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">tail</span><span class="s3">;</span>
        <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
            <span class="s0">// if list has no tail, then it also has no head</span>
            <span class="s0">// in this case head points to new item</span>
            <span class="s2">this</span><span class="s3">.</span><span class="s1">head </span><span class="s3">= </span><span class="s1">item</span><span class="s3">;</span>
        <span class="s3">}</span>

        <span class="s0">// tail always points to new item</span>
        <span class="s2">this</span><span class="s3">.</span><span class="s1">tail </span><span class="s3">= </span><span class="s1">item</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s2">return this</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">insertData </span><span class="s3">= </span><span class="s2">function</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">before</span><span class="s3">) {</span>
    <span class="s2">return this</span><span class="s3">.</span><span class="s1">insert</span><span class="s3">(</span><span class="s1">createItem</span><span class="s3">(</span><span class="s1">data</span><span class="s3">), </span><span class="s1">before</span><span class="s3">);</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">remove </span><span class="s3">= </span><span class="s2">function</span><span class="s3">(</span><span class="s1">item</span><span class="s3">) {</span>
    <span class="s0">//      item</span>
    <span class="s0">//       ^</span>
    <span class="s0">// prev     next</span>
    <span class="s2">this</span><span class="s3">.</span><span class="s1">updateCursors</span><span class="s3">(</span><span class="s1">item</span><span class="s3">, </span><span class="s1">item</span><span class="s3">.</span><span class="s1">prev</span><span class="s3">, </span><span class="s1">item</span><span class="s3">, </span><span class="s1">item</span><span class="s3">.</span><span class="s1">next</span><span class="s3">);</span>

    <span class="s2">if </span><span class="s3">(</span><span class="s1">item</span><span class="s3">.</span><span class="s1">prev </span><span class="s3">!== </span><span class="s2">null</span><span class="s3">) {</span>
        <span class="s1">item</span><span class="s3">.</span><span class="s1">prev</span><span class="s3">.</span><span class="s1">next </span><span class="s3">= </span><span class="s1">item</span><span class="s3">.</span><span class="s1">next</span><span class="s3">;</span>
    <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">head </span><span class="s3">!== </span><span class="s1">item</span><span class="s3">) {</span>
            <span class="s2">throw new </span><span class="s1">Error</span><span class="s3">(</span><span class="s5">'item doesn</span><span class="s2">\'</span><span class="s5">t belong to list'</span><span class="s3">);</span>
        <span class="s3">}</span>

        <span class="s2">this</span><span class="s3">.</span><span class="s1">head </span><span class="s3">= </span><span class="s1">item</span><span class="s3">.</span><span class="s1">next</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s2">if </span><span class="s3">(</span><span class="s1">item</span><span class="s3">.</span><span class="s1">next </span><span class="s3">!== </span><span class="s2">null</span><span class="s3">) {</span>
        <span class="s1">item</span><span class="s3">.</span><span class="s1">next</span><span class="s3">.</span><span class="s1">prev </span><span class="s3">= </span><span class="s1">item</span><span class="s3">.</span><span class="s1">prev</span><span class="s3">;</span>
    <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">tail </span><span class="s3">!== </span><span class="s1">item</span><span class="s3">) {</span>
            <span class="s2">throw new </span><span class="s1">Error</span><span class="s3">(</span><span class="s5">'item doesn</span><span class="s2">\'</span><span class="s5">t belong to list'</span><span class="s3">);</span>
        <span class="s3">}</span>

        <span class="s2">this</span><span class="s3">.</span><span class="s1">tail </span><span class="s3">= </span><span class="s1">item</span><span class="s3">.</span><span class="s1">prev</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s1">item</span><span class="s3">.</span><span class="s1">prev </span><span class="s3">= </span><span class="s2">null</span><span class="s3">;</span>
    <span class="s1">item</span><span class="s3">.</span><span class="s1">next </span><span class="s3">= </span><span class="s2">null</span><span class="s3">;</span>

    <span class="s2">return </span><span class="s1">item</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">push </span><span class="s3">= </span><span class="s2">function</span><span class="s3">(</span><span class="s1">data</span><span class="s3">) {</span>
    <span class="s2">this</span><span class="s3">.</span><span class="s1">insert</span><span class="s3">(</span><span class="s1">createItem</span><span class="s3">(</span><span class="s1">data</span><span class="s3">));</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">pop </span><span class="s3">= </span><span class="s2">function</span><span class="s3">() {</span>
    <span class="s2">if </span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">tail </span><span class="s3">!== </span><span class="s2">null</span><span class="s3">) {</span>
        <span class="s2">return this</span><span class="s3">.</span><span class="s1">remove</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">tail</span><span class="s3">);</span>
    <span class="s3">}</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">unshift </span><span class="s3">= </span><span class="s2">function</span><span class="s3">(</span><span class="s1">data</span><span class="s3">) {</span>
    <span class="s2">this</span><span class="s3">.</span><span class="s1">prepend</span><span class="s3">(</span><span class="s1">createItem</span><span class="s3">(</span><span class="s1">data</span><span class="s3">));</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">shift </span><span class="s3">= </span><span class="s2">function</span><span class="s3">() {</span>
    <span class="s2">if </span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">head </span><span class="s3">!== </span><span class="s2">null</span><span class="s3">) {</span>
        <span class="s2">return this</span><span class="s3">.</span><span class="s1">remove</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">head</span><span class="s3">);</span>
    <span class="s3">}</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">prependList </span><span class="s3">= </span><span class="s2">function</span><span class="s3">(</span><span class="s1">list</span><span class="s3">) {</span>
    <span class="s2">return this</span><span class="s3">.</span><span class="s1">insertList</span><span class="s3">(</span><span class="s1">list</span><span class="s3">, </span><span class="s2">this</span><span class="s3">.</span><span class="s1">head</span><span class="s3">);</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">appendList </span><span class="s3">= </span><span class="s2">function</span><span class="s3">(</span><span class="s1">list</span><span class="s3">) {</span>
    <span class="s2">return this</span><span class="s3">.</span><span class="s1">insertList</span><span class="s3">(</span><span class="s1">list</span><span class="s3">);</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">insertList </span><span class="s3">= </span><span class="s2">function</span><span class="s3">(</span><span class="s1">list</span><span class="s3">, </span><span class="s1">before</span><span class="s3">) {</span>
    <span class="s0">// ignore empty lists</span>
    <span class="s2">if </span><span class="s3">(</span><span class="s1">list</span><span class="s3">.</span><span class="s1">head </span><span class="s3">=== </span><span class="s2">null</span><span class="s3">) {</span>
        <span class="s2">return this</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s2">if </span><span class="s3">(</span><span class="s1">before </span><span class="s3">!== </span><span class="s1">undefined </span><span class="s3">&amp;&amp; </span><span class="s1">before </span><span class="s3">!== </span><span class="s2">null</span><span class="s3">) {</span>
        <span class="s2">this</span><span class="s3">.</span><span class="s1">updateCursors</span><span class="s3">(</span><span class="s1">before</span><span class="s3">.</span><span class="s1">prev</span><span class="s3">, </span><span class="s1">list</span><span class="s3">.</span><span class="s1">tail</span><span class="s3">, </span><span class="s1">before</span><span class="s3">, </span><span class="s1">list</span><span class="s3">.</span><span class="s1">head</span><span class="s3">);</span>

        <span class="s0">// insert in the middle of dist list</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">before</span><span class="s3">.</span><span class="s1">prev </span><span class="s3">!== </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s0">// before.prev &lt;-&gt; list.head</span>
            <span class="s1">before</span><span class="s3">.</span><span class="s1">prev</span><span class="s3">.</span><span class="s1">next </span><span class="s3">= </span><span class="s1">list</span><span class="s3">.</span><span class="s1">head</span><span class="s3">;</span>
            <span class="s1">list</span><span class="s3">.</span><span class="s1">head</span><span class="s3">.</span><span class="s1">prev </span><span class="s3">= </span><span class="s1">before</span><span class="s3">.</span><span class="s1">prev</span><span class="s3">;</span>
        <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
            <span class="s2">this</span><span class="s3">.</span><span class="s1">head </span><span class="s3">= </span><span class="s1">list</span><span class="s3">.</span><span class="s1">head</span><span class="s3">;</span>
        <span class="s3">}</span>

        <span class="s1">before</span><span class="s3">.</span><span class="s1">prev </span><span class="s3">= </span><span class="s1">list</span><span class="s3">.</span><span class="s1">tail</span><span class="s3">;</span>
        <span class="s1">list</span><span class="s3">.</span><span class="s1">tail</span><span class="s3">.</span><span class="s1">next </span><span class="s3">= </span><span class="s1">before</span><span class="s3">;</span>
    <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
        <span class="s2">this</span><span class="s3">.</span><span class="s1">updateCursors</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">tail</span><span class="s3">, </span><span class="s1">list</span><span class="s3">.</span><span class="s1">tail</span><span class="s3">, </span><span class="s2">null</span><span class="s3">, </span><span class="s1">list</span><span class="s3">.</span><span class="s1">head</span><span class="s3">);</span>

        <span class="s0">// insert to end of the list</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">tail </span><span class="s3">!== </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s0">// if destination list has a tail, then it also has a head,</span>
            <span class="s0">// but head doesn't change</span>

            <span class="s0">// dest tail -&gt; source head</span>
            <span class="s2">this</span><span class="s3">.</span><span class="s1">tail</span><span class="s3">.</span><span class="s1">next </span><span class="s3">= </span><span class="s1">list</span><span class="s3">.</span><span class="s1">head</span><span class="s3">;</span>

            <span class="s0">// dest tail &lt;- source head</span>
            <span class="s1">list</span><span class="s3">.</span><span class="s1">head</span><span class="s3">.</span><span class="s1">prev </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">tail</span><span class="s3">;</span>
        <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
            <span class="s0">// if list has no a tail, then it also has no a head</span>
            <span class="s0">// in this case points head to new item</span>
            <span class="s2">this</span><span class="s3">.</span><span class="s1">head </span><span class="s3">= </span><span class="s1">list</span><span class="s3">.</span><span class="s1">head</span><span class="s3">;</span>
        <span class="s3">}</span>

        <span class="s0">// tail always start point to new item</span>
        <span class="s2">this</span><span class="s3">.</span><span class="s1">tail </span><span class="s3">= </span><span class="s1">list</span><span class="s3">.</span><span class="s1">tail</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s1">list</span><span class="s3">.</span><span class="s1">head </span><span class="s3">= </span><span class="s2">null</span><span class="s3">;</span>
    <span class="s1">list</span><span class="s3">.</span><span class="s1">tail </span><span class="s3">= </span><span class="s2">null</span><span class="s3">;</span>

    <span class="s2">return this</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s1">List</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">replace </span><span class="s3">= </span><span class="s2">function</span><span class="s3">(</span><span class="s1">oldItem</span><span class="s3">, </span><span class="s1">newItemOrList</span><span class="s3">) {</span>
    <span class="s2">if </span><span class="s3">(</span><span class="s5">'head' </span><span class="s2">in </span><span class="s1">newItemOrList</span><span class="s3">) {</span>
        <span class="s2">this</span><span class="s3">.</span><span class="s1">insertList</span><span class="s3">(</span><span class="s1">newItemOrList</span><span class="s3">, </span><span class="s1">oldItem</span><span class="s3">);</span>
    <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
        <span class="s2">this</span><span class="s3">.</span><span class="s1">insert</span><span class="s3">(</span><span class="s1">newItemOrList</span><span class="s3">, </span><span class="s1">oldItem</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s2">this</span><span class="s3">.</span><span class="s1">remove</span><span class="s3">(</span><span class="s1">oldItem</span><span class="s3">);</span>
<span class="s3">};</span>

<span class="s1">module</span><span class="s3">.</span><span class="s1">exports </span><span class="s3">= </span><span class="s1">List</span><span class="s3">;</span>
</pre>
</body>
</html>