<html>
<head>
<title>websocket.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #6aab73;}
.s3 { color: #bcbec4;}
.s4 { color: #cf8e6d;}
.s5 { color: #2aacb8;}
.s6 { color: #42c3d4;}
.s7 { color: #5f826b; font-style: italic;}
.s8 { color: #67a37c; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
websocket.js</font>
</center></td></tr></table>
<pre><span class="s0">/* eslint no-unused-vars: [&quot;error&quot;, { &quot;varsIgnorePattern&quot;: &quot;^Duplex|Readable$&quot; }] */</span>

<span class="s2">'use strict'</span><span class="s3">;</span>

<span class="s4">const </span><span class="s1">EventEmitter </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'events'</span><span class="s3">);</span>
<span class="s4">const </span><span class="s1">https </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'https'</span><span class="s3">);</span>
<span class="s4">const </span><span class="s1">http </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'http'</span><span class="s3">);</span>
<span class="s4">const </span><span class="s1">net </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'net'</span><span class="s3">);</span>
<span class="s4">const </span><span class="s1">tls </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'tls'</span><span class="s3">);</span>
<span class="s4">const </span><span class="s3">{ </span><span class="s1">randomBytes</span><span class="s3">, </span><span class="s1">createHash </span><span class="s3">} = </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'crypto'</span><span class="s3">);</span>
<span class="s4">const </span><span class="s3">{ </span><span class="s1">Duplex</span><span class="s3">, </span><span class="s1">Readable </span><span class="s3">} = </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'stream'</span><span class="s3">);</span>
<span class="s4">const </span><span class="s3">{ </span><span class="s1">URL </span><span class="s3">} = </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'url'</span><span class="s3">);</span>

<span class="s4">const </span><span class="s1">PerMessageDeflate </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'./permessage-deflate'</span><span class="s3">);</span>
<span class="s4">const </span><span class="s1">Receiver </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'./receiver'</span><span class="s3">);</span>
<span class="s4">const </span><span class="s1">Sender </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'./sender'</span><span class="s3">);</span>
<span class="s4">const </span><span class="s3">{</span>
  <span class="s1">BINARY_TYPES</span><span class="s3">,</span>
  <span class="s1">EMPTY_BUFFER</span><span class="s3">,</span>
  <span class="s1">GUID</span><span class="s3">,</span>
  <span class="s1">kForOnEventAttribute</span><span class="s3">,</span>
  <span class="s1">kListener</span><span class="s3">,</span>
  <span class="s1">kStatusCode</span><span class="s3">,</span>
  <span class="s1">kWebSocket</span><span class="s3">,</span>
  <span class="s1">NOOP</span>
<span class="s3">} = </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'./constants'</span><span class="s3">);</span>
<span class="s4">const </span><span class="s3">{</span>
  <span class="s1">EventTarget</span><span class="s3">: { </span><span class="s1">addEventListener</span><span class="s3">, </span><span class="s1">removeEventListener </span><span class="s3">}</span>
<span class="s3">} = </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'./event-target'</span><span class="s3">);</span>
<span class="s4">const </span><span class="s3">{ </span><span class="s1">format</span><span class="s3">, </span><span class="s1">parse </span><span class="s3">} = </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'./extension'</span><span class="s3">);</span>
<span class="s4">const </span><span class="s3">{ </span><span class="s1">toBuffer </span><span class="s3">} = </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'./buffer-util'</span><span class="s3">);</span>

<span class="s4">const </span><span class="s1">closeTimeout </span><span class="s3">= </span><span class="s5">30 </span><span class="s3">* </span><span class="s5">1000</span><span class="s3">;</span>
<span class="s4">const </span><span class="s1">kAborted </span><span class="s3">= </span><span class="s1">Symbol</span><span class="s3">(</span><span class="s2">'kAborted'</span><span class="s3">);</span>
<span class="s4">const </span><span class="s1">protocolVersions </span><span class="s3">= [</span><span class="s5">8</span><span class="s3">, </span><span class="s5">13</span><span class="s3">];</span>
<span class="s4">const </span><span class="s1">readyStates </span><span class="s3">= [</span><span class="s2">'CONNECTING'</span><span class="s3">, </span><span class="s2">'OPEN'</span><span class="s3">, </span><span class="s2">'CLOSING'</span><span class="s3">, </span><span class="s2">'CLOSED'</span><span class="s3">];</span>
<span class="s4">const </span><span class="s1">subprotocolRegex </span><span class="s3">= </span><span class="s6">/^[!#$%&amp;'*+\-.0-9A-Z^_`|a-z~]+$/</span><span class="s3">;</span>

<span class="s7">/**</span>
 <span class="s7">* Class representing a WebSocket.</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@extends </span><span class="s7">EventEmitter</span>
 <span class="s7">*/</span>
<span class="s4">class </span><span class="s1">WebSocket </span><span class="s4">extends </span><span class="s1">EventEmitter </span><span class="s3">{</span>
  <span class="s7">/**</span>
   <span class="s7">* Create a new `WebSocket`.</span>
   <span class="s7">*</span>
   <span class="s7">* </span><span class="s8">@param </span><span class="s7">{(String|URL)} address The URL to which to connect</span>
   <span class="s7">* </span><span class="s8">@param </span><span class="s7">{(String|String[])} [protocols] The subprotocols</span>
   <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Object} [options] Connection options</span>
   <span class="s7">*/</span>
  <span class="s1">constructor</span><span class="s3">(</span><span class="s1">address</span><span class="s3">, </span><span class="s1">protocols</span><span class="s3">, </span><span class="s1">options</span><span class="s3">) {</span>
    <span class="s4">super</span><span class="s3">();</span>

    <span class="s4">this</span><span class="s3">.</span><span class="s1">_binaryType </span><span class="s3">= </span><span class="s1">BINARY_TYPES</span><span class="s3">[</span><span class="s5">0</span><span class="s3">];</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">_closeCode </span><span class="s3">= </span><span class="s5">1006</span><span class="s3">;</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">_closeFrameReceived </span><span class="s3">= </span><span class="s4">false</span><span class="s3">;</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">_closeFrameSent </span><span class="s3">= </span><span class="s4">false</span><span class="s3">;</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">_closeMessage </span><span class="s3">= </span><span class="s1">EMPTY_BUFFER</span><span class="s3">;</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">_closeTimer </span><span class="s3">= </span><span class="s4">null</span><span class="s3">;</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">_extensions </span><span class="s3">= {};</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">_paused </span><span class="s3">= </span><span class="s4">false</span><span class="s3">;</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">_protocol </span><span class="s3">= </span><span class="s2">''</span><span class="s3">;</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">_readyState </span><span class="s3">= </span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">CONNECTING</span><span class="s3">;</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">_receiver </span><span class="s3">= </span><span class="s4">null</span><span class="s3">;</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">_sender </span><span class="s3">= </span><span class="s4">null</span><span class="s3">;</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">_socket </span><span class="s3">= </span><span class="s4">null</span><span class="s3">;</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s1">address </span><span class="s3">!== </span><span class="s4">null</span><span class="s3">) {</span>
      <span class="s4">this</span><span class="s3">.</span><span class="s1">_bufferedAmount </span><span class="s3">= </span><span class="s5">0</span><span class="s3">;</span>
      <span class="s4">this</span><span class="s3">.</span><span class="s1">_isServer </span><span class="s3">= </span><span class="s4">false</span><span class="s3">;</span>
      <span class="s4">this</span><span class="s3">.</span><span class="s1">_redirects </span><span class="s3">= </span><span class="s5">0</span><span class="s3">;</span>

      <span class="s4">if </span><span class="s3">(</span><span class="s1">protocols </span><span class="s3">=== </span><span class="s1">undefined</span><span class="s3">) {</span>
        <span class="s1">protocols </span><span class="s3">= [];</span>
      <span class="s3">} </span><span class="s4">else if </span><span class="s3">(!</span><span class="s1">Array</span><span class="s3">.</span><span class="s1">isArray</span><span class="s3">(</span><span class="s1">protocols</span><span class="s3">)) {</span>
        <span class="s4">if </span><span class="s3">(</span><span class="s4">typeof </span><span class="s1">protocols </span><span class="s3">=== </span><span class="s2">'object' </span><span class="s3">&amp;&amp; </span><span class="s1">protocols </span><span class="s3">!== </span><span class="s4">null</span><span class="s3">) {</span>
          <span class="s1">options </span><span class="s3">= </span><span class="s1">protocols</span><span class="s3">;</span>
          <span class="s1">protocols </span><span class="s3">= [];</span>
        <span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
          <span class="s1">protocols </span><span class="s3">= [</span><span class="s1">protocols</span><span class="s3">];</span>
        <span class="s3">}</span>
      <span class="s3">}</span>

      <span class="s1">initAsClient</span><span class="s3">(</span><span class="s4">this</span><span class="s3">, </span><span class="s1">address</span><span class="s3">, </span><span class="s1">protocols</span><span class="s3">, </span><span class="s1">options</span><span class="s3">);</span>
    <span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
      <span class="s4">this</span><span class="s3">.</span><span class="s1">_isServer </span><span class="s3">= </span><span class="s4">true</span><span class="s3">;</span>
    <span class="s3">}</span>
  <span class="s3">}</span>

  <span class="s7">/**</span>
   <span class="s7">* This deviates from the WHATWG interface since ws doesn't support the</span>
   <span class="s7">* required default &quot;blob&quot; type (instead we define a custom &quot;nodebuffer&quot;</span>
   <span class="s7">* type).</span>
   <span class="s7">*</span>
   <span class="s7">* </span><span class="s8">@type </span><span class="s7">{String}</span>
   <span class="s7">*/</span>
  <span class="s1">get binaryType</span><span class="s3">() {</span>
    <span class="s4">return this</span><span class="s3">.</span><span class="s1">_binaryType</span><span class="s3">;</span>
  <span class="s3">}</span>

  <span class="s1">set binaryType</span><span class="s3">(</span><span class="s1">type</span><span class="s3">) {</span>
    <span class="s4">if </span><span class="s3">(!</span><span class="s1">BINARY_TYPES</span><span class="s3">.</span><span class="s1">includes</span><span class="s3">(</span><span class="s1">type</span><span class="s3">)) </span><span class="s4">return</span><span class="s3">;</span>

    <span class="s4">this</span><span class="s3">.</span><span class="s1">_binaryType </span><span class="s3">= </span><span class="s1">type</span><span class="s3">;</span>

    <span class="s0">//</span>
    <span class="s0">// Allow to change `binaryType` on the fly.</span>
    <span class="s0">//</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">_receiver</span><span class="s3">) </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_receiver</span><span class="s3">.</span><span class="s1">_binaryType </span><span class="s3">= </span><span class="s1">type</span><span class="s3">;</span>
  <span class="s3">}</span>

  <span class="s7">/**</span>
   <span class="s7">* </span><span class="s8">@type </span><span class="s7">{Number}</span>
   <span class="s7">*/</span>
  <span class="s1">get bufferedAmount</span><span class="s3">() {</span>
    <span class="s4">if </span><span class="s3">(!</span><span class="s4">this</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">) </span><span class="s4">return this</span><span class="s3">.</span><span class="s1">_bufferedAmount</span><span class="s3">;</span>

    <span class="s4">return this</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">_writableState</span><span class="s3">.</span><span class="s1">length </span><span class="s3">+ </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_sender</span><span class="s3">.</span><span class="s1">_bufferedBytes</span><span class="s3">;</span>
  <span class="s3">}</span>

  <span class="s7">/**</span>
   <span class="s7">* </span><span class="s8">@type </span><span class="s7">{String}</span>
   <span class="s7">*/</span>
  <span class="s1">get extensions</span><span class="s3">() {</span>
    <span class="s4">return </span><span class="s1">Object</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">_extensions</span><span class="s3">).</span><span class="s1">join</span><span class="s3">();</span>
  <span class="s3">}</span>

  <span class="s7">/**</span>
   <span class="s7">* </span><span class="s8">@type </span><span class="s7">{Boolean}</span>
   <span class="s7">*/</span>
  <span class="s1">get isPaused</span><span class="s3">() {</span>
    <span class="s4">return this</span><span class="s3">.</span><span class="s1">_paused</span><span class="s3">;</span>
  <span class="s3">}</span>

  <span class="s7">/**</span>
   <span class="s7">* </span><span class="s8">@type </span><span class="s7">{Function}</span>
   <span class="s7">*/</span>
  <span class="s0">/* istanbul ignore next */</span>
  <span class="s1">get onclose</span><span class="s3">() {</span>
    <span class="s4">return null</span><span class="s3">;</span>
  <span class="s3">}</span>

  <span class="s7">/**</span>
   <span class="s7">* </span><span class="s8">@type </span><span class="s7">{Function}</span>
   <span class="s7">*/</span>
  <span class="s0">/* istanbul ignore next */</span>
  <span class="s1">get onerror</span><span class="s3">() {</span>
    <span class="s4">return null</span><span class="s3">;</span>
  <span class="s3">}</span>

  <span class="s7">/**</span>
   <span class="s7">* </span><span class="s8">@type </span><span class="s7">{Function}</span>
   <span class="s7">*/</span>
  <span class="s0">/* istanbul ignore next */</span>
  <span class="s1">get onopen</span><span class="s3">() {</span>
    <span class="s4">return null</span><span class="s3">;</span>
  <span class="s3">}</span>

  <span class="s7">/**</span>
   <span class="s7">* </span><span class="s8">@type </span><span class="s7">{Function}</span>
   <span class="s7">*/</span>
  <span class="s0">/* istanbul ignore next */</span>
  <span class="s1">get onmessage</span><span class="s3">() {</span>
    <span class="s4">return null</span><span class="s3">;</span>
  <span class="s3">}</span>

  <span class="s7">/**</span>
   <span class="s7">* </span><span class="s8">@type </span><span class="s7">{String}</span>
   <span class="s7">*/</span>
  <span class="s1">get protocol</span><span class="s3">() {</span>
    <span class="s4">return this</span><span class="s3">.</span><span class="s1">_protocol</span><span class="s3">;</span>
  <span class="s3">}</span>

  <span class="s7">/**</span>
   <span class="s7">* </span><span class="s8">@type </span><span class="s7">{Number}</span>
   <span class="s7">*/</span>
  <span class="s1">get readyState</span><span class="s3">() {</span>
    <span class="s4">return this</span><span class="s3">.</span><span class="s1">_readyState</span><span class="s3">;</span>
  <span class="s3">}</span>

  <span class="s7">/**</span>
   <span class="s7">* </span><span class="s8">@type </span><span class="s7">{String}</span>
   <span class="s7">*/</span>
  <span class="s1">get url</span><span class="s3">() {</span>
    <span class="s4">return this</span><span class="s3">.</span><span class="s1">_url</span><span class="s3">;</span>
  <span class="s3">}</span>

  <span class="s7">/**</span>
   <span class="s7">* Set up the socket and the internal resources.</span>
   <span class="s7">*</span>
   <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Duplex} socket The network socket between the server and client</span>
   <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Buffer} head The first packet of the upgraded stream</span>
   <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Object} options Options object</span>
   <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Function} [options.generateMask] The function used to generate the</span>
   <span class="s7">*     masking key</span>
   <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Number} [options.maxPayload=0] The maximum allowed message size</span>
   <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Boolean} [options.skipUTF8Validation=false] Specifies whether or</span>
   <span class="s7">*     not to skip UTF-8 validation for text and close messages</span>
   <span class="s7">* </span><span class="s8">@private</span>
   <span class="s7">*/</span>
  <span class="s1">setSocket</span><span class="s3">(</span><span class="s1">socket</span><span class="s3">, </span><span class="s1">head</span><span class="s3">, </span><span class="s1">options</span><span class="s3">) {</span>
    <span class="s4">const </span><span class="s1">receiver </span><span class="s3">= </span><span class="s4">new </span><span class="s1">Receiver</span><span class="s3">({</span>
      <span class="s1">binaryType</span><span class="s3">: </span><span class="s4">this</span><span class="s3">.</span><span class="s1">binaryType</span><span class="s3">,</span>
      <span class="s1">extensions</span><span class="s3">: </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_extensions</span><span class="s3">,</span>
      <span class="s1">isServer</span><span class="s3">: </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_isServer</span><span class="s3">,</span>
      <span class="s1">maxPayload</span><span class="s3">: </span><span class="s1">options</span><span class="s3">.</span><span class="s1">maxPayload</span><span class="s3">,</span>
      <span class="s1">skipUTF8Validation</span><span class="s3">: </span><span class="s1">options</span><span class="s3">.</span><span class="s1">skipUTF8Validation</span>
    <span class="s3">});</span>

    <span class="s4">this</span><span class="s3">.</span><span class="s1">_sender </span><span class="s3">= </span><span class="s4">new </span><span class="s1">Sender</span><span class="s3">(</span><span class="s1">socket</span><span class="s3">, </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_extensions</span><span class="s3">, </span><span class="s1">options</span><span class="s3">.</span><span class="s1">generateMask</span><span class="s3">);</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">_receiver </span><span class="s3">= </span><span class="s1">receiver</span><span class="s3">;</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">_socket </span><span class="s3">= </span><span class="s1">socket</span><span class="s3">;</span>

    <span class="s1">receiver</span><span class="s3">[</span><span class="s1">kWebSocket</span><span class="s3">] = </span><span class="s4">this</span><span class="s3">;</span>
    <span class="s1">socket</span><span class="s3">[</span><span class="s1">kWebSocket</span><span class="s3">] = </span><span class="s4">this</span><span class="s3">;</span>

    <span class="s1">receiver</span><span class="s3">.</span><span class="s1">on</span><span class="s3">(</span><span class="s2">'conclude'</span><span class="s3">, </span><span class="s1">receiverOnConclude</span><span class="s3">);</span>
    <span class="s1">receiver</span><span class="s3">.</span><span class="s1">on</span><span class="s3">(</span><span class="s2">'drain'</span><span class="s3">, </span><span class="s1">receiverOnDrain</span><span class="s3">);</span>
    <span class="s1">receiver</span><span class="s3">.</span><span class="s1">on</span><span class="s3">(</span><span class="s2">'error'</span><span class="s3">, </span><span class="s1">receiverOnError</span><span class="s3">);</span>
    <span class="s1">receiver</span><span class="s3">.</span><span class="s1">on</span><span class="s3">(</span><span class="s2">'message'</span><span class="s3">, </span><span class="s1">receiverOnMessage</span><span class="s3">);</span>
    <span class="s1">receiver</span><span class="s3">.</span><span class="s1">on</span><span class="s3">(</span><span class="s2">'ping'</span><span class="s3">, </span><span class="s1">receiverOnPing</span><span class="s3">);</span>
    <span class="s1">receiver</span><span class="s3">.</span><span class="s1">on</span><span class="s3">(</span><span class="s2">'pong'</span><span class="s3">, </span><span class="s1">receiverOnPong</span><span class="s3">);</span>

    <span class="s0">//</span>
    <span class="s0">// These methods may not be available if `socket` is just a `Duplex`.</span>
    <span class="s0">//</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s1">socket</span><span class="s3">.</span><span class="s1">setTimeout</span><span class="s3">) </span><span class="s1">socket</span><span class="s3">.</span><span class="s1">setTimeout</span><span class="s3">(</span><span class="s5">0</span><span class="s3">);</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s1">socket</span><span class="s3">.</span><span class="s1">setNoDelay</span><span class="s3">) </span><span class="s1">socket</span><span class="s3">.</span><span class="s1">setNoDelay</span><span class="s3">();</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s1">head</span><span class="s3">.</span><span class="s1">length </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">) </span><span class="s1">socket</span><span class="s3">.</span><span class="s1">unshift</span><span class="s3">(</span><span class="s1">head</span><span class="s3">);</span>

    <span class="s1">socket</span><span class="s3">.</span><span class="s1">on</span><span class="s3">(</span><span class="s2">'close'</span><span class="s3">, </span><span class="s1">socketOnClose</span><span class="s3">);</span>
    <span class="s1">socket</span><span class="s3">.</span><span class="s1">on</span><span class="s3">(</span><span class="s2">'data'</span><span class="s3">, </span><span class="s1">socketOnData</span><span class="s3">);</span>
    <span class="s1">socket</span><span class="s3">.</span><span class="s1">on</span><span class="s3">(</span><span class="s2">'end'</span><span class="s3">, </span><span class="s1">socketOnEnd</span><span class="s3">);</span>
    <span class="s1">socket</span><span class="s3">.</span><span class="s1">on</span><span class="s3">(</span><span class="s2">'error'</span><span class="s3">, </span><span class="s1">socketOnError</span><span class="s3">);</span>

    <span class="s4">this</span><span class="s3">.</span><span class="s1">_readyState </span><span class="s3">= </span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">OPEN</span><span class="s3">;</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s2">'open'</span><span class="s3">);</span>
  <span class="s3">}</span>

  <span class="s7">/**</span>
   <span class="s7">* Emit the `'close'` event.</span>
   <span class="s7">*</span>
   <span class="s7">* </span><span class="s8">@private</span>
   <span class="s7">*/</span>
  <span class="s1">emitClose</span><span class="s3">() {</span>
    <span class="s4">if </span><span class="s3">(!</span><span class="s4">this</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">) {</span>
      <span class="s4">this</span><span class="s3">.</span><span class="s1">_readyState </span><span class="s3">= </span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">CLOSED</span><span class="s3">;</span>
      <span class="s4">this</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s2">'close'</span><span class="s3">, </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_closeCode</span><span class="s3">, </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_closeMessage</span><span class="s3">);</span>
      <span class="s4">return</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">_extensions</span><span class="s3">[</span><span class="s1">PerMessageDeflate</span><span class="s3">.</span><span class="s1">extensionName</span><span class="s3">]) {</span>
      <span class="s4">this</span><span class="s3">.</span><span class="s1">_extensions</span><span class="s3">[</span><span class="s1">PerMessageDeflate</span><span class="s3">.</span><span class="s1">extensionName</span><span class="s3">].</span><span class="s1">cleanup</span><span class="s3">();</span>
    <span class="s3">}</span>

    <span class="s4">this</span><span class="s3">.</span><span class="s1">_receiver</span><span class="s3">.</span><span class="s1">removeAllListeners</span><span class="s3">();</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">_readyState </span><span class="s3">= </span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">CLOSED</span><span class="s3">;</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s2">'close'</span><span class="s3">, </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_closeCode</span><span class="s3">, </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_closeMessage</span><span class="s3">);</span>
  <span class="s3">}</span>

  <span class="s7">/**</span>
   <span class="s7">* Start a closing handshake.</span>
   <span class="s7">*</span>
   <span class="s7">*          +----------+   +-----------+   +----------+</span>
   <span class="s7">*     - - -|ws.close()|--&gt;|close frame|--&gt;|ws.close()|- - -</span>
   <span class="s7">*    |     +----------+   +-----------+   +----------+     |</span>
   <span class="s7">*          +----------+   +-----------+         |</span>
   <span class="s7">* CLOSING  |ws.close()|&lt;--|close frame|&lt;--+-----+       CLOSING</span>
   <span class="s7">*          +----------+   +-----------+   |</span>
   <span class="s7">*    |           |                        |   +---+        |</span>
   <span class="s7">*                +------------------------+--&gt;|fin| - - - -</span>
   <span class="s7">*    |         +---+                      |   +---+</span>
   <span class="s7">*     - - - - -|fin|&lt;---------------------+</span>
   <span class="s7">*              +---+</span>
   <span class="s7">*</span>
   <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Number} [code] Status code explaining why the connection is closing</span>
   <span class="s7">* </span><span class="s8">@param </span><span class="s7">{(String|Buffer)} [data] The reason why the connection is</span>
   <span class="s7">*     closing</span>
   <span class="s7">* </span><span class="s8">@public</span>
   <span class="s7">*/</span>
  <span class="s1">close</span><span class="s3">(</span><span class="s1">code</span><span class="s3">, </span><span class="s1">data</span><span class="s3">) {</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">readyState </span><span class="s3">=== </span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">CLOSED</span><span class="s3">) </span><span class="s4">return</span><span class="s3">;</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">readyState </span><span class="s3">=== </span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">CONNECTING</span><span class="s3">) {</span>
      <span class="s4">const </span><span class="s1">msg </span><span class="s3">= </span><span class="s2">'WebSocket was closed before the connection was established'</span><span class="s3">;</span>
      <span class="s1">abortHandshake</span><span class="s3">(</span><span class="s4">this</span><span class="s3">, </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_req</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">);</span>
      <span class="s4">return</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">readyState </span><span class="s3">=== </span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">CLOSING</span><span class="s3">) {</span>
      <span class="s4">if </span><span class="s3">(</span>
        <span class="s4">this</span><span class="s3">.</span><span class="s1">_closeFrameSent </span><span class="s3">&amp;&amp;</span>
        <span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">_closeFrameReceived </span><span class="s3">|| </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_receiver</span><span class="s3">.</span><span class="s1">_writableState</span><span class="s3">.</span><span class="s1">errorEmitted</span><span class="s3">)</span>
      <span class="s3">) {</span>
        <span class="s4">this</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">end</span><span class="s3">();</span>
      <span class="s3">}</span>

      <span class="s4">return</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">this</span><span class="s3">.</span><span class="s1">_readyState </span><span class="s3">= </span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">CLOSING</span><span class="s3">;</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">_sender</span><span class="s3">.</span><span class="s1">close</span><span class="s3">(</span><span class="s1">code</span><span class="s3">, </span><span class="s1">data</span><span class="s3">, !</span><span class="s4">this</span><span class="s3">.</span><span class="s1">_isServer</span><span class="s3">, (</span><span class="s1">err</span><span class="s3">) =&gt; {</span>
      <span class="s0">//</span>
      <span class="s0">// This error is handled by the `'error'` listener on the socket. We only</span>
      <span class="s0">// want to know if the close frame has been sent here.</span>
      <span class="s0">//</span>
      <span class="s4">if </span><span class="s3">(</span><span class="s1">err</span><span class="s3">) </span><span class="s4">return</span><span class="s3">;</span>

      <span class="s4">this</span><span class="s3">.</span><span class="s1">_closeFrameSent </span><span class="s3">= </span><span class="s4">true</span><span class="s3">;</span>

      <span class="s4">if </span><span class="s3">(</span>
        <span class="s4">this</span><span class="s3">.</span><span class="s1">_closeFrameReceived </span><span class="s3">||</span>
        <span class="s4">this</span><span class="s3">.</span><span class="s1">_receiver</span><span class="s3">.</span><span class="s1">_writableState</span><span class="s3">.</span><span class="s1">errorEmitted</span>
      <span class="s3">) {</span>
        <span class="s4">this</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">end</span><span class="s3">();</span>
      <span class="s3">}</span>
    <span class="s3">});</span>

    <span class="s0">//</span>
    <span class="s0">// Specify a timeout for the closing handshake to complete.</span>
    <span class="s0">//</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">_closeTimer </span><span class="s3">= </span><span class="s1">setTimeout</span><span class="s3">(</span>
      <span class="s4">this</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">destroy</span><span class="s3">.</span><span class="s1">bind</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">),</span>
      <span class="s1">closeTimeout</span>
    <span class="s3">);</span>
  <span class="s3">}</span>

  <span class="s7">/**</span>
   <span class="s7">* Pause the socket.</span>
   <span class="s7">*</span>
   <span class="s7">* </span><span class="s8">@public</span>
   <span class="s7">*/</span>
  <span class="s1">pause</span><span class="s3">() {</span>
    <span class="s4">if </span><span class="s3">(</span>
      <span class="s4">this</span><span class="s3">.</span><span class="s1">readyState </span><span class="s3">=== </span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">CONNECTING </span><span class="s3">||</span>
      <span class="s4">this</span><span class="s3">.</span><span class="s1">readyState </span><span class="s3">=== </span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">CLOSED</span>
    <span class="s3">) {</span>
      <span class="s4">return</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">this</span><span class="s3">.</span><span class="s1">_paused </span><span class="s3">= </span><span class="s4">true</span><span class="s3">;</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">pause</span><span class="s3">();</span>
  <span class="s3">}</span>

  <span class="s7">/**</span>
   <span class="s7">* Send a ping.</span>
   <span class="s7">*</span>
   <span class="s7">* </span><span class="s8">@param </span><span class="s7">{*} [data] The data to send</span>
   <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Boolean} [mask] Indicates whether or not to mask `data`</span>
   <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Function} [cb] Callback which is executed when the ping is sent</span>
   <span class="s7">* </span><span class="s8">@public</span>
   <span class="s7">*/</span>
  <span class="s1">ping</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">mask</span><span class="s3">, </span><span class="s1">cb</span><span class="s3">) {</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">readyState </span><span class="s3">=== </span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">CONNECTING</span><span class="s3">) {</span>
      <span class="s4">throw new </span><span class="s1">Error</span><span class="s3">(</span><span class="s2">'WebSocket is not open: readyState 0 (CONNECTING)'</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s4">typeof </span><span class="s1">data </span><span class="s3">=== </span><span class="s2">'function'</span><span class="s3">) {</span>
      <span class="s1">cb </span><span class="s3">= </span><span class="s1">data</span><span class="s3">;</span>
      <span class="s1">data </span><span class="s3">= </span><span class="s1">mask </span><span class="s3">= </span><span class="s1">undefined</span><span class="s3">;</span>
    <span class="s3">} </span><span class="s4">else if </span><span class="s3">(</span><span class="s4">typeof </span><span class="s1">mask </span><span class="s3">=== </span><span class="s2">'function'</span><span class="s3">) {</span>
      <span class="s1">cb </span><span class="s3">= </span><span class="s1">mask</span><span class="s3">;</span>
      <span class="s1">mask </span><span class="s3">= </span><span class="s1">undefined</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s4">typeof </span><span class="s1">data </span><span class="s3">=== </span><span class="s2">'number'</span><span class="s3">) </span><span class="s1">data </span><span class="s3">= </span><span class="s1">data</span><span class="s3">.</span><span class="s1">toString</span><span class="s3">();</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">readyState </span><span class="s3">!== </span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">OPEN</span><span class="s3">) {</span>
      <span class="s1">sendAfterClose</span><span class="s3">(</span><span class="s4">this</span><span class="s3">, </span><span class="s1">data</span><span class="s3">, </span><span class="s1">cb</span><span class="s3">);</span>
      <span class="s4">return</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s1">mask </span><span class="s3">=== </span><span class="s1">undefined</span><span class="s3">) </span><span class="s1">mask </span><span class="s3">= !</span><span class="s4">this</span><span class="s3">.</span><span class="s1">_isServer</span><span class="s3">;</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">_sender</span><span class="s3">.</span><span class="s1">ping</span><span class="s3">(</span><span class="s1">data </span><span class="s3">|| </span><span class="s1">EMPTY_BUFFER</span><span class="s3">, </span><span class="s1">mask</span><span class="s3">, </span><span class="s1">cb</span><span class="s3">);</span>
  <span class="s3">}</span>

  <span class="s7">/**</span>
   <span class="s7">* Send a pong.</span>
   <span class="s7">*</span>
   <span class="s7">* </span><span class="s8">@param </span><span class="s7">{*} [data] The data to send</span>
   <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Boolean} [mask] Indicates whether or not to mask `data`</span>
   <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Function} [cb] Callback which is executed when the pong is sent</span>
   <span class="s7">* </span><span class="s8">@public</span>
   <span class="s7">*/</span>
  <span class="s1">pong</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">mask</span><span class="s3">, </span><span class="s1">cb</span><span class="s3">) {</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">readyState </span><span class="s3">=== </span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">CONNECTING</span><span class="s3">) {</span>
      <span class="s4">throw new </span><span class="s1">Error</span><span class="s3">(</span><span class="s2">'WebSocket is not open: readyState 0 (CONNECTING)'</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s4">typeof </span><span class="s1">data </span><span class="s3">=== </span><span class="s2">'function'</span><span class="s3">) {</span>
      <span class="s1">cb </span><span class="s3">= </span><span class="s1">data</span><span class="s3">;</span>
      <span class="s1">data </span><span class="s3">= </span><span class="s1">mask </span><span class="s3">= </span><span class="s1">undefined</span><span class="s3">;</span>
    <span class="s3">} </span><span class="s4">else if </span><span class="s3">(</span><span class="s4">typeof </span><span class="s1">mask </span><span class="s3">=== </span><span class="s2">'function'</span><span class="s3">) {</span>
      <span class="s1">cb </span><span class="s3">= </span><span class="s1">mask</span><span class="s3">;</span>
      <span class="s1">mask </span><span class="s3">= </span><span class="s1">undefined</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s4">typeof </span><span class="s1">data </span><span class="s3">=== </span><span class="s2">'number'</span><span class="s3">) </span><span class="s1">data </span><span class="s3">= </span><span class="s1">data</span><span class="s3">.</span><span class="s1">toString</span><span class="s3">();</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">readyState </span><span class="s3">!== </span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">OPEN</span><span class="s3">) {</span>
      <span class="s1">sendAfterClose</span><span class="s3">(</span><span class="s4">this</span><span class="s3">, </span><span class="s1">data</span><span class="s3">, </span><span class="s1">cb</span><span class="s3">);</span>
      <span class="s4">return</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s1">mask </span><span class="s3">=== </span><span class="s1">undefined</span><span class="s3">) </span><span class="s1">mask </span><span class="s3">= !</span><span class="s4">this</span><span class="s3">.</span><span class="s1">_isServer</span><span class="s3">;</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">_sender</span><span class="s3">.</span><span class="s1">pong</span><span class="s3">(</span><span class="s1">data </span><span class="s3">|| </span><span class="s1">EMPTY_BUFFER</span><span class="s3">, </span><span class="s1">mask</span><span class="s3">, </span><span class="s1">cb</span><span class="s3">);</span>
  <span class="s3">}</span>

  <span class="s7">/**</span>
   <span class="s7">* Resume the socket.</span>
   <span class="s7">*</span>
   <span class="s7">* </span><span class="s8">@public</span>
   <span class="s7">*/</span>
  <span class="s1">resume</span><span class="s3">() {</span>
    <span class="s4">if </span><span class="s3">(</span>
      <span class="s4">this</span><span class="s3">.</span><span class="s1">readyState </span><span class="s3">=== </span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">CONNECTING </span><span class="s3">||</span>
      <span class="s4">this</span><span class="s3">.</span><span class="s1">readyState </span><span class="s3">=== </span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">CLOSED</span>
    <span class="s3">) {</span>
      <span class="s4">return</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">this</span><span class="s3">.</span><span class="s1">_paused </span><span class="s3">= </span><span class="s4">false</span><span class="s3">;</span>
    <span class="s4">if </span><span class="s3">(!</span><span class="s4">this</span><span class="s3">.</span><span class="s1">_receiver</span><span class="s3">.</span><span class="s1">_writableState</span><span class="s3">.</span><span class="s1">needDrain</span><span class="s3">) </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">resume</span><span class="s3">();</span>
  <span class="s3">}</span>

  <span class="s7">/**</span>
   <span class="s7">* Send a data message.</span>
   <span class="s7">*</span>
   <span class="s7">* </span><span class="s8">@param </span><span class="s7">{*} data The message to send</span>
   <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Object} [options] Options object</span>
   <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Boolean} [options.binary] Specifies whether `data` is binary or</span>
   <span class="s7">*     text</span>
   <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Boolean} [options.compress] Specifies whether or not to compress</span>
   <span class="s7">*     `data`</span>
   <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Boolean} [options.fin=true] Specifies whether the fragment is the</span>
   <span class="s7">*     last one</span>
   <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Boolean} [options.mask] Specifies whether or not to mask `data`</span>
   <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Function} [cb] Callback which is executed when data is written out</span>
   <span class="s7">* </span><span class="s8">@public</span>
   <span class="s7">*/</span>
  <span class="s1">send</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">options</span><span class="s3">, </span><span class="s1">cb</span><span class="s3">) {</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">readyState </span><span class="s3">=== </span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">CONNECTING</span><span class="s3">) {</span>
      <span class="s4">throw new </span><span class="s1">Error</span><span class="s3">(</span><span class="s2">'WebSocket is not open: readyState 0 (CONNECTING)'</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s4">typeof </span><span class="s1">options </span><span class="s3">=== </span><span class="s2">'function'</span><span class="s3">) {</span>
      <span class="s1">cb </span><span class="s3">= </span><span class="s1">options</span><span class="s3">;</span>
      <span class="s1">options </span><span class="s3">= {};</span>
    <span class="s3">}</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s4">typeof </span><span class="s1">data </span><span class="s3">=== </span><span class="s2">'number'</span><span class="s3">) </span><span class="s1">data </span><span class="s3">= </span><span class="s1">data</span><span class="s3">.</span><span class="s1">toString</span><span class="s3">();</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">readyState </span><span class="s3">!== </span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">OPEN</span><span class="s3">) {</span>
      <span class="s1">sendAfterClose</span><span class="s3">(</span><span class="s4">this</span><span class="s3">, </span><span class="s1">data</span><span class="s3">, </span><span class="s1">cb</span><span class="s3">);</span>
      <span class="s4">return</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">const </span><span class="s1">opts </span><span class="s3">= {</span>
      <span class="s1">binary</span><span class="s3">: </span><span class="s4">typeof </span><span class="s1">data </span><span class="s3">!== </span><span class="s2">'string'</span><span class="s3">,</span>
      <span class="s1">mask</span><span class="s3">: !</span><span class="s4">this</span><span class="s3">.</span><span class="s1">_isServer</span><span class="s3">,</span>
      <span class="s1">compress</span><span class="s3">: </span><span class="s4">true</span><span class="s3">,</span>
      <span class="s1">fin</span><span class="s3">: </span><span class="s4">true</span><span class="s3">,</span>
      <span class="s1">...options</span>
    <span class="s3">};</span>

    <span class="s4">if </span><span class="s3">(!</span><span class="s4">this</span><span class="s3">.</span><span class="s1">_extensions</span><span class="s3">[</span><span class="s1">PerMessageDeflate</span><span class="s3">.</span><span class="s1">extensionName</span><span class="s3">]) {</span>
      <span class="s1">opts</span><span class="s3">.</span><span class="s1">compress </span><span class="s3">= </span><span class="s4">false</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">this</span><span class="s3">.</span><span class="s1">_sender</span><span class="s3">.</span><span class="s1">send</span><span class="s3">(</span><span class="s1">data </span><span class="s3">|| </span><span class="s1">EMPTY_BUFFER</span><span class="s3">, </span><span class="s1">opts</span><span class="s3">, </span><span class="s1">cb</span><span class="s3">);</span>
  <span class="s3">}</span>

  <span class="s7">/**</span>
   <span class="s7">* Forcibly close the connection.</span>
   <span class="s7">*</span>
   <span class="s7">* </span><span class="s8">@public</span>
   <span class="s7">*/</span>
  <span class="s1">terminate</span><span class="s3">() {</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">readyState </span><span class="s3">=== </span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">CLOSED</span><span class="s3">) </span><span class="s4">return</span><span class="s3">;</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">readyState </span><span class="s3">=== </span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">CONNECTING</span><span class="s3">) {</span>
      <span class="s4">const </span><span class="s1">msg </span><span class="s3">= </span><span class="s2">'WebSocket was closed before the connection was established'</span><span class="s3">;</span>
      <span class="s1">abortHandshake</span><span class="s3">(</span><span class="s4">this</span><span class="s3">, </span><span class="s4">this</span><span class="s3">.</span><span class="s1">_req</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">);</span>
      <span class="s4">return</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">) {</span>
      <span class="s4">this</span><span class="s3">.</span><span class="s1">_readyState </span><span class="s3">= </span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">CLOSING</span><span class="s3">;</span>
      <span class="s4">this</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">destroy</span><span class="s3">();</span>
    <span class="s3">}</span>
  <span class="s3">}</span>
<span class="s3">}</span>

<span class="s7">/**</span>
 <span class="s7">* </span><span class="s8">@constant </span><span class="s7">{Number} CONNECTING</span>
 <span class="s7">* </span><span class="s8">@memberof </span><span class="s7">WebSocket</span>
 <span class="s7">*/</span>
<span class="s1">Object</span><span class="s3">.</span><span class="s1">defineProperty</span><span class="s3">(</span><span class="s1">WebSocket</span><span class="s3">, </span><span class="s2">'CONNECTING'</span><span class="s3">, {</span>
  <span class="s1">enumerable</span><span class="s3">: </span><span class="s4">true</span><span class="s3">,</span>
  <span class="s1">value</span><span class="s3">: </span><span class="s1">readyStates</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s2">'CONNECTING'</span><span class="s3">)</span>
<span class="s3">});</span>

<span class="s7">/**</span>
 <span class="s7">* </span><span class="s8">@constant </span><span class="s7">{Number} CONNECTING</span>
 <span class="s7">* </span><span class="s8">@memberof </span><span class="s7">WebSocket.prototype</span>
 <span class="s7">*/</span>
<span class="s1">Object</span><span class="s3">.</span><span class="s1">defineProperty</span><span class="s3">(</span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">, </span><span class="s2">'CONNECTING'</span><span class="s3">, {</span>
  <span class="s1">enumerable</span><span class="s3">: </span><span class="s4">true</span><span class="s3">,</span>
  <span class="s1">value</span><span class="s3">: </span><span class="s1">readyStates</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s2">'CONNECTING'</span><span class="s3">)</span>
<span class="s3">});</span>

<span class="s7">/**</span>
 <span class="s7">* </span><span class="s8">@constant </span><span class="s7">{Number} OPEN</span>
 <span class="s7">* </span><span class="s8">@memberof </span><span class="s7">WebSocket</span>
 <span class="s7">*/</span>
<span class="s1">Object</span><span class="s3">.</span><span class="s1">defineProperty</span><span class="s3">(</span><span class="s1">WebSocket</span><span class="s3">, </span><span class="s2">'OPEN'</span><span class="s3">, {</span>
  <span class="s1">enumerable</span><span class="s3">: </span><span class="s4">true</span><span class="s3">,</span>
  <span class="s1">value</span><span class="s3">: </span><span class="s1">readyStates</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s2">'OPEN'</span><span class="s3">)</span>
<span class="s3">});</span>

<span class="s7">/**</span>
 <span class="s7">* </span><span class="s8">@constant </span><span class="s7">{Number} OPEN</span>
 <span class="s7">* </span><span class="s8">@memberof </span><span class="s7">WebSocket.prototype</span>
 <span class="s7">*/</span>
<span class="s1">Object</span><span class="s3">.</span><span class="s1">defineProperty</span><span class="s3">(</span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">, </span><span class="s2">'OPEN'</span><span class="s3">, {</span>
  <span class="s1">enumerable</span><span class="s3">: </span><span class="s4">true</span><span class="s3">,</span>
  <span class="s1">value</span><span class="s3">: </span><span class="s1">readyStates</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s2">'OPEN'</span><span class="s3">)</span>
<span class="s3">});</span>

<span class="s7">/**</span>
 <span class="s7">* </span><span class="s8">@constant </span><span class="s7">{Number} CLOSING</span>
 <span class="s7">* </span><span class="s8">@memberof </span><span class="s7">WebSocket</span>
 <span class="s7">*/</span>
<span class="s1">Object</span><span class="s3">.</span><span class="s1">defineProperty</span><span class="s3">(</span><span class="s1">WebSocket</span><span class="s3">, </span><span class="s2">'CLOSING'</span><span class="s3">, {</span>
  <span class="s1">enumerable</span><span class="s3">: </span><span class="s4">true</span><span class="s3">,</span>
  <span class="s1">value</span><span class="s3">: </span><span class="s1">readyStates</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s2">'CLOSING'</span><span class="s3">)</span>
<span class="s3">});</span>

<span class="s7">/**</span>
 <span class="s7">* </span><span class="s8">@constant </span><span class="s7">{Number} CLOSING</span>
 <span class="s7">* </span><span class="s8">@memberof </span><span class="s7">WebSocket.prototype</span>
 <span class="s7">*/</span>
<span class="s1">Object</span><span class="s3">.</span><span class="s1">defineProperty</span><span class="s3">(</span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">, </span><span class="s2">'CLOSING'</span><span class="s3">, {</span>
  <span class="s1">enumerable</span><span class="s3">: </span><span class="s4">true</span><span class="s3">,</span>
  <span class="s1">value</span><span class="s3">: </span><span class="s1">readyStates</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s2">'CLOSING'</span><span class="s3">)</span>
<span class="s3">});</span>

<span class="s7">/**</span>
 <span class="s7">* </span><span class="s8">@constant </span><span class="s7">{Number} CLOSED</span>
 <span class="s7">* </span><span class="s8">@memberof </span><span class="s7">WebSocket</span>
 <span class="s7">*/</span>
<span class="s1">Object</span><span class="s3">.</span><span class="s1">defineProperty</span><span class="s3">(</span><span class="s1">WebSocket</span><span class="s3">, </span><span class="s2">'CLOSED'</span><span class="s3">, {</span>
  <span class="s1">enumerable</span><span class="s3">: </span><span class="s4">true</span><span class="s3">,</span>
  <span class="s1">value</span><span class="s3">: </span><span class="s1">readyStates</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s2">'CLOSED'</span><span class="s3">)</span>
<span class="s3">});</span>

<span class="s7">/**</span>
 <span class="s7">* </span><span class="s8">@constant </span><span class="s7">{Number} CLOSED</span>
 <span class="s7">* </span><span class="s8">@memberof </span><span class="s7">WebSocket.prototype</span>
 <span class="s7">*/</span>
<span class="s1">Object</span><span class="s3">.</span><span class="s1">defineProperty</span><span class="s3">(</span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">, </span><span class="s2">'CLOSED'</span><span class="s3">, {</span>
  <span class="s1">enumerable</span><span class="s3">: </span><span class="s4">true</span><span class="s3">,</span>
  <span class="s1">value</span><span class="s3">: </span><span class="s1">readyStates</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s2">'CLOSED'</span><span class="s3">)</span>
<span class="s3">});</span>

<span class="s3">[</span>
  <span class="s2">'binaryType'</span><span class="s3">,</span>
  <span class="s2">'bufferedAmount'</span><span class="s3">,</span>
  <span class="s2">'extensions'</span><span class="s3">,</span>
  <span class="s2">'isPaused'</span><span class="s3">,</span>
  <span class="s2">'protocol'</span><span class="s3">,</span>
  <span class="s2">'readyState'</span><span class="s3">,</span>
  <span class="s2">'url'</span>
<span class="s3">].</span><span class="s1">forEach</span><span class="s3">((</span><span class="s1">property</span><span class="s3">) =&gt; {</span>
  <span class="s1">Object</span><span class="s3">.</span><span class="s1">defineProperty</span><span class="s3">(</span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">, </span><span class="s1">property</span><span class="s3">, { </span><span class="s1">enumerable</span><span class="s3">: </span><span class="s4">true </span><span class="s3">});</span>
<span class="s3">});</span>

<span class="s0">//</span>
<span class="s0">// Add the `onopen`, `onerror`, `onclose`, and `onmessage` attributes.</span>
<span class="s0">// See https://html.spec.whatwg.org/multipage/comms.html#the-websocket-interface</span>
<span class="s0">//</span>
<span class="s3">[</span><span class="s2">'open'</span><span class="s3">, </span><span class="s2">'error'</span><span class="s3">, </span><span class="s2">'close'</span><span class="s3">, </span><span class="s2">'message'</span><span class="s3">].</span><span class="s1">forEach</span><span class="s3">((</span><span class="s1">method</span><span class="s3">) =&gt; {</span>
  <span class="s1">Object</span><span class="s3">.</span><span class="s1">defineProperty</span><span class="s3">(</span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">, </span><span class="s2">`on</span><span class="s1">$</span><span class="s3">{</span><span class="s1">method</span><span class="s3">}</span><span class="s2">`</span><span class="s3">, {</span>
    <span class="s1">enumerable</span><span class="s3">: </span><span class="s4">true</span><span class="s3">,</span>
    <span class="s1">get</span><span class="s3">() {</span>
      <span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s1">listener of </span><span class="s4">this</span><span class="s3">.</span><span class="s1">listeners</span><span class="s3">(</span><span class="s1">method</span><span class="s3">)) {</span>
        <span class="s4">if </span><span class="s3">(</span><span class="s1">listener</span><span class="s3">[</span><span class="s1">kForOnEventAttribute</span><span class="s3">]) </span><span class="s4">return </span><span class="s1">listener</span><span class="s3">[</span><span class="s1">kListener</span><span class="s3">];</span>
      <span class="s3">}</span>

      <span class="s4">return null</span><span class="s3">;</span>
    <span class="s3">},</span>
    <span class="s1">set</span><span class="s3">(</span><span class="s1">handler</span><span class="s3">) {</span>
      <span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s1">listener of </span><span class="s4">this</span><span class="s3">.</span><span class="s1">listeners</span><span class="s3">(</span><span class="s1">method</span><span class="s3">)) {</span>
        <span class="s4">if </span><span class="s3">(</span><span class="s1">listener</span><span class="s3">[</span><span class="s1">kForOnEventAttribute</span><span class="s3">]) {</span>
          <span class="s4">this</span><span class="s3">.</span><span class="s1">removeListener</span><span class="s3">(</span><span class="s1">method</span><span class="s3">, </span><span class="s1">listener</span><span class="s3">);</span>
          <span class="s4">break</span><span class="s3">;</span>
        <span class="s3">}</span>
      <span class="s3">}</span>

      <span class="s4">if </span><span class="s3">(</span><span class="s4">typeof </span><span class="s1">handler </span><span class="s3">!== </span><span class="s2">'function'</span><span class="s3">) </span><span class="s4">return</span><span class="s3">;</span>

      <span class="s4">this</span><span class="s3">.</span><span class="s1">addEventListener</span><span class="s3">(</span><span class="s1">method</span><span class="s3">, </span><span class="s1">handler</span><span class="s3">, {</span>
        <span class="s3">[</span><span class="s1">kForOnEventAttribute</span><span class="s3">]: </span><span class="s4">true</span>
      <span class="s3">});</span>
    <span class="s3">}</span>
  <span class="s3">});</span>
<span class="s3">});</span>

<span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">addEventListener </span><span class="s3">= </span><span class="s1">addEventListener</span><span class="s3">;</span>
<span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">removeEventListener </span><span class="s3">= </span><span class="s1">removeEventListener</span><span class="s3">;</span>

<span class="s1">module</span><span class="s3">.</span><span class="s1">exports </span><span class="s3">= </span><span class="s1">WebSocket</span><span class="s3">;</span>

<span class="s7">/**</span>
 <span class="s7">* Initialize a WebSocket client.</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{WebSocket} websocket The client to initialize</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{(String|URL)} address The URL to which to connect</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Array} protocols The subprotocols</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Object} [options] Connection options</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Boolean} [options.followRedirects=false] Whether or not to follow</span>
 <span class="s7">*     redirects</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Function} [options.generateMask] The function used to generate the</span>
 <span class="s7">*     masking key</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Number} [options.handshakeTimeout] Timeout in milliseconds for the</span>
 <span class="s7">*     handshake request</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Number} [options.maxPayload=104857600] The maximum allowed message</span>
 <span class="s7">*     size</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Number} [options.maxRedirects=10] The maximum number of redirects</span>
 <span class="s7">*     allowed</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{String} [options.origin] Value of the `Origin` or</span>
 <span class="s7">*     `Sec-WebSocket-Origin` header</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{(Boolean|Object)} [options.perMessageDeflate=true] Enable/disable</span>
 <span class="s7">*     permessage-deflate</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Number} [options.protocolVersion=13] Value of the</span>
 <span class="s7">*     `Sec-WebSocket-Version` header</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Boolean} [options.skipUTF8Validation=false] Specifies whether or</span>
 <span class="s7">*     not to skip UTF-8 validation for text and close messages</span>
 <span class="s7">* </span><span class="s8">@private</span>
 <span class="s7">*/</span>
<span class="s4">function </span><span class="s1">initAsClient</span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">, </span><span class="s1">address</span><span class="s3">, </span><span class="s1">protocols</span><span class="s3">, </span><span class="s1">options</span><span class="s3">) {</span>
  <span class="s4">const </span><span class="s1">opts </span><span class="s3">= {</span>
    <span class="s1">protocolVersion</span><span class="s3">: </span><span class="s1">protocolVersions</span><span class="s3">[</span><span class="s5">1</span><span class="s3">],</span>
    <span class="s1">maxPayload</span><span class="s3">: </span><span class="s5">100 </span><span class="s3">* </span><span class="s5">1024 </span><span class="s3">* </span><span class="s5">1024</span><span class="s3">,</span>
    <span class="s1">skipUTF8Validation</span><span class="s3">: </span><span class="s4">false</span><span class="s3">,</span>
    <span class="s1">perMessageDeflate</span><span class="s3">: </span><span class="s4">true</span><span class="s3">,</span>
    <span class="s1">followRedirects</span><span class="s3">: </span><span class="s4">false</span><span class="s3">,</span>
    <span class="s1">maxRedirects</span><span class="s3">: </span><span class="s5">10</span><span class="s3">,</span>
    <span class="s1">...options</span><span class="s3">,</span>
    <span class="s1">createConnection</span><span class="s3">: </span><span class="s1">undefined</span><span class="s3">,</span>
    <span class="s1">socketPath</span><span class="s3">: </span><span class="s1">undefined</span><span class="s3">,</span>
    <span class="s1">hostname</span><span class="s3">: </span><span class="s1">undefined</span><span class="s3">,</span>
    <span class="s1">protocol</span><span class="s3">: </span><span class="s1">undefined</span><span class="s3">,</span>
    <span class="s1">timeout</span><span class="s3">: </span><span class="s1">undefined</span><span class="s3">,</span>
    <span class="s1">method</span><span class="s3">: </span><span class="s2">'GET'</span><span class="s3">,</span>
    <span class="s1">host</span><span class="s3">: </span><span class="s1">undefined</span><span class="s3">,</span>
    <span class="s1">path</span><span class="s3">: </span><span class="s1">undefined</span><span class="s3">,</span>
    <span class="s1">port</span><span class="s3">: </span><span class="s1">undefined</span>
  <span class="s3">};</span>

  <span class="s4">if </span><span class="s3">(!</span><span class="s1">protocolVersions</span><span class="s3">.</span><span class="s1">includes</span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">protocolVersion</span><span class="s3">)) {</span>
    <span class="s4">throw new </span><span class="s1">RangeError</span><span class="s3">(</span>
      <span class="s2">`Unsupported protocol version: </span><span class="s1">$</span><span class="s3">{</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">protocolVersion</span><span class="s3">} </span><span class="s2">` </span><span class="s3">+</span>
        <span class="s2">`(supported versions: </span><span class="s1">$</span><span class="s3">{</span><span class="s1">protocolVersions</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s2">', '</span><span class="s3">)}</span><span class="s2">)`</span>
    <span class="s3">);</span>
  <span class="s3">}</span>

  <span class="s4">let </span><span class="s1">parsedUrl</span><span class="s3">;</span>

  <span class="s4">if </span><span class="s3">(</span><span class="s1">address </span><span class="s4">instanceof </span><span class="s1">URL</span><span class="s3">) {</span>
    <span class="s1">parsedUrl </span><span class="s3">= </span><span class="s1">address</span><span class="s3">;</span>
  <span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
    <span class="s4">try </span><span class="s3">{</span>
      <span class="s1">parsedUrl </span><span class="s3">= </span><span class="s4">new </span><span class="s1">URL</span><span class="s3">(</span><span class="s1">address</span><span class="s3">);</span>
    <span class="s3">} </span><span class="s4">catch </span><span class="s3">(</span><span class="s1">e</span><span class="s3">) {</span>
      <span class="s4">throw new </span><span class="s1">SyntaxError</span><span class="s3">(</span><span class="s2">`Invalid URL: </span><span class="s1">$</span><span class="s3">{</span><span class="s1">address</span><span class="s3">}</span><span class="s2">`</span><span class="s3">);</span>
    <span class="s3">}</span>
  <span class="s3">}</span>

  <span class="s4">if </span><span class="s3">(</span><span class="s1">parsedUrl</span><span class="s3">.</span><span class="s1">protocol </span><span class="s3">=== </span><span class="s2">'http:'</span><span class="s3">) {</span>
    <span class="s1">parsedUrl</span><span class="s3">.</span><span class="s1">protocol </span><span class="s3">= </span><span class="s2">'ws:'</span><span class="s3">;</span>
  <span class="s3">} </span><span class="s4">else if </span><span class="s3">(</span><span class="s1">parsedUrl</span><span class="s3">.</span><span class="s1">protocol </span><span class="s3">=== </span><span class="s2">'https:'</span><span class="s3">) {</span>
    <span class="s1">parsedUrl</span><span class="s3">.</span><span class="s1">protocol </span><span class="s3">= </span><span class="s2">'wss:'</span><span class="s3">;</span>
  <span class="s3">}</span>

  <span class="s1">websocket</span><span class="s3">.</span><span class="s1">_url </span><span class="s3">= </span><span class="s1">parsedUrl</span><span class="s3">.</span><span class="s1">href</span><span class="s3">;</span>

  <span class="s4">const </span><span class="s1">isSecure </span><span class="s3">= </span><span class="s1">parsedUrl</span><span class="s3">.</span><span class="s1">protocol </span><span class="s3">=== </span><span class="s2">'wss:'</span><span class="s3">;</span>
  <span class="s4">const </span><span class="s1">isIpcUrl </span><span class="s3">= </span><span class="s1">parsedUrl</span><span class="s3">.</span><span class="s1">protocol </span><span class="s3">=== </span><span class="s2">'ws+unix:'</span><span class="s3">;</span>
  <span class="s4">let </span><span class="s1">invalidUrlMessage</span><span class="s3">;</span>

  <span class="s4">if </span><span class="s3">(</span><span class="s1">parsedUrl</span><span class="s3">.</span><span class="s1">protocol </span><span class="s3">!== </span><span class="s2">'ws:' </span><span class="s3">&amp;&amp; !</span><span class="s1">isSecure </span><span class="s3">&amp;&amp; !</span><span class="s1">isIpcUrl</span><span class="s3">) {</span>
    <span class="s1">invalidUrlMessage </span><span class="s3">=</span>
      <span class="s2">'The URL</span><span class="s4">\'</span><span class="s2">s protocol must be one of &quot;ws:&quot;, &quot;wss:&quot;, ' </span><span class="s3">+</span>
      <span class="s2">'&quot;http:&quot;, &quot;https&quot;, or &quot;ws+unix:&quot;'</span><span class="s3">;</span>
  <span class="s3">} </span><span class="s4">else if </span><span class="s3">(</span><span class="s1">isIpcUrl </span><span class="s3">&amp;&amp; !</span><span class="s1">parsedUrl</span><span class="s3">.</span><span class="s1">pathname</span><span class="s3">) {</span>
    <span class="s1">invalidUrlMessage </span><span class="s3">= </span><span class="s2">&quot;The URL's pathname is empty&quot;</span><span class="s3">;</span>
  <span class="s3">} </span><span class="s4">else if </span><span class="s3">(</span><span class="s1">parsedUrl</span><span class="s3">.</span><span class="s1">hash</span><span class="s3">) {</span>
    <span class="s1">invalidUrlMessage </span><span class="s3">= </span><span class="s2">'The URL contains a fragment identifier'</span><span class="s3">;</span>
  <span class="s3">}</span>

  <span class="s4">if </span><span class="s3">(</span><span class="s1">invalidUrlMessage</span><span class="s3">) {</span>
    <span class="s4">const </span><span class="s1">err </span><span class="s3">= </span><span class="s4">new </span><span class="s1">SyntaxError</span><span class="s3">(</span><span class="s1">invalidUrlMessage</span><span class="s3">);</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_redirects </span><span class="s3">=== </span><span class="s5">0</span><span class="s3">) {</span>
      <span class="s4">throw </span><span class="s1">err</span><span class="s3">;</span>
    <span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
      <span class="s1">emitErrorAndClose</span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">, </span><span class="s1">err</span><span class="s3">);</span>
      <span class="s4">return</span><span class="s3">;</span>
    <span class="s3">}</span>
  <span class="s3">}</span>

  <span class="s4">const </span><span class="s1">defaultPort </span><span class="s3">= </span><span class="s1">isSecure </span><span class="s3">? </span><span class="s5">443 </span><span class="s3">: </span><span class="s5">80</span><span class="s3">;</span>
  <span class="s4">const </span><span class="s1">key </span><span class="s3">= </span><span class="s1">randomBytes</span><span class="s3">(</span><span class="s5">16</span><span class="s3">).</span><span class="s1">toString</span><span class="s3">(</span><span class="s2">'base64'</span><span class="s3">);</span>
  <span class="s4">const </span><span class="s1">request </span><span class="s3">= </span><span class="s1">isSecure </span><span class="s3">? </span><span class="s1">https</span><span class="s3">.</span><span class="s1">request </span><span class="s3">: </span><span class="s1">http</span><span class="s3">.</span><span class="s1">request</span><span class="s3">;</span>
  <span class="s4">const </span><span class="s1">protocolSet </span><span class="s3">= </span><span class="s4">new </span><span class="s1">Set</span><span class="s3">();</span>
  <span class="s4">let </span><span class="s1">perMessageDeflate</span><span class="s3">;</span>

  <span class="s1">opts</span><span class="s3">.</span><span class="s1">createConnection </span><span class="s3">= </span><span class="s1">isSecure </span><span class="s3">? </span><span class="s1">tlsConnect </span><span class="s3">: </span><span class="s1">netConnect</span><span class="s3">;</span>
  <span class="s1">opts</span><span class="s3">.</span><span class="s1">defaultPort </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">defaultPort </span><span class="s3">|| </span><span class="s1">defaultPort</span><span class="s3">;</span>
  <span class="s1">opts</span><span class="s3">.</span><span class="s1">port </span><span class="s3">= </span><span class="s1">parsedUrl</span><span class="s3">.</span><span class="s1">port </span><span class="s3">|| </span><span class="s1">defaultPort</span><span class="s3">;</span>
  <span class="s1">opts</span><span class="s3">.</span><span class="s1">host </span><span class="s3">= </span><span class="s1">parsedUrl</span><span class="s3">.</span><span class="s1">hostname</span><span class="s3">.</span><span class="s1">startsWith</span><span class="s3">(</span><span class="s2">'['</span><span class="s3">)</span>
    <span class="s3">? </span><span class="s1">parsedUrl</span><span class="s3">.</span><span class="s1">hostname</span><span class="s3">.</span><span class="s1">slice</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">)</span>
    <span class="s3">: </span><span class="s1">parsedUrl</span><span class="s3">.</span><span class="s1">hostname</span><span class="s3">;</span>
  <span class="s1">opts</span><span class="s3">.</span><span class="s1">headers </span><span class="s3">= {</span>
    <span class="s1">...opts</span><span class="s3">.</span><span class="s1">headers</span><span class="s3">,</span>
    <span class="s2">'Sec-WebSocket-Version'</span><span class="s3">: </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">protocolVersion</span><span class="s3">,</span>
    <span class="s2">'Sec-WebSocket-Key'</span><span class="s3">: </span><span class="s1">key</span><span class="s3">,</span>
    <span class="s1">Connection</span><span class="s3">: </span><span class="s2">'Upgrade'</span><span class="s3">,</span>
    <span class="s1">Upgrade</span><span class="s3">: </span><span class="s2">'websocket'</span>
  <span class="s3">};</span>
  <span class="s1">opts</span><span class="s3">.</span><span class="s1">path </span><span class="s3">= </span><span class="s1">parsedUrl</span><span class="s3">.</span><span class="s1">pathname </span><span class="s3">+ </span><span class="s1">parsedUrl</span><span class="s3">.</span><span class="s1">search</span><span class="s3">;</span>
  <span class="s1">opts</span><span class="s3">.</span><span class="s1">timeout </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">handshakeTimeout</span><span class="s3">;</span>

  <span class="s4">if </span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">perMessageDeflate</span><span class="s3">) {</span>
    <span class="s1">perMessageDeflate </span><span class="s3">= </span><span class="s4">new </span><span class="s1">PerMessageDeflate</span><span class="s3">(</span>
      <span class="s1">opts</span><span class="s3">.</span><span class="s1">perMessageDeflate </span><span class="s3">!== </span><span class="s4">true </span><span class="s3">? </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">perMessageDeflate </span><span class="s3">: {},</span>
      <span class="s4">false</span><span class="s3">,</span>
      <span class="s1">opts</span><span class="s3">.</span><span class="s1">maxPayload</span>
    <span class="s3">);</span>
    <span class="s1">opts</span><span class="s3">.</span><span class="s1">headers</span><span class="s3">[</span><span class="s2">'Sec-WebSocket-Extensions'</span><span class="s3">] = </span><span class="s1">format</span><span class="s3">({</span>
      <span class="s3">[</span><span class="s1">PerMessageDeflate</span><span class="s3">.</span><span class="s1">extensionName</span><span class="s3">]: </span><span class="s1">perMessageDeflate</span><span class="s3">.</span><span class="s1">offer</span><span class="s3">()</span>
    <span class="s3">});</span>
  <span class="s3">}</span>
  <span class="s4">if </span><span class="s3">(</span><span class="s1">protocols</span><span class="s3">.</span><span class="s1">length</span><span class="s3">) {</span>
    <span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s1">protocol of protocols</span><span class="s3">) {</span>
      <span class="s4">if </span><span class="s3">(</span>
        <span class="s4">typeof </span><span class="s1">protocol </span><span class="s3">!== </span><span class="s2">'string' </span><span class="s3">||</span>
        <span class="s3">!</span><span class="s1">subprotocolRegex</span><span class="s3">.</span><span class="s1">test</span><span class="s3">(</span><span class="s1">protocol</span><span class="s3">) ||</span>
        <span class="s1">protocolSet</span><span class="s3">.</span><span class="s1">has</span><span class="s3">(</span><span class="s1">protocol</span><span class="s3">)</span>
      <span class="s3">) {</span>
        <span class="s4">throw new </span><span class="s1">SyntaxError</span><span class="s3">(</span>
          <span class="s2">'An invalid or duplicated subprotocol was specified'</span>
        <span class="s3">);</span>
      <span class="s3">}</span>

      <span class="s1">protocolSet</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">protocol</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s1">opts</span><span class="s3">.</span><span class="s1">headers</span><span class="s3">[</span><span class="s2">'Sec-WebSocket-Protocol'</span><span class="s3">] = </span><span class="s1">protocols</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s2">','</span><span class="s3">);</span>
  <span class="s3">}</span>
  <span class="s4">if </span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">origin</span><span class="s3">) {</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">protocolVersion </span><span class="s3">&lt; </span><span class="s5">13</span><span class="s3">) {</span>
      <span class="s1">opts</span><span class="s3">.</span><span class="s1">headers</span><span class="s3">[</span><span class="s2">'Sec-WebSocket-Origin'</span><span class="s3">] = </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">origin</span><span class="s3">;</span>
    <span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
      <span class="s1">opts</span><span class="s3">.</span><span class="s1">headers</span><span class="s3">.</span><span class="s1">Origin </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">origin</span><span class="s3">;</span>
    <span class="s3">}</span>
  <span class="s3">}</span>
  <span class="s4">if </span><span class="s3">(</span><span class="s1">parsedUrl</span><span class="s3">.</span><span class="s1">username </span><span class="s3">|| </span><span class="s1">parsedUrl</span><span class="s3">.</span><span class="s1">password</span><span class="s3">) {</span>
    <span class="s1">opts</span><span class="s3">.</span><span class="s1">auth </span><span class="s3">= </span><span class="s2">`</span><span class="s1">$</span><span class="s3">{</span><span class="s1">parsedUrl</span><span class="s3">.</span><span class="s1">username</span><span class="s3">}</span><span class="s2">:</span><span class="s1">$</span><span class="s3">{</span><span class="s1">parsedUrl</span><span class="s3">.</span><span class="s1">password</span><span class="s3">}</span><span class="s2">`</span><span class="s3">;</span>
  <span class="s3">}</span>

  <span class="s4">if </span><span class="s3">(</span><span class="s1">isIpcUrl</span><span class="s3">) {</span>
    <span class="s4">const </span><span class="s1">parts </span><span class="s3">= </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s2">':'</span><span class="s3">);</span>

    <span class="s1">opts</span><span class="s3">.</span><span class="s1">socketPath </span><span class="s3">= </span><span class="s1">parts</span><span class="s3">[</span><span class="s5">0</span><span class="s3">];</span>
    <span class="s1">opts</span><span class="s3">.</span><span class="s1">path </span><span class="s3">= </span><span class="s1">parts</span><span class="s3">[</span><span class="s5">1</span><span class="s3">];</span>
  <span class="s3">}</span>

  <span class="s4">let </span><span class="s1">req</span><span class="s3">;</span>

  <span class="s4">if </span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">followRedirects</span><span class="s3">) {</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_redirects </span><span class="s3">=== </span><span class="s5">0</span><span class="s3">) {</span>
      <span class="s1">websocket</span><span class="s3">.</span><span class="s1">_originalIpc </span><span class="s3">= </span><span class="s1">isIpcUrl</span><span class="s3">;</span>
      <span class="s1">websocket</span><span class="s3">.</span><span class="s1">_originalSecure </span><span class="s3">= </span><span class="s1">isSecure</span><span class="s3">;</span>
      <span class="s1">websocket</span><span class="s3">.</span><span class="s1">_originalHostOrSocketPath </span><span class="s3">= </span><span class="s1">isIpcUrl</span>
        <span class="s3">? </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">socketPath</span>
        <span class="s3">: </span><span class="s1">parsedUrl</span><span class="s3">.</span><span class="s1">host</span><span class="s3">;</span>

      <span class="s4">const </span><span class="s1">headers </span><span class="s3">= </span><span class="s1">options </span><span class="s3">&amp;&amp; </span><span class="s1">options</span><span class="s3">.</span><span class="s1">headers</span><span class="s3">;</span>

      <span class="s0">//</span>
      <span class="s0">// Shallow copy the user provided options so that headers can be changed</span>
      <span class="s0">// without mutating the original object.</span>
      <span class="s0">//</span>
      <span class="s1">options </span><span class="s3">= { </span><span class="s1">...options</span><span class="s3">, </span><span class="s1">headers</span><span class="s3">: {} };</span>

      <span class="s4">if </span><span class="s3">(</span><span class="s1">headers</span><span class="s3">) {</span>
        <span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s3">[</span><span class="s1">key</span><span class="s3">, </span><span class="s1">value</span><span class="s3">] </span><span class="s1">of Object</span><span class="s3">.</span><span class="s1">entries</span><span class="s3">(</span><span class="s1">headers</span><span class="s3">)) {</span>
          <span class="s1">options</span><span class="s3">.</span><span class="s1">headers</span><span class="s3">[</span><span class="s1">key</span><span class="s3">.</span><span class="s1">toLowerCase</span><span class="s3">()] = </span><span class="s1">value</span><span class="s3">;</span>
        <span class="s3">}</span>
      <span class="s3">}</span>
    <span class="s3">} </span><span class="s4">else if </span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">listenerCount</span><span class="s3">(</span><span class="s2">'redirect'</span><span class="s3">) === </span><span class="s5">0</span><span class="s3">) {</span>
      <span class="s4">const </span><span class="s1">isSameHost </span><span class="s3">= </span><span class="s1">isIpcUrl</span>
        <span class="s3">? </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_originalIpc</span>
          <span class="s3">? </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">socketPath </span><span class="s3">=== </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_originalHostOrSocketPath</span>
          <span class="s3">: </span><span class="s4">false</span>
        <span class="s3">: </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_originalIpc</span>
        <span class="s3">? </span><span class="s4">false</span>
        <span class="s3">: </span><span class="s1">parsedUrl</span><span class="s3">.</span><span class="s1">host </span><span class="s3">=== </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_originalHostOrSocketPath</span><span class="s3">;</span>

      <span class="s4">if </span><span class="s3">(!</span><span class="s1">isSameHost </span><span class="s3">|| (</span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_originalSecure </span><span class="s3">&amp;&amp; !</span><span class="s1">isSecure</span><span class="s3">)) {</span>
        <span class="s0">//</span>
        <span class="s0">// Match curl 7.77.0 behavior and drop the following headers. These</span>
        <span class="s0">// headers are also dropped when following a redirect to a subdomain.</span>
        <span class="s0">//</span>
        <span class="s4">delete </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">headers</span><span class="s3">.</span><span class="s1">authorization</span><span class="s3">;</span>
        <span class="s4">delete </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">headers</span><span class="s3">.</span><span class="s1">cookie</span><span class="s3">;</span>

        <span class="s4">if </span><span class="s3">(!</span><span class="s1">isSameHost</span><span class="s3">) </span><span class="s4">delete </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">headers</span><span class="s3">.</span><span class="s1">host</span><span class="s3">;</span>

        <span class="s1">opts</span><span class="s3">.</span><span class="s1">auth </span><span class="s3">= </span><span class="s1">undefined</span><span class="s3">;</span>
      <span class="s3">}</span>
    <span class="s3">}</span>

    <span class="s0">//</span>
    <span class="s0">// Match curl 7.77.0 behavior and make the first `Authorization` header win.</span>
    <span class="s0">// If the `Authorization` header is set, then there is nothing to do as it</span>
    <span class="s0">// will take precedence.</span>
    <span class="s0">//</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">auth </span><span class="s3">&amp;&amp; !</span><span class="s1">options</span><span class="s3">.</span><span class="s1">headers</span><span class="s3">.</span><span class="s1">authorization</span><span class="s3">) {</span>
      <span class="s1">options</span><span class="s3">.</span><span class="s1">headers</span><span class="s3">.</span><span class="s1">authorization </span><span class="s3">=</span>
        <span class="s2">'Basic ' </span><span class="s3">+ </span><span class="s1">Buffer</span><span class="s3">.</span><span class="s1">from</span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">auth</span><span class="s3">).</span><span class="s1">toString</span><span class="s3">(</span><span class="s2">'base64'</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s1">req </span><span class="s3">= </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_req </span><span class="s3">= </span><span class="s1">request</span><span class="s3">(</span><span class="s1">opts</span><span class="s3">);</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_redirects</span><span class="s3">) {</span>
      <span class="s0">//</span>
      <span class="s0">// Unlike what is done for the `'upgrade'` event, no early exit is</span>
      <span class="s0">// triggered here if the user calls `websocket.close()` or</span>
      <span class="s0">// `websocket.terminate()` from a listener of the `'redirect'` event. This</span>
      <span class="s0">// is because the user can also call `request.destroy()` with an error</span>
      <span class="s0">// before calling `websocket.close()` or `websocket.terminate()` and this</span>
      <span class="s0">// would result in an error being emitted on the `request` object with no</span>
      <span class="s0">// `'error'` event listeners attached.</span>
      <span class="s0">//</span>
      <span class="s1">websocket</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s2">'redirect'</span><span class="s3">, </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">url</span><span class="s3">, </span><span class="s1">req</span><span class="s3">);</span>
    <span class="s3">}</span>
  <span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
    <span class="s1">req </span><span class="s3">= </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_req </span><span class="s3">= </span><span class="s1">request</span><span class="s3">(</span><span class="s1">opts</span><span class="s3">);</span>
  <span class="s3">}</span>

  <span class="s4">if </span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">timeout</span><span class="s3">) {</span>
    <span class="s1">req</span><span class="s3">.</span><span class="s1">on</span><span class="s3">(</span><span class="s2">'timeout'</span><span class="s3">, () =&gt; {</span>
      <span class="s1">abortHandshake</span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">, </span><span class="s1">req</span><span class="s3">, </span><span class="s2">'Opening handshake has timed out'</span><span class="s3">);</span>
    <span class="s3">});</span>
  <span class="s3">}</span>

  <span class="s1">req</span><span class="s3">.</span><span class="s1">on</span><span class="s3">(</span><span class="s2">'error'</span><span class="s3">, (</span><span class="s1">err</span><span class="s3">) =&gt; {</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s1">req </span><span class="s3">=== </span><span class="s4">null </span><span class="s3">|| </span><span class="s1">req</span><span class="s3">[</span><span class="s1">kAborted</span><span class="s3">]) </span><span class="s4">return</span><span class="s3">;</span>

    <span class="s1">req </span><span class="s3">= </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_req </span><span class="s3">= </span><span class="s4">null</span><span class="s3">;</span>
    <span class="s1">emitErrorAndClose</span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">, </span><span class="s1">err</span><span class="s3">);</span>
  <span class="s3">});</span>

  <span class="s1">req</span><span class="s3">.</span><span class="s1">on</span><span class="s3">(</span><span class="s2">'response'</span><span class="s3">, (</span><span class="s1">res</span><span class="s3">) =&gt; {</span>
    <span class="s4">const </span><span class="s1">location </span><span class="s3">= </span><span class="s1">res</span><span class="s3">.</span><span class="s1">headers</span><span class="s3">.</span><span class="s1">location</span><span class="s3">;</span>
    <span class="s4">const </span><span class="s1">statusCode </span><span class="s3">= </span><span class="s1">res</span><span class="s3">.</span><span class="s1">statusCode</span><span class="s3">;</span>

    <span class="s4">if </span><span class="s3">(</span>
      <span class="s1">location </span><span class="s3">&amp;&amp;</span>
      <span class="s1">opts</span><span class="s3">.</span><span class="s1">followRedirects </span><span class="s3">&amp;&amp;</span>
      <span class="s1">statusCode </span><span class="s3">&gt;= </span><span class="s5">300 </span><span class="s3">&amp;&amp;</span>
      <span class="s1">statusCode </span><span class="s3">&lt; </span><span class="s5">400</span>
    <span class="s3">) {</span>
      <span class="s4">if </span><span class="s3">(++</span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_redirects </span><span class="s3">&gt; </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">maxRedirects</span><span class="s3">) {</span>
        <span class="s1">abortHandshake</span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">, </span><span class="s1">req</span><span class="s3">, </span><span class="s2">'Maximum redirects exceeded'</span><span class="s3">);</span>
        <span class="s4">return</span><span class="s3">;</span>
      <span class="s3">}</span>

      <span class="s1">req</span><span class="s3">.</span><span class="s1">abort</span><span class="s3">();</span>

      <span class="s4">let </span><span class="s1">addr</span><span class="s3">;</span>

      <span class="s4">try </span><span class="s3">{</span>
        <span class="s1">addr </span><span class="s3">= </span><span class="s4">new </span><span class="s1">URL</span><span class="s3">(</span><span class="s1">location</span><span class="s3">, </span><span class="s1">address</span><span class="s3">);</span>
      <span class="s3">} </span><span class="s4">catch </span><span class="s3">(</span><span class="s1">e</span><span class="s3">) {</span>
        <span class="s4">const </span><span class="s1">err </span><span class="s3">= </span><span class="s4">new </span><span class="s1">SyntaxError</span><span class="s3">(</span><span class="s2">`Invalid URL: </span><span class="s1">$</span><span class="s3">{</span><span class="s1">location</span><span class="s3">}</span><span class="s2">`</span><span class="s3">);</span>
        <span class="s1">emitErrorAndClose</span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">, </span><span class="s1">err</span><span class="s3">);</span>
        <span class="s4">return</span><span class="s3">;</span>
      <span class="s3">}</span>

      <span class="s1">initAsClient</span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">, </span><span class="s1">addr</span><span class="s3">, </span><span class="s1">protocols</span><span class="s3">, </span><span class="s1">options</span><span class="s3">);</span>
    <span class="s3">} </span><span class="s4">else if </span><span class="s3">(!</span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s2">'unexpected-response'</span><span class="s3">, </span><span class="s1">req</span><span class="s3">, </span><span class="s1">res</span><span class="s3">)) {</span>
      <span class="s1">abortHandshake</span><span class="s3">(</span>
        <span class="s1">websocket</span><span class="s3">,</span>
        <span class="s1">req</span><span class="s3">,</span>
        <span class="s2">`Unexpected server response: </span><span class="s1">$</span><span class="s3">{</span><span class="s1">res</span><span class="s3">.</span><span class="s1">statusCode</span><span class="s3">}</span><span class="s2">`</span>
      <span class="s3">);</span>
    <span class="s3">}</span>
  <span class="s3">});</span>

  <span class="s1">req</span><span class="s3">.</span><span class="s1">on</span><span class="s3">(</span><span class="s2">'upgrade'</span><span class="s3">, (</span><span class="s1">res</span><span class="s3">, </span><span class="s1">socket</span><span class="s3">, </span><span class="s1">head</span><span class="s3">) =&gt; {</span>
    <span class="s1">websocket</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s2">'upgrade'</span><span class="s3">, </span><span class="s1">res</span><span class="s3">);</span>

    <span class="s0">//</span>
    <span class="s0">// The user may have closed the connection from a listener of the</span>
    <span class="s0">// `'upgrade'` event.</span>
    <span class="s0">//</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">readyState </span><span class="s3">!== </span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">CONNECTING</span><span class="s3">) </span><span class="s4">return</span><span class="s3">;</span>

    <span class="s1">req </span><span class="s3">= </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_req </span><span class="s3">= </span><span class="s4">null</span><span class="s3">;</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">headers</span><span class="s3">.</span><span class="s1">upgrade</span><span class="s3">.</span><span class="s1">toLowerCase</span><span class="s3">() !== </span><span class="s2">'websocket'</span><span class="s3">) {</span>
      <span class="s1">abortHandshake</span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">, </span><span class="s1">socket</span><span class="s3">, </span><span class="s2">'Invalid Upgrade header'</span><span class="s3">);</span>
      <span class="s4">return</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">const </span><span class="s1">digest </span><span class="s3">= </span><span class="s1">createHash</span><span class="s3">(</span><span class="s2">'sha1'</span><span class="s3">)</span>
      <span class="s3">.</span><span class="s1">update</span><span class="s3">(</span><span class="s1">key </span><span class="s3">+ </span><span class="s1">GUID</span><span class="s3">)</span>
      <span class="s3">.</span><span class="s1">digest</span><span class="s3">(</span><span class="s2">'base64'</span><span class="s3">);</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">headers</span><span class="s3">[</span><span class="s2">'sec-websocket-accept'</span><span class="s3">] !== </span><span class="s1">digest</span><span class="s3">) {</span>
      <span class="s1">abortHandshake</span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">, </span><span class="s1">socket</span><span class="s3">, </span><span class="s2">'Invalid Sec-WebSocket-Accept header'</span><span class="s3">);</span>
      <span class="s4">return</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">const </span><span class="s1">serverProt </span><span class="s3">= </span><span class="s1">res</span><span class="s3">.</span><span class="s1">headers</span><span class="s3">[</span><span class="s2">'sec-websocket-protocol'</span><span class="s3">];</span>
    <span class="s4">let </span><span class="s1">protError</span><span class="s3">;</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s1">serverProt </span><span class="s3">!== </span><span class="s1">undefined</span><span class="s3">) {</span>
      <span class="s4">if </span><span class="s3">(!</span><span class="s1">protocolSet</span><span class="s3">.</span><span class="s1">size</span><span class="s3">) {</span>
        <span class="s1">protError </span><span class="s3">= </span><span class="s2">'Server sent a subprotocol but none was requested'</span><span class="s3">;</span>
      <span class="s3">} </span><span class="s4">else if </span><span class="s3">(!</span><span class="s1">protocolSet</span><span class="s3">.</span><span class="s1">has</span><span class="s3">(</span><span class="s1">serverProt</span><span class="s3">)) {</span>
        <span class="s1">protError </span><span class="s3">= </span><span class="s2">'Server sent an invalid subprotocol'</span><span class="s3">;</span>
      <span class="s3">}</span>
    <span class="s3">} </span><span class="s4">else if </span><span class="s3">(</span><span class="s1">protocolSet</span><span class="s3">.</span><span class="s1">size</span><span class="s3">) {</span>
      <span class="s1">protError </span><span class="s3">= </span><span class="s2">'Server sent no subprotocol'</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s1">protError</span><span class="s3">) {</span>
      <span class="s1">abortHandshake</span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">, </span><span class="s1">socket</span><span class="s3">, </span><span class="s1">protError</span><span class="s3">);</span>
      <span class="s4">return</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s1">serverProt</span><span class="s3">) </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_protocol </span><span class="s3">= </span><span class="s1">serverProt</span><span class="s3">;</span>

    <span class="s4">const </span><span class="s1">secWebSocketExtensions </span><span class="s3">= </span><span class="s1">res</span><span class="s3">.</span><span class="s1">headers</span><span class="s3">[</span><span class="s2">'sec-websocket-extensions'</span><span class="s3">];</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s1">secWebSocketExtensions </span><span class="s3">!== </span><span class="s1">undefined</span><span class="s3">) {</span>
      <span class="s4">if </span><span class="s3">(!</span><span class="s1">perMessageDeflate</span><span class="s3">) {</span>
        <span class="s4">const </span><span class="s1">message </span><span class="s3">=</span>
          <span class="s2">'Server sent a Sec-WebSocket-Extensions header but no extension ' </span><span class="s3">+</span>
          <span class="s2">'was requested'</span><span class="s3">;</span>
        <span class="s1">abortHandshake</span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">, </span><span class="s1">socket</span><span class="s3">, </span><span class="s1">message</span><span class="s3">);</span>
        <span class="s4">return</span><span class="s3">;</span>
      <span class="s3">}</span>

      <span class="s4">let </span><span class="s1">extensions</span><span class="s3">;</span>

      <span class="s4">try </span><span class="s3">{</span>
        <span class="s1">extensions </span><span class="s3">= </span><span class="s1">parse</span><span class="s3">(</span><span class="s1">secWebSocketExtensions</span><span class="s3">);</span>
      <span class="s3">} </span><span class="s4">catch </span><span class="s3">(</span><span class="s1">err</span><span class="s3">) {</span>
        <span class="s4">const </span><span class="s1">message </span><span class="s3">= </span><span class="s2">'Invalid Sec-WebSocket-Extensions header'</span><span class="s3">;</span>
        <span class="s1">abortHandshake</span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">, </span><span class="s1">socket</span><span class="s3">, </span><span class="s1">message</span><span class="s3">);</span>
        <span class="s4">return</span><span class="s3">;</span>
      <span class="s3">}</span>

      <span class="s4">const </span><span class="s1">extensionNames </span><span class="s3">= </span><span class="s1">Object</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">(</span><span class="s1">extensions</span><span class="s3">);</span>

      <span class="s4">if </span><span class="s3">(</span>
        <span class="s1">extensionNames</span><span class="s3">.</span><span class="s1">length </span><span class="s3">!== </span><span class="s5">1 </span><span class="s3">||</span>
        <span class="s1">extensionNames</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] !== </span><span class="s1">PerMessageDeflate</span><span class="s3">.</span><span class="s1">extensionName</span>
      <span class="s3">) {</span>
        <span class="s4">const </span><span class="s1">message </span><span class="s3">= </span><span class="s2">'Server indicated an extension that was not requested'</span><span class="s3">;</span>
        <span class="s1">abortHandshake</span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">, </span><span class="s1">socket</span><span class="s3">, </span><span class="s1">message</span><span class="s3">);</span>
        <span class="s4">return</span><span class="s3">;</span>
      <span class="s3">}</span>

      <span class="s4">try </span><span class="s3">{</span>
        <span class="s1">perMessageDeflate</span><span class="s3">.</span><span class="s1">accept</span><span class="s3">(</span><span class="s1">extensions</span><span class="s3">[</span><span class="s1">PerMessageDeflate</span><span class="s3">.</span><span class="s1">extensionName</span><span class="s3">]);</span>
      <span class="s3">} </span><span class="s4">catch </span><span class="s3">(</span><span class="s1">err</span><span class="s3">) {</span>
        <span class="s4">const </span><span class="s1">message </span><span class="s3">= </span><span class="s2">'Invalid Sec-WebSocket-Extensions header'</span><span class="s3">;</span>
        <span class="s1">abortHandshake</span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">, </span><span class="s1">socket</span><span class="s3">, </span><span class="s1">message</span><span class="s3">);</span>
        <span class="s4">return</span><span class="s3">;</span>
      <span class="s3">}</span>

      <span class="s1">websocket</span><span class="s3">.</span><span class="s1">_extensions</span><span class="s3">[</span><span class="s1">PerMessageDeflate</span><span class="s3">.</span><span class="s1">extensionName</span><span class="s3">] =</span>
        <span class="s1">perMessageDeflate</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s1">websocket</span><span class="s3">.</span><span class="s1">setSocket</span><span class="s3">(</span><span class="s1">socket</span><span class="s3">, </span><span class="s1">head</span><span class="s3">, {</span>
      <span class="s1">generateMask</span><span class="s3">: </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">generateMask</span><span class="s3">,</span>
      <span class="s1">maxPayload</span><span class="s3">: </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">maxPayload</span><span class="s3">,</span>
      <span class="s1">skipUTF8Validation</span><span class="s3">: </span><span class="s1">opts</span><span class="s3">.</span><span class="s1">skipUTF8Validation</span>
    <span class="s3">});</span>
  <span class="s3">});</span>

  <span class="s4">if </span><span class="s3">(</span><span class="s1">opts</span><span class="s3">.</span><span class="s1">finishRequest</span><span class="s3">) {</span>
    <span class="s1">opts</span><span class="s3">.</span><span class="s1">finishRequest</span><span class="s3">(</span><span class="s1">req</span><span class="s3">, </span><span class="s1">websocket</span><span class="s3">);</span>
  <span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
    <span class="s1">req</span><span class="s3">.</span><span class="s1">end</span><span class="s3">();</span>
  <span class="s3">}</span>
<span class="s3">}</span>

<span class="s7">/**</span>
 <span class="s7">* Emit the `'error'` and `'close'` events.</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{WebSocket} websocket The WebSocket instance</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Error} The error to emit</span>
 <span class="s7">* </span><span class="s8">@private</span>
 <span class="s7">*/</span>
<span class="s4">function </span><span class="s1">emitErrorAndClose</span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">, </span><span class="s1">err</span><span class="s3">) {</span>
  <span class="s1">websocket</span><span class="s3">.</span><span class="s1">_readyState </span><span class="s3">= </span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">CLOSING</span><span class="s3">;</span>
  <span class="s1">websocket</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s2">'error'</span><span class="s3">, </span><span class="s1">err</span><span class="s3">);</span>
  <span class="s1">websocket</span><span class="s3">.</span><span class="s1">emitClose</span><span class="s3">();</span>
<span class="s3">}</span>

<span class="s7">/**</span>
 <span class="s7">* Create a `net.Socket` and initiate a connection.</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Object} options Connection options</span>
 <span class="s7">* </span><span class="s8">@return </span><span class="s7">{net.Socket} The newly created socket used to start the connection</span>
 <span class="s7">* </span><span class="s8">@private</span>
 <span class="s7">*/</span>
<span class="s4">function </span><span class="s1">netConnect</span><span class="s3">(</span><span class="s1">options</span><span class="s3">) {</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">path </span><span class="s3">= </span><span class="s1">options</span><span class="s3">.</span><span class="s1">socketPath</span><span class="s3">;</span>
  <span class="s4">return </span><span class="s1">net</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">(</span><span class="s1">options</span><span class="s3">);</span>
<span class="s3">}</span>

<span class="s7">/**</span>
 <span class="s7">* Create a `tls.TLSSocket` and initiate a connection.</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Object} options Connection options</span>
 <span class="s7">* </span><span class="s8">@return </span><span class="s7">{tls.TLSSocket} The newly created socket used to start the connection</span>
 <span class="s7">* </span><span class="s8">@private</span>
 <span class="s7">*/</span>
<span class="s4">function </span><span class="s1">tlsConnect</span><span class="s3">(</span><span class="s1">options</span><span class="s3">) {</span>
  <span class="s1">options</span><span class="s3">.</span><span class="s1">path </span><span class="s3">= </span><span class="s1">undefined</span><span class="s3">;</span>

  <span class="s4">if </span><span class="s3">(!</span><span class="s1">options</span><span class="s3">.</span><span class="s1">servername </span><span class="s3">&amp;&amp; </span><span class="s1">options</span><span class="s3">.</span><span class="s1">servername </span><span class="s3">!== </span><span class="s2">''</span><span class="s3">) {</span>
    <span class="s1">options</span><span class="s3">.</span><span class="s1">servername </span><span class="s3">= </span><span class="s1">net</span><span class="s3">.</span><span class="s1">isIP</span><span class="s3">(</span><span class="s1">options</span><span class="s3">.</span><span class="s1">host</span><span class="s3">) ? </span><span class="s2">'' </span><span class="s3">: </span><span class="s1">options</span><span class="s3">.</span><span class="s1">host</span><span class="s3">;</span>
  <span class="s3">}</span>

  <span class="s4">return </span><span class="s1">tls</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">(</span><span class="s1">options</span><span class="s3">);</span>
<span class="s3">}</span>

<span class="s7">/**</span>
 <span class="s7">* Abort the handshake and emit an error.</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{WebSocket} websocket The WebSocket instance</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{(http.ClientRequest|net.Socket|tls.Socket)} stream The request to</span>
 <span class="s7">*     abort or the socket to destroy</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{String} message The error message</span>
 <span class="s7">* </span><span class="s8">@private</span>
 <span class="s7">*/</span>
<span class="s4">function </span><span class="s1">abortHandshake</span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">, </span><span class="s1">stream</span><span class="s3">, </span><span class="s1">message</span><span class="s3">) {</span>
  <span class="s1">websocket</span><span class="s3">.</span><span class="s1">_readyState </span><span class="s3">= </span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">CLOSING</span><span class="s3">;</span>

  <span class="s4">const </span><span class="s1">err </span><span class="s3">= </span><span class="s4">new </span><span class="s1">Error</span><span class="s3">(</span><span class="s1">message</span><span class="s3">);</span>
  <span class="s1">Error</span><span class="s3">.</span><span class="s1">captureStackTrace</span><span class="s3">(</span><span class="s1">err</span><span class="s3">, </span><span class="s1">abortHandshake</span><span class="s3">);</span>

  <span class="s4">if </span><span class="s3">(</span><span class="s1">stream</span><span class="s3">.</span><span class="s1">setHeader</span><span class="s3">) {</span>
    <span class="s1">stream</span><span class="s3">[</span><span class="s1">kAborted</span><span class="s3">] = </span><span class="s4">true</span><span class="s3">;</span>
    <span class="s1">stream</span><span class="s3">.</span><span class="s1">abort</span><span class="s3">();</span>

    <span class="s4">if </span><span class="s3">(</span><span class="s1">stream</span><span class="s3">.</span><span class="s1">socket </span><span class="s3">&amp;&amp; !</span><span class="s1">stream</span><span class="s3">.</span><span class="s1">socket</span><span class="s3">.</span><span class="s1">destroyed</span><span class="s3">) {</span>
      <span class="s0">//</span>
      <span class="s0">// On Node.js &gt;= 14.3.0 `request.abort()` does not destroy the socket if</span>
      <span class="s0">// called after the request completed. See</span>
      <span class="s0">// https://github.com/websockets/ws/issues/1869.</span>
      <span class="s0">//</span>
      <span class="s1">stream</span><span class="s3">.</span><span class="s1">socket</span><span class="s3">.</span><span class="s1">destroy</span><span class="s3">();</span>
    <span class="s3">}</span>

    <span class="s1">process</span><span class="s3">.</span><span class="s1">nextTick</span><span class="s3">(</span><span class="s1">emitErrorAndClose</span><span class="s3">, </span><span class="s1">websocket</span><span class="s3">, </span><span class="s1">err</span><span class="s3">);</span>
  <span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
    <span class="s1">stream</span><span class="s3">.</span><span class="s1">destroy</span><span class="s3">(</span><span class="s1">err</span><span class="s3">);</span>
    <span class="s1">stream</span><span class="s3">.</span><span class="s1">once</span><span class="s3">(</span><span class="s2">'error'</span><span class="s3">, </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">.</span><span class="s1">bind</span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">, </span><span class="s2">'error'</span><span class="s3">));</span>
    <span class="s1">stream</span><span class="s3">.</span><span class="s1">once</span><span class="s3">(</span><span class="s2">'close'</span><span class="s3">, </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">emitClose</span><span class="s3">.</span><span class="s1">bind</span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">));</span>
  <span class="s3">}</span>
<span class="s3">}</span>

<span class="s7">/**</span>
 <span class="s7">* Handle cases where the `ping()`, `pong()`, or `send()` methods are called</span>
 <span class="s7">* when the `readyState` attribute is `CLOSING` or `CLOSED`.</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{WebSocket} websocket The WebSocket instance</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{*} [data] The data to send</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Function} [cb] Callback</span>
 <span class="s7">* </span><span class="s8">@private</span>
 <span class="s7">*/</span>
<span class="s4">function </span><span class="s1">sendAfterClose</span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">, </span><span class="s1">data</span><span class="s3">, </span><span class="s1">cb</span><span class="s3">) {</span>
  <span class="s4">if </span><span class="s3">(</span><span class="s1">data</span><span class="s3">) {</span>
    <span class="s4">const </span><span class="s1">length </span><span class="s3">= </span><span class="s1">toBuffer</span><span class="s3">(</span><span class="s1">data</span><span class="s3">).</span><span class="s1">length</span><span class="s3">;</span>

    <span class="s0">//</span>
    <span class="s0">// The `_bufferedAmount` property is used only when the peer is a client and</span>
    <span class="s0">// the opening handshake fails. Under these circumstances, in fact, the</span>
    <span class="s0">// `setSocket()` method is not called, so the `_socket` and `_sender`</span>
    <span class="s0">// properties are set to `null`.</span>
    <span class="s0">//</span>
    <span class="s4">if </span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">) </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_sender</span><span class="s3">.</span><span class="s1">_bufferedBytes </span><span class="s3">+= </span><span class="s1">length</span><span class="s3">;</span>
    <span class="s4">else </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_bufferedAmount </span><span class="s3">+= </span><span class="s1">length</span><span class="s3">;</span>
  <span class="s3">}</span>

  <span class="s4">if </span><span class="s3">(</span><span class="s1">cb</span><span class="s3">) {</span>
    <span class="s4">const </span><span class="s1">err </span><span class="s3">= </span><span class="s4">new </span><span class="s1">Error</span><span class="s3">(</span>
      <span class="s2">`WebSocket is not open: readyState </span><span class="s1">$</span><span class="s3">{</span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">readyState</span><span class="s3">} </span><span class="s2">` </span><span class="s3">+</span>
        <span class="s2">`(</span><span class="s1">$</span><span class="s3">{</span><span class="s1">readyStates</span><span class="s3">[</span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">readyState</span><span class="s3">]}</span><span class="s2">)`</span>
    <span class="s3">);</span>
    <span class="s1">process</span><span class="s3">.</span><span class="s1">nextTick</span><span class="s3">(</span><span class="s1">cb</span><span class="s3">, </span><span class="s1">err</span><span class="s3">);</span>
  <span class="s3">}</span>
<span class="s3">}</span>

<span class="s7">/**</span>
 <span class="s7">* The listener of the `Receiver` `'conclude'` event.</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Number} code The status code</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Buffer} reason The reason for closing</span>
 <span class="s7">* </span><span class="s8">@private</span>
 <span class="s7">*/</span>
<span class="s4">function </span><span class="s1">receiverOnConclude</span><span class="s3">(</span><span class="s1">code</span><span class="s3">, </span><span class="s1">reason</span><span class="s3">) {</span>
  <span class="s4">const </span><span class="s1">websocket </span><span class="s3">= </span><span class="s4">this</span><span class="s3">[</span><span class="s1">kWebSocket</span><span class="s3">];</span>

  <span class="s1">websocket</span><span class="s3">.</span><span class="s1">_closeFrameReceived </span><span class="s3">= </span><span class="s4">true</span><span class="s3">;</span>
  <span class="s1">websocket</span><span class="s3">.</span><span class="s1">_closeMessage </span><span class="s3">= </span><span class="s1">reason</span><span class="s3">;</span>
  <span class="s1">websocket</span><span class="s3">.</span><span class="s1">_closeCode </span><span class="s3">= </span><span class="s1">code</span><span class="s3">;</span>

  <span class="s4">if </span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">[</span><span class="s1">kWebSocket</span><span class="s3">] === </span><span class="s1">undefined</span><span class="s3">) </span><span class="s4">return</span><span class="s3">;</span>

  <span class="s1">websocket</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">removeListener</span><span class="s3">(</span><span class="s2">'data'</span><span class="s3">, </span><span class="s1">socketOnData</span><span class="s3">);</span>
  <span class="s1">process</span><span class="s3">.</span><span class="s1">nextTick</span><span class="s3">(</span><span class="s1">resume</span><span class="s3">, </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">);</span>

  <span class="s4">if </span><span class="s3">(</span><span class="s1">code </span><span class="s3">=== </span><span class="s5">1005</span><span class="s3">) </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">close</span><span class="s3">();</span>
  <span class="s4">else </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">close</span><span class="s3">(</span><span class="s1">code</span><span class="s3">, </span><span class="s1">reason</span><span class="s3">);</span>
<span class="s3">}</span>

<span class="s7">/**</span>
 <span class="s7">* The listener of the `Receiver` `'drain'` event.</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@private</span>
 <span class="s7">*/</span>
<span class="s4">function </span><span class="s1">receiverOnDrain</span><span class="s3">() {</span>
  <span class="s4">const </span><span class="s1">websocket </span><span class="s3">= </span><span class="s4">this</span><span class="s3">[</span><span class="s1">kWebSocket</span><span class="s3">];</span>

  <span class="s4">if </span><span class="s3">(!</span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">isPaused</span><span class="s3">) </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">resume</span><span class="s3">();</span>
<span class="s3">}</span>

<span class="s7">/**</span>
 <span class="s7">* The listener of the `Receiver` `'error'` event.</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{(RangeError|Error)} err The emitted error</span>
 <span class="s7">* </span><span class="s8">@private</span>
 <span class="s7">*/</span>
<span class="s4">function </span><span class="s1">receiverOnError</span><span class="s3">(</span><span class="s1">err</span><span class="s3">) {</span>
  <span class="s4">const </span><span class="s1">websocket </span><span class="s3">= </span><span class="s4">this</span><span class="s3">[</span><span class="s1">kWebSocket</span><span class="s3">];</span>

  <span class="s4">if </span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">[</span><span class="s1">kWebSocket</span><span class="s3">] !== </span><span class="s1">undefined</span><span class="s3">) {</span>
    <span class="s1">websocket</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">removeListener</span><span class="s3">(</span><span class="s2">'data'</span><span class="s3">, </span><span class="s1">socketOnData</span><span class="s3">);</span>

    <span class="s0">//</span>
    <span class="s0">// On Node.js &lt; 14.0.0 the `'error'` event is emitted synchronously. See</span>
    <span class="s0">// https://github.com/websockets/ws/issues/1940.</span>
    <span class="s0">//</span>
    <span class="s1">process</span><span class="s3">.</span><span class="s1">nextTick</span><span class="s3">(</span><span class="s1">resume</span><span class="s3">, </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">);</span>

    <span class="s1">websocket</span><span class="s3">.</span><span class="s1">close</span><span class="s3">(</span><span class="s1">err</span><span class="s3">[</span><span class="s1">kStatusCode</span><span class="s3">]);</span>
  <span class="s3">}</span>

  <span class="s1">websocket</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s2">'error'</span><span class="s3">, </span><span class="s1">err</span><span class="s3">);</span>
<span class="s3">}</span>

<span class="s7">/**</span>
 <span class="s7">* The listener of the `Receiver` `'finish'` event.</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@private</span>
 <span class="s7">*/</span>
<span class="s4">function </span><span class="s1">receiverOnFinish</span><span class="s3">() {</span>
  <span class="s4">this</span><span class="s3">[</span><span class="s1">kWebSocket</span><span class="s3">].</span><span class="s1">emitClose</span><span class="s3">();</span>
<span class="s3">}</span>

<span class="s7">/**</span>
 <span class="s7">* The listener of the `Receiver` `'message'` event.</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Buffer|ArrayBuffer|Buffer[])} data The message</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Boolean} isBinary Specifies whether the message is binary or not</span>
 <span class="s7">* </span><span class="s8">@private</span>
 <span class="s7">*/</span>
<span class="s4">function </span><span class="s1">receiverOnMessage</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">isBinary</span><span class="s3">) {</span>
  <span class="s4">this</span><span class="s3">[</span><span class="s1">kWebSocket</span><span class="s3">].</span><span class="s1">emit</span><span class="s3">(</span><span class="s2">'message'</span><span class="s3">, </span><span class="s1">data</span><span class="s3">, </span><span class="s1">isBinary</span><span class="s3">);</span>
<span class="s3">}</span>

<span class="s7">/**</span>
 <span class="s7">* The listener of the `Receiver` `'ping'` event.</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Buffer} data The data included in the ping frame</span>
 <span class="s7">* </span><span class="s8">@private</span>
 <span class="s7">*/</span>
<span class="s4">function </span><span class="s1">receiverOnPing</span><span class="s3">(</span><span class="s1">data</span><span class="s3">) {</span>
  <span class="s4">const </span><span class="s1">websocket </span><span class="s3">= </span><span class="s4">this</span><span class="s3">[</span><span class="s1">kWebSocket</span><span class="s3">];</span>

  <span class="s1">websocket</span><span class="s3">.</span><span class="s1">pong</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, !</span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_isServer</span><span class="s3">, </span><span class="s1">NOOP</span><span class="s3">);</span>
  <span class="s1">websocket</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s2">'ping'</span><span class="s3">, </span><span class="s1">data</span><span class="s3">);</span>
<span class="s3">}</span>

<span class="s7">/**</span>
 <span class="s7">* The listener of the `Receiver` `'pong'` event.</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Buffer} data The data included in the pong frame</span>
 <span class="s7">* </span><span class="s8">@private</span>
 <span class="s7">*/</span>
<span class="s4">function </span><span class="s1">receiverOnPong</span><span class="s3">(</span><span class="s1">data</span><span class="s3">) {</span>
  <span class="s4">this</span><span class="s3">[</span><span class="s1">kWebSocket</span><span class="s3">].</span><span class="s1">emit</span><span class="s3">(</span><span class="s2">'pong'</span><span class="s3">, </span><span class="s1">data</span><span class="s3">);</span>
<span class="s3">}</span>

<span class="s7">/**</span>
 <span class="s7">* Resume a readable stream</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Readable} stream The readable stream</span>
 <span class="s7">* </span><span class="s8">@private</span>
 <span class="s7">*/</span>
<span class="s4">function </span><span class="s1">resume</span><span class="s3">(</span><span class="s1">stream</span><span class="s3">) {</span>
  <span class="s1">stream</span><span class="s3">.</span><span class="s1">resume</span><span class="s3">();</span>
<span class="s3">}</span>

<span class="s7">/**</span>
 <span class="s7">* The listener of the socket `'close'` event.</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@private</span>
 <span class="s7">*/</span>
<span class="s4">function </span><span class="s1">socketOnClose</span><span class="s3">() {</span>
  <span class="s4">const </span><span class="s1">websocket </span><span class="s3">= </span><span class="s4">this</span><span class="s3">[</span><span class="s1">kWebSocket</span><span class="s3">];</span>

  <span class="s4">this</span><span class="s3">.</span><span class="s1">removeListener</span><span class="s3">(</span><span class="s2">'close'</span><span class="s3">, </span><span class="s1">socketOnClose</span><span class="s3">);</span>
  <span class="s4">this</span><span class="s3">.</span><span class="s1">removeListener</span><span class="s3">(</span><span class="s2">'data'</span><span class="s3">, </span><span class="s1">socketOnData</span><span class="s3">);</span>
  <span class="s4">this</span><span class="s3">.</span><span class="s1">removeListener</span><span class="s3">(</span><span class="s2">'end'</span><span class="s3">, </span><span class="s1">socketOnEnd</span><span class="s3">);</span>

  <span class="s1">websocket</span><span class="s3">.</span><span class="s1">_readyState </span><span class="s3">= </span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">CLOSING</span><span class="s3">;</span>

  <span class="s4">let </span><span class="s1">chunk</span><span class="s3">;</span>

  <span class="s0">//</span>
  <span class="s0">// The close frame might not have been received or the `'end'` event emitted,</span>
  <span class="s0">// for example, if the socket was destroyed due to an error. Ensure that the</span>
  <span class="s0">// `receiver` stream is closed after writing any remaining buffered data to</span>
  <span class="s0">// it. If the readable side of the socket is in flowing mode then there is no</span>
  <span class="s0">// buffered data as everything has been already written and `readable.read()`</span>
  <span class="s0">// will return `null`. If instead, the socket is paused, any possible buffered</span>
  <span class="s0">// data will be read as a single chunk.</span>
  <span class="s0">//</span>
  <span class="s4">if </span><span class="s3">(</span>
    <span class="s3">!</span><span class="s4">this</span><span class="s3">.</span><span class="s1">_readableState</span><span class="s3">.</span><span class="s1">endEmitted </span><span class="s3">&amp;&amp;</span>
    <span class="s3">!</span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_closeFrameReceived </span><span class="s3">&amp;&amp;</span>
    <span class="s3">!</span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_receiver</span><span class="s3">.</span><span class="s1">_writableState</span><span class="s3">.</span><span class="s1">errorEmitted </span><span class="s3">&amp;&amp;</span>
    <span class="s3">(</span><span class="s1">chunk </span><span class="s3">= </span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()) !== </span><span class="s4">null</span>
  <span class="s3">) {</span>
    <span class="s1">websocket</span><span class="s3">.</span><span class="s1">_receiver</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">chunk</span><span class="s3">);</span>
  <span class="s3">}</span>

  <span class="s1">websocket</span><span class="s3">.</span><span class="s1">_receiver</span><span class="s3">.</span><span class="s1">end</span><span class="s3">();</span>

  <span class="s4">this</span><span class="s3">[</span><span class="s1">kWebSocket</span><span class="s3">] = </span><span class="s1">undefined</span><span class="s3">;</span>

  <span class="s1">clearTimeout</span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">.</span><span class="s1">_closeTimer</span><span class="s3">);</span>

  <span class="s4">if </span><span class="s3">(</span>
    <span class="s1">websocket</span><span class="s3">.</span><span class="s1">_receiver</span><span class="s3">.</span><span class="s1">_writableState</span><span class="s3">.</span><span class="s1">finished </span><span class="s3">||</span>
    <span class="s1">websocket</span><span class="s3">.</span><span class="s1">_receiver</span><span class="s3">.</span><span class="s1">_writableState</span><span class="s3">.</span><span class="s1">errorEmitted</span>
  <span class="s3">) {</span>
    <span class="s1">websocket</span><span class="s3">.</span><span class="s1">emitClose</span><span class="s3">();</span>
  <span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
    <span class="s1">websocket</span><span class="s3">.</span><span class="s1">_receiver</span><span class="s3">.</span><span class="s1">on</span><span class="s3">(</span><span class="s2">'error'</span><span class="s3">, </span><span class="s1">receiverOnFinish</span><span class="s3">);</span>
    <span class="s1">websocket</span><span class="s3">.</span><span class="s1">_receiver</span><span class="s3">.</span><span class="s1">on</span><span class="s3">(</span><span class="s2">'finish'</span><span class="s3">, </span><span class="s1">receiverOnFinish</span><span class="s3">);</span>
  <span class="s3">}</span>
<span class="s3">}</span>

<span class="s7">/**</span>
 <span class="s7">* The listener of the socket `'data'` event.</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Buffer} chunk A chunk of data</span>
 <span class="s7">* </span><span class="s8">@private</span>
 <span class="s7">*/</span>
<span class="s4">function </span><span class="s1">socketOnData</span><span class="s3">(</span><span class="s1">chunk</span><span class="s3">) {</span>
  <span class="s4">if </span><span class="s3">(!</span><span class="s4">this</span><span class="s3">[</span><span class="s1">kWebSocket</span><span class="s3">].</span><span class="s1">_receiver</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">chunk</span><span class="s3">)) {</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">pause</span><span class="s3">();</span>
  <span class="s3">}</span>
<span class="s3">}</span>

<span class="s7">/**</span>
 <span class="s7">* The listener of the socket `'end'` event.</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@private</span>
 <span class="s7">*/</span>
<span class="s4">function </span><span class="s1">socketOnEnd</span><span class="s3">() {</span>
  <span class="s4">const </span><span class="s1">websocket </span><span class="s3">= </span><span class="s4">this</span><span class="s3">[</span><span class="s1">kWebSocket</span><span class="s3">];</span>

  <span class="s1">websocket</span><span class="s3">.</span><span class="s1">_readyState </span><span class="s3">= </span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">CLOSING</span><span class="s3">;</span>
  <span class="s1">websocket</span><span class="s3">.</span><span class="s1">_receiver</span><span class="s3">.</span><span class="s1">end</span><span class="s3">();</span>
  <span class="s4">this</span><span class="s3">.</span><span class="s1">end</span><span class="s3">();</span>
<span class="s3">}</span>

<span class="s7">/**</span>
 <span class="s7">* The listener of the socket `'error'` event.</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@private</span>
 <span class="s7">*/</span>
<span class="s4">function </span><span class="s1">socketOnError</span><span class="s3">() {</span>
  <span class="s4">const </span><span class="s1">websocket </span><span class="s3">= </span><span class="s4">this</span><span class="s3">[</span><span class="s1">kWebSocket</span><span class="s3">];</span>

  <span class="s4">this</span><span class="s3">.</span><span class="s1">removeListener</span><span class="s3">(</span><span class="s2">'error'</span><span class="s3">, </span><span class="s1">socketOnError</span><span class="s3">);</span>
  <span class="s4">this</span><span class="s3">.</span><span class="s1">on</span><span class="s3">(</span><span class="s2">'error'</span><span class="s3">, </span><span class="s1">NOOP</span><span class="s3">);</span>

  <span class="s4">if </span><span class="s3">(</span><span class="s1">websocket</span><span class="s3">) {</span>
    <span class="s1">websocket</span><span class="s3">.</span><span class="s1">_readyState </span><span class="s3">= </span><span class="s1">WebSocket</span><span class="s3">.</span><span class="s1">CLOSING</span><span class="s3">;</span>
    <span class="s4">this</span><span class="s3">.</span><span class="s1">destroy</span><span class="s3">();</span>
  <span class="s3">}</span>
<span class="s3">}</span>
</pre>
</body>
</html>