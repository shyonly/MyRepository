<html>
<head>
<title>volume.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #6aab73;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #cf8e6d;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
.s6 { color: #5f826b; font-style: italic;}
.s7 { color: #67a37c; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
volume.js</font>
</center></td></tr></table>
<pre><span class="s0">&quot;use strict&quot;</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">__extends </span><span class="s1">= (</span><span class="s3">this </span><span class="s1">&amp;&amp; </span><span class="s3">this</span><span class="s1">.</span><span class="s2">__extends</span><span class="s1">) || (</span><span class="s3">function </span><span class="s1">() {</span>
    <span class="s3">var </span><span class="s2">extendStatics </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">d</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) {</span>
        <span class="s2">extendStatics </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">setPrototypeOf </span><span class="s1">||</span>
            <span class="s1">({ </span><span class="s2">__proto__</span><span class="s1">: [] } </span><span class="s3">instanceof </span><span class="s2">Array </span><span class="s1">&amp;&amp; </span><span class="s3">function </span><span class="s1">(</span><span class="s2">d</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) { </span><span class="s2">d</span><span class="s1">.</span><span class="s2">__proto__ </span><span class="s1">= </span><span class="s2">b</span><span class="s1">; }) ||</span>
            <span class="s3">function </span><span class="s1">(</span><span class="s2">d</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) { </span><span class="s3">for </span><span class="s1">(</span><span class="s3">var </span><span class="s2">p </span><span class="s3">in </span><span class="s2">b</span><span class="s1">) </span><span class="s3">if </span><span class="s1">(</span><span class="s2">Object</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">hasOwnProperty</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s2">b</span><span class="s1">, </span><span class="s2">p</span><span class="s1">)) </span><span class="s2">d</span><span class="s1">[</span><span class="s2">p</span><span class="s1">] = </span><span class="s2">b</span><span class="s1">[</span><span class="s2">p</span><span class="s1">]; };</span>
        <span class="s3">return </span><span class="s2">extendStatics</span><span class="s1">(</span><span class="s2">d</span><span class="s1">, </span><span class="s2">b</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s3">return function </span><span class="s1">(</span><span class="s2">d</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">b </span><span class="s1">!== </span><span class="s0">&quot;function&quot; </span><span class="s1">&amp;&amp; </span><span class="s2">b </span><span class="s1">!== </span><span class="s3">null</span><span class="s1">)</span>
            <span class="s3">throw new </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s0">&quot;Class extends value &quot; </span><span class="s1">+ </span><span class="s2">String</span><span class="s1">(</span><span class="s2">b</span><span class="s1">) + </span><span class="s0">&quot; is not a constructor or null&quot;</span><span class="s1">);</span>
        <span class="s2">extendStatics</span><span class="s1">(</span><span class="s2">d</span><span class="s1">, </span><span class="s2">b</span><span class="s1">);</span>
        <span class="s3">function </span><span class="s2">__</span><span class="s1">() { </span><span class="s3">this</span><span class="s1">.</span><span class="s2">constructor </span><span class="s1">= </span><span class="s2">d</span><span class="s1">; }</span>
        <span class="s2">d</span><span class="s1">.</span><span class="s2">prototype </span><span class="s1">= </span><span class="s2">b </span><span class="s1">=== </span><span class="s3">null </span><span class="s1">? </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s2">b</span><span class="s1">) : (</span><span class="s2">__</span><span class="s1">.</span><span class="s2">prototype </span><span class="s1">= </span><span class="s2">b</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">, </span><span class="s3">new </span><span class="s2">__</span><span class="s1">());</span>
    <span class="s1">};</span>
<span class="s1">})();</span>
<span class="s3">var </span><span class="s2">__spreadArray </span><span class="s1">= (</span><span class="s3">this </span><span class="s1">&amp;&amp; </span><span class="s3">this</span><span class="s1">.</span><span class="s2">__spreadArray</span><span class="s1">) || </span><span class="s3">function </span><span class="s1">(</span><span class="s2">to</span><span class="s1">, </span><span class="s2">from</span><span class="s1">, </span><span class="s2">pack</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">pack </span><span class="s1">|| </span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s4">2</span><span class="s1">) </span><span class="s3">for </span><span class="s1">(</span><span class="s3">var </span><span class="s2">i </span><span class="s1">= </span><span class="s4">0</span><span class="s1">, </span><span class="s2">l </span><span class="s1">= </span><span class="s2">from</span><span class="s1">.</span><span class="s2">length</span><span class="s1">, </span><span class="s2">ar</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">l</span><span class="s1">; </span><span class="s2">i</span><span class="s1">++) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">ar </span><span class="s1">|| !(</span><span class="s2">i </span><span class="s3">in </span><span class="s2">from</span><span class="s1">)) {</span>
            <span class="s3">if </span><span class="s1">(!</span><span class="s2">ar</span><span class="s1">) </span><span class="s2">ar </span><span class="s1">= </span><span class="s2">Array</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s2">from</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s2">i</span><span class="s1">);</span>
            <span class="s2">ar</span><span class="s1">[</span><span class="s2">i</span><span class="s1">] = </span><span class="s2">from</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s3">return </span><span class="s2">to</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">ar </span><span class="s1">|| </span><span class="s2">Array</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s2">from</span><span class="s1">));</span>
<span class="s1">};</span>
<span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">exports</span><span class="s1">, </span><span class="s0">&quot;__esModule&quot;</span><span class="s1">, { </span><span class="s2">value</span><span class="s1">: </span><span class="s3">true </span><span class="s1">});</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">FSWatcher </span><span class="s1">= </span><span class="s2">exports</span><span class="s1">.</span><span class="s2">StatWatcher </span><span class="s1">= </span><span class="s2">exports</span><span class="s1">.</span><span class="s2">Volume </span><span class="s1">= </span><span class="s2">exports</span><span class="s1">.</span><span class="s2">toUnixTimestamp </span><span class="s1">= </span><span class="s2">exports</span><span class="s1">.</span><span class="s2">bufferToEncoding </span><span class="s1">= </span><span class="s2">exports</span><span class="s1">.</span><span class="s2">dataToBuffer </span><span class="s1">= </span><span class="s2">exports</span><span class="s1">.</span><span class="s2">dataToStr </span><span class="s1">= </span><span class="s2">exports</span><span class="s1">.</span><span class="s2">pathToSteps </span><span class="s1">= </span><span class="s2">exports</span><span class="s1">.</span><span class="s2">filenameToSteps </span><span class="s1">= </span><span class="s2">exports</span><span class="s1">.</span><span class="s2">pathToFilename </span><span class="s1">= </span><span class="s2">exports</span><span class="s1">.</span><span class="s2">flagsToNumber </span><span class="s1">= </span><span class="s2">exports</span><span class="s1">.</span><span class="s2">FLAGS </span><span class="s1">= </span><span class="s3">void </span><span class="s4">0</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">pathModule </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;path&quot;</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">node_1 </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;./node&quot;</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">Stats_1 </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;./Stats&quot;</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">Dirent_1 </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;./Dirent&quot;</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">buffer_1 </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;./internal/buffer&quot;</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">setImmediate_1 </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;./setImmediate&quot;</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">process_1 </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;./process&quot;</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">setTimeoutUnref_1 </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;./setTimeoutUnref&quot;</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">stream_1 </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;stream&quot;</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">constants_1 </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;./constants&quot;</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">events_1 </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;events&quot;</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">encoding_1 </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;./encoding&quot;</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">errors </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;./internal/errors&quot;</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">util </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;util&quot;</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">promises_1 </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;./promises&quot;</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">resolveCrossPlatform </span><span class="s1">= </span><span class="s2">pathModule</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">O_RDONLY </span><span class="s1">= </span><span class="s2">constants_1</span><span class="s1">.</span><span class="s2">constants</span><span class="s1">.</span><span class="s2">O_RDONLY</span><span class="s1">, </span><span class="s2">O_WRONLY </span><span class="s1">= </span><span class="s2">constants_1</span><span class="s1">.</span><span class="s2">constants</span><span class="s1">.</span><span class="s2">O_WRONLY</span><span class="s1">, </span><span class="s2">O_RDWR </span><span class="s1">= </span><span class="s2">constants_1</span><span class="s1">.</span><span class="s2">constants</span><span class="s1">.</span><span class="s2">O_RDWR</span><span class="s1">, </span><span class="s2">O_CREAT </span><span class="s1">= </span><span class="s2">constants_1</span><span class="s1">.</span><span class="s2">constants</span><span class="s1">.</span><span class="s2">O_CREAT</span><span class="s1">, </span><span class="s2">O_EXCL </span><span class="s1">= </span><span class="s2">constants_1</span><span class="s1">.</span><span class="s2">constants</span><span class="s1">.</span><span class="s2">O_EXCL</span><span class="s1">, </span><span class="s2">O_TRUNC </span><span class="s1">= </span><span class="s2">constants_1</span><span class="s1">.</span><span class="s2">constants</span><span class="s1">.</span><span class="s2">O_TRUNC</span><span class="s1">, </span><span class="s2">O_APPEND </span><span class="s1">= </span><span class="s2">constants_1</span><span class="s1">.</span><span class="s2">constants</span><span class="s1">.</span><span class="s2">O_APPEND</span><span class="s1">, </span><span class="s2">O_SYNC </span><span class="s1">= </span><span class="s2">constants_1</span><span class="s1">.</span><span class="s2">constants</span><span class="s1">.</span><span class="s2">O_SYNC</span><span class="s1">, </span><span class="s2">O_DIRECTORY </span><span class="s1">= </span><span class="s2">constants_1</span><span class="s1">.</span><span class="s2">constants</span><span class="s1">.</span><span class="s2">O_DIRECTORY</span><span class="s1">, </span><span class="s2">F_OK </span><span class="s1">= </span><span class="s2">constants_1</span><span class="s1">.</span><span class="s2">constants</span><span class="s1">.</span><span class="s2">F_OK</span><span class="s1">, </span><span class="s2">COPYFILE_EXCL </span><span class="s1">= </span><span class="s2">constants_1</span><span class="s1">.</span><span class="s2">constants</span><span class="s1">.</span><span class="s2">COPYFILE_EXCL</span><span class="s1">, </span><span class="s2">COPYFILE_FICLONE_FORCE </span><span class="s1">= </span><span class="s2">constants_1</span><span class="s1">.</span><span class="s2">constants</span><span class="s1">.</span><span class="s2">COPYFILE_FICLONE_FORCE</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">_a </span><span class="s1">= </span><span class="s2">pathModule</span><span class="s1">.</span><span class="s2">posix </span><span class="s1">? </span><span class="s2">pathModule</span><span class="s1">.</span><span class="s2">posix </span><span class="s1">: </span><span class="s2">pathModule</span><span class="s1">, </span><span class="s2">sep </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">.</span><span class="s2">sep</span><span class="s1">, </span><span class="s2">relative </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">.</span><span class="s2">relative</span><span class="s1">, </span><span class="s2">join </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">.</span><span class="s2">join</span><span class="s1">, </span><span class="s2">dirname </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">.</span><span class="s2">dirname</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">isWin </span><span class="s1">= </span><span class="s2">process_1</span><span class="s1">.</span><span class="s2">default</span><span class="s1">.</span><span class="s2">platform </span><span class="s1">=== </span><span class="s0">'win32'</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">kMinPoolSpace </span><span class="s1">= </span><span class="s4">128</span><span class="s1">;</span>
<span class="s5">// const kMaxLength = require('buffer').kMaxLength;</span>
<span class="s5">// ---------------------------------------- Error messages</span>
<span class="s5">// TODO: Use `internal/errors.js` in the future.</span>
<span class="s3">var </span><span class="s2">ERRSTR </span><span class="s1">= {</span>
    <span class="s2">PATH_STR</span><span class="s1">: </span><span class="s0">'path must be a string or Buffer'</span><span class="s1">,</span>
    <span class="s5">// FD:             'file descriptor must be a unsigned 32-bit integer',</span>
    <span class="s2">FD</span><span class="s1">: </span><span class="s0">'fd must be a file descriptor'</span><span class="s1">,</span>
    <span class="s2">MODE_INT</span><span class="s1">: </span><span class="s0">'mode must be an int'</span><span class="s1">,</span>
    <span class="s2">CB</span><span class="s1">: </span><span class="s0">'callback must be a function'</span><span class="s1">,</span>
    <span class="s2">UID</span><span class="s1">: </span><span class="s0">'uid must be an unsigned int'</span><span class="s1">,</span>
    <span class="s2">GID</span><span class="s1">: </span><span class="s0">'gid must be an unsigned int'</span><span class="s1">,</span>
    <span class="s2">LEN</span><span class="s1">: </span><span class="s0">'len must be an integer'</span><span class="s1">,</span>
    <span class="s2">ATIME</span><span class="s1">: </span><span class="s0">'atime must be an integer'</span><span class="s1">,</span>
    <span class="s2">MTIME</span><span class="s1">: </span><span class="s0">'mtime must be an integer'</span><span class="s1">,</span>
    <span class="s2">PREFIX</span><span class="s1">: </span><span class="s0">'filename prefix is required'</span><span class="s1">,</span>
    <span class="s2">BUFFER</span><span class="s1">: </span><span class="s0">'buffer must be an instance of Buffer or StaticBuffer'</span><span class="s1">,</span>
    <span class="s2">OFFSET</span><span class="s1">: </span><span class="s0">'offset must be an integer'</span><span class="s1">,</span>
    <span class="s2">LENGTH</span><span class="s1">: </span><span class="s0">'length must be an integer'</span><span class="s1">,</span>
    <span class="s2">POSITION</span><span class="s1">: </span><span class="s0">'position must be an integer'</span><span class="s1">,</span>
<span class="s1">};</span>
<span class="s3">var </span><span class="s2">ERRSTR_OPTS </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">tipeof</span><span class="s1">) { </span><span class="s3">return </span><span class="s0">&quot;Expected options to be either an object or a string, but got &quot;</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">tipeof</span><span class="s1">, </span><span class="s0">&quot; instead&quot;</span><span class="s1">); };</span>
<span class="s5">// const ERRSTR_FLAG = flag =&gt; `Unknown file open flag: ${flag}`;</span>
<span class="s3">var </span><span class="s2">ENOENT </span><span class="s1">= </span><span class="s0">'ENOENT'</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">EBADF </span><span class="s1">= </span><span class="s0">'EBADF'</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">EINVAL </span><span class="s1">= </span><span class="s0">'EINVAL'</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">EPERM </span><span class="s1">= </span><span class="s0">'EPERM'</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">EPROTO </span><span class="s1">= </span><span class="s0">'EPROTO'</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">EEXIST </span><span class="s1">= </span><span class="s0">'EEXIST'</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">ENOTDIR </span><span class="s1">= </span><span class="s0">'ENOTDIR'</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">EMFILE </span><span class="s1">= </span><span class="s0">'EMFILE'</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">EACCES </span><span class="s1">= </span><span class="s0">'EACCES'</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">EISDIR </span><span class="s1">= </span><span class="s0">'EISDIR'</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">ENOTEMPTY </span><span class="s1">= </span><span class="s0">'ENOTEMPTY'</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">ENOSYS </span><span class="s1">= </span><span class="s0">'ENOSYS'</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">ERR_FS_EISDIR </span><span class="s1">= </span><span class="s0">'ERR_FS_EISDIR'</span><span class="s1">;</span>
<span class="s3">function </span><span class="s2">formatError</span><span class="s1">(</span><span class="s2">errorCode</span><span class="s1">, </span><span class="s2">func</span><span class="s1">, </span><span class="s2">path</span><span class="s1">, </span><span class="s2">path2</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">func </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">func </span><span class="s1">= </span><span class="s0">''</span><span class="s1">; }</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">path </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">path </span><span class="s1">= </span><span class="s0">''</span><span class="s1">; }</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">path2 </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">path2 </span><span class="s1">= </span><span class="s0">''</span><span class="s1">; }</span>
    <span class="s3">var </span><span class="s2">pathFormatted </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">path</span><span class="s1">)</span>
        <span class="s2">pathFormatted </span><span class="s1">= </span><span class="s0">&quot; '&quot;</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s0">&quot;'&quot;</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">path2</span><span class="s1">)</span>
        <span class="s2">pathFormatted </span><span class="s1">+= </span><span class="s0">&quot; -&gt; '&quot;</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">path2</span><span class="s1">, </span><span class="s0">&quot;'&quot;</span><span class="s1">);</span>
    <span class="s3">switch </span><span class="s1">(</span><span class="s2">errorCode</span><span class="s1">) {</span>
        <span class="s3">case </span><span class="s2">ENOENT</span><span class="s1">:</span>
            <span class="s3">return </span><span class="s0">&quot;ENOENT: no such file or directory, &quot;</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">func</span><span class="s1">).</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">pathFormatted</span><span class="s1">);</span>
        <span class="s3">case </span><span class="s2">EBADF</span><span class="s1">:</span>
            <span class="s3">return </span><span class="s0">&quot;EBADF: bad file descriptor, &quot;</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">func</span><span class="s1">).</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">pathFormatted</span><span class="s1">);</span>
        <span class="s3">case </span><span class="s2">EINVAL</span><span class="s1">:</span>
            <span class="s3">return </span><span class="s0">&quot;EINVAL: invalid argument, &quot;</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">func</span><span class="s1">).</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">pathFormatted</span><span class="s1">);</span>
        <span class="s3">case </span><span class="s2">EPERM</span><span class="s1">:</span>
            <span class="s3">return </span><span class="s0">&quot;EPERM: operation not permitted, &quot;</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">func</span><span class="s1">).</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">pathFormatted</span><span class="s1">);</span>
        <span class="s3">case </span><span class="s2">EPROTO</span><span class="s1">:</span>
            <span class="s3">return </span><span class="s0">&quot;EPROTO: protocol error, &quot;</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">func</span><span class="s1">).</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">pathFormatted</span><span class="s1">);</span>
        <span class="s3">case </span><span class="s2">EEXIST</span><span class="s1">:</span>
            <span class="s3">return </span><span class="s0">&quot;EEXIST: file already exists, &quot;</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">func</span><span class="s1">).</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">pathFormatted</span><span class="s1">);</span>
        <span class="s3">case </span><span class="s2">ENOTDIR</span><span class="s1">:</span>
            <span class="s3">return </span><span class="s0">&quot;ENOTDIR: not a directory, &quot;</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">func</span><span class="s1">).</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">pathFormatted</span><span class="s1">);</span>
        <span class="s3">case </span><span class="s2">EISDIR</span><span class="s1">:</span>
            <span class="s3">return </span><span class="s0">&quot;EISDIR: illegal operation on a directory, &quot;</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">func</span><span class="s1">).</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">pathFormatted</span><span class="s1">);</span>
        <span class="s3">case </span><span class="s2">EACCES</span><span class="s1">:</span>
            <span class="s3">return </span><span class="s0">&quot;EACCES: permission denied, &quot;</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">func</span><span class="s1">).</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">pathFormatted</span><span class="s1">);</span>
        <span class="s3">case </span><span class="s2">ENOTEMPTY</span><span class="s1">:</span>
            <span class="s3">return </span><span class="s0">&quot;ENOTEMPTY: directory not empty, &quot;</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">func</span><span class="s1">).</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">pathFormatted</span><span class="s1">);</span>
        <span class="s3">case </span><span class="s2">EMFILE</span><span class="s1">:</span>
            <span class="s3">return </span><span class="s0">&quot;EMFILE: too many open files, &quot;</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">func</span><span class="s1">).</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">pathFormatted</span><span class="s1">);</span>
        <span class="s3">case </span><span class="s2">ENOSYS</span><span class="s1">:</span>
            <span class="s3">return </span><span class="s0">&quot;ENOSYS: function not implemented, &quot;</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">func</span><span class="s1">).</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">pathFormatted</span><span class="s1">);</span>
        <span class="s3">case </span><span class="s2">ERR_FS_EISDIR</span><span class="s1">:</span>
            <span class="s3">return </span><span class="s0">&quot;[ERR_FS_EISDIR]: Path is a directory: &quot;</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">func</span><span class="s1">, </span><span class="s0">&quot; returned EISDIR (is a directory) &quot;</span><span class="s1">).</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
        <span class="s3">default</span><span class="s1">:</span>
            <span class="s3">return </span><span class="s0">&quot;&quot;</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">errorCode</span><span class="s1">, </span><span class="s0">&quot;: error occurred, &quot;</span><span class="s1">).</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">func</span><span class="s1">).</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">pathFormatted</span><span class="s1">);</span>
    <span class="s1">}</span>
<span class="s1">}</span>
<span class="s3">function </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">errorCode</span><span class="s1">, </span><span class="s2">func</span><span class="s1">, </span><span class="s2">path</span><span class="s1">, </span><span class="s2">path2</span><span class="s1">, </span><span class="s2">Constructor</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">func </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">func </span><span class="s1">= </span><span class="s0">''</span><span class="s1">; }</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">path </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">path </span><span class="s1">= </span><span class="s0">''</span><span class="s1">; }</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">path2 </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">path2 </span><span class="s1">= </span><span class="s0">''</span><span class="s1">; }</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">Constructor </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">Constructor </span><span class="s1">= </span><span class="s2">Error</span><span class="s1">; }</span>
    <span class="s3">var </span><span class="s2">error </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Constructor</span><span class="s1">(</span><span class="s2">formatError</span><span class="s1">(</span><span class="s2">errorCode</span><span class="s1">, </span><span class="s2">func</span><span class="s1">, </span><span class="s2">path</span><span class="s1">, </span><span class="s2">path2</span><span class="s1">));</span>
    <span class="s2">error</span><span class="s1">.</span><span class="s2">code </span><span class="s1">= </span><span class="s2">errorCode</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">path</span><span class="s1">) {</span>
        <span class="s2">error</span><span class="s1">.</span><span class="s2">path </span><span class="s1">= </span><span class="s2">path</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">return </span><span class="s2">error</span><span class="s1">;</span>
<span class="s1">}</span>
<span class="s5">// ---------------------------------------- Flags</span>
<span class="s5">// List of file `flags` as defined by Node.</span>
<span class="s3">var </span><span class="s2">FLAGS</span><span class="s1">;</span>
<span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">FLAGS</span><span class="s1">) {</span>
    <span class="s5">// Open file for reading. An exception occurs if the file does not exist.</span>
    <span class="s2">FLAGS</span><span class="s1">[</span><span class="s2">FLAGS</span><span class="s1">[</span><span class="s0">&quot;r&quot;</span><span class="s1">] = </span><span class="s2">O_RDONLY</span><span class="s1">] = </span><span class="s0">&quot;r&quot;</span><span class="s1">;</span>
    <span class="s5">// Open file for reading and writing. An exception occurs if the file does not exist.</span>
    <span class="s2">FLAGS</span><span class="s1">[</span><span class="s2">FLAGS</span><span class="s1">[</span><span class="s0">&quot;r+&quot;</span><span class="s1">] = </span><span class="s2">O_RDWR</span><span class="s1">] = </span><span class="s0">&quot;r+&quot;</span><span class="s1">;</span>
    <span class="s5">// Open file for reading in synchronous mode. Instructs the operating system to bypass the local file system cache.</span>
    <span class="s2">FLAGS</span><span class="s1">[</span><span class="s2">FLAGS</span><span class="s1">[</span><span class="s0">&quot;rs&quot;</span><span class="s1">] = </span><span class="s2">O_RDONLY </span><span class="s1">| </span><span class="s2">O_SYNC</span><span class="s1">] = </span><span class="s0">&quot;rs&quot;</span><span class="s1">;</span>
    <span class="s2">FLAGS</span><span class="s1">[</span><span class="s2">FLAGS</span><span class="s1">[</span><span class="s0">&quot;sr&quot;</span><span class="s1">] = </span><span class="s2">FLAGS</span><span class="s1">.</span><span class="s2">rs</span><span class="s1">] = </span><span class="s0">&quot;sr&quot;</span><span class="s1">;</span>
    <span class="s5">// Open file for reading and writing, telling the OS to open it synchronously. See notes for 'rs' about using this with caution.</span>
    <span class="s2">FLAGS</span><span class="s1">[</span><span class="s2">FLAGS</span><span class="s1">[</span><span class="s0">&quot;rs+&quot;</span><span class="s1">] = </span><span class="s2">O_RDWR </span><span class="s1">| </span><span class="s2">O_SYNC</span><span class="s1">] = </span><span class="s0">&quot;rs+&quot;</span><span class="s1">;</span>
    <span class="s2">FLAGS</span><span class="s1">[</span><span class="s2">FLAGS</span><span class="s1">[</span><span class="s0">&quot;sr+&quot;</span><span class="s1">] = </span><span class="s2">FLAGS</span><span class="s1">[</span><span class="s0">'rs+'</span><span class="s1">]] = </span><span class="s0">&quot;sr+&quot;</span><span class="s1">;</span>
    <span class="s5">// Open file for writing. The file is created (if it does not exist) or truncated (if it exists).</span>
    <span class="s2">FLAGS</span><span class="s1">[</span><span class="s2">FLAGS</span><span class="s1">[</span><span class="s0">&quot;w&quot;</span><span class="s1">] = </span><span class="s2">O_WRONLY </span><span class="s1">| </span><span class="s2">O_CREAT </span><span class="s1">| </span><span class="s2">O_TRUNC</span><span class="s1">] = </span><span class="s0">&quot;w&quot;</span><span class="s1">;</span>
    <span class="s5">// Like 'w' but fails if path exists.</span>
    <span class="s2">FLAGS</span><span class="s1">[</span><span class="s2">FLAGS</span><span class="s1">[</span><span class="s0">&quot;wx&quot;</span><span class="s1">] = </span><span class="s2">O_WRONLY </span><span class="s1">| </span><span class="s2">O_CREAT </span><span class="s1">| </span><span class="s2">O_TRUNC </span><span class="s1">| </span><span class="s2">O_EXCL</span><span class="s1">] = </span><span class="s0">&quot;wx&quot;</span><span class="s1">;</span>
    <span class="s2">FLAGS</span><span class="s1">[</span><span class="s2">FLAGS</span><span class="s1">[</span><span class="s0">&quot;xw&quot;</span><span class="s1">] = </span><span class="s2">FLAGS</span><span class="s1">.</span><span class="s2">wx</span><span class="s1">] = </span><span class="s0">&quot;xw&quot;</span><span class="s1">;</span>
    <span class="s5">// Open file for reading and writing. The file is created (if it does not exist) or truncated (if it exists).</span>
    <span class="s2">FLAGS</span><span class="s1">[</span><span class="s2">FLAGS</span><span class="s1">[</span><span class="s0">&quot;w+&quot;</span><span class="s1">] = </span><span class="s2">O_RDWR </span><span class="s1">| </span><span class="s2">O_CREAT </span><span class="s1">| </span><span class="s2">O_TRUNC</span><span class="s1">] = </span><span class="s0">&quot;w+&quot;</span><span class="s1">;</span>
    <span class="s5">// Like 'w+' but fails if path exists.</span>
    <span class="s2">FLAGS</span><span class="s1">[</span><span class="s2">FLAGS</span><span class="s1">[</span><span class="s0">&quot;wx+&quot;</span><span class="s1">] = </span><span class="s2">O_RDWR </span><span class="s1">| </span><span class="s2">O_CREAT </span><span class="s1">| </span><span class="s2">O_TRUNC </span><span class="s1">| </span><span class="s2">O_EXCL</span><span class="s1">] = </span><span class="s0">&quot;wx+&quot;</span><span class="s1">;</span>
    <span class="s2">FLAGS</span><span class="s1">[</span><span class="s2">FLAGS</span><span class="s1">[</span><span class="s0">&quot;xw+&quot;</span><span class="s1">] = </span><span class="s2">FLAGS</span><span class="s1">[</span><span class="s0">'wx+'</span><span class="s1">]] = </span><span class="s0">&quot;xw+&quot;</span><span class="s1">;</span>
    <span class="s5">// Open file for appending. The file is created if it does not exist.</span>
    <span class="s2">FLAGS</span><span class="s1">[</span><span class="s2">FLAGS</span><span class="s1">[</span><span class="s0">&quot;a&quot;</span><span class="s1">] = </span><span class="s2">O_WRONLY </span><span class="s1">| </span><span class="s2">O_APPEND </span><span class="s1">| </span><span class="s2">O_CREAT</span><span class="s1">] = </span><span class="s0">&quot;a&quot;</span><span class="s1">;</span>
    <span class="s5">// Like 'a' but fails if path exists.</span>
    <span class="s2">FLAGS</span><span class="s1">[</span><span class="s2">FLAGS</span><span class="s1">[</span><span class="s0">&quot;ax&quot;</span><span class="s1">] = </span><span class="s2">O_WRONLY </span><span class="s1">| </span><span class="s2">O_APPEND </span><span class="s1">| </span><span class="s2">O_CREAT </span><span class="s1">| </span><span class="s2">O_EXCL</span><span class="s1">] = </span><span class="s0">&quot;ax&quot;</span><span class="s1">;</span>
    <span class="s2">FLAGS</span><span class="s1">[</span><span class="s2">FLAGS</span><span class="s1">[</span><span class="s0">&quot;xa&quot;</span><span class="s1">] = </span><span class="s2">FLAGS</span><span class="s1">.</span><span class="s2">ax</span><span class="s1">] = </span><span class="s0">&quot;xa&quot;</span><span class="s1">;</span>
    <span class="s5">// Open file for reading and appending. The file is created if it does not exist.</span>
    <span class="s2">FLAGS</span><span class="s1">[</span><span class="s2">FLAGS</span><span class="s1">[</span><span class="s0">&quot;a+&quot;</span><span class="s1">] = </span><span class="s2">O_RDWR </span><span class="s1">| </span><span class="s2">O_APPEND </span><span class="s1">| </span><span class="s2">O_CREAT</span><span class="s1">] = </span><span class="s0">&quot;a+&quot;</span><span class="s1">;</span>
    <span class="s5">// Like 'a+' but fails if path exists.</span>
    <span class="s2">FLAGS</span><span class="s1">[</span><span class="s2">FLAGS</span><span class="s1">[</span><span class="s0">&quot;ax+&quot;</span><span class="s1">] = </span><span class="s2">O_RDWR </span><span class="s1">| </span><span class="s2">O_APPEND </span><span class="s1">| </span><span class="s2">O_CREAT </span><span class="s1">| </span><span class="s2">O_EXCL</span><span class="s1">] = </span><span class="s0">&quot;ax+&quot;</span><span class="s1">;</span>
    <span class="s2">FLAGS</span><span class="s1">[</span><span class="s2">FLAGS</span><span class="s1">[</span><span class="s0">&quot;xa+&quot;</span><span class="s1">] = </span><span class="s2">FLAGS</span><span class="s1">[</span><span class="s0">'ax+'</span><span class="s1">]] = </span><span class="s0">&quot;xa+&quot;</span><span class="s1">;</span>
<span class="s1">})(</span><span class="s2">FLAGS </span><span class="s1">= </span><span class="s2">exports</span><span class="s1">.</span><span class="s2">FLAGS </span><span class="s1">|| (</span><span class="s2">exports</span><span class="s1">.</span><span class="s2">FLAGS </span><span class="s1">= {}));</span>
<span class="s3">function </span><span class="s2">flagsToNumber</span><span class="s1">(</span><span class="s2">flags</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">flags </span><span class="s1">=== </span><span class="s0">'number'</span><span class="s1">)</span>
        <span class="s3">return </span><span class="s2">flags</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">flags </span><span class="s1">=== </span><span class="s0">'string'</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">flagsNum </span><span class="s1">= </span><span class="s2">FLAGS</span><span class="s1">[</span><span class="s2">flags</span><span class="s1">];</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">flagsNum </span><span class="s1">!== </span><span class="s0">'undefined'</span><span class="s1">)</span>
            <span class="s3">return </span><span class="s2">flagsNum</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s5">// throw new TypeError(formatError(ERRSTR_FLAG(flags)));</span>
    <span class="s3">throw new </span><span class="s2">errors</span><span class="s1">.</span><span class="s2">TypeError</span><span class="s1">(</span><span class="s0">'ERR_INVALID_OPT_VALUE'</span><span class="s1">, </span><span class="s0">'flags'</span><span class="s1">, </span><span class="s2">flags</span><span class="s1">);</span>
<span class="s1">}</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">flagsToNumber </span><span class="s1">= </span><span class="s2">flagsToNumber</span><span class="s1">;</span>
<span class="s5">// ---------------------------------------- Options</span>
<span class="s3">function </span><span class="s2">getOptions</span><span class="s1">(</span><span class="s2">defaults</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
    <span class="s3">var </span><span class="s2">opts</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">options</span><span class="s1">)</span>
        <span class="s3">return </span><span class="s2">defaults</span><span class="s1">;</span>
    <span class="s3">else </span><span class="s1">{</span>
        <span class="s3">var </span><span class="s2">tipeof </span><span class="s1">= </span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">;</span>
        <span class="s3">switch </span><span class="s1">(</span><span class="s2">tipeof</span><span class="s1">) {</span>
            <span class="s3">case </span><span class="s0">'string'</span><span class="s1">:</span>
                <span class="s2">opts </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">assign</span><span class="s1">({}, </span><span class="s2">defaults</span><span class="s1">, { </span><span class="s2">encoding</span><span class="s1">: </span><span class="s2">options </span><span class="s1">});</span>
                <span class="s3">break</span><span class="s1">;</span>
            <span class="s3">case </span><span class="s0">'object'</span><span class="s1">:</span>
                <span class="s2">opts </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">assign</span><span class="s1">({}, </span><span class="s2">defaults</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
                <span class="s3">break</span><span class="s1">;</span>
            <span class="s3">default</span><span class="s1">:</span>
                <span class="s3">throw </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s2">ERRSTR_OPTS</span><span class="s1">(</span><span class="s2">tipeof</span><span class="s1">));</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">opts</span><span class="s1">.</span><span class="s2">encoding </span><span class="s1">!== </span><span class="s0">'buffer'</span><span class="s1">)</span>
        <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">encoding_1</span><span class="s1">.</span><span class="s2">assertEncoding</span><span class="s1">)(</span><span class="s2">opts</span><span class="s1">.</span><span class="s2">encoding</span><span class="s1">);</span>
    <span class="s3">return </span><span class="s2">opts</span><span class="s1">;</span>
<span class="s1">}</span>
<span class="s3">function </span><span class="s2">optsGenerator</span><span class="s1">(</span><span class="s2">defaults</span><span class="s1">) {</span>
    <span class="s3">return function </span><span class="s1">(</span><span class="s2">options</span><span class="s1">) { </span><span class="s3">return </span><span class="s2">getOptions</span><span class="s1">(</span><span class="s2">defaults</span><span class="s1">, </span><span class="s2">options</span><span class="s1">); };</span>
<span class="s1">}</span>
<span class="s3">function </span><span class="s2">validateCallback</span><span class="s1">(</span><span class="s2">callback</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">callback </span><span class="s1">!== </span><span class="s0">'function'</span><span class="s1">)</span>
        <span class="s3">throw </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s2">ERRSTR</span><span class="s1">.</span><span class="s2">CB</span><span class="s1">);</span>
    <span class="s3">return </span><span class="s2">callback</span><span class="s1">;</span>
<span class="s1">}</span>
<span class="s3">function </span><span class="s2">optsAndCbGenerator</span><span class="s1">(</span><span class="s2">getOpts</span><span class="s1">) {</span>
    <span class="s3">return function </span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
        <span class="s3">return typeof </span><span class="s2">options </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">? [</span><span class="s2">getOpts</span><span class="s1">(), </span><span class="s2">options</span><span class="s1">] : [</span><span class="s2">getOpts</span><span class="s1">(</span><span class="s2">options</span><span class="s1">), </span><span class="s2">validateCallback</span><span class="s1">(</span><span class="s2">callback</span><span class="s1">)];</span>
    <span class="s1">};</span>
<span class="s1">}</span>
<span class="s3">var </span><span class="s2">optsDefaults </span><span class="s1">= {</span>
    <span class="s2">encoding</span><span class="s1">: </span><span class="s0">'utf8'</span><span class="s1">,</span>
<span class="s1">};</span>
<span class="s3">var </span><span class="s2">getDefaultOpts </span><span class="s1">= </span><span class="s2">optsGenerator</span><span class="s1">(</span><span class="s2">optsDefaults</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">getDefaultOptsAndCb </span><span class="s1">= </span><span class="s2">optsAndCbGenerator</span><span class="s1">(</span><span class="s2">getDefaultOpts</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">readFileOptsDefaults </span><span class="s1">= {</span>
    <span class="s2">flag</span><span class="s1">: </span><span class="s0">'r'</span><span class="s1">,</span>
<span class="s1">};</span>
<span class="s3">var </span><span class="s2">getReadFileOptions </span><span class="s1">= </span><span class="s2">optsGenerator</span><span class="s1">(</span><span class="s2">readFileOptsDefaults</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">writeFileDefaults </span><span class="s1">= {</span>
    <span class="s2">encoding</span><span class="s1">: </span><span class="s0">'utf8'</span><span class="s1">,</span>
    <span class="s2">mode</span><span class="s1">: </span><span class="s4">438 </span><span class="s5">/* MODE.DEFAULT */</span><span class="s1">,</span>
    <span class="s2">flag</span><span class="s1">: </span><span class="s2">FLAGS</span><span class="s1">[</span><span class="s2">FLAGS</span><span class="s1">.</span><span class="s2">w</span><span class="s1">],</span>
<span class="s1">};</span>
<span class="s3">var </span><span class="s2">getWriteFileOptions </span><span class="s1">= </span><span class="s2">optsGenerator</span><span class="s1">(</span><span class="s2">writeFileDefaults</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">appendFileDefaults </span><span class="s1">= {</span>
    <span class="s2">encoding</span><span class="s1">: </span><span class="s0">'utf8'</span><span class="s1">,</span>
    <span class="s2">mode</span><span class="s1">: </span><span class="s4">438 </span><span class="s5">/* MODE.DEFAULT */</span><span class="s1">,</span>
    <span class="s2">flag</span><span class="s1">: </span><span class="s2">FLAGS</span><span class="s1">[</span><span class="s2">FLAGS</span><span class="s1">.</span><span class="s2">a</span><span class="s1">],</span>
<span class="s1">};</span>
<span class="s3">var </span><span class="s2">getAppendFileOpts </span><span class="s1">= </span><span class="s2">optsGenerator</span><span class="s1">(</span><span class="s2">appendFileDefaults</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">getAppendFileOptsAndCb </span><span class="s1">= </span><span class="s2">optsAndCbGenerator</span><span class="s1">(</span><span class="s2">getAppendFileOpts</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">realpathDefaults </span><span class="s1">= </span><span class="s2">optsDefaults</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">getRealpathOptions </span><span class="s1">= </span><span class="s2">optsGenerator</span><span class="s1">(</span><span class="s2">realpathDefaults</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">getRealpathOptsAndCb </span><span class="s1">= </span><span class="s2">optsAndCbGenerator</span><span class="s1">(</span><span class="s2">getRealpathOptions</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">mkdirDefaults </span><span class="s1">= {</span>
    <span class="s2">mode</span><span class="s1">: </span><span class="s4">511 </span><span class="s5">/* MODE.DIR */</span><span class="s1">,</span>
    <span class="s2">recursive</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
<span class="s1">};</span>
<span class="s3">var </span><span class="s2">getMkdirOptions </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">options</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options </span><span class="s1">=== </span><span class="s0">'number'</span><span class="s1">)</span>
        <span class="s3">return </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">assign</span><span class="s1">({}, </span><span class="s2">mkdirDefaults</span><span class="s1">, { </span><span class="s2">mode</span><span class="s1">: </span><span class="s2">options </span><span class="s1">});</span>
    <span class="s3">return </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">assign</span><span class="s1">({}, </span><span class="s2">mkdirDefaults</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
<span class="s1">};</span>
<span class="s3">var </span><span class="s2">rmdirDefaults </span><span class="s1">= {</span>
    <span class="s2">recursive</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
<span class="s1">};</span>
<span class="s3">var </span><span class="s2">getRmdirOptions </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">options</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">assign</span><span class="s1">({}, </span><span class="s2">rmdirDefaults</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
<span class="s1">};</span>
<span class="s3">var </span><span class="s2">getRmOpts </span><span class="s1">= </span><span class="s2">optsGenerator</span><span class="s1">(</span><span class="s2">optsDefaults</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">getRmOptsAndCb </span><span class="s1">= </span><span class="s2">optsAndCbGenerator</span><span class="s1">(</span><span class="s2">getRmOpts</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">readdirDefaults </span><span class="s1">= {</span>
    <span class="s2">encoding</span><span class="s1">: </span><span class="s0">'utf8'</span><span class="s1">,</span>
    <span class="s2">withFileTypes</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
<span class="s1">};</span>
<span class="s3">var </span><span class="s2">getReaddirOptions </span><span class="s1">= </span><span class="s2">optsGenerator</span><span class="s1">(</span><span class="s2">readdirDefaults</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">getReaddirOptsAndCb </span><span class="s1">= </span><span class="s2">optsAndCbGenerator</span><span class="s1">(</span><span class="s2">getReaddirOptions</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">statDefaults </span><span class="s1">= {</span>
    <span class="s2">bigint</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
<span class="s1">};</span>
<span class="s3">var </span><span class="s2">getStatOptions </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">options</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">options </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">options </span><span class="s1">= {}; }</span>
    <span class="s3">return </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">assign</span><span class="s1">({}, </span><span class="s2">statDefaults</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
<span class="s1">};</span>
<span class="s3">var </span><span class="s2">getStatOptsAndCb </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
    <span class="s3">return typeof </span><span class="s2">options </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">? [</span><span class="s2">getStatOptions</span><span class="s1">(), </span><span class="s2">options</span><span class="s1">] : [</span><span class="s2">getStatOptions</span><span class="s1">(</span><span class="s2">options</span><span class="s1">), </span><span class="s2">validateCallback</span><span class="s1">(</span><span class="s2">callback</span><span class="s1">)];</span>
<span class="s1">};</span>
<span class="s5">// ---------------------------------------- Utility functions</span>
<span class="s3">function </span><span class="s2">getPathFromURLPosix</span><span class="s1">(</span><span class="s2">url</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">url</span><span class="s1">.</span><span class="s2">hostname </span><span class="s1">!== </span><span class="s0">''</span><span class="s1">) {</span>
        <span class="s3">throw new </span><span class="s2">errors</span><span class="s1">.</span><span class="s2">TypeError</span><span class="s1">(</span><span class="s0">'ERR_INVALID_FILE_URL_HOST'</span><span class="s1">, </span><span class="s2">process_1</span><span class="s1">.</span><span class="s2">default</span><span class="s1">.</span><span class="s2">platform</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s3">var </span><span class="s2">pathname </span><span class="s1">= </span><span class="s2">url</span><span class="s1">.</span><span class="s2">pathname</span><span class="s1">;</span>
    <span class="s3">for </span><span class="s1">(</span><span class="s3">var </span><span class="s2">n </span><span class="s1">= </span><span class="s4">0</span><span class="s1">; </span><span class="s2">n </span><span class="s1">&lt; </span><span class="s2">pathname</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">n</span><span class="s1">++) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">pathname</span><span class="s1">[</span><span class="s2">n</span><span class="s1">] === </span><span class="s0">'%'</span><span class="s1">) {</span>
            <span class="s3">var </span><span class="s2">third </span><span class="s1">= </span><span class="s2">pathname</span><span class="s1">.</span><span class="s2">codePointAt</span><span class="s1">(</span><span class="s2">n </span><span class="s1">+ </span><span class="s4">2</span><span class="s1">) | </span><span class="s4">0x20</span><span class="s1">;</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">pathname</span><span class="s1">[</span><span class="s2">n </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">] === </span><span class="s0">'2' </span><span class="s1">&amp;&amp; </span><span class="s2">third </span><span class="s1">=== </span><span class="s4">102</span><span class="s1">) {</span>
                <span class="s3">throw new </span><span class="s2">errors</span><span class="s1">.</span><span class="s2">TypeError</span><span class="s1">(</span><span class="s0">'ERR_INVALID_FILE_URL_PATH'</span><span class="s1">, </span><span class="s0">'must not include encoded / characters'</span><span class="s1">);</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s3">return </span><span class="s2">decodeURIComponent</span><span class="s1">(</span><span class="s2">pathname</span><span class="s1">);</span>
<span class="s1">}</span>
<span class="s3">function </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">path </span><span class="s1">!== </span><span class="s0">'string' </span><span class="s1">&amp;&amp; !</span><span class="s2">buffer_1</span><span class="s1">.</span><span class="s2">Buffer</span><span class="s1">.</span><span class="s2">isBuffer</span><span class="s1">(</span><span class="s2">path</span><span class="s1">)) {</span>
        <span class="s3">try </span><span class="s1">{</span>
            <span class="s3">if </span><span class="s1">(!(</span><span class="s2">path </span><span class="s3">instanceof </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'url'</span><span class="s1">).</span><span class="s2">URL</span><span class="s1">))</span>
                <span class="s3">throw new </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s2">ERRSTR</span><span class="s1">.</span><span class="s2">PATH_STR</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
            <span class="s3">throw new </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s2">ERRSTR</span><span class="s1">.</span><span class="s2">PATH_STR</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s2">path </span><span class="s1">= </span><span class="s2">getPathFromURLPosix</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s3">var </span><span class="s2">pathString </span><span class="s1">= </span><span class="s2">String</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
    <span class="s2">nullCheck</span><span class="s1">(</span><span class="s2">pathString</span><span class="s1">);</span>
    <span class="s5">// return slash(pathString);</span>
    <span class="s3">return </span><span class="s2">pathString</span><span class="s1">;</span>
<span class="s1">}</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">pathToFilename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">resolve </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">base</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">base </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">base </span><span class="s1">= </span><span class="s2">process_1</span><span class="s1">.</span><span class="s2">default</span><span class="s1">.</span><span class="s2">cwd</span><span class="s1">(); }</span>
    <span class="s3">return </span><span class="s2">resolveCrossPlatform</span><span class="s1">(</span><span class="s2">base</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">);</span>
<span class="s1">};</span>
<span class="s3">if </span><span class="s1">(</span><span class="s2">isWin</span><span class="s1">) {</span>
    <span class="s3">var </span><span class="s2">_resolve_1 </span><span class="s1">= </span><span class="s2">resolve</span><span class="s1">;</span>
    <span class="s3">var </span><span class="s2">unixify_1 </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'fs-monkey/lib/correctPath'</span><span class="s1">).</span><span class="s2">unixify</span><span class="s1">;</span>
    <span class="s2">resolve </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">base</span><span class="s1">) { </span><span class="s3">return </span><span class="s2">unixify_1</span><span class="s1">(</span><span class="s2">_resolve_1</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">base</span><span class="s1">)); };</span>
<span class="s1">}</span>
<span class="s3">function </span><span class="s2">filenameToSteps</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">base</span><span class="s1">) {</span>
    <span class="s3">var </span><span class="s2">fullPath </span><span class="s1">= </span><span class="s2">resolve</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">base</span><span class="s1">);</span>
    <span class="s3">var </span><span class="s2">fullPathSansSlash </span><span class="s1">= </span><span class="s2">fullPath</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span><span class="s4">1</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">fullPathSansSlash</span><span class="s1">)</span>
        <span class="s3">return </span><span class="s1">[];</span>
    <span class="s3">return </span><span class="s2">fullPathSansSlash</span><span class="s1">.</span><span class="s2">split</span><span class="s1">(</span><span class="s2">sep</span><span class="s1">);</span>
<span class="s1">}</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">filenameToSteps </span><span class="s1">= </span><span class="s2">filenameToSteps</span><span class="s1">;</span>
<span class="s3">function </span><span class="s2">pathToSteps</span><span class="s1">(</span><span class="s2">path</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s2">filenameToSteps</span><span class="s1">(</span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">));</span>
<span class="s1">}</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">pathToSteps </span><span class="s1">= </span><span class="s2">pathToSteps</span><span class="s1">;</span>
<span class="s3">function </span><span class="s2">dataToStr</span><span class="s1">(</span><span class="s2">data</span><span class="s1">, </span><span class="s2">encoding</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">encoding </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">encoding </span><span class="s1">= </span><span class="s2">encoding_1</span><span class="s1">.</span><span class="s2">ENCODING_UTF8</span><span class="s1">; }</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">buffer_1</span><span class="s1">.</span><span class="s2">Buffer</span><span class="s1">.</span><span class="s2">isBuffer</span><span class="s1">(</span><span class="s2">data</span><span class="s1">))</span>
        <span class="s3">return </span><span class="s2">data</span><span class="s1">.</span><span class="s2">toString</span><span class="s1">(</span><span class="s2">encoding</span><span class="s1">);</span>
    <span class="s3">else if </span><span class="s1">(</span><span class="s2">data </span><span class="s3">instanceof </span><span class="s2">Uint8Array</span><span class="s1">)</span>
        <span class="s3">return </span><span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">buffer_1</span><span class="s1">.</span><span class="s2">bufferFrom</span><span class="s1">)(</span><span class="s2">data</span><span class="s1">).</span><span class="s2">toString</span><span class="s1">(</span><span class="s2">encoding</span><span class="s1">);</span>
    <span class="s3">else</span>
        <span class="s3">return </span><span class="s2">String</span><span class="s1">(</span><span class="s2">data</span><span class="s1">);</span>
<span class="s1">}</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">dataToStr </span><span class="s1">= </span><span class="s2">dataToStr</span><span class="s1">;</span>
<span class="s3">function </span><span class="s2">dataToBuffer</span><span class="s1">(</span><span class="s2">data</span><span class="s1">, </span><span class="s2">encoding</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">encoding </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">encoding </span><span class="s1">= </span><span class="s2">encoding_1</span><span class="s1">.</span><span class="s2">ENCODING_UTF8</span><span class="s1">; }</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">buffer_1</span><span class="s1">.</span><span class="s2">Buffer</span><span class="s1">.</span><span class="s2">isBuffer</span><span class="s1">(</span><span class="s2">data</span><span class="s1">))</span>
        <span class="s3">return </span><span class="s2">data</span><span class="s1">;</span>
    <span class="s3">else if </span><span class="s1">(</span><span class="s2">data </span><span class="s3">instanceof </span><span class="s2">Uint8Array</span><span class="s1">)</span>
        <span class="s3">return </span><span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">buffer_1</span><span class="s1">.</span><span class="s2">bufferFrom</span><span class="s1">)(</span><span class="s2">data</span><span class="s1">);</span>
    <span class="s3">else</span>
        <span class="s3">return </span><span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">buffer_1</span><span class="s1">.</span><span class="s2">bufferFrom</span><span class="s1">)(</span><span class="s2">String</span><span class="s1">(</span><span class="s2">data</span><span class="s1">), </span><span class="s2">encoding</span><span class="s1">);</span>
<span class="s1">}</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">dataToBuffer </span><span class="s1">= </span><span class="s2">dataToBuffer</span><span class="s1">;</span>
<span class="s3">function </span><span class="s2">bufferToEncoding</span><span class="s1">(</span><span class="s2">buffer</span><span class="s1">, </span><span class="s2">encoding</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">encoding </span><span class="s1">|| </span><span class="s2">encoding </span><span class="s1">=== </span><span class="s0">'buffer'</span><span class="s1">)</span>
        <span class="s3">return </span><span class="s2">buffer</span><span class="s1">;</span>
    <span class="s3">else</span>
        <span class="s3">return </span><span class="s2">buffer</span><span class="s1">.</span><span class="s2">toString</span><span class="s1">(</span><span class="s2">encoding</span><span class="s1">);</span>
<span class="s1">}</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">bufferToEncoding </span><span class="s1">= </span><span class="s2">bufferToEncoding</span><span class="s1">;</span>
<span class="s3">function </span><span class="s2">nullCheck</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">((</span><span class="s0">'' </span><span class="s1">+ </span><span class="s2">path</span><span class="s1">).</span><span class="s2">indexOf</span><span class="s1">(</span><span class="s0">'</span><span class="s3">\u0000</span><span class="s0">'</span><span class="s1">) !== -</span><span class="s4">1</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">er </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'Path must be a string without null bytes'</span><span class="s1">);</span>
        <span class="s2">er</span><span class="s1">.</span><span class="s2">code </span><span class="s1">= </span><span class="s2">ENOENT</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">callback </span><span class="s1">!== </span><span class="s0">'function'</span><span class="s1">)</span>
            <span class="s3">throw </span><span class="s2">er</span><span class="s1">;</span>
        <span class="s2">process_1</span><span class="s1">.</span><span class="s2">default</span><span class="s1">.</span><span class="s2">nextTick</span><span class="s1">(</span><span class="s2">callback</span><span class="s1">, </span><span class="s2">er</span><span class="s1">);</span>
        <span class="s3">return false</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">return true</span><span class="s1">;</span>
<span class="s1">}</span>
<span class="s3">function </span><span class="s2">_modeToNumber</span><span class="s1">(</span><span class="s2">mode</span><span class="s1">, </span><span class="s2">def</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">mode </span><span class="s1">=== </span><span class="s0">'number'</span><span class="s1">)</span>
        <span class="s3">return </span><span class="s2">mode</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">mode </span><span class="s1">=== </span><span class="s0">'string'</span><span class="s1">)</span>
        <span class="s3">return </span><span class="s2">parseInt</span><span class="s1">(</span><span class="s2">mode</span><span class="s1">, </span><span class="s4">8</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">def</span><span class="s1">)</span>
        <span class="s3">return </span><span class="s2">modeToNumber</span><span class="s1">(</span><span class="s2">def</span><span class="s1">);</span>
    <span class="s3">return </span><span class="s2">undefined</span><span class="s1">;</span>
<span class="s1">}</span>
<span class="s3">function </span><span class="s2">modeToNumber</span><span class="s1">(</span><span class="s2">mode</span><span class="s1">, </span><span class="s2">def</span><span class="s1">) {</span>
    <span class="s3">var </span><span class="s2">result </span><span class="s1">= </span><span class="s2">_modeToNumber</span><span class="s1">(</span><span class="s2">mode</span><span class="s1">, </span><span class="s2">def</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">result </span><span class="s1">!== </span><span class="s0">'number' </span><span class="s1">|| </span><span class="s2">isNaN</span><span class="s1">(</span><span class="s2">result</span><span class="s1">))</span>
        <span class="s3">throw new </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s2">ERRSTR</span><span class="s1">.</span><span class="s2">MODE_INT</span><span class="s1">);</span>
    <span class="s3">return </span><span class="s2">result</span><span class="s1">;</span>
<span class="s1">}</span>
<span class="s3">function </span><span class="s2">isFd</span><span class="s1">(</span><span class="s2">path</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s2">path </span><span class="s1">&gt;&gt;&gt; </span><span class="s4">0 </span><span class="s1">=== </span><span class="s2">path</span><span class="s1">;</span>
<span class="s1">}</span>
<span class="s3">function </span><span class="s2">validateFd</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">isFd</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">))</span>
        <span class="s3">throw </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s2">ERRSTR</span><span class="s1">.</span><span class="s2">FD</span><span class="s1">);</span>
<span class="s1">}</span>
<span class="s5">// converts Date or number to a fractional UNIX timestamp</span>
<span class="s3">function </span><span class="s2">toUnixTimestamp</span><span class="s1">(</span><span class="s2">time</span><span class="s1">) {</span>
    <span class="s5">// tslint:disable-next-line triple-equals</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">time </span><span class="s1">=== </span><span class="s0">'string' </span><span class="s1">&amp;&amp; +</span><span class="s2">time </span><span class="s1">== </span><span class="s2">time</span><span class="s1">) {</span>
        <span class="s3">return </span><span class="s1">+</span><span class="s2">time</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">time </span><span class="s3">instanceof </span><span class="s2">Date</span><span class="s1">) {</span>
        <span class="s3">return </span><span class="s2">time</span><span class="s1">.</span><span class="s2">getTime</span><span class="s1">() / </span><span class="s4">1000</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">isFinite</span><span class="s1">(</span><span class="s2">time</span><span class="s1">)) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">time </span><span class="s1">&lt; </span><span class="s4">0</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s2">Date</span><span class="s1">.</span><span class="s2">now</span><span class="s1">() / </span><span class="s4">1000</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">return </span><span class="s2">time</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'Cannot parse time: ' </span><span class="s1">+ </span><span class="s2">time</span><span class="s1">);</span>
<span class="s1">}</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">toUnixTimestamp </span><span class="s1">= </span><span class="s2">toUnixTimestamp</span><span class="s1">;</span>
<span class="s3">function </span><span class="s2">validateUid</span><span class="s1">(</span><span class="s2">uid</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">uid </span><span class="s1">!== </span><span class="s0">'number'</span><span class="s1">)</span>
        <span class="s3">throw </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s2">ERRSTR</span><span class="s1">.</span><span class="s2">UID</span><span class="s1">);</span>
<span class="s1">}</span>
<span class="s3">function </span><span class="s2">validateGid</span><span class="s1">(</span><span class="s2">gid</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">gid </span><span class="s1">!== </span><span class="s0">'number'</span><span class="s1">)</span>
        <span class="s3">throw </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s2">ERRSTR</span><span class="s1">.</span><span class="s2">GID</span><span class="s1">);</span>
<span class="s1">}</span>
<span class="s3">function </span><span class="s2">flattenJSON</span><span class="s1">(</span><span class="s2">nestedJSON</span><span class="s1">) {</span>
    <span class="s3">var </span><span class="s2">flatJSON </span><span class="s1">= {};</span>
    <span class="s3">function </span><span class="s2">flatten</span><span class="s1">(</span><span class="s2">pathPrefix</span><span class="s1">, </span><span class="s2">node</span><span class="s1">) {</span>
        <span class="s3">for </span><span class="s1">(</span><span class="s3">var </span><span class="s2">path </span><span class="s3">in </span><span class="s2">node</span><span class="s1">) {</span>
            <span class="s3">var </span><span class="s2">contentOrNode </span><span class="s1">= </span><span class="s2">node</span><span class="s1">[</span><span class="s2">path</span><span class="s1">];</span>
            <span class="s3">var </span><span class="s2">joinedPath </span><span class="s1">= </span><span class="s2">join</span><span class="s1">(</span><span class="s2">pathPrefix</span><span class="s1">, </span><span class="s2">path</span><span class="s1">);</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">contentOrNode </span><span class="s1">=== </span><span class="s0">'string'</span><span class="s1">) {</span>
                <span class="s2">flatJSON</span><span class="s1">[</span><span class="s2">joinedPath</span><span class="s1">] = </span><span class="s2">contentOrNode</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s3">else if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">contentOrNode </span><span class="s1">=== </span><span class="s0">'object' </span><span class="s1">&amp;&amp; </span><span class="s2">contentOrNode </span><span class="s1">!== </span><span class="s3">null </span><span class="s1">&amp;&amp; </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">contentOrNode</span><span class="s1">).</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s4">0</span><span class="s1">) {</span>
                <span class="s5">// empty directories need an explicit entry and therefore get handled in `else`, non-empty ones are implicitly considered</span>
                <span class="s2">flatten</span><span class="s1">(</span><span class="s2">joinedPath</span><span class="s1">, </span><span class="s2">contentOrNode</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s3">else </span><span class="s1">{</span>
                <span class="s5">// without this branch null, empty-object or non-object entries would not be handled in the same way</span>
                <span class="s5">// by both fromJSON() and fromNestedJSON()</span>
                <span class="s2">flatJSON</span><span class="s1">[</span><span class="s2">joinedPath</span><span class="s1">] = </span><span class="s3">null</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">flatten</span><span class="s1">(</span><span class="s0">''</span><span class="s1">, </span><span class="s2">nestedJSON</span><span class="s1">);</span>
    <span class="s3">return </span><span class="s2">flatJSON</span><span class="s1">;</span>
<span class="s1">}</span>
<span class="s6">/**</span>
 <span class="s6">* `Volume` represents a file system.</span>
 <span class="s6">*/</span>
<span class="s3">var </span><span class="s2">Volume </span><span class="s1">= </span><span class="s6">/** </span><span class="s7">@class </span><span class="s6">*/ </span><span class="s1">(</span><span class="s3">function </span><span class="s1">() {</span>
    <span class="s3">function </span><span class="s2">Volume</span><span class="s1">(</span><span class="s2">props</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">props </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">props </span><span class="s1">= {}; }</span>
        <span class="s5">// I-node number counter.</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">ino </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
        <span class="s5">// A mapping for i-node numbers to i-nodes (`Node`);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">inodes </span><span class="s1">= {};</span>
        <span class="s5">// List of released i-node numbers, for reuse.</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">releasedInos </span><span class="s1">= [];</span>
        <span class="s5">// A mapping for file descriptors to `File`s.</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">fds </span><span class="s1">= {};</span>
        <span class="s5">// A list of reusable (opened and closed) file descriptors, that should be</span>
        <span class="s5">// used first before creating a new file descriptor.</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">releasedFds </span><span class="s1">= [];</span>
        <span class="s5">// Max number of open files.</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">maxFiles </span><span class="s1">= </span><span class="s4">10000</span><span class="s1">;</span>
        <span class="s5">// Current number of open files.</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">openFiles </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">promisesApi </span><span class="s1">= (</span><span class="s4">0</span><span class="s1">, </span><span class="s2">promises_1</span><span class="s1">.</span><span class="s2">default</span><span class="s1">)(</span><span class="s3">this</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">statWatchers </span><span class="s1">= {};</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">props </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">assign</span><span class="s1">({ </span><span class="s2">Node</span><span class="s1">: </span><span class="s2">node_1</span><span class="s1">.</span><span class="s2">Node</span><span class="s1">, </span><span class="s2">Link</span><span class="s1">: </span><span class="s2">node_1</span><span class="s1">.</span><span class="s2">Link</span><span class="s1">, </span><span class="s2">File</span><span class="s1">: </span><span class="s2">node_1</span><span class="s1">.</span><span class="s2">File </span><span class="s1">}, </span><span class="s2">props</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">root </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">createLink</span><span class="s1">();</span>
        <span class="s2">root</span><span class="s1">.</span><span class="s2">setNode</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">createNode</span><span class="s1">(</span><span class="s3">true</span><span class="s1">));</span>
        <span class="s3">var </span><span class="s2">self </span><span class="s1">= </span><span class="s3">this</span><span class="s1">; </span><span class="s5">// tslint:disable-line no-this-assignment</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">StatWatcher </span><span class="s1">= </span><span class="s6">/** </span><span class="s7">@class </span><span class="s6">*/ </span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">_super</span><span class="s1">) {</span>
            <span class="s2">__extends</span><span class="s1">(</span><span class="s2">StatWatcher</span><span class="s1">, </span><span class="s2">_super</span><span class="s1">);</span>
            <span class="s3">function </span><span class="s2">StatWatcher</span><span class="s1">() {</span>
                <span class="s3">return </span><span class="s2">_super</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s2">self</span><span class="s1">) || </span><span class="s3">this</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s3">return </span><span class="s2">StatWatcher</span><span class="s1">;</span>
        <span class="s1">}(</span><span class="s2">StatWatcher</span><span class="s1">));</span>
        <span class="s3">var </span><span class="s2">_ReadStream </span><span class="s1">= </span><span class="s2">FsReadStream</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">ReadStream </span><span class="s1">= </span><span class="s6">/** </span><span class="s7">@class </span><span class="s6">*/ </span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">_super</span><span class="s1">) {</span>
            <span class="s2">__extends</span><span class="s1">(</span><span class="s2">class_1</span><span class="s1">, </span><span class="s2">_super</span><span class="s1">);</span>
            <span class="s3">function </span><span class="s2">class_1</span><span class="s1">() {</span>
                <span class="s3">var </span><span class="s2">args </span><span class="s1">= [];</span>
                <span class="s3">for </span><span class="s1">(</span><span class="s3">var </span><span class="s2">_i </span><span class="s1">= </span><span class="s4">0</span><span class="s1">; </span><span class="s2">_i </span><span class="s1">&lt; </span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">_i</span><span class="s1">++) {</span>
                    <span class="s2">args</span><span class="s1">[</span><span class="s2">_i</span><span class="s1">] = </span><span class="s2">arguments</span><span class="s1">[</span><span class="s2">_i</span><span class="s1">];</span>
                <span class="s1">}</span>
                <span class="s3">return </span><span class="s2">_super</span><span class="s1">.</span><span class="s2">apply</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s2">__spreadArray</span><span class="s1">([</span><span class="s2">self</span><span class="s1">], </span><span class="s2">args</span><span class="s1">, </span><span class="s3">false</span><span class="s1">)) || </span><span class="s3">this</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s3">return </span><span class="s2">class_1</span><span class="s1">;</span>
        <span class="s1">}(</span><span class="s2">_ReadStream</span><span class="s1">));</span>
        <span class="s3">var </span><span class="s2">_WriteStream </span><span class="s1">= </span><span class="s2">FsWriteStream</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">WriteStream </span><span class="s1">= </span><span class="s6">/** </span><span class="s7">@class </span><span class="s6">*/ </span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">_super</span><span class="s1">) {</span>
            <span class="s2">__extends</span><span class="s1">(</span><span class="s2">class_2</span><span class="s1">, </span><span class="s2">_super</span><span class="s1">);</span>
            <span class="s3">function </span><span class="s2">class_2</span><span class="s1">() {</span>
                <span class="s3">var </span><span class="s2">args </span><span class="s1">= [];</span>
                <span class="s3">for </span><span class="s1">(</span><span class="s3">var </span><span class="s2">_i </span><span class="s1">= </span><span class="s4">0</span><span class="s1">; </span><span class="s2">_i </span><span class="s1">&lt; </span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">_i</span><span class="s1">++) {</span>
                    <span class="s2">args</span><span class="s1">[</span><span class="s2">_i</span><span class="s1">] = </span><span class="s2">arguments</span><span class="s1">[</span><span class="s2">_i</span><span class="s1">];</span>
                <span class="s1">}</span>
                <span class="s3">return </span><span class="s2">_super</span><span class="s1">.</span><span class="s2">apply</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s2">__spreadArray</span><span class="s1">([</span><span class="s2">self</span><span class="s1">], </span><span class="s2">args</span><span class="s1">, </span><span class="s3">false</span><span class="s1">)) || </span><span class="s3">this</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s3">return </span><span class="s2">class_2</span><span class="s1">;</span>
        <span class="s1">}(</span><span class="s2">_WriteStream</span><span class="s1">));</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">FSWatcher </span><span class="s1">= </span><span class="s6">/** </span><span class="s7">@class </span><span class="s6">*/ </span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">_super</span><span class="s1">) {</span>
            <span class="s2">__extends</span><span class="s1">(</span><span class="s2">FSWatcher</span><span class="s1">, </span><span class="s2">_super</span><span class="s1">);</span>
            <span class="s3">function </span><span class="s2">FSWatcher</span><span class="s1">() {</span>
                <span class="s3">return </span><span class="s2">_super</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s2">self</span><span class="s1">) || </span><span class="s3">this</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s3">return </span><span class="s2">FSWatcher</span><span class="s1">;</span>
        <span class="s1">}(</span><span class="s2">FSWatcher</span><span class="s1">));</span>
        <span class="s2">root</span><span class="s1">.</span><span class="s2">setChild</span><span class="s1">(</span><span class="s0">'.'</span><span class="s1">, </span><span class="s2">root</span><span class="s1">);</span>
        <span class="s2">root</span><span class="s1">.</span><span class="s2">getNode</span><span class="s1">().</span><span class="s2">nlink</span><span class="s1">++;</span>
        <span class="s2">root</span><span class="s1">.</span><span class="s2">setChild</span><span class="s1">(</span><span class="s0">'..'</span><span class="s1">, </span><span class="s2">root</span><span class="s1">);</span>
        <span class="s2">root</span><span class="s1">.</span><span class="s2">getNode</span><span class="s1">().</span><span class="s2">nlink</span><span class="s1">++;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">root </span><span class="s1">= </span><span class="s2">root</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">fromJSON </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">json</span><span class="s1">, </span><span class="s2">cwd</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">vol </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Volume</span><span class="s1">();</span>
        <span class="s2">vol</span><span class="s1">.</span><span class="s2">fromJSON</span><span class="s1">(</span><span class="s2">json</span><span class="s1">, </span><span class="s2">cwd</span><span class="s1">);</span>
        <span class="s3">return </span><span class="s2">vol</span><span class="s1">;</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">fromNestedJSON </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">json</span><span class="s1">, </span><span class="s2">cwd</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">vol </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Volume</span><span class="s1">();</span>
        <span class="s2">vol</span><span class="s1">.</span><span class="s2">fromNestedJSON</span><span class="s1">(</span><span class="s2">json</span><span class="s1">, </span><span class="s2">cwd</span><span class="s1">);</span>
        <span class="s3">return </span><span class="s2">vol</span><span class="s1">;</span>
    <span class="s1">};</span>
    <span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">, </span><span class="s0">&quot;promises&quot;</span><span class="s1">, {</span>
        <span class="s2">get</span><span class="s1">: </span><span class="s3">function </span><span class="s1">() {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">promisesApi </span><span class="s1">=== </span><span class="s3">null</span><span class="s1">)</span>
                <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'Promise is not supported in this environment.'</span><span class="s1">);</span>
            <span class="s3">return this</span><span class="s1">.</span><span class="s2">promisesApi</span><span class="s1">;</span>
        <span class="s1">},</span>
        <span class="s2">enumerable</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
        <span class="s2">configurable</span><span class="s1">: </span><span class="s3">true</span>
    <span class="s1">});</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">createLink </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">parent</span><span class="s1">, </span><span class="s2">name</span><span class="s1">, </span><span class="s2">isDirectory</span><span class="s1">, </span><span class="s2">perm</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">isDirectory </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">isDirectory </span><span class="s1">= </span><span class="s3">false</span><span class="s1">; }</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">parent</span><span class="s1">) {</span>
            <span class="s3">return new this</span><span class="s1">.</span><span class="s2">props</span><span class="s1">.</span><span class="s2">Link</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s3">null</span><span class="s1">, </span><span class="s0">''</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">name</span><span class="s1">) {</span>
            <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'createLink: name cannot be empty'</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">return </span><span class="s2">parent</span><span class="s1">.</span><span class="s2">createChild</span><span class="s1">(</span><span class="s2">name</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">createNode</span><span class="s1">(</span><span class="s2">isDirectory</span><span class="s1">, </span><span class="s2">perm</span><span class="s1">));</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">deleteLink </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">link</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">parent </span><span class="s1">= </span><span class="s2">link</span><span class="s1">.</span><span class="s2">parent</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">parent</span><span class="s1">) {</span>
            <span class="s2">parent</span><span class="s1">.</span><span class="s2">deleteChild</span><span class="s1">(</span><span class="s2">link</span><span class="s1">);</span>
            <span class="s3">return true</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">return false</span><span class="s1">;</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">newInoNumber </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
        <span class="s3">var </span><span class="s2">releasedFd </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">releasedInos</span><span class="s1">.</span><span class="s2">pop</span><span class="s1">();</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">releasedFd</span><span class="s1">)</span>
            <span class="s3">return </span><span class="s2">releasedFd</span><span class="s1">;</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">ino </span><span class="s1">= (</span><span class="s3">this</span><span class="s1">.</span><span class="s2">ino </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">) % </span><span class="s4">0xffffffff</span><span class="s1">;</span>
            <span class="s3">return this</span><span class="s1">.</span><span class="s2">ino</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">newFdNumber </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
        <span class="s3">var </span><span class="s2">releasedFd </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">releasedFds</span><span class="s1">.</span><span class="s2">pop</span><span class="s1">();</span>
        <span class="s3">return typeof </span><span class="s2">releasedFd </span><span class="s1">=== </span><span class="s0">'number' </span><span class="s1">? </span><span class="s2">releasedFd </span><span class="s1">: </span><span class="s2">Volume</span><span class="s1">.</span><span class="s2">fd</span><span class="s1">--;</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">createNode </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">isDirectory</span><span class="s1">, </span><span class="s2">perm</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">isDirectory </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">isDirectory </span><span class="s1">= </span><span class="s3">false</span><span class="s1">; }</span>
        <span class="s3">var </span><span class="s2">node </span><span class="s1">= </span><span class="s3">new this</span><span class="s1">.</span><span class="s2">props</span><span class="s1">.</span><span class="s2">Node</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">newInoNumber</span><span class="s1">(), </span><span class="s2">perm</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">isDirectory</span><span class="s1">)</span>
            <span class="s2">node</span><span class="s1">.</span><span class="s2">setIsDirectory</span><span class="s1">();</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">inodes</span><span class="s1">[</span><span class="s2">node</span><span class="s1">.</span><span class="s2">ino</span><span class="s1">] = </span><span class="s2">node</span><span class="s1">;</span>
        <span class="s3">return </span><span class="s2">node</span><span class="s1">;</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">getNode </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">ino</span><span class="s1">) {</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">inodes</span><span class="s1">[</span><span class="s2">ino</span><span class="s1">];</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">deleteNode </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">node</span><span class="s1">) {</span>
        <span class="s2">node</span><span class="s1">.</span><span class="s2">del</span><span class="s1">();</span>
        <span class="s3">delete this</span><span class="s1">.</span><span class="s2">inodes</span><span class="s1">[</span><span class="s2">node</span><span class="s1">.</span><span class="s2">ino</span><span class="s1">];</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">releasedInos</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">ino</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s5">// Generates 6 character long random string, used by `mkdtemp`.</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">genRndStr </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
        <span class="s3">var </span><span class="s2">str </span><span class="s1">= (</span><span class="s2">Math</span><span class="s1">.</span><span class="s2">random</span><span class="s1">() + </span><span class="s4">1</span><span class="s1">).</span><span class="s2">toString</span><span class="s1">(</span><span class="s4">36</span><span class="s1">).</span><span class="s2">substring</span><span class="s1">(</span><span class="s4">2</span><span class="s1">, </span><span class="s4">8</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">str</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s4">6</span><span class="s1">)</span>
            <span class="s3">return </span><span class="s2">str</span><span class="s1">;</span>
        <span class="s3">else</span>
            <span class="s3">return this</span><span class="s1">.</span><span class="s2">genRndStr</span><span class="s1">();</span>
    <span class="s1">};</span>
    <span class="s5">// Returns a `Link` (hard link) referenced by path &quot;split&quot; into steps.</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">getLink </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">steps</span><span class="s1">) {</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">root</span><span class="s1">.</span><span class="s2">walk</span><span class="s1">(</span><span class="s2">steps</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s5">// Just link `getLink`, but throws a correct user error, if link to found.</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">getLinkOrThrow </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">funcName</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">steps </span><span class="s1">= </span><span class="s2">filenameToSteps</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">link </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getLink</span><span class="s1">(</span><span class="s2">steps</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">link</span><span class="s1">)</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ENOENT</span><span class="s1">, </span><span class="s2">funcName</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">);</span>
        <span class="s3">return </span><span class="s2">link</span><span class="s1">;</span>
    <span class="s1">};</span>
    <span class="s5">// Just like `getLink`, but also dereference/resolves symbolic links.</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">getResolvedLink </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">filenameOrSteps</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">steps </span><span class="s1">= </span><span class="s3">typeof </span><span class="s2">filenameOrSteps </span><span class="s1">=== </span><span class="s0">'string' </span><span class="s1">? </span><span class="s2">filenameToSteps</span><span class="s1">(</span><span class="s2">filenameOrSteps</span><span class="s1">) : </span><span class="s2">filenameOrSteps</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">link </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">root</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">i </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
        <span class="s3">while </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">steps</span><span class="s1">.</span><span class="s2">length</span><span class="s1">) {</span>
            <span class="s3">var </span><span class="s2">step </span><span class="s1">= </span><span class="s2">steps</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>
            <span class="s2">link </span><span class="s1">= </span><span class="s2">link</span><span class="s1">.</span><span class="s2">getChild</span><span class="s1">(</span><span class="s2">step</span><span class="s1">);</span>
            <span class="s3">if </span><span class="s1">(!</span><span class="s2">link</span><span class="s1">)</span>
                <span class="s3">return null</span><span class="s1">;</span>
            <span class="s3">var </span><span class="s2">node </span><span class="s1">= </span><span class="s2">link</span><span class="s1">.</span><span class="s2">getNode</span><span class="s1">();</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">isSymlink</span><span class="s1">()) {</span>
                <span class="s2">steps </span><span class="s1">= </span><span class="s2">node</span><span class="s1">.</span><span class="s2">symlink</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">steps</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">i </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">));</span>
                <span class="s2">link </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">root</span><span class="s1">;</span>
                <span class="s2">i </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
                <span class="s3">continue</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s2">i</span><span class="s1">++;</span>
        <span class="s1">}</span>
        <span class="s3">return </span><span class="s2">link</span><span class="s1">;</span>
    <span class="s1">};</span>
    <span class="s5">// Just like `getLinkOrThrow`, but also dereference/resolves symbolic links.</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">getResolvedLinkOrThrow </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">funcName</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">link </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getResolvedLink</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">link</span><span class="s1">)</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ENOENT</span><span class="s1">, </span><span class="s2">funcName</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">);</span>
        <span class="s3">return </span><span class="s2">link</span><span class="s1">;</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">resolveSymlinks </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">link</span><span class="s1">) {</span>
        <span class="s5">// let node: Node = link.getNode();</span>
        <span class="s5">// while(link &amp;&amp; node.isSymlink()) {</span>
        <span class="s5">//     link = this.getLink(node.symlink);</span>
        <span class="s5">//     if(!link) return null;</span>
        <span class="s5">//     node = link.getNode();</span>
        <span class="s5">// }</span>
        <span class="s5">// return link;</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">getResolvedLink</span><span class="s1">(</span><span class="s2">link</span><span class="s1">.</span><span class="s2">steps</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s4">1</span><span class="s1">));</span>
    <span class="s1">};</span>
    <span class="s5">// Just like `getLinkOrThrow`, but also verifies that the link is a directory.</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">getLinkAsDirOrThrow </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">funcName</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">link </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getLinkOrThrow</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">funcName</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">link</span><span class="s1">.</span><span class="s2">getNode</span><span class="s1">().</span><span class="s2">isDirectory</span><span class="s1">())</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ENOTDIR</span><span class="s1">, </span><span class="s2">funcName</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">);</span>
        <span class="s3">return </span><span class="s2">link</span><span class="s1">;</span>
    <span class="s1">};</span>
    <span class="s5">// Get the immediate parent directory of the link.</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">getLinkParent </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">steps</span><span class="s1">) {</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">root</span><span class="s1">.</span><span class="s2">walk</span><span class="s1">(</span><span class="s2">steps</span><span class="s1">, </span><span class="s2">steps</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">1</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">getLinkParentAsDirOrThrow </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">filenameOrSteps</span><span class="s1">, </span><span class="s2">funcName</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">steps </span><span class="s1">= </span><span class="s2">filenameOrSteps </span><span class="s3">instanceof </span><span class="s2">Array </span><span class="s1">? </span><span class="s2">filenameOrSteps </span><span class="s1">: </span><span class="s2">filenameToSteps</span><span class="s1">(</span><span class="s2">filenameOrSteps</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">link </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getLinkParent</span><span class="s1">(</span><span class="s2">steps</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">link</span><span class="s1">)</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ENOENT</span><span class="s1">, </span><span class="s2">funcName</span><span class="s1">, </span><span class="s2">sep </span><span class="s1">+ </span><span class="s2">steps</span><span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s2">sep</span><span class="s1">));</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">link</span><span class="s1">.</span><span class="s2">getNode</span><span class="s1">().</span><span class="s2">isDirectory</span><span class="s1">())</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ENOTDIR</span><span class="s1">, </span><span class="s2">funcName</span><span class="s1">, </span><span class="s2">sep </span><span class="s1">+ </span><span class="s2">steps</span><span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s2">sep</span><span class="s1">));</span>
        <span class="s3">return </span><span class="s2">link</span><span class="s1">;</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">getFileByFd </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">) {</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">fds</span><span class="s1">[</span><span class="s2">String</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">)];</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">getFileByFdOrThrow </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">funcName</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">isFd</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">))</span>
            <span class="s3">throw </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s2">ERRSTR</span><span class="s1">.</span><span class="s2">FD</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">file </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getFileByFd</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">file</span><span class="s1">)</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">EBADF</span><span class="s1">, </span><span class="s2">funcName</span><span class="s1">);</span>
        <span class="s3">return </span><span class="s2">file</span><span class="s1">;</span>
    <span class="s1">};</span>
    <span class="s6">/**</span>
     <span class="s6">* </span><span class="s7">@todo </span><span class="s6">This is not used anymore. Remove.</span>
     <span class="s6">*/</span>
    <span class="s5">/* 
    private getNodeByIdOrCreate(id: TFileId, flags: number, perm: number): Node { 
      if (typeof id === 'number') { 
        const file = this.getFileByFd(id); 
        if (!file) throw Error('File nto found'); 
        return file.node; 
      } else { 
        const steps = pathToSteps(id as PathLike); 
        let link = this.getLink(steps); 
        if (link) return link.getNode(); 
   
        // Try creating a node if not found. 
        if (flags &amp; O_CREAT) { 
          const dirLink = this.getLinkParent(steps); 
          if (dirLink) { 
            const name = steps[steps.length - 1]; 
            link = this.createLink(dirLink, name, false, perm); 
            return link.getNode(); 
          } 
        } 
   
        throw createError(ENOENT, 'getNodeByIdOrCreate', pathToFilename(id)); 
      } 
    } 
    */</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">wrapAsync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">method</span><span class="s1">, </span><span class="s2">args</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">_this </span><span class="s1">= </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s2">validateCallback</span><span class="s1">(</span><span class="s2">callback</span><span class="s1">);</span>
        <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">setImmediate_1</span><span class="s1">.</span><span class="s2">default</span><span class="s1">)(</span><span class="s3">function </span><span class="s1">() {</span>
            <span class="s3">var </span><span class="s2">result</span><span class="s1">;</span>
            <span class="s3">try </span><span class="s1">{</span>
                <span class="s2">result </span><span class="s1">= </span><span class="s2">method</span><span class="s1">.</span><span class="s2">apply</span><span class="s1">(</span><span class="s2">_this</span><span class="s1">, </span><span class="s2">args</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s3">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
                <span class="s2">callback</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
                <span class="s3">return</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s2">callback</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s2">result</span><span class="s1">);</span>
        <span class="s1">});</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_toJSON </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">link</span><span class="s1">, </span><span class="s2">json</span><span class="s1">, </span><span class="s2">path</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">_a</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">link </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">link </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">root</span><span class="s1">; }</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">json </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">json </span><span class="s1">= {}; }</span>
        <span class="s3">var </span><span class="s2">isEmpty </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">children </span><span class="s1">= </span><span class="s2">link</span><span class="s1">.</span><span class="s2">children</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">link</span><span class="s1">.</span><span class="s2">getNode</span><span class="s1">().</span><span class="s2">isFile</span><span class="s1">()) {</span>
            <span class="s2">children </span><span class="s1">= (</span><span class="s2">_a </span><span class="s1">= {}, </span><span class="s2">_a</span><span class="s1">[</span><span class="s2">link</span><span class="s1">.</span><span class="s2">getName</span><span class="s1">()] = </span><span class="s2">link</span><span class="s1">.</span><span class="s2">parent</span><span class="s1">.</span><span class="s2">getChild</span><span class="s1">(</span><span class="s2">link</span><span class="s1">.</span><span class="s2">getName</span><span class="s1">()), </span><span class="s2">_a</span><span class="s1">);</span>
            <span class="s2">link </span><span class="s1">= </span><span class="s2">link</span><span class="s1">.</span><span class="s2">parent</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">for </span><span class="s1">(</span><span class="s3">var </span><span class="s2">name_1 </span><span class="s3">in </span><span class="s2">children</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">name_1 </span><span class="s1">=== </span><span class="s0">'.' </span><span class="s1">|| </span><span class="s2">name_1 </span><span class="s1">=== </span><span class="s0">'..'</span><span class="s1">) {</span>
                <span class="s3">continue</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s2">isEmpty </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
            <span class="s3">var </span><span class="s2">child </span><span class="s1">= </span><span class="s2">link</span><span class="s1">.</span><span class="s2">getChild</span><span class="s1">(</span><span class="s2">name_1</span><span class="s1">);</span>
            <span class="s3">if </span><span class="s1">(!</span><span class="s2">child</span><span class="s1">) {</span>
                <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'_toJSON: unexpected undefined'</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s3">var </span><span class="s2">node </span><span class="s1">= </span><span class="s2">child</span><span class="s1">.</span><span class="s2">getNode</span><span class="s1">();</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">isFile</span><span class="s1">()) {</span>
                <span class="s3">var </span><span class="s2">filename </span><span class="s1">= </span><span class="s2">child</span><span class="s1">.</span><span class="s2">getPath</span><span class="s1">();</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">path</span><span class="s1">)</span>
                    <span class="s2">filename </span><span class="s1">= </span><span class="s2">relative</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">);</span>
                <span class="s2">json</span><span class="s1">[</span><span class="s2">filename</span><span class="s1">] = </span><span class="s2">node</span><span class="s1">.</span><span class="s2">getString</span><span class="s1">();</span>
            <span class="s1">}</span>
            <span class="s3">else if </span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">isDirectory</span><span class="s1">()) {</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">_toJSON</span><span class="s1">(</span><span class="s2">child</span><span class="s1">, </span><span class="s2">json</span><span class="s1">, </span><span class="s2">path</span><span class="s1">);</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s3">var </span><span class="s2">dirPath </span><span class="s1">= </span><span class="s2">link</span><span class="s1">.</span><span class="s2">getPath</span><span class="s1">();</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">path</span><span class="s1">)</span>
            <span class="s2">dirPath </span><span class="s1">= </span><span class="s2">relative</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">dirPath</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">dirPath </span><span class="s1">&amp;&amp; </span><span class="s2">isEmpty</span><span class="s1">) {</span>
            <span class="s2">json</span><span class="s1">[</span><span class="s2">dirPath</span><span class="s1">] = </span><span class="s3">null</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">return </span><span class="s2">json</span><span class="s1">;</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">toJSON </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">paths</span><span class="s1">, </span><span class="s2">json</span><span class="s1">, </span><span class="s2">isRelative</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">json </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">json </span><span class="s1">= {}; }</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">isRelative </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">isRelative </span><span class="s1">= </span><span class="s3">false</span><span class="s1">; }</span>
        <span class="s3">var </span><span class="s2">links </span><span class="s1">= [];</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">paths</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(!(</span><span class="s2">paths </span><span class="s3">instanceof </span><span class="s2">Array</span><span class="s1">))</span>
                <span class="s2">paths </span><span class="s1">= [</span><span class="s2">paths</span><span class="s1">];</span>
            <span class="s3">for </span><span class="s1">(</span><span class="s3">var </span><span class="s2">_i </span><span class="s1">= </span><span class="s4">0</span><span class="s1">, </span><span class="s2">paths_1 </span><span class="s1">= </span><span class="s2">paths</span><span class="s1">; </span><span class="s2">_i </span><span class="s1">&lt; </span><span class="s2">paths_1</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">_i</span><span class="s1">++) {</span>
                <span class="s3">var </span><span class="s2">path </span><span class="s1">= </span><span class="s2">paths_1</span><span class="s1">[</span><span class="s2">_i</span><span class="s1">];</span>
                <span class="s3">var </span><span class="s2">filename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
                <span class="s3">var </span><span class="s2">link </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getResolvedLink</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">);</span>
                <span class="s3">if </span><span class="s1">(!</span><span class="s2">link</span><span class="s1">)</span>
                    <span class="s3">continue</span><span class="s1">;</span>
                <span class="s2">links</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">link</span><span class="s1">);</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s2">links</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">root</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">links</span><span class="s1">.</span><span class="s2">length</span><span class="s1">)</span>
            <span class="s3">return </span><span class="s2">json</span><span class="s1">;</span>
        <span class="s3">for </span><span class="s1">(</span><span class="s3">var </span><span class="s2">_a </span><span class="s1">= </span><span class="s4">0</span><span class="s1">, </span><span class="s2">links_1 </span><span class="s1">= </span><span class="s2">links</span><span class="s1">; </span><span class="s2">_a </span><span class="s1">&lt; </span><span class="s2">links_1</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">_a</span><span class="s1">++) {</span>
            <span class="s3">var </span><span class="s2">link </span><span class="s1">= </span><span class="s2">links_1</span><span class="s1">[</span><span class="s2">_a</span><span class="s1">];</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">_toJSON</span><span class="s1">(</span><span class="s2">link</span><span class="s1">, </span><span class="s2">json</span><span class="s1">, </span><span class="s2">isRelative </span><span class="s1">? </span><span class="s2">link</span><span class="s1">.</span><span class="s2">getPath</span><span class="s1">() : </span><span class="s0">''</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">return </span><span class="s2">json</span><span class="s1">;</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">fromJSON </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">json</span><span class="s1">, </span><span class="s2">cwd</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">cwd </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">cwd </span><span class="s1">= </span><span class="s2">process_1</span><span class="s1">.</span><span class="s2">default</span><span class="s1">.</span><span class="s2">cwd</span><span class="s1">(); }</span>
        <span class="s3">for </span><span class="s1">(</span><span class="s3">var </span><span class="s2">filename </span><span class="s3">in </span><span class="s2">json</span><span class="s1">) {</span>
            <span class="s3">var </span><span class="s2">data </span><span class="s1">= </span><span class="s2">json</span><span class="s1">[</span><span class="s2">filename</span><span class="s1">];</span>
            <span class="s2">filename </span><span class="s1">= </span><span class="s2">resolve</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">cwd</span><span class="s1">);</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">data </span><span class="s1">=== </span><span class="s0">'string'</span><span class="s1">) {</span>
                <span class="s3">var </span><span class="s2">dir </span><span class="s1">= </span><span class="s2">dirname</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">);</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">mkdirpBase</span><span class="s1">(</span><span class="s2">dir</span><span class="s1">, </span><span class="s4">511 </span><span class="s5">/* MODE.DIR */</span><span class="s1">);</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">writeFileSync</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">data</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s3">else </span><span class="s1">{</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">mkdirpBase</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s4">511 </span><span class="s5">/* MODE.DIR */</span><span class="s1">);</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">fromNestedJSON </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">json</span><span class="s1">, </span><span class="s2">cwd</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">fromJSON</span><span class="s1">(</span><span class="s2">flattenJSON</span><span class="s1">(</span><span class="s2">json</span><span class="s1">), </span><span class="s2">cwd</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">reset </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">ino </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">inodes </span><span class="s1">= {};</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">releasedInos </span><span class="s1">= [];</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">fds </span><span class="s1">= {};</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">releasedFds </span><span class="s1">= [];</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">openFiles </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">root </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">createLink</span><span class="s1">();</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">root</span><span class="s1">.</span><span class="s2">setNode</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">createNode</span><span class="s1">(</span><span class="s3">true</span><span class="s1">));</span>
    <span class="s1">};</span>
    <span class="s5">// Legacy interface</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">mountSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">mountpoint</span><span class="s1">, </span><span class="s2">json</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">fromJSON</span><span class="s1">(</span><span class="s2">json</span><span class="s1">, </span><span class="s2">mountpoint</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">openLink </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">link</span><span class="s1">, </span><span class="s2">flagsNum</span><span class="s1">, </span><span class="s2">resolveSymlinks</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">resolveSymlinks </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">resolveSymlinks </span><span class="s1">= </span><span class="s3">true</span><span class="s1">; }</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">openFiles </span><span class="s1">&gt;= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">maxFiles</span><span class="s1">) {</span>
            <span class="s5">// Too many open files.</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">EMFILE</span><span class="s1">, </span><span class="s0">'open'</span><span class="s1">, </span><span class="s2">link</span><span class="s1">.</span><span class="s2">getPath</span><span class="s1">());</span>
        <span class="s1">}</span>
        <span class="s5">// Resolve symlinks.</span>
        <span class="s3">var </span><span class="s2">realLink </span><span class="s1">= </span><span class="s2">link</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">resolveSymlinks</span><span class="s1">)</span>
            <span class="s2">realLink </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">resolveSymlinks</span><span class="s1">(</span><span class="s2">link</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">realLink</span><span class="s1">)</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ENOENT</span><span class="s1">, </span><span class="s0">'open'</span><span class="s1">, </span><span class="s2">link</span><span class="s1">.</span><span class="s2">getPath</span><span class="s1">());</span>
        <span class="s3">var </span><span class="s2">node </span><span class="s1">= </span><span class="s2">realLink</span><span class="s1">.</span><span class="s2">getNode</span><span class="s1">();</span>
        <span class="s5">// Check whether node is a directory</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">isDirectory</span><span class="s1">()) {</span>
            <span class="s3">if </span><span class="s1">((</span><span class="s2">flagsNum </span><span class="s1">&amp; (</span><span class="s2">O_RDONLY </span><span class="s1">| </span><span class="s2">O_RDWR </span><span class="s1">| </span><span class="s2">O_WRONLY</span><span class="s1">)) !== </span><span class="s2">O_RDONLY</span><span class="s1">)</span>
                <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">EISDIR</span><span class="s1">, </span><span class="s0">'open'</span><span class="s1">, </span><span class="s2">link</span><span class="s1">.</span><span class="s2">getPath</span><span class="s1">());</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">flagsNum </span><span class="s1">&amp; </span><span class="s2">O_DIRECTORY</span><span class="s1">)</span>
                <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ENOTDIR</span><span class="s1">, </span><span class="s0">'open'</span><span class="s1">, </span><span class="s2">link</span><span class="s1">.</span><span class="s2">getPath</span><span class="s1">());</span>
        <span class="s1">}</span>
        <span class="s5">// Check node permissions</span>
        <span class="s3">if </span><span class="s1">(!(</span><span class="s2">flagsNum </span><span class="s1">&amp; </span><span class="s2">O_WRONLY</span><span class="s1">)) {</span>
            <span class="s3">if </span><span class="s1">(!</span><span class="s2">node</span><span class="s1">.</span><span class="s2">canRead</span><span class="s1">()) {</span>
                <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">EACCES</span><span class="s1">, </span><span class="s0">'open'</span><span class="s1">, </span><span class="s2">link</span><span class="s1">.</span><span class="s2">getPath</span><span class="s1">());</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">flagsNum </span><span class="s1">&amp; </span><span class="s2">O_RDWR</span><span class="s1">) {</span>
        <span class="s1">}</span>
        <span class="s3">var </span><span class="s2">file </span><span class="s1">= </span><span class="s3">new this</span><span class="s1">.</span><span class="s2">props</span><span class="s1">.</span><span class="s2">File</span><span class="s1">(</span><span class="s2">link</span><span class="s1">, </span><span class="s2">node</span><span class="s1">, </span><span class="s2">flagsNum</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">newFdNumber</span><span class="s1">());</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">fds</span><span class="s1">[</span><span class="s2">file</span><span class="s1">.</span><span class="s2">fd</span><span class="s1">] = </span><span class="s2">file</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">openFiles</span><span class="s1">++;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">flagsNum </span><span class="s1">&amp; </span><span class="s2">O_TRUNC</span><span class="s1">)</span>
            <span class="s2">file</span><span class="s1">.</span><span class="s2">truncate</span><span class="s1">();</span>
        <span class="s3">return </span><span class="s2">file</span><span class="s1">;</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">openFile </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">flagsNum</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">, </span><span class="s2">resolveSymlinks</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">resolveSymlinks </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">resolveSymlinks </span><span class="s1">= </span><span class="s3">true</span><span class="s1">; }</span>
        <span class="s3">var </span><span class="s2">steps </span><span class="s1">= </span><span class="s2">filenameToSteps</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">link </span><span class="s1">= </span><span class="s2">resolveSymlinks </span><span class="s1">? </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getResolvedLink</span><span class="s1">(</span><span class="s2">steps</span><span class="s1">) : </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getLink</span><span class="s1">(</span><span class="s2">steps</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">link </span><span class="s1">&amp;&amp; </span><span class="s2">flagsNum </span><span class="s1">&amp; </span><span class="s2">O_EXCL</span><span class="s1">)</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">EEXIST</span><span class="s1">, </span><span class="s0">'open'</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">);</span>
        <span class="s5">// Try creating a new file, if it does not exist.</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">link </span><span class="s1">&amp;&amp; </span><span class="s2">flagsNum </span><span class="s1">&amp; </span><span class="s2">O_CREAT</span><span class="s1">) {</span>
            <span class="s5">// const dirLink: Link = this.getLinkParent(steps);</span>
            <span class="s3">var </span><span class="s2">dirLink </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getResolvedLink</span><span class="s1">(</span><span class="s2">steps</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">steps</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">1</span><span class="s1">));</span>
            <span class="s5">// if(!dirLink) throw createError(ENOENT, 'open', filename);</span>
            <span class="s3">if </span><span class="s1">(!</span><span class="s2">dirLink</span><span class="s1">)</span>
                <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ENOENT</span><span class="s1">, </span><span class="s0">'open'</span><span class="s1">, </span><span class="s2">sep </span><span class="s1">+ </span><span class="s2">steps</span><span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s2">sep</span><span class="s1">));</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">flagsNum </span><span class="s1">&amp; </span><span class="s2">O_CREAT </span><span class="s1">&amp;&amp; </span><span class="s3">typeof </span><span class="s2">modeNum </span><span class="s1">=== </span><span class="s0">'number'</span><span class="s1">) {</span>
                <span class="s2">link </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">createLink</span><span class="s1">(</span><span class="s2">dirLink</span><span class="s1">, </span><span class="s2">steps</span><span class="s1">[</span><span class="s2">steps</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">1</span><span class="s1">], </span><span class="s3">false</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">);</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">link</span><span class="s1">)</span>
            <span class="s3">return this</span><span class="s1">.</span><span class="s2">openLink</span><span class="s1">(</span><span class="s2">link</span><span class="s1">, </span><span class="s2">flagsNum</span><span class="s1">, </span><span class="s2">resolveSymlinks</span><span class="s1">);</span>
        <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ENOENT</span><span class="s1">, </span><span class="s0">'open'</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">openBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">flagsNum</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">, </span><span class="s2">resolveSymlinks</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">resolveSymlinks </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">resolveSymlinks </span><span class="s1">= </span><span class="s3">true</span><span class="s1">; }</span>
        <span class="s3">var </span><span class="s2">file </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">openFile</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">flagsNum</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">, </span><span class="s2">resolveSymlinks</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">file</span><span class="s1">)</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ENOENT</span><span class="s1">, </span><span class="s0">'open'</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">);</span>
        <span class="s3">return </span><span class="s2">file</span><span class="s1">.</span><span class="s2">fd</span><span class="s1">;</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">openSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">flags</span><span class="s1">, </span><span class="s2">mode</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">mode </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">mode </span><span class="s1">= </span><span class="s4">438 </span><span class="s5">/* MODE.DEFAULT */</span><span class="s1">; }</span>
        <span class="s5">// Validate (1) mode; (2) path; (3) flags - in that order.</span>
        <span class="s3">var </span><span class="s2">modeNum </span><span class="s1">= </span><span class="s2">modeToNumber</span><span class="s1">(</span><span class="s2">mode</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">fileName </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">flagsNum </span><span class="s1">= </span><span class="s2">flagsToNumber</span><span class="s1">(</span><span class="s2">flags</span><span class="s1">);</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">openBase</span><span class="s1">(</span><span class="s2">fileName</span><span class="s1">, </span><span class="s2">flagsNum</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">open </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">flags</span><span class="s1">, </span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">mode </span><span class="s1">= </span><span class="s2">a</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">callback </span><span class="s1">= </span><span class="s2">b</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">a </span><span class="s1">=== </span><span class="s0">'function'</span><span class="s1">) {</span>
            <span class="s2">mode </span><span class="s1">= </span><span class="s4">438 </span><span class="s5">/* MODE.DEFAULT */</span><span class="s1">;</span>
            <span class="s2">callback </span><span class="s1">= </span><span class="s2">a</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s2">mode </span><span class="s1">= </span><span class="s2">mode </span><span class="s1">|| </span><span class="s4">438 </span><span class="s5">/* MODE.DEFAULT */</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">modeNum </span><span class="s1">= </span><span class="s2">modeToNumber</span><span class="s1">(</span><span class="s2">mode</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">fileName </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">flagsNum </span><span class="s1">= </span><span class="s2">flagsToNumber</span><span class="s1">(</span><span class="s2">flags</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">openBase</span><span class="s1">, [</span><span class="s2">fileName</span><span class="s1">, </span><span class="s2">flagsNum</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">closeFile </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">file</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">fds</span><span class="s1">[</span><span class="s2">file</span><span class="s1">.</span><span class="s2">fd</span><span class="s1">])</span>
            <span class="s3">return</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">openFiles</span><span class="s1">--;</span>
        <span class="s3">delete this</span><span class="s1">.</span><span class="s2">fds</span><span class="s1">[</span><span class="s2">file</span><span class="s1">.</span><span class="s2">fd</span><span class="s1">];</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">releasedFds</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">file</span><span class="s1">.</span><span class="s2">fd</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">closeSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">) {</span>
        <span class="s2">validateFd</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">file </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getFileByFdOrThrow</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s0">'close'</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">closeFile</span><span class="s1">(</span><span class="s2">file</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">close </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
        <span class="s2">validateFd</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">closeSync</span><span class="s1">, [</span><span class="s2">fd</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">openFileOrGetById </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">id</span><span class="s1">, </span><span class="s2">flagsNum</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">id </span><span class="s1">=== </span><span class="s0">'number'</span><span class="s1">) {</span>
            <span class="s3">var </span><span class="s2">file </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">fds</span><span class="s1">[</span><span class="s2">id</span><span class="s1">];</span>
            <span class="s3">if </span><span class="s1">(!</span><span class="s2">file</span><span class="s1">)</span>
                <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ENOENT</span><span class="s1">);</span>
            <span class="s3">return </span><span class="s2">file</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s3">return this</span><span class="s1">.</span><span class="s2">openFile</span><span class="s1">(</span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">id</span><span class="s1">), </span><span class="s2">flagsNum</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">);</span>
        <span class="s1">}</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">readBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">buffer</span><span class="s1">, </span><span class="s2">offset</span><span class="s1">, </span><span class="s2">length</span><span class="s1">, </span><span class="s2">position</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">file </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getFileByFdOrThrow</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">);</span>
        <span class="s3">return </span><span class="s2">file</span><span class="s1">.</span><span class="s2">read</span><span class="s1">(</span><span class="s2">buffer</span><span class="s1">, </span><span class="s2">Number</span><span class="s1">(</span><span class="s2">offset</span><span class="s1">), </span><span class="s2">Number</span><span class="s1">(</span><span class="s2">length</span><span class="s1">), </span><span class="s2">position</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">readSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">buffer</span><span class="s1">, </span><span class="s2">offset</span><span class="s1">, </span><span class="s2">length</span><span class="s1">, </span><span class="s2">position</span><span class="s1">) {</span>
        <span class="s2">validateFd</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">);</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">readBase</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">buffer</span><span class="s1">, </span><span class="s2">offset</span><span class="s1">, </span><span class="s2">length</span><span class="s1">, </span><span class="s2">position</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">read </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">buffer</span><span class="s1">, </span><span class="s2">offset</span><span class="s1">, </span><span class="s2">length</span><span class="s1">, </span><span class="s2">position</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">_this </span><span class="s1">= </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s2">validateCallback</span><span class="s1">(</span><span class="s2">callback</span><span class="s1">);</span>
        <span class="s5">// This `if` branch is from Node.js</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">length </span><span class="s1">=== </span><span class="s4">0</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s2">process_1</span><span class="s1">.</span><span class="s2">default</span><span class="s1">.</span><span class="s2">nextTick</span><span class="s1">(</span><span class="s3">function </span><span class="s1">() {</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">callback</span><span class="s1">)</span>
                    <span class="s2">callback</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s2">buffer</span><span class="s1">);</span>
            <span class="s1">});</span>
        <span class="s1">}</span>
        <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">setImmediate_1</span><span class="s1">.</span><span class="s2">default</span><span class="s1">)(</span><span class="s3">function </span><span class="s1">() {</span>
            <span class="s3">try </span><span class="s1">{</span>
                <span class="s3">var </span><span class="s2">bytes </span><span class="s1">= </span><span class="s2">_this</span><span class="s1">.</span><span class="s2">readBase</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">buffer</span><span class="s1">, </span><span class="s2">offset</span><span class="s1">, </span><span class="s2">length</span><span class="s1">, </span><span class="s2">position</span><span class="s1">);</span>
                <span class="s2">callback</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s2">bytes</span><span class="s1">, </span><span class="s2">buffer</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s3">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
                <span class="s2">callback</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
            <span class="s1">}</span>
        <span class="s1">});</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">readFileBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">id</span><span class="s1">, </span><span class="s2">flagsNum</span><span class="s1">, </span><span class="s2">encoding</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">result</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">isUserFd </span><span class="s1">= </span><span class="s3">typeof </span><span class="s2">id </span><span class="s1">=== </span><span class="s0">'number'</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">userOwnsFd </span><span class="s1">= </span><span class="s2">isUserFd </span><span class="s1">&amp;&amp; </span><span class="s2">isFd</span><span class="s1">(</span><span class="s2">id</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">fd</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">userOwnsFd</span><span class="s1">)</span>
            <span class="s2">fd </span><span class="s1">= </span><span class="s2">id</span><span class="s1">;</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s3">var </span><span class="s2">filename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">id</span><span class="s1">);</span>
            <span class="s3">var </span><span class="s2">steps </span><span class="s1">= </span><span class="s2">filenameToSteps</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">);</span>
            <span class="s3">var </span><span class="s2">link </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getResolvedLink</span><span class="s1">(</span><span class="s2">steps</span><span class="s1">);</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">link</span><span class="s1">) {</span>
                <span class="s3">var </span><span class="s2">node </span><span class="s1">= </span><span class="s2">link</span><span class="s1">.</span><span class="s2">getNode</span><span class="s1">();</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">isDirectory</span><span class="s1">())</span>
                    <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">EISDIR</span><span class="s1">, </span><span class="s0">'open'</span><span class="s1">, </span><span class="s2">link</span><span class="s1">.</span><span class="s2">getPath</span><span class="s1">());</span>
            <span class="s1">}</span>
            <span class="s2">fd </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">openSync</span><span class="s1">(</span><span class="s2">id</span><span class="s1">, </span><span class="s2">flagsNum</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">try </span><span class="s1">{</span>
            <span class="s2">result </span><span class="s1">= </span><span class="s2">bufferToEncoding</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">getFileByFdOrThrow</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">).</span><span class="s2">getBuffer</span><span class="s1">(), </span><span class="s2">encoding</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">finally </span><span class="s1">{</span>
            <span class="s3">if </span><span class="s1">(!</span><span class="s2">userOwnsFd</span><span class="s1">) {</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">closeSync</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">);</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s3">return </span><span class="s2">result</span><span class="s1">;</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">readFileSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">file</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">opts </span><span class="s1">= </span><span class="s2">getReadFileOptions</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">flagsNum </span><span class="s1">= </span><span class="s2">flagsToNumber</span><span class="s1">(</span><span class="s2">opts</span><span class="s1">.</span><span class="s2">flag</span><span class="s1">);</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">readFileBase</span><span class="s1">(</span><span class="s2">file</span><span class="s1">, </span><span class="s2">flagsNum</span><span class="s1">, </span><span class="s2">opts</span><span class="s1">.</span><span class="s2">encoding</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">readFile </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">id</span><span class="s1">, </span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">_a </span><span class="s1">= </span><span class="s2">optsAndCbGenerator</span><span class="s1">(</span><span class="s2">getReadFileOptions</span><span class="s1">)(</span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">), </span><span class="s2">opts </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">[</span><span class="s4">0</span><span class="s1">], </span><span class="s2">callback </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
        <span class="s3">var </span><span class="s2">flagsNum </span><span class="s1">= </span><span class="s2">flagsToNumber</span><span class="s1">(</span><span class="s2">opts</span><span class="s1">.</span><span class="s2">flag</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">readFileBase</span><span class="s1">, [</span><span class="s2">id</span><span class="s1">, </span><span class="s2">flagsNum</span><span class="s1">, </span><span class="s2">opts</span><span class="s1">.</span><span class="s2">encoding</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">writeBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">buf</span><span class="s1">, </span><span class="s2">offset</span><span class="s1">, </span><span class="s2">length</span><span class="s1">, </span><span class="s2">position</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">file </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getFileByFdOrThrow</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s0">'write'</span><span class="s1">);</span>
        <span class="s3">return </span><span class="s2">file</span><span class="s1">.</span><span class="s2">write</span><span class="s1">(</span><span class="s2">buf</span><span class="s1">, </span><span class="s2">offset</span><span class="s1">, </span><span class="s2">length</span><span class="s1">, </span><span class="s2">position</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">writeSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">, </span><span class="s2">c</span><span class="s1">, </span><span class="s2">d</span><span class="s1">) {</span>
        <span class="s2">validateFd</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">encoding</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">offset</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">length</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">position</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">isBuffer </span><span class="s1">= </span><span class="s3">typeof </span><span class="s2">a </span><span class="s1">!== </span><span class="s0">'string'</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">isBuffer</span><span class="s1">) {</span>
            <span class="s2">offset </span><span class="s1">= (</span><span class="s2">b </span><span class="s1">|| </span><span class="s4">0</span><span class="s1">) | </span><span class="s4">0</span><span class="s1">;</span>
            <span class="s2">length </span><span class="s1">= </span><span class="s2">c</span><span class="s1">;</span>
            <span class="s2">position </span><span class="s1">= </span><span class="s2">d</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s2">position </span><span class="s1">= </span><span class="s2">b</span><span class="s1">;</span>
            <span class="s2">encoding </span><span class="s1">= </span><span class="s2">c</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">var </span><span class="s2">buf </span><span class="s1">= </span><span class="s2">dataToBuffer</span><span class="s1">(</span><span class="s2">a</span><span class="s1">, </span><span class="s2">encoding</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">isBuffer</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">length </span><span class="s1">=== </span><span class="s0">'undefined'</span><span class="s1">) {</span>
                <span class="s2">length </span><span class="s1">= </span><span class="s2">buf</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s2">offset </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
            <span class="s2">length </span><span class="s1">= </span><span class="s2">buf</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">writeBase</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">buf</span><span class="s1">, </span><span class="s2">offset</span><span class="s1">, </span><span class="s2">length</span><span class="s1">, </span><span class="s2">position</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">write </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">, </span><span class="s2">c</span><span class="s1">, </span><span class="s2">d</span><span class="s1">, </span><span class="s2">e</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">_this </span><span class="s1">= </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s2">validateFd</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">offset</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">length</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">position</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">encoding</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">callback</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">tipa </span><span class="s1">= </span><span class="s3">typeof </span><span class="s2">a</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">tipb </span><span class="s1">= </span><span class="s3">typeof </span><span class="s2">b</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">tipc </span><span class="s1">= </span><span class="s3">typeof </span><span class="s2">c</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">tipd </span><span class="s1">= </span><span class="s3">typeof </span><span class="s2">d</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">tipa </span><span class="s1">!== </span><span class="s0">'string'</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">tipb </span><span class="s1">=== </span><span class="s0">'function'</span><span class="s1">) {</span>
                <span class="s2">callback </span><span class="s1">= </span><span class="s2">b</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s3">else if </span><span class="s1">(</span><span class="s2">tipc </span><span class="s1">=== </span><span class="s0">'function'</span><span class="s1">) {</span>
                <span class="s2">offset </span><span class="s1">= </span><span class="s2">b </span><span class="s1">| </span><span class="s4">0</span><span class="s1">;</span>
                <span class="s2">callback </span><span class="s1">= </span><span class="s2">c</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s3">else if </span><span class="s1">(</span><span class="s2">tipd </span><span class="s1">=== </span><span class="s0">'function'</span><span class="s1">) {</span>
                <span class="s2">offset </span><span class="s1">= </span><span class="s2">b </span><span class="s1">| </span><span class="s4">0</span><span class="s1">;</span>
                <span class="s2">length </span><span class="s1">= </span><span class="s2">c</span><span class="s1">;</span>
                <span class="s2">callback </span><span class="s1">= </span><span class="s2">d</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s3">else </span><span class="s1">{</span>
                <span class="s2">offset </span><span class="s1">= </span><span class="s2">b </span><span class="s1">| </span><span class="s4">0</span><span class="s1">;</span>
                <span class="s2">length </span><span class="s1">= </span><span class="s2">c</span><span class="s1">;</span>
                <span class="s2">position </span><span class="s1">= </span><span class="s2">d</span><span class="s1">;</span>
                <span class="s2">callback </span><span class="s1">= </span><span class="s2">e</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">tipb </span><span class="s1">=== </span><span class="s0">'function'</span><span class="s1">) {</span>
                <span class="s2">callback </span><span class="s1">= </span><span class="s2">b</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s3">else if </span><span class="s1">(</span><span class="s2">tipc </span><span class="s1">=== </span><span class="s0">'function'</span><span class="s1">) {</span>
                <span class="s2">position </span><span class="s1">= </span><span class="s2">b</span><span class="s1">;</span>
                <span class="s2">callback </span><span class="s1">= </span><span class="s2">c</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s3">else if </span><span class="s1">(</span><span class="s2">tipd </span><span class="s1">=== </span><span class="s0">'function'</span><span class="s1">) {</span>
                <span class="s2">position </span><span class="s1">= </span><span class="s2">b</span><span class="s1">;</span>
                <span class="s2">encoding </span><span class="s1">= </span><span class="s2">c</span><span class="s1">;</span>
                <span class="s2">callback </span><span class="s1">= </span><span class="s2">d</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s3">var </span><span class="s2">buf </span><span class="s1">= </span><span class="s2">dataToBuffer</span><span class="s1">(</span><span class="s2">a</span><span class="s1">, </span><span class="s2">encoding</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">tipa </span><span class="s1">!== </span><span class="s0">'string'</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">length </span><span class="s1">=== </span><span class="s0">'undefined'</span><span class="s1">)</span>
                <span class="s2">length </span><span class="s1">= </span><span class="s2">buf</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s2">offset </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
            <span class="s2">length </span><span class="s1">= </span><span class="s2">buf</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">var </span><span class="s2">cb </span><span class="s1">= </span><span class="s2">validateCallback</span><span class="s1">(</span><span class="s2">callback</span><span class="s1">);</span>
        <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">setImmediate_1</span><span class="s1">.</span><span class="s2">default</span><span class="s1">)(</span><span class="s3">function </span><span class="s1">() {</span>
            <span class="s3">try </span><span class="s1">{</span>
                <span class="s3">var </span><span class="s2">bytes </span><span class="s1">= </span><span class="s2">_this</span><span class="s1">.</span><span class="s2">writeBase</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">buf</span><span class="s1">, </span><span class="s2">offset</span><span class="s1">, </span><span class="s2">length</span><span class="s1">, </span><span class="s2">position</span><span class="s1">);</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">tipa </span><span class="s1">!== </span><span class="s0">'string'</span><span class="s1">) {</span>
                    <span class="s2">cb</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s2">bytes</span><span class="s1">, </span><span class="s2">buf</span><span class="s1">);</span>
                <span class="s1">}</span>
                <span class="s3">else </span><span class="s1">{</span>
                    <span class="s2">cb</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s2">bytes</span><span class="s1">, </span><span class="s2">a</span><span class="s1">);</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
            <span class="s3">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
                <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
            <span class="s1">}</span>
        <span class="s1">});</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">writeFileBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">id</span><span class="s1">, </span><span class="s2">buf</span><span class="s1">, </span><span class="s2">flagsNum</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">) {</span>
        <span class="s5">// console.log('writeFileBase', id, buf, flagsNum, modeNum);</span>
        <span class="s5">// const node = this.getNodeByIdOrCreate(id, flagsNum, modeNum);</span>
        <span class="s5">// node.setBuffer(buf);</span>
        <span class="s3">var </span><span class="s2">isUserFd </span><span class="s1">= </span><span class="s3">typeof </span><span class="s2">id </span><span class="s1">=== </span><span class="s0">'number'</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">fd</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">isUserFd</span><span class="s1">)</span>
            <span class="s2">fd </span><span class="s1">= </span><span class="s2">id</span><span class="s1">;</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s2">fd </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">openBase</span><span class="s1">(</span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">id</span><span class="s1">), </span><span class="s2">flagsNum</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">);</span>
            <span class="s5">// fd = this.openSync(id as PathLike, flagsNum, modeNum);</span>
        <span class="s1">}</span>
        <span class="s3">var </span><span class="s2">offset </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">length </span><span class="s1">= </span><span class="s2">buf</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">position </span><span class="s1">= </span><span class="s2">flagsNum </span><span class="s1">&amp; </span><span class="s2">O_APPEND </span><span class="s1">? </span><span class="s2">undefined </span><span class="s1">: </span><span class="s4">0</span><span class="s1">;</span>
        <span class="s3">try </span><span class="s1">{</span>
            <span class="s3">while </span><span class="s1">(</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s4">0</span><span class="s1">) {</span>
                <span class="s3">var </span><span class="s2">written </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">writeSync</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">buf</span><span class="s1">, </span><span class="s2">offset</span><span class="s1">, </span><span class="s2">length</span><span class="s1">, </span><span class="s2">position</span><span class="s1">);</span>
                <span class="s2">offset </span><span class="s1">+= </span><span class="s2">written</span><span class="s1">;</span>
                <span class="s2">length </span><span class="s1">-= </span><span class="s2">written</span><span class="s1">;</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">position </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">)</span>
                    <span class="s2">position </span><span class="s1">+= </span><span class="s2">written</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s3">finally </span><span class="s1">{</span>
            <span class="s3">if </span><span class="s1">(!</span><span class="s2">isUserFd</span><span class="s1">)</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">closeSync</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">);</span>
        <span class="s1">}</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">writeFileSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">id</span><span class="s1">, </span><span class="s2">data</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">opts </span><span class="s1">= </span><span class="s2">getWriteFileOptions</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">flagsNum </span><span class="s1">= </span><span class="s2">flagsToNumber</span><span class="s1">(</span><span class="s2">opts</span><span class="s1">.</span><span class="s2">flag</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">modeNum </span><span class="s1">= </span><span class="s2">modeToNumber</span><span class="s1">(</span><span class="s2">opts</span><span class="s1">.</span><span class="s2">mode</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">buf </span><span class="s1">= </span><span class="s2">dataToBuffer</span><span class="s1">(</span><span class="s2">data</span><span class="s1">, </span><span class="s2">opts</span><span class="s1">.</span><span class="s2">encoding</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">writeFileBase</span><span class="s1">(</span><span class="s2">id</span><span class="s1">, </span><span class="s2">buf</span><span class="s1">, </span><span class="s2">flagsNum</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">writeFile </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">id</span><span class="s1">, </span><span class="s2">data</span><span class="s1">, </span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">options </span><span class="s1">= </span><span class="s2">a</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">callback </span><span class="s1">= </span><span class="s2">b</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">a </span><span class="s1">=== </span><span class="s0">'function'</span><span class="s1">) {</span>
            <span class="s2">options </span><span class="s1">= </span><span class="s2">writeFileDefaults</span><span class="s1">;</span>
            <span class="s2">callback </span><span class="s1">= </span><span class="s2">a</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">var </span><span class="s2">cb </span><span class="s1">= </span><span class="s2">validateCallback</span><span class="s1">(</span><span class="s2">callback</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">opts </span><span class="s1">= </span><span class="s2">getWriteFileOptions</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">flagsNum </span><span class="s1">= </span><span class="s2">flagsToNumber</span><span class="s1">(</span><span class="s2">opts</span><span class="s1">.</span><span class="s2">flag</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">modeNum </span><span class="s1">= </span><span class="s2">modeToNumber</span><span class="s1">(</span><span class="s2">opts</span><span class="s1">.</span><span class="s2">mode</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">buf </span><span class="s1">= </span><span class="s2">dataToBuffer</span><span class="s1">(</span><span class="s2">data</span><span class="s1">, </span><span class="s2">opts</span><span class="s1">.</span><span class="s2">encoding</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">writeFileBase</span><span class="s1">, [</span><span class="s2">id</span><span class="s1">, </span><span class="s2">buf</span><span class="s1">, </span><span class="s2">flagsNum</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">], </span><span class="s2">cb</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">linkBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">filename1</span><span class="s1">, </span><span class="s2">filename2</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">steps1 </span><span class="s1">= </span><span class="s2">filenameToSteps</span><span class="s1">(</span><span class="s2">filename1</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">link1 </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getLink</span><span class="s1">(</span><span class="s2">steps1</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">link1</span><span class="s1">)</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ENOENT</span><span class="s1">, </span><span class="s0">'link'</span><span class="s1">, </span><span class="s2">filename1</span><span class="s1">, </span><span class="s2">filename2</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">steps2 </span><span class="s1">= </span><span class="s2">filenameToSteps</span><span class="s1">(</span><span class="s2">filename2</span><span class="s1">);</span>
        <span class="s5">// Check new link directory exists.</span>
        <span class="s3">var </span><span class="s2">dir2 </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getLinkParent</span><span class="s1">(</span><span class="s2">steps2</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">dir2</span><span class="s1">)</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ENOENT</span><span class="s1">, </span><span class="s0">'link'</span><span class="s1">, </span><span class="s2">filename1</span><span class="s1">, </span><span class="s2">filename2</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">name </span><span class="s1">= </span><span class="s2">steps2</span><span class="s1">[</span><span class="s2">steps2</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">1</span><span class="s1">];</span>
        <span class="s5">// Check if new file already exists.</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">dir2</span><span class="s1">.</span><span class="s2">getChild</span><span class="s1">(</span><span class="s2">name</span><span class="s1">))</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">EEXIST</span><span class="s1">, </span><span class="s0">'link'</span><span class="s1">, </span><span class="s2">filename1</span><span class="s1">, </span><span class="s2">filename2</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">node </span><span class="s1">= </span><span class="s2">link1</span><span class="s1">.</span><span class="s2">getNode</span><span class="s1">();</span>
        <span class="s2">node</span><span class="s1">.</span><span class="s2">nlink</span><span class="s1">++;</span>
        <span class="s2">dir2</span><span class="s1">.</span><span class="s2">createChild</span><span class="s1">(</span><span class="s2">name</span><span class="s1">, </span><span class="s2">node</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">copyFileBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">src</span><span class="s1">, </span><span class="s2">dest</span><span class="s1">, </span><span class="s2">flags</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">buf </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">readFileSync</span><span class="s1">(</span><span class="s2">src</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">flags </span><span class="s1">&amp; </span><span class="s2">COPYFILE_EXCL</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">existsSync</span><span class="s1">(</span><span class="s2">dest</span><span class="s1">)) {</span>
                <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">EEXIST</span><span class="s1">, </span><span class="s0">'copyFile'</span><span class="s1">, </span><span class="s2">src</span><span class="s1">, </span><span class="s2">dest</span><span class="s1">);</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">flags </span><span class="s1">&amp; </span><span class="s2">COPYFILE_FICLONE_FORCE</span><span class="s1">) {</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ENOSYS</span><span class="s1">, </span><span class="s0">'copyFile'</span><span class="s1">, </span><span class="s2">src</span><span class="s1">, </span><span class="s2">dest</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">writeFileBase</span><span class="s1">(</span><span class="s2">dest</span><span class="s1">, </span><span class="s2">buf</span><span class="s1">, </span><span class="s2">FLAGS</span><span class="s1">.</span><span class="s2">w</span><span class="s1">, </span><span class="s4">438 </span><span class="s5">/* MODE.DEFAULT */</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">copyFileSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">src</span><span class="s1">, </span><span class="s2">dest</span><span class="s1">, </span><span class="s2">flags</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">srcFilename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">src</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">destFilename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">dest</span><span class="s1">);</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">copyFileBase</span><span class="s1">(</span><span class="s2">srcFilename</span><span class="s1">, </span><span class="s2">destFilename</span><span class="s1">, (</span><span class="s2">flags </span><span class="s1">|| </span><span class="s4">0</span><span class="s1">) | </span><span class="s4">0</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">copyFile </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">src</span><span class="s1">, </span><span class="s2">dest</span><span class="s1">, </span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">srcFilename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">src</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">destFilename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">dest</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">flags</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">callback</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">a </span><span class="s1">=== </span><span class="s0">'function'</span><span class="s1">) {</span>
            <span class="s2">flags </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
            <span class="s2">callback </span><span class="s1">= </span><span class="s2">a</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s2">flags </span><span class="s1">= </span><span class="s2">a</span><span class="s1">;</span>
            <span class="s2">callback </span><span class="s1">= </span><span class="s2">b</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s2">validateCallback</span><span class="s1">(</span><span class="s2">callback</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">copyFileBase</span><span class="s1">, [</span><span class="s2">srcFilename</span><span class="s1">, </span><span class="s2">destFilename</span><span class="s1">, </span><span class="s2">flags</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">linkSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">existingPath</span><span class="s1">, </span><span class="s2">newPath</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">existingPathFilename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">existingPath</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">newPathFilename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">newPath</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">linkBase</span><span class="s1">(</span><span class="s2">existingPathFilename</span><span class="s1">, </span><span class="s2">newPathFilename</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">link </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">existingPath</span><span class="s1">, </span><span class="s2">newPath</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">existingPathFilename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">existingPath</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">newPathFilename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">newPath</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">linkBase</span><span class="s1">, [</span><span class="s2">existingPathFilename</span><span class="s1">, </span><span class="s2">newPathFilename</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">unlinkBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">filename</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">steps </span><span class="s1">= </span><span class="s2">filenameToSteps</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">link </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getLink</span><span class="s1">(</span><span class="s2">steps</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">link</span><span class="s1">)</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ENOENT</span><span class="s1">, </span><span class="s0">'unlink'</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">);</span>
        <span class="s5">// TODO: Check if it is file, dir, other...</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">link</span><span class="s1">.</span><span class="s2">length</span><span class="s1">)</span>
            <span class="s3">throw </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'Dir not empty...'</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">deleteLink</span><span class="s1">(</span><span class="s2">link</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">node </span><span class="s1">= </span><span class="s2">link</span><span class="s1">.</span><span class="s2">getNode</span><span class="s1">();</span>
        <span class="s2">node</span><span class="s1">.</span><span class="s2">nlink</span><span class="s1">--;</span>
        <span class="s5">// When all hard links to i-node are deleted, remove the i-node, too.</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">nlink </span><span class="s1">&lt;= </span><span class="s4">0</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">deleteNode</span><span class="s1">(</span><span class="s2">node</span><span class="s1">);</span>
        <span class="s1">}</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">unlinkSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">filename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">unlinkBase</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">unlink </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">filename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">unlinkBase</span><span class="s1">, [</span><span class="s2">filename</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">symlinkBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">targetFilename</span><span class="s1">, </span><span class="s2">pathFilename</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">pathSteps </span><span class="s1">= </span><span class="s2">filenameToSteps</span><span class="s1">(</span><span class="s2">pathFilename</span><span class="s1">);</span>
        <span class="s5">// Check if directory exists, where we about to create a symlink.</span>
        <span class="s3">var </span><span class="s2">dirLink </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getLinkParent</span><span class="s1">(</span><span class="s2">pathSteps</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">dirLink</span><span class="s1">)</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ENOENT</span><span class="s1">, </span><span class="s0">'symlink'</span><span class="s1">, </span><span class="s2">targetFilename</span><span class="s1">, </span><span class="s2">pathFilename</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">name </span><span class="s1">= </span><span class="s2">pathSteps</span><span class="s1">[</span><span class="s2">pathSteps</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">1</span><span class="s1">];</span>
        <span class="s5">// Check if new file already exists.</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">dirLink</span><span class="s1">.</span><span class="s2">getChild</span><span class="s1">(</span><span class="s2">name</span><span class="s1">))</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">EEXIST</span><span class="s1">, </span><span class="s0">'symlink'</span><span class="s1">, </span><span class="s2">targetFilename</span><span class="s1">, </span><span class="s2">pathFilename</span><span class="s1">);</span>
        <span class="s5">// Create symlink.</span>
        <span class="s3">var </span><span class="s2">symlink </span><span class="s1">= </span><span class="s2">dirLink</span><span class="s1">.</span><span class="s2">createChild</span><span class="s1">(</span><span class="s2">name</span><span class="s1">);</span>
        <span class="s2">symlink</span><span class="s1">.</span><span class="s2">getNode</span><span class="s1">().</span><span class="s2">makeSymlink</span><span class="s1">(</span><span class="s2">filenameToSteps</span><span class="s1">(</span><span class="s2">targetFilename</span><span class="s1">));</span>
        <span class="s3">return </span><span class="s2">symlink</span><span class="s1">;</span>
    <span class="s1">};</span>
    <span class="s5">// `type` argument works only on Windows.</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">symlinkSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">target</span><span class="s1">, </span><span class="s2">path</span><span class="s1">, </span><span class="s2">type</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">targetFilename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">target</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">pathFilename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">symlinkBase</span><span class="s1">(</span><span class="s2">targetFilename</span><span class="s1">, </span><span class="s2">pathFilename</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">symlink </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">target</span><span class="s1">, </span><span class="s2">path</span><span class="s1">, </span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">callback </span><span class="s1">= </span><span class="s2">validateCallback</span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">a </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">? </span><span class="s2">a </span><span class="s1">: </span><span class="s2">b</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">targetFilename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">target</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">pathFilename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">symlinkBase</span><span class="s1">, [</span><span class="s2">targetFilename</span><span class="s1">, </span><span class="s2">pathFilename</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">realpathBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">encoding</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">steps </span><span class="s1">= </span><span class="s2">filenameToSteps</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">realLink </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getResolvedLink</span><span class="s1">(</span><span class="s2">steps</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">realLink</span><span class="s1">)</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ENOENT</span><span class="s1">, </span><span class="s0">'realpath'</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">);</span>
        <span class="s3">return </span><span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">encoding_1</span><span class="s1">.</span><span class="s2">strToEncoding</span><span class="s1">)(</span><span class="s2">realLink</span><span class="s1">.</span><span class="s2">getPath</span><span class="s1">() || </span><span class="s0">'/'</span><span class="s1">, </span><span class="s2">encoding</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">realpathSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">realpathBase</span><span class="s1">(</span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">), </span><span class="s2">getRealpathOptions</span><span class="s1">(</span><span class="s2">options</span><span class="s1">).</span><span class="s2">encoding</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">realpath </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">_a </span><span class="s1">= </span><span class="s2">getRealpathOptsAndCb</span><span class="s1">(</span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">), </span><span class="s2">opts </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">[</span><span class="s4">0</span><span class="s1">], </span><span class="s2">callback </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
        <span class="s3">var </span><span class="s2">pathFilename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">realpathBase</span><span class="s1">, [</span><span class="s2">pathFilename</span><span class="s1">, </span><span class="s2">opts</span><span class="s1">.</span><span class="s2">encoding</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">lstatBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">bigint</span><span class="s1">, </span><span class="s2">throwIfNoEntry</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">bigint </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">bigint </span><span class="s1">= </span><span class="s3">false</span><span class="s1">; }</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">throwIfNoEntry </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">throwIfNoEntry </span><span class="s1">= </span><span class="s3">false</span><span class="s1">; }</span>
        <span class="s3">var </span><span class="s2">link </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getLink</span><span class="s1">(</span><span class="s2">filenameToSteps</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">));</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">link</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s2">Stats_1</span><span class="s1">.</span><span class="s2">default</span><span class="s1">.</span><span class="s2">build</span><span class="s1">(</span><span class="s2">link</span><span class="s1">.</span><span class="s2">getNode</span><span class="s1">(), </span><span class="s2">bigint</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">else if </span><span class="s1">(!</span><span class="s2">throwIfNoEntry</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s2">undefined</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ENOENT</span><span class="s1">, </span><span class="s0">'lstat'</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">);</span>
        <span class="s1">}</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">lstatSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">_a </span><span class="s1">= </span><span class="s2">getStatOptions</span><span class="s1">(</span><span class="s2">options</span><span class="s1">), </span><span class="s2">_b </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">.</span><span class="s2">throwIfNoEntry</span><span class="s1">, </span><span class="s2">throwIfNoEntry </span><span class="s1">= </span><span class="s2">_b </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0 </span><span class="s1">? </span><span class="s3">true </span><span class="s1">: </span><span class="s2">_b</span><span class="s1">, </span><span class="s2">_c </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">.</span><span class="s2">bigint</span><span class="s1">, </span><span class="s2">bigint </span><span class="s1">= </span><span class="s2">_c </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0 </span><span class="s1">? </span><span class="s3">false </span><span class="s1">: </span><span class="s2">_c</span><span class="s1">;</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">lstatBase</span><span class="s1">(</span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">), </span><span class="s2">bigint</span><span class="s1">, </span><span class="s2">throwIfNoEntry</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">lstat </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">_a </span><span class="s1">= </span><span class="s2">getStatOptsAndCb</span><span class="s1">(</span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">), </span><span class="s2">_b </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">[</span><span class="s4">0</span><span class="s1">], </span><span class="s2">_c </span><span class="s1">= </span><span class="s2">_b</span><span class="s1">.</span><span class="s2">throwIfNoEntry</span><span class="s1">, </span><span class="s2">throwIfNoEntry </span><span class="s1">= </span><span class="s2">_c </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0 </span><span class="s1">? </span><span class="s3">true </span><span class="s1">: </span><span class="s2">_c</span><span class="s1">, </span><span class="s2">_d </span><span class="s1">= </span><span class="s2">_b</span><span class="s1">.</span><span class="s2">bigint</span><span class="s1">, </span><span class="s2">bigint </span><span class="s1">= </span><span class="s2">_d </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0 </span><span class="s1">? </span><span class="s3">false </span><span class="s1">: </span><span class="s2">_d</span><span class="s1">, </span><span class="s2">callback </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">lstatBase</span><span class="s1">, [</span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">), </span><span class="s2">bigint</span><span class="s1">, </span><span class="s2">throwIfNoEntry</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">statBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">bigint</span><span class="s1">, </span><span class="s2">throwIfNoEntry</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">bigint </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">bigint </span><span class="s1">= </span><span class="s3">false</span><span class="s1">; }</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">throwIfNoEntry </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">throwIfNoEntry </span><span class="s1">= </span><span class="s3">true</span><span class="s1">; }</span>
        <span class="s3">var </span><span class="s2">link </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getResolvedLink</span><span class="s1">(</span><span class="s2">filenameToSteps</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">));</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">link</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s2">Stats_1</span><span class="s1">.</span><span class="s2">default</span><span class="s1">.</span><span class="s2">build</span><span class="s1">(</span><span class="s2">link</span><span class="s1">.</span><span class="s2">getNode</span><span class="s1">(), </span><span class="s2">bigint</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">else if </span><span class="s1">(!</span><span class="s2">throwIfNoEntry</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s2">undefined</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ENOENT</span><span class="s1">, </span><span class="s0">'stat'</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">);</span>
        <span class="s1">}</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">statSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">_a </span><span class="s1">= </span><span class="s2">getStatOptions</span><span class="s1">(</span><span class="s2">options</span><span class="s1">), </span><span class="s2">_b </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">.</span><span class="s2">bigint</span><span class="s1">, </span><span class="s2">bigint </span><span class="s1">= </span><span class="s2">_b </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0 </span><span class="s1">? </span><span class="s3">true </span><span class="s1">: </span><span class="s2">_b</span><span class="s1">, </span><span class="s2">_c </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">.</span><span class="s2">throwIfNoEntry</span><span class="s1">, </span><span class="s2">throwIfNoEntry </span><span class="s1">= </span><span class="s2">_c </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0 </span><span class="s1">? </span><span class="s3">true </span><span class="s1">: </span><span class="s2">_c</span><span class="s1">;</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">statBase</span><span class="s1">(</span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">), </span><span class="s2">bigint</span><span class="s1">, </span><span class="s2">throwIfNoEntry</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">stat </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">_a </span><span class="s1">= </span><span class="s2">getStatOptsAndCb</span><span class="s1">(</span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">), </span><span class="s2">_b </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">[</span><span class="s4">0</span><span class="s1">], </span><span class="s2">_c </span><span class="s1">= </span><span class="s2">_b</span><span class="s1">.</span><span class="s2">bigint</span><span class="s1">, </span><span class="s2">bigint </span><span class="s1">= </span><span class="s2">_c </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0 </span><span class="s1">? </span><span class="s3">false </span><span class="s1">: </span><span class="s2">_c</span><span class="s1">, </span><span class="s2">_d </span><span class="s1">= </span><span class="s2">_b</span><span class="s1">.</span><span class="s2">throwIfNoEntry</span><span class="s1">, </span><span class="s2">throwIfNoEntry </span><span class="s1">= </span><span class="s2">_d </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0 </span><span class="s1">? </span><span class="s3">true </span><span class="s1">: </span><span class="s2">_d</span><span class="s1">, </span><span class="s2">callback </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">statBase</span><span class="s1">, [</span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">), </span><span class="s2">bigint</span><span class="s1">, </span><span class="s2">throwIfNoEntry</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">fstatBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">bigint</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">bigint </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">bigint </span><span class="s1">= </span><span class="s3">false</span><span class="s1">; }</span>
        <span class="s3">var </span><span class="s2">file </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getFileByFd</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">file</span><span class="s1">)</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">EBADF</span><span class="s1">, </span><span class="s0">'fstat'</span><span class="s1">);</span>
        <span class="s3">return </span><span class="s2">Stats_1</span><span class="s1">.</span><span class="s2">default</span><span class="s1">.</span><span class="s2">build</span><span class="s1">(</span><span class="s2">file</span><span class="s1">.</span><span class="s2">node</span><span class="s1">, </span><span class="s2">bigint</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">fstatSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">fstatBase</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">getStatOptions</span><span class="s1">(</span><span class="s2">options</span><span class="s1">).</span><span class="s2">bigint</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">fstat </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">_a </span><span class="s1">= </span><span class="s2">getStatOptsAndCb</span><span class="s1">(</span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">), </span><span class="s2">opts </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">[</span><span class="s4">0</span><span class="s1">], </span><span class="s2">callback </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">fstatBase</span><span class="s1">, [</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">opts</span><span class="s1">.</span><span class="s2">bigint</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">renameBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">oldPathFilename</span><span class="s1">, </span><span class="s2">newPathFilename</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">link </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getLink</span><span class="s1">(</span><span class="s2">filenameToSteps</span><span class="s1">(</span><span class="s2">oldPathFilename</span><span class="s1">));</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">link</span><span class="s1">)</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ENOENT</span><span class="s1">, </span><span class="s0">'rename'</span><span class="s1">, </span><span class="s2">oldPathFilename</span><span class="s1">, </span><span class="s2">newPathFilename</span><span class="s1">);</span>
        <span class="s5">// TODO: Check if it is directory, if non-empty, we cannot move it, right?</span>
        <span class="s3">var </span><span class="s2">newPathSteps </span><span class="s1">= </span><span class="s2">filenameToSteps</span><span class="s1">(</span><span class="s2">newPathFilename</span><span class="s1">);</span>
        <span class="s5">// Check directory exists for the new location.</span>
        <span class="s3">var </span><span class="s2">newPathDirLink </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getLinkParent</span><span class="s1">(</span><span class="s2">newPathSteps</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">newPathDirLink</span><span class="s1">)</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ENOENT</span><span class="s1">, </span><span class="s0">'rename'</span><span class="s1">, </span><span class="s2">oldPathFilename</span><span class="s1">, </span><span class="s2">newPathFilename</span><span class="s1">);</span>
        <span class="s5">// TODO: Also treat cases with directories and symbolic links.</span>
        <span class="s5">// TODO: See: http://man7.org/linux/man-pages/man2/rename.2.html</span>
        <span class="s5">// Remove hard link from old folder.</span>
        <span class="s3">var </span><span class="s2">oldLinkParent </span><span class="s1">= </span><span class="s2">link</span><span class="s1">.</span><span class="s2">parent</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">oldLinkParent</span><span class="s1">) {</span>
            <span class="s2">oldLinkParent</span><span class="s1">.</span><span class="s2">deleteChild</span><span class="s1">(</span><span class="s2">link</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s5">// Rename should overwrite the new path, if that exists.</span>
        <span class="s3">var </span><span class="s2">name </span><span class="s1">= </span><span class="s2">newPathSteps</span><span class="s1">[</span><span class="s2">newPathSteps</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">1</span><span class="s1">];</span>
        <span class="s2">link</span><span class="s1">.</span><span class="s2">name </span><span class="s1">= </span><span class="s2">name</span><span class="s1">;</span>
        <span class="s2">link</span><span class="s1">.</span><span class="s2">steps </span><span class="s1">= </span><span class="s2">__spreadArray</span><span class="s1">(</span><span class="s2">__spreadArray</span><span class="s1">([], </span><span class="s2">newPathDirLink</span><span class="s1">.</span><span class="s2">steps</span><span class="s1">, </span><span class="s3">true</span><span class="s1">), [</span><span class="s2">name</span><span class="s1">], </span><span class="s3">false</span><span class="s1">);</span>
        <span class="s2">newPathDirLink</span><span class="s1">.</span><span class="s2">setChild</span><span class="s1">(</span><span class="s2">link</span><span class="s1">.</span><span class="s2">getName</span><span class="s1">(), </span><span class="s2">link</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">renameSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">oldPath</span><span class="s1">, </span><span class="s2">newPath</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">oldPathFilename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">oldPath</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">newPathFilename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">newPath</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">renameBase</span><span class="s1">(</span><span class="s2">oldPathFilename</span><span class="s1">, </span><span class="s2">newPathFilename</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">rename </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">oldPath</span><span class="s1">, </span><span class="s2">newPath</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">oldPathFilename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">oldPath</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">newPathFilename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">newPath</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">renameBase</span><span class="s1">, [</span><span class="s2">oldPathFilename</span><span class="s1">, </span><span class="s2">newPathFilename</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">existsBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">filename</span><span class="s1">) {</span>
        <span class="s3">return </span><span class="s1">!!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">statBase</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">existsSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">) {</span>
        <span class="s3">try </span><span class="s1">{</span>
            <span class="s3">return this</span><span class="s1">.</span><span class="s2">existsBase</span><span class="s1">(</span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">));</span>
        <span class="s1">}</span>
        <span class="s3">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
            <span class="s3">return false</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">exists </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">_this </span><span class="s1">= </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">filename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">callback </span><span class="s1">!== </span><span class="s0">'function'</span><span class="s1">)</span>
            <span class="s3">throw </span><span class="s2">Error</span><span class="s1">(</span><span class="s2">ERRSTR</span><span class="s1">.</span><span class="s2">CB</span><span class="s1">);</span>
        <span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">setImmediate_1</span><span class="s1">.</span><span class="s2">default</span><span class="s1">)(</span><span class="s3">function </span><span class="s1">() {</span>
            <span class="s3">try </span><span class="s1">{</span>
                <span class="s2">callback</span><span class="s1">(</span><span class="s2">_this</span><span class="s1">.</span><span class="s2">existsBase</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">));</span>
            <span class="s1">}</span>
            <span class="s3">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
                <span class="s2">callback</span><span class="s1">(</span><span class="s3">false</span><span class="s1">);</span>
            <span class="s1">}</span>
        <span class="s1">});</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">accessBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">mode</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">link </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getLinkOrThrow</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s0">'access'</span><span class="s1">);</span>
        <span class="s5">// TODO: Verify permissions</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">accessSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">mode</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">mode </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">mode </span><span class="s1">= </span><span class="s2">F_OK</span><span class="s1">; }</span>
        <span class="s3">var </span><span class="s2">filename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
        <span class="s2">mode </span><span class="s1">= </span><span class="s2">mode </span><span class="s1">| </span><span class="s4">0</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">accessBase</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">mode</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">access </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">mode </span><span class="s1">= </span><span class="s2">F_OK</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">callback</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">a </span><span class="s1">!== </span><span class="s0">'function'</span><span class="s1">) {</span>
            <span class="s2">mode </span><span class="s1">= </span><span class="s2">a </span><span class="s1">| </span><span class="s4">0</span><span class="s1">; </span><span class="s5">// cast to number</span>
            <span class="s2">callback </span><span class="s1">= </span><span class="s2">validateCallback</span><span class="s1">(</span><span class="s2">b</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s2">callback </span><span class="s1">= </span><span class="s2">a</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">var </span><span class="s2">filename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">accessBase</span><span class="s1">, [</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">mode</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">appendFileSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">id</span><span class="s1">, </span><span class="s2">data</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">options </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">options </span><span class="s1">= </span><span class="s2">appendFileDefaults</span><span class="s1">; }</span>
        <span class="s3">var </span><span class="s2">opts </span><span class="s1">= </span><span class="s2">getAppendFileOpts</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
        <span class="s5">// force append behavior when using a supplied file descriptor</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">opts</span><span class="s1">.</span><span class="s2">flag </span><span class="s1">|| </span><span class="s2">isFd</span><span class="s1">(</span><span class="s2">id</span><span class="s1">))</span>
            <span class="s2">opts</span><span class="s1">.</span><span class="s2">flag </span><span class="s1">= </span><span class="s0">'a'</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">writeFileSync</span><span class="s1">(</span><span class="s2">id</span><span class="s1">, </span><span class="s2">data</span><span class="s1">, </span><span class="s2">opts</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">appendFile </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">id</span><span class="s1">, </span><span class="s2">data</span><span class="s1">, </span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">_a </span><span class="s1">= </span><span class="s2">getAppendFileOptsAndCb</span><span class="s1">(</span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">), </span><span class="s2">opts </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">[</span><span class="s4">0</span><span class="s1">], </span><span class="s2">callback </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
        <span class="s5">// force append behavior when using a supplied file descriptor</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">opts</span><span class="s1">.</span><span class="s2">flag </span><span class="s1">|| </span><span class="s2">isFd</span><span class="s1">(</span><span class="s2">id</span><span class="s1">))</span>
            <span class="s2">opts</span><span class="s1">.</span><span class="s2">flag </span><span class="s1">= </span><span class="s0">'a'</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">writeFile</span><span class="s1">(</span><span class="s2">id</span><span class="s1">, </span><span class="s2">data</span><span class="s1">, </span><span class="s2">opts</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">readdirBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">steps </span><span class="s1">= </span><span class="s2">filenameToSteps</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">link </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getResolvedLink</span><span class="s1">(</span><span class="s2">steps</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">link</span><span class="s1">)</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ENOENT</span><span class="s1">, </span><span class="s0">'readdir'</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">node </span><span class="s1">= </span><span class="s2">link</span><span class="s1">.</span><span class="s2">getNode</span><span class="s1">();</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">node</span><span class="s1">.</span><span class="s2">isDirectory</span><span class="s1">())</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ENOTDIR</span><span class="s1">, </span><span class="s0">'scandir'</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">withFileTypes</span><span class="s1">) {</span>
            <span class="s3">var </span><span class="s2">list_1 </span><span class="s1">= [];</span>
            <span class="s3">for </span><span class="s1">(</span><span class="s3">var </span><span class="s2">name_2 </span><span class="s3">in </span><span class="s2">link</span><span class="s1">.</span><span class="s2">children</span><span class="s1">) {</span>
                <span class="s3">var </span><span class="s2">child </span><span class="s1">= </span><span class="s2">link</span><span class="s1">.</span><span class="s2">getChild</span><span class="s1">(</span><span class="s2">name_2</span><span class="s1">);</span>
                <span class="s3">if </span><span class="s1">(!</span><span class="s2">child </span><span class="s1">|| </span><span class="s2">name_2 </span><span class="s1">=== </span><span class="s0">'.' </span><span class="s1">|| </span><span class="s2">name_2 </span><span class="s1">=== </span><span class="s0">'..'</span><span class="s1">) {</span>
                    <span class="s3">continue</span><span class="s1">;</span>
                <span class="s1">}</span>
                <span class="s2">list_1</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">Dirent_1</span><span class="s1">.</span><span class="s2">default</span><span class="s1">.</span><span class="s2">build</span><span class="s1">(</span><span class="s2">child</span><span class="s1">, </span><span class="s2">options</span><span class="s1">.</span><span class="s2">encoding</span><span class="s1">));</span>
            <span class="s1">}</span>
            <span class="s3">if </span><span class="s1">(!</span><span class="s2">isWin </span><span class="s1">&amp;&amp; </span><span class="s2">options</span><span class="s1">.</span><span class="s2">encoding </span><span class="s1">!== </span><span class="s0">'buffer'</span><span class="s1">)</span>
                <span class="s2">list_1</span><span class="s1">.</span><span class="s2">sort</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) {</span>
                    <span class="s3">if </span><span class="s1">(</span><span class="s2">a</span><span class="s1">.</span><span class="s2">name </span><span class="s1">&lt; </span><span class="s2">b</span><span class="s1">.</span><span class="s2">name</span><span class="s1">)</span>
                        <span class="s3">return </span><span class="s1">-</span><span class="s4">1</span><span class="s1">;</span>
                    <span class="s3">if </span><span class="s1">(</span><span class="s2">a</span><span class="s1">.</span><span class="s2">name </span><span class="s1">&gt; </span><span class="s2">b</span><span class="s1">.</span><span class="s2">name</span><span class="s1">)</span>
                        <span class="s3">return </span><span class="s4">1</span><span class="s1">;</span>
                    <span class="s3">return </span><span class="s4">0</span><span class="s1">;</span>
                <span class="s1">});</span>
            <span class="s3">return </span><span class="s2">list_1</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">var </span><span class="s2">list </span><span class="s1">= [];</span>
        <span class="s3">for </span><span class="s1">(</span><span class="s3">var </span><span class="s2">name_3 </span><span class="s3">in </span><span class="s2">link</span><span class="s1">.</span><span class="s2">children</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">name_3 </span><span class="s1">=== </span><span class="s0">'.' </span><span class="s1">|| </span><span class="s2">name_3 </span><span class="s1">=== </span><span class="s0">'..'</span><span class="s1">) {</span>
                <span class="s3">continue</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s2">list</span><span class="s1">.</span><span class="s2">push</span><span class="s1">((</span><span class="s4">0</span><span class="s1">, </span><span class="s2">encoding_1</span><span class="s1">.</span><span class="s2">strToEncoding</span><span class="s1">)(</span><span class="s2">name_3</span><span class="s1">, </span><span class="s2">options</span><span class="s1">.</span><span class="s2">encoding</span><span class="s1">));</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">isWin </span><span class="s1">&amp;&amp; </span><span class="s2">options</span><span class="s1">.</span><span class="s2">encoding </span><span class="s1">!== </span><span class="s0">'buffer'</span><span class="s1">)</span>
            <span class="s2">list</span><span class="s1">.</span><span class="s2">sort</span><span class="s1">();</span>
        <span class="s3">return </span><span class="s2">list</span><span class="s1">;</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">readdirSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">opts </span><span class="s1">= </span><span class="s2">getReaddirOptions</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">filename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">readdirBase</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">opts</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">readdir </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">_a </span><span class="s1">= </span><span class="s2">getReaddirOptsAndCb</span><span class="s1">(</span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">), </span><span class="s2">options </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">[</span><span class="s4">0</span><span class="s1">], </span><span class="s2">callback </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
        <span class="s3">var </span><span class="s2">filename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">readdirBase</span><span class="s1">, [</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">options</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">readlinkBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">encoding</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">link </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getLinkOrThrow</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s0">'readlink'</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">node </span><span class="s1">= </span><span class="s2">link</span><span class="s1">.</span><span class="s2">getNode</span><span class="s1">();</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">node</span><span class="s1">.</span><span class="s2">isSymlink</span><span class="s1">())</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">EINVAL</span><span class="s1">, </span><span class="s0">'readlink'</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">str </span><span class="s1">= </span><span class="s2">sep </span><span class="s1">+ </span><span class="s2">node</span><span class="s1">.</span><span class="s2">symlink</span><span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s2">sep</span><span class="s1">);</span>
        <span class="s3">return </span><span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">encoding_1</span><span class="s1">.</span><span class="s2">strToEncoding</span><span class="s1">)(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">encoding</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">readlinkSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">opts </span><span class="s1">= </span><span class="s2">getDefaultOpts</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">filename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">readlinkBase</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">opts</span><span class="s1">.</span><span class="s2">encoding</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">readlink </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">_a </span><span class="s1">= </span><span class="s2">getDefaultOptsAndCb</span><span class="s1">(</span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">), </span><span class="s2">opts </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">[</span><span class="s4">0</span><span class="s1">], </span><span class="s2">callback </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
        <span class="s3">var </span><span class="s2">filename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">readlinkBase</span><span class="s1">, [</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">opts</span><span class="s1">.</span><span class="s2">encoding</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">fsyncBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">getFileByFdOrThrow</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s0">'fsync'</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">fsyncSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">fsyncBase</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">fsync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">fsyncBase</span><span class="s1">, [</span><span class="s2">fd</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">fdatasyncBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">getFileByFdOrThrow</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s0">'fdatasync'</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">fdatasyncSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">fdatasyncBase</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">fdatasync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">fdatasyncBase</span><span class="s1">, [</span><span class="s2">fd</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">ftruncateBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">len</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">file </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getFileByFdOrThrow</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s0">'ftruncate'</span><span class="s1">);</span>
        <span class="s2">file</span><span class="s1">.</span><span class="s2">truncate</span><span class="s1">(</span><span class="s2">len</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">ftruncateSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">len</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">ftruncateBase</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">len</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">ftruncate </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">len </span><span class="s1">= </span><span class="s3">typeof </span><span class="s2">a </span><span class="s1">=== </span><span class="s0">'number' </span><span class="s1">? </span><span class="s2">a </span><span class="s1">: </span><span class="s4">0</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">callback </span><span class="s1">= </span><span class="s2">validateCallback</span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">a </span><span class="s1">=== </span><span class="s0">'number' </span><span class="s1">? </span><span class="s2">b </span><span class="s1">: </span><span class="s2">a</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">ftruncateBase</span><span class="s1">, [</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">len</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">truncateBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">len</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">fd </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">openSync</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s0">'r+'</span><span class="s1">);</span>
        <span class="s3">try </span><span class="s1">{</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">ftruncateSync</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">len</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">finally </span><span class="s1">{</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">closeSync</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">);</span>
        <span class="s1">}</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">truncateSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">id</span><span class="s1">, </span><span class="s2">len</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">isFd</span><span class="s1">(</span><span class="s2">id</span><span class="s1">))</span>
            <span class="s3">return this</span><span class="s1">.</span><span class="s2">ftruncateSync</span><span class="s1">(</span><span class="s2">id</span><span class="s1">, </span><span class="s2">len</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">truncateBase</span><span class="s1">(</span><span class="s2">id</span><span class="s1">, </span><span class="s2">len</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">truncate </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">id</span><span class="s1">, </span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">len </span><span class="s1">= </span><span class="s3">typeof </span><span class="s2">a </span><span class="s1">=== </span><span class="s0">'number' </span><span class="s1">? </span><span class="s2">a </span><span class="s1">: </span><span class="s4">0</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">callback </span><span class="s1">= </span><span class="s2">validateCallback</span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">a </span><span class="s1">=== </span><span class="s0">'number' </span><span class="s1">? </span><span class="s2">b </span><span class="s1">: </span><span class="s2">a</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">isFd</span><span class="s1">(</span><span class="s2">id</span><span class="s1">))</span>
            <span class="s3">return this</span><span class="s1">.</span><span class="s2">ftruncate</span><span class="s1">(</span><span class="s2">id</span><span class="s1">, </span><span class="s2">len</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">truncateBase</span><span class="s1">, [</span><span class="s2">id</span><span class="s1">, </span><span class="s2">len</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">futimesBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">atime</span><span class="s1">, </span><span class="s2">mtime</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">file </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getFileByFdOrThrow</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s0">'futimes'</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">node </span><span class="s1">= </span><span class="s2">file</span><span class="s1">.</span><span class="s2">node</span><span class="s1">;</span>
        <span class="s2">node</span><span class="s1">.</span><span class="s2">atime </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Date</span><span class="s1">(</span><span class="s2">atime </span><span class="s1">* </span><span class="s4">1000</span><span class="s1">);</span>
        <span class="s2">node</span><span class="s1">.</span><span class="s2">mtime </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Date</span><span class="s1">(</span><span class="s2">mtime </span><span class="s1">* </span><span class="s4">1000</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">futimesSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">atime</span><span class="s1">, </span><span class="s2">mtime</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">futimesBase</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">toUnixTimestamp</span><span class="s1">(</span><span class="s2">atime</span><span class="s1">), </span><span class="s2">toUnixTimestamp</span><span class="s1">(</span><span class="s2">mtime</span><span class="s1">));</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">futimes </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">atime</span><span class="s1">, </span><span class="s2">mtime</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">futimesBase</span><span class="s1">, [</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">toUnixTimestamp</span><span class="s1">(</span><span class="s2">atime</span><span class="s1">), </span><span class="s2">toUnixTimestamp</span><span class="s1">(</span><span class="s2">mtime</span><span class="s1">)], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">utimesBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">atime</span><span class="s1">, </span><span class="s2">mtime</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">fd </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">openSync</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s0">'r'</span><span class="s1">);</span>
        <span class="s3">try </span><span class="s1">{</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">futimesBase</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">atime</span><span class="s1">, </span><span class="s2">mtime</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">finally </span><span class="s1">{</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">closeSync</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">);</span>
        <span class="s1">}</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">utimesSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">atime</span><span class="s1">, </span><span class="s2">mtime</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">utimesBase</span><span class="s1">(</span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">), </span><span class="s2">toUnixTimestamp</span><span class="s1">(</span><span class="s2">atime</span><span class="s1">), </span><span class="s2">toUnixTimestamp</span><span class="s1">(</span><span class="s2">mtime</span><span class="s1">));</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">utimes </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">atime</span><span class="s1">, </span><span class="s2">mtime</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">utimesBase</span><span class="s1">, [</span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">), </span><span class="s2">toUnixTimestamp</span><span class="s1">(</span><span class="s2">atime</span><span class="s1">), </span><span class="s2">toUnixTimestamp</span><span class="s1">(</span><span class="s2">mtime</span><span class="s1">)], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">mkdirBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">steps </span><span class="s1">= </span><span class="s2">filenameToSteps</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">);</span>
        <span class="s5">// This will throw if user tries to create root dir `fs.mkdirSync('/')`.</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">steps</span><span class="s1">.</span><span class="s2">length</span><span class="s1">) {</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">EEXIST</span><span class="s1">, </span><span class="s0">'mkdir'</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">var </span><span class="s2">dir </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getLinkParentAsDirOrThrow</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s0">'mkdir'</span><span class="s1">);</span>
        <span class="s5">// Check path already exists.</span>
        <span class="s3">var </span><span class="s2">name </span><span class="s1">= </span><span class="s2">steps</span><span class="s1">[</span><span class="s2">steps</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">1</span><span class="s1">];</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">dir</span><span class="s1">.</span><span class="s2">getChild</span><span class="s1">(</span><span class="s2">name</span><span class="s1">))</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">EEXIST</span><span class="s1">, </span><span class="s0">'mkdir'</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">);</span>
        <span class="s2">dir</span><span class="s1">.</span><span class="s2">createChild</span><span class="s1">(</span><span class="s2">name</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">createNode</span><span class="s1">(</span><span class="s3">true</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">));</span>
    <span class="s1">};</span>
    <span class="s6">/**</span>
     <span class="s6">* Creates directory tree recursively.</span>
     <span class="s6">* </span><span class="s7">@param </span><span class="s6">filename</span>
     <span class="s6">* </span><span class="s7">@param </span><span class="s6">modeNum</span>
     <span class="s6">*/</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">mkdirpBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">fullPath </span><span class="s1">= </span><span class="s2">resolve</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">fullPathSansSlash </span><span class="s1">= </span><span class="s2">fullPath</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span><span class="s4">1</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">steps </span><span class="s1">= !</span><span class="s2">fullPathSansSlash </span><span class="s1">? [] : </span><span class="s2">fullPathSansSlash</span><span class="s1">.</span><span class="s2">split</span><span class="s1">(</span><span class="s2">sep</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">link </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">root</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">created </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
        <span class="s3">for </span><span class="s1">(</span><span class="s3">var </span><span class="s2">i </span><span class="s1">= </span><span class="s4">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">steps</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">i</span><span class="s1">++) {</span>
            <span class="s3">var </span><span class="s2">step </span><span class="s1">= </span><span class="s2">steps</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>
            <span class="s3">if </span><span class="s1">(!</span><span class="s2">link</span><span class="s1">.</span><span class="s2">getNode</span><span class="s1">().</span><span class="s2">isDirectory</span><span class="s1">())</span>
                <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ENOTDIR</span><span class="s1">, </span><span class="s0">'mkdir'</span><span class="s1">, </span><span class="s2">link</span><span class="s1">.</span><span class="s2">getPath</span><span class="s1">());</span>
            <span class="s3">var </span><span class="s2">child </span><span class="s1">= </span><span class="s2">link</span><span class="s1">.</span><span class="s2">getChild</span><span class="s1">(</span><span class="s2">step</span><span class="s1">);</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">child</span><span class="s1">) {</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">child</span><span class="s1">.</span><span class="s2">getNode</span><span class="s1">().</span><span class="s2">isDirectory</span><span class="s1">())</span>
                    <span class="s2">link </span><span class="s1">= </span><span class="s2">child</span><span class="s1">;</span>
                <span class="s3">else</span>
                    <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ENOTDIR</span><span class="s1">, </span><span class="s0">'mkdir'</span><span class="s1">, </span><span class="s2">child</span><span class="s1">.</span><span class="s2">getPath</span><span class="s1">());</span>
            <span class="s1">}</span>
            <span class="s3">else </span><span class="s1">{</span>
                <span class="s2">link </span><span class="s1">= </span><span class="s2">link</span><span class="s1">.</span><span class="s2">createChild</span><span class="s1">(</span><span class="s2">step</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">createNode</span><span class="s1">(</span><span class="s3">true</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">));</span>
                <span class="s2">created </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s3">return </span><span class="s2">created </span><span class="s1">? </span><span class="s2">fullPath </span><span class="s1">: </span><span class="s2">undefined</span><span class="s1">;</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">mkdirSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">opts </span><span class="s1">= </span><span class="s2">getMkdirOptions</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">modeNum </span><span class="s1">= </span><span class="s2">modeToNumber</span><span class="s1">(</span><span class="s2">opts</span><span class="s1">.</span><span class="s2">mode</span><span class="s1">, </span><span class="s4">511</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">filename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">opts</span><span class="s1">.</span><span class="s2">recursive</span><span class="s1">)</span>
            <span class="s3">return this</span><span class="s1">.</span><span class="s2">mkdirpBase</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">mkdirBase</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">mkdir </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">opts </span><span class="s1">= </span><span class="s2">getMkdirOptions</span><span class="s1">(</span><span class="s2">a</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">callback </span><span class="s1">= </span><span class="s2">validateCallback</span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">a </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">? </span><span class="s2">a </span><span class="s1">: </span><span class="s2">b</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">modeNum </span><span class="s1">= </span><span class="s2">modeToNumber</span><span class="s1">(</span><span class="s2">opts</span><span class="s1">.</span><span class="s2">mode</span><span class="s1">, </span><span class="s4">511</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">filename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">opts</span><span class="s1">.</span><span class="s2">recursive</span><span class="s1">)</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">mkdirpBase</span><span class="s1">, [</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
        <span class="s3">else</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">mkdirBase</span><span class="s1">, [</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s5">// legacy interface</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">mkdirpSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">mode</span><span class="s1">) {</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">mkdirSync</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, { </span><span class="s2">mode</span><span class="s1">: </span><span class="s2">mode</span><span class="s1">, </span><span class="s2">recursive</span><span class="s1">: </span><span class="s3">true </span><span class="s1">});</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">mkdirp </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">mode </span><span class="s1">= </span><span class="s3">typeof </span><span class="s2">a </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">? </span><span class="s2">undefined </span><span class="s1">: </span><span class="s2">a</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">callback </span><span class="s1">= </span><span class="s2">validateCallback</span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">a </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">? </span><span class="s2">a </span><span class="s1">: </span><span class="s2">b</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">mkdir</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, { </span><span class="s2">mode</span><span class="s1">: </span><span class="s2">mode</span><span class="s1">, </span><span class="s2">recursive</span><span class="s1">: </span><span class="s3">true </span><span class="s1">}, </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">mkdtempBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">prefix</span><span class="s1">, </span><span class="s2">encoding</span><span class="s1">, </span><span class="s2">retry</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">retry </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">retry </span><span class="s1">= </span><span class="s4">5</span><span class="s1">; }</span>
        <span class="s3">var </span><span class="s2">filename </span><span class="s1">= </span><span class="s2">prefix </span><span class="s1">+ </span><span class="s3">this</span><span class="s1">.</span><span class="s2">genRndStr</span><span class="s1">();</span>
        <span class="s3">try </span><span class="s1">{</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">mkdirBase</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s4">511 </span><span class="s5">/* MODE.DIR */</span><span class="s1">);</span>
            <span class="s3">return </span><span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">encoding_1</span><span class="s1">.</span><span class="s2">strToEncoding</span><span class="s1">)(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">encoding</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">err</span><span class="s1">.</span><span class="s2">code </span><span class="s1">=== </span><span class="s2">EEXIST</span><span class="s1">) {</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">retry </span><span class="s1">&gt; </span><span class="s4">1</span><span class="s1">)</span>
                    <span class="s3">return this</span><span class="s1">.</span><span class="s2">mkdtempBase</span><span class="s1">(</span><span class="s2">prefix</span><span class="s1">, </span><span class="s2">encoding</span><span class="s1">, </span><span class="s2">retry </span><span class="s1">- </span><span class="s4">1</span><span class="s1">);</span>
                <span class="s3">else</span>
                    <span class="s3">throw </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'Could not create temp dir.'</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s3">else</span>
                <span class="s3">throw </span><span class="s2">err</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">mkdtempSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">prefix</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">encoding </span><span class="s1">= </span><span class="s2">getDefaultOpts</span><span class="s1">(</span><span class="s2">options</span><span class="s1">).</span><span class="s2">encoding</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">prefix </span><span class="s1">|| </span><span class="s3">typeof </span><span class="s2">prefix </span><span class="s1">!== </span><span class="s0">'string'</span><span class="s1">)</span>
            <span class="s3">throw new </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s0">'filename prefix is required'</span><span class="s1">);</span>
        <span class="s2">nullCheck</span><span class="s1">(</span><span class="s2">prefix</span><span class="s1">);</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">mkdtempBase</span><span class="s1">(</span><span class="s2">prefix</span><span class="s1">, </span><span class="s2">encoding</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">mkdtemp </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">prefix</span><span class="s1">, </span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">_a </span><span class="s1">= </span><span class="s2">getDefaultOptsAndCb</span><span class="s1">(</span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">), </span><span class="s2">encoding </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">[</span><span class="s4">0</span><span class="s1">].</span><span class="s2">encoding</span><span class="s1">, </span><span class="s2">callback </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">prefix </span><span class="s1">|| </span><span class="s3">typeof </span><span class="s2">prefix </span><span class="s1">!== </span><span class="s0">'string'</span><span class="s1">)</span>
            <span class="s3">throw new </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s0">'filename prefix is required'</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">nullCheck</span><span class="s1">(</span><span class="s2">prefix</span><span class="s1">))</span>
            <span class="s3">return</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">mkdtempBase</span><span class="s1">, [</span><span class="s2">prefix</span><span class="s1">, </span><span class="s2">encoding</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">rmdirBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">opts </span><span class="s1">= </span><span class="s2">getRmdirOptions</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">link </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getLinkAsDirOrThrow</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s0">'rmdir'</span><span class="s1">);</span>
        <span class="s5">// Check directory is empty.</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">link</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&amp;&amp; !</span><span class="s2">opts</span><span class="s1">.</span><span class="s2">recursive</span><span class="s1">)</span>
            <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ENOTEMPTY</span><span class="s1">, </span><span class="s0">'rmdir'</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">deleteLink</span><span class="s1">(</span><span class="s2">link</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">rmdirSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">rmdirBase</span><span class="s1">(</span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">), </span><span class="s2">options</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">rmdir </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">opts </span><span class="s1">= </span><span class="s2">getRmdirOptions</span><span class="s1">(</span><span class="s2">a</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">callback </span><span class="s1">= </span><span class="s2">validateCallback</span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">a </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">? </span><span class="s2">a </span><span class="s1">: </span><span class="s2">b</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">rmdirBase</span><span class="s1">, [</span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">), </span><span class="s2">opts</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">rmBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">options </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">options </span><span class="s1">= {}; }</span>
        <span class="s3">var </span><span class="s2">link </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getResolvedLink</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">link</span><span class="s1">) {</span>
            <span class="s5">// &quot;stat&quot; is used to match Node's native error message.</span>
            <span class="s3">if </span><span class="s1">(!</span><span class="s2">options</span><span class="s1">.</span><span class="s2">force</span><span class="s1">)</span>
                <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ENOENT</span><span class="s1">, </span><span class="s0">'stat'</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">);</span>
            <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">link</span><span class="s1">.</span><span class="s2">getNode</span><span class="s1">().</span><span class="s2">isDirectory</span><span class="s1">()) {</span>
            <span class="s3">if </span><span class="s1">(!</span><span class="s2">options</span><span class="s1">.</span><span class="s2">recursive</span><span class="s1">) {</span>
                <span class="s3">throw </span><span class="s2">createError</span><span class="s1">(</span><span class="s2">ERR_FS_EISDIR</span><span class="s1">, </span><span class="s0">'rm'</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">);</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">deleteLink</span><span class="s1">(</span><span class="s2">link</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">rmSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">rmBase</span><span class="s1">(</span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">), </span><span class="s2">options</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">rm </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">_a </span><span class="s1">= </span><span class="s2">getRmOptsAndCb</span><span class="s1">(</span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">), </span><span class="s2">opts </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">[</span><span class="s4">0</span><span class="s1">], </span><span class="s2">callback </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">rmBase</span><span class="s1">, [</span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">), </span><span class="s2">opts</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">fchmodBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">file </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getFileByFdOrThrow</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s0">'fchmod'</span><span class="s1">);</span>
        <span class="s2">file</span><span class="s1">.</span><span class="s2">chmod</span><span class="s1">(</span><span class="s2">modeNum</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">fchmodSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">mode</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">fchmodBase</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">modeToNumber</span><span class="s1">(</span><span class="s2">mode</span><span class="s1">));</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">fchmod </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">mode</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">fchmodBase</span><span class="s1">, [</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">modeToNumber</span><span class="s1">(</span><span class="s2">mode</span><span class="s1">)], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">chmodBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">fd </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">openSync</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s0">'r'</span><span class="s1">);</span>
        <span class="s3">try </span><span class="s1">{</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fchmodBase</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">finally </span><span class="s1">{</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">closeSync</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">);</span>
        <span class="s1">}</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">chmodSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">mode</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">modeNum </span><span class="s1">= </span><span class="s2">modeToNumber</span><span class="s1">(</span><span class="s2">mode</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">filename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">chmodBase</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">chmod </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">mode</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">modeNum </span><span class="s1">= </span><span class="s2">modeToNumber</span><span class="s1">(</span><span class="s2">mode</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">filename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">chmodBase</span><span class="s1">, [</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">lchmodBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">fd </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">openBase</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">O_RDWR</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s3">false</span><span class="s1">);</span>
        <span class="s3">try </span><span class="s1">{</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">fchmodBase</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">finally </span><span class="s1">{</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">closeSync</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">);</span>
        <span class="s1">}</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">lchmodSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">mode</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">modeNum </span><span class="s1">= </span><span class="s2">modeToNumber</span><span class="s1">(</span><span class="s2">mode</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">filename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">lchmodBase</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">lchmod </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">mode</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">modeNum </span><span class="s1">= </span><span class="s2">modeToNumber</span><span class="s1">(</span><span class="s2">mode</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">filename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">lchmodBase</span><span class="s1">, [</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">modeNum</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">fchownBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">uid</span><span class="s1">, </span><span class="s2">gid</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">getFileByFdOrThrow</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s0">'fchown'</span><span class="s1">).</span><span class="s2">chown</span><span class="s1">(</span><span class="s2">uid</span><span class="s1">, </span><span class="s2">gid</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">fchownSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">uid</span><span class="s1">, </span><span class="s2">gid</span><span class="s1">) {</span>
        <span class="s2">validateUid</span><span class="s1">(</span><span class="s2">uid</span><span class="s1">);</span>
        <span class="s2">validateGid</span><span class="s1">(</span><span class="s2">gid</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">fchownBase</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">uid</span><span class="s1">, </span><span class="s2">gid</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">fchown </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">uid</span><span class="s1">, </span><span class="s2">gid</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
        <span class="s2">validateUid</span><span class="s1">(</span><span class="s2">uid</span><span class="s1">);</span>
        <span class="s2">validateGid</span><span class="s1">(</span><span class="s2">gid</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">fchownBase</span><span class="s1">, [</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">uid</span><span class="s1">, </span><span class="s2">gid</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">chownBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">uid</span><span class="s1">, </span><span class="s2">gid</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">link </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getResolvedLinkOrThrow</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s0">'chown'</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">node </span><span class="s1">= </span><span class="s2">link</span><span class="s1">.</span><span class="s2">getNode</span><span class="s1">();</span>
        <span class="s2">node</span><span class="s1">.</span><span class="s2">chown</span><span class="s1">(</span><span class="s2">uid</span><span class="s1">, </span><span class="s2">gid</span><span class="s1">);</span>
        <span class="s5">// if(node.isFile() || node.isSymlink()) {</span>
        <span class="s5">//</span>
        <span class="s5">// } else if(node.isDirectory()) {</span>
        <span class="s5">//</span>
        <span class="s5">// } else {</span>
        <span class="s5">// TODO: What do we do here?</span>
        <span class="s5">// }</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">chownSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">uid</span><span class="s1">, </span><span class="s2">gid</span><span class="s1">) {</span>
        <span class="s2">validateUid</span><span class="s1">(</span><span class="s2">uid</span><span class="s1">);</span>
        <span class="s2">validateGid</span><span class="s1">(</span><span class="s2">gid</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">chownBase</span><span class="s1">(</span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">), </span><span class="s2">uid</span><span class="s1">, </span><span class="s2">gid</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">chown </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">uid</span><span class="s1">, </span><span class="s2">gid</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
        <span class="s2">validateUid</span><span class="s1">(</span><span class="s2">uid</span><span class="s1">);</span>
        <span class="s2">validateGid</span><span class="s1">(</span><span class="s2">gid</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">chownBase</span><span class="s1">, [</span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">), </span><span class="s2">uid</span><span class="s1">, </span><span class="s2">gid</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">lchownBase </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">uid</span><span class="s1">, </span><span class="s2">gid</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">getLinkOrThrow</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s0">'lchown'</span><span class="s1">).</span><span class="s2">getNode</span><span class="s1">().</span><span class="s2">chown</span><span class="s1">(</span><span class="s2">uid</span><span class="s1">, </span><span class="s2">gid</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">lchownSync </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">uid</span><span class="s1">, </span><span class="s2">gid</span><span class="s1">) {</span>
        <span class="s2">validateUid</span><span class="s1">(</span><span class="s2">uid</span><span class="s1">);</span>
        <span class="s2">validateGid</span><span class="s1">(</span><span class="s2">gid</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">lchownBase</span><span class="s1">(</span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">), </span><span class="s2">uid</span><span class="s1">, </span><span class="s2">gid</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">lchown </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">uid</span><span class="s1">, </span><span class="s2">gid</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
        <span class="s2">validateUid</span><span class="s1">(</span><span class="s2">uid</span><span class="s1">);</span>
        <span class="s2">validateGid</span><span class="s1">(</span><span class="s2">gid</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">wrapAsync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">lchownBase</span><span class="s1">, [</span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">), </span><span class="s2">uid</span><span class="s1">, </span><span class="s2">gid</span><span class="s1">], </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">watchFile </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">a</span><span class="s1">, </span><span class="s2">b</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">filename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">options </span><span class="s1">= </span><span class="s2">a</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">listener </span><span class="s1">= </span><span class="s2">b</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options </span><span class="s1">=== </span><span class="s0">'function'</span><span class="s1">) {</span>
            <span class="s2">listener </span><span class="s1">= </span><span class="s2">a</span><span class="s1">;</span>
            <span class="s2">options </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">listener </span><span class="s1">!== </span><span class="s0">'function'</span><span class="s1">) {</span>
            <span class="s3">throw </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'&quot;watchFile()&quot; requires a listener function'</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">var </span><span class="s2">interval </span><span class="s1">= </span><span class="s4">5007</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">persistent </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">options </span><span class="s1">&amp;&amp; </span><span class="s3">typeof </span><span class="s2">options </span><span class="s1">=== </span><span class="s0">'object'</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">interval </span><span class="s1">=== </span><span class="s0">'number'</span><span class="s1">)</span>
                <span class="s2">interval </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">interval</span><span class="s1">;</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">persistent </span><span class="s1">=== </span><span class="s0">'boolean'</span><span class="s1">)</span>
                <span class="s2">persistent </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">persistent</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">var </span><span class="s2">watcher </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">statWatchers</span><span class="s1">[</span><span class="s2">filename</span><span class="s1">];</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">watcher</span><span class="s1">) {</span>
            <span class="s2">watcher </span><span class="s1">= </span><span class="s3">new this</span><span class="s1">.</span><span class="s2">StatWatcher</span><span class="s1">();</span>
            <span class="s2">watcher</span><span class="s1">.</span><span class="s2">start</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">persistent</span><span class="s1">, </span><span class="s2">interval</span><span class="s1">);</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">statWatchers</span><span class="s1">[</span><span class="s2">filename</span><span class="s1">] = </span><span class="s2">watcher</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s2">watcher</span><span class="s1">.</span><span class="s2">addListener</span><span class="s1">(</span><span class="s0">'change'</span><span class="s1">, </span><span class="s2">listener</span><span class="s1">);</span>
        <span class="s3">return </span><span class="s2">watcher</span><span class="s1">;</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">unwatchFile </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">listener</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">filename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">watcher </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">statWatchers</span><span class="s1">[</span><span class="s2">filename</span><span class="s1">];</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">watcher</span><span class="s1">)</span>
            <span class="s3">return</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">listener </span><span class="s1">=== </span><span class="s0">'function'</span><span class="s1">) {</span>
            <span class="s2">watcher</span><span class="s1">.</span><span class="s2">removeListener</span><span class="s1">(</span><span class="s0">'change'</span><span class="s1">, </span><span class="s2">listener</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s2">watcher</span><span class="s1">.</span><span class="s2">removeAllListeners</span><span class="s1">(</span><span class="s0">'change'</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">watcher</span><span class="s1">.</span><span class="s2">listenerCount</span><span class="s1">(</span><span class="s0">'change'</span><span class="s1">) === </span><span class="s4">0</span><span class="s1">) {</span>
            <span class="s2">watcher</span><span class="s1">.</span><span class="s2">stop</span><span class="s1">();</span>
            <span class="s3">delete this</span><span class="s1">.</span><span class="s2">statWatchers</span><span class="s1">[</span><span class="s2">filename</span><span class="s1">];</span>
        <span class="s1">}</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">createReadStream </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
        <span class="s3">return new this</span><span class="s1">.</span><span class="s2">ReadStream</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">createWriteStream </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
        <span class="s3">return new this</span><span class="s1">.</span><span class="s2">WriteStream</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s5">// watch(path: PathLike): FSWatcher;</span>
    <span class="s5">// watch(path: PathLike, options?: IWatchOptions | string): FSWatcher;</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">watch </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">listener</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">filename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">givenOptions </span><span class="s1">= </span><span class="s2">options</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options </span><span class="s1">=== </span><span class="s0">'function'</span><span class="s1">) {</span>
            <span class="s2">listener </span><span class="s1">= </span><span class="s2">options</span><span class="s1">;</span>
            <span class="s2">givenOptions </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s5">// tslint:disable-next-line prefer-const</span>
        <span class="s3">var </span><span class="s2">_a </span><span class="s1">= </span><span class="s2">getDefaultOpts</span><span class="s1">(</span><span class="s2">givenOptions</span><span class="s1">), </span><span class="s2">persistent </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">.</span><span class="s2">persistent</span><span class="s1">, </span><span class="s2">recursive </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">.</span><span class="s2">recursive</span><span class="s1">, </span><span class="s2">encoding </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">.</span><span class="s2">encoding</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">persistent </span><span class="s1">=== </span><span class="s2">undefined</span><span class="s1">)</span>
            <span class="s2">persistent </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">recursive </span><span class="s1">=== </span><span class="s2">undefined</span><span class="s1">)</span>
            <span class="s2">recursive </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
        <span class="s3">var </span><span class="s2">watcher </span><span class="s1">= </span><span class="s3">new this</span><span class="s1">.</span><span class="s2">FSWatcher</span><span class="s1">();</span>
        <span class="s2">watcher</span><span class="s1">.</span><span class="s2">start</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">persistent</span><span class="s1">, </span><span class="s2">recursive</span><span class="s1">, </span><span class="s2">encoding</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">listener</span><span class="s1">) {</span>
            <span class="s2">watcher</span><span class="s1">.</span><span class="s2">addListener</span><span class="s1">(</span><span class="s0">'change'</span><span class="s1">, </span><span class="s2">listener</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">return </span><span class="s2">watcher</span><span class="s1">;</span>
    <span class="s1">};</span>
    <span class="s6">/**</span>
     <span class="s6">* Global file descriptor counter. UNIX file descriptors start from 0 and go sequentially</span>
     <span class="s6">* up, so here, in order not to conflict with them, we choose some big number and descrease</span>
     <span class="s6">* the file descriptor of every new opened file.</span>
     <span class="s6">* </span><span class="s7">@type </span><span class="s6">{number}</span>
     <span class="s6">* </span><span class="s7">@todo </span><span class="s6">This should not be static, right?</span>
     <span class="s6">*/</span>
    <span class="s2">Volume</span><span class="s1">.</span><span class="s2">fd </span><span class="s1">= </span><span class="s4">0x7fffffff</span><span class="s1">;</span>
    <span class="s3">return </span><span class="s2">Volume</span><span class="s1">;</span>
<span class="s1">}());</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">Volume </span><span class="s1">= </span><span class="s2">Volume</span><span class="s1">;</span>
<span class="s3">function </span><span class="s2">emitStop</span><span class="s1">(</span><span class="s2">self</span><span class="s1">) {</span>
    <span class="s2">self</span><span class="s1">.</span><span class="s2">emit</span><span class="s1">(</span><span class="s0">'stop'</span><span class="s1">);</span>
<span class="s1">}</span>
<span class="s3">var </span><span class="s2">StatWatcher </span><span class="s1">= </span><span class="s6">/** </span><span class="s7">@class </span><span class="s6">*/ </span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">_super</span><span class="s1">) {</span>
    <span class="s2">__extends</span><span class="s1">(</span><span class="s2">StatWatcher</span><span class="s1">, </span><span class="s2">_super</span><span class="s1">);</span>
    <span class="s3">function </span><span class="s2">StatWatcher</span><span class="s1">(</span><span class="s2">vol</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">_this </span><span class="s1">= </span><span class="s2">_super</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">) || </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s2">_this</span><span class="s1">.</span><span class="s2">onInterval </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
            <span class="s3">try </span><span class="s1">{</span>
                <span class="s3">var </span><span class="s2">stats </span><span class="s1">= </span><span class="s2">_this</span><span class="s1">.</span><span class="s2">vol</span><span class="s1">.</span><span class="s2">statSync</span><span class="s1">(</span><span class="s2">_this</span><span class="s1">.</span><span class="s2">filename</span><span class="s1">);</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">_this</span><span class="s1">.</span><span class="s2">hasChanged</span><span class="s1">(</span><span class="s2">stats</span><span class="s1">)) {</span>
                    <span class="s2">_this</span><span class="s1">.</span><span class="s2">emit</span><span class="s1">(</span><span class="s0">'change'</span><span class="s1">, </span><span class="s2">stats</span><span class="s1">, </span><span class="s2">_this</span><span class="s1">.</span><span class="s2">prev</span><span class="s1">);</span>
                    <span class="s2">_this</span><span class="s1">.</span><span class="s2">prev </span><span class="s1">= </span><span class="s2">stats</span><span class="s1">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
            <span class="s3">finally </span><span class="s1">{</span>
                <span class="s2">_this</span><span class="s1">.</span><span class="s2">loop</span><span class="s1">();</span>
            <span class="s1">}</span>
        <span class="s1">};</span>
        <span class="s2">_this</span><span class="s1">.</span><span class="s2">vol </span><span class="s1">= </span><span class="s2">vol</span><span class="s1">;</span>
        <span class="s3">return </span><span class="s2">_this</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">StatWatcher</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">loop </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">timeoutRef </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">setTimeout</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">onInterval</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">interval</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">StatWatcher</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">hasChanged </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">stats</span><span class="s1">) {</span>
        <span class="s5">// if(!this.prev) return false;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">stats</span><span class="s1">.</span><span class="s2">mtimeMs </span><span class="s1">&gt; </span><span class="s3">this</span><span class="s1">.</span><span class="s2">prev</span><span class="s1">.</span><span class="s2">mtimeMs</span><span class="s1">)</span>
            <span class="s3">return true</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">stats</span><span class="s1">.</span><span class="s2">nlink </span><span class="s1">!== </span><span class="s3">this</span><span class="s1">.</span><span class="s2">prev</span><span class="s1">.</span><span class="s2">nlink</span><span class="s1">)</span>
            <span class="s3">return true</span><span class="s1">;</span>
        <span class="s3">return false</span><span class="s1">;</span>
    <span class="s1">};</span>
    <span class="s2">StatWatcher</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">start </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">persistent</span><span class="s1">, </span><span class="s2">interval</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">persistent </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">persistent </span><span class="s1">= </span><span class="s3">true</span><span class="s1">; }</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">interval </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">interval </span><span class="s1">= </span><span class="s4">5007</span><span class="s1">; }</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">filename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">setTimeout </span><span class="s1">= </span><span class="s2">persistent</span>
            <span class="s1">? </span><span class="s2">setTimeout</span><span class="s1">.</span><span class="s2">bind</span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">globalThis </span><span class="s1">!== </span><span class="s0">'undefined' </span><span class="s1">? </span><span class="s2">globalThis </span><span class="s1">: </span><span class="s2">global</span><span class="s1">)</span>
            <span class="s1">: </span><span class="s2">setTimeoutUnref_1</span><span class="s1">.</span><span class="s2">default</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">interval </span><span class="s1">= </span><span class="s2">interval</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">prev </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">vol</span><span class="s1">.</span><span class="s2">statSync</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">filename</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">loop</span><span class="s1">();</span>
    <span class="s1">};</span>
    <span class="s2">StatWatcher</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">stop </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
        <span class="s2">clearTimeout</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">timeoutRef</span><span class="s1">);</span>
        <span class="s2">process_1</span><span class="s1">.</span><span class="s2">default</span><span class="s1">.</span><span class="s2">nextTick</span><span class="s1">(</span><span class="s2">emitStop</span><span class="s1">, </span><span class="s3">this</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s3">return </span><span class="s2">StatWatcher</span><span class="s1">;</span>
<span class="s1">}(</span><span class="s2">events_1</span><span class="s1">.</span><span class="s2">EventEmitter</span><span class="s1">));</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">StatWatcher </span><span class="s1">= </span><span class="s2">StatWatcher</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">pool</span><span class="s1">;</span>
<span class="s3">function </span><span class="s2">allocNewPool</span><span class="s1">(</span><span class="s2">poolSize</span><span class="s1">) {</span>
    <span class="s2">pool </span><span class="s1">= (</span><span class="s4">0</span><span class="s1">, </span><span class="s2">buffer_1</span><span class="s1">.</span><span class="s2">bufferAllocUnsafe</span><span class="s1">)(</span><span class="s2">poolSize</span><span class="s1">);</span>
    <span class="s2">pool</span><span class="s1">.</span><span class="s2">used </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
<span class="s1">}</span>
<span class="s2">util</span><span class="s1">.</span><span class="s2">inherits</span><span class="s1">(</span><span class="s2">FsReadStream</span><span class="s1">, </span><span class="s2">stream_1</span><span class="s1">.</span><span class="s2">Readable</span><span class="s1">);</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">ReadStream </span><span class="s1">= </span><span class="s2">FsReadStream</span><span class="s1">;</span>
<span class="s3">function </span><span class="s2">FsReadStream</span><span class="s1">(</span><span class="s2">vol</span><span class="s1">, </span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(!(</span><span class="s3">this instanceof </span><span class="s2">FsReadStream</span><span class="s1">))</span>
        <span class="s3">return new </span><span class="s2">FsReadStream</span><span class="s1">(</span><span class="s2">vol</span><span class="s1">, </span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_vol </span><span class="s1">= </span><span class="s2">vol</span><span class="s1">;</span>
    <span class="s5">// a little bit bigger buffer and water marks by default</span>
    <span class="s2">options </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">assign</span><span class="s1">({}, </span><span class="s2">getOptions</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, {}));</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">highWaterMark </span><span class="s1">=== </span><span class="s2">undefined</span><span class="s1">)</span>
        <span class="s2">options</span><span class="s1">.</span><span class="s2">highWaterMark </span><span class="s1">= </span><span class="s4">64 </span><span class="s1">* </span><span class="s4">1024</span><span class="s1">;</span>
    <span class="s2">stream_1</span><span class="s1">.</span><span class="s2">Readable</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">path </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">fd </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">fd </span><span class="s1">=== </span><span class="s2">undefined </span><span class="s1">? </span><span class="s3">null </span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">fd</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">flags </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">flags </span><span class="s1">=== </span><span class="s2">undefined </span><span class="s1">? </span><span class="s0">'r' </span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">flags</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">mode </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">mode </span><span class="s1">=== </span><span class="s2">undefined </span><span class="s1">? </span><span class="s4">438 </span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">mode</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">start </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">start</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">end </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">end</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">autoClose </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">autoClose </span><span class="s1">=== </span><span class="s2">undefined </span><span class="s1">? </span><span class="s3">true </span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">autoClose</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">pos </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">bytesRead </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">start </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof this</span><span class="s1">.</span><span class="s2">start </span><span class="s1">!== </span><span class="s0">'number'</span><span class="s1">) {</span>
            <span class="s3">throw new </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s0">'&quot;start&quot; option must be a Number'</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">end </span><span class="s1">=== </span><span class="s2">undefined</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">end </span><span class="s1">= </span><span class="s2">Infinity</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">else if </span><span class="s1">(</span><span class="s3">typeof this</span><span class="s1">.</span><span class="s2">end </span><span class="s1">!== </span><span class="s0">'number'</span><span class="s1">) {</span>
            <span class="s3">throw new </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s0">'&quot;end&quot; option must be a Number'</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">start </span><span class="s1">&gt; </span><span class="s3">this</span><span class="s1">.</span><span class="s2">end</span><span class="s1">) {</span>
            <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'&quot;start&quot; option must be &lt;= &quot;end&quot; option'</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">pos </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">start</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof this</span><span class="s1">.</span><span class="s2">fd </span><span class="s1">!== </span><span class="s0">'number'</span><span class="s1">)</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">open</span><span class="s1">();</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">on</span><span class="s1">(</span><span class="s0">'end'</span><span class="s1">, </span><span class="s3">function </span><span class="s1">() {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">autoClose</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">destroy</span><span class="s1">)</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">destroy</span><span class="s1">();</span>
        <span class="s1">}</span>
    <span class="s1">});</span>
<span class="s1">}</span>
<span class="s2">FsReadStream</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">open </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
    <span class="s3">var </span><span class="s2">self </span><span class="s1">= </span><span class="s3">this</span><span class="s1">; </span><span class="s5">// tslint:disable-line no-this-assignment</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_vol</span><span class="s1">.</span><span class="s2">open</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">path</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">flags</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">mode</span><span class="s1">, </span><span class="s3">function </span><span class="s1">(</span><span class="s2">er</span><span class="s1">, </span><span class="s2">fd</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">er</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">self</span><span class="s1">.</span><span class="s2">autoClose</span><span class="s1">) {</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">self</span><span class="s1">.</span><span class="s2">destroy</span><span class="s1">)</span>
                    <span class="s2">self</span><span class="s1">.</span><span class="s2">destroy</span><span class="s1">();</span>
            <span class="s1">}</span>
            <span class="s2">self</span><span class="s1">.</span><span class="s2">emit</span><span class="s1">(</span><span class="s0">'error'</span><span class="s1">, </span><span class="s2">er</span><span class="s1">);</span>
            <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s2">self</span><span class="s1">.</span><span class="s2">fd </span><span class="s1">= </span><span class="s2">fd</span><span class="s1">;</span>
        <span class="s2">self</span><span class="s1">.</span><span class="s2">emit</span><span class="s1">(</span><span class="s0">'open'</span><span class="s1">, </span><span class="s2">fd</span><span class="s1">);</span>
        <span class="s5">// start the flow of data.</span>
        <span class="s2">self</span><span class="s1">.</span><span class="s2">read</span><span class="s1">();</span>
    <span class="s1">});</span>
<span class="s1">};</span>
<span class="s2">FsReadStream</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_read </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">n</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof this</span><span class="s1">.</span><span class="s2">fd </span><span class="s1">!== </span><span class="s0">'number'</span><span class="s1">) {</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">once</span><span class="s1">(</span><span class="s0">'open'</span><span class="s1">, </span><span class="s3">function </span><span class="s1">() {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">_read</span><span class="s1">(</span><span class="s2">n</span><span class="s1">);</span>
        <span class="s1">});</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">destroyed</span><span class="s1">)</span>
        <span class="s3">return</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">pool </span><span class="s1">|| </span><span class="s2">pool</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s2">pool</span><span class="s1">.</span><span class="s2">used </span><span class="s1">&lt; </span><span class="s2">kMinPoolSpace</span><span class="s1">) {</span>
        <span class="s5">// discard the old pool.</span>
        <span class="s2">allocNewPool</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_readableState</span><span class="s1">.</span><span class="s2">highWaterMark</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s5">// Grab another reference to the pool in the case that while we're</span>
    <span class="s5">// in the thread pool another read() finishes up the pool, and</span>
    <span class="s5">// allocates a new one.</span>
    <span class="s3">var </span><span class="s2">thisPool </span><span class="s1">= </span><span class="s2">pool</span><span class="s1">;</span>
    <span class="s3">var </span><span class="s2">toRead </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">min</span><span class="s1">(</span><span class="s2">pool</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s2">pool</span><span class="s1">.</span><span class="s2">used</span><span class="s1">, </span><span class="s2">n</span><span class="s1">);</span>
    <span class="s3">var </span><span class="s2">start </span><span class="s1">= </span><span class="s2">pool</span><span class="s1">.</span><span class="s2">used</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">pos </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">)</span>
        <span class="s2">toRead </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">min</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">end </span><span class="s1">- </span><span class="s3">this</span><span class="s1">.</span><span class="s2">pos </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">, </span><span class="s2">toRead</span><span class="s1">);</span>
    <span class="s5">// already read everything we were supposed to read!</span>
    <span class="s5">// treat as EOF.</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">toRead </span><span class="s1">&lt;= </span><span class="s4">0</span><span class="s1">)</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">null</span><span class="s1">);</span>
    <span class="s5">// the actual read.</span>
    <span class="s3">var </span><span class="s2">self </span><span class="s1">= </span><span class="s3">this</span><span class="s1">; </span><span class="s5">// tslint:disable-line no-this-assignment</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_vol</span><span class="s1">.</span><span class="s2">read</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">pool</span><span class="s1">, </span><span class="s2">pool</span><span class="s1">.</span><span class="s2">used</span><span class="s1">, </span><span class="s2">toRead</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">pos</span><span class="s1">, </span><span class="s2">onread</span><span class="s1">);</span>
    <span class="s5">// move the pool positions, and internal position for reading.</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">pos </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">)</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">pos </span><span class="s1">+= </span><span class="s2">toRead</span><span class="s1">;</span>
    <span class="s2">pool</span><span class="s1">.</span><span class="s2">used </span><span class="s1">+= </span><span class="s2">toRead</span><span class="s1">;</span>
    <span class="s3">function </span><span class="s2">onread</span><span class="s1">(</span><span class="s2">er</span><span class="s1">, </span><span class="s2">bytesRead</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">er</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">self</span><span class="s1">.</span><span class="s2">autoClose </span><span class="s1">&amp;&amp; </span><span class="s2">self</span><span class="s1">.</span><span class="s2">destroy</span><span class="s1">) {</span>
                <span class="s2">self</span><span class="s1">.</span><span class="s2">destroy</span><span class="s1">();</span>
            <span class="s1">}</span>
            <span class="s2">self</span><span class="s1">.</span><span class="s2">emit</span><span class="s1">(</span><span class="s0">'error'</span><span class="s1">, </span><span class="s2">er</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">else </span><span class="s1">{</span>
            <span class="s3">var </span><span class="s2">b </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">bytesRead </span><span class="s1">&gt; </span><span class="s4">0</span><span class="s1">) {</span>
                <span class="s2">self</span><span class="s1">.</span><span class="s2">bytesRead </span><span class="s1">+= </span><span class="s2">bytesRead</span><span class="s1">;</span>
                <span class="s2">b </span><span class="s1">= </span><span class="s2">thisPool</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">, </span><span class="s2">start </span><span class="s1">+ </span><span class="s2">bytesRead</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s2">self</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">b</span><span class="s1">);</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
<span class="s1">};</span>
<span class="s2">FsReadStream</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_destroy </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">err</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">close</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">err2</span><span class="s1">) {</span>
        <span class="s2">cb</span><span class="s1">(</span><span class="s2">err </span><span class="s1">|| </span><span class="s2">err2</span><span class="s1">);</span>
    <span class="s1">});</span>
<span class="s1">};</span>
<span class="s2">FsReadStream</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">close </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s3">var </span><span class="s2">_this </span><span class="s1">= </span><span class="s3">this</span><span class="s1">;</span>
    <span class="s3">var </span><span class="s2">_a</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">cb</span><span class="s1">)</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">once</span><span class="s1">(</span><span class="s0">'close'</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">closed </span><span class="s1">|| </span><span class="s3">typeof this</span><span class="s1">.</span><span class="s2">fd </span><span class="s1">!== </span><span class="s0">'number'</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof this</span><span class="s1">.</span><span class="s2">fd </span><span class="s1">!== </span><span class="s0">'number'</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">once</span><span class="s1">(</span><span class="s0">'open'</span><span class="s1">, </span><span class="s2">closeOnOpen</span><span class="s1">);</span>
            <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">return </span><span class="s2">process_1</span><span class="s1">.</span><span class="s2">default</span><span class="s1">.</span><span class="s2">nextTick</span><span class="s1">(</span><span class="s3">function </span><span class="s1">() { </span><span class="s3">return </span><span class="s2">_this</span><span class="s1">.</span><span class="s2">emit</span><span class="s1">(</span><span class="s0">'close'</span><span class="s1">); });</span>
    <span class="s1">}</span>
    <span class="s5">// Since Node 18, there is only a getter for '.closed'.</span>
    <span class="s5">// The first branch mimics other setters from Readable.</span>
    <span class="s5">// See https://github.com/nodejs/node/blob/v18.0.0/lib/internal/streams/readable.js#L1243</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s1">((</span><span class="s2">_a </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_readableState</span><span class="s1">) === </span><span class="s3">null </span><span class="s1">|| </span><span class="s2">_a </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0 </span><span class="s1">? </span><span class="s3">void </span><span class="s4">0 </span><span class="s1">: </span><span class="s2">_a</span><span class="s1">.</span><span class="s2">closed</span><span class="s1">) === </span><span class="s0">'boolean'</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">_readableState</span><span class="s1">.</span><span class="s2">closed </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">else </span><span class="s1">{</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">closed </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_vol</span><span class="s1">.</span><span class="s2">close</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">fd</span><span class="s1">, </span><span class="s3">function </span><span class="s1">(</span><span class="s2">er</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">er</span><span class="s1">)</span>
            <span class="s2">_this</span><span class="s1">.</span><span class="s2">emit</span><span class="s1">(</span><span class="s0">'error'</span><span class="s1">, </span><span class="s2">er</span><span class="s1">);</span>
        <span class="s3">else</span>
            <span class="s2">_this</span><span class="s1">.</span><span class="s2">emit</span><span class="s1">(</span><span class="s0">'close'</span><span class="s1">);</span>
    <span class="s1">});</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">fd </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
<span class="s1">};</span>
<span class="s5">// needed because as it will be called with arguments</span>
<span class="s5">// that does not match this.close() signature</span>
<span class="s3">function </span><span class="s2">closeOnOpen</span><span class="s1">(</span><span class="s2">fd</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">close</span><span class="s1">();</span>
<span class="s1">}</span>
<span class="s2">util</span><span class="s1">.</span><span class="s2">inherits</span><span class="s1">(</span><span class="s2">FsWriteStream</span><span class="s1">, </span><span class="s2">stream_1</span><span class="s1">.</span><span class="s2">Writable</span><span class="s1">);</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">WriteStream </span><span class="s1">= </span><span class="s2">FsWriteStream</span><span class="s1">;</span>
<span class="s3">function </span><span class="s2">FsWriteStream</span><span class="s1">(</span><span class="s2">vol</span><span class="s1">, </span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(!(</span><span class="s3">this instanceof </span><span class="s2">FsWriteStream</span><span class="s1">))</span>
        <span class="s3">return new </span><span class="s2">FsWriteStream</span><span class="s1">(</span><span class="s2">vol</span><span class="s1">, </span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_vol </span><span class="s1">= </span><span class="s2">vol</span><span class="s1">;</span>
    <span class="s2">options </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">assign</span><span class="s1">({}, </span><span class="s2">getOptions</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, {}));</span>
    <span class="s2">stream_1</span><span class="s1">.</span><span class="s2">Writable</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">path </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">fd </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">fd </span><span class="s1">=== </span><span class="s2">undefined </span><span class="s1">? </span><span class="s3">null </span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">fd</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">flags </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">flags </span><span class="s1">=== </span><span class="s2">undefined </span><span class="s1">? </span><span class="s0">'w' </span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">flags</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">mode </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">mode </span><span class="s1">=== </span><span class="s2">undefined </span><span class="s1">? </span><span class="s4">438 </span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">mode</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">start </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">start</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">autoClose </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">autoClose </span><span class="s1">=== </span><span class="s2">undefined </span><span class="s1">? </span><span class="s3">true </span><span class="s1">: !!</span><span class="s2">options</span><span class="s1">.</span><span class="s2">autoClose</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">pos </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">bytesWritten </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">start </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof this</span><span class="s1">.</span><span class="s2">start </span><span class="s1">!== </span><span class="s0">'number'</span><span class="s1">) {</span>
            <span class="s3">throw new </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s0">'&quot;start&quot; option must be a Number'</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">start </span><span class="s1">&lt; </span><span class="s4">0</span><span class="s1">) {</span>
            <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'&quot;start&quot; must be &gt;= zero'</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">pos </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">start</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">encoding</span><span class="s1">)</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">setDefaultEncoding</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">encoding</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof this</span><span class="s1">.</span><span class="s2">fd </span><span class="s1">!== </span><span class="s0">'number'</span><span class="s1">)</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">open</span><span class="s1">();</span>
    <span class="s5">// dispose on finish.</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">once</span><span class="s1">(</span><span class="s0">'finish'</span><span class="s1">, </span><span class="s3">function </span><span class="s1">() {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">autoClose</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">close</span><span class="s1">();</span>
        <span class="s1">}</span>
    <span class="s1">});</span>
<span class="s1">}</span>
<span class="s2">FsWriteStream</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">open </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_vol</span><span class="s1">.</span><span class="s2">open</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">path</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">flags</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">mode</span><span class="s1">, </span><span class="s3">function </span><span class="s1">(</span><span class="s2">er</span><span class="s1">, </span><span class="s2">fd</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">er</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">autoClose </span><span class="s1">&amp;&amp; </span><span class="s3">this</span><span class="s1">.</span><span class="s2">destroy</span><span class="s1">) {</span>
                <span class="s3">this</span><span class="s1">.</span><span class="s2">destroy</span><span class="s1">();</span>
            <span class="s1">}</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">emit</span><span class="s1">(</span><span class="s0">'error'</span><span class="s1">, </span><span class="s2">er</span><span class="s1">);</span>
            <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">fd </span><span class="s1">= </span><span class="s2">fd</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">emit</span><span class="s1">(</span><span class="s0">'open'</span><span class="s1">, </span><span class="s2">fd</span><span class="s1">);</span>
    <span class="s1">}.</span><span class="s2">bind</span><span class="s1">(</span><span class="s3">this</span><span class="s1">));</span>
<span class="s1">};</span>
<span class="s2">FsWriteStream</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_write </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">data</span><span class="s1">, </span><span class="s2">encoding</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(!(</span><span class="s2">data </span><span class="s3">instanceof </span><span class="s2">buffer_1</span><span class="s1">.</span><span class="s2">Buffer </span><span class="s1">|| </span><span class="s2">data </span><span class="s3">instanceof </span><span class="s2">Uint8Array</span><span class="s1">))</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">emit</span><span class="s1">(</span><span class="s0">'error'</span><span class="s1">, </span><span class="s3">new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'Invalid data'</span><span class="s1">));</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof this</span><span class="s1">.</span><span class="s2">fd </span><span class="s1">!== </span><span class="s0">'number'</span><span class="s1">) {</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">once</span><span class="s1">(</span><span class="s0">'open'</span><span class="s1">, </span><span class="s3">function </span><span class="s1">() {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">_write</span><span class="s1">(</span><span class="s2">data</span><span class="s1">, </span><span class="s2">encoding</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">);</span>
        <span class="s1">});</span>
    <span class="s1">}</span>
    <span class="s3">var </span><span class="s2">self </span><span class="s1">= </span><span class="s3">this</span><span class="s1">; </span><span class="s5">// tslint:disable-line no-this-assignment</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_vol</span><span class="s1">.</span><span class="s2">write</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">data</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s2">data</span><span class="s1">.</span><span class="s2">length</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">pos</span><span class="s1">, </span><span class="s3">function </span><span class="s1">(</span><span class="s2">er</span><span class="s1">, </span><span class="s2">bytes</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">er</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">self</span><span class="s1">.</span><span class="s2">autoClose </span><span class="s1">&amp;&amp; </span><span class="s2">self</span><span class="s1">.</span><span class="s2">destroy</span><span class="s1">) {</span>
                <span class="s2">self</span><span class="s1">.</span><span class="s2">destroy</span><span class="s1">();</span>
            <span class="s1">}</span>
            <span class="s3">return </span><span class="s2">cb</span><span class="s1">(</span><span class="s2">er</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s2">self</span><span class="s1">.</span><span class="s2">bytesWritten </span><span class="s1">+= </span><span class="s2">bytes</span><span class="s1">;</span>
        <span class="s2">cb</span><span class="s1">();</span>
    <span class="s1">});</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">pos </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">)</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">pos </span><span class="s1">+= </span><span class="s2">data</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
<span class="s1">};</span>
<span class="s2">FsWriteStream</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_writev </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">data</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof this</span><span class="s1">.</span><span class="s2">fd </span><span class="s1">!== </span><span class="s0">'number'</span><span class="s1">) {</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">once</span><span class="s1">(</span><span class="s0">'open'</span><span class="s1">, </span><span class="s3">function </span><span class="s1">() {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">_writev</span><span class="s1">(</span><span class="s2">data</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">);</span>
        <span class="s1">});</span>
    <span class="s1">}</span>
    <span class="s3">var </span><span class="s2">self </span><span class="s1">= </span><span class="s3">this</span><span class="s1">; </span><span class="s5">// tslint:disable-line no-this-assignment</span>
    <span class="s3">var </span><span class="s2">len </span><span class="s1">= </span><span class="s2">data</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
    <span class="s3">var </span><span class="s2">chunks </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Array</span><span class="s1">(</span><span class="s2">len</span><span class="s1">);</span>
    <span class="s3">var </span><span class="s2">size </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
    <span class="s3">for </span><span class="s1">(</span><span class="s3">var </span><span class="s2">i </span><span class="s1">= </span><span class="s4">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">len</span><span class="s1">; </span><span class="s2">i</span><span class="s1">++) {</span>
        <span class="s3">var </span><span class="s2">chunk </span><span class="s1">= </span><span class="s2">data</span><span class="s1">[</span><span class="s2">i</span><span class="s1">].</span><span class="s2">chunk</span><span class="s1">;</span>
        <span class="s2">chunks</span><span class="s1">[</span><span class="s2">i</span><span class="s1">] = </span><span class="s2">chunk</span><span class="s1">;</span>
        <span class="s2">size </span><span class="s1">+= </span><span class="s2">chunk</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">var </span><span class="s2">buf </span><span class="s1">= </span><span class="s2">buffer_1</span><span class="s1">.</span><span class="s2">Buffer</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">chunks</span><span class="s1">);</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_vol</span><span class="s1">.</span><span class="s2">write</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">fd</span><span class="s1">, </span><span class="s2">buf</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s2">buf</span><span class="s1">.</span><span class="s2">length</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">pos</span><span class="s1">, </span><span class="s3">function </span><span class="s1">(</span><span class="s2">er</span><span class="s1">, </span><span class="s2">bytes</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">er</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">self</span><span class="s1">.</span><span class="s2">destroy</span><span class="s1">)</span>
                <span class="s2">self</span><span class="s1">.</span><span class="s2">destroy</span><span class="s1">();</span>
            <span class="s3">return </span><span class="s2">cb</span><span class="s1">(</span><span class="s2">er</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s2">self</span><span class="s1">.</span><span class="s2">bytesWritten </span><span class="s1">+= </span><span class="s2">bytes</span><span class="s1">;</span>
        <span class="s2">cb</span><span class="s1">();</span>
    <span class="s1">});</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">pos </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">)</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">pos </span><span class="s1">+= </span><span class="s2">size</span><span class="s1">;</span>
<span class="s1">};</span>
<span class="s2">FsWriteStream</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">close </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s3">var </span><span class="s2">_this </span><span class="s1">= </span><span class="s3">this</span><span class="s1">;</span>
    <span class="s3">var </span><span class="s2">_a</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">cb</span><span class="s1">)</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">once</span><span class="s1">(</span><span class="s0">'close'</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">closed </span><span class="s1">|| </span><span class="s3">typeof this</span><span class="s1">.</span><span class="s2">fd </span><span class="s1">!== </span><span class="s0">'number'</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof this</span><span class="s1">.</span><span class="s2">fd </span><span class="s1">!== </span><span class="s0">'number'</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">once</span><span class="s1">(</span><span class="s0">'open'</span><span class="s1">, </span><span class="s2">closeOnOpen</span><span class="s1">);</span>
            <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">return </span><span class="s2">process_1</span><span class="s1">.</span><span class="s2">default</span><span class="s1">.</span><span class="s2">nextTick</span><span class="s1">(</span><span class="s3">function </span><span class="s1">() { </span><span class="s3">return </span><span class="s2">_this</span><span class="s1">.</span><span class="s2">emit</span><span class="s1">(</span><span class="s0">'close'</span><span class="s1">); });</span>
    <span class="s1">}</span>
    <span class="s5">// Since Node 18, there is only a getter for '.closed'.</span>
    <span class="s5">// The first branch mimics other setters from Writable.</span>
    <span class="s5">// See https://github.com/nodejs/node/blob/v18.0.0/lib/internal/streams/writable.js#L766</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s1">((</span><span class="s2">_a </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_writableState</span><span class="s1">) === </span><span class="s3">null </span><span class="s1">|| </span><span class="s2">_a </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0 </span><span class="s1">? </span><span class="s3">void </span><span class="s4">0 </span><span class="s1">: </span><span class="s2">_a</span><span class="s1">.</span><span class="s2">closed</span><span class="s1">) === </span><span class="s0">'boolean'</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">_writableState</span><span class="s1">.</span><span class="s2">closed </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">else </span><span class="s1">{</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">closed </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">_vol</span><span class="s1">.</span><span class="s2">close</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">fd</span><span class="s1">, </span><span class="s3">function </span><span class="s1">(</span><span class="s2">er</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">er</span><span class="s1">)</span>
            <span class="s2">_this</span><span class="s1">.</span><span class="s2">emit</span><span class="s1">(</span><span class="s0">'error'</span><span class="s1">, </span><span class="s2">er</span><span class="s1">);</span>
        <span class="s3">else</span>
            <span class="s2">_this</span><span class="s1">.</span><span class="s2">emit</span><span class="s1">(</span><span class="s0">'close'</span><span class="s1">);</span>
    <span class="s1">});</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">fd </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
<span class="s1">};</span>
<span class="s2">FsWriteStream</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_destroy </span><span class="s1">= </span><span class="s2">FsReadStream</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_destroy</span><span class="s1">;</span>
<span class="s5">// There is no shutdown() for files.</span>
<span class="s2">FsWriteStream</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">destroySoon </span><span class="s1">= </span><span class="s2">FsWriteStream</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">end</span><span class="s1">;</span>
<span class="s5">// ---------------------------------------- FSWatcher</span>
<span class="s3">var </span><span class="s2">FSWatcher </span><span class="s1">= </span><span class="s6">/** </span><span class="s7">@class </span><span class="s6">*/ </span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">_super</span><span class="s1">) {</span>
    <span class="s2">__extends</span><span class="s1">(</span><span class="s2">FSWatcher</span><span class="s1">, </span><span class="s2">_super</span><span class="s1">);</span>
    <span class="s3">function </span><span class="s2">FSWatcher</span><span class="s1">(</span><span class="s2">vol</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">_this </span><span class="s1">= </span><span class="s2">_super</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">) || </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s2">_this</span><span class="s1">.</span><span class="s2">_filename </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
        <span class="s2">_this</span><span class="s1">.</span><span class="s2">_filenameEncoded </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
        <span class="s5">// _persistent: boolean = true;</span>
        <span class="s2">_this</span><span class="s1">.</span><span class="s2">_recursive </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
        <span class="s2">_this</span><span class="s1">.</span><span class="s2">_encoding </span><span class="s1">= </span><span class="s2">encoding_1</span><span class="s1">.</span><span class="s2">ENCODING_UTF8</span><span class="s1">;</span>
        <span class="s5">// inode -&gt; removers</span>
        <span class="s2">_this</span><span class="s1">.</span><span class="s2">_listenerRemovers </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Map</span><span class="s1">();</span>
        <span class="s2">_this</span><span class="s1">.</span><span class="s2">_onParentChild </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">link</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">link</span><span class="s1">.</span><span class="s2">getName</span><span class="s1">() === </span><span class="s2">_this</span><span class="s1">.</span><span class="s2">_getName</span><span class="s1">()) {</span>
                <span class="s2">_this</span><span class="s1">.</span><span class="s2">_emit</span><span class="s1">(</span><span class="s0">'rename'</span><span class="s1">);</span>
            <span class="s1">}</span>
        <span class="s1">};</span>
        <span class="s2">_this</span><span class="s1">.</span><span class="s2">_emit </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">type</span><span class="s1">) {</span>
            <span class="s2">_this</span><span class="s1">.</span><span class="s2">emit</span><span class="s1">(</span><span class="s0">'change'</span><span class="s1">, </span><span class="s2">type</span><span class="s1">, </span><span class="s2">_this</span><span class="s1">.</span><span class="s2">_filenameEncoded</span><span class="s1">);</span>
        <span class="s1">};</span>
        <span class="s2">_this</span><span class="s1">.</span><span class="s2">_persist </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
            <span class="s2">_this</span><span class="s1">.</span><span class="s2">_timer </span><span class="s1">= </span><span class="s2">setTimeout</span><span class="s1">(</span><span class="s2">_this</span><span class="s1">.</span><span class="s2">_persist</span><span class="s1">, </span><span class="s4">1e6</span><span class="s1">);</span>
        <span class="s1">};</span>
        <span class="s2">_this</span><span class="s1">.</span><span class="s2">_vol </span><span class="s1">= </span><span class="s2">vol</span><span class="s1">;</span>
        <span class="s3">return </span><span class="s2">_this</span><span class="s1">;</span>
        <span class="s5">// TODO: Emit &quot;error&quot; messages when watching.</span>
        <span class="s5">// this._handle.onchange = function(status, eventType, filename) {</span>
        <span class="s5">//     if (status &lt; 0) {</span>
        <span class="s5">//         self._handle.close();</span>
        <span class="s5">//         const error = !filename ?</span>
        <span class="s5">//             errnoException(status, 'Error watching file for changes:') :</span>
        <span class="s5">//             errnoException(status, `Error watching file ${filename} for changes:`);</span>
        <span class="s5">//         error.filename = filename;</span>
        <span class="s5">//         self.emit('error', error);</span>
        <span class="s5">//     } else {</span>
        <span class="s5">//         self.emit('change', eventType, filename);</span>
        <span class="s5">//     }</span>
        <span class="s5">// };</span>
    <span class="s1">}</span>
    <span class="s2">FSWatcher</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">_getName </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">_steps</span><span class="s1">[</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_steps</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">1</span><span class="s1">];</span>
    <span class="s1">};</span>
    <span class="s2">FSWatcher</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">start </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">persistent</span><span class="s1">, </span><span class="s2">recursive</span><span class="s1">, </span><span class="s2">encoding</span><span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">_this </span><span class="s1">= </span><span class="s3">this</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">persistent </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">persistent </span><span class="s1">= </span><span class="s3">true</span><span class="s1">; }</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">recursive </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">recursive </span><span class="s1">= </span><span class="s3">false</span><span class="s1">; }</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">encoding </span><span class="s1">=== </span><span class="s3">void </span><span class="s4">0</span><span class="s1">) { </span><span class="s2">encoding </span><span class="s1">= </span><span class="s2">encoding_1</span><span class="s1">.</span><span class="s2">ENCODING_UTF8</span><span class="s1">; }</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">_filename </span><span class="s1">= </span><span class="s2">pathToFilename</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">_steps </span><span class="s1">= </span><span class="s2">filenameToSteps</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_filename</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">_filenameEncoded </span><span class="s1">= (</span><span class="s4">0</span><span class="s1">, </span><span class="s2">encoding_1</span><span class="s1">.</span><span class="s2">strToEncoding</span><span class="s1">)(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_filename</span><span class="s1">);</span>
        <span class="s5">// this._persistent = persistent;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">_recursive </span><span class="s1">= </span><span class="s2">recursive</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">_encoding </span><span class="s1">= </span><span class="s2">encoding</span><span class="s1">;</span>
        <span class="s3">try </span><span class="s1">{</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">_link </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_vol</span><span class="s1">.</span><span class="s2">getLinkOrThrow</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_filename</span><span class="s1">, </span><span class="s0">'FSWatcher'</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
            <span class="s3">var </span><span class="s2">error </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">&quot;watch &quot;</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_filename</span><span class="s1">, </span><span class="s0">&quot; &quot;</span><span class="s1">).</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">err</span><span class="s1">.</span><span class="s2">code</span><span class="s1">));</span>
            <span class="s2">error</span><span class="s1">.</span><span class="s2">code </span><span class="s1">= </span><span class="s2">err</span><span class="s1">.</span><span class="s2">code</span><span class="s1">;</span>
            <span class="s2">error</span><span class="s1">.</span><span class="s2">errno </span><span class="s1">= </span><span class="s2">err</span><span class="s1">.</span><span class="s2">code</span><span class="s1">;</span>
            <span class="s3">throw </span><span class="s2">error</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">var </span><span class="s2">watchLinkNodeChanged </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">link</span><span class="s1">) {</span>
            <span class="s3">var </span><span class="s2">_a</span><span class="s1">;</span>
            <span class="s3">var </span><span class="s2">filepath </span><span class="s1">= </span><span class="s2">link</span><span class="s1">.</span><span class="s2">getPath</span><span class="s1">();</span>
            <span class="s3">var </span><span class="s2">node </span><span class="s1">= </span><span class="s2">link</span><span class="s1">.</span><span class="s2">getNode</span><span class="s1">();</span>
            <span class="s3">var </span><span class="s2">onNodeChange </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
                <span class="s3">var </span><span class="s2">filename </span><span class="s1">= </span><span class="s2">relative</span><span class="s1">(</span><span class="s2">_this</span><span class="s1">.</span><span class="s2">_filename</span><span class="s1">, </span><span class="s2">filepath</span><span class="s1">);</span>
                <span class="s3">if </span><span class="s1">(!</span><span class="s2">filename</span><span class="s1">) {</span>
                    <span class="s2">filename </span><span class="s1">= </span><span class="s2">_this</span><span class="s1">.</span><span class="s2">_getName</span><span class="s1">();</span>
                <span class="s1">}</span>
                <span class="s3">return </span><span class="s2">_this</span><span class="s1">.</span><span class="s2">emit</span><span class="s1">(</span><span class="s0">'change'</span><span class="s1">, </span><span class="s0">'change'</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">);</span>
            <span class="s1">};</span>
            <span class="s2">node</span><span class="s1">.</span><span class="s2">on</span><span class="s1">(</span><span class="s0">'change'</span><span class="s1">, </span><span class="s2">onNodeChange</span><span class="s1">);</span>
            <span class="s3">var </span><span class="s2">removers </span><span class="s1">= (</span><span class="s2">_a </span><span class="s1">= </span><span class="s2">_this</span><span class="s1">.</span><span class="s2">_listenerRemovers</span><span class="s1">.</span><span class="s2">get</span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">ino</span><span class="s1">)) !== </span><span class="s3">null </span><span class="s1">&amp;&amp; </span><span class="s2">_a </span><span class="s1">!== </span><span class="s3">void </span><span class="s4">0 </span><span class="s1">? </span><span class="s2">_a </span><span class="s1">: [];</span>
            <span class="s2">removers</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">function </span><span class="s1">() { </span><span class="s3">return </span><span class="s2">node</span><span class="s1">.</span><span class="s2">removeListener</span><span class="s1">(</span><span class="s0">'change'</span><span class="s1">, </span><span class="s2">onNodeChange</span><span class="s1">); });</span>
            <span class="s2">_this</span><span class="s1">.</span><span class="s2">_listenerRemovers</span><span class="s1">.</span><span class="s2">set</span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">ino</span><span class="s1">, </span><span class="s2">removers</span><span class="s1">);</span>
        <span class="s1">};</span>
        <span class="s3">var </span><span class="s2">watchLinkChildrenChanged </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">link</span><span class="s1">) {</span>
            <span class="s3">var </span><span class="s2">_a</span><span class="s1">;</span>
            <span class="s3">var </span><span class="s2">node </span><span class="s1">= </span><span class="s2">link</span><span class="s1">.</span><span class="s2">getNode</span><span class="s1">();</span>
            <span class="s5">// when a new link added</span>
            <span class="s3">var </span><span class="s2">onLinkChildAdd </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">l</span><span class="s1">) {</span>
                <span class="s2">_this</span><span class="s1">.</span><span class="s2">emit</span><span class="s1">(</span><span class="s0">'change'</span><span class="s1">, </span><span class="s0">'rename'</span><span class="s1">, </span><span class="s2">relative</span><span class="s1">(</span><span class="s2">_this</span><span class="s1">.</span><span class="s2">_filename</span><span class="s1">, </span><span class="s2">l</span><span class="s1">.</span><span class="s2">getPath</span><span class="s1">()));</span>
                <span class="s2">setTimeout</span><span class="s1">(</span><span class="s3">function </span><span class="s1">() {</span>
                    <span class="s5">// 1. watch changes of the new link-node</span>
                    <span class="s2">watchLinkNodeChanged</span><span class="s1">(</span><span class="s2">l</span><span class="s1">);</span>
                    <span class="s5">// 2. watch changes of the new link-node's children</span>
                    <span class="s2">watchLinkChildrenChanged</span><span class="s1">(</span><span class="s2">l</span><span class="s1">);</span>
                <span class="s1">});</span>
            <span class="s1">};</span>
            <span class="s5">// when a new link deleted</span>
            <span class="s3">var </span><span class="s2">onLinkChildDelete </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">l</span><span class="s1">) {</span>
                <span class="s5">// remove the listeners of the children nodes</span>
                <span class="s3">var </span><span class="s2">removeLinkNodeListeners </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">curLink</span><span class="s1">) {</span>
                    <span class="s3">var </span><span class="s2">ino </span><span class="s1">= </span><span class="s2">curLink</span><span class="s1">.</span><span class="s2">getNode</span><span class="s1">().</span><span class="s2">ino</span><span class="s1">;</span>
                    <span class="s3">var </span><span class="s2">removers </span><span class="s1">= </span><span class="s2">_this</span><span class="s1">.</span><span class="s2">_listenerRemovers</span><span class="s1">.</span><span class="s2">get</span><span class="s1">(</span><span class="s2">ino</span><span class="s1">);</span>
                    <span class="s3">if </span><span class="s1">(</span><span class="s2">removers</span><span class="s1">) {</span>
                        <span class="s2">removers</span><span class="s1">.</span><span class="s2">forEach</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">r</span><span class="s1">) { </span><span class="s3">return </span><span class="s2">r</span><span class="s1">(); });</span>
                        <span class="s2">_this</span><span class="s1">.</span><span class="s2">_listenerRemovers</span><span class="s1">.</span><span class="s2">delete</span><span class="s1">(</span><span class="s2">ino</span><span class="s1">);</span>
                    <span class="s1">}</span>
                    <span class="s2">Object</span><span class="s1">.</span><span class="s2">values</span><span class="s1">(</span><span class="s2">curLink</span><span class="s1">.</span><span class="s2">children</span><span class="s1">).</span><span class="s2">forEach</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">childLink</span><span class="s1">) {</span>
                        <span class="s3">if </span><span class="s1">(</span><span class="s2">childLink</span><span class="s1">) {</span>
                            <span class="s2">removeLinkNodeListeners</span><span class="s1">(</span><span class="s2">childLink</span><span class="s1">);</span>
                        <span class="s1">}</span>
                    <span class="s1">});</span>
                <span class="s1">};</span>
                <span class="s2">removeLinkNodeListeners</span><span class="s1">(</span><span class="s2">l</span><span class="s1">);</span>
                <span class="s2">_this</span><span class="s1">.</span><span class="s2">emit</span><span class="s1">(</span><span class="s0">'change'</span><span class="s1">, </span><span class="s0">'rename'</span><span class="s1">, </span><span class="s2">relative</span><span class="s1">(</span><span class="s2">_this</span><span class="s1">.</span><span class="s2">_filename</span><span class="s1">, </span><span class="s2">l</span><span class="s1">.</span><span class="s2">getPath</span><span class="s1">()));</span>
            <span class="s1">};</span>
            <span class="s5">// children nodes changed</span>
            <span class="s2">Object</span><span class="s1">.</span><span class="s2">entries</span><span class="s1">(</span><span class="s2">link</span><span class="s1">.</span><span class="s2">children</span><span class="s1">).</span><span class="s2">forEach</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">_a</span><span class="s1">) {</span>
                <span class="s3">var </span><span class="s2">name </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">[</span><span class="s4">0</span><span class="s1">], </span><span class="s2">childLink </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">childLink </span><span class="s1">&amp;&amp; </span><span class="s2">name </span><span class="s1">!== </span><span class="s0">'.' </span><span class="s1">&amp;&amp; </span><span class="s2">name </span><span class="s1">!== </span><span class="s0">'..'</span><span class="s1">) {</span>
                    <span class="s2">watchLinkNodeChanged</span><span class="s1">(</span><span class="s2">childLink</span><span class="s1">);</span>
                <span class="s1">}</span>
            <span class="s1">});</span>
            <span class="s5">// link children add/remove</span>
            <span class="s2">link</span><span class="s1">.</span><span class="s2">on</span><span class="s1">(</span><span class="s0">'child:add'</span><span class="s1">, </span><span class="s2">onLinkChildAdd</span><span class="s1">);</span>
            <span class="s2">link</span><span class="s1">.</span><span class="s2">on</span><span class="s1">(</span><span class="s0">'child:delete'</span><span class="s1">, </span><span class="s2">onLinkChildDelete</span><span class="s1">);</span>
            <span class="s3">var </span><span class="s2">removers </span><span class="s1">= (</span><span class="s2">_a </span><span class="s1">= </span><span class="s2">_this</span><span class="s1">.</span><span class="s2">_listenerRemovers</span><span class="s1">.</span><span class="s2">get</span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">ino</span><span class="s1">)) !== </span><span class="s3">null </span><span class="s1">&amp;&amp; </span><span class="s2">_a </span><span class="s1">!== </span><span class="s3">void </span><span class="s4">0 </span><span class="s1">? </span><span class="s2">_a </span><span class="s1">: [];</span>
            <span class="s2">removers</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">function </span><span class="s1">() {</span>
                <span class="s2">link</span><span class="s1">.</span><span class="s2">removeListener</span><span class="s1">(</span><span class="s0">'child:add'</span><span class="s1">, </span><span class="s2">onLinkChildAdd</span><span class="s1">);</span>
                <span class="s2">link</span><span class="s1">.</span><span class="s2">removeListener</span><span class="s1">(</span><span class="s0">'child:delete'</span><span class="s1">, </span><span class="s2">onLinkChildDelete</span><span class="s1">);</span>
            <span class="s1">});</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">recursive</span><span class="s1">) {</span>
                <span class="s2">Object</span><span class="s1">.</span><span class="s2">entries</span><span class="s1">(</span><span class="s2">link</span><span class="s1">.</span><span class="s2">children</span><span class="s1">).</span><span class="s2">forEach</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">_a</span><span class="s1">) {</span>
                    <span class="s3">var </span><span class="s2">name </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">[</span><span class="s4">0</span><span class="s1">], </span><span class="s2">childLink </span><span class="s1">= </span><span class="s2">_a</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
                    <span class="s3">if </span><span class="s1">(</span><span class="s2">childLink </span><span class="s1">&amp;&amp; </span><span class="s2">name </span><span class="s1">!== </span><span class="s0">'.' </span><span class="s1">&amp;&amp; </span><span class="s2">name </span><span class="s1">!== </span><span class="s0">'..'</span><span class="s1">) {</span>
                        <span class="s2">watchLinkChildrenChanged</span><span class="s1">(</span><span class="s2">childLink</span><span class="s1">);</span>
                    <span class="s1">}</span>
                <span class="s1">});</span>
            <span class="s1">}</span>
        <span class="s1">};</span>
        <span class="s2">watchLinkNodeChanged</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_link</span><span class="s1">);</span>
        <span class="s2">watchLinkChildrenChanged</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_link</span><span class="s1">);</span>
        <span class="s3">var </span><span class="s2">parent </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_link</span><span class="s1">.</span><span class="s2">parent</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">parent</span><span class="s1">) {</span>
            <span class="s5">// parent.on('child:add', this._onParentChild);</span>
            <span class="s2">parent</span><span class="s1">.</span><span class="s2">setMaxListeners</span><span class="s1">(</span><span class="s2">parent</span><span class="s1">.</span><span class="s2">getMaxListeners</span><span class="s1">() + </span><span class="s4">1</span><span class="s1">);</span>
            <span class="s2">parent</span><span class="s1">.</span><span class="s2">on</span><span class="s1">(</span><span class="s0">'child:delete'</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_onParentChild</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">persistent</span><span class="s1">)</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">_persist</span><span class="s1">();</span>
    <span class="s1">};</span>
    <span class="s2">FSWatcher</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">close </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
        <span class="s2">clearTimeout</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">_timer</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">_listenerRemovers</span><span class="s1">.</span><span class="s2">forEach</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">removers</span><span class="s1">) {</span>
            <span class="s2">removers</span><span class="s1">.</span><span class="s2">forEach</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">r</span><span class="s1">) { </span><span class="s3">return </span><span class="s2">r</span><span class="s1">(); });</span>
        <span class="s1">});</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">_listenerRemovers</span><span class="s1">.</span><span class="s2">clear</span><span class="s1">();</span>
        <span class="s3">var </span><span class="s2">parent </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_link</span><span class="s1">.</span><span class="s2">parent</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">parent</span><span class="s1">) {</span>
            <span class="s5">// parent.removeListener('child:add', this._onParentChild);</span>
            <span class="s2">parent</span><span class="s1">.</span><span class="s2">removeListener</span><span class="s1">(</span><span class="s0">'child:delete'</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">_onParentChild</span><span class="s1">);</span>
        <span class="s1">}</span>
    <span class="s1">};</span>
    <span class="s3">return </span><span class="s2">FSWatcher</span><span class="s1">;</span>
<span class="s1">}(</span><span class="s2">events_1</span><span class="s1">.</span><span class="s2">EventEmitter</span><span class="s1">));</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">FSWatcher </span><span class="s1">= </span><span class="s2">FSWatcher</span><span class="s1">;</span>
</pre>
</body>
</html>