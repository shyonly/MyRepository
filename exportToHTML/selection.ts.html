<html>
<head>
<title>selection.ts</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #67a37c; font-style: italic;}
.s2 { color: #bcbec4;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #7a7e85;}
.s7 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
selection.ts</font>
</center></td></tr></table>
<pre><span class="s0">/**</span>
 <span class="s0">* </span><span class="s1">@description </span><span class="s0">selection range API</span>
 <span class="s0">* </span><span class="s1">@author </span><span class="s0">wangfupeng</span>
 <span class="s0">*/</span>
<span class="s3">import </span><span class="s2">$</span><span class="s4">, { </span><span class="s2">DomElement </span><span class="s4">} </span><span class="s2">from </span><span class="s5">'../utils/dom-core'</span>
<span class="s3">import </span><span class="s4">{ </span><span class="s2">UA </span><span class="s4">} </span><span class="s2">from </span><span class="s5">'../utils/util'</span>
<span class="s3">import </span><span class="s2">Editor from </span><span class="s5">'./index'</span>
<span class="s3">import </span><span class="s4">{ </span><span class="s2">EMPTY_P </span><span class="s4">} </span><span class="s2">from </span><span class="s5">'../utils/const'</span>

<span class="s3">class </span><span class="s2">SelectionAndRange </span><span class="s4">{</span>
    <span class="s3">public </span><span class="s2">editor</span><span class="s4">: </span><span class="s2">Editor</span>
    <span class="s3">private </span><span class="s2">_currentRange</span><span class="s4">: </span><span class="s2">Range </span><span class="s4">| </span><span class="s3">null </span><span class="s4">| </span><span class="s2">undefined </span><span class="s4">= </span><span class="s3">null</span>

    <span class="s2">constructor</span><span class="s4">(</span><span class="s2">editor</span><span class="s4">: </span><span class="s2">Editor</span><span class="s4">) {</span>
        <span class="s3">this</span><span class="s4">.</span><span class="s2">editor </span><span class="s4">= </span><span class="s2">editor</span>
    <span class="s4">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 获取当前 range</span>
     <span class="s0">*/</span>
    <span class="s3">public </span><span class="s2">getRange</span><span class="s4">(): </span><span class="s2">Range </span><span class="s4">| </span><span class="s3">null </span><span class="s4">| </span><span class="s2">undefined </span><span class="s4">{</span>
        <span class="s3">return this</span><span class="s4">.</span><span class="s2">_currentRange</span>
    <span class="s4">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 保存选区范围</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">_range 选区范围</span>
     <span class="s0">*/</span>
    <span class="s3">public </span><span class="s2">saveRange</span><span class="s4">(</span><span class="s2">_range</span><span class="s4">?: </span><span class="s2">Range</span><span class="s4">): </span><span class="s3">void </span><span class="s4">{</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s2">_range</span><span class="s4">) {</span>
            <span class="s6">// 保存已有选区</span>
            <span class="s3">this</span><span class="s4">.</span><span class="s2">_currentRange </span><span class="s4">= </span><span class="s2">_range</span>
            <span class="s3">return</span>
        <span class="s4">}</span>

        <span class="s6">// 获取当前的选区</span>
        <span class="s3">const </span><span class="s2">selection </span><span class="s4">= </span><span class="s2">window</span><span class="s4">.</span><span class="s2">getSelection</span><span class="s4">() as </span><span class="s2">Selection</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s2">selection</span><span class="s4">.</span><span class="s2">rangeCount </span><span class="s4">=== </span><span class="s7">0</span><span class="s4">) {</span>
            <span class="s3">return</span>
        <span class="s4">}</span>
        <span class="s3">const </span><span class="s2">range </span><span class="s4">= </span><span class="s2">selection</span><span class="s4">.</span><span class="s2">getRangeAt</span><span class="s4">(</span><span class="s7">0</span><span class="s4">)</span>

        <span class="s6">// 获取选区范围的 DOM 元素</span>
        <span class="s3">const </span><span class="s2">$containerElem </span><span class="s4">= </span><span class="s3">this</span><span class="s4">.</span><span class="s2">getSelectionContainerElem</span><span class="s4">(</span><span class="s2">range</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s4">(!</span><span class="s2">$containerElem</span><span class="s4">?.</span><span class="s2">length</span><span class="s4">) {</span>
            <span class="s6">// 当 选区范围内没有 DOM元素 则抛出</span>
            <span class="s3">return</span>
        <span class="s4">}</span>
        <span class="s3">if </span><span class="s4">(</span>
            <span class="s2">$containerElem</span><span class="s4">.</span><span class="s2">attr</span><span class="s4">(</span><span class="s5">'contenteditable'</span><span class="s4">) === </span><span class="s5">'false' </span><span class="s4">||</span>
            <span class="s2">$containerElem</span><span class="s4">.</span><span class="s2">parentUntil</span><span class="s4">(</span><span class="s5">'[contenteditable=false]'</span><span class="s4">)</span>
        <span class="s4">) {</span>
            <span class="s6">// 这里大体意义上就是个保险</span>
            <span class="s6">// 确保 编辑区域 的 contenteditable属性 的值为 true</span>
            <span class="s3">return</span>
        <span class="s4">}</span>

        <span class="s3">const </span><span class="s2">editor </span><span class="s4">= </span><span class="s3">this</span><span class="s4">.</span><span class="s2">editor</span>
        <span class="s3">const </span><span class="s2">$textElem </span><span class="s4">= </span><span class="s2">editor</span><span class="s4">.</span><span class="s2">$textElem</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s2">$textElem</span><span class="s4">.</span><span class="s2">isContain</span><span class="s4">(</span><span class="s2">$containerElem</span><span class="s4">)) {</span>
            <span class="s3">if </span><span class="s4">(</span><span class="s2">$textElem</span><span class="s4">.</span><span class="s2">elems</span><span class="s4">[</span><span class="s7">0</span><span class="s4">] === </span><span class="s2">$containerElem</span><span class="s4">.</span><span class="s2">elems</span><span class="s4">[</span><span class="s7">0</span><span class="s4">]) {</span>
                <span class="s3">if </span><span class="s4">(</span><span class="s2">$textElem</span><span class="s4">.</span><span class="s2">html</span><span class="s4">().</span><span class="s2">trim</span><span class="s4">() === </span><span class="s2">EMPTY_P</span><span class="s4">) {</span>
                    <span class="s3">const </span><span class="s2">$children </span><span class="s4">= </span><span class="s2">$textElem</span><span class="s4">.</span><span class="s2">children</span><span class="s4">()</span>
                    <span class="s3">const </span><span class="s2">$last </span><span class="s4">= </span><span class="s2">$children</span><span class="s4">?.</span><span class="s2">last</span><span class="s4">()</span>
                    <span class="s2">editor</span><span class="s4">.</span><span class="s2">selection</span><span class="s4">.</span><span class="s2">createRangeByElem</span><span class="s4">(</span><span class="s2">$last </span><span class="s4">as </span><span class="s2">DomElement</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, </span><span class="s3">true</span><span class="s4">)</span>
                    <span class="s2">editor</span><span class="s4">.</span><span class="s2">selection</span><span class="s4">.</span><span class="s2">restoreSelection</span><span class="s4">()</span>
                <span class="s4">}</span>
            <span class="s4">}</span>
            <span class="s6">// 是编辑内容之内的</span>
            <span class="s3">this</span><span class="s4">.</span><span class="s2">_currentRange </span><span class="s4">= </span><span class="s2">range</span>
        <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 折叠选区范围</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">toStart true 开始位置，false 结束位置</span>
     <span class="s0">*/</span>
    <span class="s3">public </span><span class="s2">collapseRange</span><span class="s4">(</span><span class="s2">toStart</span><span class="s4">: </span><span class="s2">boolean </span><span class="s4">= </span><span class="s3">false</span><span class="s4">): </span><span class="s3">void </span><span class="s4">{</span>
        <span class="s3">const </span><span class="s2">range </span><span class="s4">= </span><span class="s3">this</span><span class="s4">.</span><span class="s2">_currentRange</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s2">range</span><span class="s4">) {</span>
            <span class="s2">range</span><span class="s4">.</span><span class="s2">collapse</span><span class="s4">(</span><span class="s2">toStart</span><span class="s4">)</span>
        <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 获取选区范围内的文字</span>
     <span class="s0">*/</span>
    <span class="s3">public </span><span class="s2">getSelectionText</span><span class="s4">(): </span><span class="s2">string </span><span class="s4">{</span>
        <span class="s3">const </span><span class="s2">range </span><span class="s4">= </span><span class="s3">this</span><span class="s4">.</span><span class="s2">_currentRange</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s2">range</span><span class="s4">) {</span>
            <span class="s3">return </span><span class="s2">range</span><span class="s4">.</span><span class="s2">toString</span><span class="s4">()</span>
        <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
            <span class="s3">return </span><span class="s5">''</span>
        <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 获取选区范围的 DOM 元素</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">range 选区范围</span>
     <span class="s0">*/</span>
    <span class="s3">public </span><span class="s2">getSelectionContainerElem</span><span class="s4">(</span><span class="s2">range</span><span class="s4">?: </span><span class="s2">Range</span><span class="s4">): </span><span class="s2">DomElement </span><span class="s4">| </span><span class="s2">undefined </span><span class="s4">{</span>
        <span class="s3">let </span><span class="s2">r</span><span class="s4">: </span><span class="s2">Range </span><span class="s4">| </span><span class="s3">null </span><span class="s4">| </span><span class="s2">undefined</span>
        <span class="s2">r </span><span class="s4">= </span><span class="s2">range </span><span class="s4">|| </span><span class="s3">this</span><span class="s4">.</span><span class="s2">_currentRange</span>
        <span class="s3">let </span><span class="s2">elem</span><span class="s4">: </span><span class="s2">Node</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s2">r</span><span class="s4">) {</span>
            <span class="s2">elem </span><span class="s4">= </span><span class="s2">r</span><span class="s4">.</span><span class="s2">commonAncestorContainer</span>
            <span class="s3">return </span><span class="s2">$</span><span class="s4">(</span><span class="s2">elem</span><span class="s4">.</span><span class="s2">nodeType </span><span class="s4">=== </span><span class="s7">1 </span><span class="s4">? </span><span class="s2">elem </span><span class="s4">: </span><span class="s2">elem</span><span class="s4">.</span><span class="s2">parentNode</span><span class="s4">)</span>
        <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 选区范围开始的 DOM 元素</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">range 选区范围</span>
     <span class="s0">*/</span>
    <span class="s3">public </span><span class="s2">getSelectionStartElem</span><span class="s4">(</span><span class="s2">range</span><span class="s4">?: </span><span class="s2">Range</span><span class="s4">): </span><span class="s2">DomElement </span><span class="s4">| </span><span class="s2">undefined </span><span class="s4">{</span>
        <span class="s3">let </span><span class="s2">r</span><span class="s4">: </span><span class="s2">Range </span><span class="s4">| </span><span class="s3">null </span><span class="s4">| </span><span class="s2">undefined</span>
        <span class="s2">r </span><span class="s4">= </span><span class="s2">range </span><span class="s4">|| </span><span class="s3">this</span><span class="s4">.</span><span class="s2">_currentRange</span>
        <span class="s3">let </span><span class="s2">elem</span><span class="s4">: </span><span class="s2">Node</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s2">r</span><span class="s4">) {</span>
            <span class="s2">elem </span><span class="s4">= </span><span class="s2">r</span><span class="s4">.</span><span class="s2">startContainer</span>
            <span class="s3">return </span><span class="s2">$</span><span class="s4">(</span><span class="s2">elem</span><span class="s4">.</span><span class="s2">nodeType </span><span class="s4">=== </span><span class="s7">1 </span><span class="s4">? </span><span class="s2">elem </span><span class="s4">: </span><span class="s2">elem</span><span class="s4">.</span><span class="s2">parentNode</span><span class="s4">)</span>
        <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 选区范围结束的 DOM 元素</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">range 选区范围</span>
     <span class="s0">*/</span>
    <span class="s3">public </span><span class="s2">getSelectionEndElem</span><span class="s4">(</span><span class="s2">range</span><span class="s4">?: </span><span class="s2">Range</span><span class="s4">): </span><span class="s2">DomElement </span><span class="s4">| </span><span class="s2">undefined </span><span class="s4">{</span>
        <span class="s3">let </span><span class="s2">r</span><span class="s4">: </span><span class="s2">Range </span><span class="s4">| </span><span class="s3">null </span><span class="s4">| </span><span class="s2">undefined</span>
        <span class="s2">r </span><span class="s4">= </span><span class="s2">range </span><span class="s4">|| </span><span class="s3">this</span><span class="s4">.</span><span class="s2">_currentRange</span>
        <span class="s3">let </span><span class="s2">elem</span><span class="s4">: </span><span class="s2">Node</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s2">r</span><span class="s4">) {</span>
            <span class="s2">elem </span><span class="s4">= </span><span class="s2">r</span><span class="s4">.</span><span class="s2">endContainer</span>
            <span class="s3">return </span><span class="s2">$</span><span class="s4">(</span><span class="s2">elem</span><span class="s4">.</span><span class="s2">nodeType </span><span class="s4">=== </span><span class="s7">1 </span><span class="s4">? </span><span class="s2">elem </span><span class="s4">: </span><span class="s2">elem</span><span class="s4">.</span><span class="s2">parentNode</span><span class="s4">)</span>
        <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 选区是否为空（没有选择文字）</span>
     <span class="s0">*/</span>
    <span class="s3">public </span><span class="s2">isSelectionEmpty</span><span class="s4">(): </span><span class="s2">boolean </span><span class="s4">{</span>
        <span class="s3">const </span><span class="s2">range </span><span class="s4">= </span><span class="s3">this</span><span class="s4">.</span><span class="s2">_currentRange</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s2">range </span><span class="s4">&amp;&amp; </span><span class="s2">range</span><span class="s4">.</span><span class="s2">startContainer</span><span class="s4">) {</span>
            <span class="s3">if </span><span class="s4">(</span><span class="s2">range</span><span class="s4">.</span><span class="s2">startContainer </span><span class="s4">=== </span><span class="s2">range</span><span class="s4">.</span><span class="s2">endContainer</span><span class="s4">) {</span>
                <span class="s3">if </span><span class="s4">(</span><span class="s2">range</span><span class="s4">.</span><span class="s2">startOffset </span><span class="s4">=== </span><span class="s2">range</span><span class="s4">.</span><span class="s2">endOffset</span><span class="s4">) {</span>
                    <span class="s3">return true</span>
                <span class="s4">}</span>
            <span class="s4">}</span>
        <span class="s4">}</span>
        <span class="s3">return false</span>
    <span class="s4">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 恢复选区范围</span>
     <span class="s0">*/</span>
    <span class="s3">public </span><span class="s2">restoreSelection</span><span class="s4">(): </span><span class="s3">void </span><span class="s4">{</span>
        <span class="s3">const </span><span class="s2">selection </span><span class="s4">= </span><span class="s2">window</span><span class="s4">.</span><span class="s2">getSelection</span><span class="s4">()</span>
        <span class="s3">const </span><span class="s2">r </span><span class="s4">= </span><span class="s3">this</span><span class="s4">.</span><span class="s2">_currentRange</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s2">selection </span><span class="s4">&amp;&amp; </span><span class="s2">r</span><span class="s4">) {</span>
            <span class="s2">selection</span><span class="s4">.</span><span class="s2">removeAllRanges</span><span class="s4">()</span>
            <span class="s2">selection</span><span class="s4">.</span><span class="s2">addRange</span><span class="s4">(</span><span class="s2">r</span><span class="s4">)</span>
        <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 创建一个空白（即 &amp;#8203 字符）选区</span>
     <span class="s0">*/</span>
    <span class="s3">public </span><span class="s2">createEmptyRange</span><span class="s4">(): </span><span class="s3">void </span><span class="s4">{</span>
        <span class="s3">const </span><span class="s2">editor </span><span class="s4">= </span><span class="s3">this</span><span class="s4">.</span><span class="s2">editor</span>
        <span class="s3">const </span><span class="s2">range </span><span class="s4">= </span><span class="s3">this</span><span class="s4">.</span><span class="s2">getRange</span><span class="s4">()</span>
        <span class="s3">let </span><span class="s2">$elem</span><span class="s4">: </span><span class="s2">DomElement</span>

        <span class="s3">if </span><span class="s4">(!</span><span class="s2">range</span><span class="s4">) {</span>
            <span class="s6">// 当前无 range</span>
            <span class="s3">return</span>
        <span class="s4">}</span>
        <span class="s3">if </span><span class="s4">(!</span><span class="s3">this</span><span class="s4">.</span><span class="s2">isSelectionEmpty</span><span class="s4">()) {</span>
            <span class="s6">// 当前选区必须没有内容才可以，有内容就直接 return</span>
            <span class="s3">return</span>
        <span class="s4">}</span>

        <span class="s3">try </span><span class="s4">{</span>
            <span class="s6">// 目前只支持 webkit 内核</span>
            <span class="s3">if </span><span class="s4">(</span><span class="s2">UA</span><span class="s4">.</span><span class="s2">isWebkit</span><span class="s4">()) {</span>
                <span class="s6">// 插入 &amp;#8203</span>
                <span class="s2">editor</span><span class="s4">.</span><span class="s2">cmd</span><span class="s4">.</span><span class="s2">do</span><span class="s4">(</span><span class="s5">'insertHTML'</span><span class="s4">, </span><span class="s5">'&amp;#8203;'</span><span class="s4">)</span>
                <span class="s6">// 修改 offset 位置</span>
                <span class="s2">range</span><span class="s4">.</span><span class="s2">setEnd</span><span class="s4">(</span><span class="s2">range</span><span class="s4">.</span><span class="s2">endContainer</span><span class="s4">, </span><span class="s2">range</span><span class="s4">.</span><span class="s2">endOffset </span><span class="s4">+ </span><span class="s7">1</span><span class="s4">)</span>
                <span class="s6">// 存储</span>
                <span class="s3">this</span><span class="s4">.</span><span class="s2">saveRange</span><span class="s4">(</span><span class="s2">range</span><span class="s4">)</span>
            <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
                <span class="s2">$elem </span><span class="s4">= </span><span class="s2">$</span><span class="s4">(</span><span class="s5">'&lt;strong&gt;&amp;#8203;&lt;/strong&gt;'</span><span class="s4">)</span>
                <span class="s2">editor</span><span class="s4">.</span><span class="s2">cmd</span><span class="s4">.</span><span class="s2">do</span><span class="s4">(</span><span class="s5">'insertElem'</span><span class="s4">, </span><span class="s2">$elem</span><span class="s4">)</span>
                <span class="s3">this</span><span class="s4">.</span><span class="s2">createRangeByElem</span><span class="s4">(</span><span class="s2">$elem</span><span class="s4">, </span><span class="s3">true</span><span class="s4">)</span>
            <span class="s4">}</span>
        <span class="s4">} </span><span class="s3">catch </span><span class="s4">(</span><span class="s2">ex</span><span class="s4">) {</span>
            <span class="s6">// 部分情况下会报错，兼容一下</span>
        <span class="s4">}</span>
    <span class="s4">}</span>
    <span class="s0">/**</span>
     <span class="s0">* 重新设置选区</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">startDom 选区开始的元素</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">endDom 选区结束的元素</span>
     <span class="s0">*/</span>
    <span class="s3">public </span><span class="s2">createRangeByElems</span><span class="s4">(</span><span class="s2">startDom</span><span class="s4">: </span><span class="s2">Node</span><span class="s4">, </span><span class="s2">endDom</span><span class="s4">: </span><span class="s2">Node</span><span class="s4">): </span><span class="s3">void </span><span class="s4">{</span>
        <span class="s3">let </span><span class="s2">selection </span><span class="s4">= </span><span class="s2">window</span><span class="s4">.</span><span class="s2">getSelection </span><span class="s4">? </span><span class="s2">window</span><span class="s4">.</span><span class="s2">getSelection</span><span class="s4">() : </span><span class="s2">document</span><span class="s4">.</span><span class="s2">getSelection</span><span class="s4">()</span>
        <span class="s6">//清除所有的选区</span>
        <span class="s2">selection</span><span class="s4">?.</span><span class="s2">removeAllRanges</span><span class="s4">()</span>
        <span class="s3">const </span><span class="s2">range </span><span class="s4">= </span><span class="s2">document</span><span class="s4">.</span><span class="s2">createRange</span><span class="s4">()</span>
        <span class="s2">range</span><span class="s4">.</span><span class="s2">setStart</span><span class="s4">(</span><span class="s2">startDom</span><span class="s4">, </span><span class="s7">0</span><span class="s4">)</span>
        <span class="s6">// 设置多行标签之后，第二个参数会被h标签内的b、font标签等影响range范围的选取</span>
        <span class="s2">range</span><span class="s4">.</span><span class="s2">setEnd</span><span class="s4">(</span><span class="s2">endDom</span><span class="s4">, </span><span class="s2">endDom</span><span class="s4">.</span><span class="s2">childNodes</span><span class="s4">.</span><span class="s2">length </span><span class="s4">|| </span><span class="s7">1</span><span class="s4">)</span>
        <span class="s6">// 保存设置好的选区</span>
        <span class="s3">this</span><span class="s4">.</span><span class="s2">saveRange</span><span class="s4">(</span><span class="s2">range</span><span class="s4">)</span>
        <span class="s6">//恢复选区</span>
        <span class="s3">this</span><span class="s4">.</span><span class="s2">restoreSelection</span><span class="s4">()</span>
    <span class="s4">}</span>
    <span class="s0">/**</span>
     <span class="s0">* 根据 DOM 元素设置选区</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">$elem DOM 元素</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">toStart true 开始位置，false 结束位置</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">isContent 是否选中 $elem 的内容</span>
     <span class="s0">*/</span>
    <span class="s3">public </span><span class="s2">createRangeByElem</span><span class="s4">(</span><span class="s2">$elem</span><span class="s4">: </span><span class="s2">DomElement</span><span class="s4">, </span><span class="s2">toStart</span><span class="s4">?: </span><span class="s2">boolean</span><span class="s4">, </span><span class="s2">isContent</span><span class="s4">?: </span><span class="s2">boolean</span><span class="s4">): </span><span class="s3">void </span><span class="s4">{</span>
        <span class="s3">if </span><span class="s4">(!</span><span class="s2">$elem</span><span class="s4">.</span><span class="s2">length</span><span class="s4">) {</span>
            <span class="s3">return</span>
        <span class="s4">}</span>

        <span class="s3">const </span><span class="s2">elem </span><span class="s4">= </span><span class="s2">$elem</span><span class="s4">.</span><span class="s2">elems</span><span class="s4">[</span><span class="s7">0</span><span class="s4">]</span>
        <span class="s3">const </span><span class="s2">range </span><span class="s4">= </span><span class="s2">document</span><span class="s4">.</span><span class="s2">createRange</span><span class="s4">()</span>

        <span class="s3">if </span><span class="s4">(</span><span class="s2">isContent</span><span class="s4">) {</span>
            <span class="s2">range</span><span class="s4">.</span><span class="s2">selectNodeContents</span><span class="s4">(</span><span class="s2">elem</span><span class="s4">)</span>
        <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
            <span class="s6">// 如果用户没有传入 isContent 参数，那就默认为 false</span>
            <span class="s2">range</span><span class="s4">.</span><span class="s2">selectNode</span><span class="s4">(</span><span class="s2">elem</span><span class="s4">)</span>
        <span class="s4">}</span>

        <span class="s3">if </span><span class="s4">(</span><span class="s2">toStart </span><span class="s4">!= </span><span class="s3">null</span><span class="s4">) {</span>
            <span class="s6">// 传入了 toStart 参数，折叠选区。如果没传入 toStart 参数，则忽略这一步</span>
            <span class="s2">range</span><span class="s4">.</span><span class="s2">collapse</span><span class="s4">(</span><span class="s2">toStart</span><span class="s4">)</span>

            <span class="s3">if </span><span class="s4">(!</span><span class="s2">toStart</span><span class="s4">) {</span>
                <span class="s3">this</span><span class="s4">.</span><span class="s2">saveRange</span><span class="s4">(</span><span class="s2">range</span><span class="s4">)</span>
                <span class="s3">this</span><span class="s4">.</span><span class="s2">editor</span><span class="s4">.</span><span class="s2">selection</span><span class="s4">.</span><span class="s2">moveCursor</span><span class="s4">(</span><span class="s2">elem</span><span class="s4">)</span>
            <span class="s4">}</span>
        <span class="s4">}</span>

        <span class="s6">// 存储 range</span>
        <span class="s3">this</span><span class="s4">.</span><span class="s2">saveRange</span><span class="s4">(</span><span class="s2">range</span><span class="s4">)</span>
    <span class="s4">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 获取 当前 选取范围的 顶级(段落) 元素</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">$editor</span>
     <span class="s0">*/</span>
    <span class="s3">public </span><span class="s2">getSelectionRangeTopNodes</span><span class="s4">(): </span><span class="s2">DomElement</span><span class="s4">[] {</span>
        <span class="s6">// 清空，防止叠加元素</span>
        <span class="s3">let </span><span class="s2">$nodeList</span><span class="s4">: </span><span class="s2">DomElement</span><span class="s4">[]</span>

        <span class="s3">const </span><span class="s2">$startElem </span><span class="s4">= </span><span class="s3">this</span><span class="s4">.</span><span class="s2">getSelectionStartElem</span><span class="s4">()?.</span><span class="s2">getNodeTop</span><span class="s4">(</span><span class="s3">this</span><span class="s4">.</span><span class="s2">editor</span><span class="s4">)</span>
        <span class="s3">const </span><span class="s2">$endElem </span><span class="s4">= </span><span class="s3">this</span><span class="s4">.</span><span class="s2">getSelectionEndElem</span><span class="s4">()?.</span><span class="s2">getNodeTop</span><span class="s4">(</span><span class="s3">this</span><span class="s4">.</span><span class="s2">editor</span><span class="s4">)</span>

        <span class="s2">$nodeList </span><span class="s4">= </span><span class="s3">this</span><span class="s4">.</span><span class="s2">recordSelectionNodes</span><span class="s4">(</span><span class="s2">$</span><span class="s4">(</span><span class="s2">$startElem</span><span class="s4">), </span><span class="s2">$</span><span class="s4">(</span><span class="s2">$endElem</span><span class="s4">))</span>

        <span class="s3">return </span><span class="s2">$nodeList</span>
    <span class="s4">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 移动光标位置,默认情况下在尾部</span>
     <span class="s0">* 有一个特殊情况是firefox下的文本节点会自动补充一个br元素，会导致自动换行</span>
     <span class="s0">* 所以默认情况下在firefox下的文本节点会自动移动到br前面</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">{Node} node 元素节点</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">{number} position 光标的位置</span>
     <span class="s0">*/</span>
    <span class="s3">public </span><span class="s2">moveCursor</span><span class="s4">(</span><span class="s2">node</span><span class="s4">: </span><span class="s2">Node</span><span class="s4">, </span><span class="s2">position</span><span class="s4">?: </span><span class="s2">number</span><span class="s4">): </span><span class="s3">void </span><span class="s4">{</span>
        <span class="s3">const </span><span class="s2">range </span><span class="s4">= </span><span class="s3">this</span><span class="s4">.</span><span class="s2">getRange</span><span class="s4">()</span>
        <span class="s6">//对文本节点特殊处理</span>
        <span class="s3">let </span><span class="s2">len</span><span class="s4">: </span><span class="s2">number </span><span class="s4">=</span>
            <span class="s2">node</span><span class="s4">.</span><span class="s2">nodeType </span><span class="s4">=== </span><span class="s7">3 </span><span class="s4">? (</span><span class="s2">node</span><span class="s4">.</span><span class="s2">nodeValue</span><span class="s4">?.</span><span class="s2">length </span><span class="s4">as </span><span class="s2">number</span><span class="s4">) : </span><span class="s2">node</span><span class="s4">.</span><span class="s2">childNodes</span><span class="s4">.</span><span class="s2">length</span>
        <span class="s3">if </span><span class="s4">((</span><span class="s2">UA</span><span class="s4">.</span><span class="s2">isFirefox </span><span class="s4">|| </span><span class="s2">UA</span><span class="s4">.</span><span class="s2">isIE</span><span class="s4">()) &amp;&amp; </span><span class="s2">len </span><span class="s4">!== </span><span class="s7">0</span><span class="s4">) {</span>
            <span class="s6">// firefox下在节点为文本节点和节点最后一个元素为文本节点的情况下</span>
            <span class="s3">if </span><span class="s4">(</span><span class="s2">node</span><span class="s4">.</span><span class="s2">nodeType </span><span class="s4">=== </span><span class="s7">3 </span><span class="s4">|| </span><span class="s2">node</span><span class="s4">.</span><span class="s2">childNodes</span><span class="s4">[</span><span class="s2">len </span><span class="s4">- </span><span class="s7">1</span><span class="s4">].</span><span class="s2">nodeName </span><span class="s4">=== </span><span class="s5">'BR'</span><span class="s4">) {</span>
                <span class="s2">len </span><span class="s4">= </span><span class="s2">len </span><span class="s4">- </span><span class="s7">1</span>
            <span class="s4">}</span>
        <span class="s4">}</span>
        <span class="s3">let </span><span class="s2">pos</span><span class="s4">: </span><span class="s2">number </span><span class="s4">= </span><span class="s2">position </span><span class="s4">?? </span><span class="s2">len</span>
        <span class="s3">if </span><span class="s4">(!</span><span class="s2">range</span><span class="s4">) {</span>
            <span class="s3">return</span>
        <span class="s4">}</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s2">node</span><span class="s4">) {</span>
            <span class="s2">range</span><span class="s4">.</span><span class="s2">setStart</span><span class="s4">(</span><span class="s2">node</span><span class="s4">, </span><span class="s2">pos</span><span class="s4">)</span>
            <span class="s2">range</span><span class="s4">.</span><span class="s2">setEnd</span><span class="s4">(</span><span class="s2">node</span><span class="s4">, </span><span class="s2">pos</span><span class="s4">)</span>
            <span class="s3">this</span><span class="s4">.</span><span class="s2">restoreSelection</span><span class="s4">()</span>
        <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 获取光标在当前选区的位置</span>
     <span class="s0">*/</span>
    <span class="s3">public </span><span class="s2">getCursorPos</span><span class="s4">(): </span><span class="s2">number </span><span class="s4">| </span><span class="s2">undefined </span><span class="s4">{</span>
        <span class="s3">const </span><span class="s2">selection </span><span class="s4">= </span><span class="s2">window</span><span class="s4">.</span><span class="s2">getSelection</span><span class="s4">()</span>

        <span class="s3">return </span><span class="s2">selection</span><span class="s4">?.</span><span class="s2">anchorOffset</span>
    <span class="s4">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 清除当前选区的Range,notice:不影响已保存的Range</span>
     <span class="s0">*/</span>
    <span class="s3">public </span><span class="s2">clearWindowSelectionRange</span><span class="s4">(): </span><span class="s3">void </span><span class="s4">{</span>
        <span class="s3">const </span><span class="s2">selection </span><span class="s4">= </span><span class="s2">window</span><span class="s4">.</span><span class="s2">getSelection</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s4">(</span><span class="s2">selection</span><span class="s4">) {</span>
            <span class="s2">selection</span><span class="s4">.</span><span class="s2">removeAllRanges</span><span class="s4">()</span>
        <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 记录节点 - 从选区开始节点开始 一直到匹配到选区结束节点为止</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">$node 节点</span>
     <span class="s0">*/</span>
    <span class="s3">public </span><span class="s2">recordSelectionNodes</span><span class="s4">(</span><span class="s2">$node</span><span class="s4">: </span><span class="s2">DomElement</span><span class="s4">, </span><span class="s2">$endElem</span><span class="s4">: </span><span class="s2">DomElement</span><span class="s4">): </span><span class="s2">DomElement</span><span class="s4">[] {</span>
        <span class="s3">let </span><span class="s2">$list</span><span class="s4">: </span><span class="s2">DomElement</span><span class="s4">[] = []</span>
        <span class="s3">let </span><span class="s2">isEnd </span><span class="s4">= </span><span class="s3">true</span>
        <span class="s0">/**  </span>
        <span class="s1">@author</span><span class="s0">:lw</span>
        <span class="s1">@description </span><span class="s0">解决ctrl+a全选报错的bug $elem.getNodeName()可能会触发$elem[0]未定义</span>
        <span class="s0">**/</span>
        <span class="s3">try </span><span class="s4">{</span>
            <span class="s3">let </span><span class="s2">$NODE</span><span class="s4">: </span><span class="s2">DomElement </span><span class="s4">= </span><span class="s2">$node</span>
            <span class="s3">const </span><span class="s2">$textElem </span><span class="s4">= </span><span class="s3">this</span><span class="s4">.</span><span class="s2">editor</span><span class="s4">.</span><span class="s2">$textElem</span>
            <span class="s6">// $NODE元素为空时不需要进行循环</span>
            <span class="s3">while </span><span class="s4">(</span><span class="s2">isEnd</span><span class="s4">) {</span>
                <span class="s3">const </span><span class="s2">$elem </span><span class="s4">= </span><span class="s2">$NODE</span><span class="s4">?.</span><span class="s2">getNodeTop</span><span class="s4">(</span><span class="s3">this</span><span class="s4">.</span><span class="s2">editor</span><span class="s4">)</span>
                <span class="s3">if </span><span class="s4">(</span><span class="s2">$elem</span><span class="s4">.</span><span class="s2">getNodeName</span><span class="s4">() === </span><span class="s5">'BODY'</span><span class="s4">) </span><span class="s2">isEnd </span><span class="s4">= </span><span class="s3">false </span><span class="s6">// 兜底</span>
                <span class="s3">if </span><span class="s4">(</span><span class="s2">$elem</span><span class="s4">.</span><span class="s2">length </span><span class="s4">&gt; </span><span class="s7">0</span><span class="s4">) {</span>
                    <span class="s2">$list</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">$</span><span class="s4">(</span><span class="s2">$NODE</span><span class="s4">))</span>
                    <span class="s6">// 两个边界情况：</span>
                    <span class="s6">// 1. 当前元素就是我们要找的末尾元素</span>
                    <span class="s6">// 2. 当前元素已经是编辑区顶级元素（否则会找到编辑区的兄弟节点，比如placeholder元素）</span>
                    <span class="s3">if </span><span class="s4">(</span><span class="s2">$endElem</span><span class="s4">?.</span><span class="s2">equal</span><span class="s4">(</span><span class="s2">$elem</span><span class="s4">) || </span><span class="s2">$textElem</span><span class="s4">.</span><span class="s2">equal</span><span class="s4">(</span><span class="s2">$elem</span><span class="s4">)) {</span>
                        <span class="s2">isEnd </span><span class="s4">= </span><span class="s3">false</span>
                    <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
                        <span class="s2">$NODE </span><span class="s4">= </span><span class="s2">$elem</span><span class="s4">.</span><span class="s2">getNextSibling</span><span class="s4">()</span>
                    <span class="s4">}</span>
                <span class="s4">}</span>
            <span class="s4">}</span>
        <span class="s4">} </span><span class="s3">catch </span><span class="s4">(</span><span class="s2">e</span><span class="s4">) {</span>
            <span class="s2">isEnd </span><span class="s4">= </span><span class="s3">false</span>
        <span class="s4">}</span>
        <span class="s3">return </span><span class="s2">$list</span>
    <span class="s4">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 将当前 range 设置到 node 元素并初始化位置</span>
     <span class="s0">* 解决编辑器内容为空时，菜单不生效的问题</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">node 元素节点</span>
     <span class="s0">*/</span>
    <span class="s3">public </span><span class="s2">setRangeToElem</span><span class="s4">(</span><span class="s2">node</span><span class="s4">: </span><span class="s2">Node</span><span class="s4">): </span><span class="s3">void </span><span class="s4">{</span>
        <span class="s3">const </span><span class="s2">range </span><span class="s4">= </span><span class="s3">this</span><span class="s4">.</span><span class="s2">getRange</span><span class="s4">()</span>
        <span class="s2">range</span><span class="s4">?.</span><span class="s2">setStart</span><span class="s4">(</span><span class="s2">node</span><span class="s4">, </span><span class="s7">0</span><span class="s4">)</span>
        <span class="s2">range</span><span class="s4">?.</span><span class="s2">setEnd</span><span class="s4">(</span><span class="s2">node</span><span class="s4">, </span><span class="s7">0</span><span class="s4">)</span>
    <span class="s4">}</span>
<span class="s4">}</span>

<span class="s3">export default </span><span class="s2">SelectionAndRange</span>
</pre>
</body>
</html>