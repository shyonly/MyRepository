<html>
<head>
<title>resolveSeq-d03cb037.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #6aab73;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #cf8e6d;}
.s4 { color: #42c3d4;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
.s7 { color: #5f826b; font-style: italic;}
.s8 { color: #67a37c; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
resolveSeq-d03cb037.js</font>
</center></td></tr></table>
<pre><span class="s0">'use strict'</span><span class="s1">;</span>

<span class="s3">var </span><span class="s2">PlainValue </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./PlainValue-ec8e588e.js'</span><span class="s1">);</span>

<span class="s3">function </span><span class="s2">addCommentBefore</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">indent</span><span class="s1">, </span><span class="s2">comment</span><span class="s1">) {</span>
  <span class="s3">if </span><span class="s1">(!</span><span class="s2">comment</span><span class="s1">) </span><span class="s3">return </span><span class="s2">str</span><span class="s1">;</span>
  <span class="s3">const </span><span class="s2">cc </span><span class="s1">= </span><span class="s2">comment</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s4">/[\s\S]^/gm</span><span class="s1">, </span><span class="s0">`$&amp;</span><span class="s2">$</span><span class="s1">{</span><span class="s2">indent</span><span class="s1">}</span><span class="s0">#`</span><span class="s1">);</span>
  <span class="s3">return </span><span class="s0">`#</span><span class="s2">$</span><span class="s1">{</span><span class="s2">cc</span><span class="s1">}</span><span class="s3">\n</span><span class="s2">$</span><span class="s1">{</span><span class="s2">indent</span><span class="s1">}</span><span class="s2">$</span><span class="s1">{</span><span class="s2">str</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
<span class="s1">}</span>
<span class="s3">function </span><span class="s2">addComment</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">indent</span><span class="s1">, </span><span class="s2">comment</span><span class="s1">) {</span>
  <span class="s3">return </span><span class="s1">!</span><span class="s2">comment </span><span class="s1">? </span><span class="s2">str </span><span class="s1">: </span><span class="s2">comment</span><span class="s1">.</span><span class="s2">indexOf</span><span class="s1">(</span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">) === -</span><span class="s5">1 </span><span class="s1">? </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">str</span><span class="s1">} </span><span class="s0">#</span><span class="s2">$</span><span class="s1">{</span><span class="s2">comment</span><span class="s1">}</span><span class="s0">` </span><span class="s1">: </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">str</span><span class="s1">}</span><span class="s3">\n</span><span class="s0">` </span><span class="s1">+ </span><span class="s2">comment</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s4">/^/gm</span><span class="s1">, </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">indent </span><span class="s1">|| </span><span class="s0">''</span><span class="s1">}</span><span class="s0">#`</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s3">class </span><span class="s2">Node </span><span class="s1">{}</span>

<span class="s3">function </span><span class="s2">toJSON</span><span class="s1">(</span><span class="s2">value</span><span class="s1">, </span><span class="s2">arg</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">) {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">value</span><span class="s1">)) </span><span class="s3">return </span><span class="s2">value</span><span class="s1">.</span><span class="s2">map</span><span class="s1">((</span><span class="s2">v</span><span class="s1">, </span><span class="s2">i</span><span class="s1">) =&gt; </span><span class="s2">toJSON</span><span class="s1">(</span><span class="s2">v</span><span class="s1">, </span><span class="s2">String</span><span class="s1">(</span><span class="s2">i</span><span class="s1">), </span><span class="s2">ctx</span><span class="s1">));</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">value </span><span class="s1">&amp;&amp; </span><span class="s3">typeof </span><span class="s2">value</span><span class="s1">.</span><span class="s2">toJSON </span><span class="s1">=== </span><span class="s0">'function'</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">anchor </span><span class="s1">= </span><span class="s2">ctx </span><span class="s1">&amp;&amp; </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">anchors </span><span class="s1">&amp;&amp; </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">anchors</span><span class="s1">.</span><span class="s2">get</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">anchor</span><span class="s1">) </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">onCreate </span><span class="s1">= </span><span class="s2">res </span><span class="s1">=&gt; {</span>
      <span class="s2">anchor</span><span class="s1">.</span><span class="s2">res </span><span class="s1">= </span><span class="s2">res</span><span class="s1">;</span>
      <span class="s3">delete </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">onCreate</span><span class="s1">;</span>
    <span class="s1">};</span>
    <span class="s3">const </span><span class="s2">res </span><span class="s1">= </span><span class="s2">value</span><span class="s1">.</span><span class="s2">toJSON</span><span class="s1">(</span><span class="s2">arg</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">anchor </span><span class="s1">&amp;&amp; </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">onCreate</span><span class="s1">) </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">onCreate</span><span class="s1">(</span><span class="s2">res</span><span class="s1">);</span>
    <span class="s3">return </span><span class="s2">res</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">((!</span><span class="s2">ctx </span><span class="s1">|| !</span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">keep</span><span class="s1">) &amp;&amp; </span><span class="s3">typeof </span><span class="s2">value </span><span class="s1">=== </span><span class="s0">'bigint'</span><span class="s1">) </span><span class="s3">return </span><span class="s2">Number</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>
  <span class="s3">return </span><span class="s2">value</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">class </span><span class="s2">Scalar </span><span class="s3">extends </span><span class="s2">Node </span><span class="s1">{</span>
  <span class="s2">constructor</span><span class="s1">(</span><span class="s2">value</span><span class="s1">) {</span>
    <span class="s3">super</span><span class="s1">();</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">value </span><span class="s1">= </span><span class="s2">value</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">toJSON</span><span class="s1">(</span><span class="s2">arg</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s2">ctx </span><span class="s1">&amp;&amp; </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">keep </span><span class="s1">? </span><span class="s3">this</span><span class="s1">.</span><span class="s2">value </span><span class="s1">: </span><span class="s2">toJSON</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">value</span><span class="s1">, </span><span class="s2">arg</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">toString</span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">String</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">value</span><span class="s1">);</span>
  <span class="s1">}</span>

<span class="s1">}</span>

<span class="s3">function </span><span class="s2">collectionFromPath</span><span class="s1">(</span><span class="s2">schema</span><span class="s1">, </span><span class="s2">path</span><span class="s1">, </span><span class="s2">value</span><span class="s1">) {</span>
  <span class="s3">let </span><span class="s2">v </span><span class="s1">= </span><span class="s2">value</span><span class="s1">;</span>

  <span class="s3">for </span><span class="s1">(</span><span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s2">path</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s5">1</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&gt;= </span><span class="s5">0</span><span class="s1">; --</span><span class="s2">i</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">k </span><span class="s1">= </span><span class="s2">path</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">Number</span><span class="s1">.</span><span class="s2">isInteger</span><span class="s1">(</span><span class="s2">k</span><span class="s1">) &amp;&amp; </span><span class="s2">k </span><span class="s1">&gt;= </span><span class="s5">0</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">a </span><span class="s1">= [];</span>
      <span class="s2">a</span><span class="s1">[</span><span class="s2">k</span><span class="s1">] = </span><span class="s2">v</span><span class="s1">;</span>
      <span class="s2">v </span><span class="s1">= </span><span class="s2">a</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">const </span><span class="s2">o </span><span class="s1">= {};</span>
      <span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">o</span><span class="s1">, </span><span class="s2">k</span><span class="s1">, {</span>
        <span class="s2">value</span><span class="s1">: </span><span class="s2">v</span><span class="s1">,</span>
        <span class="s2">writable</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
        <span class="s2">enumerable</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
        <span class="s2">configurable</span><span class="s1">: </span><span class="s3">true</span>
      <span class="s1">});</span>
      <span class="s2">v </span><span class="s1">= </span><span class="s2">o</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s2">schema</span><span class="s1">.</span><span class="s2">createNode</span><span class="s1">(</span><span class="s2">v</span><span class="s1">, </span><span class="s3">false</span><span class="s1">);</span>
<span class="s1">} </span><span class="s6">// null, undefined, or an empty non-string iterable (e.g. [])</span>


<span class="s3">const </span><span class="s2">isEmptyPath </span><span class="s1">= </span><span class="s2">path </span><span class="s1">=&gt; </span><span class="s2">path </span><span class="s1">== </span><span class="s3">null </span><span class="s1">|| </span><span class="s3">typeof </span><span class="s2">path </span><span class="s1">=== </span><span class="s0">'object' </span><span class="s1">&amp;&amp; </span><span class="s2">path</span><span class="s1">[</span><span class="s2">Symbol</span><span class="s1">.</span><span class="s2">iterator</span><span class="s1">]().</span><span class="s2">next</span><span class="s1">().</span><span class="s2">done</span><span class="s1">;</span>
<span class="s3">class </span><span class="s2">Collection </span><span class="s3">extends </span><span class="s2">Node </span><span class="s1">{</span>
  <span class="s2">constructor</span><span class="s1">(</span><span class="s2">schema</span><span class="s1">) {</span>
    <span class="s3">super</span><span class="s1">();</span>

    <span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">_defineProperty</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s0">&quot;items&quot;</span><span class="s1">, []);</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">schema </span><span class="s1">= </span><span class="s2">schema</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">addIn</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">value</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">isEmptyPath</span><span class="s1">(</span><span class="s2">path</span><span class="s1">)) </span><span class="s3">this</span><span class="s1">.</span><span class="s2">add</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">const </span><span class="s1">[</span><span class="s2">key</span><span class="s1">, </span><span class="s2">...rest</span><span class="s1">] = </span><span class="s2">path</span><span class="s1">;</span>
      <span class="s3">const </span><span class="s2">node </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">get</span><span class="s1">(</span><span class="s2">key</span><span class="s1">, </span><span class="s3">true</span><span class="s1">);</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">node </span><span class="s3">instanceof </span><span class="s2">Collection</span><span class="s1">) </span><span class="s2">node</span><span class="s1">.</span><span class="s2">addIn</span><span class="s1">(</span><span class="s2">rest</span><span class="s1">, </span><span class="s2">value</span><span class="s1">);</span><span class="s3">else if </span><span class="s1">(</span><span class="s2">node </span><span class="s1">=== </span><span class="s2">undefined </span><span class="s1">&amp;&amp; </span><span class="s3">this</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">) </span><span class="s3">this</span><span class="s1">.</span><span class="s2">set</span><span class="s1">(</span><span class="s2">key</span><span class="s1">, </span><span class="s2">collectionFromPath</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">, </span><span class="s2">rest</span><span class="s1">, </span><span class="s2">value</span><span class="s1">));</span><span class="s3">else throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">`Expected YAML collection at </span><span class="s2">$</span><span class="s1">{</span><span class="s2">key</span><span class="s1">}</span><span class="s0">. Remaining path: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">rest</span><span class="s1">}</span><span class="s0">`</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">deleteIn</span><span class="s1">([</span><span class="s2">key</span><span class="s1">, </span><span class="s2">...rest</span><span class="s1">]) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">rest</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s5">0</span><span class="s1">) </span><span class="s3">return this</span><span class="s1">.</span><span class="s2">delete</span><span class="s1">(</span><span class="s2">key</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">node </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">get</span><span class="s1">(</span><span class="s2">key</span><span class="s1">, </span><span class="s3">true</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">node </span><span class="s3">instanceof </span><span class="s2">Collection</span><span class="s1">) </span><span class="s3">return </span><span class="s2">node</span><span class="s1">.</span><span class="s2">deleteIn</span><span class="s1">(</span><span class="s2">rest</span><span class="s1">);</span><span class="s3">else throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">`Expected YAML collection at </span><span class="s2">$</span><span class="s1">{</span><span class="s2">key</span><span class="s1">}</span><span class="s0">. Remaining path: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">rest</span><span class="s1">}</span><span class="s0">`</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">getIn</span><span class="s1">([</span><span class="s2">key</span><span class="s1">, </span><span class="s2">...rest</span><span class="s1">], </span><span class="s2">keepScalar</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">node </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">get</span><span class="s1">(</span><span class="s2">key</span><span class="s1">, </span><span class="s3">true</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">rest</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s5">0</span><span class="s1">) </span><span class="s3">return </span><span class="s1">!</span><span class="s2">keepScalar </span><span class="s1">&amp;&amp; </span><span class="s2">node </span><span class="s3">instanceof </span><span class="s2">Scalar </span><span class="s1">? </span><span class="s2">node</span><span class="s1">.</span><span class="s2">value </span><span class="s1">: </span><span class="s2">node</span><span class="s1">;</span><span class="s3">else return </span><span class="s2">node </span><span class="s3">instanceof </span><span class="s2">Collection </span><span class="s1">? </span><span class="s2">node</span><span class="s1">.</span><span class="s2">getIn</span><span class="s1">(</span><span class="s2">rest</span><span class="s1">, </span><span class="s2">keepScalar</span><span class="s1">) : </span><span class="s2">undefined</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">hasAllNullValues</span><span class="s1">() {</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">items</span><span class="s1">.</span><span class="s2">every</span><span class="s1">(</span><span class="s2">node </span><span class="s1">=&gt; {</span>
      <span class="s3">if </span><span class="s1">(!</span><span class="s2">node </span><span class="s1">|| </span><span class="s2">node</span><span class="s1">.</span><span class="s2">type </span><span class="s1">!== </span><span class="s0">'PAIR'</span><span class="s1">) </span><span class="s3">return false</span><span class="s1">;</span>
      <span class="s3">const </span><span class="s2">n </span><span class="s1">= </span><span class="s2">node</span><span class="s1">.</span><span class="s2">value</span><span class="s1">;</span>
      <span class="s3">return </span><span class="s2">n </span><span class="s1">== </span><span class="s3">null </span><span class="s1">|| </span><span class="s2">n </span><span class="s3">instanceof </span><span class="s2">Scalar </span><span class="s1">&amp;&amp; </span><span class="s2">n</span><span class="s1">.</span><span class="s2">value </span><span class="s1">== </span><span class="s3">null </span><span class="s1">&amp;&amp; !</span><span class="s2">n</span><span class="s1">.</span><span class="s2">commentBefore </span><span class="s1">&amp;&amp; !</span><span class="s2">n</span><span class="s1">.</span><span class="s2">comment </span><span class="s1">&amp;&amp; !</span><span class="s2">n</span><span class="s1">.</span><span class="s2">tag</span><span class="s1">;</span>
    <span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s2">hasIn</span><span class="s1">([</span><span class="s2">key</span><span class="s1">, </span><span class="s2">...rest</span><span class="s1">]) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">rest</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s5">0</span><span class="s1">) </span><span class="s3">return this</span><span class="s1">.</span><span class="s2">has</span><span class="s1">(</span><span class="s2">key</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">node </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">get</span><span class="s1">(</span><span class="s2">key</span><span class="s1">, </span><span class="s3">true</span><span class="s1">);</span>
    <span class="s3">return </span><span class="s2">node </span><span class="s3">instanceof </span><span class="s2">Collection </span><span class="s1">? </span><span class="s2">node</span><span class="s1">.</span><span class="s2">hasIn</span><span class="s1">(</span><span class="s2">rest</span><span class="s1">) : </span><span class="s3">false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">setIn</span><span class="s1">([</span><span class="s2">key</span><span class="s1">, </span><span class="s2">...rest</span><span class="s1">], </span><span class="s2">value</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">rest</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s5">0</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">set</span><span class="s1">(</span><span class="s2">key</span><span class="s1">, </span><span class="s2">value</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">const </span><span class="s2">node </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">get</span><span class="s1">(</span><span class="s2">key</span><span class="s1">, </span><span class="s3">true</span><span class="s1">);</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">node </span><span class="s3">instanceof </span><span class="s2">Collection</span><span class="s1">) </span><span class="s2">node</span><span class="s1">.</span><span class="s2">setIn</span><span class="s1">(</span><span class="s2">rest</span><span class="s1">, </span><span class="s2">value</span><span class="s1">);</span><span class="s3">else if </span><span class="s1">(</span><span class="s2">node </span><span class="s1">=== </span><span class="s2">undefined </span><span class="s1">&amp;&amp; </span><span class="s3">this</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">) </span><span class="s3">this</span><span class="s1">.</span><span class="s2">set</span><span class="s1">(</span><span class="s2">key</span><span class="s1">, </span><span class="s2">collectionFromPath</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">, </span><span class="s2">rest</span><span class="s1">, </span><span class="s2">value</span><span class="s1">));</span><span class="s3">else throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">`Expected YAML collection at </span><span class="s2">$</span><span class="s1">{</span><span class="s2">key</span><span class="s1">}</span><span class="s0">. Remaining path: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">rest</span><span class="s1">}</span><span class="s0">`</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s6">// overridden in implementations</span>

  <span class="s6">/* istanbul ignore next */</span>


  <span class="s2">toJSON</span><span class="s1">() {</span>
    <span class="s3">return null</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">toString</span><span class="s1">(</span><span class="s2">ctx</span><span class="s1">, {</span>
    <span class="s2">blockItem</span><span class="s1">,</span>
    <span class="s2">flowChars</span><span class="s1">,</span>
    <span class="s2">isMap</span><span class="s1">,</span>
    <span class="s2">itemIndent</span>
  <span class="s1">}, </span><span class="s2">onComment</span><span class="s1">, </span><span class="s2">onChompKeep</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s1">{</span>
      <span class="s2">indent</span><span class="s1">,</span>
      <span class="s2">indentStep</span><span class="s1">,</span>
      <span class="s2">stringify</span>
    <span class="s1">} = </span><span class="s2">ctx</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">inFlow </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">FLOW_MAP </span><span class="s1">|| </span><span class="s3">this</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">FLOW_SEQ </span><span class="s1">|| </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">inFlow</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">inFlow</span><span class="s1">) </span><span class="s2">itemIndent </span><span class="s1">+= </span><span class="s2">indentStep</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">allNullValues </span><span class="s1">= </span><span class="s2">isMap </span><span class="s1">&amp;&amp; </span><span class="s3">this</span><span class="s1">.</span><span class="s2">hasAllNullValues</span><span class="s1">();</span>
    <span class="s2">ctx </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">assign</span><span class="s1">({}, </span><span class="s2">ctx</span><span class="s1">, {</span>
      <span class="s2">allNullValues</span><span class="s1">,</span>
      <span class="s2">indent</span><span class="s1">: </span><span class="s2">itemIndent</span><span class="s1">,</span>
      <span class="s2">inFlow</span><span class="s1">,</span>
      <span class="s2">type</span><span class="s1">: </span><span class="s3">null</span>
    <span class="s1">});</span>
    <span class="s3">let </span><span class="s2">chompKeep </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s3">let </span><span class="s2">hasItemWithNewLine </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">nodes </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">items</span><span class="s1">.</span><span class="s2">reduce</span><span class="s1">((</span><span class="s2">nodes</span><span class="s1">, </span><span class="s2">item</span><span class="s1">, </span><span class="s2">i</span><span class="s1">) =&gt; {</span>
      <span class="s3">let </span><span class="s2">comment</span><span class="s1">;</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">item</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">chompKeep </span><span class="s1">&amp;&amp; </span><span class="s2">item</span><span class="s1">.</span><span class="s2">spaceBefore</span><span class="s1">) </span><span class="s2">nodes</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({</span>
          <span class="s2">type</span><span class="s1">: </span><span class="s0">'comment'</span><span class="s1">,</span>
          <span class="s2">str</span><span class="s1">: </span><span class="s0">''</span>
        <span class="s1">});</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">commentBefore</span><span class="s1">) </span><span class="s2">item</span><span class="s1">.</span><span class="s2">commentBefore</span><span class="s1">.</span><span class="s2">match</span><span class="s1">(</span><span class="s4">/^.*$/gm</span><span class="s1">).</span><span class="s2">forEach</span><span class="s1">(</span><span class="s2">line </span><span class="s1">=&gt; {</span>
          <span class="s2">nodes</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({</span>
            <span class="s2">type</span><span class="s1">: </span><span class="s0">'comment'</span><span class="s1">,</span>
            <span class="s2">str</span><span class="s1">: </span><span class="s0">`#</span><span class="s2">$</span><span class="s1">{</span><span class="s2">line</span><span class="s1">}</span><span class="s0">`</span>
          <span class="s1">});</span>
        <span class="s1">});</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">comment</span><span class="s1">) </span><span class="s2">comment </span><span class="s1">= </span><span class="s2">item</span><span class="s1">.</span><span class="s2">comment</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">inFlow </span><span class="s1">&amp;&amp; (!</span><span class="s2">chompKeep </span><span class="s1">&amp;&amp; </span><span class="s2">item</span><span class="s1">.</span><span class="s2">spaceBefore </span><span class="s1">|| </span><span class="s2">item</span><span class="s1">.</span><span class="s2">commentBefore </span><span class="s1">|| </span><span class="s2">item</span><span class="s1">.</span><span class="s2">comment </span><span class="s1">|| </span><span class="s2">item</span><span class="s1">.</span><span class="s2">key </span><span class="s1">&amp;&amp; (</span><span class="s2">item</span><span class="s1">.</span><span class="s2">key</span><span class="s1">.</span><span class="s2">commentBefore </span><span class="s1">|| </span><span class="s2">item</span><span class="s1">.</span><span class="s2">key</span><span class="s1">.</span><span class="s2">comment</span><span class="s1">) || </span><span class="s2">item</span><span class="s1">.</span><span class="s2">value </span><span class="s1">&amp;&amp; (</span><span class="s2">item</span><span class="s1">.</span><span class="s2">value</span><span class="s1">.</span><span class="s2">commentBefore </span><span class="s1">|| </span><span class="s2">item</span><span class="s1">.</span><span class="s2">value</span><span class="s1">.</span><span class="s2">comment</span><span class="s1">))) </span><span class="s2">hasItemWithNewLine </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s2">chompKeep </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
      <span class="s3">let </span><span class="s2">str </span><span class="s1">= </span><span class="s2">stringify</span><span class="s1">(</span><span class="s2">item</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">, () =&gt; </span><span class="s2">comment </span><span class="s1">= </span><span class="s3">null</span><span class="s1">, () =&gt; </span><span class="s2">chompKeep </span><span class="s1">= </span><span class="s3">true</span><span class="s1">);</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">inFlow </span><span class="s1">&amp;&amp; !</span><span class="s2">hasItemWithNewLine </span><span class="s1">&amp;&amp; </span><span class="s2">str</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">)) </span><span class="s2">hasItemWithNewLine </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">inFlow </span><span class="s1">&amp;&amp; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s3">this</span><span class="s1">.</span><span class="s2">items</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s5">1</span><span class="s1">) </span><span class="s2">str </span><span class="s1">+= </span><span class="s0">','</span><span class="s1">;</span>
      <span class="s2">str </span><span class="s1">= </span><span class="s2">addComment</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">itemIndent</span><span class="s1">, </span><span class="s2">comment</span><span class="s1">);</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">chompKeep </span><span class="s1">&amp;&amp; (</span><span class="s2">comment </span><span class="s1">|| </span><span class="s2">inFlow</span><span class="s1">)) </span><span class="s2">chompKeep </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
      <span class="s2">nodes</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({</span>
        <span class="s2">type</span><span class="s1">: </span><span class="s0">'item'</span><span class="s1">,</span>
        <span class="s2">str</span>
      <span class="s1">});</span>
      <span class="s3">return </span><span class="s2">nodes</span><span class="s1">;</span>
    <span class="s1">}, []);</span>
    <span class="s3">let </span><span class="s2">str</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">nodes</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s5">0</span><span class="s1">) {</span>
      <span class="s2">str </span><span class="s1">= </span><span class="s2">flowChars</span><span class="s1">.</span><span class="s2">start </span><span class="s1">+ </span><span class="s2">flowChars</span><span class="s1">.</span><span class="s2">end</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">inFlow</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s1">{</span>
        <span class="s2">start</span><span class="s1">,</span>
        <span class="s2">end</span>
      <span class="s1">} = </span><span class="s2">flowChars</span><span class="s1">;</span>
      <span class="s3">const </span><span class="s2">strings </span><span class="s1">= </span><span class="s2">nodes</span><span class="s1">.</span><span class="s2">map</span><span class="s1">(</span><span class="s2">n </span><span class="s1">=&gt; </span><span class="s2">n</span><span class="s1">.</span><span class="s2">str</span><span class="s1">);</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">hasItemWithNewLine </span><span class="s1">|| </span><span class="s2">strings</span><span class="s1">.</span><span class="s2">reduce</span><span class="s1">((</span><span class="s2">sum</span><span class="s1">, </span><span class="s2">str</span><span class="s1">) =&gt; </span><span class="s2">sum </span><span class="s1">+ </span><span class="s2">str</span><span class="s1">.</span><span class="s2">length </span><span class="s1">+ </span><span class="s5">2</span><span class="s1">, </span><span class="s5">2</span><span class="s1">) &gt; </span><span class="s2">Collection</span><span class="s1">.</span><span class="s2">maxFlowStringSingleLineLength</span><span class="s1">) {</span>
        <span class="s2">str </span><span class="s1">= </span><span class="s2">start</span><span class="s1">;</span>

        <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">s of strings</span><span class="s1">) {</span>
          <span class="s2">str </span><span class="s1">+= </span><span class="s2">s </span><span class="s1">? </span><span class="s0">`</span><span class="s3">\n</span><span class="s2">$</span><span class="s1">{</span><span class="s2">indentStep</span><span class="s1">}</span><span class="s2">$</span><span class="s1">{</span><span class="s2">indent</span><span class="s1">}</span><span class="s2">$</span><span class="s1">{</span><span class="s2">s</span><span class="s1">}</span><span class="s0">` </span><span class="s1">: </span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s2">str </span><span class="s1">+= </span><span class="s0">`</span><span class="s3">\n</span><span class="s2">$</span><span class="s1">{</span><span class="s2">indent</span><span class="s1">}</span><span class="s2">$</span><span class="s1">{</span><span class="s2">end</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s2">str </span><span class="s1">= </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">start</span><span class="s1">} </span><span class="s2">$</span><span class="s1">{</span><span class="s2">strings</span><span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s0">' '</span><span class="s1">)} </span><span class="s2">$</span><span class="s1">{</span><span class="s2">end</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">const </span><span class="s2">strings </span><span class="s1">= </span><span class="s2">nodes</span><span class="s1">.</span><span class="s2">map</span><span class="s1">(</span><span class="s2">blockItem</span><span class="s1">);</span>
      <span class="s2">str </span><span class="s1">= </span><span class="s2">strings</span><span class="s1">.</span><span class="s2">shift</span><span class="s1">();</span>

      <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">s of strings</span><span class="s1">) </span><span class="s2">str </span><span class="s1">+= </span><span class="s2">s </span><span class="s1">? </span><span class="s0">`</span><span class="s3">\n</span><span class="s2">$</span><span class="s1">{</span><span class="s2">indent</span><span class="s1">}</span><span class="s2">$</span><span class="s1">{</span><span class="s2">s</span><span class="s1">}</span><span class="s0">` </span><span class="s1">: </span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">comment</span><span class="s1">) {</span>
      <span class="s2">str </span><span class="s1">+= </span><span class="s0">'</span><span class="s3">\n</span><span class="s0">' </span><span class="s1">+ </span><span class="s3">this</span><span class="s1">.</span><span class="s2">comment</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s4">/^/gm</span><span class="s1">, </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">indent</span><span class="s1">}</span><span class="s0">#`</span><span class="s1">);</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">onComment</span><span class="s1">) </span><span class="s2">onComment</span><span class="s1">();</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">chompKeep </span><span class="s1">&amp;&amp; </span><span class="s2">onChompKeep</span><span class="s1">) </span><span class="s2">onChompKeep</span><span class="s1">();</span>

    <span class="s3">return </span><span class="s2">str</span><span class="s1">;</span>
  <span class="s1">}</span>

<span class="s1">}</span>

<span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">_defineProperty</span><span class="s1">(</span><span class="s2">Collection</span><span class="s1">, </span><span class="s0">&quot;maxFlowStringSingleLineLength&quot;</span><span class="s1">, </span><span class="s5">60</span><span class="s1">);</span>

<span class="s3">function </span><span class="s2">asItemIndex</span><span class="s1">(</span><span class="s2">key</span><span class="s1">) {</span>
  <span class="s3">let </span><span class="s2">idx </span><span class="s1">= </span><span class="s2">key </span><span class="s3">instanceof </span><span class="s2">Scalar </span><span class="s1">? </span><span class="s2">key</span><span class="s1">.</span><span class="s2">value </span><span class="s1">: </span><span class="s2">key</span><span class="s1">;</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">idx </span><span class="s1">&amp;&amp; </span><span class="s3">typeof </span><span class="s2">idx </span><span class="s1">=== </span><span class="s0">'string'</span><span class="s1">) </span><span class="s2">idx </span><span class="s1">= </span><span class="s2">Number</span><span class="s1">(</span><span class="s2">idx</span><span class="s1">);</span>
  <span class="s3">return </span><span class="s2">Number</span><span class="s1">.</span><span class="s2">isInteger</span><span class="s1">(</span><span class="s2">idx</span><span class="s1">) &amp;&amp; </span><span class="s2">idx </span><span class="s1">&gt;= </span><span class="s5">0 </span><span class="s1">? </span><span class="s2">idx </span><span class="s1">: </span><span class="s3">null</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">class </span><span class="s2">YAMLSeq </span><span class="s3">extends </span><span class="s2">Collection </span><span class="s1">{</span>
  <span class="s2">add</span><span class="s1">(</span><span class="s2">value</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">items</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">delete</span><span class="s1">(</span><span class="s2">key</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">idx </span><span class="s1">= </span><span class="s2">asItemIndex</span><span class="s1">(</span><span class="s2">key</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">idx </span><span class="s1">!== </span><span class="s0">'number'</span><span class="s1">) </span><span class="s3">return false</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">del </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">items</span><span class="s1">.</span><span class="s2">splice</span><span class="s1">(</span><span class="s2">idx</span><span class="s1">, </span><span class="s5">1</span><span class="s1">);</span>
    <span class="s3">return </span><span class="s2">del</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s5">0</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">get</span><span class="s1">(</span><span class="s2">key</span><span class="s1">, </span><span class="s2">keepScalar</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">idx </span><span class="s1">= </span><span class="s2">asItemIndex</span><span class="s1">(</span><span class="s2">key</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">idx </span><span class="s1">!== </span><span class="s0">'number'</span><span class="s1">) </span><span class="s3">return </span><span class="s2">undefined</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">it </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">items</span><span class="s1">[</span><span class="s2">idx</span><span class="s1">];</span>
    <span class="s3">return </span><span class="s1">!</span><span class="s2">keepScalar </span><span class="s1">&amp;&amp; </span><span class="s2">it </span><span class="s3">instanceof </span><span class="s2">Scalar </span><span class="s1">? </span><span class="s2">it</span><span class="s1">.</span><span class="s2">value </span><span class="s1">: </span><span class="s2">it</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">has</span><span class="s1">(</span><span class="s2">key</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">idx </span><span class="s1">= </span><span class="s2">asItemIndex</span><span class="s1">(</span><span class="s2">key</span><span class="s1">);</span>
    <span class="s3">return typeof </span><span class="s2">idx </span><span class="s1">=== </span><span class="s0">'number' </span><span class="s1">&amp;&amp; </span><span class="s2">idx </span><span class="s1">&lt; </span><span class="s3">this</span><span class="s1">.</span><span class="s2">items</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">set</span><span class="s1">(</span><span class="s2">key</span><span class="s1">, </span><span class="s2">value</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">idx </span><span class="s1">= </span><span class="s2">asItemIndex</span><span class="s1">(</span><span class="s2">key</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">idx </span><span class="s1">!== </span><span class="s0">'number'</span><span class="s1">) </span><span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">`Expected a valid index, not </span><span class="s2">$</span><span class="s1">{</span><span class="s2">key</span><span class="s1">}</span><span class="s0">.`</span><span class="s1">);</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">items</span><span class="s1">[</span><span class="s2">idx</span><span class="s1">] = </span><span class="s2">value</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">toJSON</span><span class="s1">(</span><span class="s2">_</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">seq </span><span class="s1">= [];</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">ctx </span><span class="s1">&amp;&amp; </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">onCreate</span><span class="s1">) </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">onCreate</span><span class="s1">(</span><span class="s2">seq</span><span class="s1">);</span>
    <span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>

    <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">item of </span><span class="s3">this</span><span class="s1">.</span><span class="s2">items</span><span class="s1">) </span><span class="s2">seq</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">toJSON</span><span class="s1">(</span><span class="s2">item</span><span class="s1">, </span><span class="s2">String</span><span class="s1">(</span><span class="s2">i</span><span class="s1">++), </span><span class="s2">ctx</span><span class="s1">));</span>

    <span class="s3">return </span><span class="s2">seq</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">toString</span><span class="s1">(</span><span class="s2">ctx</span><span class="s1">, </span><span class="s2">onComment</span><span class="s1">, </span><span class="s2">onChompKeep</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">ctx</span><span class="s1">) </span><span class="s3">return </span><span class="s2">JSON</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">(</span><span class="s3">this</span><span class="s1">);</span>
    <span class="s3">return super</span><span class="s1">.</span><span class="s2">toString</span><span class="s1">(</span><span class="s2">ctx</span><span class="s1">, {</span>
      <span class="s2">blockItem</span><span class="s1">: </span><span class="s2">n </span><span class="s1">=&gt; </span><span class="s2">n</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">'comment' </span><span class="s1">? </span><span class="s2">n</span><span class="s1">.</span><span class="s2">str </span><span class="s1">: </span><span class="s0">`- </span><span class="s2">$</span><span class="s1">{</span><span class="s2">n</span><span class="s1">.</span><span class="s2">str</span><span class="s1">}</span><span class="s0">`</span><span class="s1">,</span>
      <span class="s2">flowChars</span><span class="s1">: {</span>
        <span class="s2">start</span><span class="s1">: </span><span class="s0">'['</span><span class="s1">,</span>
        <span class="s2">end</span><span class="s1">: </span><span class="s0">']'</span>
      <span class="s1">},</span>
      <span class="s2">isMap</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
      <span class="s2">itemIndent</span><span class="s1">: (</span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">indent </span><span class="s1">|| </span><span class="s0">''</span><span class="s1">) + </span><span class="s0">'  '</span>
    <span class="s1">}, </span><span class="s2">onComment</span><span class="s1">, </span><span class="s2">onChompKeep</span><span class="s1">);</span>
  <span class="s1">}</span>

<span class="s1">}</span>

<span class="s3">const </span><span class="s2">stringifyKey </span><span class="s1">= (</span><span class="s2">key</span><span class="s1">, </span><span class="s2">jsKey</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">) =&gt; {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">jsKey </span><span class="s1">=== </span><span class="s3">null</span><span class="s1">) </span><span class="s3">return </span><span class="s0">''</span><span class="s1">;</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">jsKey </span><span class="s1">!== </span><span class="s0">'object'</span><span class="s1">) </span><span class="s3">return </span><span class="s2">String</span><span class="s1">(</span><span class="s2">jsKey</span><span class="s1">);</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">key </span><span class="s3">instanceof </span><span class="s2">Node </span><span class="s1">&amp;&amp; </span><span class="s2">ctx </span><span class="s1">&amp;&amp; </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">doc</span><span class="s1">) </span><span class="s3">return </span><span class="s2">key</span><span class="s1">.</span><span class="s2">toString</span><span class="s1">({</span>
    <span class="s2">anchors</span><span class="s1">: </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s3">null</span><span class="s1">),</span>
    <span class="s2">doc</span><span class="s1">: </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">doc</span><span class="s1">,</span>
    <span class="s2">indent</span><span class="s1">: </span><span class="s0">''</span><span class="s1">,</span>
    <span class="s2">indentStep</span><span class="s1">: </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">indentStep</span><span class="s1">,</span>
    <span class="s2">inFlow</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
    <span class="s2">inStringifyKey</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
    <span class="s2">stringify</span><span class="s1">: </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">stringify</span>
  <span class="s1">});</span>
  <span class="s3">return </span><span class="s2">JSON</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">(</span><span class="s2">jsKey</span><span class="s1">);</span>
<span class="s1">};</span>

<span class="s3">class </span><span class="s2">Pair </span><span class="s3">extends </span><span class="s2">Node </span><span class="s1">{</span>
  <span class="s2">constructor</span><span class="s1">(</span><span class="s2">key</span><span class="s1">, </span><span class="s2">value </span><span class="s1">= </span><span class="s3">null</span><span class="s1">) {</span>
    <span class="s3">super</span><span class="s1">();</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">key </span><span class="s1">= </span><span class="s2">key</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">value </span><span class="s1">= </span><span class="s2">value</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">type </span><span class="s1">= </span><span class="s2">Pair</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">PAIR</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">get commentBefore</span><span class="s1">() {</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">key </span><span class="s3">instanceof </span><span class="s2">Node </span><span class="s1">? </span><span class="s3">this</span><span class="s1">.</span><span class="s2">key</span><span class="s1">.</span><span class="s2">commentBefore </span><span class="s1">: </span><span class="s2">undefined</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">set commentBefore</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">key </span><span class="s1">== </span><span class="s3">null</span><span class="s1">) </span><span class="s3">this</span><span class="s1">.</span><span class="s2">key </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Scalar</span><span class="s1">(</span><span class="s3">null</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">key </span><span class="s3">instanceof </span><span class="s2">Node</span><span class="s1">) </span><span class="s3">this</span><span class="s1">.</span><span class="s2">key</span><span class="s1">.</span><span class="s2">commentBefore </span><span class="s1">= </span><span class="s2">cb</span><span class="s1">;</span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">'Pair.commentBefore is an alias for Pair.key.commentBefore. To set it, the key must be a Node.'</span><span class="s1">;</span>
      <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s2">msg</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">addToJSMap</span><span class="s1">(</span><span class="s2">ctx</span><span class="s1">, </span><span class="s2">map</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">key </span><span class="s1">= </span><span class="s2">toJSON</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">key</span><span class="s1">, </span><span class="s0">''</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">map </span><span class="s3">instanceof </span><span class="s2">Map</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">value </span><span class="s1">= </span><span class="s2">toJSON</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">value</span><span class="s1">, </span><span class="s2">key</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">);</span>
      <span class="s2">map</span><span class="s1">.</span><span class="s2">set</span><span class="s1">(</span><span class="s2">key</span><span class="s1">, </span><span class="s2">value</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">map </span><span class="s3">instanceof </span><span class="s2">Set</span><span class="s1">) {</span>
      <span class="s2">map</span><span class="s1">.</span><span class="s2">add</span><span class="s1">(</span><span class="s2">key</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">const </span><span class="s2">stringKey </span><span class="s1">= </span><span class="s2">stringifyKey</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">key</span><span class="s1">, </span><span class="s2">key</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">);</span>
      <span class="s3">const </span><span class="s2">value </span><span class="s1">= </span><span class="s2">toJSON</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">value</span><span class="s1">, </span><span class="s2">stringKey</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">);</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">stringKey </span><span class="s3">in </span><span class="s2">map</span><span class="s1">) </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">map</span><span class="s1">, </span><span class="s2">stringKey</span><span class="s1">, {</span>
        <span class="s2">value</span><span class="s1">,</span>
        <span class="s2">writable</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
        <span class="s2">enumerable</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
        <span class="s2">configurable</span><span class="s1">: </span><span class="s3">true</span>
      <span class="s1">});</span><span class="s3">else </span><span class="s2">map</span><span class="s1">[</span><span class="s2">stringKey</span><span class="s1">] = </span><span class="s2">value</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s2">map</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">toJSON</span><span class="s1">(</span><span class="s2">_</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">pair </span><span class="s1">= </span><span class="s2">ctx </span><span class="s1">&amp;&amp; </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">mapAsMap </span><span class="s1">? </span><span class="s3">new </span><span class="s2">Map</span><span class="s1">() : {};</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">addToJSMap</span><span class="s1">(</span><span class="s2">ctx</span><span class="s1">, </span><span class="s2">pair</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">toString</span><span class="s1">(</span><span class="s2">ctx</span><span class="s1">, </span><span class="s2">onComment</span><span class="s1">, </span><span class="s2">onChompKeep</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">ctx </span><span class="s1">|| !</span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">doc</span><span class="s1">) </span><span class="s3">return </span><span class="s2">JSON</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">(</span><span class="s3">this</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s1">{</span>
      <span class="s2">indent</span><span class="s1">: </span><span class="s2">indentSize</span><span class="s1">,</span>
      <span class="s2">indentSeq</span><span class="s1">,</span>
      <span class="s2">simpleKeys</span>
    <span class="s1">} = </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">doc</span><span class="s1">.</span><span class="s2">options</span><span class="s1">;</span>
    <span class="s3">let </span><span class="s1">{</span>
      <span class="s2">key</span><span class="s1">,</span>
      <span class="s2">value</span>
    <span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
    <span class="s3">let </span><span class="s2">keyComment </span><span class="s1">= </span><span class="s2">key </span><span class="s3">instanceof </span><span class="s2">Node </span><span class="s1">&amp;&amp; </span><span class="s2">key</span><span class="s1">.</span><span class="s2">comment</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">simpleKeys</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">keyComment</span><span class="s1">) {</span>
        <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'With simple keys, key nodes cannot have comments'</span><span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">key </span><span class="s3">instanceof </span><span class="s2">Collection</span><span class="s1">) {</span>
        <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">'With simple keys, collection cannot be used as a key value'</span><span class="s1">;</span>
        <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s2">msg</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s3">let </span><span class="s2">explicitKey </span><span class="s1">= !</span><span class="s2">simpleKeys </span><span class="s1">&amp;&amp; (!</span><span class="s2">key </span><span class="s1">|| </span><span class="s2">keyComment </span><span class="s1">|| (</span><span class="s2">key </span><span class="s3">instanceof </span><span class="s2">Node </span><span class="s1">? </span><span class="s2">key </span><span class="s3">instanceof </span><span class="s2">Collection </span><span class="s1">|| </span><span class="s2">key</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">BLOCK_FOLDED </span><span class="s1">|| </span><span class="s2">key</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">BLOCK_LITERAL </span><span class="s1">: </span><span class="s3">typeof </span><span class="s2">key </span><span class="s1">=== </span><span class="s0">'object'</span><span class="s1">));</span>
    <span class="s3">const </span><span class="s1">{</span>
      <span class="s2">doc</span><span class="s1">,</span>
      <span class="s2">indent</span><span class="s1">,</span>
      <span class="s2">indentStep</span><span class="s1">,</span>
      <span class="s2">stringify</span>
    <span class="s1">} = </span><span class="s2">ctx</span><span class="s1">;</span>
    <span class="s2">ctx </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">assign</span><span class="s1">({}, </span><span class="s2">ctx</span><span class="s1">, {</span>
      <span class="s2">implicitKey</span><span class="s1">: !</span><span class="s2">explicitKey</span><span class="s1">,</span>
      <span class="s2">indent</span><span class="s1">: </span><span class="s2">indent </span><span class="s1">+ </span><span class="s2">indentStep</span>
    <span class="s1">});</span>
    <span class="s3">let </span><span class="s2">chompKeep </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s3">let </span><span class="s2">str </span><span class="s1">= </span><span class="s2">stringify</span><span class="s1">(</span><span class="s2">key</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">, () =&gt; </span><span class="s2">keyComment </span><span class="s1">= </span><span class="s3">null</span><span class="s1">, () =&gt; </span><span class="s2">chompKeep </span><span class="s1">= </span><span class="s3">true</span><span class="s1">);</span>
    <span class="s2">str </span><span class="s1">= </span><span class="s2">addComment</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">indent</span><span class="s1">, </span><span class="s2">keyComment</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(!</span><span class="s2">explicitKey </span><span class="s1">&amp;&amp; </span><span class="s2">str</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s5">1024</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">simpleKeys</span><span class="s1">) </span><span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'With simple keys, single line scalar must not span more than 1024 characters'</span><span class="s1">);</span>
      <span class="s2">explicitKey </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">allNullValues </span><span class="s1">&amp;&amp; !</span><span class="s2">simpleKeys</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">comment</span><span class="s1">) {</span>
        <span class="s2">str </span><span class="s1">= </span><span class="s2">addComment</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">indent</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">comment</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">onComment</span><span class="s1">) </span><span class="s2">onComment</span><span class="s1">();</span>
      <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">chompKeep </span><span class="s1">&amp;&amp; !</span><span class="s2">keyComment </span><span class="s1">&amp;&amp; </span><span class="s2">onChompKeep</span><span class="s1">) </span><span class="s2">onChompKeep</span><span class="s1">();</span>

      <span class="s3">return </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">inFlow </span><span class="s1">&amp;&amp; !</span><span class="s2">explicitKey </span><span class="s1">? </span><span class="s2">str </span><span class="s1">: </span><span class="s0">`? </span><span class="s2">$</span><span class="s1">{</span><span class="s2">str</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">str </span><span class="s1">= </span><span class="s2">explicitKey </span><span class="s1">? </span><span class="s0">`? </span><span class="s2">$</span><span class="s1">{</span><span class="s2">str</span><span class="s1">}</span><span class="s3">\n</span><span class="s2">$</span><span class="s1">{</span><span class="s2">indent</span><span class="s1">}</span><span class="s0">:` </span><span class="s1">: </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">str</span><span class="s1">}</span><span class="s0">:`</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">comment</span><span class="s1">) {</span>
      <span class="s6">// expected (but not strictly required) to be a single-line comment</span>
      <span class="s2">str </span><span class="s1">= </span><span class="s2">addComment</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">indent</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">comment</span><span class="s1">);</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">onComment</span><span class="s1">) </span><span class="s2">onComment</span><span class="s1">();</span>
    <span class="s1">}</span>

    <span class="s3">let </span><span class="s2">vcb </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
    <span class="s3">let </span><span class="s2">valueComment </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">value </span><span class="s3">instanceof </span><span class="s2">Node</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">value</span><span class="s1">.</span><span class="s2">spaceBefore</span><span class="s1">) </span><span class="s2">vcb </span><span class="s1">= </span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">;</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">value</span><span class="s1">.</span><span class="s2">commentBefore</span><span class="s1">) {</span>
        <span class="s3">const </span><span class="s2">cs </span><span class="s1">= </span><span class="s2">value</span><span class="s1">.</span><span class="s2">commentBefore</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s4">/^/gm</span><span class="s1">, </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">indent</span><span class="s1">}</span><span class="s0">#`</span><span class="s1">);</span>
        <span class="s2">vcb </span><span class="s1">+= </span><span class="s0">`</span><span class="s3">\n</span><span class="s2">$</span><span class="s1">{</span><span class="s2">cs</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s2">valueComment </span><span class="s1">= </span><span class="s2">value</span><span class="s1">.</span><span class="s2">comment</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">value </span><span class="s1">&amp;&amp; </span><span class="s3">typeof </span><span class="s2">value </span><span class="s1">=== </span><span class="s0">'object'</span><span class="s1">) {</span>
      <span class="s2">value </span><span class="s1">= </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">.</span><span class="s2">createNode</span><span class="s1">(</span><span class="s2">value</span><span class="s1">, </span><span class="s3">true</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s2">ctx</span><span class="s1">.</span><span class="s2">implicitKey </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">explicitKey </span><span class="s1">&amp;&amp; !</span><span class="s3">this</span><span class="s1">.</span><span class="s2">comment </span><span class="s1">&amp;&amp; </span><span class="s2">value </span><span class="s3">instanceof </span><span class="s2">Scalar</span><span class="s1">) </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">indentAtStart </span><span class="s1">= </span><span class="s2">str</span><span class="s1">.</span><span class="s2">length </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">;</span>
    <span class="s2">chompKeep </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(!</span><span class="s2">indentSeq </span><span class="s1">&amp;&amp; </span><span class="s2">indentSize </span><span class="s1">&gt;= </span><span class="s5">2 </span><span class="s1">&amp;&amp; !</span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">inFlow </span><span class="s1">&amp;&amp; !</span><span class="s2">explicitKey </span><span class="s1">&amp;&amp; </span><span class="s2">value </span><span class="s3">instanceof </span><span class="s2">YAMLSeq </span><span class="s1">&amp;&amp; </span><span class="s2">value</span><span class="s1">.</span><span class="s2">type </span><span class="s1">!== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">FLOW_SEQ </span><span class="s1">&amp;&amp; !</span><span class="s2">value</span><span class="s1">.</span><span class="s2">tag </span><span class="s1">&amp;&amp; !</span><span class="s2">doc</span><span class="s1">.</span><span class="s2">anchors</span><span class="s1">.</span><span class="s2">getName</span><span class="s1">(</span><span class="s2">value</span><span class="s1">)) {</span>
      <span class="s6">// If indentSeq === false, consider '- ' as part of indentation where possible</span>
      <span class="s2">ctx</span><span class="s1">.</span><span class="s2">indent </span><span class="s1">= </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">indent</span><span class="s1">.</span><span class="s2">substr</span><span class="s1">(</span><span class="s5">2</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">const </span><span class="s2">valueStr </span><span class="s1">= </span><span class="s2">stringify</span><span class="s1">(</span><span class="s2">value</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">, () =&gt; </span><span class="s2">valueComment </span><span class="s1">= </span><span class="s3">null</span><span class="s1">, () =&gt; </span><span class="s2">chompKeep </span><span class="s1">= </span><span class="s3">true</span><span class="s1">);</span>
    <span class="s3">let </span><span class="s2">ws </span><span class="s1">= </span><span class="s0">' '</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">vcb </span><span class="s1">|| </span><span class="s3">this</span><span class="s1">.</span><span class="s2">comment</span><span class="s1">) {</span>
      <span class="s2">ws </span><span class="s1">= </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">vcb</span><span class="s1">}</span><span class="s3">\n</span><span class="s2">$</span><span class="s1">{</span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">indent</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(!</span><span class="s2">explicitKey </span><span class="s1">&amp;&amp; </span><span class="s2">value </span><span class="s3">instanceof </span><span class="s2">Collection</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">flow </span><span class="s1">= </span><span class="s2">valueStr</span><span class="s1">[</span><span class="s5">0</span><span class="s1">] === </span><span class="s0">'[' </span><span class="s1">|| </span><span class="s2">valueStr</span><span class="s1">[</span><span class="s5">0</span><span class="s1">] === </span><span class="s0">'{'</span><span class="s1">;</span>
      <span class="s3">if </span><span class="s1">(!</span><span class="s2">flow </span><span class="s1">|| </span><span class="s2">valueStr</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">)) </span><span class="s2">ws </span><span class="s1">= </span><span class="s0">`</span><span class="s3">\n</span><span class="s2">$</span><span class="s1">{</span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">indent</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">valueStr</span><span class="s1">[</span><span class="s5">0</span><span class="s1">] === </span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">) </span><span class="s2">ws </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">chompKeep </span><span class="s1">&amp;&amp; !</span><span class="s2">valueComment </span><span class="s1">&amp;&amp; </span><span class="s2">onChompKeep</span><span class="s1">) </span><span class="s2">onChompKeep</span><span class="s1">();</span>
    <span class="s3">return </span><span class="s2">addComment</span><span class="s1">(</span><span class="s2">str </span><span class="s1">+ </span><span class="s2">ws </span><span class="s1">+ </span><span class="s2">valueStr</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">indent</span><span class="s1">, </span><span class="s2">valueComment</span><span class="s1">);</span>
  <span class="s1">}</span>

<span class="s1">}</span>

<span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">_defineProperty</span><span class="s1">(</span><span class="s2">Pair</span><span class="s1">, </span><span class="s0">&quot;Type&quot;</span><span class="s1">, {</span>
  <span class="s2">PAIR</span><span class="s1">: </span><span class="s0">'PAIR'</span><span class="s1">,</span>
  <span class="s2">MERGE_PAIR</span><span class="s1">: </span><span class="s0">'MERGE_PAIR'</span>
<span class="s1">});</span>

<span class="s3">const </span><span class="s2">getAliasCount </span><span class="s1">= (</span><span class="s2">node</span><span class="s1">, </span><span class="s2">anchors</span><span class="s1">) =&gt; {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">node </span><span class="s3">instanceof </span><span class="s2">Alias</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">anchor </span><span class="s1">= </span><span class="s2">anchors</span><span class="s1">.</span><span class="s2">get</span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">source</span><span class="s1">);</span>
    <span class="s3">return </span><span class="s2">anchor</span><span class="s1">.</span><span class="s2">count </span><span class="s1">* </span><span class="s2">anchor</span><span class="s1">.</span><span class="s2">aliasCount</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">node </span><span class="s3">instanceof </span><span class="s2">Collection</span><span class="s1">) {</span>
    <span class="s3">let </span><span class="s2">count </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>

    <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">item of node</span><span class="s1">.</span><span class="s2">items</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">c </span><span class="s1">= </span><span class="s2">getAliasCount</span><span class="s1">(</span><span class="s2">item</span><span class="s1">, </span><span class="s2">anchors</span><span class="s1">);</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">c </span><span class="s1">&gt; </span><span class="s2">count</span><span class="s1">) </span><span class="s2">count </span><span class="s1">= </span><span class="s2">c</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s2">count</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">node </span><span class="s3">instanceof </span><span class="s2">Pair</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">kc </span><span class="s1">= </span><span class="s2">getAliasCount</span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">key</span><span class="s1">, </span><span class="s2">anchors</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">vc </span><span class="s1">= </span><span class="s2">getAliasCount</span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">value</span><span class="s1">, </span><span class="s2">anchors</span><span class="s1">);</span>
    <span class="s3">return </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">max</span><span class="s1">(</span><span class="s2">kc</span><span class="s1">, </span><span class="s2">vc</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s5">1</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s3">class </span><span class="s2">Alias </span><span class="s3">extends </span><span class="s2">Node </span><span class="s1">{</span>
  <span class="s3">static </span><span class="s2">stringify</span><span class="s1">({</span>
    <span class="s2">range</span><span class="s1">,</span>
    <span class="s2">source</span>
  <span class="s1">}, {</span>
    <span class="s2">anchors</span><span class="s1">,</span>
    <span class="s2">doc</span><span class="s1">,</span>
    <span class="s2">implicitKey</span><span class="s1">,</span>
    <span class="s2">inStringifyKey</span>
  <span class="s1">}) {</span>
    <span class="s3">let </span><span class="s2">anchor </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">anchors</span><span class="s1">).</span><span class="s2">find</span><span class="s1">(</span><span class="s2">a </span><span class="s1">=&gt; </span><span class="s2">anchors</span><span class="s1">[</span><span class="s2">a</span><span class="s1">] === </span><span class="s2">source</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">anchor </span><span class="s1">&amp;&amp; </span><span class="s2">inStringifyKey</span><span class="s1">) </span><span class="s2">anchor </span><span class="s1">= </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">anchors</span><span class="s1">.</span><span class="s2">getName</span><span class="s1">(</span><span class="s2">source</span><span class="s1">) || </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">anchors</span><span class="s1">.</span><span class="s2">newName</span><span class="s1">();</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">anchor</span><span class="s1">) </span><span class="s3">return </span><span class="s0">`*</span><span class="s2">$</span><span class="s1">{</span><span class="s2">anchor</span><span class="s1">}</span><span class="s2">$</span><span class="s1">{</span><span class="s2">implicitKey </span><span class="s1">? </span><span class="s0">' ' </span><span class="s1">: </span><span class="s0">''</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">anchors</span><span class="s1">.</span><span class="s2">getName</span><span class="s1">(</span><span class="s2">source</span><span class="s1">) ? </span><span class="s0">'Alias node must be after source node' </span><span class="s1">: </span><span class="s0">'Source node not found for alias node'</span><span class="s1">;</span>
    <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">msg</span><span class="s1">} </span><span class="s0">[</span><span class="s2">$</span><span class="s1">{</span><span class="s2">range</span><span class="s1">}</span><span class="s0">]`</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">constructor</span><span class="s1">(</span><span class="s2">source</span><span class="s1">) {</span>
    <span class="s3">super</span><span class="s1">();</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">source </span><span class="s1">= </span><span class="s2">source</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">type </span><span class="s1">= </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">ALIAS</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">set tag</span><span class="s1">(</span><span class="s2">t</span><span class="s1">) {</span>
    <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'Alias nodes cannot have tags'</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">toJSON</span><span class="s1">(</span><span class="s2">arg</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">ctx</span><span class="s1">) </span><span class="s3">return </span><span class="s2">toJSON</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">source</span><span class="s1">, </span><span class="s2">arg</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s1">{</span>
      <span class="s2">anchors</span><span class="s1">,</span>
      <span class="s2">maxAliasCount</span>
    <span class="s1">} = </span><span class="s2">ctx</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">anchor </span><span class="s1">= </span><span class="s2">anchors</span><span class="s1">.</span><span class="s2">get</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">source</span><span class="s1">);</span>
    <span class="s6">/* istanbul ignore if */</span>

    <span class="s3">if </span><span class="s1">(!</span><span class="s2">anchor </span><span class="s1">|| </span><span class="s2">anchor</span><span class="s1">.</span><span class="s2">res </span><span class="s1">=== </span><span class="s2">undefined</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">'This should not happen: Alias anchor was not resolved?'</span><span class="s1">;</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">cstNode</span><span class="s1">) </span><span class="s3">throw new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLReferenceError</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">cstNode</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">);</span><span class="s3">else throw new </span><span class="s2">ReferenceError</span><span class="s1">(</span><span class="s2">msg</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">maxAliasCount </span><span class="s1">&gt;= </span><span class="s5">0</span><span class="s1">) {</span>
      <span class="s2">anchor</span><span class="s1">.</span><span class="s2">count </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">;</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">anchor</span><span class="s1">.</span><span class="s2">aliasCount </span><span class="s1">=== </span><span class="s5">0</span><span class="s1">) </span><span class="s2">anchor</span><span class="s1">.</span><span class="s2">aliasCount </span><span class="s1">= </span><span class="s2">getAliasCount</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">source</span><span class="s1">, </span><span class="s2">anchors</span><span class="s1">);</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">anchor</span><span class="s1">.</span><span class="s2">count </span><span class="s1">* </span><span class="s2">anchor</span><span class="s1">.</span><span class="s2">aliasCount </span><span class="s1">&gt; </span><span class="s2">maxAliasCount</span><span class="s1">) {</span>
        <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">'Excessive alias count indicates a resource exhaustion attack'</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">cstNode</span><span class="s1">) </span><span class="s3">throw new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLReferenceError</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">cstNode</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">);</span><span class="s3">else throw new </span><span class="s2">ReferenceError</span><span class="s1">(</span><span class="s2">msg</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s2">anchor</span><span class="s1">.</span><span class="s2">res</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s6">// Only called when stringifying an alias mapping key while constructing</span>
  <span class="s6">// Object output.</span>


  <span class="s2">toString</span><span class="s1">(</span><span class="s2">ctx</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s2">Alias</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">);</span>
  <span class="s1">}</span>

<span class="s1">}</span>

<span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">_defineProperty</span><span class="s1">(</span><span class="s2">Alias</span><span class="s1">, </span><span class="s0">&quot;default&quot;</span><span class="s1">, </span><span class="s3">true</span><span class="s1">);</span>

<span class="s3">function </span><span class="s2">findPair</span><span class="s1">(</span><span class="s2">items</span><span class="s1">, </span><span class="s2">key</span><span class="s1">) {</span>
  <span class="s3">const </span><span class="s2">k </span><span class="s1">= </span><span class="s2">key </span><span class="s3">instanceof </span><span class="s2">Scalar </span><span class="s1">? </span><span class="s2">key</span><span class="s1">.</span><span class="s2">value </span><span class="s1">: </span><span class="s2">key</span><span class="s1">;</span>

  <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">it of items</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">it </span><span class="s3">instanceof </span><span class="s2">Pair</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">it</span><span class="s1">.</span><span class="s2">key </span><span class="s1">=== </span><span class="s2">key </span><span class="s1">|| </span><span class="s2">it</span><span class="s1">.</span><span class="s2">key </span><span class="s1">=== </span><span class="s2">k</span><span class="s1">) </span><span class="s3">return </span><span class="s2">it</span><span class="s1">;</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">it</span><span class="s1">.</span><span class="s2">key </span><span class="s1">&amp;&amp; </span><span class="s2">it</span><span class="s1">.</span><span class="s2">key</span><span class="s1">.</span><span class="s2">value </span><span class="s1">=== </span><span class="s2">k</span><span class="s1">) </span><span class="s3">return </span><span class="s2">it</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s2">undefined</span><span class="s1">;</span>
<span class="s1">}</span>
<span class="s3">class </span><span class="s2">YAMLMap </span><span class="s3">extends </span><span class="s2">Collection </span><span class="s1">{</span>
  <span class="s2">add</span><span class="s1">(</span><span class="s2">pair</span><span class="s1">, </span><span class="s2">overwrite</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">pair</span><span class="s1">) </span><span class="s2">pair </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Pair</span><span class="s1">(</span><span class="s2">pair</span><span class="s1">);</span><span class="s3">else if </span><span class="s1">(!(</span><span class="s2">pair </span><span class="s3">instanceof </span><span class="s2">Pair</span><span class="s1">)) </span><span class="s2">pair </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Pair</span><span class="s1">(</span><span class="s2">pair</span><span class="s1">.</span><span class="s2">key </span><span class="s1">|| </span><span class="s2">pair</span><span class="s1">, </span><span class="s2">pair</span><span class="s1">.</span><span class="s2">value</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">prev </span><span class="s1">= </span><span class="s2">findPair</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">items</span><span class="s1">, </span><span class="s2">pair</span><span class="s1">.</span><span class="s2">key</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">sortEntries </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">schema </span><span class="s1">&amp;&amp; </span><span class="s3">this</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">.</span><span class="s2">sortMapEntries</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">prev</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">overwrite</span><span class="s1">) </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">value </span><span class="s1">= </span><span class="s2">pair</span><span class="s1">.</span><span class="s2">value</span><span class="s1">;</span><span class="s3">else throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">`Key </span><span class="s2">$</span><span class="s1">{</span><span class="s2">pair</span><span class="s1">.</span><span class="s2">key</span><span class="s1">} </span><span class="s0">already set`</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">sortEntries</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">i </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">items</span><span class="s1">.</span><span class="s2">findIndex</span><span class="s1">(</span><span class="s2">item </span><span class="s1">=&gt; </span><span class="s2">sortEntries</span><span class="s1">(</span><span class="s2">pair</span><span class="s1">, </span><span class="s2">item</span><span class="s1">) &lt; </span><span class="s5">0</span><span class="s1">);</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">i </span><span class="s1">=== -</span><span class="s5">1</span><span class="s1">) </span><span class="s3">this</span><span class="s1">.</span><span class="s2">items</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">pair</span><span class="s1">);</span><span class="s3">else this</span><span class="s1">.</span><span class="s2">items</span><span class="s1">.</span><span class="s2">splice</span><span class="s1">(</span><span class="s2">i</span><span class="s1">, </span><span class="s5">0</span><span class="s1">, </span><span class="s2">pair</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">items</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">pair</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">delete</span><span class="s1">(</span><span class="s2">key</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">it </span><span class="s1">= </span><span class="s2">findPair</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">items</span><span class="s1">, </span><span class="s2">key</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">it</span><span class="s1">) </span><span class="s3">return false</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">del </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">items</span><span class="s1">.</span><span class="s2">splice</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">items</span><span class="s1">.</span><span class="s2">indexOf</span><span class="s1">(</span><span class="s2">it</span><span class="s1">), </span><span class="s5">1</span><span class="s1">);</span>
    <span class="s3">return </span><span class="s2">del</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s5">0</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">get</span><span class="s1">(</span><span class="s2">key</span><span class="s1">, </span><span class="s2">keepScalar</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">it </span><span class="s1">= </span><span class="s2">findPair</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">items</span><span class="s1">, </span><span class="s2">key</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">node </span><span class="s1">= </span><span class="s2">it </span><span class="s1">&amp;&amp; </span><span class="s2">it</span><span class="s1">.</span><span class="s2">value</span><span class="s1">;</span>
    <span class="s3">return </span><span class="s1">!</span><span class="s2">keepScalar </span><span class="s1">&amp;&amp; </span><span class="s2">node </span><span class="s3">instanceof </span><span class="s2">Scalar </span><span class="s1">? </span><span class="s2">node</span><span class="s1">.</span><span class="s2">value </span><span class="s1">: </span><span class="s2">node</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">has</span><span class="s1">(</span><span class="s2">key</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s1">!!</span><span class="s2">findPair</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">items</span><span class="s1">, </span><span class="s2">key</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">set</span><span class="s1">(</span><span class="s2">key</span><span class="s1">, </span><span class="s2">value</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">add</span><span class="s1">(</span><span class="s3">new </span><span class="s2">Pair</span><span class="s1">(</span><span class="s2">key</span><span class="s1">, </span><span class="s2">value</span><span class="s1">), </span><span class="s3">true</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s7">/**</span>
   <span class="s7">* </span><span class="s8">@param </span><span class="s7">{*} arg ignored</span>
   <span class="s7">* </span><span class="s8">@param </span><span class="s7">{*} ctx Conversion context, originally set in Document#toJSON()</span>
   <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Class} Type If set, forces the returned collection type</span>
   <span class="s7">* </span><span class="s8">@returns </span><span class="s7">{*} Instance of Type, Map, or Object</span>
   <span class="s7">*/</span>


  <span class="s2">toJSON</span><span class="s1">(</span><span class="s2">_</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">, </span><span class="s2">Type</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">map </span><span class="s1">= </span><span class="s2">Type </span><span class="s1">? </span><span class="s3">new </span><span class="s2">Type</span><span class="s1">() : </span><span class="s2">ctx </span><span class="s1">&amp;&amp; </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">mapAsMap </span><span class="s1">? </span><span class="s3">new </span><span class="s2">Map</span><span class="s1">() : {};</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">ctx </span><span class="s1">&amp;&amp; </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">onCreate</span><span class="s1">) </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">onCreate</span><span class="s1">(</span><span class="s2">map</span><span class="s1">);</span>

    <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">item of </span><span class="s3">this</span><span class="s1">.</span><span class="s2">items</span><span class="s1">) </span><span class="s2">item</span><span class="s1">.</span><span class="s2">addToJSMap</span><span class="s1">(</span><span class="s2">ctx</span><span class="s1">, </span><span class="s2">map</span><span class="s1">);</span>

    <span class="s3">return </span><span class="s2">map</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">toString</span><span class="s1">(</span><span class="s2">ctx</span><span class="s1">, </span><span class="s2">onComment</span><span class="s1">, </span><span class="s2">onChompKeep</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">ctx</span><span class="s1">) </span><span class="s3">return </span><span class="s2">JSON</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">(</span><span class="s3">this</span><span class="s1">);</span>

    <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">item of </span><span class="s3">this</span><span class="s1">.</span><span class="s2">items</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(!(</span><span class="s2">item </span><span class="s3">instanceof </span><span class="s2">Pair</span><span class="s1">)) </span><span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">`Map items must all be pairs; found </span><span class="s2">$</span><span class="s1">{</span><span class="s2">JSON</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">(</span><span class="s2">item</span><span class="s1">)} </span><span class="s0">instead`</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">return super</span><span class="s1">.</span><span class="s2">toString</span><span class="s1">(</span><span class="s2">ctx</span><span class="s1">, {</span>
      <span class="s2">blockItem</span><span class="s1">: </span><span class="s2">n </span><span class="s1">=&gt; </span><span class="s2">n</span><span class="s1">.</span><span class="s2">str</span><span class="s1">,</span>
      <span class="s2">flowChars</span><span class="s1">: {</span>
        <span class="s2">start</span><span class="s1">: </span><span class="s0">'{'</span><span class="s1">,</span>
        <span class="s2">end</span><span class="s1">: </span><span class="s0">'}'</span>
      <span class="s1">},</span>
      <span class="s2">isMap</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
      <span class="s2">itemIndent</span><span class="s1">: </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">indent </span><span class="s1">|| </span><span class="s0">''</span>
    <span class="s1">}, </span><span class="s2">onComment</span><span class="s1">, </span><span class="s2">onChompKeep</span><span class="s1">);</span>
  <span class="s1">}</span>

<span class="s1">}</span>

<span class="s3">const </span><span class="s2">MERGE_KEY </span><span class="s1">= </span><span class="s0">'&lt;&lt;'</span><span class="s1">;</span>
<span class="s3">class </span><span class="s2">Merge </span><span class="s3">extends </span><span class="s2">Pair </span><span class="s1">{</span>
  <span class="s2">constructor</span><span class="s1">(</span><span class="s2">pair</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">pair </span><span class="s3">instanceof </span><span class="s2">Pair</span><span class="s1">) {</span>
      <span class="s3">let </span><span class="s2">seq </span><span class="s1">= </span><span class="s2">pair</span><span class="s1">.</span><span class="s2">value</span><span class="s1">;</span>

      <span class="s3">if </span><span class="s1">(!(</span><span class="s2">seq </span><span class="s3">instanceof </span><span class="s2">YAMLSeq</span><span class="s1">)) {</span>
        <span class="s2">seq </span><span class="s1">= </span><span class="s3">new </span><span class="s2">YAMLSeq</span><span class="s1">();</span>
        <span class="s2">seq</span><span class="s1">.</span><span class="s2">items</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">pair</span><span class="s1">.</span><span class="s2">value</span><span class="s1">);</span>
        <span class="s2">seq</span><span class="s1">.</span><span class="s2">range </span><span class="s1">= </span><span class="s2">pair</span><span class="s1">.</span><span class="s2">value</span><span class="s1">.</span><span class="s2">range</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s3">super</span><span class="s1">(</span><span class="s2">pair</span><span class="s1">.</span><span class="s2">key</span><span class="s1">, </span><span class="s2">seq</span><span class="s1">);</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">range </span><span class="s1">= </span><span class="s2">pair</span><span class="s1">.</span><span class="s2">range</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">super</span><span class="s1">(</span><span class="s3">new </span><span class="s2">Scalar</span><span class="s1">(</span><span class="s2">MERGE_KEY</span><span class="s1">), </span><span class="s3">new </span><span class="s2">YAMLSeq</span><span class="s1">());</span>
    <span class="s1">}</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">type </span><span class="s1">= </span><span class="s2">Pair</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">MERGE_PAIR</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s6">// If the value associated with a merge key is a single mapping node, each of</span>
  <span class="s6">// its key/value pairs is inserted into the current mapping, unless the key</span>
  <span class="s6">// already exists in it. If the value associated with the merge key is a</span>
  <span class="s6">// sequence, then this sequence is expected to contain mapping nodes and each</span>
  <span class="s6">// of these nodes is merged in turn according to its order in the sequence.</span>
  <span class="s6">// Keys in mapping nodes earlier in the sequence override keys specified in</span>
  <span class="s6">// later mapping nodes. -- http://yaml.org/type/merge.html</span>


  <span class="s2">addToJSMap</span><span class="s1">(</span><span class="s2">ctx</span><span class="s1">, </span><span class="s2">map</span><span class="s1">) {</span>
    <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s1">{</span>
      <span class="s2">source</span>
    <span class="s1">} </span><span class="s2">of </span><span class="s3">this</span><span class="s1">.</span><span class="s2">value</span><span class="s1">.</span><span class="s2">items</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(!(</span><span class="s2">source </span><span class="s3">instanceof </span><span class="s2">YAMLMap</span><span class="s1">)) </span><span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'Merge sources must be maps'</span><span class="s1">);</span>
      <span class="s3">const </span><span class="s2">srcMap </span><span class="s1">= </span><span class="s2">source</span><span class="s1">.</span><span class="s2">toJSON</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">, </span><span class="s2">Map</span><span class="s1">);</span>

      <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s1">[</span><span class="s2">key</span><span class="s1">, </span><span class="s2">value</span><span class="s1">] </span><span class="s2">of srcMap</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">map </span><span class="s3">instanceof </span><span class="s2">Map</span><span class="s1">) {</span>
          <span class="s3">if </span><span class="s1">(!</span><span class="s2">map</span><span class="s1">.</span><span class="s2">has</span><span class="s1">(</span><span class="s2">key</span><span class="s1">)) </span><span class="s2">map</span><span class="s1">.</span><span class="s2">set</span><span class="s1">(</span><span class="s2">key</span><span class="s1">, </span><span class="s2">value</span><span class="s1">);</span>
        <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">map </span><span class="s3">instanceof </span><span class="s2">Set</span><span class="s1">) {</span>
          <span class="s2">map</span><span class="s1">.</span><span class="s2">add</span><span class="s1">(</span><span class="s2">key</span><span class="s1">);</span>
        <span class="s1">} </span><span class="s3">else if </span><span class="s1">(!</span><span class="s2">Object</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">hasOwnProperty</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s2">map</span><span class="s1">, </span><span class="s2">key</span><span class="s1">)) {</span>
          <span class="s2">Object</span><span class="s1">.</span><span class="s2">defineProperty</span><span class="s1">(</span><span class="s2">map</span><span class="s1">, </span><span class="s2">key</span><span class="s1">, {</span>
            <span class="s2">value</span><span class="s1">,</span>
            <span class="s2">writable</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
            <span class="s2">enumerable</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
            <span class="s2">configurable</span><span class="s1">: </span><span class="s3">true</span>
          <span class="s1">});</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s2">map</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">toString</span><span class="s1">(</span><span class="s2">ctx</span><span class="s1">, </span><span class="s2">onComment</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">seq </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">value</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">seq</span><span class="s1">.</span><span class="s2">items</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s5">1</span><span class="s1">) </span><span class="s3">return super</span><span class="s1">.</span><span class="s2">toString</span><span class="s1">(</span><span class="s2">ctx</span><span class="s1">, </span><span class="s2">onComment</span><span class="s1">);</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">value </span><span class="s1">= </span><span class="s2">seq</span><span class="s1">.</span><span class="s2">items</span><span class="s1">[</span><span class="s5">0</span><span class="s1">];</span>
    <span class="s3">const </span><span class="s2">str </span><span class="s1">= </span><span class="s3">super</span><span class="s1">.</span><span class="s2">toString</span><span class="s1">(</span><span class="s2">ctx</span><span class="s1">, </span><span class="s2">onComment</span><span class="s1">);</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">value </span><span class="s1">= </span><span class="s2">seq</span><span class="s1">;</span>
    <span class="s3">return </span><span class="s2">str</span><span class="s1">;</span>
  <span class="s1">}</span>

<span class="s1">}</span>

<span class="s3">const </span><span class="s2">binaryOptions </span><span class="s1">= {</span>
  <span class="s2">defaultType</span><span class="s1">: </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">BLOCK_LITERAL</span><span class="s1">,</span>
  <span class="s2">lineWidth</span><span class="s1">: </span><span class="s5">76</span>
<span class="s1">};</span>
<span class="s3">const </span><span class="s2">boolOptions </span><span class="s1">= {</span>
  <span class="s2">trueStr</span><span class="s1">: </span><span class="s0">'true'</span><span class="s1">,</span>
  <span class="s2">falseStr</span><span class="s1">: </span><span class="s0">'false'</span>
<span class="s1">};</span>
<span class="s3">const </span><span class="s2">intOptions </span><span class="s1">= {</span>
  <span class="s2">asBigInt</span><span class="s1">: </span><span class="s3">false</span>
<span class="s1">};</span>
<span class="s3">const </span><span class="s2">nullOptions </span><span class="s1">= {</span>
  <span class="s2">nullStr</span><span class="s1">: </span><span class="s0">'null'</span>
<span class="s1">};</span>
<span class="s3">const </span><span class="s2">strOptions </span><span class="s1">= {</span>
  <span class="s2">defaultType</span><span class="s1">: </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">PLAIN</span><span class="s1">,</span>
  <span class="s2">doubleQuoted</span><span class="s1">: {</span>
    <span class="s2">jsonEncoding</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
    <span class="s2">minMultiLineLength</span><span class="s1">: </span><span class="s5">40</span>
  <span class="s1">},</span>
  <span class="s2">fold</span><span class="s1">: {</span>
    <span class="s2">lineWidth</span><span class="s1">: </span><span class="s5">80</span><span class="s1">,</span>
    <span class="s2">minContentWidth</span><span class="s1">: </span><span class="s5">20</span>
  <span class="s1">}</span>
<span class="s1">};</span>

<span class="s3">function </span><span class="s2">resolveScalar</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">tags</span><span class="s1">, </span><span class="s2">scalarFallback</span><span class="s1">) {</span>
  <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s1">{</span>
    <span class="s2">format</span><span class="s1">,</span>
    <span class="s2">test</span><span class="s1">,</span>
    <span class="s2">resolve</span>
  <span class="s1">} </span><span class="s2">of tags</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">test</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">match </span><span class="s1">= </span><span class="s2">str</span><span class="s1">.</span><span class="s2">match</span><span class="s1">(</span><span class="s2">test</span><span class="s1">);</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">match</span><span class="s1">) {</span>
        <span class="s3">let </span><span class="s2">res </span><span class="s1">= </span><span class="s2">resolve</span><span class="s1">.</span><span class="s2">apply</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s2">match</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(!(</span><span class="s2">res </span><span class="s3">instanceof </span><span class="s2">Scalar</span><span class="s1">)) </span><span class="s2">res </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Scalar</span><span class="s1">(</span><span class="s2">res</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">format</span><span class="s1">) </span><span class="s2">res</span><span class="s1">.</span><span class="s2">format </span><span class="s1">= </span><span class="s2">format</span><span class="s1">;</span>
        <span class="s3">return </span><span class="s2">res</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">scalarFallback</span><span class="s1">) </span><span class="s2">str </span><span class="s1">= </span><span class="s2">scalarFallback</span><span class="s1">(</span><span class="s2">str</span><span class="s1">);</span>
  <span class="s3">return new </span><span class="s2">Scalar</span><span class="s1">(</span><span class="s2">str</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s3">const </span><span class="s2">FOLD_FLOW </span><span class="s1">= </span><span class="s0">'flow'</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">FOLD_BLOCK </span><span class="s1">= </span><span class="s0">'block'</span><span class="s1">;</span>
<span class="s3">const </span><span class="s2">FOLD_QUOTED </span><span class="s1">= </span><span class="s0">'quoted'</span><span class="s1">; </span><span class="s6">// presumes i+1 is at the start of a line</span>
<span class="s6">// returns index of last newline in more-indented block</span>

<span class="s3">const </span><span class="s2">consumeMoreIndentedLines </span><span class="s1">= (</span><span class="s2">text</span><span class="s1">, </span><span class="s2">i</span><span class="s1">) =&gt; {</span>
  <span class="s3">let </span><span class="s2">ch </span><span class="s1">= </span><span class="s2">text</span><span class="s1">[</span><span class="s2">i </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">];</span>

  <span class="s3">while </span><span class="s1">(</span><span class="s2">ch </span><span class="s1">=== </span><span class="s0">' ' </span><span class="s1">|| </span><span class="s2">ch </span><span class="s1">=== </span><span class="s0">'</span><span class="s3">\t</span><span class="s0">'</span><span class="s1">) {</span>
    <span class="s3">do </span><span class="s1">{</span>
      <span class="s2">ch </span><span class="s1">= </span><span class="s2">text</span><span class="s1">[</span><span class="s2">i </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">];</span>
    <span class="s1">} </span><span class="s3">while </span><span class="s1">(</span><span class="s2">ch </span><span class="s1">&amp;&amp; </span><span class="s2">ch </span><span class="s1">!== </span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">);</span>

    <span class="s2">ch </span><span class="s1">= </span><span class="s2">text</span><span class="s1">[</span><span class="s2">i </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">];</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s2">i</span><span class="s1">;</span>
<span class="s1">};</span>
<span class="s7">/**</span>
 <span class="s7">* Tries to keep input at up to `lineWidth` characters, splitting only on spaces</span>
 <span class="s7">* not followed by newlines or spaces unless `mode` is `'quoted'`. Lines are</span>
 <span class="s7">* terminated with `\n` and started with `indent`.</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{string} text</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{string} indent</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{string} [mode='flow'] `'block'` prevents more-indented lines</span>
 <span class="s7">*   from being folded; `'quoted'` allows for `\` escapes, including escaped</span>
 <span class="s7">*   newlines</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{Object} options</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{number} [options.indentAtStart] Accounts for leading contents on</span>
 <span class="s7">*   the first line, defaulting to `indent.length`</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{number} [options.lineWidth=80]</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{number} [options.minContentWidth=20] Allow highly indented lines to</span>
 <span class="s7">*   stretch the line width or indent content from the start</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{function} options.onFold Called once if the text is folded</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{function} options.onFold Called once if any line of text exceeds</span>
 <span class="s7">*   lineWidth characters</span>
 <span class="s7">*/</span>


<span class="s3">function </span><span class="s2">foldFlowLines</span><span class="s1">(</span><span class="s2">text</span><span class="s1">, </span><span class="s2">indent</span><span class="s1">, </span><span class="s2">mode</span><span class="s1">, {</span>
  <span class="s2">indentAtStart</span><span class="s1">,</span>
  <span class="s2">lineWidth </span><span class="s1">= </span><span class="s5">80</span><span class="s1">,</span>
  <span class="s2">minContentWidth </span><span class="s1">= </span><span class="s5">20</span><span class="s1">,</span>
  <span class="s2">onFold</span><span class="s1">,</span>
  <span class="s2">onOverflow</span>
<span class="s1">}) {</span>
  <span class="s3">if </span><span class="s1">(!</span><span class="s2">lineWidth </span><span class="s1">|| </span><span class="s2">lineWidth </span><span class="s1">&lt; </span><span class="s5">0</span><span class="s1">) </span><span class="s3">return </span><span class="s2">text</span><span class="s1">;</span>
  <span class="s3">const </span><span class="s2">endStep </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">max</span><span class="s1">(</span><span class="s5">1 </span><span class="s1">+ </span><span class="s2">minContentWidth</span><span class="s1">, </span><span class="s5">1 </span><span class="s1">+ </span><span class="s2">lineWidth </span><span class="s1">- </span><span class="s2">indent</span><span class="s1">.</span><span class="s2">length</span><span class="s1">);</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">text</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&lt;= </span><span class="s2">endStep</span><span class="s1">) </span><span class="s3">return </span><span class="s2">text</span><span class="s1">;</span>
  <span class="s3">const </span><span class="s2">folds </span><span class="s1">= [];</span>
  <span class="s3">const </span><span class="s2">escapedFolds </span><span class="s1">= {};</span>
  <span class="s3">let </span><span class="s2">end </span><span class="s1">= </span><span class="s2">lineWidth </span><span class="s1">- </span><span class="s2">indent</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">indentAtStart </span><span class="s1">=== </span><span class="s0">'number'</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">indentAtStart </span><span class="s1">&gt; </span><span class="s2">lineWidth </span><span class="s1">- </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">max</span><span class="s1">(</span><span class="s5">2</span><span class="s1">, </span><span class="s2">minContentWidth</span><span class="s1">)) </span><span class="s2">folds</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s5">0</span><span class="s1">);</span><span class="s3">else </span><span class="s2">end </span><span class="s1">= </span><span class="s2">lineWidth </span><span class="s1">- </span><span class="s2">indentAtStart</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">let </span><span class="s2">split </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">prev </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">overflow </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">i </span><span class="s1">= -</span><span class="s5">1</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">escStart </span><span class="s1">= -</span><span class="s5">1</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">escEnd </span><span class="s1">= -</span><span class="s5">1</span><span class="s1">;</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">mode </span><span class="s1">=== </span><span class="s2">FOLD_BLOCK</span><span class="s1">) {</span>
    <span class="s2">i </span><span class="s1">= </span><span class="s2">consumeMoreIndentedLines</span><span class="s1">(</span><span class="s2">text</span><span class="s1">, </span><span class="s2">i</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">i </span><span class="s1">!== -</span><span class="s5">1</span><span class="s1">) </span><span class="s2">end </span><span class="s1">= </span><span class="s2">i </span><span class="s1">+ </span><span class="s2">endStep</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">for </span><span class="s1">(</span><span class="s3">let </span><span class="s2">ch</span><span class="s1">; </span><span class="s2">ch </span><span class="s1">= </span><span class="s2">text</span><span class="s1">[</span><span class="s2">i </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">];) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">mode </span><span class="s1">=== </span><span class="s2">FOLD_QUOTED </span><span class="s1">&amp;&amp; </span><span class="s2">ch </span><span class="s1">=== </span><span class="s0">'</span><span class="s3">\\</span><span class="s0">'</span><span class="s1">) {</span>
      <span class="s2">escStart </span><span class="s1">= </span><span class="s2">i</span><span class="s1">;</span>

      <span class="s3">switch </span><span class="s1">(</span><span class="s2">text</span><span class="s1">[</span><span class="s2">i </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">]) {</span>
        <span class="s3">case </span><span class="s0">'x'</span><span class="s1">:</span>
          <span class="s2">i </span><span class="s1">+= </span><span class="s5">3</span><span class="s1">;</span>
          <span class="s3">break</span><span class="s1">;</span>

        <span class="s3">case </span><span class="s0">'u'</span><span class="s1">:</span>
          <span class="s2">i </span><span class="s1">+= </span><span class="s5">5</span><span class="s1">;</span>
          <span class="s3">break</span><span class="s1">;</span>

        <span class="s3">case </span><span class="s0">'U'</span><span class="s1">:</span>
          <span class="s2">i </span><span class="s1">+= </span><span class="s5">9</span><span class="s1">;</span>
          <span class="s3">break</span><span class="s1">;</span>

        <span class="s3">default</span><span class="s1">:</span>
          <span class="s2">i </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s2">escEnd </span><span class="s1">= </span><span class="s2">i</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">ch </span><span class="s1">=== </span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">mode </span><span class="s1">=== </span><span class="s2">FOLD_BLOCK</span><span class="s1">) </span><span class="s2">i </span><span class="s1">= </span><span class="s2">consumeMoreIndentedLines</span><span class="s1">(</span><span class="s2">text</span><span class="s1">, </span><span class="s2">i</span><span class="s1">);</span>
      <span class="s2">end </span><span class="s1">= </span><span class="s2">i </span><span class="s1">+ </span><span class="s2">endStep</span><span class="s1">;</span>
      <span class="s2">split </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">ch </span><span class="s1">=== </span><span class="s0">' ' </span><span class="s1">&amp;&amp; </span><span class="s2">prev </span><span class="s1">&amp;&amp; </span><span class="s2">prev </span><span class="s1">!== </span><span class="s0">' ' </span><span class="s1">&amp;&amp; </span><span class="s2">prev </span><span class="s1">!== </span><span class="s0">'</span><span class="s3">\n</span><span class="s0">' </span><span class="s1">&amp;&amp; </span><span class="s2">prev </span><span class="s1">!== </span><span class="s0">'</span><span class="s3">\t</span><span class="s0">'</span><span class="s1">) {</span>
        <span class="s6">// space surrounded by non-space can be replaced with newline + indent</span>
        <span class="s3">const </span><span class="s2">next </span><span class="s1">= </span><span class="s2">text</span><span class="s1">[</span><span class="s2">i </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">];</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">next </span><span class="s1">&amp;&amp; </span><span class="s2">next </span><span class="s1">!== </span><span class="s0">' ' </span><span class="s1">&amp;&amp; </span><span class="s2">next </span><span class="s1">!== </span><span class="s0">'</span><span class="s3">\n</span><span class="s0">' </span><span class="s1">&amp;&amp; </span><span class="s2">next </span><span class="s1">!== </span><span class="s0">'</span><span class="s3">\t</span><span class="s0">'</span><span class="s1">) </span><span class="s2">split </span><span class="s1">= </span><span class="s2">i</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&gt;= </span><span class="s2">end</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">split</span><span class="s1">) {</span>
          <span class="s2">folds</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">split</span><span class="s1">);</span>
          <span class="s2">end </span><span class="s1">= </span><span class="s2">split </span><span class="s1">+ </span><span class="s2">endStep</span><span class="s1">;</span>
          <span class="s2">split </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
        <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">mode </span><span class="s1">=== </span><span class="s2">FOLD_QUOTED</span><span class="s1">) {</span>
          <span class="s6">// white-space collected at end may stretch past lineWidth</span>
          <span class="s3">while </span><span class="s1">(</span><span class="s2">prev </span><span class="s1">=== </span><span class="s0">' ' </span><span class="s1">|| </span><span class="s2">prev </span><span class="s1">=== </span><span class="s0">'</span><span class="s3">\t</span><span class="s0">'</span><span class="s1">) {</span>
            <span class="s2">prev </span><span class="s1">= </span><span class="s2">ch</span><span class="s1">;</span>
            <span class="s2">ch </span><span class="s1">= </span><span class="s2">text</span><span class="s1">[</span><span class="s2">i </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">];</span>
            <span class="s2">overflow </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s6">// Account for newline escape, but don't break preceding escape</span>


          <span class="s3">const </span><span class="s2">j </span><span class="s1">= </span><span class="s2">i </span><span class="s1">&gt; </span><span class="s2">escEnd </span><span class="s1">+ </span><span class="s5">1 </span><span class="s1">? </span><span class="s2">i </span><span class="s1">- </span><span class="s5">2 </span><span class="s1">: </span><span class="s2">escStart </span><span class="s1">- </span><span class="s5">1</span><span class="s1">; </span><span class="s6">// Bail out if lineWidth &amp; minContentWidth are shorter than an escape string</span>

          <span class="s3">if </span><span class="s1">(</span><span class="s2">escapedFolds</span><span class="s1">[</span><span class="s2">j</span><span class="s1">]) </span><span class="s3">return </span><span class="s2">text</span><span class="s1">;</span>
          <span class="s2">folds</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">j</span><span class="s1">);</span>
          <span class="s2">escapedFolds</span><span class="s1">[</span><span class="s2">j</span><span class="s1">] = </span><span class="s3">true</span><span class="s1">;</span>
          <span class="s2">end </span><span class="s1">= </span><span class="s2">j </span><span class="s1">+ </span><span class="s2">endStep</span><span class="s1">;</span>
          <span class="s2">split </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
        <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
          <span class="s2">overflow </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s2">prev </span><span class="s1">= </span><span class="s2">ch</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">overflow </span><span class="s1">&amp;&amp; </span><span class="s2">onOverflow</span><span class="s1">) </span><span class="s2">onOverflow</span><span class="s1">();</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">folds</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s5">0</span><span class="s1">) </span><span class="s3">return </span><span class="s2">text</span><span class="s1">;</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">onFold</span><span class="s1">) </span><span class="s2">onFold</span><span class="s1">();</span>
  <span class="s3">let </span><span class="s2">res </span><span class="s1">= </span><span class="s2">text</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s5">0</span><span class="s1">, </span><span class="s2">folds</span><span class="s1">[</span><span class="s5">0</span><span class="s1">]);</span>

  <span class="s3">for </span><span class="s1">(</span><span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s5">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">folds</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; ++</span><span class="s2">i</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">fold </span><span class="s1">= </span><span class="s2">folds</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>
    <span class="s3">const </span><span class="s2">end </span><span class="s1">= </span><span class="s2">folds</span><span class="s1">[</span><span class="s2">i </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">] || </span><span class="s2">text</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">fold </span><span class="s1">=== </span><span class="s5">0</span><span class="s1">) </span><span class="s2">res </span><span class="s1">= </span><span class="s0">`</span><span class="s3">\n</span><span class="s2">$</span><span class="s1">{</span><span class="s2">indent</span><span class="s1">}</span><span class="s2">$</span><span class="s1">{</span><span class="s2">text</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s5">0</span><span class="s1">, </span><span class="s2">end</span><span class="s1">)}</span><span class="s0">`</span><span class="s1">;</span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">mode </span><span class="s1">=== </span><span class="s2">FOLD_QUOTED </span><span class="s1">&amp;&amp; </span><span class="s2">escapedFolds</span><span class="s1">[</span><span class="s2">fold</span><span class="s1">]) </span><span class="s2">res </span><span class="s1">+= </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">text</span><span class="s1">[</span><span class="s2">fold</span><span class="s1">]}</span><span class="s3">\\</span><span class="s0">`</span><span class="s1">;</span>
      <span class="s2">res </span><span class="s1">+= </span><span class="s0">`</span><span class="s3">\n</span><span class="s2">$</span><span class="s1">{</span><span class="s2">indent</span><span class="s1">}</span><span class="s2">$</span><span class="s1">{</span><span class="s2">text</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">fold </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">, </span><span class="s2">end</span><span class="s1">)}</span><span class="s0">`</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s2">res</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">const </span><span class="s2">getFoldOptions </span><span class="s1">= ({</span>
  <span class="s2">indentAtStart</span>
<span class="s1">}) =&gt; </span><span class="s2">indentAtStart </span><span class="s1">? </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">assign</span><span class="s1">({</span>
  <span class="s2">indentAtStart</span>
<span class="s1">}, </span><span class="s2">strOptions</span><span class="s1">.</span><span class="s2">fold</span><span class="s1">) : </span><span class="s2">strOptions</span><span class="s1">.</span><span class="s2">fold</span><span class="s1">; </span><span class="s6">// Also checks for lines starting with %, as parsing the output as YAML 1.1 will</span>
<span class="s6">// presume that's starting a new document.</span>


<span class="s3">const </span><span class="s2">containsDocumentMarker </span><span class="s1">= </span><span class="s2">str </span><span class="s1">=&gt; </span><span class="s4">/^(%|---|\.\.\.)/m</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">str</span><span class="s1">);</span>

<span class="s3">function </span><span class="s2">lineLengthOverLimit</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">lineWidth</span><span class="s1">, </span><span class="s2">indentLength</span><span class="s1">) {</span>
  <span class="s3">if </span><span class="s1">(!</span><span class="s2">lineWidth </span><span class="s1">|| </span><span class="s2">lineWidth </span><span class="s1">&lt; </span><span class="s5">0</span><span class="s1">) </span><span class="s3">return false</span><span class="s1">;</span>
  <span class="s3">const </span><span class="s2">limit </span><span class="s1">= </span><span class="s2">lineWidth </span><span class="s1">- </span><span class="s2">indentLength</span><span class="s1">;</span>
  <span class="s3">const </span><span class="s2">strLen </span><span class="s1">= </span><span class="s2">str</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">strLen </span><span class="s1">&lt;= </span><span class="s2">limit</span><span class="s1">) </span><span class="s3">return false</span><span class="s1">;</span>

  <span class="s3">for </span><span class="s1">(</span><span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s2">start </span><span class="s1">= </span><span class="s5">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">strLen</span><span class="s1">; ++</span><span class="s2">i</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">str</span><span class="s1">[</span><span class="s2">i</span><span class="s1">] === </span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">i </span><span class="s1">- </span><span class="s2">start </span><span class="s1">&gt; </span><span class="s2">limit</span><span class="s1">) </span><span class="s3">return true</span><span class="s1">;</span>
      <span class="s2">start </span><span class="s1">= </span><span class="s2">i </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">;</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">strLen </span><span class="s1">- </span><span class="s2">start </span><span class="s1">&lt;= </span><span class="s2">limit</span><span class="s1">) </span><span class="s3">return false</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">return true</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">doubleQuotedString</span><span class="s1">(</span><span class="s2">value</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">) {</span>
  <span class="s3">const </span><span class="s1">{</span>
    <span class="s2">implicitKey</span>
  <span class="s1">} = </span><span class="s2">ctx</span><span class="s1">;</span>
  <span class="s3">const </span><span class="s1">{</span>
    <span class="s2">jsonEncoding</span><span class="s1">,</span>
    <span class="s2">minMultiLineLength</span>
  <span class="s1">} = </span><span class="s2">strOptions</span><span class="s1">.</span><span class="s2">doubleQuoted</span><span class="s1">;</span>
  <span class="s3">const </span><span class="s2">json </span><span class="s1">= </span><span class="s2">JSON</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">jsonEncoding</span><span class="s1">) </span><span class="s3">return </span><span class="s2">json</span><span class="s1">;</span>
  <span class="s3">const </span><span class="s2">indent </span><span class="s1">= </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">indent </span><span class="s1">|| (</span><span class="s2">containsDocumentMarker</span><span class="s1">(</span><span class="s2">value</span><span class="s1">) ? </span><span class="s0">'  ' </span><span class="s1">: </span><span class="s0">''</span><span class="s1">);</span>
  <span class="s3">let </span><span class="s2">str </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">start </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>

  <span class="s3">for </span><span class="s1">(</span><span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s5">0</span><span class="s1">, </span><span class="s2">ch </span><span class="s1">= </span><span class="s2">json</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]; </span><span class="s2">ch</span><span class="s1">; </span><span class="s2">ch </span><span class="s1">= </span><span class="s2">json</span><span class="s1">[++</span><span class="s2">i</span><span class="s1">]) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">ch </span><span class="s1">=== </span><span class="s0">' ' </span><span class="s1">&amp;&amp; </span><span class="s2">json</span><span class="s1">[</span><span class="s2">i </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">] === </span><span class="s0">'</span><span class="s3">\\</span><span class="s0">' </span><span class="s1">&amp;&amp; </span><span class="s2">json</span><span class="s1">[</span><span class="s2">i </span><span class="s1">+ </span><span class="s5">2</span><span class="s1">] === </span><span class="s0">'n'</span><span class="s1">) {</span>
      <span class="s6">// space before newline needs to be escaped to not be folded</span>
      <span class="s2">str </span><span class="s1">+= </span><span class="s2">json</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">, </span><span class="s2">i</span><span class="s1">) + </span><span class="s0">'</span><span class="s3">\\ </span><span class="s0">'</span><span class="s1">;</span>
      <span class="s2">i </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">;</span>
      <span class="s2">start </span><span class="s1">= </span><span class="s2">i</span><span class="s1">;</span>
      <span class="s2">ch </span><span class="s1">= </span><span class="s0">'</span><span class="s3">\\</span><span class="s0">'</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">ch </span><span class="s1">=== </span><span class="s0">'</span><span class="s3">\\</span><span class="s0">'</span><span class="s1">) </span><span class="s3">switch </span><span class="s1">(</span><span class="s2">json</span><span class="s1">[</span><span class="s2">i </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">]) {</span>
      <span class="s3">case </span><span class="s0">'u'</span><span class="s1">:</span>
        <span class="s1">{</span>
          <span class="s2">str </span><span class="s1">+= </span><span class="s2">json</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">, </span><span class="s2">i</span><span class="s1">);</span>
          <span class="s3">const </span><span class="s2">code </span><span class="s1">= </span><span class="s2">json</span><span class="s1">.</span><span class="s2">substr</span><span class="s1">(</span><span class="s2">i </span><span class="s1">+ </span><span class="s5">2</span><span class="s1">, </span><span class="s5">4</span><span class="s1">);</span>

          <span class="s3">switch </span><span class="s1">(</span><span class="s2">code</span><span class="s1">) {</span>
            <span class="s3">case </span><span class="s0">'0000'</span><span class="s1">:</span>
              <span class="s2">str </span><span class="s1">+= </span><span class="s0">'</span><span class="s3">\\</span><span class="s0">0'</span><span class="s1">;</span>
              <span class="s3">break</span><span class="s1">;</span>

            <span class="s3">case </span><span class="s0">'0007'</span><span class="s1">:</span>
              <span class="s2">str </span><span class="s1">+= </span><span class="s0">'</span><span class="s3">\\</span><span class="s0">a'</span><span class="s1">;</span>
              <span class="s3">break</span><span class="s1">;</span>

            <span class="s3">case </span><span class="s0">'000b'</span><span class="s1">:</span>
              <span class="s2">str </span><span class="s1">+= </span><span class="s0">'</span><span class="s3">\\</span><span class="s0">v'</span><span class="s1">;</span>
              <span class="s3">break</span><span class="s1">;</span>

            <span class="s3">case </span><span class="s0">'001b'</span><span class="s1">:</span>
              <span class="s2">str </span><span class="s1">+= </span><span class="s0">'</span><span class="s3">\\</span><span class="s0">e'</span><span class="s1">;</span>
              <span class="s3">break</span><span class="s1">;</span>

            <span class="s3">case </span><span class="s0">'0085'</span><span class="s1">:</span>
              <span class="s2">str </span><span class="s1">+= </span><span class="s0">'</span><span class="s3">\\</span><span class="s0">N'</span><span class="s1">;</span>
              <span class="s3">break</span><span class="s1">;</span>

            <span class="s3">case </span><span class="s0">'00a0'</span><span class="s1">:</span>
              <span class="s2">str </span><span class="s1">+= </span><span class="s0">'</span><span class="s3">\\</span><span class="s0">_'</span><span class="s1">;</span>
              <span class="s3">break</span><span class="s1">;</span>

            <span class="s3">case </span><span class="s0">'2028'</span><span class="s1">:</span>
              <span class="s2">str </span><span class="s1">+= </span><span class="s0">'</span><span class="s3">\\</span><span class="s0">L'</span><span class="s1">;</span>
              <span class="s3">break</span><span class="s1">;</span>

            <span class="s3">case </span><span class="s0">'2029'</span><span class="s1">:</span>
              <span class="s2">str </span><span class="s1">+= </span><span class="s0">'</span><span class="s3">\\</span><span class="s0">P'</span><span class="s1">;</span>
              <span class="s3">break</span><span class="s1">;</span>

            <span class="s3">default</span><span class="s1">:</span>
              <span class="s3">if </span><span class="s1">(</span><span class="s2">code</span><span class="s1">.</span><span class="s2">substr</span><span class="s1">(</span><span class="s5">0</span><span class="s1">, </span><span class="s5">2</span><span class="s1">) === </span><span class="s0">'00'</span><span class="s1">) </span><span class="s2">str </span><span class="s1">+= </span><span class="s0">'</span><span class="s3">\\</span><span class="s0">x' </span><span class="s1">+ </span><span class="s2">code</span><span class="s1">.</span><span class="s2">substr</span><span class="s1">(</span><span class="s5">2</span><span class="s1">);</span><span class="s3">else </span><span class="s2">str </span><span class="s1">+= </span><span class="s2">json</span><span class="s1">.</span><span class="s2">substr</span><span class="s1">(</span><span class="s2">i</span><span class="s1">, </span><span class="s5">6</span><span class="s1">);</span>
          <span class="s1">}</span>

          <span class="s2">i </span><span class="s1">+= </span><span class="s5">5</span><span class="s1">;</span>
          <span class="s2">start </span><span class="s1">= </span><span class="s2">i </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">case </span><span class="s0">'n'</span><span class="s1">:</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">implicitKey </span><span class="s1">|| </span><span class="s2">json</span><span class="s1">[</span><span class="s2">i </span><span class="s1">+ </span><span class="s5">2</span><span class="s1">] === </span><span class="s0">'&quot;' </span><span class="s1">|| </span><span class="s2">json</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&lt; </span><span class="s2">minMultiLineLength</span><span class="s1">) {</span>
          <span class="s2">i </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">;</span>
        <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
          <span class="s6">// folding will eat first newline</span>
          <span class="s2">str </span><span class="s1">+= </span><span class="s2">json</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">, </span><span class="s2">i</span><span class="s1">) + </span><span class="s0">'</span><span class="s3">\n\n</span><span class="s0">'</span><span class="s1">;</span>

          <span class="s3">while </span><span class="s1">(</span><span class="s2">json</span><span class="s1">[</span><span class="s2">i </span><span class="s1">+ </span><span class="s5">2</span><span class="s1">] === </span><span class="s0">'</span><span class="s3">\\</span><span class="s0">' </span><span class="s1">&amp;&amp; </span><span class="s2">json</span><span class="s1">[</span><span class="s2">i </span><span class="s1">+ </span><span class="s5">3</span><span class="s1">] === </span><span class="s0">'n' </span><span class="s1">&amp;&amp; </span><span class="s2">json</span><span class="s1">[</span><span class="s2">i </span><span class="s1">+ </span><span class="s5">4</span><span class="s1">] !== </span><span class="s0">'&quot;'</span><span class="s1">) {</span>
            <span class="s2">str </span><span class="s1">+= </span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">;</span>
            <span class="s2">i </span><span class="s1">+= </span><span class="s5">2</span><span class="s1">;</span>
          <span class="s1">}</span>

          <span class="s2">str </span><span class="s1">+= </span><span class="s2">indent</span><span class="s1">; </span><span class="s6">// space after newline needs to be escaped to not be folded</span>

          <span class="s3">if </span><span class="s1">(</span><span class="s2">json</span><span class="s1">[</span><span class="s2">i </span><span class="s1">+ </span><span class="s5">2</span><span class="s1">] === </span><span class="s0">' '</span><span class="s1">) </span><span class="s2">str </span><span class="s1">+= </span><span class="s0">'</span><span class="s3">\\</span><span class="s0">'</span><span class="s1">;</span>
          <span class="s2">i </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">;</span>
          <span class="s2">start </span><span class="s1">= </span><span class="s2">i </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">default</span><span class="s1">:</span>
        <span class="s2">i </span><span class="s1">+= </span><span class="s5">1</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">str </span><span class="s1">= </span><span class="s2">start </span><span class="s1">? </span><span class="s2">str </span><span class="s1">+ </span><span class="s2">json</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start</span><span class="s1">) : </span><span class="s2">json</span><span class="s1">;</span>
  <span class="s3">return </span><span class="s2">implicitKey </span><span class="s1">? </span><span class="s2">str </span><span class="s1">: </span><span class="s2">foldFlowLines</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">indent</span><span class="s1">, </span><span class="s2">FOLD_QUOTED</span><span class="s1">, </span><span class="s2">getFoldOptions</span><span class="s1">(</span><span class="s2">ctx</span><span class="s1">));</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">singleQuotedString</span><span class="s1">(</span><span class="s2">value</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">) {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">implicitKey</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s4">/\n/</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">value</span><span class="s1">)) </span><span class="s3">return </span><span class="s2">doubleQuotedString</span><span class="s1">(</span><span class="s2">value</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">);</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s6">// single quoted string can't have leading or trailing whitespace around newline</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s4">/[ \t]\n|\n[ \t]/</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">value</span><span class="s1">)) </span><span class="s3">return </span><span class="s2">doubleQuotedString</span><span class="s1">(</span><span class="s2">value</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">const </span><span class="s2">indent </span><span class="s1">= </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">indent </span><span class="s1">|| (</span><span class="s2">containsDocumentMarker</span><span class="s1">(</span><span class="s2">value</span><span class="s1">) ? </span><span class="s0">'  ' </span><span class="s1">: </span><span class="s0">''</span><span class="s1">);</span>
  <span class="s3">const </span><span class="s2">res </span><span class="s1">= </span><span class="s0">&quot;'&quot; </span><span class="s1">+ </span><span class="s2">value</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s4">/'/g</span><span class="s1">, </span><span class="s0">&quot;''&quot;</span><span class="s1">).</span><span class="s2">replace</span><span class="s1">(</span><span class="s4">/\n+/g</span><span class="s1">, </span><span class="s0">`$&amp;</span><span class="s3">\n</span><span class="s2">$</span><span class="s1">{</span><span class="s2">indent</span><span class="s1">}</span><span class="s0">`</span><span class="s1">) + </span><span class="s0">&quot;'&quot;</span><span class="s1">;</span>
  <span class="s3">return </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">implicitKey </span><span class="s1">? </span><span class="s2">res </span><span class="s1">: </span><span class="s2">foldFlowLines</span><span class="s1">(</span><span class="s2">res</span><span class="s1">, </span><span class="s2">indent</span><span class="s1">, </span><span class="s2">FOLD_FLOW</span><span class="s1">, </span><span class="s2">getFoldOptions</span><span class="s1">(</span><span class="s2">ctx</span><span class="s1">));</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">blockString</span><span class="s1">({</span>
  <span class="s2">comment</span><span class="s1">,</span>
  <span class="s2">type</span><span class="s1">,</span>
  <span class="s2">value</span>
<span class="s1">}, </span><span class="s2">ctx</span><span class="s1">, </span><span class="s2">onComment</span><span class="s1">, </span><span class="s2">onChompKeep</span><span class="s1">) {</span>
  <span class="s6">// 1. Block can't end in whitespace unless the last line is non-empty.</span>
  <span class="s6">// 2. Strings consisting of only whitespace are best rendered explicitly.</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s4">/\n[\t ]+$/</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">value</span><span class="s1">) || </span><span class="s4">/^\s*$/</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">value</span><span class="s1">)) {</span>
    <span class="s3">return </span><span class="s2">doubleQuotedString</span><span class="s1">(</span><span class="s2">value</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">const </span><span class="s2">indent </span><span class="s1">= </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">indent </span><span class="s1">|| (</span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">forceBlockIndent </span><span class="s1">|| </span><span class="s2">containsDocumentMarker</span><span class="s1">(</span><span class="s2">value</span><span class="s1">) ? </span><span class="s0">'  ' </span><span class="s1">: </span><span class="s0">''</span><span class="s1">);</span>
  <span class="s3">const </span><span class="s2">indentSize </span><span class="s1">= </span><span class="s2">indent </span><span class="s1">? </span><span class="s0">'2' </span><span class="s1">: </span><span class="s0">'1'</span><span class="s1">; </span><span class="s6">// root is at -1</span>

  <span class="s3">const </span><span class="s2">literal </span><span class="s1">= </span><span class="s2">type </span><span class="s1">=== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">BLOCK_FOLDED </span><span class="s1">? </span><span class="s3">false </span><span class="s1">: </span><span class="s2">type </span><span class="s1">=== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">BLOCK_LITERAL </span><span class="s1">? </span><span class="s3">true </span><span class="s1">: !</span><span class="s2">lineLengthOverLimit</span><span class="s1">(</span><span class="s2">value</span><span class="s1">, </span><span class="s2">strOptions</span><span class="s1">.</span><span class="s2">fold</span><span class="s1">.</span><span class="s2">lineWidth</span><span class="s1">, </span><span class="s2">indent</span><span class="s1">.</span><span class="s2">length</span><span class="s1">);</span>
  <span class="s3">let </span><span class="s2">header </span><span class="s1">= </span><span class="s2">literal </span><span class="s1">? </span><span class="s0">'|' </span><span class="s1">: </span><span class="s0">'&gt;'</span><span class="s1">;</span>
  <span class="s3">if </span><span class="s1">(!</span><span class="s2">value</span><span class="s1">) </span><span class="s3">return </span><span class="s2">header </span><span class="s1">+ </span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">wsStart </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">wsEnd </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
  <span class="s2">value </span><span class="s1">= </span><span class="s2">value</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s4">/[\n\t ]*$/</span><span class="s1">, </span><span class="s2">ws </span><span class="s1">=&gt; {</span>
    <span class="s3">const </span><span class="s2">n </span><span class="s1">= </span><span class="s2">ws</span><span class="s1">.</span><span class="s2">indexOf</span><span class="s1">(</span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">n </span><span class="s1">=== -</span><span class="s5">1</span><span class="s1">) {</span>
      <span class="s2">header </span><span class="s1">+= </span><span class="s0">'-'</span><span class="s1">; </span><span class="s6">// strip</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">value </span><span class="s1">=== </span><span class="s2">ws </span><span class="s1">|| </span><span class="s2">n </span><span class="s1">!== </span><span class="s2">ws</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s5">1</span><span class="s1">) {</span>
      <span class="s2">header </span><span class="s1">+= </span><span class="s0">'+'</span><span class="s1">; </span><span class="s6">// keep</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">onChompKeep</span><span class="s1">) </span><span class="s2">onChompKeep</span><span class="s1">();</span>
    <span class="s1">}</span>

    <span class="s2">wsEnd </span><span class="s1">= </span><span class="s2">ws</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s4">/\n$/</span><span class="s1">, </span><span class="s0">''</span><span class="s1">);</span>
    <span class="s3">return </span><span class="s0">''</span><span class="s1">;</span>
  <span class="s1">}).</span><span class="s2">replace</span><span class="s1">(</span><span class="s4">/^[\n ]*/</span><span class="s1">, </span><span class="s2">ws </span><span class="s1">=&gt; {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">ws</span><span class="s1">.</span><span class="s2">indexOf</span><span class="s1">(</span><span class="s0">' '</span><span class="s1">) !== -</span><span class="s5">1</span><span class="s1">) </span><span class="s2">header </span><span class="s1">+= </span><span class="s2">indentSize</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">m </span><span class="s1">= </span><span class="s2">ws</span><span class="s1">.</span><span class="s2">match</span><span class="s1">(</span><span class="s4">/ +$/</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">m</span><span class="s1">) {</span>
      <span class="s2">wsStart </span><span class="s1">= </span><span class="s2">ws</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s5">0</span><span class="s1">, -</span><span class="s2">m</span><span class="s1">[</span><span class="s5">0</span><span class="s1">].</span><span class="s2">length</span><span class="s1">);</span>
      <span class="s3">return </span><span class="s2">m</span><span class="s1">[</span><span class="s5">0</span><span class="s1">];</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s2">wsStart </span><span class="s1">= </span><span class="s2">ws</span><span class="s1">;</span>
      <span class="s3">return </span><span class="s0">''</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">wsEnd</span><span class="s1">) </span><span class="s2">wsEnd </span><span class="s1">= </span><span class="s2">wsEnd</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s4">/\n+(?!\n|$)/g</span><span class="s1">, </span><span class="s0">`$&amp;</span><span class="s2">$</span><span class="s1">{</span><span class="s2">indent</span><span class="s1">}</span><span class="s0">`</span><span class="s1">);</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">wsStart</span><span class="s1">) </span><span class="s2">wsStart </span><span class="s1">= </span><span class="s2">wsStart</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s4">/\n+/g</span><span class="s1">, </span><span class="s0">`$&amp;</span><span class="s2">$</span><span class="s1">{</span><span class="s2">indent</span><span class="s1">}</span><span class="s0">`</span><span class="s1">);</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">comment</span><span class="s1">) {</span>
    <span class="s2">header </span><span class="s1">+= </span><span class="s0">' #' </span><span class="s1">+ </span><span class="s2">comment</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s4">/ ?[\r\n]+/g</span><span class="s1">, </span><span class="s0">' '</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">onComment</span><span class="s1">) </span><span class="s2">onComment</span><span class="s1">();</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">value</span><span class="s1">) </span><span class="s3">return </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">header</span><span class="s1">}</span><span class="s2">$</span><span class="s1">{</span><span class="s2">indentSize</span><span class="s1">}</span><span class="s3">\n</span><span class="s2">$</span><span class="s1">{</span><span class="s2">indent</span><span class="s1">}</span><span class="s2">$</span><span class="s1">{</span><span class="s2">wsEnd</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">literal</span><span class="s1">) {</span>
    <span class="s2">value </span><span class="s1">= </span><span class="s2">value</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s4">/\n+/g</span><span class="s1">, </span><span class="s0">`$&amp;</span><span class="s2">$</span><span class="s1">{</span><span class="s2">indent</span><span class="s1">}</span><span class="s0">`</span><span class="s1">);</span>
    <span class="s3">return </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">header</span><span class="s1">}</span><span class="s3">\n</span><span class="s2">$</span><span class="s1">{</span><span class="s2">indent</span><span class="s1">}</span><span class="s2">$</span><span class="s1">{</span><span class="s2">wsStart</span><span class="s1">}</span><span class="s2">$</span><span class="s1">{</span><span class="s2">value</span><span class="s1">}</span><span class="s2">$</span><span class="s1">{</span><span class="s2">wsEnd</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">value </span><span class="s1">= </span><span class="s2">value</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s4">/\n+/g</span><span class="s1">, </span><span class="s0">'</span><span class="s3">\n</span><span class="s0">$&amp;'</span><span class="s1">).</span><span class="s2">replace</span><span class="s1">(</span><span class="s4">/(?:^|\n)([\t ].*)(?:([\n\t ]*)\n(?![\n\t ]))?/g</span><span class="s1">, </span><span class="s0">'$1$2'</span><span class="s1">) </span><span class="s6">// more-indented lines aren't folded</span>
  <span class="s6">//         ^ ind.line  ^ empty     ^ capture next empty lines only at end of indent</span>
  <span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s4">/\n+/g</span><span class="s1">, </span><span class="s0">`$&amp;</span><span class="s2">$</span><span class="s1">{</span><span class="s2">indent</span><span class="s1">}</span><span class="s0">`</span><span class="s1">);</span>
  <span class="s3">const </span><span class="s2">body </span><span class="s1">= </span><span class="s2">foldFlowLines</span><span class="s1">(</span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">wsStart</span><span class="s1">}</span><span class="s2">$</span><span class="s1">{</span><span class="s2">value</span><span class="s1">}</span><span class="s2">$</span><span class="s1">{</span><span class="s2">wsEnd</span><span class="s1">}</span><span class="s0">`</span><span class="s1">, </span><span class="s2">indent</span><span class="s1">, </span><span class="s2">FOLD_BLOCK</span><span class="s1">, </span><span class="s2">strOptions</span><span class="s1">.</span><span class="s2">fold</span><span class="s1">);</span>
  <span class="s3">return </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">header</span><span class="s1">}</span><span class="s3">\n</span><span class="s2">$</span><span class="s1">{</span><span class="s2">indent</span><span class="s1">}</span><span class="s2">$</span><span class="s1">{</span><span class="s2">body</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">plainString</span><span class="s1">(</span><span class="s2">item</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">, </span><span class="s2">onComment</span><span class="s1">, </span><span class="s2">onChompKeep</span><span class="s1">) {</span>
  <span class="s3">const </span><span class="s1">{</span>
    <span class="s2">comment</span><span class="s1">,</span>
    <span class="s2">type</span><span class="s1">,</span>
    <span class="s2">value</span>
  <span class="s1">} = </span><span class="s2">item</span><span class="s1">;</span>
  <span class="s3">const </span><span class="s1">{</span>
    <span class="s2">actualString</span><span class="s1">,</span>
    <span class="s2">implicitKey</span><span class="s1">,</span>
    <span class="s2">indent</span><span class="s1">,</span>
    <span class="s2">inFlow</span>
  <span class="s1">} = </span><span class="s2">ctx</span><span class="s1">;</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">implicitKey </span><span class="s1">&amp;&amp; </span><span class="s4">/[\n[\]{},]/</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">value</span><span class="s1">) || </span><span class="s2">inFlow </span><span class="s1">&amp;&amp; </span><span class="s4">/[[\]{},]/</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">value</span><span class="s1">)) {</span>
    <span class="s3">return </span><span class="s2">doubleQuotedString</span><span class="s1">(</span><span class="s2">value</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">value </span><span class="s1">|| </span><span class="s4">/^[\n\t ,[\]{}#&amp;*!|&gt;'&quot;%@`]|^[?-]$|^[?-][ \t]|[\n:][ \t]|[ \t]\n|[\n\t ]#|[\n\t :]$/</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">value</span><span class="s1">)) {</span>
    <span class="s6">// not allowed:</span>
    <span class="s6">// - empty string, '-' or '?'</span>
    <span class="s6">// - start with an indicator character (except [?:-]) or /[?-] /</span>
    <span class="s6">// - '\n ', ': ' or ' \n' anywhere</span>
    <span class="s6">// - '#' not preceded by a non-space char</span>
    <span class="s6">// - end with ' ' or ':'</span>
    <span class="s3">return </span><span class="s2">implicitKey </span><span class="s1">|| </span><span class="s2">inFlow </span><span class="s1">|| </span><span class="s2">value</span><span class="s1">.</span><span class="s2">indexOf</span><span class="s1">(</span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">) === -</span><span class="s5">1 </span><span class="s1">? </span><span class="s2">value</span><span class="s1">.</span><span class="s2">indexOf</span><span class="s1">(</span><span class="s0">'&quot;'</span><span class="s1">) !== -</span><span class="s5">1 </span><span class="s1">&amp;&amp; </span><span class="s2">value</span><span class="s1">.</span><span class="s2">indexOf</span><span class="s1">(</span><span class="s0">&quot;'&quot;</span><span class="s1">) === -</span><span class="s5">1 </span><span class="s1">? </span><span class="s2">singleQuotedString</span><span class="s1">(</span><span class="s2">value</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">) : </span><span class="s2">doubleQuotedString</span><span class="s1">(</span><span class="s2">value</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">) : </span><span class="s2">blockString</span><span class="s1">(</span><span class="s2">item</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">, </span><span class="s2">onComment</span><span class="s1">, </span><span class="s2">onChompKeep</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">implicitKey </span><span class="s1">&amp;&amp; !</span><span class="s2">inFlow </span><span class="s1">&amp;&amp; </span><span class="s2">type </span><span class="s1">!== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">PLAIN </span><span class="s1">&amp;&amp; </span><span class="s2">value</span><span class="s1">.</span><span class="s2">indexOf</span><span class="s1">(</span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">) !== -</span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s6">// Where allowed &amp; type not set explicitly, prefer block style for multiline strings</span>
    <span class="s3">return </span><span class="s2">blockString</span><span class="s1">(</span><span class="s2">item</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">, </span><span class="s2">onComment</span><span class="s1">, </span><span class="s2">onChompKeep</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">indent </span><span class="s1">=== </span><span class="s0">'' </span><span class="s1">&amp;&amp; </span><span class="s2">containsDocumentMarker</span><span class="s1">(</span><span class="s2">value</span><span class="s1">)) {</span>
    <span class="s2">ctx</span><span class="s1">.</span><span class="s2">forceBlockIndent </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s3">return </span><span class="s2">blockString</span><span class="s1">(</span><span class="s2">item</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">, </span><span class="s2">onComment</span><span class="s1">, </span><span class="s2">onChompKeep</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">const </span><span class="s2">str </span><span class="s1">= </span><span class="s2">value</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s4">/\n+/g</span><span class="s1">, </span><span class="s0">`$&amp;</span><span class="s3">\n</span><span class="s2">$</span><span class="s1">{</span><span class="s2">indent</span><span class="s1">}</span><span class="s0">`</span><span class="s1">); </span><span class="s6">// Verify that output will be parsed as a string, as e.g. plain numbers and</span>
  <span class="s6">// booleans get parsed with those types in v1.2 (e.g. '42', 'true' &amp; '0.9e-3'),</span>
  <span class="s6">// and others in v1.1.</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">actualString</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s1">{</span>
      <span class="s2">tags</span>
    <span class="s1">} = </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">doc</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">resolved </span><span class="s1">= </span><span class="s2">resolveScalar</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">tags</span><span class="s1">, </span><span class="s2">tags</span><span class="s1">.</span><span class="s2">scalarFallback</span><span class="s1">).</span><span class="s2">value</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">resolved </span><span class="s1">!== </span><span class="s0">'string'</span><span class="s1">) </span><span class="s3">return </span><span class="s2">doubleQuotedString</span><span class="s1">(</span><span class="s2">value</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">const </span><span class="s2">body </span><span class="s1">= </span><span class="s2">implicitKey </span><span class="s1">? </span><span class="s2">str </span><span class="s1">: </span><span class="s2">foldFlowLines</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">indent</span><span class="s1">, </span><span class="s2">FOLD_FLOW</span><span class="s1">, </span><span class="s2">getFoldOptions</span><span class="s1">(</span><span class="s2">ctx</span><span class="s1">));</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">comment </span><span class="s1">&amp;&amp; !</span><span class="s2">inFlow </span><span class="s1">&amp;&amp; (</span><span class="s2">body</span><span class="s1">.</span><span class="s2">indexOf</span><span class="s1">(</span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">) !== -</span><span class="s5">1 </span><span class="s1">|| </span><span class="s2">comment</span><span class="s1">.</span><span class="s2">indexOf</span><span class="s1">(</span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">) !== -</span><span class="s5">1</span><span class="s1">)) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">onComment</span><span class="s1">) </span><span class="s2">onComment</span><span class="s1">();</span>
    <span class="s3">return </span><span class="s2">addCommentBefore</span><span class="s1">(</span><span class="s2">body</span><span class="s1">, </span><span class="s2">indent</span><span class="s1">, </span><span class="s2">comment</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s2">body</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">stringifyString</span><span class="s1">(</span><span class="s2">item</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">, </span><span class="s2">onComment</span><span class="s1">, </span><span class="s2">onChompKeep</span><span class="s1">) {</span>
  <span class="s3">const </span><span class="s1">{</span>
    <span class="s2">defaultType</span>
  <span class="s1">} = </span><span class="s2">strOptions</span><span class="s1">;</span>
  <span class="s3">const </span><span class="s1">{</span>
    <span class="s2">implicitKey</span><span class="s1">,</span>
    <span class="s2">inFlow</span>
  <span class="s1">} = </span><span class="s2">ctx</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s1">{</span>
    <span class="s2">type</span><span class="s1">,</span>
    <span class="s2">value</span>
  <span class="s1">} = </span><span class="s2">item</span><span class="s1">;</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">value </span><span class="s1">!== </span><span class="s0">'string'</span><span class="s1">) {</span>
    <span class="s2">value </span><span class="s1">= </span><span class="s2">String</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>
    <span class="s2">item </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">assign</span><span class="s1">({}, </span><span class="s2">item</span><span class="s1">, {</span>
      <span class="s2">value</span>
    <span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s3">const </span><span class="s2">_stringify </span><span class="s1">= </span><span class="s2">_type </span><span class="s1">=&gt; {</span>
    <span class="s3">switch </span><span class="s1">(</span><span class="s2">_type</span><span class="s1">) {</span>
      <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">BLOCK_FOLDED</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">BLOCK_LITERAL</span><span class="s1">:</span>
        <span class="s3">return </span><span class="s2">blockString</span><span class="s1">(</span><span class="s2">item</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">, </span><span class="s2">onComment</span><span class="s1">, </span><span class="s2">onChompKeep</span><span class="s1">);</span>

      <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">QUOTE_DOUBLE</span><span class="s1">:</span>
        <span class="s3">return </span><span class="s2">doubleQuotedString</span><span class="s1">(</span><span class="s2">value</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">);</span>

      <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">QUOTE_SINGLE</span><span class="s1">:</span>
        <span class="s3">return </span><span class="s2">singleQuotedString</span><span class="s1">(</span><span class="s2">value</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">);</span>

      <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">PLAIN</span><span class="s1">:</span>
        <span class="s3">return </span><span class="s2">plainString</span><span class="s1">(</span><span class="s2">item</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">, </span><span class="s2">onComment</span><span class="s1">, </span><span class="s2">onChompKeep</span><span class="s1">);</span>

      <span class="s3">default</span><span class="s1">:</span>
        <span class="s3">return null</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">};</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">type </span><span class="s1">!== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">QUOTE_DOUBLE </span><span class="s1">&amp;&amp; </span><span class="s4">/[\x00-\x08\x0b-\x1f\x7f-\x9f]/</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">value</span><span class="s1">)) {</span>
    <span class="s6">// force double quotes on control characters</span>
    <span class="s2">type </span><span class="s1">= </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">QUOTE_DOUBLE</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">((</span><span class="s2">implicitKey </span><span class="s1">|| </span><span class="s2">inFlow</span><span class="s1">) &amp;&amp; (</span><span class="s2">type </span><span class="s1">=== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">BLOCK_FOLDED </span><span class="s1">|| </span><span class="s2">type </span><span class="s1">=== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">BLOCK_LITERAL</span><span class="s1">)) {</span>
    <span class="s6">// should not happen; blocks are not valid inside flow containers</span>
    <span class="s2">type </span><span class="s1">= </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">QUOTE_DOUBLE</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">let </span><span class="s2">res </span><span class="s1">= </span><span class="s2">_stringify</span><span class="s1">(</span><span class="s2">type</span><span class="s1">);</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">res </span><span class="s1">=== </span><span class="s3">null</span><span class="s1">) {</span>
    <span class="s2">res </span><span class="s1">= </span><span class="s2">_stringify</span><span class="s1">(</span><span class="s2">defaultType</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">res </span><span class="s1">=== </span><span class="s3">null</span><span class="s1">) </span><span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">`Unsupported default string type </span><span class="s2">$</span><span class="s1">{</span><span class="s2">defaultType</span><span class="s1">}</span><span class="s0">`</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s2">res</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">stringifyNumber</span><span class="s1">({</span>
  <span class="s2">format</span><span class="s1">,</span>
  <span class="s2">minFractionDigits</span><span class="s1">,</span>
  <span class="s2">tag</span><span class="s1">,</span>
  <span class="s2">value</span>
<span class="s1">}) {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">value </span><span class="s1">=== </span><span class="s0">'bigint'</span><span class="s1">) </span><span class="s3">return </span><span class="s2">String</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>
  <span class="s3">if </span><span class="s1">(!</span><span class="s2">isFinite</span><span class="s1">(</span><span class="s2">value</span><span class="s1">)) </span><span class="s3">return </span><span class="s2">isNaN</span><span class="s1">(</span><span class="s2">value</span><span class="s1">) ? </span><span class="s0">'.nan' </span><span class="s1">: </span><span class="s2">value </span><span class="s1">&lt; </span><span class="s5">0 </span><span class="s1">? </span><span class="s0">'-.inf' </span><span class="s1">: </span><span class="s0">'.inf'</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">n </span><span class="s1">= </span><span class="s2">JSON</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">format </span><span class="s1">&amp;&amp; </span><span class="s2">minFractionDigits </span><span class="s1">&amp;&amp; (!</span><span class="s2">tag </span><span class="s1">|| </span><span class="s2">tag </span><span class="s1">=== </span><span class="s0">'tag:yaml.org,2002:float'</span><span class="s1">) &amp;&amp; </span><span class="s4">/^\d/</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">n</span><span class="s1">)) {</span>
    <span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s2">n</span><span class="s1">.</span><span class="s2">indexOf</span><span class="s1">(</span><span class="s0">'.'</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&lt; </span><span class="s5">0</span><span class="s1">) {</span>
      <span class="s2">i </span><span class="s1">= </span><span class="s2">n</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
      <span class="s2">n </span><span class="s1">+= </span><span class="s0">'.'</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">let </span><span class="s2">d </span><span class="s1">= </span><span class="s2">minFractionDigits </span><span class="s1">- (</span><span class="s2">n</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s2">i </span><span class="s1">- </span><span class="s5">1</span><span class="s1">);</span>

    <span class="s3">while </span><span class="s1">(</span><span class="s2">d</span><span class="s1">-- &gt; </span><span class="s5">0</span><span class="s1">) </span><span class="s2">n </span><span class="s1">+= </span><span class="s0">'0'</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s2">n</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">checkFlowCollectionEnd</span><span class="s1">(</span><span class="s2">errors</span><span class="s1">, </span><span class="s2">cst</span><span class="s1">) {</span>
  <span class="s3">let </span><span class="s2">char</span><span class="s1">, </span><span class="s2">name</span><span class="s1">;</span>

  <span class="s3">switch </span><span class="s1">(</span><span class="s2">cst</span><span class="s1">.</span><span class="s2">type</span><span class="s1">) {</span>
    <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">FLOW_MAP</span><span class="s1">:</span>
      <span class="s2">char </span><span class="s1">= </span><span class="s0">'}'</span><span class="s1">;</span>
      <span class="s2">name </span><span class="s1">= </span><span class="s0">'flow map'</span><span class="s1">;</span>
      <span class="s3">break</span><span class="s1">;</span>

    <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">FLOW_SEQ</span><span class="s1">:</span>
      <span class="s2">char </span><span class="s1">= </span><span class="s0">']'</span><span class="s1">;</span>
      <span class="s2">name </span><span class="s1">= </span><span class="s0">'flow sequence'</span><span class="s1">;</span>
      <span class="s3">break</span><span class="s1">;</span>

    <span class="s3">default</span><span class="s1">:</span>
      <span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSemanticError</span><span class="s1">(</span><span class="s2">cst</span><span class="s1">, </span><span class="s0">'Not a flow collection!?'</span><span class="s1">));</span>
      <span class="s3">return</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">let </span><span class="s2">lastItem</span><span class="s1">;</span>

  <span class="s3">for </span><span class="s1">(</span><span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s2">cst</span><span class="s1">.</span><span class="s2">items</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s5">1</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&gt;= </span><span class="s5">0</span><span class="s1">; --</span><span class="s2">i</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">item </span><span class="s1">= </span><span class="s2">cst</span><span class="s1">.</span><span class="s2">items</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>

    <span class="s3">if </span><span class="s1">(!</span><span class="s2">item </span><span class="s1">|| </span><span class="s2">item</span><span class="s1">.</span><span class="s2">type </span><span class="s1">!== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">COMMENT</span><span class="s1">) {</span>
      <span class="s2">lastItem </span><span class="s1">= </span><span class="s2">item</span><span class="s1">;</span>
      <span class="s3">break</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">lastItem </span><span class="s1">&amp;&amp; </span><span class="s2">lastItem</span><span class="s1">.</span><span class="s2">char </span><span class="s1">!== </span><span class="s2">char</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">`Expected </span><span class="s2">$</span><span class="s1">{</span><span class="s2">name</span><span class="s1">} </span><span class="s0">to end with </span><span class="s2">$</span><span class="s1">{</span><span class="s2">char</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
    <span class="s3">let </span><span class="s2">err</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">lastItem</span><span class="s1">.</span><span class="s2">offset </span><span class="s1">=== </span><span class="s0">'number'</span><span class="s1">) {</span>
      <span class="s2">err </span><span class="s1">= </span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSemanticError</span><span class="s1">(</span><span class="s2">cst</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">);</span>
      <span class="s2">err</span><span class="s1">.</span><span class="s2">offset </span><span class="s1">= </span><span class="s2">lastItem</span><span class="s1">.</span><span class="s2">offset </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s2">err </span><span class="s1">= </span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSemanticError</span><span class="s1">(</span><span class="s2">lastItem</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">);</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">lastItem</span><span class="s1">.</span><span class="s2">range </span><span class="s1">&amp;&amp; </span><span class="s2">lastItem</span><span class="s1">.</span><span class="s2">range</span><span class="s1">.</span><span class="s2">end</span><span class="s1">) </span><span class="s2">err</span><span class="s1">.</span><span class="s2">offset </span><span class="s1">= </span><span class="s2">lastItem</span><span class="s1">.</span><span class="s2">range</span><span class="s1">.</span><span class="s2">end </span><span class="s1">- </span><span class="s2">lastItem</span><span class="s1">.</span><span class="s2">range</span><span class="s1">.</span><span class="s2">start</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
  <span class="s1">}</span>
<span class="s1">}</span>
<span class="s3">function </span><span class="s2">checkFlowCommentSpace</span><span class="s1">(</span><span class="s2">errors</span><span class="s1">, </span><span class="s2">comment</span><span class="s1">) {</span>
  <span class="s3">const </span><span class="s2">prev </span><span class="s1">= </span><span class="s2">comment</span><span class="s1">.</span><span class="s2">context</span><span class="s1">.</span><span class="s2">src</span><span class="s1">[</span><span class="s2">comment</span><span class="s1">.</span><span class="s2">range</span><span class="s1">.</span><span class="s2">start </span><span class="s1">- </span><span class="s5">1</span><span class="s1">];</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">prev </span><span class="s1">!== </span><span class="s0">'</span><span class="s3">\n</span><span class="s0">' </span><span class="s1">&amp;&amp; </span><span class="s2">prev </span><span class="s1">!== </span><span class="s0">'</span><span class="s3">\t</span><span class="s0">' </span><span class="s1">&amp;&amp; </span><span class="s2">prev </span><span class="s1">!== </span><span class="s0">' '</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">'Comments must be separated from other tokens by white space characters'</span><span class="s1">;</span>
    <span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSemanticError</span><span class="s1">(</span><span class="s2">comment</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">));</span>
  <span class="s1">}</span>
<span class="s1">}</span>
<span class="s3">function </span><span class="s2">getLongKeyError</span><span class="s1">(</span><span class="s2">source</span><span class="s1">, </span><span class="s2">key</span><span class="s1">) {</span>
  <span class="s3">const </span><span class="s2">sk </span><span class="s1">= </span><span class="s2">String</span><span class="s1">(</span><span class="s2">key</span><span class="s1">);</span>
  <span class="s3">const </span><span class="s2">k </span><span class="s1">= </span><span class="s2">sk</span><span class="s1">.</span><span class="s2">substr</span><span class="s1">(</span><span class="s5">0</span><span class="s1">, </span><span class="s5">8</span><span class="s1">) + </span><span class="s0">'...' </span><span class="s1">+ </span><span class="s2">sk</span><span class="s1">.</span><span class="s2">substr</span><span class="s1">(-</span><span class="s5">8</span><span class="s1">);</span>
  <span class="s3">return new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSemanticError</span><span class="s1">(</span><span class="s2">source</span><span class="s1">, </span><span class="s0">`The &quot;</span><span class="s2">$</span><span class="s1">{</span><span class="s2">k</span><span class="s1">}</span><span class="s0">&quot; key is too long`</span><span class="s1">);</span>
<span class="s1">}</span>
<span class="s3">function </span><span class="s2">resolveComments</span><span class="s1">(</span><span class="s2">collection</span><span class="s1">, </span><span class="s2">comments</span><span class="s1">) {</span>
  <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s1">{</span>
    <span class="s2">afterKey</span><span class="s1">,</span>
    <span class="s2">before</span><span class="s1">,</span>
    <span class="s2">comment</span>
  <span class="s1">} </span><span class="s2">of comments</span><span class="s1">) {</span>
    <span class="s3">let </span><span class="s2">item </span><span class="s1">= </span><span class="s2">collection</span><span class="s1">.</span><span class="s2">items</span><span class="s1">[</span><span class="s2">before</span><span class="s1">];</span>

    <span class="s3">if </span><span class="s1">(!</span><span class="s2">item</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">comment </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">collection</span><span class="s1">.</span><span class="s2">comment</span><span class="s1">) </span><span class="s2">collection</span><span class="s1">.</span><span class="s2">comment </span><span class="s1">+= </span><span class="s0">'</span><span class="s3">\n</span><span class="s0">' </span><span class="s1">+ </span><span class="s2">comment</span><span class="s1">;</span><span class="s3">else </span><span class="s2">collection</span><span class="s1">.</span><span class="s2">comment </span><span class="s1">= </span><span class="s2">comment</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">afterKey </span><span class="s1">&amp;&amp; </span><span class="s2">item</span><span class="s1">.</span><span class="s2">value</span><span class="s1">) </span><span class="s2">item </span><span class="s1">= </span><span class="s2">item</span><span class="s1">.</span><span class="s2">value</span><span class="s1">;</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">comment </span><span class="s1">=== </span><span class="s2">undefined</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">afterKey </span><span class="s1">|| !</span><span class="s2">item</span><span class="s1">.</span><span class="s2">commentBefore</span><span class="s1">) </span><span class="s2">item</span><span class="s1">.</span><span class="s2">spaceBefore </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">commentBefore</span><span class="s1">) </span><span class="s2">item</span><span class="s1">.</span><span class="s2">commentBefore </span><span class="s1">+= </span><span class="s0">'</span><span class="s3">\n</span><span class="s0">' </span><span class="s1">+ </span><span class="s2">comment</span><span class="s1">;</span><span class="s3">else </span><span class="s2">item</span><span class="s1">.</span><span class="s2">commentBefore </span><span class="s1">= </span><span class="s2">comment</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s6">// on error, will return { str: string, errors: Error[] }</span>
<span class="s3">function </span><span class="s2">resolveString</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">node</span><span class="s1">) {</span>
  <span class="s3">const </span><span class="s2">res </span><span class="s1">= </span><span class="s2">node</span><span class="s1">.</span><span class="s2">strValue</span><span class="s1">;</span>
  <span class="s3">if </span><span class="s1">(!</span><span class="s2">res</span><span class="s1">) </span><span class="s3">return </span><span class="s0">''</span><span class="s1">;</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">res </span><span class="s1">=== </span><span class="s0">'string'</span><span class="s1">) </span><span class="s3">return </span><span class="s2">res</span><span class="s1">;</span>
  <span class="s2">res</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">forEach</span><span class="s1">(</span><span class="s2">error </span><span class="s1">=&gt; {</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">error</span><span class="s1">.</span><span class="s2">source</span><span class="s1">) </span><span class="s2">error</span><span class="s1">.</span><span class="s2">source </span><span class="s1">= </span><span class="s2">node</span><span class="s1">;</span>
    <span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">error</span><span class="s1">);</span>
  <span class="s1">});</span>
  <span class="s3">return </span><span class="s2">res</span><span class="s1">.</span><span class="s2">str</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">resolveTagHandle</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">node</span><span class="s1">) {</span>
  <span class="s3">const </span><span class="s1">{</span>
    <span class="s2">handle</span><span class="s1">,</span>
    <span class="s2">suffix</span>
  <span class="s1">} = </span><span class="s2">node</span><span class="s1">.</span><span class="s2">tag</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">prefix </span><span class="s1">= </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">tagPrefixes</span><span class="s1">.</span><span class="s2">find</span><span class="s1">(</span><span class="s2">p </span><span class="s1">=&gt; </span><span class="s2">p</span><span class="s1">.</span><span class="s2">handle </span><span class="s1">=== </span><span class="s2">handle</span><span class="s1">);</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">prefix</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">dtp </span><span class="s1">= </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">getDefaults</span><span class="s1">().</span><span class="s2">tagPrefixes</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">dtp</span><span class="s1">) </span><span class="s2">prefix </span><span class="s1">= </span><span class="s2">dtp</span><span class="s1">.</span><span class="s2">find</span><span class="s1">(</span><span class="s2">p </span><span class="s1">=&gt; </span><span class="s2">p</span><span class="s1">.</span><span class="s2">handle </span><span class="s1">=== </span><span class="s2">handle</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">prefix</span><span class="s1">) </span><span class="s3">throw new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSemanticError</span><span class="s1">(</span><span class="s2">node</span><span class="s1">, </span><span class="s0">`The </span><span class="s2">$</span><span class="s1">{</span><span class="s2">handle</span><span class="s1">} </span><span class="s0">tag handle is non-default and was not declared.`</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">suffix</span><span class="s1">) </span><span class="s3">throw new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSemanticError</span><span class="s1">(</span><span class="s2">node</span><span class="s1">, </span><span class="s0">`The </span><span class="s2">$</span><span class="s1">{</span><span class="s2">handle</span><span class="s1">} </span><span class="s0">tag has no suffix.`</span><span class="s1">);</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">handle </span><span class="s1">=== </span><span class="s0">'!' </span><span class="s1">&amp;&amp; (</span><span class="s2">doc</span><span class="s1">.</span><span class="s2">version </span><span class="s1">|| </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">version</span><span class="s1">) === </span><span class="s0">'1.0'</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">suffix</span><span class="s1">[</span><span class="s5">0</span><span class="s1">] === </span><span class="s0">'^'</span><span class="s1">) {</span>
      <span class="s2">doc</span><span class="s1">.</span><span class="s2">warnings</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLWarning</span><span class="s1">(</span><span class="s2">node</span><span class="s1">, </span><span class="s0">'YAML 1.0 ^ tag expansion is not supported'</span><span class="s1">));</span>
      <span class="s3">return </span><span class="s2">suffix</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s4">/[:/]/</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">suffix</span><span class="s1">)) {</span>
      <span class="s6">// word/foo -&gt; tag:word.yaml.org,2002:foo</span>
      <span class="s3">const </span><span class="s2">vocab </span><span class="s1">= </span><span class="s2">suffix</span><span class="s1">.</span><span class="s2">match</span><span class="s1">(</span><span class="s4">/^([a-z0-9-]+)\/(.*)/i</span><span class="s1">);</span>
      <span class="s3">return </span><span class="s2">vocab </span><span class="s1">? </span><span class="s0">`tag:</span><span class="s2">$</span><span class="s1">{</span><span class="s2">vocab</span><span class="s1">[</span><span class="s5">1</span><span class="s1">]}</span><span class="s0">.yaml.org,2002:</span><span class="s2">$</span><span class="s1">{</span><span class="s2">vocab</span><span class="s1">[</span><span class="s5">2</span><span class="s1">]}</span><span class="s0">` </span><span class="s1">: </span><span class="s0">`tag:</span><span class="s2">$</span><span class="s1">{</span><span class="s2">suffix</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s2">prefix</span><span class="s1">.</span><span class="s2">prefix </span><span class="s1">+ </span><span class="s2">decodeURIComponent</span><span class="s1">(</span><span class="s2">suffix</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">resolveTagName</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">node</span><span class="s1">) {</span>
  <span class="s3">const </span><span class="s1">{</span>
    <span class="s2">tag</span><span class="s1">,</span>
    <span class="s2">type</span>
  <span class="s1">} = </span><span class="s2">node</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">nonSpecific </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">tag</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s1">{</span>
      <span class="s2">handle</span><span class="s1">,</span>
      <span class="s2">suffix</span><span class="s1">,</span>
      <span class="s2">verbatim</span>
    <span class="s1">} = </span><span class="s2">tag</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">verbatim</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">verbatim </span><span class="s1">!== </span><span class="s0">'!' </span><span class="s1">&amp;&amp; </span><span class="s2">verbatim </span><span class="s1">!== </span><span class="s0">'!!'</span><span class="s1">) </span><span class="s3">return </span><span class="s2">verbatim</span><span class="s1">;</span>
      <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">`Verbatim tags aren't resolved, so </span><span class="s2">$</span><span class="s1">{</span><span class="s2">verbatim</span><span class="s1">} </span><span class="s0">is invalid.`</span><span class="s1">;</span>
      <span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSemanticError</span><span class="s1">(</span><span class="s2">node</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">handle </span><span class="s1">=== </span><span class="s0">'!' </span><span class="s1">&amp;&amp; !</span><span class="s2">suffix</span><span class="s1">) {</span>
      <span class="s2">nonSpecific </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">try </span><span class="s1">{</span>
        <span class="s3">return </span><span class="s2">resolveTagHandle</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">node</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) {</span>
        <span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">error</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">switch </span><span class="s1">(</span><span class="s2">type</span><span class="s1">) {</span>
    <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">BLOCK_FOLDED</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">BLOCK_LITERAL</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">QUOTE_DOUBLE</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">QUOTE_SINGLE</span><span class="s1">:</span>
      <span class="s3">return </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">defaultTags</span><span class="s1">.</span><span class="s2">STR</span><span class="s1">;</span>

    <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">FLOW_MAP</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">MAP</span><span class="s1">:</span>
      <span class="s3">return </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">defaultTags</span><span class="s1">.</span><span class="s2">MAP</span><span class="s1">;</span>

    <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">FLOW_SEQ</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">SEQ</span><span class="s1">:</span>
      <span class="s3">return </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">defaultTags</span><span class="s1">.</span><span class="s2">SEQ</span><span class="s1">;</span>

    <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">PLAIN</span><span class="s1">:</span>
      <span class="s3">return </span><span class="s2">nonSpecific </span><span class="s1">? </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">defaultTags</span><span class="s1">.</span><span class="s2">STR </span><span class="s1">: </span><span class="s3">null</span><span class="s1">;</span>

    <span class="s3">default</span><span class="s1">:</span>
      <span class="s3">return null</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">resolveByTagName</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">node</span><span class="s1">, </span><span class="s2">tagName</span><span class="s1">) {</span>
  <span class="s3">const </span><span class="s1">{</span>
    <span class="s2">tags</span>
  <span class="s1">} = </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">;</span>
  <span class="s3">const </span><span class="s2">matchWithTest </span><span class="s1">= [];</span>

  <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">tag of tags</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">tag</span><span class="s1">.</span><span class="s2">tag </span><span class="s1">=== </span><span class="s2">tagName</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">tag</span><span class="s1">.</span><span class="s2">test</span><span class="s1">) </span><span class="s2">matchWithTest</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">tag</span><span class="s1">);</span><span class="s3">else </span><span class="s1">{</span>
        <span class="s3">const </span><span class="s2">res </span><span class="s1">= </span><span class="s2">tag</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">node</span><span class="s1">);</span>
        <span class="s3">return </span><span class="s2">res </span><span class="s3">instanceof </span><span class="s2">Collection </span><span class="s1">? </span><span class="s2">res </span><span class="s1">: </span><span class="s3">new </span><span class="s2">Scalar</span><span class="s1">(</span><span class="s2">res</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">const </span><span class="s2">str </span><span class="s1">= </span><span class="s2">resolveString</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">node</span><span class="s1">);</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">str </span><span class="s1">=== </span><span class="s0">'string' </span><span class="s1">&amp;&amp; </span><span class="s2">matchWithTest</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s5">0</span><span class="s1">) </span><span class="s3">return </span><span class="s2">resolveScalar</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">matchWithTest</span><span class="s1">, </span><span class="s2">tags</span><span class="s1">.</span><span class="s2">scalarFallback</span><span class="s1">);</span>
  <span class="s3">return null</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">getFallbackTagName</span><span class="s1">({</span>
  <span class="s2">type</span>
<span class="s1">}) {</span>
  <span class="s3">switch </span><span class="s1">(</span><span class="s2">type</span><span class="s1">) {</span>
    <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">FLOW_MAP</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">MAP</span><span class="s1">:</span>
      <span class="s3">return </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">defaultTags</span><span class="s1">.</span><span class="s2">MAP</span><span class="s1">;</span>

    <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">FLOW_SEQ</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">SEQ</span><span class="s1">:</span>
      <span class="s3">return </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">defaultTags</span><span class="s1">.</span><span class="s2">SEQ</span><span class="s1">;</span>

    <span class="s3">default</span><span class="s1">:</span>
      <span class="s3">return </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">defaultTags</span><span class="s1">.</span><span class="s2">STR</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">resolveTag</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">node</span><span class="s1">, </span><span class="s2">tagName</span><span class="s1">) {</span>
  <span class="s3">try </span><span class="s1">{</span>
    <span class="s3">const </span><span class="s2">res </span><span class="s1">= </span><span class="s2">resolveByTagName</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">node</span><span class="s1">, </span><span class="s2">tagName</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">res</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">tagName </span><span class="s1">&amp;&amp; </span><span class="s2">node</span><span class="s1">.</span><span class="s2">tag</span><span class="s1">) </span><span class="s2">res</span><span class="s1">.</span><span class="s2">tag </span><span class="s1">= </span><span class="s2">tagName</span><span class="s1">;</span>
      <span class="s3">return </span><span class="s2">res</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) {</span>
    <span class="s6">/* istanbul ignore if */</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">error</span><span class="s1">.</span><span class="s2">source</span><span class="s1">) </span><span class="s2">error</span><span class="s1">.</span><span class="s2">source </span><span class="s1">= </span><span class="s2">node</span><span class="s1">;</span>
    <span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">error</span><span class="s1">);</span>
    <span class="s3">return null</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">try </span><span class="s1">{</span>
    <span class="s3">const </span><span class="s2">fallback </span><span class="s1">= </span><span class="s2">getFallbackTagName</span><span class="s1">(</span><span class="s2">node</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">fallback</span><span class="s1">) </span><span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">`The tag </span><span class="s2">$</span><span class="s1">{</span><span class="s2">tagName</span><span class="s1">} </span><span class="s0">is unavailable`</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">`The tag </span><span class="s2">$</span><span class="s1">{</span><span class="s2">tagName</span><span class="s1">} </span><span class="s0">is unavailable, falling back to </span><span class="s2">$</span><span class="s1">{</span><span class="s2">fallback</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
    <span class="s2">doc</span><span class="s1">.</span><span class="s2">warnings</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLWarning</span><span class="s1">(</span><span class="s2">node</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">));</span>
    <span class="s3">const </span><span class="s2">res </span><span class="s1">= </span><span class="s2">resolveByTagName</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">node</span><span class="s1">, </span><span class="s2">fallback</span><span class="s1">);</span>
    <span class="s2">res</span><span class="s1">.</span><span class="s2">tag </span><span class="s1">= </span><span class="s2">tagName</span><span class="s1">;</span>
    <span class="s3">return </span><span class="s2">res</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">refError </span><span class="s1">= </span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLReferenceError</span><span class="s1">(</span><span class="s2">node</span><span class="s1">, </span><span class="s2">error</span><span class="s1">.</span><span class="s2">message</span><span class="s1">);</span>
    <span class="s2">refError</span><span class="s1">.</span><span class="s2">stack </span><span class="s1">= </span><span class="s2">error</span><span class="s1">.</span><span class="s2">stack</span><span class="s1">;</span>
    <span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">refError</span><span class="s1">);</span>
    <span class="s3">return null</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s3">const </span><span class="s2">isCollectionItem </span><span class="s1">= </span><span class="s2">node </span><span class="s1">=&gt; {</span>
  <span class="s3">if </span><span class="s1">(!</span><span class="s2">node</span><span class="s1">) </span><span class="s3">return false</span><span class="s1">;</span>
  <span class="s3">const </span><span class="s1">{</span>
    <span class="s2">type</span>
  <span class="s1">} = </span><span class="s2">node</span><span class="s1">;</span>
  <span class="s3">return </span><span class="s2">type </span><span class="s1">=== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">MAP_KEY </span><span class="s1">|| </span><span class="s2">type </span><span class="s1">=== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">MAP_VALUE </span><span class="s1">|| </span><span class="s2">type </span><span class="s1">=== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">SEQ_ITEM</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s3">function </span><span class="s2">resolveNodeProps</span><span class="s1">(</span><span class="s2">errors</span><span class="s1">, </span><span class="s2">node</span><span class="s1">) {</span>
  <span class="s3">const </span><span class="s2">comments </span><span class="s1">= {</span>
    <span class="s2">before</span><span class="s1">: [],</span>
    <span class="s2">after</span><span class="s1">: []</span>
  <span class="s1">};</span>
  <span class="s3">let </span><span class="s2">hasAnchor </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">hasTag </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
  <span class="s3">const </span><span class="s2">props </span><span class="s1">= </span><span class="s2">isCollectionItem</span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">context</span><span class="s1">.</span><span class="s2">parent</span><span class="s1">) ? </span><span class="s2">node</span><span class="s1">.</span><span class="s2">context</span><span class="s1">.</span><span class="s2">parent</span><span class="s1">.</span><span class="s2">props</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">props</span><span class="s1">) : </span><span class="s2">node</span><span class="s1">.</span><span class="s2">props</span><span class="s1">;</span>

  <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s1">{</span>
    <span class="s2">start</span><span class="s1">,</span>
    <span class="s2">end</span>
  <span class="s1">} </span><span class="s2">of props</span><span class="s1">) {</span>
    <span class="s3">switch </span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">context</span><span class="s1">.</span><span class="s2">src</span><span class="s1">[</span><span class="s2">start</span><span class="s1">]) {</span>
      <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Char</span><span class="s1">.</span><span class="s2">COMMENT</span><span class="s1">:</span>
        <span class="s1">{</span>
          <span class="s3">if </span><span class="s1">(!</span><span class="s2">node</span><span class="s1">.</span><span class="s2">commentHasRequiredWhitespace</span><span class="s1">(</span><span class="s2">start</span><span class="s1">)) {</span>
            <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">'Comments must be separated from other tokens by white space characters'</span><span class="s1">;</span>
            <span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSemanticError</span><span class="s1">(</span><span class="s2">node</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">));</span>
          <span class="s1">}</span>

          <span class="s3">const </span><span class="s1">{</span>
            <span class="s2">header</span><span class="s1">,</span>
            <span class="s2">valueRange</span>
          <span class="s1">} = </span><span class="s2">node</span><span class="s1">;</span>
          <span class="s3">const </span><span class="s2">cc </span><span class="s1">= </span><span class="s2">valueRange </span><span class="s1">&amp;&amp; (</span><span class="s2">start </span><span class="s1">&gt; </span><span class="s2">valueRange</span><span class="s1">.</span><span class="s2">start </span><span class="s1">|| </span><span class="s2">header </span><span class="s1">&amp;&amp; </span><span class="s2">start </span><span class="s1">&gt; </span><span class="s2">header</span><span class="s1">.</span><span class="s2">start</span><span class="s1">) ? </span><span class="s2">comments</span><span class="s1">.</span><span class="s2">after </span><span class="s1">: </span><span class="s2">comments</span><span class="s1">.</span><span class="s2">before</span><span class="s1">;</span>
          <span class="s2">cc</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">context</span><span class="s1">.</span><span class="s2">src</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">start </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">, </span><span class="s2">end</span><span class="s1">));</span>
          <span class="s3">break</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s6">// Actual anchor &amp; tag resolution is handled by schema, here we just complain</span>

      <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Char</span><span class="s1">.</span><span class="s2">ANCHOR</span><span class="s1">:</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">hasAnchor</span><span class="s1">) {</span>
          <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">'A node can have at most one anchor'</span><span class="s1">;</span>
          <span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSemanticError</span><span class="s1">(</span><span class="s2">node</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">));</span>
        <span class="s1">}</span>

        <span class="s2">hasAnchor </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Char</span><span class="s1">.</span><span class="s2">TAG</span><span class="s1">:</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">hasTag</span><span class="s1">) {</span>
          <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">'A node can have at most one tag'</span><span class="s1">;</span>
          <span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSemanticError</span><span class="s1">(</span><span class="s2">node</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">));</span>
        <span class="s1">}</span>

        <span class="s2">hasTag </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
        <span class="s3">break</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s1">{</span>
    <span class="s2">comments</span><span class="s1">,</span>
    <span class="s2">hasAnchor</span><span class="s1">,</span>
    <span class="s2">hasTag</span>
  <span class="s1">};</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">resolveNodeValue</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">node</span><span class="s1">) {</span>
  <span class="s3">const </span><span class="s1">{</span>
    <span class="s2">anchors</span><span class="s1">,</span>
    <span class="s2">errors</span><span class="s1">,</span>
    <span class="s2">schema</span>
  <span class="s1">} = </span><span class="s2">doc</span><span class="s1">;</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">ALIAS</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">name </span><span class="s1">= </span><span class="s2">node</span><span class="s1">.</span><span class="s2">rawValue</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">src </span><span class="s1">= </span><span class="s2">anchors</span><span class="s1">.</span><span class="s2">getNode</span><span class="s1">(</span><span class="s2">name</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(!</span><span class="s2">src</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">`Aliased anchor not found: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">name</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
      <span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLReferenceError</span><span class="s1">(</span><span class="s2">node</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">));</span>
      <span class="s3">return null</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s6">// Lazy resolution for circular references</span>


    <span class="s3">const </span><span class="s2">res </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Alias</span><span class="s1">(</span><span class="s2">src</span><span class="s1">);</span>

    <span class="s2">anchors</span><span class="s1">.</span><span class="s2">_cstAliases</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">res</span><span class="s1">);</span>

    <span class="s3">return </span><span class="s2">res</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">const </span><span class="s2">tagName </span><span class="s1">= </span><span class="s2">resolveTagName</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">node</span><span class="s1">);</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">tagName</span><span class="s1">) </span><span class="s3">return </span><span class="s2">resolveTag</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">node</span><span class="s1">, </span><span class="s2">tagName</span><span class="s1">);</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">type </span><span class="s1">!== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">PLAIN</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">`Failed to resolve </span><span class="s2">$</span><span class="s1">{</span><span class="s2">node</span><span class="s1">.</span><span class="s2">type</span><span class="s1">} </span><span class="s0">node here`</span><span class="s1">;</span>
    <span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSyntaxError</span><span class="s1">(</span><span class="s2">node</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">));</span>
    <span class="s3">return null</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">try </span><span class="s1">{</span>
    <span class="s3">const </span><span class="s2">str </span><span class="s1">= </span><span class="s2">resolveString</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">node</span><span class="s1">);</span>
    <span class="s3">return </span><span class="s2">resolveScalar</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">schema</span><span class="s1">.</span><span class="s2">tags</span><span class="s1">, </span><span class="s2">schema</span><span class="s1">.</span><span class="s2">tags</span><span class="s1">.</span><span class="s2">scalarFallback</span><span class="s1">);</span>
  <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">error</span><span class="s1">.</span><span class="s2">source</span><span class="s1">) </span><span class="s2">error</span><span class="s1">.</span><span class="s2">source </span><span class="s1">= </span><span class="s2">node</span><span class="s1">;</span>
    <span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">error</span><span class="s1">);</span>
    <span class="s3">return null</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">} </span><span class="s6">// sets node.resolved on success</span>


<span class="s3">function </span><span class="s2">resolveNode</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">node</span><span class="s1">) {</span>
  <span class="s3">if </span><span class="s1">(!</span><span class="s2">node</span><span class="s1">) </span><span class="s3">return null</span><span class="s1">;</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">error</span><span class="s1">) </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">error</span><span class="s1">);</span>
  <span class="s3">const </span><span class="s1">{</span>
    <span class="s2">comments</span><span class="s1">,</span>
    <span class="s2">hasAnchor</span><span class="s1">,</span>
    <span class="s2">hasTag</span>
  <span class="s1">} = </span><span class="s2">resolveNodeProps</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">, </span><span class="s2">node</span><span class="s1">);</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">hasAnchor</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s1">{</span>
      <span class="s2">anchors</span>
    <span class="s1">} = </span><span class="s2">doc</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">name </span><span class="s1">= </span><span class="s2">node</span><span class="s1">.</span><span class="s2">anchor</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">prev </span><span class="s1">= </span><span class="s2">anchors</span><span class="s1">.</span><span class="s2">getNode</span><span class="s1">(</span><span class="s2">name</span><span class="s1">); </span><span class="s6">// At this point, aliases for any preceding node with the same anchor</span>
    <span class="s6">// name have already been resolved, so it may safely be renamed.</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">prev</span><span class="s1">) </span><span class="s2">anchors</span><span class="s1">.</span><span class="s2">map</span><span class="s1">[</span><span class="s2">anchors</span><span class="s1">.</span><span class="s2">newName</span><span class="s1">(</span><span class="s2">name</span><span class="s1">)] = </span><span class="s2">prev</span><span class="s1">; </span><span class="s6">// During parsing, we need to store the CST node in anchors.map as</span>
    <span class="s6">// anchors need to be available during resolution to allow for</span>
    <span class="s6">// circular references.</span>

    <span class="s2">anchors</span><span class="s1">.</span><span class="s2">map</span><span class="s1">[</span><span class="s2">name</span><span class="s1">] = </span><span class="s2">node</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">ALIAS </span><span class="s1">&amp;&amp; (</span><span class="s2">hasAnchor </span><span class="s1">|| </span><span class="s2">hasTag</span><span class="s1">)) {</span>
    <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">'An alias node must not specify any properties'</span><span class="s1">;</span>
    <span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSemanticError</span><span class="s1">(</span><span class="s2">node</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">));</span>
  <span class="s1">}</span>

  <span class="s3">const </span><span class="s2">res </span><span class="s1">= </span><span class="s2">resolveNodeValue</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">node</span><span class="s1">);</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">res</span><span class="s1">) {</span>
    <span class="s2">res</span><span class="s1">.</span><span class="s2">range </span><span class="s1">= [</span><span class="s2">node</span><span class="s1">.</span><span class="s2">range</span><span class="s1">.</span><span class="s2">start</span><span class="s1">, </span><span class="s2">node</span><span class="s1">.</span><span class="s2">range</span><span class="s1">.</span><span class="s2">end</span><span class="s1">];</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">doc</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">keepCstNodes</span><span class="s1">) </span><span class="s2">res</span><span class="s1">.</span><span class="s2">cstNode </span><span class="s1">= </span><span class="s2">node</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">doc</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">keepNodeTypes</span><span class="s1">) </span><span class="s2">res</span><span class="s1">.</span><span class="s2">type </span><span class="s1">= </span><span class="s2">node</span><span class="s1">.</span><span class="s2">type</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">cb </span><span class="s1">= </span><span class="s2">comments</span><span class="s1">.</span><span class="s2">before</span><span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
      <span class="s2">res</span><span class="s1">.</span><span class="s2">commentBefore </span><span class="s1">= </span><span class="s2">res</span><span class="s1">.</span><span class="s2">commentBefore </span><span class="s1">? </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">res</span><span class="s1">.</span><span class="s2">commentBefore</span><span class="s1">}</span><span class="s3">\n</span><span class="s2">$</span><span class="s1">{</span><span class="s2">cb</span><span class="s1">}</span><span class="s0">` </span><span class="s1">: </span><span class="s2">cb</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">const </span><span class="s2">ca </span><span class="s1">= </span><span class="s2">comments</span><span class="s1">.</span><span class="s2">after</span><span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">ca</span><span class="s1">) </span><span class="s2">res</span><span class="s1">.</span><span class="s2">comment </span><span class="s1">= </span><span class="s2">res</span><span class="s1">.</span><span class="s2">comment </span><span class="s1">? </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">res</span><span class="s1">.</span><span class="s2">comment</span><span class="s1">}</span><span class="s3">\n</span><span class="s2">$</span><span class="s1">{</span><span class="s2">ca</span><span class="s1">}</span><span class="s0">` </span><span class="s1">: </span><span class="s2">ca</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s2">node</span><span class="s1">.</span><span class="s2">resolved </span><span class="s1">= </span><span class="s2">res</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">resolveMap</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">cst</span><span class="s1">) {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">cst</span><span class="s1">.</span><span class="s2">type </span><span class="s1">!== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">MAP </span><span class="s1">&amp;&amp; </span><span class="s2">cst</span><span class="s1">.</span><span class="s2">type </span><span class="s1">!== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">FLOW_MAP</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">`A </span><span class="s2">$</span><span class="s1">{</span><span class="s2">cst</span><span class="s1">.</span><span class="s2">type</span><span class="s1">} </span><span class="s0">node cannot be resolved as a mapping`</span><span class="s1">;</span>
    <span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSyntaxError</span><span class="s1">(</span><span class="s2">cst</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">));</span>
    <span class="s3">return null</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">const </span><span class="s1">{</span>
    <span class="s2">comments</span><span class="s1">,</span>
    <span class="s2">items</span>
  <span class="s1">} = </span><span class="s2">cst</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">FLOW_MAP </span><span class="s1">? </span><span class="s2">resolveFlowMapItems</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">cst</span><span class="s1">) : </span><span class="s2">resolveBlockMapItems</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">cst</span><span class="s1">);</span>
  <span class="s3">const </span><span class="s2">map </span><span class="s1">= </span><span class="s3">new </span><span class="s2">YAMLMap</span><span class="s1">();</span>
  <span class="s2">map</span><span class="s1">.</span><span class="s2">items </span><span class="s1">= </span><span class="s2">items</span><span class="s1">;</span>
  <span class="s2">resolveComments</span><span class="s1">(</span><span class="s2">map</span><span class="s1">, </span><span class="s2">comments</span><span class="s1">);</span>
  <span class="s3">let </span><span class="s2">hasCollectionKey </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>

  <span class="s3">for </span><span class="s1">(</span><span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s5">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">items</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; ++</span><span class="s2">i</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s1">{</span>
      <span class="s2">key</span><span class="s1">: </span><span class="s2">iKey</span>
    <span class="s1">} = </span><span class="s2">items</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">iKey </span><span class="s3">instanceof </span><span class="s2">Collection</span><span class="s1">) </span><span class="s2">hasCollectionKey </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">doc</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">.</span><span class="s2">merge </span><span class="s1">&amp;&amp; </span><span class="s2">iKey </span><span class="s1">&amp;&amp; </span><span class="s2">iKey</span><span class="s1">.</span><span class="s2">value </span><span class="s1">=== </span><span class="s2">MERGE_KEY</span><span class="s1">) {</span>
      <span class="s2">items</span><span class="s1">[</span><span class="s2">i</span><span class="s1">] = </span><span class="s3">new </span><span class="s2">Merge</span><span class="s1">(</span><span class="s2">items</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]);</span>
      <span class="s3">const </span><span class="s2">sources </span><span class="s1">= </span><span class="s2">items</span><span class="s1">[</span><span class="s2">i</span><span class="s1">].</span><span class="s2">value</span><span class="s1">.</span><span class="s2">items</span><span class="s1">;</span>
      <span class="s3">let </span><span class="s2">error </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
      <span class="s2">sources</span><span class="s1">.</span><span class="s2">some</span><span class="s1">(</span><span class="s2">node </span><span class="s1">=&gt; {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">node </span><span class="s3">instanceof </span><span class="s2">Alias</span><span class="s1">) {</span>
          <span class="s6">// During parsing, alias sources are CST nodes; to account for</span>
          <span class="s6">// circular references their resolved values can't be used here.</span>
          <span class="s3">const </span><span class="s1">{</span>
            <span class="s2">type</span>
          <span class="s1">} = </span><span class="s2">node</span><span class="s1">.</span><span class="s2">source</span><span class="s1">;</span>
          <span class="s3">if </span><span class="s1">(</span><span class="s2">type </span><span class="s1">=== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">MAP </span><span class="s1">|| </span><span class="s2">type </span><span class="s1">=== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">FLOW_MAP</span><span class="s1">) </span><span class="s3">return false</span><span class="s1">;</span>
          <span class="s3">return </span><span class="s2">error </span><span class="s1">= </span><span class="s0">'Merge nodes aliases can only point to maps'</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">return </span><span class="s2">error </span><span class="s1">= </span><span class="s0">'Merge nodes can only have Alias nodes as values'</span><span class="s1">;</span>
      <span class="s1">});</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSemanticError</span><span class="s1">(</span><span class="s2">cst</span><span class="s1">, </span><span class="s2">error</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">for </span><span class="s1">(</span><span class="s3">let </span><span class="s2">j </span><span class="s1">= </span><span class="s2">i </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">; </span><span class="s2">j </span><span class="s1">&lt; </span><span class="s2">items</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; ++</span><span class="s2">j</span><span class="s1">) {</span>
        <span class="s3">const </span><span class="s1">{</span>
          <span class="s2">key</span><span class="s1">: </span><span class="s2">jKey</span>
        <span class="s1">} = </span><span class="s2">items</span><span class="s1">[</span><span class="s2">j</span><span class="s1">];</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">iKey </span><span class="s1">=== </span><span class="s2">jKey </span><span class="s1">|| </span><span class="s2">iKey </span><span class="s1">&amp;&amp; </span><span class="s2">jKey </span><span class="s1">&amp;&amp; </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">hasOwnProperty</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s2">iKey</span><span class="s1">, </span><span class="s0">'value'</span><span class="s1">) &amp;&amp; </span><span class="s2">iKey</span><span class="s1">.</span><span class="s2">value </span><span class="s1">=== </span><span class="s2">jKey</span><span class="s1">.</span><span class="s2">value</span><span class="s1">) {</span>
          <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">`Map keys must be unique; &quot;</span><span class="s2">$</span><span class="s1">{</span><span class="s2">iKey</span><span class="s1">}</span><span class="s0">&quot; is repeated`</span><span class="s1">;</span>
          <span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSemanticError</span><span class="s1">(</span><span class="s2">cst</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">));</span>
          <span class="s3">break</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">hasCollectionKey </span><span class="s1">&amp;&amp; !</span><span class="s2">doc</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">mapAsMap</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">warn </span><span class="s1">= </span><span class="s0">'Keys with collection values will be stringified as YAML due to JS Object restrictions. Use mapAsMap: true to avoid this.'</span><span class="s1">;</span>
    <span class="s2">doc</span><span class="s1">.</span><span class="s2">warnings</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLWarning</span><span class="s1">(</span><span class="s2">cst</span><span class="s1">, </span><span class="s2">warn</span><span class="s1">));</span>
  <span class="s1">}</span>

  <span class="s2">cst</span><span class="s1">.</span><span class="s2">resolved </span><span class="s1">= </span><span class="s2">map</span><span class="s1">;</span>
  <span class="s3">return </span><span class="s2">map</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">const </span><span class="s2">valueHasPairComment </span><span class="s1">= ({</span>
  <span class="s2">context</span><span class="s1">: {</span>
    <span class="s2">lineStart</span><span class="s1">,</span>
    <span class="s2">node</span><span class="s1">,</span>
    <span class="s2">src</span>
  <span class="s1">},</span>
  <span class="s2">props</span>
<span class="s1">}) =&gt; {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">props</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s5">0</span><span class="s1">) </span><span class="s3">return false</span><span class="s1">;</span>
  <span class="s3">const </span><span class="s1">{</span>
    <span class="s2">start</span>
  <span class="s1">} = </span><span class="s2">props</span><span class="s1">[</span><span class="s5">0</span><span class="s1">];</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">node </span><span class="s1">&amp;&amp; </span><span class="s2">start </span><span class="s1">&gt; </span><span class="s2">node</span><span class="s1">.</span><span class="s2">valueRange</span><span class="s1">.</span><span class="s2">start</span><span class="s1">) </span><span class="s3">return false</span><span class="s1">;</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">src</span><span class="s1">[</span><span class="s2">start</span><span class="s1">] !== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Char</span><span class="s1">.</span><span class="s2">COMMENT</span><span class="s1">) </span><span class="s3">return false</span><span class="s1">;</span>

  <span class="s3">for </span><span class="s1">(</span><span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s2">lineStart</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">start</span><span class="s1">; ++</span><span class="s2">i</span><span class="s1">) </span><span class="s3">if </span><span class="s1">(</span><span class="s2">src</span><span class="s1">[</span><span class="s2">i</span><span class="s1">] === </span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">) </span><span class="s3">return false</span><span class="s1">;</span>

  <span class="s3">return true</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s3">function </span><span class="s2">resolvePairComment</span><span class="s1">(</span><span class="s2">item</span><span class="s1">, </span><span class="s2">pair</span><span class="s1">) {</span>
  <span class="s3">if </span><span class="s1">(!</span><span class="s2">valueHasPairComment</span><span class="s1">(</span><span class="s2">item</span><span class="s1">)) </span><span class="s3">return</span><span class="s1">;</span>
  <span class="s3">const </span><span class="s2">comment </span><span class="s1">= </span><span class="s2">item</span><span class="s1">.</span><span class="s2">getPropValue</span><span class="s1">(</span><span class="s5">0</span><span class="s1">, </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Char</span><span class="s1">.</span><span class="s2">COMMENT</span><span class="s1">, </span><span class="s3">true</span><span class="s1">);</span>
  <span class="s3">let </span><span class="s2">found </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
  <span class="s3">const </span><span class="s2">cb </span><span class="s1">= </span><span class="s2">pair</span><span class="s1">.</span><span class="s2">value</span><span class="s1">.</span><span class="s2">commentBefore</span><span class="s1">;</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">cb </span><span class="s1">&amp;&amp; </span><span class="s2">cb</span><span class="s1">.</span><span class="s2">startsWith</span><span class="s1">(</span><span class="s2">comment</span><span class="s1">)) {</span>
    <span class="s2">pair</span><span class="s1">.</span><span class="s2">value</span><span class="s1">.</span><span class="s2">commentBefore </span><span class="s1">= </span><span class="s2">cb</span><span class="s1">.</span><span class="s2">substr</span><span class="s1">(</span><span class="s2">comment</span><span class="s1">.</span><span class="s2">length </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">);</span>
    <span class="s2">found </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s3">const </span><span class="s2">cc </span><span class="s1">= </span><span class="s2">pair</span><span class="s1">.</span><span class="s2">value</span><span class="s1">.</span><span class="s2">comment</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(!</span><span class="s2">item</span><span class="s1">.</span><span class="s2">node </span><span class="s1">&amp;&amp; </span><span class="s2">cc </span><span class="s1">&amp;&amp; </span><span class="s2">cc</span><span class="s1">.</span><span class="s2">startsWith</span><span class="s1">(</span><span class="s2">comment</span><span class="s1">)) {</span>
      <span class="s2">pair</span><span class="s1">.</span><span class="s2">value</span><span class="s1">.</span><span class="s2">comment </span><span class="s1">= </span><span class="s2">cc</span><span class="s1">.</span><span class="s2">substr</span><span class="s1">(</span><span class="s2">comment</span><span class="s1">.</span><span class="s2">length </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">);</span>
      <span class="s2">found </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">found</span><span class="s1">) </span><span class="s2">pair</span><span class="s1">.</span><span class="s2">comment </span><span class="s1">= </span><span class="s2">comment</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">resolveBlockMapItems</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">cst</span><span class="s1">) {</span>
  <span class="s3">const </span><span class="s2">comments </span><span class="s1">= [];</span>
  <span class="s3">const </span><span class="s2">items </span><span class="s1">= [];</span>
  <span class="s3">let </span><span class="s2">key </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">keyStart </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>

  <span class="s3">for </span><span class="s1">(</span><span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s5">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">cst</span><span class="s1">.</span><span class="s2">items</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; ++</span><span class="s2">i</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">item </span><span class="s1">= </span><span class="s2">cst</span><span class="s1">.</span><span class="s2">items</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>

    <span class="s3">switch </span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">type</span><span class="s1">) {</span>
      <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">BLANK_LINE</span><span class="s1">:</span>
        <span class="s2">comments</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({</span>
          <span class="s2">afterKey</span><span class="s1">: !!</span><span class="s2">key</span><span class="s1">,</span>
          <span class="s2">before</span><span class="s1">: </span><span class="s2">items</span><span class="s1">.</span><span class="s2">length</span>
        <span class="s1">});</span>
        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">COMMENT</span><span class="s1">:</span>
        <span class="s2">comments</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({</span>
          <span class="s2">afterKey</span><span class="s1">: !!</span><span class="s2">key</span><span class="s1">,</span>
          <span class="s2">before</span><span class="s1">: </span><span class="s2">items</span><span class="s1">.</span><span class="s2">length</span><span class="s1">,</span>
          <span class="s2">comment</span><span class="s1">: </span><span class="s2">item</span><span class="s1">.</span><span class="s2">comment</span>
        <span class="s1">});</span>
        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">MAP_KEY</span><span class="s1">:</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">key </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) </span><span class="s2">items</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">Pair</span><span class="s1">(</span><span class="s2">key</span><span class="s1">));</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">error</span><span class="s1">) </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">error</span><span class="s1">);</span>
        <span class="s2">key </span><span class="s1">= </span><span class="s2">resolveNode</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">item</span><span class="s1">.</span><span class="s2">node</span><span class="s1">);</span>
        <span class="s2">keyStart </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">MAP_VALUE</span><span class="s1">:</span>
        <span class="s1">{</span>
          <span class="s3">if </span><span class="s1">(</span><span class="s2">key </span><span class="s1">=== </span><span class="s2">undefined</span><span class="s1">) </span><span class="s2">key </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
          <span class="s3">if </span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">error</span><span class="s1">) </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">error</span><span class="s1">);</span>

          <span class="s3">if </span><span class="s1">(!</span><span class="s2">item</span><span class="s1">.</span><span class="s2">context</span><span class="s1">.</span><span class="s2">atLineStart </span><span class="s1">&amp;&amp; </span><span class="s2">item</span><span class="s1">.</span><span class="s2">node </span><span class="s1">&amp;&amp; </span><span class="s2">item</span><span class="s1">.</span><span class="s2">node</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">MAP </span><span class="s1">&amp;&amp; !</span><span class="s2">item</span><span class="s1">.</span><span class="s2">node</span><span class="s1">.</span><span class="s2">context</span><span class="s1">.</span><span class="s2">atLineStart</span><span class="s1">) {</span>
            <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">'Nested mappings are not allowed in compact mappings'</span><span class="s1">;</span>
            <span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSemanticError</span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">node</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">));</span>
          <span class="s1">}</span>

          <span class="s3">let </span><span class="s2">valueNode </span><span class="s1">= </span><span class="s2">item</span><span class="s1">.</span><span class="s2">node</span><span class="s1">;</span>

          <span class="s3">if </span><span class="s1">(!</span><span class="s2">valueNode </span><span class="s1">&amp;&amp; </span><span class="s2">item</span><span class="s1">.</span><span class="s2">props</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s5">0</span><span class="s1">) {</span>
            <span class="s6">// Comments on an empty mapping value need to be preserved, so we</span>
            <span class="s6">// need to construct a minimal empty node here to use instead of the</span>
            <span class="s6">// missing `item.node`. -- eemeli/yaml#19</span>
            <span class="s2">valueNode </span><span class="s1">= </span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">PlainValue</span><span class="s1">(</span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">PLAIN</span><span class="s1">, []);</span>
            <span class="s2">valueNode</span><span class="s1">.</span><span class="s2">context </span><span class="s1">= {</span>
              <span class="s2">parent</span><span class="s1">: </span><span class="s2">item</span><span class="s1">,</span>
              <span class="s2">src</span><span class="s1">: </span><span class="s2">item</span><span class="s1">.</span><span class="s2">context</span><span class="s1">.</span><span class="s2">src</span>
            <span class="s1">};</span>
            <span class="s3">const </span><span class="s2">pos </span><span class="s1">= </span><span class="s2">item</span><span class="s1">.</span><span class="s2">range</span><span class="s1">.</span><span class="s2">start </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">;</span>
            <span class="s2">valueNode</span><span class="s1">.</span><span class="s2">range </span><span class="s1">= {</span>
              <span class="s2">start</span><span class="s1">: </span><span class="s2">pos</span><span class="s1">,</span>
              <span class="s2">end</span><span class="s1">: </span><span class="s2">pos</span>
            <span class="s1">};</span>
            <span class="s2">valueNode</span><span class="s1">.</span><span class="s2">valueRange </span><span class="s1">= {</span>
              <span class="s2">start</span><span class="s1">: </span><span class="s2">pos</span><span class="s1">,</span>
              <span class="s2">end</span><span class="s1">: </span><span class="s2">pos</span>
            <span class="s1">};</span>

            <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">item</span><span class="s1">.</span><span class="s2">range</span><span class="s1">.</span><span class="s2">origStart </span><span class="s1">=== </span><span class="s0">'number'</span><span class="s1">) {</span>
              <span class="s3">const </span><span class="s2">origPos </span><span class="s1">= </span><span class="s2">item</span><span class="s1">.</span><span class="s2">range</span><span class="s1">.</span><span class="s2">origStart </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">;</span>
              <span class="s2">valueNode</span><span class="s1">.</span><span class="s2">range</span><span class="s1">.</span><span class="s2">origStart </span><span class="s1">= </span><span class="s2">valueNode</span><span class="s1">.</span><span class="s2">range</span><span class="s1">.</span><span class="s2">origEnd </span><span class="s1">= </span><span class="s2">origPos</span><span class="s1">;</span>
              <span class="s2">valueNode</span><span class="s1">.</span><span class="s2">valueRange</span><span class="s1">.</span><span class="s2">origStart </span><span class="s1">= </span><span class="s2">valueNode</span><span class="s1">.</span><span class="s2">valueRange</span><span class="s1">.</span><span class="s2">origEnd </span><span class="s1">= </span><span class="s2">origPos</span><span class="s1">;</span>
            <span class="s1">}</span>
          <span class="s1">}</span>

          <span class="s3">const </span><span class="s2">pair </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Pair</span><span class="s1">(</span><span class="s2">key</span><span class="s1">, </span><span class="s2">resolveNode</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">valueNode</span><span class="s1">));</span>
          <span class="s2">resolvePairComment</span><span class="s1">(</span><span class="s2">item</span><span class="s1">, </span><span class="s2">pair</span><span class="s1">);</span>
          <span class="s2">items</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">pair</span><span class="s1">);</span>

          <span class="s3">if </span><span class="s1">(</span><span class="s2">key </span><span class="s1">&amp;&amp; </span><span class="s3">typeof </span><span class="s2">keyStart </span><span class="s1">=== </span><span class="s0">'number'</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">range</span><span class="s1">.</span><span class="s2">start </span><span class="s1">&gt; </span><span class="s2">keyStart </span><span class="s1">+ </span><span class="s5">1024</span><span class="s1">) </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">getLongKeyError</span><span class="s1">(</span><span class="s2">cst</span><span class="s1">, </span><span class="s2">key</span><span class="s1">));</span>
          <span class="s1">}</span>

          <span class="s2">key </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
          <span class="s2">keyStart </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">default</span><span class="s1">:</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">key </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) </span><span class="s2">items</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">Pair</span><span class="s1">(</span><span class="s2">key</span><span class="s1">));</span>
        <span class="s2">key </span><span class="s1">= </span><span class="s2">resolveNode</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">item</span><span class="s1">);</span>
        <span class="s2">keyStart </span><span class="s1">= </span><span class="s2">item</span><span class="s1">.</span><span class="s2">range</span><span class="s1">.</span><span class="s2">start</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">error</span><span class="s1">) </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">error</span><span class="s1">);</span>

        <span class="s2">next</span><span class="s1">: </span><span class="s3">for </span><span class="s1">(</span><span class="s3">let </span><span class="s2">j </span><span class="s1">= </span><span class="s2">i </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">;; ++</span><span class="s2">j</span><span class="s1">) {</span>
          <span class="s3">const </span><span class="s2">nextItem </span><span class="s1">= </span><span class="s2">cst</span><span class="s1">.</span><span class="s2">items</span><span class="s1">[</span><span class="s2">j</span><span class="s1">];</span>

          <span class="s3">switch </span><span class="s1">(</span><span class="s2">nextItem </span><span class="s1">&amp;&amp; </span><span class="s2">nextItem</span><span class="s1">.</span><span class="s2">type</span><span class="s1">) {</span>
            <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">BLANK_LINE</span><span class="s1">:</span>
            <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">COMMENT</span><span class="s1">:</span>
              <span class="s3">continue </span><span class="s2">next</span><span class="s1">;</span>

            <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">MAP_VALUE</span><span class="s1">:</span>
              <span class="s3">break </span><span class="s2">next</span><span class="s1">;</span>

            <span class="s3">default</span><span class="s1">:</span>
              <span class="s1">{</span>
                <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">'Implicit map keys need to be followed by map values'</span><span class="s1">;</span>
                <span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSemanticError</span><span class="s1">(</span><span class="s2">item</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">));</span>
                <span class="s3">break </span><span class="s2">next</span><span class="s1">;</span>
              <span class="s1">}</span>
          <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">valueRangeContainsNewline</span><span class="s1">) {</span>
          <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">'Implicit map keys need to be on a single line'</span><span class="s1">;</span>
          <span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSemanticError</span><span class="s1">(</span><span class="s2">item</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">));</span>
        <span class="s1">}</span>

    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">key </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) </span><span class="s2">items</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">Pair</span><span class="s1">(</span><span class="s2">key</span><span class="s1">));</span>
  <span class="s3">return </span><span class="s1">{</span>
    <span class="s2">comments</span><span class="s1">,</span>
    <span class="s2">items</span>
  <span class="s1">};</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">resolveFlowMapItems</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">cst</span><span class="s1">) {</span>
  <span class="s3">const </span><span class="s2">comments </span><span class="s1">= [];</span>
  <span class="s3">const </span><span class="s2">items </span><span class="s1">= [];</span>
  <span class="s3">let </span><span class="s2">key </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">explicitKey </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">next </span><span class="s1">= </span><span class="s0">'{'</span><span class="s1">;</span>

  <span class="s3">for </span><span class="s1">(</span><span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s5">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">cst</span><span class="s1">.</span><span class="s2">items</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; ++</span><span class="s2">i</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">item </span><span class="s1">= </span><span class="s2">cst</span><span class="s1">.</span><span class="s2">items</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">item</span><span class="s1">.</span><span class="s2">char </span><span class="s1">=== </span><span class="s0">'string'</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s1">{</span>
        <span class="s2">char</span><span class="s1">,</span>
        <span class="s2">offset</span>
      <span class="s1">} = </span><span class="s2">item</span><span class="s1">;</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">char </span><span class="s1">=== </span><span class="s0">'?' </span><span class="s1">&amp;&amp; </span><span class="s2">key </span><span class="s1">=== </span><span class="s2">undefined </span><span class="s1">&amp;&amp; !</span><span class="s2">explicitKey</span><span class="s1">) {</span>
        <span class="s2">explicitKey </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
        <span class="s2">next </span><span class="s1">= </span><span class="s0">':'</span><span class="s1">;</span>
        <span class="s3">continue</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">char </span><span class="s1">=== </span><span class="s0">':'</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">key </span><span class="s1">=== </span><span class="s2">undefined</span><span class="s1">) </span><span class="s2">key </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">next </span><span class="s1">=== </span><span class="s0">':'</span><span class="s1">) {</span>
          <span class="s2">next </span><span class="s1">= </span><span class="s0">','</span><span class="s1">;</span>
          <span class="s3">continue</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">explicitKey</span><span class="s1">) {</span>
          <span class="s3">if </span><span class="s1">(</span><span class="s2">key </span><span class="s1">=== </span><span class="s2">undefined </span><span class="s1">&amp;&amp; </span><span class="s2">char </span><span class="s1">!== </span><span class="s0">','</span><span class="s1">) </span><span class="s2">key </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
          <span class="s2">explicitKey </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">key </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) {</span>
          <span class="s2">items</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">Pair</span><span class="s1">(</span><span class="s2">key</span><span class="s1">));</span>
          <span class="s2">key </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>

          <span class="s3">if </span><span class="s1">(</span><span class="s2">char </span><span class="s1">=== </span><span class="s0">','</span><span class="s1">) {</span>
            <span class="s2">next </span><span class="s1">= </span><span class="s0">':'</span><span class="s1">;</span>
            <span class="s3">continue</span><span class="s1">;</span>
          <span class="s1">}</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">char </span><span class="s1">=== </span><span class="s0">'}'</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">i </span><span class="s1">=== </span><span class="s2">cst</span><span class="s1">.</span><span class="s2">items</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s5">1</span><span class="s1">) </span><span class="s3">continue</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">char </span><span class="s1">=== </span><span class="s2">next</span><span class="s1">) {</span>
        <span class="s2">next </span><span class="s1">= </span><span class="s0">':'</span><span class="s1">;</span>
        <span class="s3">continue</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">`Flow map contains an unexpected </span><span class="s2">$</span><span class="s1">{</span><span class="s2">char</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
      <span class="s3">const </span><span class="s2">err </span><span class="s1">= </span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSyntaxError</span><span class="s1">(</span><span class="s2">cst</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">);</span>
      <span class="s2">err</span><span class="s1">.</span><span class="s2">offset </span><span class="s1">= </span><span class="s2">offset</span><span class="s1">;</span>
      <span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">BLANK_LINE</span><span class="s1">) {</span>
      <span class="s2">comments</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({</span>
        <span class="s2">afterKey</span><span class="s1">: !!</span><span class="s2">key</span><span class="s1">,</span>
        <span class="s2">before</span><span class="s1">: </span><span class="s2">items</span><span class="s1">.</span><span class="s2">length</span>
      <span class="s1">});</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">COMMENT</span><span class="s1">) {</span>
      <span class="s2">checkFlowCommentSpace</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">, </span><span class="s2">item</span><span class="s1">);</span>
      <span class="s2">comments</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({</span>
        <span class="s2">afterKey</span><span class="s1">: !!</span><span class="s2">key</span><span class="s1">,</span>
        <span class="s2">before</span><span class="s1">: </span><span class="s2">items</span><span class="s1">.</span><span class="s2">length</span><span class="s1">,</span>
        <span class="s2">comment</span><span class="s1">: </span><span class="s2">item</span><span class="s1">.</span><span class="s2">comment</span>
      <span class="s1">});</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">key </span><span class="s1">=== </span><span class="s2">undefined</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">next </span><span class="s1">=== </span><span class="s0">','</span><span class="s1">) </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSemanticError</span><span class="s1">(</span><span class="s2">item</span><span class="s1">, </span><span class="s0">'Separator , missing in flow map'</span><span class="s1">));</span>
      <span class="s2">key </span><span class="s1">= </span><span class="s2">resolveNode</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">item</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">next </span><span class="s1">!== </span><span class="s0">','</span><span class="s1">) </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSemanticError</span><span class="s1">(</span><span class="s2">item</span><span class="s1">, </span><span class="s0">'Indicator : missing in flow map entry'</span><span class="s1">));</span>
      <span class="s2">items</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">Pair</span><span class="s1">(</span><span class="s2">key</span><span class="s1">, </span><span class="s2">resolveNode</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">item</span><span class="s1">)));</span>
      <span class="s2">key </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
      <span class="s2">explicitKey </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">checkFlowCollectionEnd</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">, </span><span class="s2">cst</span><span class="s1">);</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">key </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) </span><span class="s2">items</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">Pair</span><span class="s1">(</span><span class="s2">key</span><span class="s1">));</span>
  <span class="s3">return </span><span class="s1">{</span>
    <span class="s2">comments</span><span class="s1">,</span>
    <span class="s2">items</span>
  <span class="s1">};</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">resolveSeq</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">cst</span><span class="s1">) {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">cst</span><span class="s1">.</span><span class="s2">type </span><span class="s1">!== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">SEQ </span><span class="s1">&amp;&amp; </span><span class="s2">cst</span><span class="s1">.</span><span class="s2">type </span><span class="s1">!== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">FLOW_SEQ</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">`A </span><span class="s2">$</span><span class="s1">{</span><span class="s2">cst</span><span class="s1">.</span><span class="s2">type</span><span class="s1">} </span><span class="s0">node cannot be resolved as a sequence`</span><span class="s1">;</span>
    <span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSyntaxError</span><span class="s1">(</span><span class="s2">cst</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">));</span>
    <span class="s3">return null</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">const </span><span class="s1">{</span>
    <span class="s2">comments</span><span class="s1">,</span>
    <span class="s2">items</span>
  <span class="s1">} = </span><span class="s2">cst</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">FLOW_SEQ </span><span class="s1">? </span><span class="s2">resolveFlowSeqItems</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">cst</span><span class="s1">) : </span><span class="s2">resolveBlockSeqItems</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">cst</span><span class="s1">);</span>
  <span class="s3">const </span><span class="s2">seq </span><span class="s1">= </span><span class="s3">new </span><span class="s2">YAMLSeq</span><span class="s1">();</span>
  <span class="s2">seq</span><span class="s1">.</span><span class="s2">items </span><span class="s1">= </span><span class="s2">items</span><span class="s1">;</span>
  <span class="s2">resolveComments</span><span class="s1">(</span><span class="s2">seq</span><span class="s1">, </span><span class="s2">comments</span><span class="s1">);</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">doc</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">mapAsMap </span><span class="s1">&amp;&amp; </span><span class="s2">items</span><span class="s1">.</span><span class="s2">some</span><span class="s1">(</span><span class="s2">it </span><span class="s1">=&gt; </span><span class="s2">it </span><span class="s3">instanceof </span><span class="s2">Pair </span><span class="s1">&amp;&amp; </span><span class="s2">it</span><span class="s1">.</span><span class="s2">key </span><span class="s3">instanceof </span><span class="s2">Collection</span><span class="s1">)) {</span>
    <span class="s3">const </span><span class="s2">warn </span><span class="s1">= </span><span class="s0">'Keys with collection values will be stringified as YAML due to JS Object restrictions. Use mapAsMap: true to avoid this.'</span><span class="s1">;</span>
    <span class="s2">doc</span><span class="s1">.</span><span class="s2">warnings</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLWarning</span><span class="s1">(</span><span class="s2">cst</span><span class="s1">, </span><span class="s2">warn</span><span class="s1">));</span>
  <span class="s1">}</span>

  <span class="s2">cst</span><span class="s1">.</span><span class="s2">resolved </span><span class="s1">= </span><span class="s2">seq</span><span class="s1">;</span>
  <span class="s3">return </span><span class="s2">seq</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">resolveBlockSeqItems</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">cst</span><span class="s1">) {</span>
  <span class="s3">const </span><span class="s2">comments </span><span class="s1">= [];</span>
  <span class="s3">const </span><span class="s2">items </span><span class="s1">= [];</span>

  <span class="s3">for </span><span class="s1">(</span><span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s5">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">cst</span><span class="s1">.</span><span class="s2">items</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; ++</span><span class="s2">i</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">item </span><span class="s1">= </span><span class="s2">cst</span><span class="s1">.</span><span class="s2">items</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>

    <span class="s3">switch </span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">type</span><span class="s1">) {</span>
      <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">BLANK_LINE</span><span class="s1">:</span>
        <span class="s2">comments</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({</span>
          <span class="s2">before</span><span class="s1">: </span><span class="s2">items</span><span class="s1">.</span><span class="s2">length</span>
        <span class="s1">});</span>
        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">COMMENT</span><span class="s1">:</span>
        <span class="s2">comments</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({</span>
          <span class="s2">comment</span><span class="s1">: </span><span class="s2">item</span><span class="s1">.</span><span class="s2">comment</span><span class="s1">,</span>
          <span class="s2">before</span><span class="s1">: </span><span class="s2">items</span><span class="s1">.</span><span class="s2">length</span>
        <span class="s1">});</span>
        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">case </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">SEQ_ITEM</span><span class="s1">:</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">error</span><span class="s1">) </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">error</span><span class="s1">);</span>
        <span class="s2">items</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">resolveNode</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">item</span><span class="s1">.</span><span class="s2">node</span><span class="s1">));</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">hasProps</span><span class="s1">) {</span>
          <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">'Sequence items cannot have tags or anchors before the - indicator'</span><span class="s1">;</span>
          <span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSemanticError</span><span class="s1">(</span><span class="s2">item</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">));</span>
        <span class="s1">}</span>

        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">default</span><span class="s1">:</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">error</span><span class="s1">) </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">error</span><span class="s1">);</span>
        <span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSyntaxError</span><span class="s1">(</span><span class="s2">item</span><span class="s1">, </span><span class="s0">`Unexpected </span><span class="s2">$</span><span class="s1">{</span><span class="s2">item</span><span class="s1">.</span><span class="s2">type</span><span class="s1">} </span><span class="s0">node in sequence`</span><span class="s1">));</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s1">{</span>
    <span class="s2">comments</span><span class="s1">,</span>
    <span class="s2">items</span>
  <span class="s1">};</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">resolveFlowSeqItems</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">cst</span><span class="s1">) {</span>
  <span class="s3">const </span><span class="s2">comments </span><span class="s1">= [];</span>
  <span class="s3">const </span><span class="s2">items </span><span class="s1">= [];</span>
  <span class="s3">let </span><span class="s2">explicitKey </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">key </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">keyStart </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">next </span><span class="s1">= </span><span class="s0">'['</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">prevItem </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>

  <span class="s3">for </span><span class="s1">(</span><span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s5">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">cst</span><span class="s1">.</span><span class="s2">items</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; ++</span><span class="s2">i</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">item </span><span class="s1">= </span><span class="s2">cst</span><span class="s1">.</span><span class="s2">items</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">item</span><span class="s1">.</span><span class="s2">char </span><span class="s1">=== </span><span class="s0">'string'</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s1">{</span>
        <span class="s2">char</span><span class="s1">,</span>
        <span class="s2">offset</span>
      <span class="s1">} = </span><span class="s2">item</span><span class="s1">;</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">char </span><span class="s1">!== </span><span class="s0">':' </span><span class="s1">&amp;&amp; (</span><span class="s2">explicitKey </span><span class="s1">|| </span><span class="s2">key </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">)) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">explicitKey </span><span class="s1">&amp;&amp; </span><span class="s2">key </span><span class="s1">=== </span><span class="s2">undefined</span><span class="s1">) </span><span class="s2">key </span><span class="s1">= </span><span class="s2">next </span><span class="s1">? </span><span class="s2">items</span><span class="s1">.</span><span class="s2">pop</span><span class="s1">() : </span><span class="s3">null</span><span class="s1">;</span>
        <span class="s2">items</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">Pair</span><span class="s1">(</span><span class="s2">key</span><span class="s1">));</span>
        <span class="s2">explicitKey </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
        <span class="s2">key </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
        <span class="s2">keyStart </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">char </span><span class="s1">=== </span><span class="s2">next</span><span class="s1">) {</span>
        <span class="s2">next </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s3">else if </span><span class="s1">(!</span><span class="s2">next </span><span class="s1">&amp;&amp; </span><span class="s2">char </span><span class="s1">=== </span><span class="s0">'?'</span><span class="s1">) {</span>
        <span class="s2">explicitKey </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">next </span><span class="s1">!== </span><span class="s0">'[' </span><span class="s1">&amp;&amp; </span><span class="s2">char </span><span class="s1">=== </span><span class="s0">':' </span><span class="s1">&amp;&amp; </span><span class="s2">key </span><span class="s1">=== </span><span class="s2">undefined</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">next </span><span class="s1">=== </span><span class="s0">','</span><span class="s1">) {</span>
          <span class="s2">key </span><span class="s1">= </span><span class="s2">items</span><span class="s1">.</span><span class="s2">pop</span><span class="s1">();</span>

          <span class="s3">if </span><span class="s1">(</span><span class="s2">key </span><span class="s3">instanceof </span><span class="s2">Pair</span><span class="s1">) {</span>
            <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">'Chaining flow sequence pairs is invalid'</span><span class="s1">;</span>
            <span class="s3">const </span><span class="s2">err </span><span class="s1">= </span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSemanticError</span><span class="s1">(</span><span class="s2">cst</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">);</span>
            <span class="s2">err</span><span class="s1">.</span><span class="s2">offset </span><span class="s1">= </span><span class="s2">offset</span><span class="s1">;</span>
            <span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
          <span class="s1">}</span>

          <span class="s3">if </span><span class="s1">(!</span><span class="s2">explicitKey </span><span class="s1">&amp;&amp; </span><span class="s3">typeof </span><span class="s2">keyStart </span><span class="s1">=== </span><span class="s0">'number'</span><span class="s1">) {</span>
            <span class="s3">const </span><span class="s2">keyEnd </span><span class="s1">= </span><span class="s2">item</span><span class="s1">.</span><span class="s2">range </span><span class="s1">? </span><span class="s2">item</span><span class="s1">.</span><span class="s2">range</span><span class="s1">.</span><span class="s2">start </span><span class="s1">: </span><span class="s2">item</span><span class="s1">.</span><span class="s2">offset</span><span class="s1">;</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">keyEnd </span><span class="s1">&gt; </span><span class="s2">keyStart </span><span class="s1">+ </span><span class="s5">1024</span><span class="s1">) </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">getLongKeyError</span><span class="s1">(</span><span class="s2">cst</span><span class="s1">, </span><span class="s2">key</span><span class="s1">));</span>
            <span class="s3">const </span><span class="s1">{</span>
              <span class="s2">src</span>
            <span class="s1">} = </span><span class="s2">prevItem</span><span class="s1">.</span><span class="s2">context</span><span class="s1">;</span>

            <span class="s3">for </span><span class="s1">(</span><span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s2">keyStart</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">keyEnd</span><span class="s1">; ++</span><span class="s2">i</span><span class="s1">) </span><span class="s3">if </span><span class="s1">(</span><span class="s2">src</span><span class="s1">[</span><span class="s2">i</span><span class="s1">] === </span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">) {</span>
              <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">'Implicit keys of flow sequence pairs need to be on a single line'</span><span class="s1">;</span>
              <span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSemanticError</span><span class="s1">(</span><span class="s2">prevItem</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">));</span>
              <span class="s3">break</span><span class="s1">;</span>
            <span class="s1">}</span>
          <span class="s1">}</span>
        <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
          <span class="s2">key </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s2">keyStart </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
        <span class="s2">explicitKey </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
        <span class="s2">next </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">next </span><span class="s1">=== </span><span class="s0">'[' </span><span class="s1">|| </span><span class="s2">char </span><span class="s1">!== </span><span class="s0">']' </span><span class="s1">|| </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">cst</span><span class="s1">.</span><span class="s2">items</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s5">1</span><span class="s1">) {</span>
        <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">`Flow sequence contains an unexpected </span><span class="s2">$</span><span class="s1">{</span><span class="s2">char</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s2">err </span><span class="s1">= </span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSyntaxError</span><span class="s1">(</span><span class="s2">cst</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">);</span>
        <span class="s2">err</span><span class="s1">.</span><span class="s2">offset </span><span class="s1">= </span><span class="s2">offset</span><span class="s1">;</span>
        <span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">BLANK_LINE</span><span class="s1">) {</span>
      <span class="s2">comments</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({</span>
        <span class="s2">before</span><span class="s1">: </span><span class="s2">items</span><span class="s1">.</span><span class="s2">length</span>
      <span class="s1">});</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">COMMENT</span><span class="s1">) {</span>
      <span class="s2">checkFlowCommentSpace</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">, </span><span class="s2">item</span><span class="s1">);</span>
      <span class="s2">comments</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({</span>
        <span class="s2">comment</span><span class="s1">: </span><span class="s2">item</span><span class="s1">.</span><span class="s2">comment</span><span class="s1">,</span>
        <span class="s2">before</span><span class="s1">: </span><span class="s2">items</span><span class="s1">.</span><span class="s2">length</span>
      <span class="s1">});</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">next</span><span class="s1">) {</span>
        <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">`Expected a </span><span class="s2">$</span><span class="s1">{</span><span class="s2">next</span><span class="s1">} </span><span class="s0">in flow sequence`</span><span class="s1">;</span>
        <span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSemanticError</span><span class="s1">(</span><span class="s2">item</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">));</span>
      <span class="s1">}</span>

      <span class="s3">const </span><span class="s2">value </span><span class="s1">= </span><span class="s2">resolveNode</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">item</span><span class="s1">);</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">key </span><span class="s1">=== </span><span class="s2">undefined</span><span class="s1">) {</span>
        <span class="s2">items</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>
        <span class="s2">prevItem </span><span class="s1">= </span><span class="s2">item</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s2">items</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">Pair</span><span class="s1">(</span><span class="s2">key</span><span class="s1">, </span><span class="s2">value</span><span class="s1">));</span>
        <span class="s2">key </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s2">keyStart </span><span class="s1">= </span><span class="s2">item</span><span class="s1">.</span><span class="s2">range</span><span class="s1">.</span><span class="s2">start</span><span class="s1">;</span>
      <span class="s2">next </span><span class="s1">= </span><span class="s0">','</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">checkFlowCollectionEnd</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">, </span><span class="s2">cst</span><span class="s1">);</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">key </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) </span><span class="s2">items</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">Pair</span><span class="s1">(</span><span class="s2">key</span><span class="s1">));</span>
  <span class="s3">return </span><span class="s1">{</span>
    <span class="s2">comments</span><span class="s1">,</span>
    <span class="s2">items</span>
  <span class="s1">};</span>
<span class="s1">}</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">Alias </span><span class="s1">= </span><span class="s2">Alias</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">Collection </span><span class="s1">= </span><span class="s2">Collection</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">Merge </span><span class="s1">= </span><span class="s2">Merge</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">Node </span><span class="s1">= </span><span class="s2">Node</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">Pair </span><span class="s1">= </span><span class="s2">Pair</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">Scalar </span><span class="s1">= </span><span class="s2">Scalar</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">YAMLMap </span><span class="s1">= </span><span class="s2">YAMLMap</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">YAMLSeq </span><span class="s1">= </span><span class="s2">YAMLSeq</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">addComment </span><span class="s1">= </span><span class="s2">addComment</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">binaryOptions </span><span class="s1">= </span><span class="s2">binaryOptions</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">boolOptions </span><span class="s1">= </span><span class="s2">boolOptions</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">findPair </span><span class="s1">= </span><span class="s2">findPair</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">intOptions </span><span class="s1">= </span><span class="s2">intOptions</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">isEmptyPath </span><span class="s1">= </span><span class="s2">isEmptyPath</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">nullOptions </span><span class="s1">= </span><span class="s2">nullOptions</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">resolveMap </span><span class="s1">= </span><span class="s2">resolveMap</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">resolveNode </span><span class="s1">= </span><span class="s2">resolveNode</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">resolveSeq </span><span class="s1">= </span><span class="s2">resolveSeq</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">resolveString </span><span class="s1">= </span><span class="s2">resolveString</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">strOptions </span><span class="s1">= </span><span class="s2">strOptions</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">stringifyNumber </span><span class="s1">= </span><span class="s2">stringifyNumber</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">stringifyString </span><span class="s1">= </span><span class="s2">stringifyString</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">toJSON </span><span class="s1">= </span><span class="s2">toJSON</span><span class="s1">;</span>
</pre>
</body>
</html>