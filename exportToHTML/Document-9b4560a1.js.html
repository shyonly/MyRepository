<html>
<head>
<title>Document-9b4560a1.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #6aab73;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #cf8e6d;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
.s6 { color: #42c3d4;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
Document-9b4560a1.js</font>
</center></td></tr></table>
<pre><span class="s0">'use strict'</span><span class="s1">;</span>

<span class="s3">var </span><span class="s2">PlainValue </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./PlainValue-ec8e588e.js'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">resolveSeq </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./resolveSeq-d03cb037.js'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">Schema </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./Schema-88e323a7.js'</span><span class="s1">);</span>

<span class="s3">const </span><span class="s2">defaultOptions </span><span class="s1">= {</span>
  <span class="s2">anchorPrefix</span><span class="s1">: </span><span class="s0">'a'</span><span class="s1">,</span>
  <span class="s2">customTags</span><span class="s1">: </span><span class="s3">null</span><span class="s1">,</span>
  <span class="s2">indent</span><span class="s1">: </span><span class="s4">2</span><span class="s1">,</span>
  <span class="s2">indentSeq</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
  <span class="s2">keepCstNodes</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
  <span class="s2">keepNodeTypes</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
  <span class="s2">keepBlobsInJSON</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
  <span class="s2">mapAsMap</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
  <span class="s2">maxAliasCount</span><span class="s1">: </span><span class="s4">100</span><span class="s1">,</span>
  <span class="s2">prettyErrors</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
  <span class="s5">// TODO Set true in v2</span>
  <span class="s2">simpleKeys</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
  <span class="s2">version</span><span class="s1">: </span><span class="s0">'1.2'</span>
<span class="s1">};</span>
<span class="s3">const </span><span class="s2">scalarOptions </span><span class="s1">= {</span>
  <span class="s2">get binary</span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">binaryOptions</span><span class="s1">;</span>
  <span class="s1">},</span>

  <span class="s2">set binary</span><span class="s1">(</span><span class="s2">opt</span><span class="s1">) {</span>
    <span class="s2">Object</span><span class="s1">.</span><span class="s2">assign</span><span class="s1">(</span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">binaryOptions</span><span class="s1">, </span><span class="s2">opt</span><span class="s1">);</span>
  <span class="s1">},</span>

  <span class="s2">get bool</span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">boolOptions</span><span class="s1">;</span>
  <span class="s1">},</span>

  <span class="s2">set bool</span><span class="s1">(</span><span class="s2">opt</span><span class="s1">) {</span>
    <span class="s2">Object</span><span class="s1">.</span><span class="s2">assign</span><span class="s1">(</span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">boolOptions</span><span class="s1">, </span><span class="s2">opt</span><span class="s1">);</span>
  <span class="s1">},</span>

  <span class="s2">get int</span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">intOptions</span><span class="s1">;</span>
  <span class="s1">},</span>

  <span class="s2">set int</span><span class="s1">(</span><span class="s2">opt</span><span class="s1">) {</span>
    <span class="s2">Object</span><span class="s1">.</span><span class="s2">assign</span><span class="s1">(</span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">intOptions</span><span class="s1">, </span><span class="s2">opt</span><span class="s1">);</span>
  <span class="s1">},</span>

  <span class="s2">get </span><span class="s3">null</span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">nullOptions</span><span class="s1">;</span>
  <span class="s1">},</span>

  <span class="s2">set </span><span class="s3">null</span><span class="s1">(</span><span class="s2">opt</span><span class="s1">) {</span>
    <span class="s2">Object</span><span class="s1">.</span><span class="s2">assign</span><span class="s1">(</span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">nullOptions</span><span class="s1">, </span><span class="s2">opt</span><span class="s1">);</span>
  <span class="s1">},</span>

  <span class="s2">get str</span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">strOptions</span><span class="s1">;</span>
  <span class="s1">},</span>

  <span class="s2">set str</span><span class="s1">(</span><span class="s2">opt</span><span class="s1">) {</span>
    <span class="s2">Object</span><span class="s1">.</span><span class="s2">assign</span><span class="s1">(</span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">strOptions</span><span class="s1">, </span><span class="s2">opt</span><span class="s1">);</span>
  <span class="s1">}</span>

<span class="s1">};</span>
<span class="s3">const </span><span class="s2">documentOptions </span><span class="s1">= {</span>
  <span class="s0">'1.0'</span><span class="s1">: {</span>
    <span class="s2">schema</span><span class="s1">: </span><span class="s0">'yaml-1.1'</span><span class="s1">,</span>
    <span class="s2">merge</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
    <span class="s2">tagPrefixes</span><span class="s1">: [{</span>
      <span class="s2">handle</span><span class="s1">: </span><span class="s0">'!'</span><span class="s1">,</span>
      <span class="s2">prefix</span><span class="s1">: </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">defaultTagPrefix</span>
    <span class="s1">}, {</span>
      <span class="s2">handle</span><span class="s1">: </span><span class="s0">'!!'</span><span class="s1">,</span>
      <span class="s2">prefix</span><span class="s1">: </span><span class="s0">'tag:private.yaml.org,2002:'</span>
    <span class="s1">}]</span>
  <span class="s1">},</span>
  <span class="s4">1.1</span><span class="s1">: {</span>
    <span class="s2">schema</span><span class="s1">: </span><span class="s0">'yaml-1.1'</span><span class="s1">,</span>
    <span class="s2">merge</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
    <span class="s2">tagPrefixes</span><span class="s1">: [{</span>
      <span class="s2">handle</span><span class="s1">: </span><span class="s0">'!'</span><span class="s1">,</span>
      <span class="s2">prefix</span><span class="s1">: </span><span class="s0">'!'</span>
    <span class="s1">}, {</span>
      <span class="s2">handle</span><span class="s1">: </span><span class="s0">'!!'</span><span class="s1">,</span>
      <span class="s2">prefix</span><span class="s1">: </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">defaultTagPrefix</span>
    <span class="s1">}]</span>
  <span class="s1">},</span>
  <span class="s4">1.2</span><span class="s1">: {</span>
    <span class="s2">schema</span><span class="s1">: </span><span class="s0">'core'</span><span class="s1">,</span>
    <span class="s2">merge</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
    <span class="s2">tagPrefixes</span><span class="s1">: [{</span>
      <span class="s2">handle</span><span class="s1">: </span><span class="s0">'!'</span><span class="s1">,</span>
      <span class="s2">prefix</span><span class="s1">: </span><span class="s0">'!'</span>
    <span class="s1">}, {</span>
      <span class="s2">handle</span><span class="s1">: </span><span class="s0">'!!'</span><span class="s1">,</span>
      <span class="s2">prefix</span><span class="s1">: </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">defaultTagPrefix</span>
    <span class="s1">}]</span>
  <span class="s1">}</span>
<span class="s1">};</span>

<span class="s3">function </span><span class="s2">stringifyTag</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">tag</span><span class="s1">) {</span>
  <span class="s3">if </span><span class="s1">((</span><span class="s2">doc</span><span class="s1">.</span><span class="s2">version </span><span class="s1">|| </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">version</span><span class="s1">) === </span><span class="s0">'1.0'</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">priv </span><span class="s1">= </span><span class="s2">tag</span><span class="s1">.</span><span class="s2">match</span><span class="s1">(</span><span class="s6">/^tag:private\.yaml\.org,2002:([^:/]+)$/</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">priv</span><span class="s1">) </span><span class="s3">return </span><span class="s0">'!' </span><span class="s1">+ </span><span class="s2">priv</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
    <span class="s3">const </span><span class="s2">vocab </span><span class="s1">= </span><span class="s2">tag</span><span class="s1">.</span><span class="s2">match</span><span class="s1">(</span><span class="s6">/^tag:([a-zA-Z0-9-]+)\.yaml\.org,2002:(.*)/</span><span class="s1">);</span>
    <span class="s3">return </span><span class="s2">vocab </span><span class="s1">? </span><span class="s0">`!</span><span class="s2">$</span><span class="s1">{</span><span class="s2">vocab</span><span class="s1">[</span><span class="s4">1</span><span class="s1">]}</span><span class="s0">/</span><span class="s2">$</span><span class="s1">{</span><span class="s2">vocab</span><span class="s1">[</span><span class="s4">2</span><span class="s1">]}</span><span class="s0">` </span><span class="s1">: </span><span class="s0">`!</span><span class="s2">$</span><span class="s1">{</span><span class="s2">tag</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s6">/^tag:/</span><span class="s1">, </span><span class="s0">''</span><span class="s1">)}</span><span class="s0">`</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">let </span><span class="s2">p </span><span class="s1">= </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">tagPrefixes</span><span class="s1">.</span><span class="s2">find</span><span class="s1">(</span><span class="s2">p </span><span class="s1">=&gt; </span><span class="s2">tag</span><span class="s1">.</span><span class="s2">indexOf</span><span class="s1">(</span><span class="s2">p</span><span class="s1">.</span><span class="s2">prefix</span><span class="s1">) === </span><span class="s4">0</span><span class="s1">);</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">p</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">dtp </span><span class="s1">= </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">getDefaults</span><span class="s1">().</span><span class="s2">tagPrefixes</span><span class="s1">;</span>
    <span class="s2">p </span><span class="s1">= </span><span class="s2">dtp </span><span class="s1">&amp;&amp; </span><span class="s2">dtp</span><span class="s1">.</span><span class="s2">find</span><span class="s1">(</span><span class="s2">p </span><span class="s1">=&gt; </span><span class="s2">tag</span><span class="s1">.</span><span class="s2">indexOf</span><span class="s1">(</span><span class="s2">p</span><span class="s1">.</span><span class="s2">prefix</span><span class="s1">) === </span><span class="s4">0</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">p</span><span class="s1">) </span><span class="s3">return </span><span class="s2">tag</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] === </span><span class="s0">'!' </span><span class="s1">? </span><span class="s2">tag </span><span class="s1">: </span><span class="s0">`!&lt;</span><span class="s2">$</span><span class="s1">{</span><span class="s2">tag</span><span class="s1">}</span><span class="s0">&gt;`</span><span class="s1">;</span>
  <span class="s3">const </span><span class="s2">suffix </span><span class="s1">= </span><span class="s2">tag</span><span class="s1">.</span><span class="s2">substr</span><span class="s1">(</span><span class="s2">p</span><span class="s1">.</span><span class="s2">prefix</span><span class="s1">.</span><span class="s2">length</span><span class="s1">).</span><span class="s2">replace</span><span class="s1">(</span><span class="s6">/[!,[\]{}]/g</span><span class="s1">, </span><span class="s2">ch </span><span class="s1">=&gt; ({</span>
    <span class="s0">'!'</span><span class="s1">: </span><span class="s0">'%21'</span><span class="s1">,</span>
    <span class="s0">','</span><span class="s1">: </span><span class="s0">'%2C'</span><span class="s1">,</span>
    <span class="s0">'['</span><span class="s1">: </span><span class="s0">'%5B'</span><span class="s1">,</span>
    <span class="s0">']'</span><span class="s1">: </span><span class="s0">'%5D'</span><span class="s1">,</span>
    <span class="s0">'{'</span><span class="s1">: </span><span class="s0">'%7B'</span><span class="s1">,</span>
    <span class="s0">'}'</span><span class="s1">: </span><span class="s0">'%7D'</span>
  <span class="s1">})[</span><span class="s2">ch</span><span class="s1">]);</span>
  <span class="s3">return </span><span class="s2">p</span><span class="s1">.</span><span class="s2">handle </span><span class="s1">+ </span><span class="s2">suffix</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">getTagObject</span><span class="s1">(</span><span class="s2">tags</span><span class="s1">, </span><span class="s2">item</span><span class="s1">) {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">item </span><span class="s3">instanceof </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">Alias</span><span class="s1">) </span><span class="s3">return </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">Alias</span><span class="s1">;</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">tag</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">match </span><span class="s1">= </span><span class="s2">tags</span><span class="s1">.</span><span class="s2">filter</span><span class="s1">(</span><span class="s2">t </span><span class="s1">=&gt; </span><span class="s2">t</span><span class="s1">.</span><span class="s2">tag </span><span class="s1">=== </span><span class="s2">item</span><span class="s1">.</span><span class="s2">tag</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">match</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s4">0</span><span class="s1">) </span><span class="s3">return </span><span class="s2">match</span><span class="s1">.</span><span class="s2">find</span><span class="s1">(</span><span class="s2">t </span><span class="s1">=&gt; </span><span class="s2">t</span><span class="s1">.</span><span class="s2">format </span><span class="s1">=== </span><span class="s2">item</span><span class="s1">.</span><span class="s2">format</span><span class="s1">) || </span><span class="s2">match</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
  <span class="s1">}</span>

  <span class="s3">let </span><span class="s2">tagObj</span><span class="s1">, </span><span class="s2">obj</span><span class="s1">;</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">item </span><span class="s3">instanceof </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">Scalar</span><span class="s1">) {</span>
    <span class="s2">obj </span><span class="s1">= </span><span class="s2">item</span><span class="s1">.</span><span class="s2">value</span><span class="s1">; </span><span class="s5">// TODO: deprecate/remove class check</span>

    <span class="s3">const </span><span class="s2">match </span><span class="s1">= </span><span class="s2">tags</span><span class="s1">.</span><span class="s2">filter</span><span class="s1">(</span><span class="s2">t </span><span class="s1">=&gt; </span><span class="s2">t</span><span class="s1">.</span><span class="s2">identify </span><span class="s1">&amp;&amp; </span><span class="s2">t</span><span class="s1">.</span><span class="s2">identify</span><span class="s1">(</span><span class="s2">obj</span><span class="s1">) || </span><span class="s2">t</span><span class="s1">.</span><span class="s2">class </span><span class="s1">&amp;&amp; </span><span class="s2">obj </span><span class="s3">instanceof </span><span class="s2">t</span><span class="s1">.</span><span class="s2">class</span><span class="s1">);</span>
    <span class="s2">tagObj </span><span class="s1">= </span><span class="s2">match</span><span class="s1">.</span><span class="s2">find</span><span class="s1">(</span><span class="s2">t </span><span class="s1">=&gt; </span><span class="s2">t</span><span class="s1">.</span><span class="s2">format </span><span class="s1">=== </span><span class="s2">item</span><span class="s1">.</span><span class="s2">format</span><span class="s1">) || </span><span class="s2">match</span><span class="s1">.</span><span class="s2">find</span><span class="s1">(</span><span class="s2">t </span><span class="s1">=&gt; !</span><span class="s2">t</span><span class="s1">.</span><span class="s2">format</span><span class="s1">);</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s2">obj </span><span class="s1">= </span><span class="s2">item</span><span class="s1">;</span>
    <span class="s2">tagObj </span><span class="s1">= </span><span class="s2">tags</span><span class="s1">.</span><span class="s2">find</span><span class="s1">(</span><span class="s2">t </span><span class="s1">=&gt; </span><span class="s2">t</span><span class="s1">.</span><span class="s2">nodeClass </span><span class="s1">&amp;&amp; </span><span class="s2">obj </span><span class="s3">instanceof </span><span class="s2">t</span><span class="s1">.</span><span class="s2">nodeClass</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">tagObj</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">name </span><span class="s1">= </span><span class="s2">obj </span><span class="s1">&amp;&amp; </span><span class="s2">obj</span><span class="s1">.</span><span class="s2">constructor </span><span class="s1">? </span><span class="s2">obj</span><span class="s1">.</span><span class="s2">constructor</span><span class="s1">.</span><span class="s2">name </span><span class="s1">: </span><span class="s3">typeof </span><span class="s2">obj</span><span class="s1">;</span>
    <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">`Tag not resolved for </span><span class="s2">$</span><span class="s1">{</span><span class="s2">name</span><span class="s1">} </span><span class="s0">value`</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s2">tagObj</span><span class="s1">;</span>
<span class="s1">} </span><span class="s5">// needs to be called before value stringifier to allow for circular anchor refs</span>


<span class="s3">function </span><span class="s2">stringifyProps</span><span class="s1">(</span><span class="s2">node</span><span class="s1">, </span><span class="s2">tagObj</span><span class="s1">, {</span>
  <span class="s2">anchors</span><span class="s1">,</span>
  <span class="s2">doc</span>
<span class="s1">}) {</span>
  <span class="s3">const </span><span class="s2">props </span><span class="s1">= [];</span>
  <span class="s3">const </span><span class="s2">anchor </span><span class="s1">= </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">anchors</span><span class="s1">.</span><span class="s2">getName</span><span class="s1">(</span><span class="s2">node</span><span class="s1">);</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">anchor</span><span class="s1">) {</span>
    <span class="s2">anchors</span><span class="s1">[</span><span class="s2">anchor</span><span class="s1">] = </span><span class="s2">node</span><span class="s1">;</span>
    <span class="s2">props</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s0">`&amp;</span><span class="s2">$</span><span class="s1">{</span><span class="s2">anchor</span><span class="s1">}</span><span class="s0">`</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">tag</span><span class="s1">) {</span>
    <span class="s2">props</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">stringifyTag</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">node</span><span class="s1">.</span><span class="s2">tag</span><span class="s1">));</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(!</span><span class="s2">tagObj</span><span class="s1">.</span><span class="s2">default</span><span class="s1">) {</span>
    <span class="s2">props</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">stringifyTag</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">tagObj</span><span class="s1">.</span><span class="s2">tag</span><span class="s1">));</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s2">props</span><span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s0">' '</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">stringify</span><span class="s1">(</span><span class="s2">item</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">, </span><span class="s2">onComment</span><span class="s1">, </span><span class="s2">onChompKeep</span><span class="s1">) {</span>
  <span class="s3">const </span><span class="s1">{</span>
    <span class="s2">anchors</span><span class="s1">,</span>
    <span class="s2">schema</span>
  <span class="s1">} = </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">doc</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">tagObj</span><span class="s1">;</span>

  <span class="s3">if </span><span class="s1">(!(</span><span class="s2">item </span><span class="s3">instanceof </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">Node</span><span class="s1">)) {</span>
    <span class="s3">const </span><span class="s2">createCtx </span><span class="s1">= {</span>
      <span class="s2">aliasNodes</span><span class="s1">: [],</span>
      <span class="s2">onTagObj</span><span class="s1">: </span><span class="s2">o </span><span class="s1">=&gt; </span><span class="s2">tagObj </span><span class="s1">= </span><span class="s2">o</span><span class="s1">,</span>
      <span class="s2">prevObjects</span><span class="s1">: </span><span class="s3">new </span><span class="s2">Map</span><span class="s1">()</span>
    <span class="s1">};</span>
    <span class="s2">item </span><span class="s1">= </span><span class="s2">schema</span><span class="s1">.</span><span class="s2">createNode</span><span class="s1">(</span><span class="s2">item</span><span class="s1">, </span><span class="s3">true</span><span class="s1">, </span><span class="s3">null</span><span class="s1">, </span><span class="s2">createCtx</span><span class="s1">);</span>

    <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">alias of createCtx</span><span class="s1">.</span><span class="s2">aliasNodes</span><span class="s1">) {</span>
      <span class="s2">alias</span><span class="s1">.</span><span class="s2">source </span><span class="s1">= </span><span class="s2">alias</span><span class="s1">.</span><span class="s2">source</span><span class="s1">.</span><span class="s2">node</span><span class="s1">;</span>
      <span class="s3">let </span><span class="s2">name </span><span class="s1">= </span><span class="s2">anchors</span><span class="s1">.</span><span class="s2">getName</span><span class="s1">(</span><span class="s2">alias</span><span class="s1">.</span><span class="s2">source</span><span class="s1">);</span>

      <span class="s3">if </span><span class="s1">(!</span><span class="s2">name</span><span class="s1">) {</span>
        <span class="s2">name </span><span class="s1">= </span><span class="s2">anchors</span><span class="s1">.</span><span class="s2">newName</span><span class="s1">();</span>
        <span class="s2">anchors</span><span class="s1">.</span><span class="s2">map</span><span class="s1">[</span><span class="s2">name</span><span class="s1">] = </span><span class="s2">alias</span><span class="s1">.</span><span class="s2">source</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">item </span><span class="s3">instanceof </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">Pair</span><span class="s1">) </span><span class="s3">return </span><span class="s2">item</span><span class="s1">.</span><span class="s2">toString</span><span class="s1">(</span><span class="s2">ctx</span><span class="s1">, </span><span class="s2">onComment</span><span class="s1">, </span><span class="s2">onChompKeep</span><span class="s1">);</span>
  <span class="s3">if </span><span class="s1">(!</span><span class="s2">tagObj</span><span class="s1">) </span><span class="s2">tagObj </span><span class="s1">= </span><span class="s2">getTagObject</span><span class="s1">(</span><span class="s2">schema</span><span class="s1">.</span><span class="s2">tags</span><span class="s1">, </span><span class="s2">item</span><span class="s1">);</span>
  <span class="s3">const </span><span class="s2">props </span><span class="s1">= </span><span class="s2">stringifyProps</span><span class="s1">(</span><span class="s2">item</span><span class="s1">, </span><span class="s2">tagObj</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">);</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">props</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s4">0</span><span class="s1">) </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">indentAtStart </span><span class="s1">= (</span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">indentAtStart </span><span class="s1">|| </span><span class="s4">0</span><span class="s1">) + </span><span class="s2">props</span><span class="s1">.</span><span class="s2">length </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">;</span>
  <span class="s3">const </span><span class="s2">str </span><span class="s1">= </span><span class="s3">typeof </span><span class="s2">tagObj</span><span class="s1">.</span><span class="s2">stringify </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">? </span><span class="s2">tagObj</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">(</span><span class="s2">item</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">, </span><span class="s2">onComment</span><span class="s1">, </span><span class="s2">onChompKeep</span><span class="s1">) : </span><span class="s2">item </span><span class="s3">instanceof </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">Scalar </span><span class="s1">? </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">stringifyString</span><span class="s1">(</span><span class="s2">item</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">, </span><span class="s2">onComment</span><span class="s1">, </span><span class="s2">onChompKeep</span><span class="s1">) : </span><span class="s2">item</span><span class="s1">.</span><span class="s2">toString</span><span class="s1">(</span><span class="s2">ctx</span><span class="s1">, </span><span class="s2">onComment</span><span class="s1">, </span><span class="s2">onChompKeep</span><span class="s1">);</span>
  <span class="s3">if </span><span class="s1">(!</span><span class="s2">props</span><span class="s1">) </span><span class="s3">return </span><span class="s2">str</span><span class="s1">;</span>
  <span class="s3">return </span><span class="s2">item </span><span class="s3">instanceof </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">Scalar </span><span class="s1">|| </span><span class="s2">str</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] === </span><span class="s0">'{' </span><span class="s1">|| </span><span class="s2">str</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] === </span><span class="s0">'[' </span><span class="s1">? </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">props</span><span class="s1">} </span><span class="s2">$</span><span class="s1">{</span><span class="s2">str</span><span class="s1">}</span><span class="s0">` </span><span class="s1">: </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">props</span><span class="s1">}</span><span class="s3">\n</span><span class="s2">$</span><span class="s1">{</span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">indent</span><span class="s1">}</span><span class="s2">$</span><span class="s1">{</span><span class="s2">str</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">class </span><span class="s2">Anchors </span><span class="s1">{</span>
  <span class="s3">static </span><span class="s2">validAnchorNode</span><span class="s1">(</span><span class="s2">node</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s2">node </span><span class="s3">instanceof </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">Scalar </span><span class="s1">|| </span><span class="s2">node </span><span class="s3">instanceof </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">YAMLSeq </span><span class="s1">|| </span><span class="s2">node </span><span class="s3">instanceof </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">YAMLMap</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">constructor</span><span class="s1">(</span><span class="s2">prefix</span><span class="s1">) {</span>
    <span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">_defineProperty</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s0">&quot;map&quot;</span><span class="s1">, </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s3">null</span><span class="s1">));</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">prefix </span><span class="s1">= </span><span class="s2">prefix</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">createAlias</span><span class="s1">(</span><span class="s2">node</span><span class="s1">, </span><span class="s2">name</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">setAnchor</span><span class="s1">(</span><span class="s2">node</span><span class="s1">, </span><span class="s2">name</span><span class="s1">);</span>
    <span class="s3">return new </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">Alias</span><span class="s1">(</span><span class="s2">node</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">createMergePair</span><span class="s1">(</span><span class="s2">...sources</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">merge </span><span class="s1">= </span><span class="s3">new </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">Merge</span><span class="s1">();</span>
    <span class="s2">merge</span><span class="s1">.</span><span class="s2">value</span><span class="s1">.</span><span class="s2">items </span><span class="s1">= </span><span class="s2">sources</span><span class="s1">.</span><span class="s2">map</span><span class="s1">(</span><span class="s2">s </span><span class="s1">=&gt; {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">s </span><span class="s3">instanceof </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">Alias</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">s</span><span class="s1">.</span><span class="s2">source </span><span class="s3">instanceof </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">YAMLMap</span><span class="s1">) </span><span class="s3">return </span><span class="s2">s</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">s </span><span class="s3">instanceof </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">YAMLMap</span><span class="s1">) {</span>
        <span class="s3">return this</span><span class="s1">.</span><span class="s2">createAlias</span><span class="s1">(</span><span class="s2">s</span><span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'Merge sources must be Map nodes or their Aliases'</span><span class="s1">);</span>
    <span class="s1">});</span>
    <span class="s3">return </span><span class="s2">merge</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">getName</span><span class="s1">(</span><span class="s2">node</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s1">{</span>
      <span class="s2">map</span>
    <span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
    <span class="s3">return </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">map</span><span class="s1">).</span><span class="s2">find</span><span class="s1">(</span><span class="s2">a </span><span class="s1">=&gt; </span><span class="s2">map</span><span class="s1">[</span><span class="s2">a</span><span class="s1">] === </span><span class="s2">node</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">getNames</span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">map</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">getNode</span><span class="s1">(</span><span class="s2">name</span><span class="s1">) {</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">map</span><span class="s1">[</span><span class="s2">name</span><span class="s1">];</span>
  <span class="s1">}</span>

  <span class="s2">newName</span><span class="s1">(</span><span class="s2">prefix</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">prefix</span><span class="s1">) </span><span class="s2">prefix </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">prefix</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">names </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">map</span><span class="s1">);</span>

    <span class="s3">for </span><span class="s1">(</span><span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s4">1</span><span class="s1">; </span><span class="s3">true</span><span class="s1">; ++</span><span class="s2">i</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">name </span><span class="s1">= </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">prefix</span><span class="s1">}</span><span class="s2">$</span><span class="s1">{</span><span class="s2">i</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
      <span class="s3">if </span><span class="s1">(!</span><span class="s2">names</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s2">name</span><span class="s1">)) </span><span class="s3">return </span><span class="s2">name</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s5">// During parsing, map &amp; aliases contain CST nodes</span>


  <span class="s2">resolveNodes</span><span class="s1">() {</span>
    <span class="s3">const </span><span class="s1">{</span>
      <span class="s2">map</span><span class="s1">,</span>
      <span class="s2">_cstAliases</span>
    <span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
    <span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">map</span><span class="s1">).</span><span class="s2">forEach</span><span class="s1">(</span><span class="s2">a </span><span class="s1">=&gt; {</span>
      <span class="s2">map</span><span class="s1">[</span><span class="s2">a</span><span class="s1">] = </span><span class="s2">map</span><span class="s1">[</span><span class="s2">a</span><span class="s1">].</span><span class="s2">resolved</span><span class="s1">;</span>
    <span class="s1">});</span>

    <span class="s2">_cstAliases</span><span class="s1">.</span><span class="s2">forEach</span><span class="s1">(</span><span class="s2">a </span><span class="s1">=&gt; {</span>
      <span class="s2">a</span><span class="s1">.</span><span class="s2">source </span><span class="s1">= </span><span class="s2">a</span><span class="s1">.</span><span class="s2">source</span><span class="s1">.</span><span class="s2">resolved</span><span class="s1">;</span>
    <span class="s1">});</span>

    <span class="s3">delete this</span><span class="s1">.</span><span class="s2">_cstAliases</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">setAnchor</span><span class="s1">(</span><span class="s2">node</span><span class="s1">, </span><span class="s2">name</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">node </span><span class="s1">!= </span><span class="s3">null </span><span class="s1">&amp;&amp; !</span><span class="s2">Anchors</span><span class="s1">.</span><span class="s2">validAnchorNode</span><span class="s1">(</span><span class="s2">node</span><span class="s1">)) {</span>
      <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'Anchors may only be set for Scalar, Seq and Map nodes'</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">name </span><span class="s1">&amp;&amp; </span><span class="s6">/[\x00-\x19\s,[\]{}]/</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">name</span><span class="s1">)) {</span>
      <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'Anchor names must not contain whitespace or control characters'</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">const </span><span class="s1">{</span>
      <span class="s2">map</span>
    <span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">prev </span><span class="s1">= </span><span class="s2">node </span><span class="s1">&amp;&amp; </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">map</span><span class="s1">).</span><span class="s2">find</span><span class="s1">(</span><span class="s2">a </span><span class="s1">=&gt; </span><span class="s2">map</span><span class="s1">[</span><span class="s2">a</span><span class="s1">] === </span><span class="s2">node</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">prev</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(!</span><span class="s2">name</span><span class="s1">) {</span>
        <span class="s3">return </span><span class="s2">prev</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">prev </span><span class="s1">!== </span><span class="s2">name</span><span class="s1">) {</span>
        <span class="s3">delete </span><span class="s2">map</span><span class="s1">[</span><span class="s2">prev</span><span class="s1">];</span>
        <span class="s2">map</span><span class="s1">[</span><span class="s2">name</span><span class="s1">] = </span><span class="s2">node</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">if </span><span class="s1">(!</span><span class="s2">name</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">node</span><span class="s1">) </span><span class="s3">return null</span><span class="s1">;</span>
        <span class="s2">name </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">newName</span><span class="s1">();</span>
      <span class="s1">}</span>

      <span class="s2">map</span><span class="s1">[</span><span class="s2">name</span><span class="s1">] = </span><span class="s2">node</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s2">name</span><span class="s1">;</span>
  <span class="s1">}</span>

<span class="s1">}</span>

<span class="s3">const </span><span class="s2">visit </span><span class="s1">= (</span><span class="s2">node</span><span class="s1">, </span><span class="s2">tags</span><span class="s1">) =&gt; {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">node </span><span class="s1">&amp;&amp; </span><span class="s3">typeof </span><span class="s2">node </span><span class="s1">=== </span><span class="s0">'object'</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s1">{</span>
      <span class="s2">tag</span>
    <span class="s1">} = </span><span class="s2">node</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">node </span><span class="s3">instanceof </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">Collection</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">tag</span><span class="s1">) </span><span class="s2">tags</span><span class="s1">[</span><span class="s2">tag</span><span class="s1">] = </span><span class="s3">true</span><span class="s1">;</span>
      <span class="s2">node</span><span class="s1">.</span><span class="s2">items</span><span class="s1">.</span><span class="s2">forEach</span><span class="s1">(</span><span class="s2">n </span><span class="s1">=&gt; </span><span class="s2">visit</span><span class="s1">(</span><span class="s2">n</span><span class="s1">, </span><span class="s2">tags</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">node </span><span class="s3">instanceof </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">Pair</span><span class="s1">) {</span>
      <span class="s2">visit</span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">key</span><span class="s1">, </span><span class="s2">tags</span><span class="s1">);</span>
      <span class="s2">visit</span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">value</span><span class="s1">, </span><span class="s2">tags</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">node </span><span class="s3">instanceof </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">Scalar</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">tag</span><span class="s1">) </span><span class="s2">tags</span><span class="s1">[</span><span class="s2">tag</span><span class="s1">] = </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s2">tags</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s2">listTagNames </span><span class="s1">= </span><span class="s2">node </span><span class="s1">=&gt; </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">visit</span><span class="s1">(</span><span class="s2">node</span><span class="s1">, {}));</span>

<span class="s3">function </span><span class="s2">parseContents</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">contents</span><span class="s1">) {</span>
  <span class="s3">const </span><span class="s2">comments </span><span class="s1">= {</span>
    <span class="s2">before</span><span class="s1">: [],</span>
    <span class="s2">after</span><span class="s1">: []</span>
  <span class="s1">};</span>
  <span class="s3">let </span><span class="s2">body </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
  <span class="s3">let </span><span class="s2">spaceBefore </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>

  <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">node of contents</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">valueRange</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">body </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) {</span>
        <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">'Document contains trailing content not separated by a ... or --- line'</span><span class="s1">;</span>
        <span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSyntaxError</span><span class="s1">(</span><span class="s2">node</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">));</span>
        <span class="s3">break</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s3">const </span><span class="s2">res </span><span class="s1">= </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">resolveNode</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">node</span><span class="s1">);</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">spaceBefore</span><span class="s1">) {</span>
        <span class="s2">res</span><span class="s1">.</span><span class="s2">spaceBefore </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
        <span class="s2">spaceBefore </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s2">body </span><span class="s1">= </span><span class="s2">res</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">comment </span><span class="s1">!== </span><span class="s3">null</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">cc </span><span class="s1">= </span><span class="s2">body </span><span class="s1">=== </span><span class="s2">undefined </span><span class="s1">? </span><span class="s2">comments</span><span class="s1">.</span><span class="s2">before </span><span class="s1">: </span><span class="s2">comments</span><span class="s1">.</span><span class="s2">after</span><span class="s1">;</span>
      <span class="s2">cc</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">comment</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">Type</span><span class="s1">.</span><span class="s2">BLANK_LINE</span><span class="s1">) {</span>
      <span class="s2">spaceBefore </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">body </span><span class="s1">=== </span><span class="s2">undefined </span><span class="s1">&amp;&amp; </span><span class="s2">comments</span><span class="s1">.</span><span class="s2">before</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s4">0 </span><span class="s1">&amp;&amp; !</span><span class="s2">doc</span><span class="s1">.</span><span class="s2">commentBefore</span><span class="s1">) {</span>
        <span class="s5">// space-separated comments at start are parsed as document comments</span>
        <span class="s2">doc</span><span class="s1">.</span><span class="s2">commentBefore </span><span class="s1">= </span><span class="s2">comments</span><span class="s1">.</span><span class="s2">before</span><span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">);</span>
        <span class="s2">comments</span><span class="s1">.</span><span class="s2">before </span><span class="s1">= [];</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">doc</span><span class="s1">.</span><span class="s2">contents </span><span class="s1">= </span><span class="s2">body </span><span class="s1">|| </span><span class="s3">null</span><span class="s1">;</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">body</span><span class="s1">) {</span>
    <span class="s2">doc</span><span class="s1">.</span><span class="s2">comment </span><span class="s1">= </span><span class="s2">comments</span><span class="s1">.</span><span class="s2">before</span><span class="s1">.</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">comments</span><span class="s1">.</span><span class="s2">after</span><span class="s1">).</span><span class="s2">join</span><span class="s1">(</span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">) || </span><span class="s3">null</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s3">const </span><span class="s2">cb </span><span class="s1">= </span><span class="s2">comments</span><span class="s1">.</span><span class="s2">before</span><span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">cbNode </span><span class="s1">= </span><span class="s2">body </span><span class="s3">instanceof </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">Collection </span><span class="s1">&amp;&amp; </span><span class="s2">body</span><span class="s1">.</span><span class="s2">items</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] ? </span><span class="s2">body</span><span class="s1">.</span><span class="s2">items</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] : </span><span class="s2">body</span><span class="s1">;</span>
      <span class="s2">cbNode</span><span class="s1">.</span><span class="s2">commentBefore </span><span class="s1">= </span><span class="s2">cbNode</span><span class="s1">.</span><span class="s2">commentBefore </span><span class="s1">? </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">cb</span><span class="s1">}</span><span class="s3">\n</span><span class="s2">$</span><span class="s1">{</span><span class="s2">cbNode</span><span class="s1">.</span><span class="s2">commentBefore</span><span class="s1">}</span><span class="s0">` </span><span class="s1">: </span><span class="s2">cb</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">doc</span><span class="s1">.</span><span class="s2">comment </span><span class="s1">= </span><span class="s2">comments</span><span class="s1">.</span><span class="s2">after</span><span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">) || </span><span class="s3">null</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">resolveTagDirective</span><span class="s1">({</span>
  <span class="s2">tagPrefixes</span>
<span class="s1">}, </span><span class="s2">directive</span><span class="s1">) {</span>
  <span class="s3">const </span><span class="s1">[</span><span class="s2">handle</span><span class="s1">, </span><span class="s2">prefix</span><span class="s1">] = </span><span class="s2">directive</span><span class="s1">.</span><span class="s2">parameters</span><span class="s1">;</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">handle </span><span class="s1">|| !</span><span class="s2">prefix</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">'Insufficient parameters given for %TAG directive'</span><span class="s1">;</span>
    <span class="s3">throw new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSemanticError</span><span class="s1">(</span><span class="s2">directive</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">tagPrefixes</span><span class="s1">.</span><span class="s2">some</span><span class="s1">(</span><span class="s2">p </span><span class="s1">=&gt; </span><span class="s2">p</span><span class="s1">.</span><span class="s2">handle </span><span class="s1">=== </span><span class="s2">handle</span><span class="s1">)) {</span>
    <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">'The %TAG directive must only be given at most once per handle in the same document.'</span><span class="s1">;</span>
    <span class="s3">throw new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSemanticError</span><span class="s1">(</span><span class="s2">directive</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s1">{</span>
    <span class="s2">handle</span><span class="s1">,</span>
    <span class="s2">prefix</span>
  <span class="s1">};</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">resolveYamlDirective</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">directive</span><span class="s1">) {</span>
  <span class="s3">let </span><span class="s1">[</span><span class="s2">version</span><span class="s1">] = </span><span class="s2">directive</span><span class="s1">.</span><span class="s2">parameters</span><span class="s1">;</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">directive</span><span class="s1">.</span><span class="s2">name </span><span class="s1">=== </span><span class="s0">'YAML:1.0'</span><span class="s1">) </span><span class="s2">version </span><span class="s1">= </span><span class="s0">'1.0'</span><span class="s1">;</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">version</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">'Insufficient parameters given for %YAML directive'</span><span class="s1">;</span>
    <span class="s3">throw new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSemanticError</span><span class="s1">(</span><span class="s2">directive</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">documentOptions</span><span class="s1">[</span><span class="s2">version</span><span class="s1">]) {</span>
    <span class="s3">const </span><span class="s2">v0 </span><span class="s1">= </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">version </span><span class="s1">|| </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">version</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">`Document will be parsed as YAML </span><span class="s2">$</span><span class="s1">{</span><span class="s2">v0</span><span class="s1">} </span><span class="s0">rather than YAML </span><span class="s2">$</span><span class="s1">{</span><span class="s2">version</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
    <span class="s2">doc</span><span class="s1">.</span><span class="s2">warnings</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLWarning</span><span class="s1">(</span><span class="s2">directive</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">));</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s2">version</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">parseDirectives</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">directives</span><span class="s1">, </span><span class="s2">prevDoc</span><span class="s1">) {</span>
  <span class="s3">const </span><span class="s2">directiveComments </span><span class="s1">= [];</span>
  <span class="s3">let </span><span class="s2">hasDirectives </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>

  <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">directive of directives</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s1">{</span>
      <span class="s2">comment</span><span class="s1">,</span>
      <span class="s2">name</span>
    <span class="s1">} = </span><span class="s2">directive</span><span class="s1">;</span>

    <span class="s3">switch </span><span class="s1">(</span><span class="s2">name</span><span class="s1">) {</span>
      <span class="s3">case </span><span class="s0">'TAG'</span><span class="s1">:</span>
        <span class="s3">try </span><span class="s1">{</span>
          <span class="s2">doc</span><span class="s1">.</span><span class="s2">tagPrefixes</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">resolveTagDirective</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">directive</span><span class="s1">));</span>
        <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) {</span>
          <span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">error</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s2">hasDirectives </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">case </span><span class="s0">'YAML'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'YAML:1.0'</span><span class="s1">:</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">doc</span><span class="s1">.</span><span class="s2">version</span><span class="s1">) {</span>
          <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">'The %YAML directive must only be given at most once per document.'</span><span class="s1">;</span>
          <span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLSemanticError</span><span class="s1">(</span><span class="s2">directive</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">));</span>
        <span class="s1">}</span>

        <span class="s3">try </span><span class="s1">{</span>
          <span class="s2">doc</span><span class="s1">.</span><span class="s2">version </span><span class="s1">= </span><span class="s2">resolveYamlDirective</span><span class="s1">(</span><span class="s2">doc</span><span class="s1">, </span><span class="s2">directive</span><span class="s1">);</span>
        <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) {</span>
          <span class="s2">doc</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">error</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s2">hasDirectives </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
        <span class="s3">break</span><span class="s1">;</span>

      <span class="s3">default</span><span class="s1">:</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">name</span><span class="s1">) {</span>
          <span class="s3">const </span><span class="s2">msg </span><span class="s1">= </span><span class="s0">`YAML only supports %TAG and %YAML directives, and not %</span><span class="s2">$</span><span class="s1">{</span><span class="s2">name</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
          <span class="s2">doc</span><span class="s1">.</span><span class="s2">warnings</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">new </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLWarning</span><span class="s1">(</span><span class="s2">directive</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">));</span>
        <span class="s1">}</span>

    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">comment</span><span class="s1">) </span><span class="s2">directiveComments</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">comment</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">prevDoc </span><span class="s1">&amp;&amp; !</span><span class="s2">hasDirectives </span><span class="s1">&amp;&amp; </span><span class="s0">'1.1' </span><span class="s1">=== (</span><span class="s2">doc</span><span class="s1">.</span><span class="s2">version </span><span class="s1">|| </span><span class="s2">prevDoc</span><span class="s1">.</span><span class="s2">version </span><span class="s1">|| </span><span class="s2">doc</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">version</span><span class="s1">)) {</span>
    <span class="s3">const </span><span class="s2">copyTagPrefix </span><span class="s1">= ({</span>
      <span class="s2">handle</span><span class="s1">,</span>
      <span class="s2">prefix</span>
    <span class="s1">}) =&gt; ({</span>
      <span class="s2">handle</span><span class="s1">,</span>
      <span class="s2">prefix</span>
    <span class="s1">});</span>

    <span class="s2">doc</span><span class="s1">.</span><span class="s2">tagPrefixes </span><span class="s1">= </span><span class="s2">prevDoc</span><span class="s1">.</span><span class="s2">tagPrefixes</span><span class="s1">.</span><span class="s2">map</span><span class="s1">(</span><span class="s2">copyTagPrefix</span><span class="s1">);</span>
    <span class="s2">doc</span><span class="s1">.</span><span class="s2">version </span><span class="s1">= </span><span class="s2">prevDoc</span><span class="s1">.</span><span class="s2">version</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">doc</span><span class="s1">.</span><span class="s2">commentBefore </span><span class="s1">= </span><span class="s2">directiveComments</span><span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">) || </span><span class="s3">null</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s2">assertCollection</span><span class="s1">(</span><span class="s2">contents</span><span class="s1">) {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">contents </span><span class="s3">instanceof </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">Collection</span><span class="s1">) </span><span class="s3">return true</span><span class="s1">;</span>
  <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'Expected a YAML collection as document contents'</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s3">class </span><span class="s2">Document </span><span class="s1">{</span>
  <span class="s2">constructor</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">anchors </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Anchors</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">anchorPrefix</span><span class="s1">);</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">commentBefore </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">comment </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">contents </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">directivesEndMarker </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">errors </span><span class="s1">= [];</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">options </span><span class="s1">= </span><span class="s2">options</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">schema </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">tagPrefixes </span><span class="s1">= [];</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">version </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">warnings </span><span class="s1">= [];</span>
  <span class="s1">}</span>

  <span class="s2">add</span><span class="s1">(</span><span class="s2">value</span><span class="s1">) {</span>
    <span class="s2">assertCollection</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">contents</span><span class="s1">);</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">contents</span><span class="s1">.</span><span class="s2">add</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">addIn</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">value</span><span class="s1">) {</span>
    <span class="s2">assertCollection</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">contents</span><span class="s1">);</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">contents</span><span class="s1">.</span><span class="s2">addIn</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">value</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">delete</span><span class="s1">(</span><span class="s2">key</span><span class="s1">) {</span>
    <span class="s2">assertCollection</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">contents</span><span class="s1">);</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">contents</span><span class="s1">.</span><span class="s2">delete</span><span class="s1">(</span><span class="s2">key</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">deleteIn</span><span class="s1">(</span><span class="s2">path</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">isEmptyPath</span><span class="s1">(</span><span class="s2">path</span><span class="s1">)) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">contents </span><span class="s1">== </span><span class="s3">null</span><span class="s1">) </span><span class="s3">return false</span><span class="s1">;</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">contents </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
      <span class="s3">return true</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">assertCollection</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">contents</span><span class="s1">);</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">contents</span><span class="s1">.</span><span class="s2">deleteIn</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">getDefaults</span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">Document</span><span class="s1">.</span><span class="s2">defaults</span><span class="s1">[</span><span class="s3">this</span><span class="s1">.</span><span class="s2">version</span><span class="s1">] || </span><span class="s2">Document</span><span class="s1">.</span><span class="s2">defaults</span><span class="s1">[</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">version</span><span class="s1">] || {};</span>
  <span class="s1">}</span>

  <span class="s2">get</span><span class="s1">(</span><span class="s2">key</span><span class="s1">, </span><span class="s2">keepScalar</span><span class="s1">) {</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">contents </span><span class="s3">instanceof </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">Collection </span><span class="s1">? </span><span class="s3">this</span><span class="s1">.</span><span class="s2">contents</span><span class="s1">.</span><span class="s2">get</span><span class="s1">(</span><span class="s2">key</span><span class="s1">, </span><span class="s2">keepScalar</span><span class="s1">) : </span><span class="s2">undefined</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">getIn</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">keepScalar</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">isEmptyPath</span><span class="s1">(</span><span class="s2">path</span><span class="s1">)) </span><span class="s3">return </span><span class="s1">!</span><span class="s2">keepScalar </span><span class="s1">&amp;&amp; </span><span class="s3">this</span><span class="s1">.</span><span class="s2">contents </span><span class="s3">instanceof </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">Scalar </span><span class="s1">? </span><span class="s3">this</span><span class="s1">.</span><span class="s2">contents</span><span class="s1">.</span><span class="s2">value </span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">contents</span><span class="s1">;</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">contents </span><span class="s3">instanceof </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">Collection </span><span class="s1">? </span><span class="s3">this</span><span class="s1">.</span><span class="s2">contents</span><span class="s1">.</span><span class="s2">getIn</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">keepScalar</span><span class="s1">) : </span><span class="s2">undefined</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">has</span><span class="s1">(</span><span class="s2">key</span><span class="s1">) {</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">contents </span><span class="s3">instanceof </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">Collection </span><span class="s1">? </span><span class="s3">this</span><span class="s1">.</span><span class="s2">contents</span><span class="s1">.</span><span class="s2">has</span><span class="s1">(</span><span class="s2">key</span><span class="s1">) : </span><span class="s3">false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">hasIn</span><span class="s1">(</span><span class="s2">path</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">isEmptyPath</span><span class="s1">(</span><span class="s2">path</span><span class="s1">)) </span><span class="s3">return this</span><span class="s1">.</span><span class="s2">contents </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">;</span>
    <span class="s3">return this</span><span class="s1">.</span><span class="s2">contents </span><span class="s3">instanceof </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">Collection </span><span class="s1">? </span><span class="s3">this</span><span class="s1">.</span><span class="s2">contents</span><span class="s1">.</span><span class="s2">hasIn</span><span class="s1">(</span><span class="s2">path</span><span class="s1">) : </span><span class="s3">false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">set</span><span class="s1">(</span><span class="s2">key</span><span class="s1">, </span><span class="s2">value</span><span class="s1">) {</span>
    <span class="s2">assertCollection</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">contents</span><span class="s1">);</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">contents</span><span class="s1">.</span><span class="s2">set</span><span class="s1">(</span><span class="s2">key</span><span class="s1">, </span><span class="s2">value</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">setIn</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">value</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">isEmptyPath</span><span class="s1">(</span><span class="s2">path</span><span class="s1">)) </span><span class="s3">this</span><span class="s1">.</span><span class="s2">contents </span><span class="s1">= </span><span class="s2">value</span><span class="s1">;</span><span class="s3">else </span><span class="s1">{</span>
      <span class="s2">assertCollection</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">contents</span><span class="s1">);</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">contents</span><span class="s1">.</span><span class="s2">setIn</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">value</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">setSchema</span><span class="s1">(</span><span class="s2">id</span><span class="s1">, </span><span class="s2">customTags</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">id </span><span class="s1">&amp;&amp; !</span><span class="s2">customTags </span><span class="s1">&amp;&amp; </span><span class="s3">this</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">) </span><span class="s3">return</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">id </span><span class="s1">=== </span><span class="s0">'number'</span><span class="s1">) </span><span class="s2">id </span><span class="s1">= </span><span class="s2">id</span><span class="s1">.</span><span class="s2">toFixed</span><span class="s1">(</span><span class="s4">1</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">id </span><span class="s1">=== </span><span class="s0">'1.0' </span><span class="s1">|| </span><span class="s2">id </span><span class="s1">=== </span><span class="s0">'1.1' </span><span class="s1">|| </span><span class="s2">id </span><span class="s1">=== </span><span class="s0">'1.2'</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">version</span><span class="s1">) </span><span class="s3">this</span><span class="s1">.</span><span class="s2">version </span><span class="s1">= </span><span class="s2">id</span><span class="s1">;</span><span class="s3">else this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">version </span><span class="s1">= </span><span class="s2">id</span><span class="s1">;</span>
      <span class="s3">delete this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">id </span><span class="s1">&amp;&amp; </span><span class="s3">typeof </span><span class="s2">id </span><span class="s1">=== </span><span class="s0">'string'</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">schema </span><span class="s1">= </span><span class="s2">id</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">customTags</span><span class="s1">)) </span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">customTags </span><span class="s1">= </span><span class="s2">customTags</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">opt </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">assign</span><span class="s1">({}, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getDefaults</span><span class="s1">(), </span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">);</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">schema </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Schema</span><span class="s1">.</span><span class="s2">Schema</span><span class="s1">(</span><span class="s2">opt</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">parse</span><span class="s1">(</span><span class="s2">node</span><span class="s1">, </span><span class="s2">prevDoc</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">keepCstNodes</span><span class="s1">) </span><span class="s3">this</span><span class="s1">.</span><span class="s2">cstNode </span><span class="s1">= </span><span class="s2">node</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">keepNodeTypes</span><span class="s1">) </span><span class="s3">this</span><span class="s1">.</span><span class="s2">type </span><span class="s1">= </span><span class="s0">'DOCUMENT'</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s1">{</span>
      <span class="s2">directives </span><span class="s1">= [],</span>
      <span class="s2">contents </span><span class="s1">= [],</span>
      <span class="s2">directivesEndMarker</span><span class="s1">,</span>
      <span class="s2">error</span><span class="s1">,</span>
      <span class="s2">valueRange</span>
    <span class="s1">} = </span><span class="s2">node</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(!</span><span class="s2">error</span><span class="s1">.</span><span class="s2">source</span><span class="s1">) </span><span class="s2">error</span><span class="s1">.</span><span class="s2">source </span><span class="s1">= </span><span class="s3">this</span><span class="s1">;</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">error</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s2">parseDirectives</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s2">directives</span><span class="s1">, </span><span class="s2">prevDoc</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">directivesEndMarker</span><span class="s1">) </span><span class="s3">this</span><span class="s1">.</span><span class="s2">directivesEndMarker </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">range </span><span class="s1">= </span><span class="s2">valueRange </span><span class="s1">? [</span><span class="s2">valueRange</span><span class="s1">.</span><span class="s2">start</span><span class="s1">, </span><span class="s2">valueRange</span><span class="s1">.</span><span class="s2">end</span><span class="s1">] : </span><span class="s3">null</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">setSchema</span><span class="s1">();</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">anchors</span><span class="s1">.</span><span class="s2">_cstAliases </span><span class="s1">= [];</span>
    <span class="s2">parseContents</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s2">contents</span><span class="s1">);</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">anchors</span><span class="s1">.</span><span class="s2">resolveNodes</span><span class="s1">();</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">prettyErrors</span><span class="s1">) {</span>
      <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">error of </span><span class="s3">this</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">) </span><span class="s3">if </span><span class="s1">(</span><span class="s2">error </span><span class="s3">instanceof </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLError</span><span class="s1">) </span><span class="s2">error</span><span class="s1">.</span><span class="s2">makePretty</span><span class="s1">();</span>

      <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">warn of </span><span class="s3">this</span><span class="s1">.</span><span class="s2">warnings</span><span class="s1">) </span><span class="s3">if </span><span class="s1">(</span><span class="s2">warn </span><span class="s3">instanceof </span><span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">YAMLError</span><span class="s1">) </span><span class="s2">warn</span><span class="s1">.</span><span class="s2">makePretty</span><span class="s1">();</span>
    <span class="s1">}</span>

    <span class="s3">return this</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">listNonDefaultTags</span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">listTagNames</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">contents</span><span class="s1">).</span><span class="s2">filter</span><span class="s1">(</span><span class="s2">t </span><span class="s1">=&gt; </span><span class="s2">t</span><span class="s1">.</span><span class="s2">indexOf</span><span class="s1">(</span><span class="s2">Schema</span><span class="s1">.</span><span class="s2">Schema</span><span class="s1">.</span><span class="s2">defaultPrefix</span><span class="s1">) !== </span><span class="s4">0</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">setTagPrefix</span><span class="s1">(</span><span class="s2">handle</span><span class="s1">, </span><span class="s2">prefix</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">handle</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] !== </span><span class="s0">'!' </span><span class="s1">|| </span><span class="s2">handle</span><span class="s1">[</span><span class="s2">handle</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">1</span><span class="s1">] !== </span><span class="s0">'!'</span><span class="s1">) </span><span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'Handle must start and end with !'</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">prefix</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">prev </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">tagPrefixes</span><span class="s1">.</span><span class="s2">find</span><span class="s1">(</span><span class="s2">p </span><span class="s1">=&gt; </span><span class="s2">p</span><span class="s1">.</span><span class="s2">handle </span><span class="s1">=== </span><span class="s2">handle</span><span class="s1">);</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">prev</span><span class="s1">) </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">prefix </span><span class="s1">= </span><span class="s2">prefix</span><span class="s1">;</span><span class="s3">else this</span><span class="s1">.</span><span class="s2">tagPrefixes</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({</span>
        <span class="s2">handle</span><span class="s1">,</span>
        <span class="s2">prefix</span>
      <span class="s1">});</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">tagPrefixes </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">tagPrefixes</span><span class="s1">.</span><span class="s2">filter</span><span class="s1">(</span><span class="s2">p </span><span class="s1">=&gt; </span><span class="s2">p</span><span class="s1">.</span><span class="s2">handle </span><span class="s1">!== </span><span class="s2">handle</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">toJSON</span><span class="s1">(</span><span class="s2">arg</span><span class="s1">, </span><span class="s2">onAnchor</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s1">{</span>
      <span class="s2">keepBlobsInJSON</span><span class="s1">,</span>
      <span class="s2">mapAsMap</span><span class="s1">,</span>
      <span class="s2">maxAliasCount</span>
    <span class="s1">} = </span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">keep </span><span class="s1">= </span><span class="s2">keepBlobsInJSON </span><span class="s1">&amp;&amp; (</span><span class="s3">typeof </span><span class="s2">arg </span><span class="s1">!== </span><span class="s0">'string' </span><span class="s1">|| !(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">contents </span><span class="s3">instanceof </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">Scalar</span><span class="s1">));</span>
    <span class="s3">const </span><span class="s2">ctx </span><span class="s1">= {</span>
      <span class="s2">doc</span><span class="s1">: </span><span class="s3">this</span><span class="s1">,</span>
      <span class="s2">indentStep</span><span class="s1">: </span><span class="s0">'  '</span><span class="s1">,</span>
      <span class="s2">keep</span><span class="s1">,</span>
      <span class="s2">mapAsMap</span><span class="s1">: </span><span class="s2">keep </span><span class="s1">&amp;&amp; !!</span><span class="s2">mapAsMap</span><span class="s1">,</span>
      <span class="s2">maxAliasCount</span><span class="s1">,</span>
      <span class="s2">stringify </span><span class="s5">// Requiring directly in Pair would create circular dependencies</span>

    <span class="s1">};</span>
    <span class="s3">const </span><span class="s2">anchorNames </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">anchors</span><span class="s1">.</span><span class="s2">map</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">anchorNames</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s4">0</span><span class="s1">) </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">anchors </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Map</span><span class="s1">(</span><span class="s2">anchorNames</span><span class="s1">.</span><span class="s2">map</span><span class="s1">(</span><span class="s2">name </span><span class="s1">=&gt; [</span><span class="s3">this</span><span class="s1">.</span><span class="s2">anchors</span><span class="s1">.</span><span class="s2">map</span><span class="s1">[</span><span class="s2">name</span><span class="s1">], {</span>
      <span class="s2">alias</span><span class="s1">: [],</span>
      <span class="s2">aliasCount</span><span class="s1">: </span><span class="s4">0</span><span class="s1">,</span>
      <span class="s2">count</span><span class="s1">: </span><span class="s4">1</span>
    <span class="s1">}]));</span>
    <span class="s3">const </span><span class="s2">res </span><span class="s1">= </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">toJSON</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">contents</span><span class="s1">, </span><span class="s2">arg</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">);</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">onAnchor </span><span class="s1">=== </span><span class="s0">'function' </span><span class="s1">&amp;&amp; </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">anchors</span><span class="s1">) </span><span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s1">{</span>
      <span class="s2">count</span><span class="s1">,</span>
      <span class="s2">res</span>
    <span class="s1">} </span><span class="s2">of ctx</span><span class="s1">.</span><span class="s2">anchors</span><span class="s1">.</span><span class="s2">values</span><span class="s1">()) </span><span class="s2">onAnchor</span><span class="s1">(</span><span class="s2">res</span><span class="s1">, </span><span class="s2">count</span><span class="s1">);</span>
    <span class="s3">return </span><span class="s2">res</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">toString</span><span class="s1">() {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s4">0</span><span class="s1">) </span><span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">'Document with errors cannot be stringified'</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">indentSize </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">indent</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(!</span><span class="s2">Number</span><span class="s1">.</span><span class="s2">isInteger</span><span class="s1">(</span><span class="s2">indentSize</span><span class="s1">) || </span><span class="s2">indentSize </span><span class="s1">&lt;= </span><span class="s4">0</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">s </span><span class="s1">= </span><span class="s2">JSON</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">(</span><span class="s2">indentSize</span><span class="s1">);</span>
      <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">`&quot;indent&quot; option must be a positive integer, not </span><span class="s2">$</span><span class="s1">{</span><span class="s2">s</span><span class="s1">}</span><span class="s0">`</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">setSchema</span><span class="s1">();</span>
    <span class="s3">const </span><span class="s2">lines </span><span class="s1">= [];</span>
    <span class="s3">let </span><span class="s2">hasDirectives </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">version</span><span class="s1">) {</span>
      <span class="s3">let </span><span class="s2">vd </span><span class="s1">= </span><span class="s0">'%YAML 1.2'</span><span class="s1">;</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">schema</span><span class="s1">.</span><span class="s2">name </span><span class="s1">=== </span><span class="s0">'yaml-1.1'</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">version </span><span class="s1">=== </span><span class="s0">'1.0'</span><span class="s1">) </span><span class="s2">vd </span><span class="s1">= </span><span class="s0">'%YAML:1.0'</span><span class="s1">;</span><span class="s3">else if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">version </span><span class="s1">=== </span><span class="s0">'1.1'</span><span class="s1">) </span><span class="s2">vd </span><span class="s1">= </span><span class="s0">'%YAML 1.1'</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s2">lines</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">vd</span><span class="s1">);</span>
      <span class="s2">hasDirectives </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">const </span><span class="s2">tagNames </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">listNonDefaultTags</span><span class="s1">();</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">tagPrefixes</span><span class="s1">.</span><span class="s2">forEach</span><span class="s1">(({</span>
      <span class="s2">handle</span><span class="s1">,</span>
      <span class="s2">prefix</span>
    <span class="s1">}) =&gt; {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">tagNames</span><span class="s1">.</span><span class="s2">some</span><span class="s1">(</span><span class="s2">t </span><span class="s1">=&gt; </span><span class="s2">t</span><span class="s1">.</span><span class="s2">indexOf</span><span class="s1">(</span><span class="s2">prefix</span><span class="s1">) === </span><span class="s4">0</span><span class="s1">)) {</span>
        <span class="s2">lines</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s0">`%TAG </span><span class="s2">$</span><span class="s1">{</span><span class="s2">handle</span><span class="s1">} </span><span class="s2">$</span><span class="s1">{</span><span class="s2">prefix</span><span class="s1">}</span><span class="s0">`</span><span class="s1">);</span>
        <span class="s2">hasDirectives </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">});</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">hasDirectives </span><span class="s1">|| </span><span class="s3">this</span><span class="s1">.</span><span class="s2">directivesEndMarker</span><span class="s1">) </span><span class="s2">lines</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s0">'---'</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">commentBefore</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">hasDirectives </span><span class="s1">|| !</span><span class="s3">this</span><span class="s1">.</span><span class="s2">directivesEndMarker</span><span class="s1">) </span><span class="s2">lines</span><span class="s1">.</span><span class="s2">unshift</span><span class="s1">(</span><span class="s0">''</span><span class="s1">);</span>
      <span class="s2">lines</span><span class="s1">.</span><span class="s2">unshift</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">commentBefore</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s6">/^/gm</span><span class="s1">, </span><span class="s0">'#'</span><span class="s1">));</span>
    <span class="s1">}</span>

    <span class="s3">const </span><span class="s2">ctx </span><span class="s1">= {</span>
      <span class="s2">anchors</span><span class="s1">: </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">create</span><span class="s1">(</span><span class="s3">null</span><span class="s1">),</span>
      <span class="s2">doc</span><span class="s1">: </span><span class="s3">this</span><span class="s1">,</span>
      <span class="s2">indent</span><span class="s1">: </span><span class="s0">''</span><span class="s1">,</span>
      <span class="s2">indentStep</span><span class="s1">: </span><span class="s0">' '</span><span class="s1">.</span><span class="s2">repeat</span><span class="s1">(</span><span class="s2">indentSize</span><span class="s1">),</span>
      <span class="s2">stringify </span><span class="s5">// Requiring directly in nodes would create circular dependencies</span>

    <span class="s1">};</span>
    <span class="s3">let </span><span class="s2">chompKeep </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s3">let </span><span class="s2">contentComment </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">contents</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">contents </span><span class="s3">instanceof </span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">Node</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">contents</span><span class="s1">.</span><span class="s2">spaceBefore </span><span class="s1">&amp;&amp; (</span><span class="s2">hasDirectives </span><span class="s1">|| </span><span class="s3">this</span><span class="s1">.</span><span class="s2">directivesEndMarker</span><span class="s1">)) </span><span class="s2">lines</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s0">''</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">contents</span><span class="s1">.</span><span class="s2">commentBefore</span><span class="s1">) </span><span class="s2">lines</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">contents</span><span class="s1">.</span><span class="s2">commentBefore</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s6">/^/gm</span><span class="s1">, </span><span class="s0">'#'</span><span class="s1">)); </span><span class="s5">// top-level block scalars need to be indented if followed by a comment</span>

        <span class="s2">ctx</span><span class="s1">.</span><span class="s2">forceBlockIndent </span><span class="s1">= !!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">comment</span><span class="s1">;</span>
        <span class="s2">contentComment </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">contents</span><span class="s1">.</span><span class="s2">comment</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s3">const </span><span class="s2">onChompKeep </span><span class="s1">= </span><span class="s2">contentComment </span><span class="s1">? </span><span class="s3">null </span><span class="s1">: () =&gt; </span><span class="s2">chompKeep </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
      <span class="s3">const </span><span class="s2">body </span><span class="s1">= </span><span class="s2">stringify</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">contents</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">, () =&gt; </span><span class="s2">contentComment </span><span class="s1">= </span><span class="s3">null</span><span class="s1">, </span><span class="s2">onChompKeep</span><span class="s1">);</span>
      <span class="s2">lines</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">resolveSeq</span><span class="s1">.</span><span class="s2">addComment</span><span class="s1">(</span><span class="s2">body</span><span class="s1">, </span><span class="s0">''</span><span class="s1">, </span><span class="s2">contentComment</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">contents </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) {</span>
      <span class="s2">lines</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">stringify</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">contents</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">));</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">comment</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">((!</span><span class="s2">chompKeep </span><span class="s1">|| </span><span class="s2">contentComment</span><span class="s1">) &amp;&amp; </span><span class="s2">lines</span><span class="s1">[</span><span class="s2">lines</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">1</span><span class="s1">] !== </span><span class="s0">''</span><span class="s1">) </span><span class="s2">lines</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s0">''</span><span class="s1">);</span>
      <span class="s2">lines</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">comment</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s6">/^/gm</span><span class="s1">, </span><span class="s0">'#'</span><span class="s1">));</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s2">lines</span><span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">) + </span><span class="s0">'</span><span class="s3">\n</span><span class="s0">'</span><span class="s1">;</span>
  <span class="s1">}</span>

<span class="s1">}</span>

<span class="s2">PlainValue</span><span class="s1">.</span><span class="s2">_defineProperty</span><span class="s1">(</span><span class="s2">Document</span><span class="s1">, </span><span class="s0">&quot;defaults&quot;</span><span class="s1">, </span><span class="s2">documentOptions</span><span class="s1">);</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">Document </span><span class="s1">= </span><span class="s2">Document</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">defaultOptions </span><span class="s1">= </span><span class="s2">defaultOptions</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">scalarOptions </span><span class="s1">= </span><span class="s2">scalarOptions</span><span class="s1">;</span>
</pre>
</body>
</html>