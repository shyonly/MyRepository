<html>
<head>
<title>xhr.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #67a37c; font-style: italic;}
.s2 { color: #bcbec4;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #7a7e85;}
.s7 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
xhr.js</font>
</center></td></tr></table>
<pre><span class="s0">/**</span>
 <span class="s0">* XmlHttpRequest implementation that uses TLS and flash SocketPool.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@author </span><span class="s0">Dave Longley</span>
 <span class="s0">*</span>
 <span class="s0">* Copyright (c) 2010-2013 Digital Bazaar, Inc.</span>
 <span class="s0">*/</span>
<span class="s3">var </span><span class="s2">forge </span><span class="s4">= </span><span class="s2">require</span><span class="s4">(</span><span class="s5">'./forge'</span><span class="s4">);</span>
<span class="s2">require</span><span class="s4">(</span><span class="s5">'./socket'</span><span class="s4">);</span>
<span class="s2">require</span><span class="s4">(</span><span class="s5">'./http'</span><span class="s4">);</span>

<span class="s6">/* XHR API */</span>
<span class="s3">var </span><span class="s2">xhrApi </span><span class="s4">= </span><span class="s2">module</span><span class="s4">.</span><span class="s2">exports </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">xhr </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">xhr </span><span class="s4">|| {};</span>

<span class="s4">(</span><span class="s3">function</span><span class="s4">(</span><span class="s2">$</span><span class="s4">) {</span>

<span class="s6">// logging category</span>
<span class="s3">var </span><span class="s2">cat </span><span class="s4">= </span><span class="s5">'forge.xhr'</span><span class="s4">;</span>

<span class="s6">/* 
XMLHttpRequest interface definition from: 
http://www.w3.org/TR/XMLHttpRequest 
 
interface XMLHttpRequest { 
  // event handler 
  attribute EventListener onreadystatechange; 
 
  // state 
  const unsigned short UNSENT = 0; 
  const unsigned short OPENED = 1; 
  const unsigned short HEADERS_RECEIVED = 2; 
  const unsigned short LOADING = 3; 
  const unsigned short DONE = 4; 
  readonly attribute unsigned short readyState; 
 
  // request 
  void open(in DOMString method, in DOMString url); 
  void open(in DOMString method, in DOMString url, in boolean async); 
  void open(in DOMString method, in DOMString url, 
            in boolean async, in DOMString user); 
  void open(in DOMString method, in DOMString url, 
            in boolean async, in DOMString user, in DOMString password); 
  void setRequestHeader(in DOMString header, in DOMString value); 
  void send(); 
  void send(in DOMString data); 
  void send(in Document data); 
  void abort(); 
 
  // response 
  DOMString getAllResponseHeaders(); 
  DOMString getResponseHeader(in DOMString header); 
  readonly attribute DOMString responseText; 
  readonly attribute Document responseXML; 
  readonly attribute unsigned short status; 
  readonly attribute DOMString statusText; 
}; 
*/</span>

<span class="s6">// readyStates</span>
<span class="s3">var </span><span class="s2">UNSENT </span><span class="s4">= </span><span class="s7">0</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">OPENED </span><span class="s4">= </span><span class="s7">1</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">HEADERS_RECEIVED </span><span class="s4">= </span><span class="s7">2</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">LOADING </span><span class="s4">= </span><span class="s7">3</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">DONE </span><span class="s4">= </span><span class="s7">4</span><span class="s4">;</span>

<span class="s6">// exceptions</span>
<span class="s3">var </span><span class="s2">INVALID_STATE_ERR </span><span class="s4">= </span><span class="s7">11</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">SYNTAX_ERR </span><span class="s4">= </span><span class="s7">12</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">SECURITY_ERR </span><span class="s4">= </span><span class="s7">18</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">NETWORK_ERR </span><span class="s4">= </span><span class="s7">19</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">ABORT_ERR </span><span class="s4">= </span><span class="s7">20</span><span class="s4">;</span>

<span class="s6">// private flash socket pool vars</span>
<span class="s3">var </span><span class="s2">_sp </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">_policyPort </span><span class="s4">= </span><span class="s7">0</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">_policyUrl </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>

<span class="s6">// default client (used if no special URL provided when creating an XHR)</span>
<span class="s3">var </span><span class="s2">_client </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>

<span class="s6">// all clients including the default, key'd by full base url</span>
<span class="s6">// (multiple cross-domain http clients are permitted so there may be more</span>
<span class="s6">// than one client in this map)</span>
<span class="s6">// TODO: provide optional clean up API for non-default clients</span>
<span class="s3">var </span><span class="s2">_clients </span><span class="s4">= {};</span>

<span class="s6">// the default maximum number of concurrents connections per client</span>
<span class="s3">var </span><span class="s2">_maxConnections </span><span class="s4">= </span><span class="s7">10</span><span class="s4">;</span>

<span class="s3">var </span><span class="s2">net </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">net</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">http </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">http</span><span class="s4">;</span>

<span class="s0">/**</span>
 <span class="s0">* Initializes flash XHR support.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">options:</span>
 <span class="s0">*   url: the default base URL to connect to if xhr URLs are relative,</span>
 <span class="s0">*     ie: https://myserver.com.</span>
 <span class="s0">*   flashId: the dom ID of the flash SocketPool.</span>
 <span class="s0">*   policyPort: the port that provides the server's flash policy, 0 to use</span>
 <span class="s0">*     the flash default.</span>
 <span class="s0">*   policyUrl: the policy file URL to use instead of a policy port.</span>
 <span class="s0">*   msie: true if browser is internet explorer, false if not.</span>
 <span class="s0">*   connections: the maximum number of concurrent connections.</span>
 <span class="s0">*   caCerts: a list of PEM-formatted certificates to trust.</span>
 <span class="s0">*   cipherSuites: an optional array of cipher suites to use,</span>
 <span class="s0">*     see forge.tls.CipherSuites.</span>
 <span class="s0">*   verify: optional TLS certificate verify callback to use (see forge.tls</span>
 <span class="s0">*     for details).</span>
 <span class="s0">*   getCertificate: an optional callback used to get a client-side</span>
 <span class="s0">*     certificate (see forge.tls for details).</span>
 <span class="s0">*   getPrivateKey: an optional callback used to get a client-side private</span>
 <span class="s0">*     key (see forge.tls for details).</span>
 <span class="s0">*   getSignature: an optional callback used to get a client-side signature</span>
 <span class="s0">*     (see forge.tls for details).</span>
 <span class="s0">*   persistCookies: true to use persistent cookies via flash local storage,</span>
 <span class="s0">*     false to only keep cookies in javascript.</span>
 <span class="s0">*   primeTlsSockets: true to immediately connect TLS sockets on their</span>
 <span class="s0">*     creation so that they will cache TLS sessions for reuse.</span>
 <span class="s0">*/</span>
<span class="s2">xhrApi</span><span class="s4">.</span><span class="s2">init </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">options</span><span class="s4">) {</span>
  <span class="s2">forge</span><span class="s4">.</span><span class="s2">log</span><span class="s4">.</span><span class="s2">debug</span><span class="s4">(</span><span class="s2">cat</span><span class="s4">, </span><span class="s5">'initializing'</span><span class="s4">, </span><span class="s2">options</span><span class="s4">);</span>

  <span class="s6">// update default policy port and max connections</span>
  <span class="s2">_policyPort </span><span class="s4">= </span><span class="s2">options</span><span class="s4">.</span><span class="s2">policyPort </span><span class="s4">|| </span><span class="s2">_policyPort</span><span class="s4">;</span>
  <span class="s2">_policyUrl </span><span class="s4">= </span><span class="s2">options</span><span class="s4">.</span><span class="s2">policyUrl </span><span class="s4">|| </span><span class="s2">_policyUrl</span><span class="s4">;</span>
  <span class="s2">_maxConnections </span><span class="s4">= </span><span class="s2">options</span><span class="s4">.</span><span class="s2">connections </span><span class="s4">|| </span><span class="s2">_maxConnections</span><span class="s4">;</span>

  <span class="s6">// create the flash socket pool</span>
  <span class="s2">_sp </span><span class="s4">= </span><span class="s2">net</span><span class="s4">.</span><span class="s2">createSocketPool</span><span class="s4">({</span>
    <span class="s2">flashId</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">flashId</span><span class="s4">,</span>
    <span class="s2">policyPort</span><span class="s4">: </span><span class="s2">_policyPort</span><span class="s4">,</span>
    <span class="s2">policyUrl</span><span class="s4">: </span><span class="s2">_policyUrl</span><span class="s4">,</span>
    <span class="s2">msie</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">msie </span><span class="s4">|| </span><span class="s3">false</span>
  <span class="s4">});</span>

  <span class="s6">// create default http client</span>
  <span class="s2">_client </span><span class="s4">= </span><span class="s2">http</span><span class="s4">.</span><span class="s2">createClient</span><span class="s4">({</span>
    <span class="s2">url</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">url </span><span class="s4">|| (</span>
      <span class="s2">window</span><span class="s4">.</span><span class="s2">location</span><span class="s4">.</span><span class="s2">protocol </span><span class="s4">+ </span><span class="s5">'//' </span><span class="s4">+ </span><span class="s2">window</span><span class="s4">.</span><span class="s2">location</span><span class="s4">.</span><span class="s2">host</span><span class="s4">),</span>
    <span class="s2">socketPool</span><span class="s4">: </span><span class="s2">_sp</span><span class="s4">,</span>
    <span class="s2">policyPort</span><span class="s4">: </span><span class="s2">_policyPort</span><span class="s4">,</span>
    <span class="s2">policyUrl</span><span class="s4">: </span><span class="s2">_policyUrl</span><span class="s4">,</span>
    <span class="s2">connections</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">connections </span><span class="s4">|| </span><span class="s2">_maxConnections</span><span class="s4">,</span>
    <span class="s2">caCerts</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">caCerts</span><span class="s4">,</span>
    <span class="s2">cipherSuites</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">cipherSuites</span><span class="s4">,</span>
    <span class="s2">persistCookies</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">persistCookies </span><span class="s4">|| </span><span class="s3">true</span><span class="s4">,</span>
    <span class="s2">primeTlsSockets</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">primeTlsSockets </span><span class="s4">|| </span><span class="s3">false</span><span class="s4">,</span>
    <span class="s2">verify</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">verify</span><span class="s4">,</span>
    <span class="s2">getCertificate</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">getCertificate</span><span class="s4">,</span>
    <span class="s2">getPrivateKey</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">getPrivateKey</span><span class="s4">,</span>
    <span class="s2">getSignature</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">getSignature</span>
  <span class="s4">});</span>
  <span class="s2">_clients</span><span class="s4">[</span><span class="s2">_client</span><span class="s4">.</span><span class="s2">url</span><span class="s4">.</span><span class="s2">origin</span><span class="s4">] = </span><span class="s2">_client</span><span class="s4">;</span>

  <span class="s2">forge</span><span class="s4">.</span><span class="s2">log</span><span class="s4">.</span><span class="s2">debug</span><span class="s4">(</span><span class="s2">cat</span><span class="s4">, </span><span class="s5">'ready'</span><span class="s4">);</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Called to clean up the clients and socket pool.</span>
 <span class="s0">*/</span>
<span class="s2">xhrApi</span><span class="s4">.</span><span class="s2">cleanup </span><span class="s4">= </span><span class="s3">function</span><span class="s4">() {</span>
  <span class="s6">// destroy all clients</span>
  <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">key </span><span class="s3">in </span><span class="s2">_clients</span><span class="s4">) {</span>
    <span class="s2">_clients</span><span class="s4">[</span><span class="s2">key</span><span class="s4">].</span><span class="s2">destroy</span><span class="s4">();</span>
  <span class="s4">}</span>
  <span class="s2">_clients </span><span class="s4">= {};</span>
  <span class="s2">_client </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>

  <span class="s6">// destroy socket pool</span>
  <span class="s2">_sp</span><span class="s4">.</span><span class="s2">destroy</span><span class="s4">();</span>
  <span class="s2">_sp </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Sets a cookie.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">cookie the cookie with parameters:</span>
 <span class="s0">*   name: the name of the cookie.</span>
 <span class="s0">*   value: the value of the cookie.</span>
 <span class="s0">*   comment: an optional comment string.</span>
 <span class="s0">*   maxAge: the age of the cookie in seconds relative to created time.</span>
 <span class="s0">*   secure: true if the cookie must be sent over a secure protocol.</span>
 <span class="s0">*   httpOnly: true to restrict access to the cookie from javascript</span>
 <span class="s0">*     (inaffective since the cookies are stored in javascript).</span>
 <span class="s0">*   path: the path for the cookie.</span>
 <span class="s0">*   domain: optional domain the cookie belongs to (must start with dot).</span>
 <span class="s0">*   version: optional version of the cookie.</span>
 <span class="s0">*   created: creation time, in UTC seconds, of the cookie.</span>
 <span class="s0">*/</span>
<span class="s2">xhrApi</span><span class="s4">.</span><span class="s2">setCookie </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">cookie</span><span class="s4">) {</span>
  <span class="s6">// default cookie expiration to never</span>
  <span class="s2">cookie</span><span class="s4">.</span><span class="s2">maxAge </span><span class="s4">= </span><span class="s2">cookie</span><span class="s4">.</span><span class="s2">maxAge </span><span class="s4">|| -</span><span class="s7">1</span><span class="s4">;</span>

  <span class="s6">// if the cookie's domain is set, use the appropriate client</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">cookie</span><span class="s4">.</span><span class="s2">domain</span><span class="s4">) {</span>
    <span class="s6">// add the cookies to the applicable domains</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">key </span><span class="s3">in </span><span class="s2">_clients</span><span class="s4">) {</span>
      <span class="s3">var </span><span class="s2">client </span><span class="s4">= </span><span class="s2">_clients</span><span class="s4">[</span><span class="s2">key</span><span class="s4">];</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">http</span><span class="s4">.</span><span class="s2">withinCookieDomain</span><span class="s4">(</span><span class="s2">client</span><span class="s4">.</span><span class="s2">url</span><span class="s4">, </span><span class="s2">cookie</span><span class="s4">) &amp;&amp;</span>
        <span class="s2">client</span><span class="s4">.</span><span class="s2">secure </span><span class="s4">=== </span><span class="s2">cookie</span><span class="s4">.</span><span class="s2">secure</span><span class="s4">) {</span>
        <span class="s2">client</span><span class="s4">.</span><span class="s2">setCookie</span><span class="s4">(</span><span class="s2">cookie</span><span class="s4">);</span>
      <span class="s4">}</span>
    <span class="s4">}</span>
  <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
    <span class="s6">// use the default domain</span>
    <span class="s6">// FIXME: should a null domain cookie be added to all clients? should</span>
    <span class="s6">// this be an option?</span>
    <span class="s2">_client</span><span class="s4">.</span><span class="s2">setCookie</span><span class="s4">(</span><span class="s2">cookie</span><span class="s4">);</span>
  <span class="s4">}</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Gets a cookie.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">name the name of the cookie.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">path an optional path for the cookie (if there are multiple cookies</span>
 <span class="s0">*          with the same name but different paths).</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">domain an optional domain for the cookie (if not using the default</span>
 <span class="s0">*          domain).</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the cookie, cookies (if multiple matches), or null if not found.</span>
 <span class="s0">*/</span>
<span class="s2">xhrApi</span><span class="s4">.</span><span class="s2">getCookie </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">name</span><span class="s4">, </span><span class="s2">path</span><span class="s4">, </span><span class="s2">domain</span><span class="s4">) {</span>
  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>

  <span class="s3">if</span><span class="s4">(</span><span class="s2">domain</span><span class="s4">) {</span>
    <span class="s6">// get the cookies from the applicable domains</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">key </span><span class="s3">in </span><span class="s2">_clients</span><span class="s4">) {</span>
      <span class="s3">var </span><span class="s2">client </span><span class="s4">= </span><span class="s2">_clients</span><span class="s4">[</span><span class="s2">key</span><span class="s4">];</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">http</span><span class="s4">.</span><span class="s2">withinCookieDomain</span><span class="s4">(</span><span class="s2">client</span><span class="s4">.</span><span class="s2">url</span><span class="s4">, </span><span class="s2">domain</span><span class="s4">)) {</span>
        <span class="s3">var </span><span class="s2">cookie </span><span class="s4">= </span><span class="s2">client</span><span class="s4">.</span><span class="s2">getCookie</span><span class="s4">(</span><span class="s2">name</span><span class="s4">, </span><span class="s2">path</span><span class="s4">);</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s2">cookie </span><span class="s4">!== </span><span class="s3">null</span><span class="s4">) {</span>
          <span class="s3">if</span><span class="s4">(</span><span class="s2">rval </span><span class="s4">=== </span><span class="s3">null</span><span class="s4">) {</span>
            <span class="s2">rval </span><span class="s4">= </span><span class="s2">cookie</span><span class="s4">;</span>
          <span class="s4">} </span><span class="s3">else if</span><span class="s4">(!</span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">isArray</span><span class="s4">(</span><span class="s2">rval</span><span class="s4">)) {</span>
            <span class="s2">rval </span><span class="s4">= [</span><span class="s2">rval</span><span class="s4">, </span><span class="s2">cookie</span><span class="s4">];</span>
          <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
            <span class="s2">rval</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">cookie</span><span class="s4">);</span>
          <span class="s4">}</span>
        <span class="s4">}</span>
      <span class="s4">}</span>
    <span class="s4">}</span>
  <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
    <span class="s6">// get cookie from default domain</span>
    <span class="s2">rval </span><span class="s4">= </span><span class="s2">_client</span><span class="s4">.</span><span class="s2">getCookie</span><span class="s4">(</span><span class="s2">name</span><span class="s4">, </span><span class="s2">path</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Removes a cookie.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">name the name of the cookie.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">path an optional path for the cookie (if there are multiple cookies</span>
 <span class="s0">*          with the same name but different paths).</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">domain an optional domain for the cookie (if not using the default</span>
 <span class="s0">*          domain).</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">true if a cookie was removed, false if not.</span>
 <span class="s0">*/</span>
<span class="s2">xhrApi</span><span class="s4">.</span><span class="s2">removeCookie </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">name</span><span class="s4">, </span><span class="s2">path</span><span class="s4">, </span><span class="s2">domain</span><span class="s4">) {</span>
  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>

  <span class="s3">if</span><span class="s4">(</span><span class="s2">domain</span><span class="s4">) {</span>
    <span class="s6">// remove the cookies from the applicable domains</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">key </span><span class="s3">in </span><span class="s2">_clients</span><span class="s4">) {</span>
      <span class="s3">var </span><span class="s2">client </span><span class="s4">= </span><span class="s2">_clients</span><span class="s4">[</span><span class="s2">key</span><span class="s4">];</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">http</span><span class="s4">.</span><span class="s2">withinCookieDomain</span><span class="s4">(</span><span class="s2">client</span><span class="s4">.</span><span class="s2">url</span><span class="s4">, </span><span class="s2">domain</span><span class="s4">)) {</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s2">client</span><span class="s4">.</span><span class="s2">removeCookie</span><span class="s4">(</span><span class="s2">name</span><span class="s4">, </span><span class="s2">path</span><span class="s4">)) {</span>
           <span class="s2">rval </span><span class="s4">= </span><span class="s3">true</span><span class="s4">;</span>
        <span class="s4">}</span>
      <span class="s4">}</span>
    <span class="s4">}</span>
  <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
    <span class="s6">// remove cookie from default domain</span>
    <span class="s2">rval </span><span class="s4">= </span><span class="s2">_client</span><span class="s4">.</span><span class="s2">removeCookie</span><span class="s4">(</span><span class="s2">name</span><span class="s4">, </span><span class="s2">path</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Creates a new XmlHttpRequest. By default the base URL, flash policy port,</span>
 <span class="s0">* etc, will be used. However, an XHR can be created to point at another</span>
 <span class="s0">* cross-domain URL.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">options:</span>
 <span class="s0">*   logWarningOnError: If true and an HTTP error status code is received then</span>
 <span class="s0">*     log a warning, otherwise log a verbose message.</span>
 <span class="s0">*   verbose: If true be very verbose in the output including the response</span>
 <span class="s0">*     event and response body, otherwise only include status, timing, and</span>
 <span class="s0">*     data size.</span>
 <span class="s0">*   logError: a multi-var log function for warnings that takes the log</span>
 <span class="s0">*     category as the first var.</span>
 <span class="s0">*   logWarning: a multi-var log function for warnings that takes the log</span>
 <span class="s0">*     category as the first var.</span>
 <span class="s0">*   logDebug: a multi-var log function for warnings that takes the log</span>
 <span class="s0">*     category as the first var.</span>
 <span class="s0">*   logVerbose: a multi-var log function for warnings that takes the log</span>
 <span class="s0">*     category as the first var.</span>
 <span class="s0">*   url: the default base URL to connect to if xhr URLs are relative,</span>
 <span class="s0">*     eg: https://myserver.com, and note that the following options will be</span>
 <span class="s0">*     ignored if the URL is absent or the same as the default base URL.</span>
 <span class="s0">*   policyPort: the port that provides the server's flash policy, 0 to use</span>
 <span class="s0">*     the flash default.</span>
 <span class="s0">*   policyUrl: the policy file URL to use instead of a policy port.</span>
 <span class="s0">*   connections: the maximum number of concurrent connections.</span>
 <span class="s0">*   caCerts: a list of PEM-formatted certificates to trust.</span>
 <span class="s0">*   cipherSuites: an optional array of cipher suites to use, see</span>
 <span class="s0">*     forge.tls.CipherSuites.</span>
 <span class="s0">*   verify: optional TLS certificate verify callback to use (see forge.tls</span>
 <span class="s0">*     for details).</span>
 <span class="s0">*   getCertificate: an optional callback used to get a client-side</span>
 <span class="s0">*     certificate.</span>
 <span class="s0">*   getPrivateKey: an optional callback used to get a client-side private key.</span>
 <span class="s0">*   getSignature: an optional callback used to get a client-side signature.</span>
 <span class="s0">*   persistCookies: true to use persistent cookies via flash local storage,</span>
 <span class="s0">*     false to only keep cookies in javascript.</span>
 <span class="s0">*   primeTlsSockets: true to immediately connect TLS sockets on their</span>
 <span class="s0">*     creation so that they will cache TLS sessions for reuse.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the XmlHttpRequest.</span>
 <span class="s0">*/</span>
<span class="s2">xhrApi</span><span class="s4">.</span><span class="s2">create </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">options</span><span class="s4">) {</span>
  <span class="s6">// set option defaults</span>
  <span class="s2">options </span><span class="s4">= </span><span class="s2">$</span><span class="s4">.</span><span class="s2">extend</span><span class="s4">({</span>
    <span class="s2">logWarningOnError</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
    <span class="s2">verbose</span><span class="s4">: </span><span class="s3">false</span><span class="s4">,</span>
    <span class="s2">logError</span><span class="s4">: </span><span class="s3">function</span><span class="s4">() {},</span>
    <span class="s2">logWarning</span><span class="s4">: </span><span class="s3">function</span><span class="s4">() {},</span>
    <span class="s2">logDebug</span><span class="s4">: </span><span class="s3">function</span><span class="s4">() {},</span>
    <span class="s2">logVerbose</span><span class="s4">: </span><span class="s3">function</span><span class="s4">() {},</span>
    <span class="s2">url</span><span class="s4">: </span><span class="s3">null</span>
  <span class="s4">}, </span><span class="s2">options </span><span class="s4">|| {});</span>

  <span class="s6">// private xhr state</span>
  <span class="s3">var </span><span class="s2">_state </span><span class="s4">= {</span>
    <span class="s6">// the http client to use</span>
    <span class="s2">client</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
    <span class="s6">// request storage</span>
    <span class="s2">request</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
    <span class="s6">// response storage</span>
    <span class="s2">response</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
    <span class="s6">// asynchronous, true if doing asynchronous communication</span>
    <span class="s2">asynchronous</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
    <span class="s6">// sendFlag, true if send has been called</span>
    <span class="s2">sendFlag</span><span class="s4">: </span><span class="s3">false</span><span class="s4">,</span>
    <span class="s6">// errorFlag, true if a network error occurred</span>
    <span class="s2">errorFlag</span><span class="s4">: </span><span class="s3">false</span>
  <span class="s4">};</span>

  <span class="s6">// private log functions</span>
  <span class="s3">var </span><span class="s2">_log </span><span class="s4">= {</span>
    <span class="s2">error</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">logError </span><span class="s4">|| </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">log</span><span class="s4">.</span><span class="s2">error</span><span class="s4">,</span>
    <span class="s2">warning</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">logWarning </span><span class="s4">|| </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">log</span><span class="s4">.</span><span class="s2">warning</span><span class="s4">,</span>
    <span class="s2">debug</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">logDebug </span><span class="s4">|| </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">log</span><span class="s4">.</span><span class="s2">debug</span><span class="s4">,</span>
    <span class="s2">verbose</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">logVerbose </span><span class="s4">|| </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">log</span><span class="s4">.</span><span class="s2">verbose</span>
  <span class="s4">};</span>

  <span class="s6">// create public xhr interface</span>
  <span class="s3">var </span><span class="s2">xhr </span><span class="s4">= {</span>
    <span class="s6">// an EventListener</span>
    <span class="s2">onreadystatechange</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
    <span class="s6">// readonly, the current readyState</span>
    <span class="s2">readyState</span><span class="s4">: </span><span class="s2">UNSENT</span><span class="s4">,</span>
    <span class="s6">// a string with the response entity-body</span>
    <span class="s2">responseText</span><span class="s4">: </span><span class="s5">''</span><span class="s4">,</span>
    <span class="s6">// a Document for response entity-bodies that are XML</span>
    <span class="s2">responseXML</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
    <span class="s6">// readonly, returns the HTTP status code (i.e. 404)</span>
    <span class="s2">status</span><span class="s4">: </span><span class="s7">0</span><span class="s4">,</span>
    <span class="s6">// readonly, returns the HTTP status message (i.e. 'Not Found')</span>
    <span class="s2">statusText</span><span class="s4">: </span><span class="s5">''</span>
  <span class="s4">};</span>

  <span class="s6">// determine which http client to use</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">options</span><span class="s4">.</span><span class="s2">url </span><span class="s4">=== </span><span class="s3">null</span><span class="s4">) {</span>
    <span class="s6">// use default</span>
    <span class="s2">_state</span><span class="s4">.</span><span class="s2">client </span><span class="s4">= </span><span class="s2">_client</span><span class="s4">;</span>
  <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
    <span class="s3">var </span><span class="s2">url</span><span class="s4">;</span>
    <span class="s3">try </span><span class="s4">{</span>
      <span class="s2">url </span><span class="s4">= </span><span class="s3">new </span><span class="s2">URL</span><span class="s4">(</span><span class="s2">options</span><span class="s4">.</span><span class="s2">url</span><span class="s4">);</span>
    <span class="s4">} </span><span class="s3">catch</span><span class="s4">(</span><span class="s2">e</span><span class="s4">) {</span>
      <span class="s3">var </span><span class="s2">error </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Invalid url.'</span><span class="s4">);</span>
      <span class="s2">error</span><span class="s4">.</span><span class="s2">details </span><span class="s4">= {</span>
        <span class="s2">url</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">url</span>
      <span class="s4">};</span>
    <span class="s4">}</span>

    <span class="s6">// find client</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">url</span><span class="s4">.</span><span class="s2">origin </span><span class="s3">in </span><span class="s2">_clients</span><span class="s4">) {</span>
      <span class="s6">// client found</span>
      <span class="s2">_state</span><span class="s4">.</span><span class="s2">client </span><span class="s4">= </span><span class="s2">_clients</span><span class="s4">[</span><span class="s2">url</span><span class="s4">.</span><span class="s2">origin</span><span class="s4">];</span>
    <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
      <span class="s6">// create client</span>
      <span class="s2">_state</span><span class="s4">.</span><span class="s2">client </span><span class="s4">= </span><span class="s2">http</span><span class="s4">.</span><span class="s2">createClient</span><span class="s4">({</span>
        <span class="s2">url</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">url</span><span class="s4">,</span>
        <span class="s2">socketPool</span><span class="s4">: </span><span class="s2">_sp</span><span class="s4">,</span>
        <span class="s2">policyPort</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">policyPort </span><span class="s4">|| </span><span class="s2">_policyPort</span><span class="s4">,</span>
        <span class="s2">policyUrl</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">policyUrl </span><span class="s4">|| </span><span class="s2">_policyUrl</span><span class="s4">,</span>
        <span class="s2">connections</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">connections </span><span class="s4">|| </span><span class="s2">_maxConnections</span><span class="s4">,</span>
        <span class="s2">caCerts</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">caCerts</span><span class="s4">,</span>
        <span class="s2">cipherSuites</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">cipherSuites</span><span class="s4">,</span>
        <span class="s2">persistCookies</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">persistCookies </span><span class="s4">|| </span><span class="s3">true</span><span class="s4">,</span>
        <span class="s2">primeTlsSockets</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">primeTlsSockets </span><span class="s4">|| </span><span class="s3">false</span><span class="s4">,</span>
        <span class="s2">verify</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">verify</span><span class="s4">,</span>
        <span class="s2">getCertificate</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">getCertificate</span><span class="s4">,</span>
        <span class="s2">getPrivateKey</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">getPrivateKey</span><span class="s4">,</span>
        <span class="s2">getSignature</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">getSignature</span>
      <span class="s4">});</span>
      <span class="s2">_clients</span><span class="s4">[</span><span class="s2">url</span><span class="s4">.</span><span class="s2">origin</span><span class="s4">] = </span><span class="s2">_state</span><span class="s4">.</span><span class="s2">client</span><span class="s4">;</span>
    <span class="s4">}</span>
  <span class="s4">}</span>

  <span class="s0">/**</span>
   <span class="s0">* Opens the request. This method will create the HTTP request to send.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">method the HTTP method (i.e. 'GET').</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">url the relative url (the HTTP request path).</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">async always true, ignored.</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">user always null, ignored.</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">password always null, ignored.</span>
   <span class="s0">*/</span>
  <span class="s2">xhr</span><span class="s4">.</span><span class="s2">open </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">method</span><span class="s4">, </span><span class="s2">url</span><span class="s4">, </span><span class="s2">async</span><span class="s4">, </span><span class="s2">user</span><span class="s4">, </span><span class="s2">password</span><span class="s4">) {</span>
    <span class="s6">// 1. validate Document if one is associated</span>
    <span class="s6">// TODO: not implemented (not used yet)</span>

    <span class="s6">// 2. validate method token</span>
    <span class="s6">// 3. change method to uppercase if it matches a known</span>
    <span class="s6">// method (here we just require it to be uppercase, and</span>
    <span class="s6">// we do not allow the standard methods)</span>
    <span class="s6">// 4. disallow CONNECT, TRACE, or TRACK with a security error</span>
    <span class="s3">switch</span><span class="s4">(</span><span class="s2">method</span><span class="s4">) {</span>
    <span class="s3">case </span><span class="s5">'DELETE'</span><span class="s4">:</span>
    <span class="s3">case </span><span class="s5">'GET'</span><span class="s4">:</span>
    <span class="s3">case </span><span class="s5">'HEAD'</span><span class="s4">:</span>
    <span class="s3">case </span><span class="s5">'OPTIONS'</span><span class="s4">:</span>
    <span class="s3">case </span><span class="s5">'PATCH'</span><span class="s4">:</span>
    <span class="s3">case </span><span class="s5">'POST'</span><span class="s4">:</span>
    <span class="s3">case </span><span class="s5">'PUT'</span><span class="s4">:</span>
      <span class="s6">// valid method</span>
      <span class="s3">break</span><span class="s4">;</span>
    <span class="s3">case </span><span class="s5">'CONNECT'</span><span class="s4">:</span>
    <span class="s3">case </span><span class="s5">'TRACE'</span><span class="s4">:</span>
    <span class="s3">case </span><span class="s5">'TRACK'</span><span class="s4">:</span>
      <span class="s3">throw new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'CONNECT, TRACE and TRACK methods are disallowed'</span><span class="s4">);</span>
    <span class="s3">default</span><span class="s4">:</span>
      <span class="s3">throw new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Invalid method: ' </span><span class="s4">+ </span><span class="s2">method</span><span class="s4">);</span>
    <span class="s4">}</span>

    <span class="s6">// TODO: other validation steps in algorithm are not implemented</span>

    <span class="s6">// 19. set send flag to false</span>
    <span class="s6">// set response body to null</span>
    <span class="s6">// empty list of request headers</span>
    <span class="s6">// set request method to given method</span>
    <span class="s6">// set request URL</span>
    <span class="s6">// set username, password</span>
    <span class="s6">// set asychronous flag</span>
    <span class="s2">_state</span><span class="s4">.</span><span class="s2">sendFlag </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>
    <span class="s2">xhr</span><span class="s4">.</span><span class="s2">responseText </span><span class="s4">= </span><span class="s5">''</span><span class="s4">;</span>
    <span class="s2">xhr</span><span class="s4">.</span><span class="s2">responseXML </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>

    <span class="s6">// custom: reset status and statusText</span>
    <span class="s2">xhr</span><span class="s4">.</span><span class="s2">status </span><span class="s4">= </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s2">xhr</span><span class="s4">.</span><span class="s2">statusText </span><span class="s4">= </span><span class="s5">''</span><span class="s4">;</span>

    <span class="s6">// create the HTTP request</span>
    <span class="s2">_state</span><span class="s4">.</span><span class="s2">request </span><span class="s4">= </span><span class="s2">http</span><span class="s4">.</span><span class="s2">createRequest</span><span class="s4">({</span>
      <span class="s2">method</span><span class="s4">: </span><span class="s2">method</span><span class="s4">,</span>
      <span class="s2">path</span><span class="s4">: </span><span class="s2">url</span>
    <span class="s4">});</span>

    <span class="s6">// 20. set state to OPENED</span>
    <span class="s2">xhr</span><span class="s4">.</span><span class="s2">readyState </span><span class="s4">= </span><span class="s2">OPENED</span><span class="s4">;</span>

    <span class="s6">// 21. dispatch onreadystatechange</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">xhr</span><span class="s4">.</span><span class="s2">onreadystatechange</span><span class="s4">) {</span>
       <span class="s2">xhr</span><span class="s4">.</span><span class="s2">onreadystatechange</span><span class="s4">();</span>
    <span class="s4">}</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Adds an HTTP header field to the request.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">header the name of the header field.</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">value the value of the header field.</span>
   <span class="s0">*/</span>
  <span class="s2">xhr</span><span class="s4">.</span><span class="s2">setRequestHeader </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">header</span><span class="s4">, </span><span class="s2">value</span><span class="s4">) {</span>
    <span class="s6">// 1. if state is not OPENED or send flag is true, raise exception</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">xhr</span><span class="s4">.</span><span class="s2">readyState </span><span class="s4">!= </span><span class="s2">OPENED </span><span class="s4">|| </span><span class="s2">_state</span><span class="s4">.</span><span class="s2">sendFlag</span><span class="s4">) {</span>
      <span class="s3">throw new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'XHR not open or sending'</span><span class="s4">);</span>
    <span class="s4">}</span>

    <span class="s6">// TODO: other validation steps in spec aren't implemented</span>

    <span class="s6">// set header</span>
    <span class="s2">_state</span><span class="s4">.</span><span class="s2">request</span><span class="s4">.</span><span class="s2">setField</span><span class="s4">(</span><span class="s2">header</span><span class="s4">, </span><span class="s2">value</span><span class="s4">);</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Sends the request and any associated data.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">data a string or Document object to send, null to send no data.</span>
   <span class="s0">*/</span>
  <span class="s2">xhr</span><span class="s4">.</span><span class="s2">send </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">data</span><span class="s4">) {</span>
    <span class="s6">// 1. if state is not OPENED or 2. send flag is true, raise</span>
    <span class="s6">// an invalid state exception</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">xhr</span><span class="s4">.</span><span class="s2">readyState </span><span class="s4">!= </span><span class="s2">OPENED </span><span class="s4">|| </span><span class="s2">_state</span><span class="s4">.</span><span class="s2">sendFlag</span><span class="s4">) {</span>
      <span class="s3">throw new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'XHR not open or sending'</span><span class="s4">);</span>
    <span class="s4">}</span>

    <span class="s6">// 3. ignore data if method is GET or HEAD</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">data </span><span class="s4">&amp;&amp;</span>
      <span class="s2">_state</span><span class="s4">.</span><span class="s2">request</span><span class="s4">.</span><span class="s2">method </span><span class="s4">!== </span><span class="s5">'GET' </span><span class="s4">&amp;&amp;</span>
      <span class="s2">_state</span><span class="s4">.</span><span class="s2">request</span><span class="s4">.</span><span class="s2">method </span><span class="s4">!== </span><span class="s5">'HEAD'</span><span class="s4">) {</span>
      <span class="s6">// handle non-IE case</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s3">typeof</span><span class="s4">(</span><span class="s2">XMLSerializer</span><span class="s4">) !== </span><span class="s5">'undefined'</span><span class="s4">) {</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s2">data </span><span class="s3">instanceof </span><span class="s2">Document</span><span class="s4">) {</span>
          <span class="s3">var </span><span class="s2">xs </span><span class="s4">= </span><span class="s3">new </span><span class="s2">XMLSerializer</span><span class="s4">();</span>
          <span class="s2">_state</span><span class="s4">.</span><span class="s2">request</span><span class="s4">.</span><span class="s2">body </span><span class="s4">= </span><span class="s2">xs</span><span class="s4">.</span><span class="s2">serializeToString</span><span class="s4">(</span><span class="s2">data</span><span class="s4">);</span>
        <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
          <span class="s2">_state</span><span class="s4">.</span><span class="s2">request</span><span class="s4">.</span><span class="s2">body </span><span class="s4">= </span><span class="s2">data</span><span class="s4">;</span>
        <span class="s4">}</span>
      <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
        <span class="s6">// poorly implemented IE case</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s3">typeof</span><span class="s4">(</span><span class="s2">data</span><span class="s4">.</span><span class="s2">xml</span><span class="s4">) !== </span><span class="s5">'undefined'</span><span class="s4">) {</span>
          <span class="s2">_state</span><span class="s4">.</span><span class="s2">request</span><span class="s4">.</span><span class="s2">body </span><span class="s4">= </span><span class="s2">data</span><span class="s4">.</span><span class="s2">xml</span><span class="s4">;</span>
        <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
          <span class="s2">_state</span><span class="s4">.</span><span class="s2">request</span><span class="s4">.</span><span class="s2">body </span><span class="s4">= </span><span class="s2">data</span><span class="s4">;</span>
        <span class="s4">}</span>
      <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s6">// 4. release storage mutex (not used)</span>

    <span class="s6">// 5. set error flag to false</span>
    <span class="s2">_state</span><span class="s4">.</span><span class="s2">errorFlag </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>

    <span class="s6">// 6. if asynchronous is true (must be in this implementation)</span>

    <span class="s6">// 6.1 set send flag to true</span>
    <span class="s2">_state</span><span class="s4">.</span><span class="s2">sendFlag </span><span class="s4">= </span><span class="s3">true</span><span class="s4">;</span>

    <span class="s6">// 6.2 dispatch onreadystatechange</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">xhr</span><span class="s4">.</span><span class="s2">onreadystatechange</span><span class="s4">) {</span>
      <span class="s2">xhr</span><span class="s4">.</span><span class="s2">onreadystatechange</span><span class="s4">();</span>
    <span class="s4">}</span>

    <span class="s6">// create send options</span>
    <span class="s3">var </span><span class="s2">options </span><span class="s4">= {};</span>
    <span class="s2">options</span><span class="s4">.</span><span class="s2">request </span><span class="s4">= </span><span class="s2">_state</span><span class="s4">.</span><span class="s2">request</span><span class="s4">;</span>
    <span class="s2">options</span><span class="s4">.</span><span class="s2">headerReady </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">e</span><span class="s4">) {</span>
      <span class="s6">// make cookies available for ease of use/iteration</span>
      <span class="s2">xhr</span><span class="s4">.</span><span class="s2">cookies </span><span class="s4">= </span><span class="s2">_state</span><span class="s4">.</span><span class="s2">client</span><span class="s4">.</span><span class="s2">cookies</span><span class="s4">;</span>

      <span class="s6">// TODO: update document.cookie with any cookies where the</span>
      <span class="s6">// script's domain matches</span>

      <span class="s6">// headers received</span>
      <span class="s2">xhr</span><span class="s4">.</span><span class="s2">readyState </span><span class="s4">= </span><span class="s2">HEADERS_RECEIVED</span><span class="s4">;</span>
      <span class="s2">xhr</span><span class="s4">.</span><span class="s2">status </span><span class="s4">= </span><span class="s2">e</span><span class="s4">.</span><span class="s2">response</span><span class="s4">.</span><span class="s2">code</span><span class="s4">;</span>
      <span class="s2">xhr</span><span class="s4">.</span><span class="s2">statusText </span><span class="s4">= </span><span class="s2">e</span><span class="s4">.</span><span class="s2">response</span><span class="s4">.</span><span class="s2">message</span><span class="s4">;</span>
      <span class="s2">_state</span><span class="s4">.</span><span class="s2">response </span><span class="s4">= </span><span class="s2">e</span><span class="s4">.</span><span class="s2">response</span><span class="s4">;</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">xhr</span><span class="s4">.</span><span class="s2">onreadystatechange</span><span class="s4">) {</span>
        <span class="s2">xhr</span><span class="s4">.</span><span class="s2">onreadystatechange</span><span class="s4">();</span>
      <span class="s4">}</span>
      <span class="s3">if</span><span class="s4">(!</span><span class="s2">_state</span><span class="s4">.</span><span class="s2">response</span><span class="s4">.</span><span class="s2">aborted</span><span class="s4">) {</span>
        <span class="s6">// now loading body</span>
        <span class="s2">xhr</span><span class="s4">.</span><span class="s2">readyState </span><span class="s4">= </span><span class="s2">LOADING</span><span class="s4">;</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s2">xhr</span><span class="s4">.</span><span class="s2">onreadystatechange</span><span class="s4">) {</span>
           <span class="s2">xhr</span><span class="s4">.</span><span class="s2">onreadystatechange</span><span class="s4">();</span>
        <span class="s4">}</span>
      <span class="s4">}</span>
    <span class="s4">};</span>
    <span class="s2">options</span><span class="s4">.</span><span class="s2">bodyReady </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">e</span><span class="s4">) {</span>
      <span class="s2">xhr</span><span class="s4">.</span><span class="s2">readyState </span><span class="s4">= </span><span class="s2">DONE</span><span class="s4">;</span>
      <span class="s3">var </span><span class="s2">ct </span><span class="s4">= </span><span class="s2">e</span><span class="s4">.</span><span class="s2">response</span><span class="s4">.</span><span class="s2">getField</span><span class="s4">(</span><span class="s5">'Content-Type'</span><span class="s4">);</span>
      <span class="s6">// Note: this null/undefined check is done outside because IE</span>
      <span class="s6">// dies otherwise on a &quot;'null' is null&quot; error</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">ct</span><span class="s4">) {</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s2">ct</span><span class="s4">.</span><span class="s2">indexOf</span><span class="s4">(</span><span class="s5">'text/xml'</span><span class="s4">) === </span><span class="s7">0 </span><span class="s4">||</span>
          <span class="s2">ct</span><span class="s4">.</span><span class="s2">indexOf</span><span class="s4">(</span><span class="s5">'application/xml'</span><span class="s4">) === </span><span class="s7">0 </span><span class="s4">||</span>
          <span class="s2">ct</span><span class="s4">.</span><span class="s2">indexOf</span><span class="s4">(</span><span class="s5">'+xml'</span><span class="s4">) !== -</span><span class="s7">1</span><span class="s4">) {</span>
          <span class="s3">try </span><span class="s4">{</span>
            <span class="s3">var </span><span class="s2">doc </span><span class="s4">= </span><span class="s3">new </span><span class="s2">ActiveXObject</span><span class="s4">(</span><span class="s5">'MicrosoftXMLDOM'</span><span class="s4">);</span>
            <span class="s2">doc</span><span class="s4">.</span><span class="s2">async </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>
            <span class="s2">doc</span><span class="s4">.</span><span class="s2">loadXML</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">response</span><span class="s4">.</span><span class="s2">body</span><span class="s4">);</span>
            <span class="s2">xhr</span><span class="s4">.</span><span class="s2">responseXML </span><span class="s4">= </span><span class="s2">doc</span><span class="s4">;</span>
          <span class="s4">} </span><span class="s3">catch</span><span class="s4">(</span><span class="s2">ex</span><span class="s4">) {</span>
            <span class="s3">var </span><span class="s2">parser </span><span class="s4">= </span><span class="s3">new </span><span class="s2">DOMParser</span><span class="s4">();</span>
            <span class="s2">xhr</span><span class="s4">.</span><span class="s2">responseXML </span><span class="s4">= </span><span class="s2">parser</span><span class="s4">.</span><span class="s2">parseFromString</span><span class="s4">(</span><span class="s2">ex</span><span class="s4">.</span><span class="s2">body</span><span class="s4">, </span><span class="s5">'text/xml'</span><span class="s4">);</span>
          <span class="s4">}</span>
        <span class="s4">}</span>
      <span class="s4">}</span>

      <span class="s3">var </span><span class="s2">length </span><span class="s4">= </span><span class="s7">0</span><span class="s4">;</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">response</span><span class="s4">.</span><span class="s2">body </span><span class="s4">!== </span><span class="s3">null</span><span class="s4">) {</span>
        <span class="s2">xhr</span><span class="s4">.</span><span class="s2">responseText </span><span class="s4">= </span><span class="s2">e</span><span class="s4">.</span><span class="s2">response</span><span class="s4">.</span><span class="s2">body</span><span class="s4">;</span>
        <span class="s2">length </span><span class="s4">= </span><span class="s2">e</span><span class="s4">.</span><span class="s2">response</span><span class="s4">.</span><span class="s2">body</span><span class="s4">.</span><span class="s2">length</span><span class="s4">;</span>
      <span class="s4">}</span>
      <span class="s6">// build logging output</span>
      <span class="s3">var </span><span class="s2">req </span><span class="s4">= </span><span class="s2">_state</span><span class="s4">.</span><span class="s2">request</span><span class="s4">;</span>
      <span class="s3">var </span><span class="s2">output </span><span class="s4">=</span>
        <span class="s2">req</span><span class="s4">.</span><span class="s2">method </span><span class="s4">+ </span><span class="s5">' ' </span><span class="s4">+ </span><span class="s2">req</span><span class="s4">.</span><span class="s2">path </span><span class="s4">+ </span><span class="s5">' ' </span><span class="s4">+</span>
        <span class="s2">xhr</span><span class="s4">.</span><span class="s2">status </span><span class="s4">+ </span><span class="s5">' ' </span><span class="s4">+ </span><span class="s2">xhr</span><span class="s4">.</span><span class="s2">statusText </span><span class="s4">+ </span><span class="s5">' ' </span><span class="s4">+</span>
        <span class="s2">length </span><span class="s4">+ </span><span class="s5">'B ' </span><span class="s4">+</span>
        <span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">request</span><span class="s4">.</span><span class="s2">connectTime </span><span class="s4">+ </span><span class="s2">e</span><span class="s4">.</span><span class="s2">request</span><span class="s4">.</span><span class="s2">time </span><span class="s4">+ </span><span class="s2">e</span><span class="s4">.</span><span class="s2">response</span><span class="s4">.</span><span class="s2">time</span><span class="s4">) +</span>
        <span class="s5">'ms'</span><span class="s4">;</span>
      <span class="s3">var </span><span class="s2">lFunc</span><span class="s4">;</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">options</span><span class="s4">.</span><span class="s2">verbose</span><span class="s4">) {</span>
        <span class="s2">lFunc </span><span class="s4">= (</span><span class="s2">xhr</span><span class="s4">.</span><span class="s2">status </span><span class="s4">&gt;= </span><span class="s7">400 </span><span class="s4">&amp;&amp; </span><span class="s2">options</span><span class="s4">.</span><span class="s2">logWarningOnError</span><span class="s4">) ?</span>
          <span class="s2">_log</span><span class="s4">.</span><span class="s2">warning </span><span class="s4">: </span><span class="s2">_log</span><span class="s4">.</span><span class="s2">verbose</span><span class="s4">;</span>
        <span class="s2">lFunc</span><span class="s4">(</span><span class="s2">cat</span><span class="s4">, </span><span class="s2">output</span><span class="s4">,</span>
          <span class="s2">e</span><span class="s4">, </span><span class="s2">e</span><span class="s4">.</span><span class="s2">response</span><span class="s4">.</span><span class="s2">body </span><span class="s4">? </span><span class="s5">'</span><span class="s3">\n</span><span class="s5">' </span><span class="s4">+ </span><span class="s2">e</span><span class="s4">.</span><span class="s2">response</span><span class="s4">.</span><span class="s2">body </span><span class="s4">: </span><span class="s5">'</span><span class="s3">\n</span><span class="s5">No content'</span><span class="s4">);</span>
      <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
        <span class="s2">lFunc </span><span class="s4">= (</span><span class="s2">xhr</span><span class="s4">.</span><span class="s2">status </span><span class="s4">&gt;= </span><span class="s7">400 </span><span class="s4">&amp;&amp; </span><span class="s2">options</span><span class="s4">.</span><span class="s2">logWarningOnError</span><span class="s4">) ?</span>
          <span class="s2">_log</span><span class="s4">.</span><span class="s2">warning </span><span class="s4">: </span><span class="s2">_log</span><span class="s4">.</span><span class="s2">debug</span><span class="s4">;</span>
        <span class="s2">lFunc</span><span class="s4">(</span><span class="s2">cat</span><span class="s4">, </span><span class="s2">output</span><span class="s4">);</span>
      <span class="s4">}</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">xhr</span><span class="s4">.</span><span class="s2">onreadystatechange</span><span class="s4">) {</span>
        <span class="s2">xhr</span><span class="s4">.</span><span class="s2">onreadystatechange</span><span class="s4">();</span>
      <span class="s4">}</span>
    <span class="s4">};</span>
    <span class="s2">options</span><span class="s4">.</span><span class="s2">error </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">e</span><span class="s4">) {</span>
      <span class="s3">var </span><span class="s2">req </span><span class="s4">= </span><span class="s2">_state</span><span class="s4">.</span><span class="s2">request</span><span class="s4">;</span>
      <span class="s2">_log</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">cat</span><span class="s4">, </span><span class="s2">req</span><span class="s4">.</span><span class="s2">method </span><span class="s4">+ </span><span class="s5">' ' </span><span class="s4">+ </span><span class="s2">req</span><span class="s4">.</span><span class="s2">path</span><span class="s4">, </span><span class="s2">e</span><span class="s4">);</span>

      <span class="s6">// 1. set response body to null</span>
      <span class="s2">xhr</span><span class="s4">.</span><span class="s2">responseText </span><span class="s4">= </span><span class="s5">''</span><span class="s4">;</span>
      <span class="s2">xhr</span><span class="s4">.</span><span class="s2">responseXML </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>

      <span class="s6">// 2. set error flag to true (and reset status)</span>
      <span class="s2">_state</span><span class="s4">.</span><span class="s2">errorFlag </span><span class="s4">= </span><span class="s3">true</span><span class="s4">;</span>
      <span class="s2">xhr</span><span class="s4">.</span><span class="s2">status </span><span class="s4">= </span><span class="s7">0</span><span class="s4">;</span>
      <span class="s2">xhr</span><span class="s4">.</span><span class="s2">statusText </span><span class="s4">= </span><span class="s5">''</span><span class="s4">;</span>

      <span class="s6">// 3. set state to done</span>
      <span class="s2">xhr</span><span class="s4">.</span><span class="s2">readyState </span><span class="s4">= </span><span class="s2">DONE</span><span class="s4">;</span>

      <span class="s6">// 4. asyc flag is always true, so dispatch onreadystatechange</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">xhr</span><span class="s4">.</span><span class="s2">onreadystatechange</span><span class="s4">) {</span>
        <span class="s2">xhr</span><span class="s4">.</span><span class="s2">onreadystatechange</span><span class="s4">();</span>
      <span class="s4">}</span>
    <span class="s4">};</span>

    <span class="s6">// 7. send request</span>
    <span class="s2">_state</span><span class="s4">.</span><span class="s2">client</span><span class="s4">.</span><span class="s2">send</span><span class="s4">(</span><span class="s2">options</span><span class="s4">);</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Aborts the request.</span>
   <span class="s0">*/</span>
  <span class="s2">xhr</span><span class="s4">.</span><span class="s2">abort </span><span class="s4">= </span><span class="s3">function</span><span class="s4">() {</span>
    <span class="s6">// 1. abort send</span>
    <span class="s6">// 2. stop network activity</span>
    <span class="s2">_state</span><span class="s4">.</span><span class="s2">request</span><span class="s4">.</span><span class="s2">abort</span><span class="s4">();</span>

    <span class="s6">// 3. set response to null</span>
    <span class="s2">xhr</span><span class="s4">.</span><span class="s2">responseText </span><span class="s4">= </span><span class="s5">''</span><span class="s4">;</span>
    <span class="s2">xhr</span><span class="s4">.</span><span class="s2">responseXML </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>

    <span class="s6">// 4. set error flag to true (and reset status)</span>
    <span class="s2">_state</span><span class="s4">.</span><span class="s2">errorFlag </span><span class="s4">= </span><span class="s3">true</span><span class="s4">;</span>
    <span class="s2">xhr</span><span class="s4">.</span><span class="s2">status </span><span class="s4">= </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s2">xhr</span><span class="s4">.</span><span class="s2">statusText </span><span class="s4">= </span><span class="s5">''</span><span class="s4">;</span>

    <span class="s6">// 5. clear user headers</span>
    <span class="s2">_state</span><span class="s4">.</span><span class="s2">request </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
    <span class="s2">_state</span><span class="s4">.</span><span class="s2">response </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>

    <span class="s6">// 6. if state is DONE or UNSENT, or if OPENED and send flag is false</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">xhr</span><span class="s4">.</span><span class="s2">readyState </span><span class="s4">=== </span><span class="s2">DONE </span><span class="s4">|| </span><span class="s2">xhr</span><span class="s4">.</span><span class="s2">readyState </span><span class="s4">=== </span><span class="s2">UNSENT </span><span class="s4">||</span>
     <span class="s4">(</span><span class="s2">xhr</span><span class="s4">.</span><span class="s2">readyState </span><span class="s4">=== </span><span class="s2">OPENED </span><span class="s4">&amp;&amp; !</span><span class="s2">_state</span><span class="s4">.</span><span class="s2">sendFlag</span><span class="s4">)) {</span>
      <span class="s6">// 7. set ready state to unsent</span>
      <span class="s2">xhr</span><span class="s4">.</span><span class="s2">readyState </span><span class="s4">= </span><span class="s2">UNSENT</span><span class="s4">;</span>
    <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
      <span class="s6">// 6.1 set state to DONE</span>
      <span class="s2">xhr</span><span class="s4">.</span><span class="s2">readyState </span><span class="s4">= </span><span class="s2">DONE</span><span class="s4">;</span>

      <span class="s6">// 6.2 set send flag to false</span>
      <span class="s2">_state</span><span class="s4">.</span><span class="s2">sendFlag </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>

      <span class="s6">// 6.3 dispatch onreadystatechange</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">xhr</span><span class="s4">.</span><span class="s2">onreadystatechange</span><span class="s4">) {</span>
        <span class="s2">xhr</span><span class="s4">.</span><span class="s2">onreadystatechange</span><span class="s4">();</span>
      <span class="s4">}</span>

      <span class="s6">// 7. set state to UNSENT</span>
      <span class="s2">xhr</span><span class="s4">.</span><span class="s2">readyState </span><span class="s4">= </span><span class="s2">UNSENT</span><span class="s4">;</span>
    <span class="s4">}</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Gets all response headers as a string.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@return </span><span class="s0">the HTTP-encoded response header fields.</span>
   <span class="s0">*/</span>
  <span class="s2">xhr</span><span class="s4">.</span><span class="s2">getAllResponseHeaders </span><span class="s4">= </span><span class="s3">function</span><span class="s4">() {</span>
    <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s5">''</span><span class="s4">;</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">_state</span><span class="s4">.</span><span class="s2">response </span><span class="s4">!== </span><span class="s3">null</span><span class="s4">) {</span>
      <span class="s3">var </span><span class="s2">fields </span><span class="s4">= </span><span class="s2">_state</span><span class="s4">.</span><span class="s2">response</span><span class="s4">.</span><span class="s2">fields</span><span class="s4">;</span>
      <span class="s2">$</span><span class="s4">.</span><span class="s2">each</span><span class="s4">(</span><span class="s2">fields</span><span class="s4">, </span><span class="s3">function</span><span class="s4">(</span><span class="s2">name</span><span class="s4">, </span><span class="s2">array</span><span class="s4">) {</span>
        <span class="s2">$</span><span class="s4">.</span><span class="s2">each</span><span class="s4">(</span><span class="s2">array</span><span class="s4">, </span><span class="s3">function</span><span class="s4">(</span><span class="s2">i</span><span class="s4">, </span><span class="s2">value</span><span class="s4">) {</span>
          <span class="s2">rval </span><span class="s4">+= </span><span class="s2">name </span><span class="s4">+ </span><span class="s5">': ' </span><span class="s4">+ </span><span class="s2">value </span><span class="s4">+ </span><span class="s5">'</span><span class="s3">\r\n</span><span class="s5">'</span><span class="s4">;</span>
        <span class="s4">});</span>
      <span class="s4">});</span>
    <span class="s4">}</span>
    <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Gets a single header field value or, if there are multiple</span>
   <span class="s0">* fields with the same name, a comma-separated list of header</span>
   <span class="s0">* values.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@return </span><span class="s0">the header field value(s) or null.</span>
   <span class="s0">*/</span>
  <span class="s2">xhr</span><span class="s4">.</span><span class="s2">getResponseHeader </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">header</span><span class="s4">) {</span>
    <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">_state</span><span class="s4">.</span><span class="s2">response </span><span class="s4">!== </span><span class="s3">null</span><span class="s4">) {</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">header </span><span class="s3">in </span><span class="s2">_state</span><span class="s4">.</span><span class="s2">response</span><span class="s4">.</span><span class="s2">fields</span><span class="s4">) {</span>
        <span class="s2">rval </span><span class="s4">= </span><span class="s2">_state</span><span class="s4">.</span><span class="s2">response</span><span class="s4">.</span><span class="s2">fields</span><span class="s4">[</span><span class="s2">header</span><span class="s4">];</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">isArray</span><span class="s4">(</span><span class="s2">rval</span><span class="s4">)) {</span>
          <span class="s2">rval </span><span class="s4">= </span><span class="s2">rval</span><span class="s4">.</span><span class="s2">join</span><span class="s4">();</span>
        <span class="s4">}</span>
      <span class="s4">}</span>
    <span class="s4">}</span>
    <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
  <span class="s4">};</span>

  <span class="s3">return </span><span class="s2">xhr</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s4">})(</span><span class="s2">jQuery</span><span class="s4">);</span>
</pre>
</body>
</html>