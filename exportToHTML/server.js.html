<html>
<head>
<title>Server.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #6aab73;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #cf8e6d;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #67a37c; font-style: italic;}
.s6 { color: #7a7e85;}
.s7 { color: #42c3d4;}
.s8 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
Server.js</font>
</center></td></tr></table>
<pre><span class="s0">&quot;use strict&quot;</span><span class="s1">;</span>

<span class="s3">const </span><span class="s2">os </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;os&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">path </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;path&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">url </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;url&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">util </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;util&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">fs </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;graceful-fs&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">ipaddr </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;ipaddr.js&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">validate </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;schema-utils&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s2">schema </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;./options.json&quot;</span><span class="s1">);</span>

<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;schema-utils/declarations/validate&quot;).Schema} Schema */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;webpack&quot;).Compiler} Compiler */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;webpack&quot;).MultiCompiler} MultiCompiler */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;webpack&quot;).Configuration} WebpackConfiguration */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;webpack&quot;).StatsOptions} StatsOptions */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;webpack&quot;).StatsCompilation} StatsCompilation */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;webpack&quot;).Stats} Stats */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;webpack&quot;).MultiStats} MultiStats */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;os&quot;).NetworkInterfaceInfo} NetworkInterfaceInfo */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;express&quot;).Request} Request */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;express&quot;).Response} Response */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;express&quot;).NextFunction} NextFunction */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;express&quot;).RequestHandler} ExpressRequestHandler */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;express&quot;).ErrorRequestHandler} ExpressErrorRequestHandler */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;chokidar&quot;).WatchOptions} WatchOptions */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;chokidar&quot;).FSWatcher} FSWatcher */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;connect-history-api-fallback&quot;).Options} ConnectHistoryApiFallbackOptions */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;bonjour-service&quot;).Bonjour} Bonjour */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;bonjour-service&quot;).Service} BonjourOptions */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;http-proxy-middleware&quot;).RequestHandler} RequestHandler */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;http-proxy-middleware&quot;).Options} HttpProxyMiddlewareOptions */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;http-proxy-middleware&quot;).Filter} HttpProxyMiddlewareOptionsFilter */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;serve-index&quot;).Options} ServeIndexOptions */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;serve-static&quot;).ServeStaticOptions} ServeStaticOptions */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;ipaddr.js&quot;).IPv4} IPv4 */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;ipaddr.js&quot;).IPv6} IPv6 */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;net&quot;).Socket} Socket */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;http&quot;).IncomingMessage} IncomingMessage */</span>
<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;open&quot;).Options} OpenOptions */</span>

<span class="s4">/** </span><span class="s5">@typedef </span><span class="s4">{import(&quot;https&quot;).ServerOptions &amp; { spdy?: { plain?: boolean | undefined, ssl?: boolean | undefined, 'x-forwarded-for'?: string | undefined, protocol?: string | undefined, protocols?: string[] | undefined }}} ServerOptions */</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@template </span><span class="s4">Request, Response</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{import(&quot;webpack-dev-middleware&quot;).Options&lt;Request, Response&gt;} DevMiddlewareOptions</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@template </span><span class="s4">Request, Response</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{import(&quot;webpack-dev-middleware&quot;).Context&lt;Request, Response&gt;} DevMiddlewareContext</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{&quot;local-ip&quot; | &quot;local-ipv4&quot; | &quot;local-ipv6&quot; | string} Host</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{number | string | &quot;auto&quot;} Port</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{Object} WatchFiles</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{string | string[]} paths</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{WatchOptions &amp; { aggregateTimeout?: number, ignored?: WatchOptions[&quot;ignored&quot;], poll?: number | boolean }} [options]</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{Object} Static</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{string} [directory]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{string | string[]} [publicPath]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{boolean | ServeIndexOptions} [serveIndex]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{ServeStaticOptions} [staticOptions]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{boolean | WatchOptions &amp; { aggregateTimeout?: number, ignored?: WatchOptions[&quot;ignored&quot;], poll?: number | boolean }} [watch]</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{Object} NormalizedStatic</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{string} directory</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{string[]} publicPath</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{false | ServeIndexOptions} serveIndex</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{ServeStaticOptions} staticOptions</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{false | WatchOptions} watch</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{Object} ServerConfiguration</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{&quot;http&quot; | &quot;https&quot; | &quot;spdy&quot; | string} [type]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{ServerOptions} [options]</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{Object} WebSocketServerConfiguration</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{&quot;sockjs&quot; | &quot;ws&quot; | string | Function} [type]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{Record&lt;string, any&gt;} [options]</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{(import(&quot;ws&quot;).WebSocket | import(&quot;sockjs&quot;).Connection &amp; { send: import(&quot;ws&quot;).WebSocket[&quot;send&quot;], terminate: import(&quot;ws&quot;).WebSocket[&quot;terminate&quot;], ping: import(&quot;ws&quot;).WebSocket[&quot;ping&quot;] }) &amp; { isAlive?: boolean }} ClientConnection</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{import(&quot;ws&quot;).WebSocketServer | import(&quot;sockjs&quot;).Server &amp; { close: import(&quot;ws&quot;).WebSocketServer[&quot;close&quot;] }} WebSocketServer</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{{ implementation: WebSocketServer, clients: ClientConnection[] }} WebSocketServerImplementation</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@callback </span><span class="s4">ByPass</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Request} req</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Response} res</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{ProxyConfigArrayItem} proxyConfig</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{{ path?: HttpProxyMiddlewareOptionsFilter | undefined, context?: HttpProxyMiddlewareOptionsFilter | undefined } &amp; { bypass?: ByPass } &amp; HttpProxyMiddlewareOptions } ProxyConfigArrayItem</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{(ProxyConfigArrayItem | ((req?: Request | undefined, res?: Response | undefined, next?: NextFunction | undefined) =&gt; ProxyConfigArrayItem))[]} ProxyConfigArray</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{{ [url: string]: string | ProxyConfigArrayItem }} ProxyConfigMap</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{Object} OpenApp</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{string} [name]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{string[]} [arguments]</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{Object} Open</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{string | string[] | OpenApp} [app]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{string | string[]} [target]</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{Object} NormalizedOpen</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{string} target</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{import(&quot;open&quot;).Options} options</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{Object} WebSocketURL</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{string} [hostname]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{string} [password]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{string} [pathname]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{number | string} [port]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{string} [protocol]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{string} [username]</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{boolean | ((error: Error) =&gt; void)} OverlayMessageOptions</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{Object} ClientConfiguration</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{&quot;log&quot; | &quot;info&quot; | &quot;warn&quot; | &quot;error&quot; | &quot;none&quot; | &quot;verbose&quot;} [logging]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{boolean  | { warnings?: OverlayMessageOptions, errors?: OverlayMessageOptions, runtimeErrors?: OverlayMessageOptions }} [overlay]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{boolean} [progress]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{boolean | number} [reconnect]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{&quot;ws&quot; | &quot;sockjs&quot; | string} [webSocketTransport]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{string | WebSocketURL} [webSocketURL]</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{Array&lt;{ key: string; value: string }&gt; | Record&lt;string, string | string[]&gt;} Headers</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{{ name?: string, path?: string, middleware: ExpressRequestHandler | ExpressErrorRequestHandler } | ExpressRequestHandler | ExpressErrorRequestHandler} Middleware</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@typedef </span><span class="s4">{Object} Configuration</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{boolean | string} [ipc]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{Host} [host]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{Port} [port]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{boolean | &quot;only&quot;} [hot]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{boolean} [liveReload]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{DevMiddlewareOptions&lt;Request, Response&gt;} [devMiddleware]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{boolean} [compress]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{boolean} [magicHtml]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{&quot;auto&quot; | &quot;all&quot; | string | string[]} [allowedHosts]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{boolean | ConnectHistoryApiFallbackOptions} [historyApiFallback]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{boolean | Record&lt;string, never&gt; | BonjourOptions} [bonjour]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{string | string[] | WatchFiles | Array&lt;string | WatchFiles&gt;} [watchFiles]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{boolean | string | Static | Array&lt;string | Static&gt;} [static]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{boolean | ServerOptions} [https]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{boolean} [http2]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{&quot;http&quot; | &quot;https&quot; | &quot;spdy&quot; | string | ServerConfiguration} [server]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{boolean | &quot;sockjs&quot; | &quot;ws&quot; | string | WebSocketServerConfiguration} [webSocketServer]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{ProxyConfigMap | ProxyConfigArrayItem | ProxyConfigArray} [proxy]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{boolean | string | Open | Array&lt;string | Open&gt;} [open]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{boolean} [setupExitSignals]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{boolean | ClientConfiguration} [client]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{Headers | ((req: Request, res: Response, context: DevMiddlewareContext&lt;Request, Response&gt;) =&gt; Headers)} [headers]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{(devServer: Server) =&gt; void} [onAfterSetupMiddleware]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{(devServer: Server) =&gt; void} [onBeforeSetupMiddleware]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{(devServer: Server) =&gt; void} [onListening]</span>
 <span class="s4">* </span><span class="s5">@property </span><span class="s4">{(middlewares: Middleware[], devServer: Server) =&gt; Middleware[]} [setupMiddlewares]</span>
 <span class="s4">*/</span>

<span class="s3">if </span><span class="s1">(!</span><span class="s2">process</span><span class="s1">.</span><span class="s2">env</span><span class="s1">.</span><span class="s2">WEBPACK_SERVE</span><span class="s1">) {</span>
  <span class="s6">// TODO fix me in the next major release</span>
  <span class="s6">// @ts-ignore</span>
  <span class="s2">process</span><span class="s1">.</span><span class="s2">env</span><span class="s1">.</span><span class="s2">WEBPACK_SERVE </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@template </span><span class="s4">T</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">fn {(function(): any) | undefined}</span>
 <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{function(): T}</span>
 <span class="s4">*/</span>
<span class="s3">const </span><span class="s2">memoize </span><span class="s1">= (</span><span class="s2">fn</span><span class="s1">) =&gt; {</span>
  <span class="s3">let </span><span class="s2">cache </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
  <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{T} */</span>
  <span class="s3">let </span><span class="s2">result</span><span class="s1">;</span>

  <span class="s3">return </span><span class="s1">() =&gt; {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">cache</span><span class="s1">) {</span>
      <span class="s3">return </span><span class="s2">result</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">result </span><span class="s1">= </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{function(): any} */ </span><span class="s1">(</span><span class="s2">fn</span><span class="s1">)();</span>
    <span class="s2">cache </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s6">// Allow to clean up memory for fn</span>
    <span class="s6">// and all dependent resources</span>
    <span class="s6">// eslint-disable-next-line no-undefined</span>
    <span class="s2">fn </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>

    <span class="s3">return </span><span class="s2">result</span><span class="s1">;</span>
  <span class="s1">};</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s2">getExpress </span><span class="s1">= </span><span class="s2">memoize</span><span class="s1">(() =&gt; </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;express&quot;</span><span class="s1">));</span>

<span class="s4">/**</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{OverlayMessageOptions} [setting]</span>
 <span class="s4">* </span><span class="s5">@returns</span>
 <span class="s4">*/</span>
<span class="s3">const </span><span class="s2">encodeOverlaySettings </span><span class="s1">= (</span><span class="s2">setting</span><span class="s1">) =&gt;</span>
  <span class="s3">typeof </span><span class="s2">setting </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span>
    <span class="s1">? </span><span class="s2">encodeURIComponent</span><span class="s1">(</span><span class="s2">setting</span><span class="s1">.</span><span class="s2">toString</span><span class="s1">())</span>
    <span class="s1">: </span><span class="s2">setting</span><span class="s1">;</span>

<span class="s3">class </span><span class="s2">Server </span><span class="s1">{</span>
  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Configuration | Compiler | MultiCompiler} options</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Compiler | MultiCompiler | Configuration} compiler</span>
   <span class="s4">*/</span>
  <span class="s2">constructor</span><span class="s1">(</span><span class="s2">options </span><span class="s1">= {}, </span><span class="s2">compiler</span><span class="s1">) {</span>
    <span class="s6">// TODO: remove this after plugin support is published</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{Compiler | MultiCompiler} */ </span><span class="s1">(</span><span class="s2">options</span><span class="s1">).</span><span class="s2">hooks</span><span class="s1">) {</span>
      <span class="s2">util</span><span class="s1">.</span><span class="s2">deprecate</span><span class="s1">(</span>
        <span class="s1">() =&gt; {},</span>
        <span class="s0">&quot;Using 'compiler' as the first argument is deprecated. Please use 'options' as the first argument and 'compiler' as the second argument.&quot;</span><span class="s1">,</span>
        <span class="s0">&quot;DEP_WEBPACK_DEV_SERVER_CONSTRUCTOR&quot;</span>
      <span class="s1">)();</span>

      <span class="s1">[</span><span class="s2">options </span><span class="s1">= {}, </span><span class="s2">compiler</span><span class="s1">] = [</span><span class="s2">compiler</span><span class="s1">, </span><span class="s2">options</span><span class="s1">];</span>
    <span class="s1">}</span>

    <span class="s2">validate</span><span class="s1">(</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{Schema} */ </span><span class="s1">(</span><span class="s2">schema</span><span class="s1">), </span><span class="s2">options</span><span class="s1">, {</span>
      <span class="s2">name</span><span class="s1">: </span><span class="s0">&quot;Dev Server&quot;</span><span class="s1">,</span>
      <span class="s2">baseDataPath</span><span class="s1">: </span><span class="s0">&quot;options&quot;</span><span class="s1">,</span>
    <span class="s1">});</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">compiler </span><span class="s1">= </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{Compiler | MultiCompiler} */ </span><span class="s1">(</span><span class="s2">compiler</span><span class="s1">);</span>
    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@type </span><span class="s4">{ReturnType&lt;Compiler[&quot;getInfrastructureLogger&quot;]&gt;}</span>
     <span class="s4">* */</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">logger </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">compiler</span><span class="s1">.</span><span class="s2">getInfrastructureLogger</span><span class="s1">(</span><span class="s0">&quot;webpack-dev-server&quot;</span><span class="s1">);</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">options </span><span class="s1">= </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{Configuration} */ </span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@type </span><span class="s4">{FSWatcher[]}</span>
     <span class="s4">*/</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">staticWatchers </span><span class="s1">= [];</span>
    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@private</span>
     <span class="s4">* </span><span class="s5">@type </span><span class="s4">{{ name: string | symbol, listener: (...args: any[]) =&gt; void}[] }}</span>
     <span class="s4">*/</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">listeners </span><span class="s1">= [];</span>
    <span class="s6">// Keep track of websocket proxies for external websocket upgrade.</span>
    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@private</span>
     <span class="s4">* </span><span class="s5">@type </span><span class="s4">{RequestHandler[]}</span>
     <span class="s4">*/</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">webSocketProxies </span><span class="s1">= [];</span>
    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@type </span><span class="s4">{Socket[]}</span>
     <span class="s4">*/</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">sockets </span><span class="s1">= [];</span>
    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@private</span>
     <span class="s4">* </span><span class="s5">@type </span><span class="s4">{string | undefined}</span>
     <span class="s4">*/</span>
    <span class="s6">// eslint-disable-next-line no-undefined</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">currentHash </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s6">// TODO compatibility with webpack v4, remove it after drop</span>
  <span class="s3">static </span><span class="s2">get cli</span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s1">{</span>
      <span class="s2">get getArguments</span><span class="s1">() {</span>
        <span class="s3">return </span><span class="s1">() =&gt; </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../bin/cli-flags&quot;</span><span class="s1">);</span>
      <span class="s1">},</span>
      <span class="s2">get processArguments</span><span class="s1">() {</span>
        <span class="s3">return </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;../bin/process-arguments&quot;</span><span class="s1">);</span>
      <span class="s1">},</span>
    <span class="s1">};</span>
  <span class="s1">}</span>

  <span class="s3">static </span><span class="s2">get schema</span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s2">schema</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{StatsOptions}</span>
   <span class="s4">* </span><span class="s5">@constructor</span>
   <span class="s4">*/</span>
  <span class="s3">static </span><span class="s2">get DEFAULT_STATS</span><span class="s1">() {</span>
    <span class="s3">return </span><span class="s1">{</span>
      <span class="s2">all</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
      <span class="s2">hash</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
      <span class="s2">warnings</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
      <span class="s2">errors</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
      <span class="s2">errorDetails</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
    <span class="s1">};</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{string} URL</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{boolean}</span>
   <span class="s4">*/</span>
  <span class="s3">static </span><span class="s2">isAbsoluteURL</span><span class="s1">(</span><span class="s2">URL</span><span class="s1">) {</span>
    <span class="s6">// Don't match Windows paths `c:\`</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s7">/^[a-zA-Z]:\\/</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">URL</span><span class="s1">)) {</span>
      <span class="s3">return false</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s6">// Scheme: https://tools.ietf.org/html/rfc3986#section-3.1</span>
    <span class="s6">// Absolute URL: https://tools.ietf.org/html/rfc3986#section-4.3</span>
    <span class="s3">return </span><span class="s7">/^[a-zA-Z][a-zA-Z\d+\-.]*:/</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">URL</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{string} gateway</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{string | undefined}</span>
   <span class="s4">*/</span>
  <span class="s3">static </span><span class="s2">findIp</span><span class="s1">(</span><span class="s2">gateway</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">gatewayIp </span><span class="s1">= </span><span class="s2">ipaddr</span><span class="s1">.</span><span class="s2">parse</span><span class="s1">(</span><span class="s2">gateway</span><span class="s1">);</span>

    <span class="s6">// Look for the matching interface in all local interfaces.</span>
    <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">addresses of Object</span><span class="s1">.</span><span class="s2">values</span><span class="s1">(</span><span class="s2">os</span><span class="s1">.</span><span class="s2">networkInterfaces</span><span class="s1">())) {</span>
      <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s1">{ </span><span class="s2">cidr </span><span class="s1">} </span><span class="s2">of </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{NetworkInterfaceInfo[]} */ </span><span class="s1">(</span>
        <span class="s2">addresses</span>
      <span class="s1">)) {</span>
        <span class="s3">const </span><span class="s2">net </span><span class="s1">= </span><span class="s2">ipaddr</span><span class="s1">.</span><span class="s2">parseCIDR</span><span class="s1">(</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{string} */ </span><span class="s1">(</span><span class="s2">cidr</span><span class="s1">));</span>

        <span class="s3">if </span><span class="s1">(</span>
          <span class="s2">net</span><span class="s1">[</span><span class="s8">0</span><span class="s1">] &amp;&amp;</span>
          <span class="s2">net</span><span class="s1">[</span><span class="s8">0</span><span class="s1">].</span><span class="s2">kind</span><span class="s1">() === </span><span class="s2">gatewayIp</span><span class="s1">.</span><span class="s2">kind</span><span class="s1">() &amp;&amp;</span>
          <span class="s2">gatewayIp</span><span class="s1">.</span><span class="s2">match</span><span class="s1">(</span><span class="s2">net</span><span class="s1">)</span>
        <span class="s1">) {</span>
          <span class="s3">return </span><span class="s2">net</span><span class="s1">[</span><span class="s8">0</span><span class="s1">].</span><span class="s2">toString</span><span class="s1">();</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{&quot;v4&quot; | &quot;v6&quot;} family</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{Promise&lt;string | undefined&gt;}</span>
   <span class="s4">*/</span>
  <span class="s3">static </span><span class="s2">async internalIP</span><span class="s1">(</span><span class="s2">family</span><span class="s1">) {</span>
    <span class="s3">try </span><span class="s1">{</span>
      <span class="s3">const </span><span class="s1">{ </span><span class="s2">gateway </span><span class="s1">} = </span><span class="s3">await </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;default-gateway&quot;</span><span class="s1">)[</span><span class="s2">family</span><span class="s1">]();</span>
      <span class="s3">return </span><span class="s2">Server</span><span class="s1">.</span><span class="s2">findIp</span><span class="s1">(</span><span class="s2">gateway</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">catch </span><span class="s1">{</span>
      <span class="s6">// ignore</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{&quot;v4&quot; | &quot;v6&quot;} family</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{string | undefined}</span>
   <span class="s4">*/</span>
  <span class="s3">static </span><span class="s2">internalIPSync</span><span class="s1">(</span><span class="s2">family</span><span class="s1">) {</span>
    <span class="s3">try </span><span class="s1">{</span>
      <span class="s3">const </span><span class="s1">{ </span><span class="s2">gateway </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;default-gateway&quot;</span><span class="s1">)[</span><span class="s2">family</span><span class="s1">].</span><span class="s2">sync</span><span class="s1">();</span>
      <span class="s3">return </span><span class="s2">Server</span><span class="s1">.</span><span class="s2">findIp</span><span class="s1">(</span><span class="s2">gateway</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">catch </span><span class="s1">{</span>
      <span class="s6">// ignore</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Host} hostname</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{Promise&lt;string&gt;}</span>
   <span class="s4">*/</span>
  <span class="s3">static </span><span class="s2">async getHostname</span><span class="s1">(</span><span class="s2">hostname</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">hostname </span><span class="s1">=== </span><span class="s0">&quot;local-ip&quot;</span><span class="s1">) {</span>
      <span class="s3">return </span><span class="s1">(</span>
        <span class="s1">(</span><span class="s3">await </span><span class="s2">Server</span><span class="s1">.</span><span class="s2">internalIP</span><span class="s1">(</span><span class="s0">&quot;v4&quot;</span><span class="s1">)) ||</span>
        <span class="s1">(</span><span class="s3">await </span><span class="s2">Server</span><span class="s1">.</span><span class="s2">internalIP</span><span class="s1">(</span><span class="s0">&quot;v6&quot;</span><span class="s1">)) ||</span>
        <span class="s0">&quot;0.0.0.0&quot;</span>
      <span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">hostname </span><span class="s1">=== </span><span class="s0">&quot;local-ipv4&quot;</span><span class="s1">) {</span>
      <span class="s3">return </span><span class="s1">(</span><span class="s3">await </span><span class="s2">Server</span><span class="s1">.</span><span class="s2">internalIP</span><span class="s1">(</span><span class="s0">&quot;v4&quot;</span><span class="s1">)) || </span><span class="s0">&quot;0.0.0.0&quot;</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">hostname </span><span class="s1">=== </span><span class="s0">&quot;local-ipv6&quot;</span><span class="s1">) {</span>
      <span class="s3">return </span><span class="s1">(</span><span class="s3">await </span><span class="s2">Server</span><span class="s1">.</span><span class="s2">internalIP</span><span class="s1">(</span><span class="s0">&quot;v6&quot;</span><span class="s1">)) || </span><span class="s0">&quot;::&quot;</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s2">hostname</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Port} port</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{string} host</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{Promise&lt;number | string&gt;}</span>
   <span class="s4">*/</span>
  <span class="s3">static </span><span class="s2">async getFreePort</span><span class="s1">(</span><span class="s2">port</span><span class="s1">, </span><span class="s2">host</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">port </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot; </span><span class="s1">&amp;&amp; </span><span class="s2">port </span><span class="s1">!== </span><span class="s3">null </span><span class="s1">&amp;&amp; </span><span class="s2">port </span><span class="s1">!== </span><span class="s0">&quot;auto&quot;</span><span class="s1">) {</span>
      <span class="s3">return </span><span class="s2">port</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">const </span><span class="s2">pRetry </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;p-retry&quot;</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">getPort </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;./getPort&quot;</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">basePort </span><span class="s1">=</span>
      <span class="s3">typeof </span><span class="s2">process</span><span class="s1">.</span><span class="s2">env</span><span class="s1">.</span><span class="s2">WEBPACK_DEV_SERVER_BASE_PORT </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span>
        <span class="s1">? </span><span class="s2">parseInt</span><span class="s1">(</span><span class="s2">process</span><span class="s1">.</span><span class="s2">env</span><span class="s1">.</span><span class="s2">WEBPACK_DEV_SERVER_BASE_PORT</span><span class="s1">, </span><span class="s8">10</span><span class="s1">)</span>
        <span class="s1">: </span><span class="s8">8080</span><span class="s1">;</span>

    <span class="s6">// Try to find unused port and listen on it for 3 times,</span>
    <span class="s6">// if port is not specified in options.</span>
    <span class="s3">const </span><span class="s2">defaultPortRetry </span><span class="s1">=</span>
      <span class="s3">typeof </span><span class="s2">process</span><span class="s1">.</span><span class="s2">env</span><span class="s1">.</span><span class="s2">WEBPACK_DEV_SERVER_PORT_RETRY </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span>
        <span class="s1">? </span><span class="s2">parseInt</span><span class="s1">(</span><span class="s2">process</span><span class="s1">.</span><span class="s2">env</span><span class="s1">.</span><span class="s2">WEBPACK_DEV_SERVER_PORT_RETRY</span><span class="s1">, </span><span class="s8">10</span><span class="s1">)</span>
        <span class="s1">: </span><span class="s8">3</span><span class="s1">;</span>

    <span class="s3">return </span><span class="s2">pRetry</span><span class="s1">(() =&gt; </span><span class="s2">getPort</span><span class="s1">(</span><span class="s2">basePort</span><span class="s1">, </span><span class="s2">host</span><span class="s1">), {</span>
      <span class="s2">retries</span><span class="s1">: </span><span class="s2">defaultPortRetry</span><span class="s1">,</span>
    <span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{string}</span>
   <span class="s4">*/</span>
  <span class="s3">static </span><span class="s2">findCacheDir</span><span class="s1">() {</span>
    <span class="s3">const </span><span class="s2">cwd </span><span class="s1">= </span><span class="s2">process</span><span class="s1">.</span><span class="s2">cwd</span><span class="s1">();</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@type </span><span class="s4">{string | undefined}</span>
     <span class="s4">*/</span>
    <span class="s3">let </span><span class="s2">dir </span><span class="s1">= </span><span class="s2">cwd</span><span class="s1">;</span>

    <span class="s3">for </span><span class="s1">(;;) {</span>
      <span class="s3">try </span><span class="s1">{</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">fs</span><span class="s1">.</span><span class="s2">statSync</span><span class="s1">(</span><span class="s2">path</span><span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s2">dir</span><span class="s1">, </span><span class="s0">&quot;package.json&quot;</span><span class="s1">)).</span><span class="s2">isFile</span><span class="s1">()) </span><span class="s3">break</span><span class="s1">;</span>
        <span class="s6">// eslint-disable-next-line no-empty</span>
      <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">e</span><span class="s1">) {}</span>

      <span class="s3">const </span><span class="s2">parent </span><span class="s1">= </span><span class="s2">path</span><span class="s1">.</span><span class="s2">dirname</span><span class="s1">(</span><span class="s2">dir</span><span class="s1">);</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">dir </span><span class="s1">=== </span><span class="s2">parent</span><span class="s1">) {</span>
        <span class="s6">// eslint-disable-next-line no-undefined</span>
        <span class="s2">dir </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
        <span class="s3">break</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s2">dir </span><span class="s1">= </span><span class="s2">parent</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(!</span><span class="s2">dir</span><span class="s1">) {</span>
      <span class="s3">return </span><span class="s2">path</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">(</span><span class="s2">cwd</span><span class="s1">, </span><span class="s0">&quot;.cache/webpack-dev-server&quot;</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">process</span><span class="s1">.</span><span class="s2">versions</span><span class="s1">.</span><span class="s2">pnp </span><span class="s1">=== </span><span class="s0">&quot;1&quot;</span><span class="s1">) {</span>
      <span class="s3">return </span><span class="s2">path</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">(</span><span class="s2">dir</span><span class="s1">, </span><span class="s0">&quot;.pnp/.cache/webpack-dev-server&quot;</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">process</span><span class="s1">.</span><span class="s2">versions</span><span class="s1">.</span><span class="s2">pnp </span><span class="s1">=== </span><span class="s0">&quot;3&quot;</span><span class="s1">) {</span>
      <span class="s3">return </span><span class="s2">path</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">(</span><span class="s2">dir</span><span class="s1">, </span><span class="s0">&quot;.yarn/.cache/webpack-dev-server&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s2">path</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">(</span><span class="s2">dir</span><span class="s1">, </span><span class="s0">&quot;node_modules/.cache/webpack-dev-server&quot;</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Compiler} compiler</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">bool</span>
   <span class="s4">*/</span>
  <span class="s3">static </span><span class="s2">isWebTarget</span><span class="s1">(</span><span class="s2">compiler</span><span class="s1">) {</span>
    <span class="s6">// TODO improve for the next major version - we should store `web` and other targets in `compiler.options.environment`</span>
    <span class="s3">if </span><span class="s1">(</span>
      <span class="s2">compiler</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">externalsPresets </span><span class="s1">&amp;&amp;</span>
      <span class="s2">compiler</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">externalsPresets</span><span class="s1">.</span><span class="s2">web</span>
    <span class="s1">) {</span>
      <span class="s3">return true</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span>
      <span class="s2">compiler</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">.</span><span class="s2">conditionNames </span><span class="s1">&amp;&amp;</span>
      <span class="s2">compiler</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">.</span><span class="s2">conditionNames</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s0">&quot;browser&quot;</span><span class="s1">)</span>
    <span class="s1">) {</span>
      <span class="s3">return true</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">const </span><span class="s2">webTargets </span><span class="s1">= [</span>
      <span class="s0">&quot;web&quot;</span><span class="s1">,</span>
      <span class="s0">&quot;webworker&quot;</span><span class="s1">,</span>
      <span class="s0">&quot;electron-preload&quot;</span><span class="s1">,</span>
      <span class="s0">&quot;electron-renderer&quot;</span><span class="s1">,</span>
      <span class="s0">&quot;node-webkit&quot;</span><span class="s1">,</span>
      <span class="s6">// eslint-disable-next-line no-undefined</span>
      <span class="s2">undefined</span><span class="s1">,</span>
      <span class="s3">null</span><span class="s1">,</span>
    <span class="s1">];</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">compiler</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">target</span><span class="s1">)) {</span>
      <span class="s3">return </span><span class="s2">compiler</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">target</span><span class="s1">.</span><span class="s2">some</span><span class="s1">((</span><span class="s2">r</span><span class="s1">) =&gt; </span><span class="s2">webTargets</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s2">r</span><span class="s1">));</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s2">webTargets</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{string} */ </span><span class="s1">(</span><span class="s2">compiler</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">target</span><span class="s1">));</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Compiler} compiler</span>
   <span class="s4">*/</span>
  <span class="s2">addAdditionalEntries</span><span class="s1">(</span><span class="s2">compiler</span><span class="s1">) {</span>
    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@type </span><span class="s4">{string[]}</span>
     <span class="s4">*/</span>
    <span class="s3">const </span><span class="s2">additionalEntries </span><span class="s1">= [];</span>
    <span class="s3">const </span><span class="s2">isWebTarget </span><span class="s1">= </span><span class="s2">Server</span><span class="s1">.</span><span class="s2">isWebTarget</span><span class="s1">(</span><span class="s2">compiler</span><span class="s1">);</span>

    <span class="s6">// TODO maybe empty client</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">client </span><span class="s1">&amp;&amp; </span><span class="s2">isWebTarget</span><span class="s1">) {</span>
      <span class="s3">let </span><span class="s2">webSocketURLStr </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">webSocketServer</span><span class="s1">) {</span>
        <span class="s3">const </span><span class="s2">webSocketURL </span><span class="s1">=</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{WebSocketURL} */</span>
          <span class="s1">(</span>
            <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ClientConfiguration} */</span>
            <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">).</span><span class="s2">webSocketURL</span>
          <span class="s1">);</span>
        <span class="s3">const </span><span class="s2">webSocketServer </span><span class="s1">=</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{{ type: WebSocketServerConfiguration[&quot;type&quot;], options: NonNullable&lt;WebSocketServerConfiguration[&quot;options&quot;]&gt; }} */</span>
          <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">webSocketServer</span><span class="s1">);</span>
        <span class="s3">const </span><span class="s2">searchParams </span><span class="s1">= </span><span class="s3">new </span><span class="s2">URLSearchParams</span><span class="s1">();</span>

        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{string} */</span>
        <span class="s3">let </span><span class="s2">protocol</span><span class="s1">;</span>

        <span class="s6">// We are proxying dev server and need to specify custom `hostname`</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">webSocketURL</span><span class="s1">.</span><span class="s2">protocol </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
          <span class="s2">protocol </span><span class="s1">= </span><span class="s2">webSocketURL</span><span class="s1">.</span><span class="s2">protocol</span><span class="s1">;</span>
        <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
          <span class="s2">protocol </span><span class="s1">=</span>
            <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ServerConfiguration} */</span>
            <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">server</span><span class="s1">).</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">&quot;http&quot; </span><span class="s1">? </span><span class="s0">&quot;ws:&quot; </span><span class="s1">: </span><span class="s0">&quot;wss:&quot;</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s2">searchParams</span><span class="s1">.</span><span class="s2">set</span><span class="s1">(</span><span class="s0">&quot;protocol&quot;</span><span class="s1">, </span><span class="s2">protocol</span><span class="s1">);</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">webSocketURL</span><span class="s1">.</span><span class="s2">username </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
          <span class="s2">searchParams</span><span class="s1">.</span><span class="s2">set</span><span class="s1">(</span><span class="s0">&quot;username&quot;</span><span class="s1">, </span><span class="s2">webSocketURL</span><span class="s1">.</span><span class="s2">username</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">webSocketURL</span><span class="s1">.</span><span class="s2">password </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
          <span class="s2">searchParams</span><span class="s1">.</span><span class="s2">set</span><span class="s1">(</span><span class="s0">&quot;password&quot;</span><span class="s1">, </span><span class="s2">webSocketURL</span><span class="s1">.</span><span class="s2">password</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{string} */</span>
        <span class="s3">let </span><span class="s2">hostname</span><span class="s1">;</span>

        <span class="s6">// SockJS is not supported server mode, so `hostname` and `port` can't specified, let's ignore them</span>
        <span class="s6">// TODO show warning about this</span>
        <span class="s3">const </span><span class="s2">isSockJSType </span><span class="s1">= </span><span class="s2">webSocketServer</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">&quot;sockjs&quot;</span><span class="s1">;</span>

        <span class="s6">// We are proxying dev server and need to specify custom `hostname`</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">webSocketURL</span><span class="s1">.</span><span class="s2">hostname </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
          <span class="s2">hostname </span><span class="s1">= </span><span class="s2">webSocketURL</span><span class="s1">.</span><span class="s2">hostname</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s6">// Web socket server works on custom `hostname`, only for `ws` because `sock-js` is not support custom `hostname`</span>
        <span class="s3">else if </span><span class="s1">(</span>
          <span class="s3">typeof </span><span class="s2">webSocketServer</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">host </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot; </span><span class="s1">&amp;&amp;</span>
          <span class="s1">!</span><span class="s2">isSockJSType</span>
        <span class="s1">) {</span>
          <span class="s2">hostname </span><span class="s1">= </span><span class="s2">webSocketServer</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">host</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s6">// The `host` option is specified</span>
        <span class="s3">else if </span><span class="s1">(</span><span class="s3">typeof this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">host </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
          <span class="s2">hostname </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">host</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s6">// The `port` option is not specified</span>
        <span class="s3">else </span><span class="s1">{</span>
          <span class="s2">hostname </span><span class="s1">= </span><span class="s0">&quot;0.0.0.0&quot;</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s2">searchParams</span><span class="s1">.</span><span class="s2">set</span><span class="s1">(</span><span class="s0">&quot;hostname&quot;</span><span class="s1">, </span><span class="s2">hostname</span><span class="s1">);</span>

        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{number | string} */</span>
        <span class="s3">let </span><span class="s2">port</span><span class="s1">;</span>

        <span class="s6">// We are proxying dev server and need to specify custom `port`</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">webSocketURL</span><span class="s1">.</span><span class="s2">port </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
          <span class="s2">port </span><span class="s1">= </span><span class="s2">webSocketURL</span><span class="s1">.</span><span class="s2">port</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s6">// Web socket server works on custom `port`, only for `ws` because `sock-js` is not support custom `port`</span>
        <span class="s3">else if </span><span class="s1">(</span>
          <span class="s3">typeof </span><span class="s2">webSocketServer</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">port </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot; </span><span class="s1">&amp;&amp;</span>
          <span class="s1">!</span><span class="s2">isSockJSType</span>
        <span class="s1">) {</span>
          <span class="s2">port </span><span class="s1">= </span><span class="s2">webSocketServer</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">port</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s6">// The `port` option is specified</span>
        <span class="s3">else if </span><span class="s1">(</span><span class="s3">typeof this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">port </span><span class="s1">=== </span><span class="s0">&quot;number&quot;</span><span class="s1">) {</span>
          <span class="s2">port </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">port</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s6">// The `port` option is specified using `string`</span>
        <span class="s3">else if </span><span class="s1">(</span>
          <span class="s3">typeof this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">port </span><span class="s1">=== </span><span class="s0">&quot;string&quot; </span><span class="s1">&amp;&amp;</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">port </span><span class="s1">!== </span><span class="s0">&quot;auto&quot;</span>
        <span class="s1">) {</span>
          <span class="s2">port </span><span class="s1">= </span><span class="s2">Number</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">port</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s6">// The `port` option is not specified or set to `auto`</span>
        <span class="s3">else </span><span class="s1">{</span>
          <span class="s2">port </span><span class="s1">= </span><span class="s0">&quot;0&quot;</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s2">searchParams</span><span class="s1">.</span><span class="s2">set</span><span class="s1">(</span><span class="s0">&quot;port&quot;</span><span class="s1">, </span><span class="s2">String</span><span class="s1">(</span><span class="s2">port</span><span class="s1">));</span>

        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{string} */</span>
        <span class="s3">let </span><span class="s2">pathname </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>

        <span class="s6">// We are proxying dev server and need to specify custom `pathname`</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">webSocketURL</span><span class="s1">.</span><span class="s2">pathname </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
          <span class="s2">pathname </span><span class="s1">= </span><span class="s2">webSocketURL</span><span class="s1">.</span><span class="s2">pathname</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s6">// Web socket server works on custom `path`</span>
        <span class="s3">else if </span><span class="s1">(</span>
          <span class="s3">typeof </span><span class="s2">webSocketServer</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">prefix </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot; </span><span class="s1">||</span>
          <span class="s3">typeof </span><span class="s2">webSocketServer</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">path </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span>
        <span class="s1">) {</span>
          <span class="s2">pathname </span><span class="s1">=</span>
            <span class="s2">webSocketServer</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">prefix </span><span class="s1">|| </span><span class="s2">webSocketServer</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">path</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s2">searchParams</span><span class="s1">.</span><span class="s2">set</span><span class="s1">(</span><span class="s0">&quot;pathname&quot;</span><span class="s1">, </span><span class="s2">pathname</span><span class="s1">);</span>

        <span class="s3">const </span><span class="s2">client </span><span class="s1">= </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ClientConfiguration} */ </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">);</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">client</span><span class="s1">.</span><span class="s2">logging </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
          <span class="s2">searchParams</span><span class="s1">.</span><span class="s2">set</span><span class="s1">(</span><span class="s0">&quot;logging&quot;</span><span class="s1">, </span><span class="s2">client</span><span class="s1">.</span><span class="s2">logging</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">client</span><span class="s1">.</span><span class="s2">progress </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
          <span class="s2">searchParams</span><span class="s1">.</span><span class="s2">set</span><span class="s1">(</span><span class="s0">&quot;progress&quot;</span><span class="s1">, </span><span class="s2">String</span><span class="s1">(</span><span class="s2">client</span><span class="s1">.</span><span class="s2">progress</span><span class="s1">));</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">client</span><span class="s1">.</span><span class="s2">overlay </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
          <span class="s3">const </span><span class="s2">overlayString </span><span class="s1">=</span>
            <span class="s3">typeof </span><span class="s2">client</span><span class="s1">.</span><span class="s2">overlay </span><span class="s1">=== </span><span class="s0">&quot;boolean&quot;</span>
              <span class="s1">? </span><span class="s2">String</span><span class="s1">(</span><span class="s2">client</span><span class="s1">.</span><span class="s2">overlay</span><span class="s1">)</span>
              <span class="s1">: </span><span class="s2">JSON</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">({</span>
                  <span class="s2">...client</span><span class="s1">.</span><span class="s2">overlay</span><span class="s1">,</span>
                  <span class="s2">errors</span><span class="s1">: </span><span class="s2">encodeOverlaySettings</span><span class="s1">(</span><span class="s2">client</span><span class="s1">.</span><span class="s2">overlay</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">),</span>
                  <span class="s2">warnings</span><span class="s1">: </span><span class="s2">encodeOverlaySettings</span><span class="s1">(</span><span class="s2">client</span><span class="s1">.</span><span class="s2">overlay</span><span class="s1">.</span><span class="s2">warnings</span><span class="s1">),</span>
                  <span class="s2">runtimeErrors</span><span class="s1">: </span><span class="s2">encodeOverlaySettings</span><span class="s1">(</span>
                    <span class="s2">client</span><span class="s1">.</span><span class="s2">overlay</span><span class="s1">.</span><span class="s2">runtimeErrors</span>
                  <span class="s1">),</span>
                <span class="s1">});</span>

          <span class="s2">searchParams</span><span class="s1">.</span><span class="s2">set</span><span class="s1">(</span><span class="s0">&quot;overlay&quot;</span><span class="s1">, </span><span class="s2">overlayString</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">client</span><span class="s1">.</span><span class="s2">reconnect </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
          <span class="s2">searchParams</span><span class="s1">.</span><span class="s2">set</span><span class="s1">(</span>
            <span class="s0">&quot;reconnect&quot;</span><span class="s1">,</span>
            <span class="s3">typeof </span><span class="s2">client</span><span class="s1">.</span><span class="s2">reconnect </span><span class="s1">=== </span><span class="s0">&quot;number&quot;</span>
              <span class="s1">? </span><span class="s2">String</span><span class="s1">(</span><span class="s2">client</span><span class="s1">.</span><span class="s2">reconnect</span><span class="s1">)</span>
              <span class="s1">: </span><span class="s0">&quot;10&quot;</span>
          <span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">hot </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
          <span class="s2">searchParams</span><span class="s1">.</span><span class="s2">set</span><span class="s1">(</span><span class="s0">&quot;hot&quot;</span><span class="s1">, </span><span class="s2">String</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">hot</span><span class="s1">));</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">liveReload </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
          <span class="s2">searchParams</span><span class="s1">.</span><span class="s2">set</span><span class="s1">(</span><span class="s0">&quot;live-reload&quot;</span><span class="s1">, </span><span class="s2">String</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">liveReload</span><span class="s1">));</span>
        <span class="s1">}</span>

        <span class="s2">webSocketURLStr </span><span class="s1">= </span><span class="s2">searchParams</span><span class="s1">.</span><span class="s2">toString</span><span class="s1">();</span>
      <span class="s1">}</span>

      <span class="s2">additionalEntries</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span>
        <span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">require</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">(</span><span class="s0">&quot;../client/index.js&quot;</span><span class="s1">)}</span><span class="s0">?</span><span class="s2">$</span><span class="s1">{</span><span class="s2">webSocketURLStr</span><span class="s1">}</span><span class="s0">`</span>
      <span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">hot </span><span class="s1">=== </span><span class="s0">&quot;only&quot;</span><span class="s1">) {</span>
      <span class="s2">additionalEntries</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">require</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">(</span><span class="s0">&quot;webpack/hot/only-dev-server&quot;</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">hot</span><span class="s1">) {</span>
      <span class="s2">additionalEntries</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">require</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">(</span><span class="s0">&quot;webpack/hot/dev-server&quot;</span><span class="s1">));</span>
    <span class="s1">}</span>

    <span class="s3">const </span><span class="s2">webpack </span><span class="s1">= </span><span class="s2">compiler</span><span class="s1">.</span><span class="s2">webpack </span><span class="s1">|| </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;webpack&quot;</span><span class="s1">);</span>

    <span class="s6">// use a hook to add entries if available</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">webpack</span><span class="s1">.</span><span class="s2">EntryPlugin </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
      <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">additionalEntry of additionalEntries</span><span class="s1">) {</span>
        <span class="s3">new </span><span class="s2">webpack</span><span class="s1">.</span><span class="s2">EntryPlugin</span><span class="s1">(</span><span class="s2">compiler</span><span class="s1">.</span><span class="s2">context</span><span class="s1">, </span><span class="s2">additionalEntry</span><span class="s1">, {</span>
          <span class="s6">// eslint-disable-next-line no-undefined</span>
          <span class="s2">name</span><span class="s1">: </span><span class="s2">undefined</span><span class="s1">,</span>
        <span class="s1">}).</span><span class="s2">apply</span><span class="s1">(</span><span class="s2">compiler</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s6">// TODO remove after drop webpack v4 support</span>
    <span class="s3">else </span><span class="s1">{</span>
      <span class="s4">/**</span>
       <span class="s4">* prependEntry Method for webpack 4</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{any} originalEntry</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{any} newAdditionalEntries</span>
       <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{any}</span>
       <span class="s4">*/</span>
      <span class="s3">const </span><span class="s2">prependEntry </span><span class="s1">= (</span><span class="s2">originalEntry</span><span class="s1">, </span><span class="s2">newAdditionalEntries</span><span class="s1">) =&gt; {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">originalEntry </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span><span class="s1">) {</span>
          <span class="s3">return </span><span class="s1">() =&gt;</span>
            <span class="s2">Promise</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">(</span><span class="s2">originalEntry</span><span class="s1">()).</span><span class="s2">then</span><span class="s1">((</span><span class="s2">entry</span><span class="s1">) =&gt;</span>
              <span class="s2">prependEntry</span><span class="s1">(</span><span class="s2">entry</span><span class="s1">, </span><span class="s2">newAdditionalEntries</span><span class="s1">)</span>
            <span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span>
          <span class="s3">typeof </span><span class="s2">originalEntry </span><span class="s1">=== </span><span class="s0">&quot;object&quot; </span><span class="s1">&amp;&amp;</span>
          <span class="s1">!</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">originalEntry</span><span class="s1">)</span>
        <span class="s1">) {</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{Object&lt;string,string&gt;} */</span>
          <span class="s3">const </span><span class="s2">clone </span><span class="s1">= {};</span>

          <span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">originalEntry</span><span class="s1">).</span><span class="s2">forEach</span><span class="s1">((</span><span class="s2">key</span><span class="s1">) =&gt; {</span>
            <span class="s6">// entry[key] should be a string here</span>
            <span class="s3">const </span><span class="s2">entryDescription </span><span class="s1">= </span><span class="s2">originalEntry</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>

            <span class="s2">clone</span><span class="s1">[</span><span class="s2">key</span><span class="s1">] = </span><span class="s2">prependEntry</span><span class="s1">(</span><span class="s2">entryDescription</span><span class="s1">, </span><span class="s2">newAdditionalEntries</span><span class="s1">);</span>
          <span class="s1">});</span>

          <span class="s3">return </span><span class="s2">clone</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s6">// in this case, entry is a string or an array.</span>
        <span class="s6">// make sure that we do not add duplicates.</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{any} */</span>
        <span class="s3">const </span><span class="s2">entriesClone </span><span class="s1">= </span><span class="s2">additionalEntries</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s8">0</span><span class="s1">);</span>

        <span class="s1">[].</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">originalEntry</span><span class="s1">).</span><span class="s2">forEach</span><span class="s1">((</span><span class="s2">newEntry</span><span class="s1">) =&gt; {</span>
          <span class="s3">if </span><span class="s1">(!</span><span class="s2">entriesClone</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s2">newEntry</span><span class="s1">)) {</span>
            <span class="s2">entriesClone</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">newEntry</span><span class="s1">);</span>
          <span class="s1">}</span>
        <span class="s1">});</span>

        <span class="s3">return </span><span class="s2">entriesClone</span><span class="s1">;</span>
      <span class="s1">};</span>

      <span class="s2">compiler</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">entry </span><span class="s1">= </span><span class="s2">prependEntry</span><span class="s1">(</span>
        <span class="s2">compiler</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">entry </span><span class="s1">|| </span><span class="s0">&quot;./src&quot;</span><span class="s1">,</span>
        <span class="s2">additionalEntries</span>
      <span class="s1">);</span>
      <span class="s2">compiler</span><span class="s1">.</span><span class="s2">hooks</span><span class="s1">.</span><span class="s2">entryOption</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{string} */ </span><span class="s1">(</span><span class="s2">compiler</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">context</span><span class="s1">),</span>
        <span class="s2">compiler</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">entry</span>
      <span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{Compiler[&quot;options&quot;]}</span>
   <span class="s4">*/</span>
  <span class="s2">getCompilerOptions</span><span class="s1">() {</span>
    <span class="s3">if </span><span class="s1">(</span>
      <span class="s3">typeof </span><span class="s1">(</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{MultiCompiler} */ </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">compiler</span><span class="s1">).</span><span class="s2">compilers</span><span class="s1">) !==</span>
      <span class="s0">&quot;undefined&quot;</span>
    <span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{MultiCompiler} */ </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">compiler</span><span class="s1">).</span><span class="s2">compilers</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s8">1</span><span class="s1">) {</span>
        <span class="s3">return </span><span class="s1">(</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{MultiCompiler} */</span>
          <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">compiler</span><span class="s1">).</span><span class="s2">compilers</span><span class="s1">[</span><span class="s8">0</span><span class="s1">].</span><span class="s2">options</span>
        <span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s6">// Configuration with the `devServer` options</span>
      <span class="s3">const </span><span class="s2">compilerWithDevServer </span><span class="s1">=</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{MultiCompiler} */</span>
        <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">compiler</span><span class="s1">).</span><span class="s2">compilers</span><span class="s1">.</span><span class="s2">find</span><span class="s1">((</span><span class="s2">config</span><span class="s1">) =&gt; </span><span class="s2">config</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">devServer</span><span class="s1">);</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">compilerWithDevServer</span><span class="s1">) {</span>
        <span class="s3">return </span><span class="s2">compilerWithDevServer</span><span class="s1">.</span><span class="s2">options</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s6">// Configuration with `web` preset</span>
      <span class="s3">const </span><span class="s2">compilerWithWebPreset </span><span class="s1">=</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{MultiCompiler} */</span>
        <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">compiler</span><span class="s1">).</span><span class="s2">compilers</span><span class="s1">.</span><span class="s2">find</span><span class="s1">(</span>
          <span class="s1">(</span><span class="s2">config</span><span class="s1">) =&gt;</span>
            <span class="s1">(</span><span class="s2">config</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">externalsPresets </span><span class="s1">&amp;&amp;</span>
              <span class="s2">config</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">externalsPresets</span><span class="s1">.</span><span class="s2">web</span><span class="s1">) ||</span>
            <span class="s1">[</span>
              <span class="s0">&quot;web&quot;</span><span class="s1">,</span>
              <span class="s0">&quot;webworker&quot;</span><span class="s1">,</span>
              <span class="s0">&quot;electron-preload&quot;</span><span class="s1">,</span>
              <span class="s0">&quot;electron-renderer&quot;</span><span class="s1">,</span>
              <span class="s0">&quot;node-webkit&quot;</span><span class="s1">,</span>
              <span class="s6">// eslint-disable-next-line no-undefined</span>
              <span class="s2">undefined</span><span class="s1">,</span>
              <span class="s3">null</span><span class="s1">,</span>
            <span class="s1">].</span><span class="s2">includes</span><span class="s1">(</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{string} */ </span><span class="s1">(</span><span class="s2">config</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">target</span><span class="s1">))</span>
        <span class="s1">);</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">compilerWithWebPreset</span><span class="s1">) {</span>
        <span class="s3">return </span><span class="s2">compilerWithWebPreset</span><span class="s1">.</span><span class="s2">options</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s6">// Fallback</span>
      <span class="s3">return </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{MultiCompiler} */ </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">compiler</span><span class="s1">).</span><span class="s2">compilers</span><span class="s1">[</span><span class="s8">0</span><span class="s1">].</span><span class="s2">options</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{Compiler} */ </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">compiler</span><span class="s1">).</span><span class="s2">options</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{Promise&lt;void&gt;}</span>
   <span class="s4">*/</span>
  <span class="s2">async normalizeOptions</span><span class="s1">() {</span>
    <span class="s3">const </span><span class="s1">{ </span><span class="s2">options </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">compilerOptions </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCompilerOptions</span><span class="s1">();</span>
    <span class="s6">// TODO remove `{}` after drop webpack v4 support</span>
    <span class="s3">const </span><span class="s2">compilerWatchOptions </span><span class="s1">= </span><span class="s2">compilerOptions</span><span class="s1">.</span><span class="s2">watchOptions </span><span class="s1">|| {};</span>
    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{WatchOptions &amp; { aggregateTimeout?: number, ignored?: WatchOptions[&quot;ignored&quot;], poll?: number | boolean }} watchOptions</span>
     <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{WatchOptions}</span>
     <span class="s4">*/</span>
    <span class="s3">const </span><span class="s2">getWatchOptions </span><span class="s1">= (</span><span class="s2">watchOptions </span><span class="s1">= {}) =&gt; {</span>
      <span class="s3">const </span><span class="s2">getPolling </span><span class="s1">= () =&gt; {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">watchOptions</span><span class="s1">.</span><span class="s2">usePolling </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
          <span class="s3">return </span><span class="s2">watchOptions</span><span class="s1">.</span><span class="s2">usePolling</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">watchOptions</span><span class="s1">.</span><span class="s2">poll </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
          <span class="s3">return </span><span class="s2">Boolean</span><span class="s1">(</span><span class="s2">watchOptions</span><span class="s1">.</span><span class="s2">poll</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">compilerWatchOptions</span><span class="s1">.</span><span class="s2">poll </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
          <span class="s3">return </span><span class="s2">Boolean</span><span class="s1">(</span><span class="s2">compilerWatchOptions</span><span class="s1">.</span><span class="s2">poll</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">return false</span><span class="s1">;</span>
      <span class="s1">};</span>
      <span class="s3">const </span><span class="s2">getInterval </span><span class="s1">= () =&gt; {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">watchOptions</span><span class="s1">.</span><span class="s2">interval </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
          <span class="s3">return </span><span class="s2">watchOptions</span><span class="s1">.</span><span class="s2">interval</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">watchOptions</span><span class="s1">.</span><span class="s2">poll </span><span class="s1">=== </span><span class="s0">&quot;number&quot;</span><span class="s1">) {</span>
          <span class="s3">return </span><span class="s2">watchOptions</span><span class="s1">.</span><span class="s2">poll</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">compilerWatchOptions</span><span class="s1">.</span><span class="s2">poll </span><span class="s1">=== </span><span class="s0">&quot;number&quot;</span><span class="s1">) {</span>
          <span class="s3">return </span><span class="s2">compilerWatchOptions</span><span class="s1">.</span><span class="s2">poll</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">};</span>

      <span class="s3">const </span><span class="s2">usePolling </span><span class="s1">= </span><span class="s2">getPolling</span><span class="s1">();</span>
      <span class="s3">const </span><span class="s2">interval </span><span class="s1">= </span><span class="s2">getInterval</span><span class="s1">();</span>
      <span class="s3">const </span><span class="s1">{ </span><span class="s2">poll</span><span class="s1">, </span><span class="s2">...rest </span><span class="s1">} = </span><span class="s2">watchOptions</span><span class="s1">;</span>

      <span class="s3">return </span><span class="s1">{</span>
        <span class="s2">ignoreInitial</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
        <span class="s2">persistent</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
        <span class="s2">followSymlinks</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
        <span class="s2">atomic</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
        <span class="s2">alwaysStat</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
        <span class="s2">ignorePermissionErrors</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
        <span class="s6">// Respect options from compiler watchOptions</span>
        <span class="s2">usePolling</span><span class="s1">,</span>
        <span class="s2">interval</span><span class="s1">,</span>
        <span class="s2">ignored</span><span class="s1">: </span><span class="s2">watchOptions</span><span class="s1">.</span><span class="s2">ignored</span><span class="s1">,</span>
        <span class="s6">// TODO: we respect these options for all watch options and allow developers to pass them to chokidar, but chokidar doesn't have these options maybe we need revisit that in future</span>
        <span class="s2">...rest</span><span class="s1">,</span>
      <span class="s1">};</span>
    <span class="s1">};</span>
    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{string | Static | undefined} [optionsForStatic]</span>
     <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{NormalizedStatic}</span>
     <span class="s4">*/</span>
    <span class="s3">const </span><span class="s2">getStaticItem </span><span class="s1">= (</span><span class="s2">optionsForStatic</span><span class="s1">) =&gt; {</span>
      <span class="s3">const </span><span class="s2">getDefaultStaticOptions </span><span class="s1">= () =&gt; {</span>
        <span class="s3">return </span><span class="s1">{</span>
          <span class="s2">directory</span><span class="s1">: </span><span class="s2">path</span><span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s2">process</span><span class="s1">.</span><span class="s2">cwd</span><span class="s1">(), </span><span class="s0">&quot;public&quot;</span><span class="s1">),</span>
          <span class="s2">staticOptions</span><span class="s1">: {},</span>
          <span class="s2">publicPath</span><span class="s1">: [</span><span class="s0">&quot;/&quot;</span><span class="s1">],</span>
          <span class="s2">serveIndex</span><span class="s1">: { </span><span class="s2">icons</span><span class="s1">: </span><span class="s3">true </span><span class="s1">},</span>
          <span class="s2">watch</span><span class="s1">: </span><span class="s2">getWatchOptions</span><span class="s1">(),</span>
        <span class="s1">};</span>
      <span class="s1">};</span>

      <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{NormalizedStatic} */</span>
      <span class="s3">let </span><span class="s2">item</span><span class="s1">;</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">optionsForStatic </span><span class="s1">=== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
        <span class="s2">item </span><span class="s1">= </span><span class="s2">getDefaultStaticOptions</span><span class="s1">();</span>
      <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">optionsForStatic </span><span class="s1">=== </span><span class="s0">&quot;string&quot;</span><span class="s1">) {</span>
        <span class="s2">item </span><span class="s1">= {</span>
          <span class="s2">...getDefaultStaticOptions</span><span class="s1">(),</span>
          <span class="s2">directory</span><span class="s1">: </span><span class="s2">optionsForStatic</span><span class="s1">,</span>
        <span class="s1">};</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s3">const </span><span class="s2">def </span><span class="s1">= </span><span class="s2">getDefaultStaticOptions</span><span class="s1">();</span>

        <span class="s2">item </span><span class="s1">= {</span>
          <span class="s2">directory</span><span class="s1">:</span>
            <span class="s3">typeof </span><span class="s2">optionsForStatic</span><span class="s1">.</span><span class="s2">directory </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span>
              <span class="s1">? </span><span class="s2">optionsForStatic</span><span class="s1">.</span><span class="s2">directory</span>
              <span class="s1">: </span><span class="s2">def</span><span class="s1">.</span><span class="s2">directory</span><span class="s1">,</span>
          <span class="s6">// TODO: do merge in the next major release</span>
          <span class="s2">staticOptions</span><span class="s1">:</span>
            <span class="s3">typeof </span><span class="s2">optionsForStatic</span><span class="s1">.</span><span class="s2">staticOptions </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span>
              <span class="s1">? </span><span class="s2">optionsForStatic</span><span class="s1">.</span><span class="s2">staticOptions</span>
              <span class="s1">: </span><span class="s2">def</span><span class="s1">.</span><span class="s2">staticOptions</span><span class="s1">,</span>
          <span class="s2">publicPath</span><span class="s1">:</span>
            <span class="s6">// eslint-disable-next-line no-nested-ternary</span>
            <span class="s3">typeof </span><span class="s2">optionsForStatic</span><span class="s1">.</span><span class="s2">publicPath </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span>
              <span class="s1">? </span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">optionsForStatic</span><span class="s1">.</span><span class="s2">publicPath</span><span class="s1">)</span>
                <span class="s1">? </span><span class="s2">optionsForStatic</span><span class="s1">.</span><span class="s2">publicPath</span>
                <span class="s1">: [</span><span class="s2">optionsForStatic</span><span class="s1">.</span><span class="s2">publicPath</span><span class="s1">]</span>
              <span class="s1">: </span><span class="s2">def</span><span class="s1">.</span><span class="s2">publicPath</span><span class="s1">,</span>
          <span class="s6">// TODO: do merge in the next major release</span>
          <span class="s2">serveIndex</span><span class="s1">:</span>
            <span class="s6">// eslint-disable-next-line no-nested-ternary</span>
            <span class="s3">typeof </span><span class="s2">optionsForStatic</span><span class="s1">.</span><span class="s2">serveIndex </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span>
              <span class="s1">? </span><span class="s3">typeof </span><span class="s2">optionsForStatic</span><span class="s1">.</span><span class="s2">serveIndex </span><span class="s1">=== </span><span class="s0">&quot;boolean&quot; </span><span class="s1">&amp;&amp;</span>
                <span class="s2">optionsForStatic</span><span class="s1">.</span><span class="s2">serveIndex</span>
                <span class="s1">? </span><span class="s2">def</span><span class="s1">.</span><span class="s2">serveIndex</span>
                <span class="s1">: </span><span class="s2">optionsForStatic</span><span class="s1">.</span><span class="s2">serveIndex</span>
              <span class="s1">: </span><span class="s2">def</span><span class="s1">.</span><span class="s2">serveIndex</span><span class="s1">,</span>
          <span class="s2">watch</span><span class="s1">:</span>
            <span class="s6">// eslint-disable-next-line no-nested-ternary</span>
            <span class="s3">typeof </span><span class="s2">optionsForStatic</span><span class="s1">.</span><span class="s2">watch </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span>
              <span class="s1">? </span><span class="s6">// eslint-disable-next-line no-nested-ternary</span>
                <span class="s3">typeof </span><span class="s2">optionsForStatic</span><span class="s1">.</span><span class="s2">watch </span><span class="s1">=== </span><span class="s0">&quot;boolean&quot;</span>
                <span class="s1">? </span><span class="s2">optionsForStatic</span><span class="s1">.</span><span class="s2">watch</span>
                  <span class="s1">? </span><span class="s2">def</span><span class="s1">.</span><span class="s2">watch</span>
                  <span class="s1">: </span><span class="s3">false</span>
                <span class="s1">: </span><span class="s2">getWatchOptions</span><span class="s1">(</span><span class="s2">optionsForStatic</span><span class="s1">.</span><span class="s2">watch</span><span class="s1">)</span>
              <span class="s1">: </span><span class="s2">def</span><span class="s1">.</span><span class="s2">watch</span><span class="s1">,</span>
        <span class="s1">};</span>
      <span class="s1">}</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">Server</span><span class="s1">.</span><span class="s2">isAbsoluteURL</span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">directory</span><span class="s1">)) {</span>
        <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">&quot;Using a URL as static.directory is not supported&quot;</span><span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s3">return </span><span class="s2">item</span><span class="s1">;</span>
    <span class="s1">};</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">allowedHosts </span><span class="s1">=== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
      <span class="s6">// AllowedHosts allows some default hosts picked from `options.host` or `webSocketURL.hostname` and `localhost`</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">allowedHosts </span><span class="s1">= </span><span class="s0">&quot;auto&quot;</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s6">// We store allowedHosts as array when supplied as string</span>
    <span class="s3">else if </span><span class="s1">(</span>
      <span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">allowedHosts </span><span class="s1">=== </span><span class="s0">&quot;string&quot; </span><span class="s1">&amp;&amp;</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">allowedHosts </span><span class="s1">!== </span><span class="s0">&quot;auto&quot; </span><span class="s1">&amp;&amp;</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">allowedHosts </span><span class="s1">!== </span><span class="s0">&quot;all&quot;</span>
    <span class="s1">) {</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">allowedHosts </span><span class="s1">= [</span><span class="s2">options</span><span class="s1">.</span><span class="s2">allowedHosts</span><span class="s1">];</span>
    <span class="s1">}</span>
    <span class="s6">// CLI pass options as array, we should normalize them</span>
    <span class="s3">else if </span><span class="s1">(</span>
      <span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">allowedHosts</span><span class="s1">) &amp;&amp;</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">allowedHosts</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s0">&quot;all&quot;</span><span class="s1">)</span>
    <span class="s1">) {</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">allowedHosts </span><span class="s1">= </span><span class="s0">&quot;all&quot;</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">bonjour </span><span class="s1">=== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">bonjour </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">bonjour </span><span class="s1">=== </span><span class="s0">&quot;boolean&quot;</span><span class="s1">) {</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">bonjour </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">bonjour </span><span class="s1">? {} : </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span>
      <span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">client </span><span class="s1">=== </span><span class="s0">&quot;undefined&quot; </span><span class="s1">||</span>
      <span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">client </span><span class="s1">=== </span><span class="s0">&quot;object&quot; </span><span class="s1">&amp;&amp; </span><span class="s2">options</span><span class="s1">.</span><span class="s2">client </span><span class="s1">!== </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(!</span><span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">) {</span>
        <span class="s2">options</span><span class="s1">.</span><span class="s2">client </span><span class="s1">= {};</span>
      <span class="s1">}</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">.</span><span class="s2">webSocketURL </span><span class="s1">=== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
        <span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">.</span><span class="s2">webSocketURL </span><span class="s1">= {};</span>
      <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">.</span><span class="s2">webSocketURL </span><span class="s1">=== </span><span class="s0">&quot;string&quot;</span><span class="s1">) {</span>
        <span class="s3">const </span><span class="s2">parsedURL </span><span class="s1">= </span><span class="s3">new </span><span class="s2">URL</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">.</span><span class="s2">webSocketURL</span><span class="s1">);</span>

        <span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">.</span><span class="s2">webSocketURL </span><span class="s1">= {</span>
          <span class="s2">protocol</span><span class="s1">: </span><span class="s2">parsedURL</span><span class="s1">.</span><span class="s2">protocol</span><span class="s1">,</span>
          <span class="s2">hostname</span><span class="s1">: </span><span class="s2">parsedURL</span><span class="s1">.</span><span class="s2">hostname</span><span class="s1">,</span>
          <span class="s2">port</span><span class="s1">: </span><span class="s2">parsedURL</span><span class="s1">.</span><span class="s2">port</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s8">0 </span><span class="s1">? </span><span class="s2">Number</span><span class="s1">(</span><span class="s2">parsedURL</span><span class="s1">.</span><span class="s2">port</span><span class="s1">) : </span><span class="s0">&quot;&quot;</span><span class="s1">,</span>
          <span class="s2">pathname</span><span class="s1">: </span><span class="s2">parsedURL</span><span class="s1">.</span><span class="s2">pathname</span><span class="s1">,</span>
          <span class="s2">username</span><span class="s1">: </span><span class="s2">parsedURL</span><span class="s1">.</span><span class="s2">username</span><span class="s1">,</span>
          <span class="s2">password</span><span class="s1">: </span><span class="s2">parsedURL</span><span class="s1">.</span><span class="s2">password</span><span class="s1">,</span>
        <span class="s1">};</span>
      <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">.</span><span class="s2">webSocketURL</span><span class="s1">.</span><span class="s2">port </span><span class="s1">=== </span><span class="s0">&quot;string&quot;</span><span class="s1">) {</span>
        <span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">.</span><span class="s2">webSocketURL</span><span class="s1">.</span><span class="s2">port </span><span class="s1">= </span><span class="s2">Number</span><span class="s1">(</span>
          <span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">.</span><span class="s2">webSocketURL</span><span class="s1">.</span><span class="s2">port</span>
        <span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s6">// Enable client overlay by default</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">.</span><span class="s2">overlay </span><span class="s1">=== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
        <span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">.</span><span class="s2">overlay </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">.</span><span class="s2">overlay </span><span class="s1">!== </span><span class="s0">&quot;boolean&quot;</span><span class="s1">) {</span>
        <span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">.</span><span class="s2">overlay </span><span class="s1">= {</span>
          <span class="s2">errors</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
          <span class="s2">warnings</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
          <span class="s2">...options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">.</span><span class="s2">overlay</span><span class="s1">,</span>
        <span class="s1">};</span>
      <span class="s1">}</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">.</span><span class="s2">reconnect </span><span class="s1">=== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
        <span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">.</span><span class="s2">reconnect </span><span class="s1">= </span><span class="s8">10</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">.</span><span class="s2">reconnect </span><span class="s1">=== </span><span class="s3">true</span><span class="s1">) {</span>
        <span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">.</span><span class="s2">reconnect </span><span class="s1">= </span><span class="s2">Infinity</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">.</span><span class="s2">reconnect </span><span class="s1">=== </span><span class="s3">false</span><span class="s1">) {</span>
        <span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">.</span><span class="s2">reconnect </span><span class="s1">= </span><span class="s8">0</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s6">// Respect infrastructureLogging.level</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">.</span><span class="s2">logging </span><span class="s1">=== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
        <span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">.</span><span class="s2">logging </span><span class="s1">= </span><span class="s2">compilerOptions</span><span class="s1">.</span><span class="s2">infrastructureLogging</span>
          <span class="s1">? </span><span class="s2">compilerOptions</span><span class="s1">.</span><span class="s2">infrastructureLogging</span><span class="s1">.</span><span class="s2">level</span>
          <span class="s1">: </span><span class="s0">&quot;info&quot;</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">compress </span><span class="s1">=== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">compress </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">devMiddleware </span><span class="s1">=== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">devMiddleware </span><span class="s1">= {};</span>
    <span class="s1">}</span>

    <span class="s6">// No need to normalize `headers`</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">historyApiFallback </span><span class="s1">=== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">historyApiFallback </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span>
      <span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">historyApiFallback </span><span class="s1">=== </span><span class="s0">&quot;boolean&quot; </span><span class="s1">&amp;&amp;</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">historyApiFallback</span>
    <span class="s1">) {</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">historyApiFallback </span><span class="s1">= {};</span>
    <span class="s1">}</span>

    <span class="s6">// No need to normalize `host`</span>

    <span class="s2">options</span><span class="s1">.</span><span class="s2">hot </span><span class="s1">=</span>
      <span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">hot </span><span class="s1">=== </span><span class="s0">&quot;boolean&quot; </span><span class="s1">|| </span><span class="s2">options</span><span class="s1">.</span><span class="s2">hot </span><span class="s1">=== </span><span class="s0">&quot;only&quot;</span>
        <span class="s1">? </span><span class="s2">options</span><span class="s1">.</span><span class="s2">hot</span>
        <span class="s1">: </span><span class="s3">true</span><span class="s1">;</span>

    <span class="s3">const </span><span class="s2">isHTTPs </span><span class="s1">= </span><span class="s2">Boolean</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">https</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">isSPDY </span><span class="s1">= </span><span class="s2">Boolean</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">http2</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">isHTTPs</span><span class="s1">) {</span>
      <span class="s6">// TODO: remove in the next major release</span>
      <span class="s2">util</span><span class="s1">.</span><span class="s2">deprecate</span><span class="s1">(</span>
        <span class="s1">() =&gt; {},</span>
        <span class="s0">&quot;'https' option is deprecated. Please use the 'server' option.&quot;</span><span class="s1">,</span>
        <span class="s0">&quot;DEP_WEBPACK_DEV_SERVER_HTTPS&quot;</span>
      <span class="s1">)();</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">isSPDY</span><span class="s1">) {</span>
      <span class="s6">// TODO: remove in the next major release</span>
      <span class="s2">util</span><span class="s1">.</span><span class="s2">deprecate</span><span class="s1">(</span>
        <span class="s1">() =&gt; {},</span>
        <span class="s0">&quot;'http2' option is deprecated. Please use the 'server' option.&quot;</span><span class="s1">,</span>
        <span class="s0">&quot;DEP_WEBPACK_DEV_SERVER_HTTP2&quot;</span>
      <span class="s1">)();</span>
    <span class="s1">}</span>

    <span class="s2">options</span><span class="s1">.</span><span class="s2">server </span><span class="s1">= {</span>
      <span class="s2">type</span><span class="s1">:</span>
        <span class="s6">// eslint-disable-next-line no-nested-ternary</span>
        <span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">server </span><span class="s1">=== </span><span class="s0">&quot;string&quot;</span>
          <span class="s1">? </span><span class="s2">options</span><span class="s1">.</span><span class="s2">server</span>
          <span class="s1">: </span><span class="s6">// eslint-disable-next-line no-nested-ternary</span>
          <span class="s3">typeof </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">server </span><span class="s1">|| {}).</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">&quot;string&quot;</span>
          <span class="s1">? </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ServerConfiguration} */ </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">server</span><span class="s1">).</span><span class="s2">type </span><span class="s1">|| </span><span class="s0">&quot;http&quot;</span>
          <span class="s1">: </span><span class="s6">// eslint-disable-next-line no-nested-ternary</span>
          <span class="s2">isSPDY</span>
          <span class="s1">? </span><span class="s0">&quot;spdy&quot;</span>
          <span class="s1">: </span><span class="s2">isHTTPs</span>
          <span class="s1">? </span><span class="s0">&quot;https&quot;</span>
          <span class="s1">: </span><span class="s0">&quot;http&quot;</span><span class="s1">,</span>
      <span class="s2">options</span><span class="s1">: {</span>
        <span class="s2">...</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ServerOptions} */ </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">https</span><span class="s1">),</span>
        <span class="s2">...</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ServerConfiguration} */ </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">server </span><span class="s1">|| {}).</span><span class="s2">options</span><span class="s1">,</span>
      <span class="s1">},</span>
    <span class="s1">};</span>

    <span class="s3">if </span><span class="s1">(</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">server</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">&quot;spdy&quot; </span><span class="s1">&amp;&amp;</span>
      <span class="s3">typeof </span><span class="s1">(</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ServerOptions} */ </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">server</span><span class="s1">.</span><span class="s2">options</span><span class="s1">).</span><span class="s2">spdy</span><span class="s1">) ===</span>
        <span class="s0">&quot;undefined&quot;</span>
    <span class="s1">) {</span>
      <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ServerOptions} */</span>
      <span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">server</span><span class="s1">.</span><span class="s2">options</span><span class="s1">).</span><span class="s2">spdy </span><span class="s1">= {</span>
        <span class="s2">protocols</span><span class="s1">: [</span><span class="s0">&quot;h2&quot;</span><span class="s1">, </span><span class="s0">&quot;http/1.1&quot;</span><span class="s1">],</span>
      <span class="s1">};</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">server</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">&quot;https&quot; </span><span class="s1">|| </span><span class="s2">options</span><span class="s1">.</span><span class="s2">server</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">&quot;spdy&quot;</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span>
        <span class="s3">typeof </span><span class="s1">(</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ServerOptions} */ </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">server</span><span class="s1">.</span><span class="s2">options</span><span class="s1">).</span><span class="s2">requestCert</span>
        <span class="s1">) === </span><span class="s0">&quot;undefined&quot;</span>
      <span class="s1">) {</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ServerOptions} */</span>
        <span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">server</span><span class="s1">.</span><span class="s2">options</span><span class="s1">).</span><span class="s2">requestCert </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s3">const </span><span class="s2">httpsProperties </span><span class="s1">=</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{Array&lt;keyof ServerOptions&gt;} */</span>
        <span class="s1">([</span><span class="s0">&quot;cacert&quot;</span><span class="s1">, </span><span class="s0">&quot;ca&quot;</span><span class="s1">, </span><span class="s0">&quot;cert&quot;</span><span class="s1">, </span><span class="s0">&quot;crl&quot;</span><span class="s1">, </span><span class="s0">&quot;key&quot;</span><span class="s1">, </span><span class="s0">&quot;pfx&quot;</span><span class="s1">]);</span>

      <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">property of httpsProperties</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span>
          <span class="s3">typeof </span><span class="s1">(</span>
            <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ServerOptions} */ </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">server</span><span class="s1">.</span><span class="s2">options</span><span class="s1">)[</span><span class="s2">property</span><span class="s1">]</span>
          <span class="s1">) === </span><span class="s0">&quot;undefined&quot;</span>
        <span class="s1">) {</span>
          <span class="s6">// eslint-disable-next-line no-continue</span>
          <span class="s3">continue</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s6">// @ts-ignore</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">property </span><span class="s1">=== </span><span class="s0">&quot;cacert&quot;</span><span class="s1">) {</span>
          <span class="s6">// TODO remove the `cacert` option in favor `ca` in the next major release</span>
          <span class="s2">util</span><span class="s1">.</span><span class="s2">deprecate</span><span class="s1">(</span>
            <span class="s1">() =&gt; {},</span>
            <span class="s0">&quot;The 'cacert' option is deprecated. Please use the 'ca' option.&quot;</span><span class="s1">,</span>
            <span class="s0">&quot;DEP_WEBPACK_DEV_SERVER_CACERT&quot;</span>
          <span class="s1">)();</span>
        <span class="s1">}</span>

        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{any} */</span>
        <span class="s3">const </span><span class="s2">value </span><span class="s1">=</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ServerOptions} */</span>
          <span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">server</span><span class="s1">.</span><span class="s2">options</span><span class="s1">)[</span><span class="s2">property</span><span class="s1">];</span>
        <span class="s4">/**</span>
         <span class="s4">* </span><span class="s5">@param </span><span class="s4">{string | Buffer | undefined} item</span>
         <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{string | Buffer | undefined}</span>
         <span class="s4">*/</span>
        <span class="s3">const </span><span class="s2">readFile </span><span class="s1">= (</span><span class="s2">item</span><span class="s1">) =&gt; {</span>
          <span class="s3">if </span><span class="s1">(</span>
            <span class="s2">Buffer</span><span class="s1">.</span><span class="s2">isBuffer</span><span class="s1">(</span><span class="s2">item</span><span class="s1">) ||</span>
            <span class="s1">(</span><span class="s3">typeof </span><span class="s2">item </span><span class="s1">=== </span><span class="s0">&quot;object&quot; </span><span class="s1">&amp;&amp; </span><span class="s2">item </span><span class="s1">!== </span><span class="s3">null </span><span class="s1">&amp;&amp; !</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">item</span><span class="s1">))</span>
          <span class="s1">) {</span>
            <span class="s3">return </span><span class="s2">item</span><span class="s1">;</span>
          <span class="s1">}</span>

          <span class="s3">if </span><span class="s1">(</span><span class="s2">item</span><span class="s1">) {</span>
            <span class="s3">let </span><span class="s2">stats </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>

            <span class="s3">try </span><span class="s1">{</span>
              <span class="s2">stats </span><span class="s1">= </span><span class="s2">fs</span><span class="s1">.</span><span class="s2">lstatSync</span><span class="s1">(</span><span class="s2">fs</span><span class="s1">.</span><span class="s2">realpathSync</span><span class="s1">(</span><span class="s2">item</span><span class="s1">)).</span><span class="s2">isFile</span><span class="s1">();</span>
            <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) {</span>
              <span class="s6">// Ignore error</span>
            <span class="s1">}</span>

            <span class="s6">// It is a file</span>
            <span class="s3">return </span><span class="s2">stats </span><span class="s1">? </span><span class="s2">fs</span><span class="s1">.</span><span class="s2">readFileSync</span><span class="s1">(</span><span class="s2">item</span><span class="s1">) : </span><span class="s2">item</span><span class="s1">;</span>
          <span class="s1">}</span>
        <span class="s1">};</span>

        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{any} */</span>
        <span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">server</span><span class="s1">.</span><span class="s2">options</span><span class="s1">)[</span><span class="s2">property</span><span class="s1">] = </span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">value</span><span class="s1">)</span>
          <span class="s1">? </span><span class="s2">value</span><span class="s1">.</span><span class="s2">map</span><span class="s1">((</span><span class="s2">item</span><span class="s1">) =&gt; </span><span class="s2">readFile</span><span class="s1">(</span><span class="s2">item</span><span class="s1">))</span>
          <span class="s1">: </span><span class="s2">readFile</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s3">let </span><span class="s2">fakeCert</span><span class="s1">;</span>

      <span class="s3">if </span><span class="s1">(</span>
        <span class="s1">!(</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ServerOptions} */ </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">server</span><span class="s1">.</span><span class="s2">options</span><span class="s1">).</span><span class="s2">key</span><span class="s1">) ||</span>
        <span class="s1">!(</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ServerOptions} */ </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">server</span><span class="s1">.</span><span class="s2">options</span><span class="s1">).</span><span class="s2">cert</span><span class="s1">)</span>
      <span class="s1">) {</span>
        <span class="s3">const </span><span class="s2">certificateDir </span><span class="s1">= </span><span class="s2">Server</span><span class="s1">.</span><span class="s2">findCacheDir</span><span class="s1">();</span>
        <span class="s3">const </span><span class="s2">certificatePath </span><span class="s1">= </span><span class="s2">path</span><span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s2">certificateDir</span><span class="s1">, </span><span class="s0">&quot;server.pem&quot;</span><span class="s1">);</span>
        <span class="s3">let </span><span class="s2">certificateExists</span><span class="s1">;</span>

        <span class="s3">try </span><span class="s1">{</span>
          <span class="s3">const </span><span class="s2">certificate </span><span class="s1">= </span><span class="s3">await </span><span class="s2">fs</span><span class="s1">.</span><span class="s2">promises</span><span class="s1">.</span><span class="s2">stat</span><span class="s1">(</span><span class="s2">certificatePath</span><span class="s1">);</span>
          <span class="s2">certificateExists </span><span class="s1">= </span><span class="s2">certificate</span><span class="s1">.</span><span class="s2">isFile</span><span class="s1">();</span>
        <span class="s1">} </span><span class="s3">catch </span><span class="s1">{</span>
          <span class="s2">certificateExists </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">certificateExists</span><span class="s1">) {</span>
          <span class="s3">const </span><span class="s2">certificateTtl </span><span class="s1">= </span><span class="s8">1000 </span><span class="s1">* </span><span class="s8">60 </span><span class="s1">* </span><span class="s8">60 </span><span class="s1">* </span><span class="s8">24</span><span class="s1">;</span>
          <span class="s3">const </span><span class="s2">certificateStat </span><span class="s1">= </span><span class="s3">await </span><span class="s2">fs</span><span class="s1">.</span><span class="s2">promises</span><span class="s1">.</span><span class="s2">stat</span><span class="s1">(</span><span class="s2">certificatePath</span><span class="s1">);</span>
          <span class="s3">const </span><span class="s2">now </span><span class="s1">= </span><span class="s2">Number</span><span class="s1">(</span><span class="s3">new </span><span class="s2">Date</span><span class="s1">());</span>

          <span class="s6">// cert is more than 30 days old, kill it with fire</span>
          <span class="s3">if </span><span class="s1">((</span><span class="s2">now </span><span class="s1">- </span><span class="s2">Number</span><span class="s1">(</span><span class="s2">certificateStat</span><span class="s1">.</span><span class="s2">ctime</span><span class="s1">)) / </span><span class="s2">certificateTtl </span><span class="s1">&gt; </span><span class="s8">30</span><span class="s1">) {</span>
            <span class="s3">const </span><span class="s1">{ </span><span class="s2">promisify </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;util&quot;</span><span class="s1">);</span>
            <span class="s3">const </span><span class="s2">rimraf </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;rimraf&quot;</span><span class="s1">);</span>
            <span class="s3">const </span><span class="s2">del </span><span class="s1">= </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">rimraf</span><span class="s1">);</span>

            <span class="s3">this</span><span class="s1">.</span><span class="s2">logger</span><span class="s1">.</span><span class="s2">info</span><span class="s1">(</span>
              <span class="s0">&quot;SSL certificate is more than 30 days old. Removing...&quot;</span>
            <span class="s1">);</span>

            <span class="s3">await </span><span class="s2">del</span><span class="s1">(</span><span class="s2">certificatePath</span><span class="s1">);</span>

            <span class="s2">certificateExists </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
          <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(!</span><span class="s2">certificateExists</span><span class="s1">) {</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">logger</span><span class="s1">.</span><span class="s2">info</span><span class="s1">(</span><span class="s0">&quot;Generating SSL certificate...&quot;</span><span class="s1">);</span>

          <span class="s6">// @ts-ignore</span>
          <span class="s3">const </span><span class="s2">selfsigned </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;selfsigned&quot;</span><span class="s1">);</span>
          <span class="s3">const </span><span class="s2">attributes </span><span class="s1">= [{ </span><span class="s2">name</span><span class="s1">: </span><span class="s0">&quot;commonName&quot;</span><span class="s1">, </span><span class="s2">value</span><span class="s1">: </span><span class="s0">&quot;localhost&quot; </span><span class="s1">}];</span>
          <span class="s3">const </span><span class="s2">pems </span><span class="s1">= </span><span class="s2">selfsigned</span><span class="s1">.</span><span class="s2">generate</span><span class="s1">(</span><span class="s2">attributes</span><span class="s1">, {</span>
            <span class="s2">algorithm</span><span class="s1">: </span><span class="s0">&quot;sha256&quot;</span><span class="s1">,</span>
            <span class="s2">days</span><span class="s1">: </span><span class="s8">30</span><span class="s1">,</span>
            <span class="s2">keySize</span><span class="s1">: </span><span class="s8">2048</span><span class="s1">,</span>
            <span class="s2">extensions</span><span class="s1">: [</span>
              <span class="s1">{</span>
                <span class="s2">name</span><span class="s1">: </span><span class="s0">&quot;basicConstraints&quot;</span><span class="s1">,</span>
                <span class="s2">cA</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
              <span class="s1">},</span>
              <span class="s1">{</span>
                <span class="s2">name</span><span class="s1">: </span><span class="s0">&quot;keyUsage&quot;</span><span class="s1">,</span>
                <span class="s2">keyCertSign</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
                <span class="s2">digitalSignature</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
                <span class="s2">nonRepudiation</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
                <span class="s2">keyEncipherment</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
                <span class="s2">dataEncipherment</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
              <span class="s1">},</span>
              <span class="s1">{</span>
                <span class="s2">name</span><span class="s1">: </span><span class="s0">&quot;extKeyUsage&quot;</span><span class="s1">,</span>
                <span class="s2">serverAuth</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
                <span class="s2">clientAuth</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
                <span class="s2">codeSigning</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
                <span class="s2">timeStamping</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
              <span class="s1">},</span>
              <span class="s1">{</span>
                <span class="s2">name</span><span class="s1">: </span><span class="s0">&quot;subjectAltName&quot;</span><span class="s1">,</span>
                <span class="s2">altNames</span><span class="s1">: [</span>
                  <span class="s1">{</span>
                    <span class="s6">// type 2 is DNS</span>
                    <span class="s2">type</span><span class="s1">: </span><span class="s8">2</span><span class="s1">,</span>
                    <span class="s2">value</span><span class="s1">: </span><span class="s0">&quot;localhost&quot;</span><span class="s1">,</span>
                  <span class="s1">},</span>
                  <span class="s1">{</span>
                    <span class="s2">type</span><span class="s1">: </span><span class="s8">2</span><span class="s1">,</span>
                    <span class="s2">value</span><span class="s1">: </span><span class="s0">&quot;localhost.localdomain&quot;</span><span class="s1">,</span>
                  <span class="s1">},</span>
                  <span class="s1">{</span>
                    <span class="s2">type</span><span class="s1">: </span><span class="s8">2</span><span class="s1">,</span>
                    <span class="s2">value</span><span class="s1">: </span><span class="s0">&quot;lvh.me&quot;</span><span class="s1">,</span>
                  <span class="s1">},</span>
                  <span class="s1">{</span>
                    <span class="s2">type</span><span class="s1">: </span><span class="s8">2</span><span class="s1">,</span>
                    <span class="s2">value</span><span class="s1">: </span><span class="s0">&quot;*.lvh.me&quot;</span><span class="s1">,</span>
                  <span class="s1">},</span>
                  <span class="s1">{</span>
                    <span class="s2">type</span><span class="s1">: </span><span class="s8">2</span><span class="s1">,</span>
                    <span class="s2">value</span><span class="s1">: </span><span class="s0">&quot;[::1]&quot;</span><span class="s1">,</span>
                  <span class="s1">},</span>
                  <span class="s1">{</span>
                    <span class="s6">// type 7 is IP</span>
                    <span class="s2">type</span><span class="s1">: </span><span class="s8">7</span><span class="s1">,</span>
                    <span class="s2">ip</span><span class="s1">: </span><span class="s0">&quot;127.0.0.1&quot;</span><span class="s1">,</span>
                  <span class="s1">},</span>
                  <span class="s1">{</span>
                    <span class="s2">type</span><span class="s1">: </span><span class="s8">7</span><span class="s1">,</span>
                    <span class="s2">ip</span><span class="s1">: </span><span class="s0">&quot;fe80::1&quot;</span><span class="s1">,</span>
                  <span class="s1">},</span>
                <span class="s1">],</span>
              <span class="s1">},</span>
            <span class="s1">],</span>
          <span class="s1">});</span>

          <span class="s3">await </span><span class="s2">fs</span><span class="s1">.</span><span class="s2">promises</span><span class="s1">.</span><span class="s2">mkdir</span><span class="s1">(</span><span class="s2">certificateDir</span><span class="s1">, { </span><span class="s2">recursive</span><span class="s1">: </span><span class="s3">true </span><span class="s1">});</span>

          <span class="s3">await </span><span class="s2">fs</span><span class="s1">.</span><span class="s2">promises</span><span class="s1">.</span><span class="s2">writeFile</span><span class="s1">(</span>
            <span class="s2">certificatePath</span><span class="s1">,</span>
            <span class="s2">pems</span><span class="s1">.</span><span class="s2">private </span><span class="s1">+ </span><span class="s2">pems</span><span class="s1">.</span><span class="s2">cert</span><span class="s1">,</span>
            <span class="s1">{</span>
              <span class="s2">encoding</span><span class="s1">: </span><span class="s0">&quot;utf8&quot;</span><span class="s1">,</span>
            <span class="s1">}</span>
          <span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s2">fakeCert </span><span class="s1">= </span><span class="s3">await </span><span class="s2">fs</span><span class="s1">.</span><span class="s2">promises</span><span class="s1">.</span><span class="s2">readFile</span><span class="s1">(</span><span class="s2">certificatePath</span><span class="s1">);</span>

        <span class="s3">this</span><span class="s1">.</span><span class="s2">logger</span><span class="s1">.</span><span class="s2">info</span><span class="s1">(</span><span class="s0">`SSL certificate: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">certificatePath</span><span class="s1">}</span><span class="s0">`</span><span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s3">if </span><span class="s1">(</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ServerOptions &amp; { cacert?: ServerOptions[&quot;ca&quot;] }} */ </span><span class="s1">(</span>
          <span class="s2">options</span><span class="s1">.</span><span class="s2">server</span><span class="s1">.</span><span class="s2">options</span>
        <span class="s1">).</span><span class="s2">cacert</span>
      <span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ServerOptions} */ </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">server</span><span class="s1">.</span><span class="s2">options</span><span class="s1">).</span><span class="s2">ca</span><span class="s1">) {</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">logger</span><span class="s1">.</span><span class="s2">warn</span><span class="s1">(</span>
            <span class="s0">&quot;Do not specify 'ca' and 'cacert' options together, the 'ca' option will be used.&quot;</span>
          <span class="s1">);</span>
        <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ServerOptions} */</span>
          <span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">server</span><span class="s1">.</span><span class="s2">options</span><span class="s1">).</span><span class="s2">ca </span><span class="s1">=</span>
            <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ServerOptions &amp; { cacert?: ServerOptions[&quot;ca&quot;] }} */</span>
            <span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">server</span><span class="s1">.</span><span class="s2">options</span><span class="s1">).</span><span class="s2">cacert</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">delete </span><span class="s1">(</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ServerOptions &amp; { cacert?: ServerOptions[&quot;ca&quot;] }} */ </span><span class="s1">(</span>
            <span class="s2">options</span><span class="s1">.</span><span class="s2">server</span><span class="s1">.</span><span class="s2">options</span>
          <span class="s1">).</span><span class="s2">cacert</span>
        <span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ServerOptions} */</span>
      <span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">server</span><span class="s1">.</span><span class="s2">options</span><span class="s1">).</span><span class="s2">key </span><span class="s1">=</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ServerOptions} */</span>
        <span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">server</span><span class="s1">.</span><span class="s2">options</span><span class="s1">).</span><span class="s2">key </span><span class="s1">|| </span><span class="s2">fakeCert</span><span class="s1">;</span>
      <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ServerOptions} */</span>
      <span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">server</span><span class="s1">.</span><span class="s2">options</span><span class="s1">).</span><span class="s2">cert </span><span class="s1">=</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ServerOptions} */</span>
        <span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">server</span><span class="s1">.</span><span class="s2">options</span><span class="s1">).</span><span class="s2">cert </span><span class="s1">|| </span><span class="s2">fakeCert</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">ipc </span><span class="s1">=== </span><span class="s0">&quot;boolean&quot;</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">isWindows </span><span class="s1">= </span><span class="s2">process</span><span class="s1">.</span><span class="s2">platform </span><span class="s1">=== </span><span class="s0">&quot;win32&quot;</span><span class="s1">;</span>
      <span class="s3">const </span><span class="s2">pipePrefix </span><span class="s1">= </span><span class="s2">isWindows </span><span class="s1">? </span><span class="s0">&quot;</span><span class="s3">\\\\</span><span class="s0">.</span><span class="s3">\\</span><span class="s0">pipe</span><span class="s3">\\</span><span class="s0">&quot; </span><span class="s1">: </span><span class="s2">os</span><span class="s1">.</span><span class="s2">tmpdir</span><span class="s1">();</span>
      <span class="s3">const </span><span class="s2">pipeName </span><span class="s1">= </span><span class="s0">&quot;webpack-dev-server.sock&quot;</span><span class="s1">;</span>

      <span class="s2">options</span><span class="s1">.</span><span class="s2">ipc </span><span class="s1">= </span><span class="s2">path</span><span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s2">pipePrefix</span><span class="s1">, </span><span class="s2">pipeName</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s2">options</span><span class="s1">.</span><span class="s2">liveReload </span><span class="s1">=</span>
      <span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">liveReload </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot; </span><span class="s1">? </span><span class="s2">options</span><span class="s1">.</span><span class="s2">liveReload </span><span class="s1">: </span><span class="s3">true</span><span class="s1">;</span>

    <span class="s2">options</span><span class="s1">.</span><span class="s2">magicHtml </span><span class="s1">=</span>
      <span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">magicHtml </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot; </span><span class="s1">? </span><span class="s2">options</span><span class="s1">.</span><span class="s2">magicHtml </span><span class="s1">: </span><span class="s3">true</span><span class="s1">;</span>

    <span class="s6">// https://github.com/webpack/webpack-dev-server/issues/1990</span>
    <span class="s3">const </span><span class="s2">defaultOpenOptions </span><span class="s1">= { </span><span class="s2">wait</span><span class="s1">: </span><span class="s3">false </span><span class="s1">};</span>
    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{any} target</span>
     <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{NormalizedOpen[]}</span>
     <span class="s4">*/</span>
    <span class="s6">// TODO: remove --open-app in favor of --open-app-name</span>
    <span class="s3">const </span><span class="s2">getOpenItemsFromObject </span><span class="s1">= ({ </span><span class="s2">target</span><span class="s1">, </span><span class="s2">...rest </span><span class="s1">}) =&gt; {</span>
      <span class="s3">const </span><span class="s2">normalizedOptions </span><span class="s1">= { </span><span class="s2">...defaultOpenOptions</span><span class="s1">, </span><span class="s2">...rest </span><span class="s1">};</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">normalizedOptions</span><span class="s1">.</span><span class="s2">app </span><span class="s1">=== </span><span class="s0">&quot;string&quot;</span><span class="s1">) {</span>
        <span class="s2">normalizedOptions</span><span class="s1">.</span><span class="s2">app </span><span class="s1">= {</span>
          <span class="s2">name</span><span class="s1">: </span><span class="s2">normalizedOptions</span><span class="s1">.</span><span class="s2">app</span><span class="s1">,</span>
        <span class="s1">};</span>
      <span class="s1">}</span>

      <span class="s3">const </span><span class="s2">normalizedTarget </span><span class="s1">= </span><span class="s3">typeof </span><span class="s2">target </span><span class="s1">=== </span><span class="s0">&quot;undefined&quot; </span><span class="s1">? </span><span class="s0">&quot;&lt;url&gt;&quot; </span><span class="s1">: </span><span class="s2">target</span><span class="s1">;</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">normalizedTarget</span><span class="s1">)) {</span>
        <span class="s3">return </span><span class="s2">normalizedTarget</span><span class="s1">.</span><span class="s2">map</span><span class="s1">((</span><span class="s2">singleTarget</span><span class="s1">) =&gt; {</span>
          <span class="s3">return </span><span class="s1">{ </span><span class="s2">target</span><span class="s1">: </span><span class="s2">singleTarget</span><span class="s1">, </span><span class="s2">options</span><span class="s1">: </span><span class="s2">normalizedOptions </span><span class="s1">};</span>
        <span class="s1">});</span>
      <span class="s1">}</span>

      <span class="s3">return </span><span class="s1">[{ </span><span class="s2">target</span><span class="s1">: </span><span class="s2">normalizedTarget</span><span class="s1">, </span><span class="s2">options</span><span class="s1">: </span><span class="s2">normalizedOptions </span><span class="s1">}];</span>
    <span class="s1">};</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">open </span><span class="s1">=== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
      <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{NormalizedOpen[]} */</span>
      <span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">open</span><span class="s1">) = [];</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">open </span><span class="s1">=== </span><span class="s0">&quot;boolean&quot;</span><span class="s1">) {</span>
      <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{NormalizedOpen[]} */</span>
      <span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">open</span><span class="s1">) = </span><span class="s2">options</span><span class="s1">.</span><span class="s2">open</span>
        <span class="s1">? [</span>
            <span class="s1">{</span>
              <span class="s2">target</span><span class="s1">: </span><span class="s0">&quot;&lt;url&gt;&quot;</span><span class="s1">,</span>
              <span class="s2">options</span><span class="s1">: </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{OpenOptions} */ </span><span class="s1">(</span><span class="s2">defaultOpenOptions</span><span class="s1">),</span>
            <span class="s1">},</span>
          <span class="s1">]</span>
        <span class="s1">: [];</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">open </span><span class="s1">=== </span><span class="s0">&quot;string&quot;</span><span class="s1">) {</span>
      <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{NormalizedOpen[]} */</span>
      <span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">open</span><span class="s1">) = [{ </span><span class="s2">target</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">open</span><span class="s1">, </span><span class="s2">options</span><span class="s1">: </span><span class="s2">defaultOpenOptions </span><span class="s1">}];</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">open</span><span class="s1">)) {</span>
      <span class="s4">/**</span>
       <span class="s4">* </span><span class="s5">@type </span><span class="s4">{NormalizedOpen[]}</span>
       <span class="s4">*/</span>
      <span class="s3">const </span><span class="s2">result </span><span class="s1">= [];</span>

      <span class="s2">options</span><span class="s1">.</span><span class="s2">open</span><span class="s1">.</span><span class="s2">forEach</span><span class="s1">((</span><span class="s2">item</span><span class="s1">) =&gt; {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">item </span><span class="s1">=== </span><span class="s0">&quot;string&quot;</span><span class="s1">) {</span>
          <span class="s2">result</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({ </span><span class="s2">target</span><span class="s1">: </span><span class="s2">item</span><span class="s1">, </span><span class="s2">options</span><span class="s1">: </span><span class="s2">defaultOpenOptions </span><span class="s1">});</span>

          <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s2">result</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">...getOpenItemsFromObject</span><span class="s1">(</span><span class="s2">item</span><span class="s1">));</span>
      <span class="s1">});</span>

      <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{NormalizedOpen[]} */</span>
      <span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">open</span><span class="s1">) = </span><span class="s2">result</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{NormalizedOpen[]} */</span>
      <span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">open</span><span class="s1">) = [</span><span class="s2">...getOpenItemsFromObject</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">open</span><span class="s1">)];</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">onAfterSetupMiddleware</span><span class="s1">) {</span>
      <span class="s6">// TODO: remove in the next major release</span>
      <span class="s2">util</span><span class="s1">.</span><span class="s2">deprecate</span><span class="s1">(</span>
        <span class="s1">() =&gt; {},</span>
        <span class="s0">&quot;'onAfterSetupMiddleware' option is deprecated. Please use the 'setupMiddlewares' option.&quot;</span><span class="s1">,</span>
        <span class="s0">`DEP_WEBPACK_DEV_SERVER_ON_AFTER_SETUP_MIDDLEWARE`</span>
      <span class="s1">)();</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">onBeforeSetupMiddleware</span><span class="s1">) {</span>
      <span class="s6">// TODO: remove in the next major release</span>
      <span class="s2">util</span><span class="s1">.</span><span class="s2">deprecate</span><span class="s1">(</span>
        <span class="s1">() =&gt; {},</span>
        <span class="s0">&quot;'onBeforeSetupMiddleware' option is deprecated. Please use the 'setupMiddlewares' option.&quot;</span><span class="s1">,</span>
        <span class="s0">`DEP_WEBPACK_DEV_SERVER_ON_BEFORE_SETUP_MIDDLEWARE`</span>
      <span class="s1">)();</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">port </span><span class="s1">=== </span><span class="s0">&quot;string&quot; </span><span class="s1">&amp;&amp; </span><span class="s2">options</span><span class="s1">.</span><span class="s2">port </span><span class="s1">!== </span><span class="s0">&quot;auto&quot;</span><span class="s1">) {</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">port </span><span class="s1">= </span><span class="s2">Number</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">port</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Assume a proxy configuration specified as:</span>
     <span class="s4">* proxy: {</span>
     <span class="s4">*   'context': { options }</span>
     <span class="s4">* }</span>
     <span class="s4">* OR</span>
     <span class="s4">* proxy: {</span>
     <span class="s4">*   'context': 'target'</span>
     <span class="s4">* }</span>
     <span class="s4">*/</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">proxy </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
      <span class="s6">// TODO remove in the next major release, only accept `Array`</span>
      <span class="s3">if </span><span class="s1">(!</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">proxy</span><span class="s1">)) {</span>
        <span class="s3">if </span><span class="s1">(</span>
          <span class="s2">Object</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">hasOwnProperty</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">proxy</span><span class="s1">, </span><span class="s0">&quot;target&quot;</span><span class="s1">) ||</span>
          <span class="s2">Object</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">hasOwnProperty</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">proxy</span><span class="s1">, </span><span class="s0">&quot;router&quot;</span><span class="s1">)</span>
        <span class="s1">) {</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ProxyConfigArray} */</span>
          <span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">proxy</span><span class="s1">) = [</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ProxyConfigMap} */ </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">proxy</span><span class="s1">)];</span>
        <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ProxyConfigArray} */</span>
          <span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">proxy</span><span class="s1">) = </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">proxy</span><span class="s1">).</span><span class="s2">map</span><span class="s1">(</span>
            <span class="s4">/**</span>
             <span class="s4">* </span><span class="s5">@param </span><span class="s4">{string} context</span>
             <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{HttpProxyMiddlewareOptions}</span>
             <span class="s4">*/</span>
            <span class="s1">(</span><span class="s2">context</span><span class="s1">) =&gt; {</span>
              <span class="s3">let </span><span class="s2">proxyOptions</span><span class="s1">;</span>
              <span class="s6">// For backwards compatibility reasons.</span>
              <span class="s3">const </span><span class="s2">correctedContext </span><span class="s1">= </span><span class="s2">context</span>
                <span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s7">/^\*$/</span><span class="s1">, </span><span class="s0">&quot;**&quot;</span><span class="s1">)</span>
                <span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s7">/\/\*$/</span><span class="s1">, </span><span class="s0">&quot;&quot;</span><span class="s1">);</span>

              <span class="s3">if </span><span class="s1">(</span>
                <span class="s3">typeof </span><span class="s1">(</span>
                  <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ProxyConfigMap} */ </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">proxy</span><span class="s1">)[</span><span class="s2">context</span><span class="s1">]</span>
                <span class="s1">) === </span><span class="s0">&quot;string&quot;</span>
              <span class="s1">) {</span>
                <span class="s2">proxyOptions </span><span class="s1">= {</span>
                  <span class="s2">context</span><span class="s1">: </span><span class="s2">correctedContext</span><span class="s1">,</span>
                  <span class="s2">target</span><span class="s1">:</span>
                    <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ProxyConfigMap} */</span>
                    <span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">proxy</span><span class="s1">)[</span><span class="s2">context</span><span class="s1">],</span>
                <span class="s1">};</span>
              <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
                <span class="s2">proxyOptions </span><span class="s1">= {</span>
                  <span class="s6">// @ts-ignore</span>
                  <span class="s2">...</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ProxyConfigMap} */ </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">proxy</span><span class="s1">)[</span><span class="s2">context</span><span class="s1">],</span>
                <span class="s1">};</span>
                <span class="s2">proxyOptions</span><span class="s1">.</span><span class="s2">context </span><span class="s1">= </span><span class="s2">correctedContext</span><span class="s1">;</span>
              <span class="s1">}</span>

              <span class="s3">return </span><span class="s2">proxyOptions</span><span class="s1">;</span>
            <span class="s1">}</span>
          <span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ProxyConfigArray} */</span>
      <span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">proxy</span><span class="s1">) =</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ProxyConfigArray} */</span>
        <span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">proxy</span><span class="s1">).</span><span class="s2">map</span><span class="s1">((</span><span class="s2">item</span><span class="s1">) =&gt; {</span>
          <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">item </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s2">item</span><span class="s1">;</span>
          <span class="s1">}</span>

          <span class="s4">/**</span>
           <span class="s4">* </span><span class="s5">@param </span><span class="s4">{&quot;info&quot; | &quot;warn&quot; | &quot;error&quot; | &quot;debug&quot; | &quot;silent&quot; | undefined | &quot;none&quot; | &quot;log&quot; | &quot;verbose&quot;} level</span>
           <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{&quot;info&quot; | &quot;warn&quot; | &quot;error&quot; | &quot;debug&quot; | &quot;silent&quot; | undefined}</span>
           <span class="s4">*/</span>
          <span class="s3">const </span><span class="s2">getLogLevelForProxy </span><span class="s1">= (</span><span class="s2">level</span><span class="s1">) =&gt; {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">level </span><span class="s1">=== </span><span class="s0">&quot;none&quot;</span><span class="s1">) {</span>
              <span class="s3">return </span><span class="s0">&quot;silent&quot;</span><span class="s1">;</span>
            <span class="s1">}</span>

            <span class="s3">if </span><span class="s1">(</span><span class="s2">level </span><span class="s1">=== </span><span class="s0">&quot;log&quot;</span><span class="s1">) {</span>
              <span class="s3">return </span><span class="s0">&quot;info&quot;</span><span class="s1">;</span>
            <span class="s1">}</span>

            <span class="s3">if </span><span class="s1">(</span><span class="s2">level </span><span class="s1">=== </span><span class="s0">&quot;verbose&quot;</span><span class="s1">) {</span>
              <span class="s3">return </span><span class="s0">&quot;debug&quot;</span><span class="s1">;</span>
            <span class="s1">}</span>

            <span class="s3">return </span><span class="s2">level</span><span class="s1">;</span>
          <span class="s1">};</span>

          <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">item</span><span class="s1">.</span><span class="s2">logLevel </span><span class="s1">=== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
            <span class="s2">item</span><span class="s1">.</span><span class="s2">logLevel </span><span class="s1">= </span><span class="s2">getLogLevelForProxy</span><span class="s1">(</span>
              <span class="s2">compilerOptions</span><span class="s1">.</span><span class="s2">infrastructureLogging</span>
                <span class="s1">? </span><span class="s2">compilerOptions</span><span class="s1">.</span><span class="s2">infrastructureLogging</span><span class="s1">.</span><span class="s2">level</span>
                <span class="s1">: </span><span class="s0">&quot;info&quot;</span>
            <span class="s1">);</span>
          <span class="s1">}</span>

          <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">item</span><span class="s1">.</span><span class="s2">logProvider </span><span class="s1">=== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
            <span class="s2">item</span><span class="s1">.</span><span class="s2">logProvider </span><span class="s1">= () =&gt; </span><span class="s3">this</span><span class="s1">.</span><span class="s2">logger</span><span class="s1">;</span>
          <span class="s1">}</span>

          <span class="s3">return </span><span class="s2">item</span><span class="s1">;</span>
        <span class="s1">});</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">setupExitSignals </span><span class="s1">=== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">setupExitSignals </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">static </span><span class="s1">=== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">static </span><span class="s1">= [</span><span class="s2">getStaticItem</span><span class="s1">()];</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">static </span><span class="s1">=== </span><span class="s0">&quot;boolean&quot;</span><span class="s1">) {</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">static </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">static </span><span class="s1">? [</span><span class="s2">getStaticItem</span><span class="s1">()] : </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">static </span><span class="s1">=== </span><span class="s0">&quot;string&quot;</span><span class="s1">) {</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">static </span><span class="s1">= [</span><span class="s2">getStaticItem</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">static</span><span class="s1">)];</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">static</span><span class="s1">)) {</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">static </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">static</span><span class="s1">.</span><span class="s2">map</span><span class="s1">((</span><span class="s2">item</span><span class="s1">) =&gt; </span><span class="s2">getStaticItem</span><span class="s1">(</span><span class="s2">item</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">static </span><span class="s1">= [</span><span class="s2">getStaticItem</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">static</span><span class="s1">)];</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">watchFiles </span><span class="s1">=== </span><span class="s0">&quot;string&quot;</span><span class="s1">) {</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">watchFiles </span><span class="s1">= [</span>
        <span class="s1">{ </span><span class="s2">paths</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">watchFiles</span><span class="s1">, </span><span class="s2">options</span><span class="s1">: </span><span class="s2">getWatchOptions</span><span class="s1">() },</span>
      <span class="s1">];</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span>
      <span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">watchFiles </span><span class="s1">=== </span><span class="s0">&quot;object&quot; </span><span class="s1">&amp;&amp;</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">watchFiles </span><span class="s1">!== </span><span class="s3">null </span><span class="s1">&amp;&amp;</span>
      <span class="s1">!</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">watchFiles</span><span class="s1">)</span>
    <span class="s1">) {</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">watchFiles </span><span class="s1">= [</span>
        <span class="s1">{</span>
          <span class="s2">paths</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">watchFiles</span><span class="s1">.</span><span class="s2">paths</span><span class="s1">,</span>
          <span class="s2">options</span><span class="s1">: </span><span class="s2">getWatchOptions</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">watchFiles</span><span class="s1">.</span><span class="s2">options </span><span class="s1">|| {}),</span>
        <span class="s1">},</span>
      <span class="s1">];</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">watchFiles</span><span class="s1">)) {</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">watchFiles </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">watchFiles</span><span class="s1">.</span><span class="s2">map</span><span class="s1">((</span><span class="s2">item</span><span class="s1">) =&gt; {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">item </span><span class="s1">=== </span><span class="s0">&quot;string&quot;</span><span class="s1">) {</span>
          <span class="s3">return </span><span class="s1">{ </span><span class="s2">paths</span><span class="s1">: </span><span class="s2">item</span><span class="s1">, </span><span class="s2">options</span><span class="s1">: </span><span class="s2">getWatchOptions</span><span class="s1">() };</span>
        <span class="s1">}</span>

        <span class="s3">return </span><span class="s1">{</span>
          <span class="s2">paths</span><span class="s1">: </span><span class="s2">item</span><span class="s1">.</span><span class="s2">paths</span><span class="s1">,</span>
          <span class="s2">options</span><span class="s1">: </span><span class="s2">getWatchOptions</span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">options </span><span class="s1">|| {}),</span>
        <span class="s1">};</span>
      <span class="s1">});</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">watchFiles </span><span class="s1">= [];</span>
    <span class="s1">}</span>

    <span class="s3">const </span><span class="s2">defaultWebSocketServerType </span><span class="s1">= </span><span class="s0">&quot;ws&quot;</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">defaultWebSocketServerOptions </span><span class="s1">= { </span><span class="s2">path</span><span class="s1">: </span><span class="s0">&quot;/ws&quot; </span><span class="s1">};</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">webSocketServer </span><span class="s1">=== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">webSocketServer </span><span class="s1">= {</span>
        <span class="s2">type</span><span class="s1">: </span><span class="s2">defaultWebSocketServerType</span><span class="s1">,</span>
        <span class="s2">options</span><span class="s1">: </span><span class="s2">defaultWebSocketServerOptions</span><span class="s1">,</span>
      <span class="s1">};</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span>
      <span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">webSocketServer </span><span class="s1">=== </span><span class="s0">&quot;boolean&quot; </span><span class="s1">&amp;&amp;</span>
      <span class="s1">!</span><span class="s2">options</span><span class="s1">.</span><span class="s2">webSocketServer</span>
    <span class="s1">) {</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">webSocketServer </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span>
      <span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">webSocketServer </span><span class="s1">=== </span><span class="s0">&quot;string&quot; </span><span class="s1">||</span>
      <span class="s3">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">webSocketServer </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span>
    <span class="s1">) {</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">webSocketServer </span><span class="s1">= {</span>
        <span class="s2">type</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">webSocketServer</span><span class="s1">,</span>
        <span class="s2">options</span><span class="s1">: </span><span class="s2">defaultWebSocketServerOptions</span><span class="s1">,</span>
      <span class="s1">};</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">webSocketServer </span><span class="s1">= {</span>
        <span class="s2">type</span><span class="s1">:</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{WebSocketServerConfiguration} */</span>
          <span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">webSocketServer</span><span class="s1">).</span><span class="s2">type </span><span class="s1">|| </span><span class="s2">defaultWebSocketServerType</span><span class="s1">,</span>
        <span class="s2">options</span><span class="s1">: {</span>
          <span class="s2">...defaultWebSocketServerOptions</span><span class="s1">,</span>
          <span class="s2">...</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{WebSocketServerConfiguration} */</span>
          <span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">webSocketServer</span><span class="s1">).</span><span class="s2">options</span><span class="s1">,</span>
        <span class="s1">},</span>
      <span class="s1">};</span>

      <span class="s3">const </span><span class="s2">webSocketServer </span><span class="s1">=</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{{ type: WebSocketServerConfiguration[&quot;type&quot;], options: NonNullable&lt;WebSocketServerConfiguration[&quot;options&quot;]&gt; }} */</span>
        <span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">webSocketServer</span><span class="s1">);</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">webSocketServer</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">port </span><span class="s1">=== </span><span class="s0">&quot;string&quot;</span><span class="s1">) {</span>
        <span class="s2">webSocketServer</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">port </span><span class="s1">= </span><span class="s2">Number</span><span class="s1">(</span><span class="s2">webSocketServer</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">port</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{string}</span>
   <span class="s4">*/</span>
  <span class="s2">getClientTransport</span><span class="s1">() {</span>
    <span class="s3">let </span><span class="s2">clientImplementation</span><span class="s1">;</span>
    <span class="s3">let </span><span class="s2">clientImplementationFound </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>

    <span class="s3">const </span><span class="s2">isKnownWebSocketServerImplementation </span><span class="s1">=</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">webSocketServer </span><span class="s1">&amp;&amp;</span>
      <span class="s3">typeof </span><span class="s1">(</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{WebSocketServerConfiguration} */</span>
        <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">webSocketServer</span><span class="s1">).</span><span class="s2">type</span>
      <span class="s1">) === </span><span class="s0">&quot;string&quot; </span><span class="s1">&amp;&amp;</span>
      <span class="s6">// @ts-ignore</span>
      <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">webSocketServer</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">&quot;ws&quot; </span><span class="s1">||</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{WebSocketServerConfiguration} */</span>
        <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">webSocketServer</span><span class="s1">).</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">&quot;sockjs&quot;</span><span class="s1">);</span>

    <span class="s3">let </span><span class="s2">clientTransport</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span>
        <span class="s3">typeof </span><span class="s1">(</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ClientConfiguration} */</span>
          <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">).</span><span class="s2">webSocketTransport</span>
        <span class="s1">) !== </span><span class="s0">&quot;undefined&quot;</span>
      <span class="s1">) {</span>
        <span class="s2">clientTransport </span><span class="s1">=</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ClientConfiguration} */</span>
          <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">).</span><span class="s2">webSocketTransport</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">isKnownWebSocketServerImplementation</span><span class="s1">) {</span>
        <span class="s2">clientTransport </span><span class="s1">=</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{WebSocketServerConfiguration} */</span>
          <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">webSocketServer</span><span class="s1">).</span><span class="s2">type</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s2">clientTransport </span><span class="s1">= </span><span class="s0">&quot;ws&quot;</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s2">clientTransport </span><span class="s1">= </span><span class="s0">&quot;ws&quot;</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">switch </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">clientTransport</span><span class="s1">) {</span>
      <span class="s3">case </span><span class="s0">&quot;string&quot;</span><span class="s1">:</span>
        <span class="s6">// could be 'sockjs', 'ws', or a path that should be required</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">clientTransport </span><span class="s1">=== </span><span class="s0">&quot;sockjs&quot;</span><span class="s1">) {</span>
          <span class="s2">clientImplementation </span><span class="s1">= </span><span class="s2">require</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">(</span>
            <span class="s0">&quot;../client/clients/SockJSClient&quot;</span>
          <span class="s1">);</span>
        <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">clientTransport </span><span class="s1">=== </span><span class="s0">&quot;ws&quot;</span><span class="s1">) {</span>
          <span class="s2">clientImplementation </span><span class="s1">= </span><span class="s2">require</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">(</span>
            <span class="s0">&quot;../client/clients/WebSocketClient&quot;</span>
          <span class="s1">);</span>
        <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
          <span class="s3">try </span><span class="s1">{</span>
            <span class="s2">clientImplementation </span><span class="s1">= </span><span class="s2">require</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">(</span><span class="s2">clientTransport</span><span class="s1">);</span>
          <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">e</span><span class="s1">) {</span>
            <span class="s2">clientImplementationFound </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
          <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s3">break</span><span class="s1">;</span>
      <span class="s3">default</span><span class="s1">:</span>
        <span class="s2">clientImplementationFound </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(!</span><span class="s2">clientImplementationFound</span><span class="s1">) {</span>
      <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span>
        <span class="s0">`</span><span class="s2">$</span><span class="s1">{</span>
          <span class="s1">!</span><span class="s2">isKnownWebSocketServerImplementation</span>
            <span class="s1">? </span><span class="s0">&quot;When you use custom web socket implementation you must explicitly specify client.webSocketTransport. &quot;</span>
            <span class="s1">: </span><span class="s0">&quot;&quot;</span>
        <span class="s1">}</span><span class="s0">client.webSocketTransport must be a string denoting a default implementation (e.g. 'sockjs', 'ws') or a full path to a JS file via require.resolve(...) which exports a class `</span>
      <span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{string} */ </span><span class="s1">(</span><span class="s2">clientImplementation</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{string}</span>
   <span class="s4">*/</span>
  <span class="s2">getServerTransport</span><span class="s1">() {</span>
    <span class="s3">let </span><span class="s2">implementation</span><span class="s1">;</span>
    <span class="s3">let </span><span class="s2">implementationFound </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>

    <span class="s3">switch </span><span class="s1">(</span>
      <span class="s3">typeof </span><span class="s1">(</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{WebSocketServerConfiguration} */</span>
        <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">webSocketServer</span><span class="s1">).</span><span class="s2">type</span>
      <span class="s1">)</span>
    <span class="s1">) {</span>
      <span class="s3">case </span><span class="s0">&quot;string&quot;</span><span class="s1">:</span>
        <span class="s6">// Could be 'sockjs', in the future 'ws', or a path that should be required</span>
        <span class="s3">if </span><span class="s1">(</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{WebSocketServerConfiguration} */ </span><span class="s1">(</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">webSocketServer</span>
          <span class="s1">).</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">&quot;sockjs&quot;</span>
        <span class="s1">) {</span>
          <span class="s2">implementation </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;./servers/SockJSServer&quot;</span><span class="s1">);</span>
        <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{WebSocketServerConfiguration} */ </span><span class="s1">(</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">webSocketServer</span>
          <span class="s1">).</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">&quot;ws&quot;</span>
        <span class="s1">) {</span>
          <span class="s2">implementation </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;./servers/WebsocketServer&quot;</span><span class="s1">);</span>
        <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
          <span class="s3">try </span><span class="s1">{</span>
            <span class="s6">// eslint-disable-next-line import/no-dynamic-require</span>
            <span class="s2">implementation </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{WebSocketServerConfiguration} */ </span><span class="s1">(</span>
              <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">webSocketServer</span>
            <span class="s1">).</span><span class="s2">type</span><span class="s1">);</span>
          <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) {</span>
            <span class="s2">implementationFound </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
          <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s3">break</span><span class="s1">;</span>
      <span class="s3">case </span><span class="s0">&quot;function&quot;</span><span class="s1">:</span>
        <span class="s2">implementation </span><span class="s1">= </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{WebSocketServerConfiguration} */ </span><span class="s1">(</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">webSocketServer</span>
        <span class="s1">).</span><span class="s2">type</span><span class="s1">;</span>
        <span class="s3">break</span><span class="s1">;</span>
      <span class="s3">default</span><span class="s1">:</span>
        <span class="s2">implementationFound </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(!</span><span class="s2">implementationFound</span><span class="s1">) {</span>
      <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span>
        <span class="s0">&quot;webSocketServer (webSocketServer.type) must be a string denoting a default implementation (e.g. 'ws', 'sockjs'), a full path to &quot; </span><span class="s1">+</span>
          <span class="s0">&quot;a JS file which exports a class extending BaseServer (webpack-dev-server/lib/servers/BaseServer.js) &quot; </span><span class="s1">+</span>
          <span class="s0">&quot;via require.resolve(...), or the class itself which extends BaseServer&quot;</span>
      <span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s2">implementation</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{void}</span>
   <span class="s4">*/</span>
  <span class="s2">setupProgressPlugin</span><span class="s1">() {</span>
    <span class="s3">const </span><span class="s1">{ </span><span class="s2">ProgressPlugin </span><span class="s1">} =</span>
      <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{MultiCompiler}*/</span>
      <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">compiler</span><span class="s1">).</span><span class="s2">compilers</span>
        <span class="s1">? </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{MultiCompiler}*/ </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">compiler</span><span class="s1">).</span><span class="s2">compilers</span><span class="s1">[</span><span class="s8">0</span><span class="s1">].</span><span class="s2">webpack</span>
        <span class="s1">: </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{Compiler}*/ </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">compiler</span><span class="s1">).</span><span class="s2">webpack </span><span class="s1">||</span>
          <span class="s6">// TODO remove me after drop webpack v4</span>
          <span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;webpack&quot;</span><span class="s1">);</span>

    <span class="s3">new </span><span class="s2">ProgressPlugin</span><span class="s1">(</span>
      <span class="s4">/**</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{number} percent</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{string} msg</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{string} addInfo</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{string} pluginName</span>
       <span class="s4">*/</span>
      <span class="s1">(</span><span class="s2">percent</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">, </span><span class="s2">addInfo</span><span class="s1">, </span><span class="s2">pluginName</span><span class="s1">) =&gt; {</span>
        <span class="s2">percent </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">floor</span><span class="s1">(</span><span class="s2">percent </span><span class="s1">* </span><span class="s8">100</span><span class="s1">);</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">percent </span><span class="s1">=== </span><span class="s8">100</span><span class="s1">) {</span>
          <span class="s2">msg </span><span class="s1">= </span><span class="s0">&quot;Compilation completed&quot;</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">addInfo</span><span class="s1">) {</span>
          <span class="s2">msg </span><span class="s1">= </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">msg</span><span class="s1">} </span><span class="s0">(</span><span class="s2">$</span><span class="s1">{</span><span class="s2">addInfo</span><span class="s1">}</span><span class="s0">)`</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">webSocketServer</span><span class="s1">) {</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">sendMessage</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">webSocketServer</span><span class="s1">.</span><span class="s2">clients</span><span class="s1">, </span><span class="s0">&quot;progress-update&quot;</span><span class="s1">, {</span>
            <span class="s2">percent</span><span class="s1">,</span>
            <span class="s2">msg</span><span class="s1">,</span>
            <span class="s2">pluginName</span><span class="s1">,</span>
          <span class="s1">});</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">server</span><span class="s1">) {</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">server</span><span class="s1">.</span><span class="s2">emit</span><span class="s1">(</span><span class="s0">&quot;progress-update&quot;</span><span class="s1">, { </span><span class="s2">percent</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">, </span><span class="s2">pluginName </span><span class="s1">});</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">).</span><span class="s2">apply</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">compiler</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{Promise&lt;void&gt;}</span>
   <span class="s4">*/</span>
  <span class="s2">async initialize</span><span class="s1">() {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">webSocketServer</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">compilers </span><span class="s1">=</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{MultiCompiler} */</span>
        <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">compiler</span><span class="s1">).</span><span class="s2">compilers </span><span class="s1">|| [</span><span class="s3">this</span><span class="s1">.</span><span class="s2">compiler</span><span class="s1">];</span>

      <span class="s2">compilers</span><span class="s1">.</span><span class="s2">forEach</span><span class="s1">((</span><span class="s2">compiler</span><span class="s1">) =&gt; {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">addAdditionalEntries</span><span class="s1">(</span><span class="s2">compiler</span><span class="s1">);</span>

        <span class="s3">const </span><span class="s2">webpack </span><span class="s1">= </span><span class="s2">compiler</span><span class="s1">.</span><span class="s2">webpack </span><span class="s1">|| </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;webpack&quot;</span><span class="s1">);</span>

        <span class="s3">new </span><span class="s2">webpack</span><span class="s1">.</span><span class="s2">ProvidePlugin</span><span class="s1">({</span>
          <span class="s2">__webpack_dev_server_client__</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getClientTransport</span><span class="s1">(),</span>
        <span class="s1">}).</span><span class="s2">apply</span><span class="s1">(</span><span class="s2">compiler</span><span class="s1">);</span>

        <span class="s6">// TODO remove after drop webpack v4 support</span>
        <span class="s2">compiler</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">plugins </span><span class="s1">= </span><span class="s2">compiler</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">plugins </span><span class="s1">|| [];</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">hot</span><span class="s1">) {</span>
          <span class="s3">const </span><span class="s2">HMRPluginExists </span><span class="s1">= </span><span class="s2">compiler</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">plugins</span><span class="s1">.</span><span class="s2">find</span><span class="s1">(</span>
            <span class="s1">(</span><span class="s2">p</span><span class="s1">) =&gt; </span><span class="s2">p</span><span class="s1">.</span><span class="s2">constructor </span><span class="s1">=== </span><span class="s2">webpack</span><span class="s1">.</span><span class="s2">HotModuleReplacementPlugin</span>
          <span class="s1">);</span>

          <span class="s3">if </span><span class="s1">(</span><span class="s2">HMRPluginExists</span><span class="s1">) {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">logger</span><span class="s1">.</span><span class="s2">warn</span><span class="s1">(</span>
              <span class="s0">`&quot;hot: true&quot; automatically applies HMR plugin, you don't have to add it manually to your webpack configuration.`</span>
            <span class="s1">);</span>
          <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
            <span class="s6">// Apply the HMR plugin</span>
            <span class="s3">const </span><span class="s2">plugin </span><span class="s1">= </span><span class="s3">new </span><span class="s2">webpack</span><span class="s1">.</span><span class="s2">HotModuleReplacementPlugin</span><span class="s1">();</span>

            <span class="s2">plugin</span><span class="s1">.</span><span class="s2">apply</span><span class="s1">(</span><span class="s2">compiler</span><span class="s1">);</span>
          <span class="s1">}</span>
        <span class="s1">}</span>
      <span class="s1">});</span>

      <span class="s3">if </span><span class="s1">(</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">client </span><span class="s1">&amp;&amp;</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ClientConfiguration} */ </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">).</span><span class="s2">progress</span>
      <span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">setupProgressPlugin</span><span class="s1">();</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">setupHooks</span><span class="s1">();</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">setupApp</span><span class="s1">();</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">setupHostHeaderCheck</span><span class="s1">();</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">setupDevMiddleware</span><span class="s1">();</span>
    <span class="s6">// Should be after `webpack-dev-middleware`, otherwise other middlewares might rewrite response</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">setupBuiltInRoutes</span><span class="s1">();</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">setupWatchFiles</span><span class="s1">();</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">setupWatchStaticFiles</span><span class="s1">();</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">setupMiddlewares</span><span class="s1">();</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">createServer</span><span class="s1">();</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">setupExitSignals</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">signals </span><span class="s1">= [</span><span class="s0">&quot;SIGINT&quot;</span><span class="s1">, </span><span class="s0">&quot;SIGTERM&quot;</span><span class="s1">];</span>

      <span class="s3">let </span><span class="s2">needForceShutdown </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>

      <span class="s2">signals</span><span class="s1">.</span><span class="s2">forEach</span><span class="s1">((</span><span class="s2">signal</span><span class="s1">) =&gt; {</span>
        <span class="s3">const </span><span class="s2">listener </span><span class="s1">= () =&gt; {</span>
          <span class="s3">if </span><span class="s1">(</span><span class="s2">needForceShutdown</span><span class="s1">) {</span>
            <span class="s2">process</span><span class="s1">.</span><span class="s2">exit</span><span class="s1">();</span>
          <span class="s1">}</span>

          <span class="s3">this</span><span class="s1">.</span><span class="s2">logger</span><span class="s1">.</span><span class="s2">info</span><span class="s1">(</span>
            <span class="s0">&quot;Gracefully shutting down. To force exit, press ^C again. Please wait...&quot;</span>
          <span class="s1">);</span>

          <span class="s2">needForceShutdown </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>

          <span class="s3">this</span><span class="s1">.</span><span class="s2">stopCallback</span><span class="s1">(() =&gt; {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof this</span><span class="s1">.</span><span class="s2">compiler</span><span class="s1">.</span><span class="s2">close </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span><span class="s1">) {</span>
              <span class="s3">this</span><span class="s1">.</span><span class="s2">compiler</span><span class="s1">.</span><span class="s2">close</span><span class="s1">(() =&gt; {</span>
                <span class="s2">process</span><span class="s1">.</span><span class="s2">exit</span><span class="s1">();</span>
              <span class="s1">});</span>
            <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
              <span class="s2">process</span><span class="s1">.</span><span class="s2">exit</span><span class="s1">();</span>
            <span class="s1">}</span>
          <span class="s1">});</span>
        <span class="s1">};</span>

        <span class="s3">this</span><span class="s1">.</span><span class="s2">listeners</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({ </span><span class="s2">name</span><span class="s1">: </span><span class="s2">signal</span><span class="s1">, </span><span class="s2">listener </span><span class="s1">});</span>

        <span class="s2">process</span><span class="s1">.</span><span class="s2">on</span><span class="s1">(</span><span class="s2">signal</span><span class="s1">, </span><span class="s2">listener</span><span class="s1">);</span>
      <span class="s1">});</span>
    <span class="s1">}</span>

    <span class="s6">// Proxy WebSocket without the initial http request</span>
    <span class="s6">// https://github.com/chimurai/http-proxy-middleware#external-websocket-upgrade</span>
    <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{RequestHandler[]} */</span>
    <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">webSocketProxies</span><span class="s1">).</span><span class="s2">forEach</span><span class="s1">((</span><span class="s2">webSocketProxy</span><span class="s1">) =&gt; {</span>
      <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;http&quot;).Server} */</span>
      <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">server</span><span class="s1">).</span><span class="s2">on</span><span class="s1">(</span>
        <span class="s0">&quot;upgrade&quot;</span><span class="s1">,</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{RequestHandler &amp; { upgrade: NonNullable&lt;RequestHandler[&quot;upgrade&quot;]&gt; }} */</span>
        <span class="s1">(</span><span class="s2">webSocketProxy</span><span class="s1">).</span><span class="s2">upgrade</span>
      <span class="s1">);</span>
    <span class="s1">}, </span><span class="s3">this</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{void}</span>
   <span class="s4">*/</span>
  <span class="s2">setupApp</span><span class="s1">() {</span>
    <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;express&quot;).Application | undefined}*/</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">app </span><span class="s1">= </span><span class="s3">new </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{any} */ </span><span class="s1">(</span><span class="s2">getExpress</span><span class="s1">())();</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Stats | MultiStats} statsObj</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{StatsCompilation}</span>
   <span class="s4">*/</span>
  <span class="s2">getStats</span><span class="s1">(</span><span class="s2">statsObj</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">stats </span><span class="s1">= </span><span class="s2">Server</span><span class="s1">.</span><span class="s2">DEFAULT_STATS</span><span class="s1">;</span>
    <span class="s3">const </span><span class="s2">compilerOptions </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCompilerOptions</span><span class="s1">();</span>

    <span class="s6">// @ts-ignore</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">compilerOptions</span><span class="s1">.</span><span class="s2">stats </span><span class="s1">&amp;&amp; </span><span class="s2">compilerOptions</span><span class="s1">.</span><span class="s2">stats</span><span class="s1">.</span><span class="s2">warningsFilter</span><span class="s1">) {</span>
      <span class="s6">// @ts-ignore</span>
      <span class="s2">stats</span><span class="s1">.</span><span class="s2">warningsFilter </span><span class="s1">= </span><span class="s2">compilerOptions</span><span class="s1">.</span><span class="s2">stats</span><span class="s1">.</span><span class="s2">warningsFilter</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s2">statsObj</span><span class="s1">.</span><span class="s2">toJson</span><span class="s1">(</span><span class="s2">stats</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{void}</span>
   <span class="s4">*/</span>
  <span class="s2">setupHooks</span><span class="s1">() {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">compiler</span><span class="s1">.</span><span class="s2">hooks</span><span class="s1">.</span><span class="s2">invalid</span><span class="s1">.</span><span class="s2">tap</span><span class="s1">(</span><span class="s0">&quot;webpack-dev-server&quot;</span><span class="s1">, () =&gt; {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">webSocketServer</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">sendMessage</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">webSocketServer</span><span class="s1">.</span><span class="s2">clients</span><span class="s1">, </span><span class="s0">&quot;invalid&quot;</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">});</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">compiler</span><span class="s1">.</span><span class="s2">hooks</span><span class="s1">.</span><span class="s2">done</span><span class="s1">.</span><span class="s2">tap</span><span class="s1">(</span>
      <span class="s0">&quot;webpack-dev-server&quot;</span><span class="s1">,</span>
      <span class="s4">/**</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Stats | MultiStats} stats</span>
       <span class="s4">*/</span>
      <span class="s1">(</span><span class="s2">stats</span><span class="s1">) =&gt; {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">webSocketServer</span><span class="s1">) {</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">sendStats</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">webSocketServer</span><span class="s1">.</span><span class="s2">clients</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getStats</span><span class="s1">(</span><span class="s2">stats</span><span class="s1">));</span>
        <span class="s1">}</span>

        <span class="s4">/**</span>
         <span class="s4">* </span><span class="s5">@private</span>
         <span class="s4">* </span><span class="s5">@type </span><span class="s4">{Stats | MultiStats}</span>
         <span class="s4">*/</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">stats </span><span class="s1">= </span><span class="s2">stats</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{void}</span>
   <span class="s4">*/</span>
  <span class="s2">setupHostHeaderCheck</span><span class="s1">() {</span>
    <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;express&quot;).Application} */</span>
    <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">app</span><span class="s1">).</span><span class="s2">all</span><span class="s1">(</span>
      <span class="s0">&quot;*&quot;</span><span class="s1">,</span>
      <span class="s4">/**</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Request} req</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Response} res</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{NextFunction} next</span>
       <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{void}</span>
       <span class="s4">*/</span>
      <span class="s1">(</span><span class="s2">req</span><span class="s1">, </span><span class="s2">res</span><span class="s1">, </span><span class="s2">next</span><span class="s1">) =&gt; {</span>
        <span class="s3">if </span><span class="s1">(</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">checkHeader</span><span class="s1">(</span>
            <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{{ [key: string]: string | undefined }} */</span>
            <span class="s1">(</span><span class="s2">req</span><span class="s1">.</span><span class="s2">headers</span><span class="s1">),</span>
            <span class="s0">&quot;host&quot;</span>
          <span class="s1">)</span>
        <span class="s1">) {</span>
          <span class="s3">return </span><span class="s2">next</span><span class="s1">();</span>
        <span class="s1">}</span>

        <span class="s2">res</span><span class="s1">.</span><span class="s2">send</span><span class="s1">(</span><span class="s0">&quot;Invalid Host header&quot;</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{void}</span>
   <span class="s4">*/</span>
  <span class="s2">setupDevMiddleware</span><span class="s1">() {</span>
    <span class="s3">const </span><span class="s2">webpackDevMiddleware </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;webpack-dev-middleware&quot;</span><span class="s1">);</span>

    <span class="s6">// middleware for serving webpack bundle</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">middleware </span><span class="s1">= </span><span class="s2">webpackDevMiddleware</span><span class="s1">(</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">compiler</span><span class="s1">,</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">devMiddleware</span>
    <span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{void}</span>
   <span class="s4">*/</span>
  <span class="s2">setupBuiltInRoutes</span><span class="s1">() {</span>
    <span class="s3">const </span><span class="s1">{ </span><span class="s2">app</span><span class="s1">, </span><span class="s2">middleware </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">;</span>

    <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;express&quot;).Application} */</span>
    <span class="s1">(</span><span class="s2">app</span><span class="s1">).</span><span class="s2">get</span><span class="s1">(</span>
      <span class="s0">&quot;/__webpack_dev_server__/sockjs.bundle.js&quot;</span><span class="s1">,</span>
      <span class="s4">/**</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Request} req</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Response} res</span>
       <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{void}</span>
       <span class="s4">*/</span>
      <span class="s1">(</span><span class="s2">req</span><span class="s1">, </span><span class="s2">res</span><span class="s1">) =&gt; {</span>
        <span class="s2">res</span><span class="s1">.</span><span class="s2">setHeader</span><span class="s1">(</span><span class="s0">&quot;Content-Type&quot;</span><span class="s1">, </span><span class="s0">&quot;application/javascript&quot;</span><span class="s1">);</span>

        <span class="s3">const </span><span class="s2">clientPath </span><span class="s1">= </span><span class="s2">path</span><span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s2">__dirname</span><span class="s1">, </span><span class="s0">&quot;..&quot;</span><span class="s1">, </span><span class="s0">&quot;client&quot;</span><span class="s1">);</span>

        <span class="s2">res</span><span class="s1">.</span><span class="s2">sendFile</span><span class="s1">(</span><span class="s2">path</span><span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s2">clientPath</span><span class="s1">, </span><span class="s0">&quot;modules/sockjs-client/index.js&quot;</span><span class="s1">));</span>
      <span class="s1">}</span>
    <span class="s1">);</span>

    <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;express&quot;).Application} */</span>
    <span class="s1">(</span><span class="s2">app</span><span class="s1">).</span><span class="s2">get</span><span class="s1">(</span>
      <span class="s0">&quot;/webpack-dev-server/invalidate&quot;</span><span class="s1">,</span>
      <span class="s4">/**</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Request} _req</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Response} res</span>
       <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{void}</span>
       <span class="s4">*/</span>
      <span class="s1">(</span><span class="s2">_req</span><span class="s1">, </span><span class="s2">res</span><span class="s1">) =&gt; {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">invalidate</span><span class="s1">();</span>

        <span class="s2">res</span><span class="s1">.</span><span class="s2">end</span><span class="s1">();</span>
      <span class="s1">}</span>
    <span class="s1">);</span>

    <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;express&quot;).Application} */</span>
    <span class="s1">(</span><span class="s2">app</span><span class="s1">).</span><span class="s2">get</span><span class="s1">(</span><span class="s0">&quot;/webpack-dev-server/open-editor&quot;</span><span class="s1">, (</span><span class="s2">req</span><span class="s1">, </span><span class="s2">res</span><span class="s1">) =&gt; {</span>
      <span class="s3">const </span><span class="s2">fileName </span><span class="s1">= </span><span class="s2">req</span><span class="s1">.</span><span class="s2">query</span><span class="s1">.</span><span class="s2">fileName</span><span class="s1">;</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">fileName </span><span class="s1">=== </span><span class="s0">&quot;string&quot;</span><span class="s1">) {</span>
        <span class="s6">// @ts-ignore</span>
        <span class="s3">const </span><span class="s2">launchEditor </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;launch-editor&quot;</span><span class="s1">);</span>
        <span class="s2">launchEditor</span><span class="s1">(</span><span class="s2">fileName</span><span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s2">res</span><span class="s1">.</span><span class="s2">end</span><span class="s1">();</span>
    <span class="s1">});</span>

    <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;express&quot;).Application} */</span>
    <span class="s1">(</span><span class="s2">app</span><span class="s1">).</span><span class="s2">get</span><span class="s1">(</span>
      <span class="s0">&quot;/webpack-dev-server&quot;</span><span class="s1">,</span>
      <span class="s4">/**</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Request} req</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Response} res</span>
       <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{void}</span>
       <span class="s4">*/</span>
      <span class="s1">(</span><span class="s2">req</span><span class="s1">, </span><span class="s2">res</span><span class="s1">) =&gt; {</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;webpack-dev-middleware&quot;).API&lt;Request, Response&gt;}*/</span>
        <span class="s1">(</span><span class="s2">middleware</span><span class="s1">).</span><span class="s2">waitUntilValid</span><span class="s1">((</span><span class="s2">stats</span><span class="s1">) =&gt; {</span>
          <span class="s2">res</span><span class="s1">.</span><span class="s2">setHeader</span><span class="s1">(</span><span class="s0">&quot;Content-Type&quot;</span><span class="s1">, </span><span class="s0">&quot;text/html&quot;</span><span class="s1">);</span>
          <span class="s2">res</span><span class="s1">.</span><span class="s2">write</span><span class="s1">(</span>
            <span class="s0">'&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset=&quot;utf-8&quot;/&gt;&lt;/head&gt;&lt;body&gt;'</span>
          <span class="s1">);</span>

          <span class="s3">const </span><span class="s2">statsForPrint </span><span class="s1">=</span>
            <span class="s3">typeof </span><span class="s1">(</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{MultiStats} */ </span><span class="s1">(</span><span class="s2">stats</span><span class="s1">).</span><span class="s2">stats</span><span class="s1">) !== </span><span class="s0">&quot;undefined&quot;</span>
              <span class="s1">? </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{MultiStats} */ </span><span class="s1">(</span><span class="s2">stats</span><span class="s1">).</span><span class="s2">toJson</span><span class="s1">().</span><span class="s2">children</span>
              <span class="s1">: [</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{Stats} */ </span><span class="s1">(</span><span class="s2">stats</span><span class="s1">).</span><span class="s2">toJson</span><span class="s1">()];</span>

          <span class="s2">res</span><span class="s1">.</span><span class="s2">write</span><span class="s1">(</span><span class="s0">`&lt;h1&gt;Assets Report:&lt;/h1&gt;`</span><span class="s1">);</span>

          <span class="s4">/**</span>
           <span class="s4">* </span><span class="s5">@type </span><span class="s4">{StatsCompilation[]}</span>
           <span class="s4">*/</span>
          <span class="s1">(</span><span class="s2">statsForPrint</span><span class="s1">).</span><span class="s2">forEach</span><span class="s1">((</span><span class="s2">item</span><span class="s1">, </span><span class="s2">index</span><span class="s1">) =&gt; {</span>
            <span class="s2">res</span><span class="s1">.</span><span class="s2">write</span><span class="s1">(</span><span class="s0">&quot;&lt;div&gt;&quot;</span><span class="s1">);</span>

            <span class="s3">const </span><span class="s2">name </span><span class="s1">=</span>
              <span class="s6">// eslint-disable-next-line no-nested-ternary</span>
              <span class="s3">typeof </span><span class="s2">item</span><span class="s1">.</span><span class="s2">name </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span>
                <span class="s1">? </span><span class="s2">item</span><span class="s1">.</span><span class="s2">name</span>
                <span class="s1">: </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{MultiStats} */ </span><span class="s1">(</span><span class="s2">stats</span><span class="s1">).</span><span class="s2">stats</span>
                <span class="s1">? </span><span class="s0">`unnamed[</span><span class="s2">$</span><span class="s1">{</span><span class="s2">index</span><span class="s1">}</span><span class="s0">]`</span>
                <span class="s1">: </span><span class="s0">&quot;unnamed&quot;</span><span class="s1">;</span>

            <span class="s2">res</span><span class="s1">.</span><span class="s2">write</span><span class="s1">(</span><span class="s0">`&lt;h2&gt;Compilation: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">name</span><span class="s1">}</span><span class="s0">&lt;/h2&gt;`</span><span class="s1">);</span>
            <span class="s2">res</span><span class="s1">.</span><span class="s2">write</span><span class="s1">(</span><span class="s0">&quot;&lt;ul&gt;&quot;</span><span class="s1">);</span>

            <span class="s3">const </span><span class="s2">publicPath </span><span class="s1">=</span>
              <span class="s2">item</span><span class="s1">.</span><span class="s2">publicPath </span><span class="s1">=== </span><span class="s0">&quot;auto&quot; </span><span class="s1">? </span><span class="s0">&quot;&quot; </span><span class="s1">: </span><span class="s2">item</span><span class="s1">.</span><span class="s2">publicPath</span><span class="s1">;</span>

            <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">asset of </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{NonNullable&lt;StatsCompilation[&quot;assets&quot;]&gt;} */ </span><span class="s1">(</span>
              <span class="s2">item</span><span class="s1">.</span><span class="s2">assets</span>
            <span class="s1">)) {</span>
              <span class="s3">const </span><span class="s2">assetName </span><span class="s1">= </span><span class="s2">asset</span><span class="s1">.</span><span class="s2">name</span><span class="s1">;</span>
              <span class="s3">const </span><span class="s2">assetURL </span><span class="s1">= </span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">publicPath</span><span class="s1">}</span><span class="s2">$</span><span class="s1">{</span><span class="s2">assetName</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>

              <span class="s2">res</span><span class="s1">.</span><span class="s2">write</span><span class="s1">(</span>
                <span class="s0">`&lt;li&gt; 
              &lt;strong&gt;&lt;a href=&quot;</span><span class="s2">$</span><span class="s1">{</span><span class="s2">assetURL</span><span class="s1">}</span><span class="s0">&quot; target=&quot;_blank&quot;&gt;</span><span class="s2">$</span><span class="s1">{</span><span class="s2">assetName</span><span class="s1">}</span><span class="s0">&lt;/a&gt;&lt;/strong&gt; 
            &lt;/li&gt;`</span>
              <span class="s1">);</span>
            <span class="s1">}</span>

            <span class="s2">res</span><span class="s1">.</span><span class="s2">write</span><span class="s1">(</span><span class="s0">&quot;&lt;/ul&gt;&quot;</span><span class="s1">);</span>
            <span class="s2">res</span><span class="s1">.</span><span class="s2">write</span><span class="s1">(</span><span class="s0">&quot;&lt;/div&gt;&quot;</span><span class="s1">);</span>
          <span class="s1">});</span>

          <span class="s2">res</span><span class="s1">.</span><span class="s2">end</span><span class="s1">(</span><span class="s0">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="s1">);</span>
        <span class="s1">});</span>
      <span class="s1">}</span>
    <span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{void}</span>
   <span class="s4">*/</span>
  <span class="s2">setupWatchStaticFiles</span><span class="s1">() {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{NormalizedStatic[]} */ </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">static</span><span class="s1">).</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s8">0</span><span class="s1">) {</span>
      <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{NormalizedStatic[]} */</span>
      <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">static</span><span class="s1">).</span><span class="s2">forEach</span><span class="s1">((</span><span class="s2">staticOption</span><span class="s1">) =&gt; {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">staticOption</span><span class="s1">.</span><span class="s2">watch</span><span class="s1">) {</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">watchFiles</span><span class="s1">(</span><span class="s2">staticOption</span><span class="s1">.</span><span class="s2">directory</span><span class="s1">, </span><span class="s2">staticOption</span><span class="s1">.</span><span class="s2">watch</span><span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">});</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{void}</span>
   <span class="s4">*/</span>
  <span class="s2">setupWatchFiles</span><span class="s1">() {</span>
    <span class="s3">const </span><span class="s1">{ </span><span class="s2">watchFiles </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{WatchFiles[]} */ </span><span class="s1">(</span><span class="s2">watchFiles</span><span class="s1">).</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s8">0</span><span class="s1">) {</span>
      <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{WatchFiles[]} */</span>
      <span class="s1">(</span><span class="s2">watchFiles</span><span class="s1">).</span><span class="s2">forEach</span><span class="s1">((</span><span class="s2">item</span><span class="s1">) =&gt; {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">watchFiles</span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">paths</span><span class="s1">, </span><span class="s2">item</span><span class="s1">.</span><span class="s2">options</span><span class="s1">);</span>
      <span class="s1">});</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{void}</span>
   <span class="s4">*/</span>
  <span class="s2">setupMiddlewares</span><span class="s1">() {</span>
    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@type </span><span class="s4">{Array&lt;Middleware&gt;}</span>
     <span class="s4">*/</span>
    <span class="s3">let </span><span class="s2">middlewares </span><span class="s1">= [];</span>

    <span class="s6">// compress is placed last and uses unshift so that it will be the first middleware used</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">compress</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">compression </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;compression&quot;</span><span class="s1">);</span>

      <span class="s2">middlewares</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({ </span><span class="s2">name</span><span class="s1">: </span><span class="s0">&quot;compression&quot;</span><span class="s1">, </span><span class="s2">middleware</span><span class="s1">: </span><span class="s2">compression</span><span class="s1">() });</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">onBeforeSetupMiddleware </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">onBeforeSetupMiddleware</span><span class="s1">(</span><span class="s3">this</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">headers </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
      <span class="s2">middlewares</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({</span>
        <span class="s2">name</span><span class="s1">: </span><span class="s0">&quot;set-headers&quot;</span><span class="s1">,</span>
        <span class="s2">path</span><span class="s1">: </span><span class="s0">&quot;*&quot;</span><span class="s1">,</span>
        <span class="s2">middleware</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">setHeaders</span><span class="s1">.</span><span class="s2">bind</span><span class="s1">(</span><span class="s3">this</span><span class="s1">),</span>
      <span class="s1">});</span>
    <span class="s1">}</span>

    <span class="s2">middlewares</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({</span>
      <span class="s2">name</span><span class="s1">: </span><span class="s0">&quot;webpack-dev-middleware&quot;</span><span class="s1">,</span>
      <span class="s2">middleware</span><span class="s1">:</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;webpack-dev-middleware&quot;).Middleware&lt;Request, Response&gt;}*/</span>
        <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">middleware</span><span class="s1">),</span>
    <span class="s1">});</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">proxy</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s1">{ </span><span class="s2">createProxyMiddleware </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;http-proxy-middleware&quot;</span><span class="s1">);</span>

      <span class="s4">/**</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{ProxyConfigArrayItem} proxyConfig</span>
       <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{RequestHandler | undefined}</span>
       <span class="s4">*/</span>
      <span class="s3">const </span><span class="s2">getProxyMiddleware </span><span class="s1">= (</span><span class="s2">proxyConfig</span><span class="s1">) =&gt; {</span>
        <span class="s6">// It is possible to use the `bypass` method without a `target` or `router`.</span>
        <span class="s6">// However, the proxy middleware has no use in this case, and will fail to instantiate.</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">proxyConfig</span><span class="s1">.</span><span class="s2">target</span><span class="s1">) {</span>
          <span class="s3">const </span><span class="s2">context </span><span class="s1">= </span><span class="s2">proxyConfig</span><span class="s1">.</span><span class="s2">context </span><span class="s1">|| </span><span class="s2">proxyConfig</span><span class="s1">.</span><span class="s2">path</span><span class="s1">;</span>

          <span class="s3">return </span><span class="s2">createProxyMiddleware</span><span class="s1">(</span>
            <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{string} */ </span><span class="s1">(</span><span class="s2">context</span><span class="s1">),</span>
            <span class="s2">proxyConfig</span>
          <span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">proxyConfig</span><span class="s1">.</span><span class="s2">router</span><span class="s1">) {</span>
          <span class="s3">return </span><span class="s2">createProxyMiddleware</span><span class="s1">(</span><span class="s2">proxyConfig</span><span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">};</span>

      <span class="s4">/**</span>
       <span class="s4">* Assume a proxy configuration specified as:</span>
       <span class="s4">* proxy: [</span>
       <span class="s4">*   {</span>
       <span class="s4">*     context: &quot;value&quot;,</span>
       <span class="s4">*     ...options,</span>
       <span class="s4">*   },</span>
       <span class="s4">*   // or:</span>
       <span class="s4">*   function() {</span>
       <span class="s4">*     return {</span>
       <span class="s4">*       context: &quot;context&quot;,</span>
       <span class="s4">*       ...options,</span>
       <span class="s4">*     };</span>
       <span class="s4">*   }</span>
       <span class="s4">* ]</span>
       <span class="s4">*/</span>
      <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ProxyConfigArray} */</span>
      <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">proxy</span><span class="s1">).</span><span class="s2">forEach</span><span class="s1">((</span><span class="s2">proxyConfigOrCallback</span><span class="s1">) =&gt; {</span>
        <span class="s4">/**</span>
         <span class="s4">* </span><span class="s5">@type </span><span class="s4">{RequestHandler}</span>
         <span class="s4">*/</span>
        <span class="s3">let </span><span class="s2">proxyMiddleware</span><span class="s1">;</span>

        <span class="s3">let </span><span class="s2">proxyConfig </span><span class="s1">=</span>
          <span class="s3">typeof </span><span class="s2">proxyConfigOrCallback </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span>
            <span class="s1">? </span><span class="s2">proxyConfigOrCallback</span><span class="s1">()</span>
            <span class="s1">: </span><span class="s2">proxyConfigOrCallback</span><span class="s1">;</span>

        <span class="s2">proxyMiddleware </span><span class="s1">=</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{RequestHandler} */</span>
          <span class="s1">(</span><span class="s2">getProxyMiddleware</span><span class="s1">(</span><span class="s2">proxyConfig</span><span class="s1">));</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">proxyConfig</span><span class="s1">.</span><span class="s2">ws</span><span class="s1">) {</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">webSocketProxies</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">proxyMiddleware</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s4">/**</span>
         <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Request} req</span>
         <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Response} res</span>
         <span class="s4">* </span><span class="s5">@param </span><span class="s4">{NextFunction} next</span>
         <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{Promise&lt;void&gt;}</span>
         <span class="s4">*/</span>
        <span class="s3">const </span><span class="s2">handler </span><span class="s1">= </span><span class="s2">async </span><span class="s1">(</span><span class="s2">req</span><span class="s1">, </span><span class="s2">res</span><span class="s1">, </span><span class="s2">next</span><span class="s1">) =&gt; {</span>
          <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">proxyConfigOrCallback </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span><span class="s1">) {</span>
            <span class="s3">const </span><span class="s2">newProxyConfig </span><span class="s1">= </span><span class="s2">proxyConfigOrCallback</span><span class="s1">(</span><span class="s2">req</span><span class="s1">, </span><span class="s2">res</span><span class="s1">, </span><span class="s2">next</span><span class="s1">);</span>

            <span class="s3">if </span><span class="s1">(</span><span class="s2">newProxyConfig </span><span class="s1">!== </span><span class="s2">proxyConfig</span><span class="s1">) {</span>
              <span class="s2">proxyConfig </span><span class="s1">= </span><span class="s2">newProxyConfig</span><span class="s1">;</span>
              <span class="s2">proxyMiddleware </span><span class="s1">=</span>
                <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{RequestHandler} */</span>
                <span class="s1">(</span><span class="s2">getProxyMiddleware</span><span class="s1">(</span><span class="s2">proxyConfig</span><span class="s1">));</span>
            <span class="s1">}</span>
          <span class="s1">}</span>

          <span class="s6">// - Check if we have a bypass function defined</span>
          <span class="s6">// - In case the bypass function is defined we'll retrieve the</span>
          <span class="s6">// bypassUrl from it otherwise bypassUrl would be null</span>
          <span class="s6">// TODO remove in the next major in favor `context` and `router` options</span>
          <span class="s3">const </span><span class="s2">isByPassFuncDefined </span><span class="s1">= </span><span class="s3">typeof </span><span class="s2">proxyConfig</span><span class="s1">.</span><span class="s2">bypass </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span><span class="s1">;</span>
          <span class="s3">const </span><span class="s2">bypassUrl </span><span class="s1">= </span><span class="s2">isByPassFuncDefined</span>
            <span class="s1">? </span><span class="s3">await </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ByPass} */ </span><span class="s1">(</span><span class="s2">proxyConfig</span><span class="s1">.</span><span class="s2">bypass</span><span class="s1">)(</span>
                <span class="s2">req</span><span class="s1">,</span>
                <span class="s2">res</span><span class="s1">,</span>
                <span class="s2">proxyConfig</span>
              <span class="s1">)</span>
            <span class="s1">: </span><span class="s3">null</span><span class="s1">;</span>

          <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">bypassUrl </span><span class="s1">=== </span><span class="s0">&quot;boolean&quot;</span><span class="s1">) {</span>
            <span class="s6">// skip the proxy</span>
            <span class="s6">// @ts-ignore</span>
            <span class="s2">req</span><span class="s1">.</span><span class="s2">url </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
            <span class="s2">next</span><span class="s1">();</span>
          <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">bypassUrl </span><span class="s1">=== </span><span class="s0">&quot;string&quot;</span><span class="s1">) {</span>
            <span class="s6">// byPass to that url</span>
            <span class="s2">req</span><span class="s1">.</span><span class="s2">url </span><span class="s1">= </span><span class="s2">bypassUrl</span><span class="s1">;</span>
            <span class="s2">next</span><span class="s1">();</span>
          <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">proxyMiddleware</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s2">proxyMiddleware</span><span class="s1">(</span><span class="s2">req</span><span class="s1">, </span><span class="s2">res</span><span class="s1">, </span><span class="s2">next</span><span class="s1">);</span>
          <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
            <span class="s2">next</span><span class="s1">();</span>
          <span class="s1">}</span>
        <span class="s1">};</span>

        <span class="s2">middlewares</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({</span>
          <span class="s2">name</span><span class="s1">: </span><span class="s0">&quot;http-proxy-middleware&quot;</span><span class="s1">,</span>
          <span class="s2">middleware</span><span class="s1">: </span><span class="s2">handler</span><span class="s1">,</span>
        <span class="s1">});</span>
        <span class="s6">// Also forward error requests to the proxy so it can handle them.</span>
        <span class="s2">middlewares</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({</span>
          <span class="s2">name</span><span class="s1">: </span><span class="s0">&quot;http-proxy-middleware-error-handler&quot;</span><span class="s1">,</span>
          <span class="s2">middleware</span><span class="s1">:</span>
            <span class="s4">/**</span>
             <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Error} error</span>
             <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Request} req</span>
             <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Response} res</span>
             <span class="s4">* </span><span class="s5">@param </span><span class="s4">{NextFunction} next</span>
             <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{any}</span>
             <span class="s4">*/</span>
            <span class="s1">(</span><span class="s2">error</span><span class="s1">, </span><span class="s2">req</span><span class="s1">, </span><span class="s2">res</span><span class="s1">, </span><span class="s2">next</span><span class="s1">) =&gt; </span><span class="s2">handler</span><span class="s1">(</span><span class="s2">req</span><span class="s1">, </span><span class="s2">res</span><span class="s1">, </span><span class="s2">next</span><span class="s1">),</span>
        <span class="s1">});</span>
      <span class="s1">});</span>

      <span class="s2">middlewares</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({</span>
        <span class="s2">name</span><span class="s1">: </span><span class="s0">&quot;webpack-dev-middleware&quot;</span><span class="s1">,</span>
        <span class="s2">middleware</span><span class="s1">:</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;webpack-dev-middleware&quot;).Middleware&lt;Request, Response&gt;}*/</span>
          <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">middleware</span><span class="s1">),</span>
      <span class="s1">});</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{NormalizedStatic[]} */ </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">static</span><span class="s1">).</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s8">0</span><span class="s1">) {</span>
      <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{NormalizedStatic[]} */</span>
      <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">static</span><span class="s1">).</span><span class="s2">forEach</span><span class="s1">((</span><span class="s2">staticOption</span><span class="s1">) =&gt; {</span>
        <span class="s2">staticOption</span><span class="s1">.</span><span class="s2">publicPath</span><span class="s1">.</span><span class="s2">forEach</span><span class="s1">((</span><span class="s2">publicPath</span><span class="s1">) =&gt; {</span>
          <span class="s2">middlewares</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({</span>
            <span class="s2">name</span><span class="s1">: </span><span class="s0">&quot;express-static&quot;</span><span class="s1">,</span>
            <span class="s2">path</span><span class="s1">: </span><span class="s2">publicPath</span><span class="s1">,</span>
            <span class="s2">middleware</span><span class="s1">: </span><span class="s2">getExpress</span><span class="s1">().</span><span class="s2">static</span><span class="s1">(</span>
              <span class="s2">staticOption</span><span class="s1">.</span><span class="s2">directory</span><span class="s1">,</span>
              <span class="s2">staticOption</span><span class="s1">.</span><span class="s2">staticOptions</span>
            <span class="s1">),</span>
          <span class="s1">});</span>
        <span class="s1">});</span>
      <span class="s1">});</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">historyApiFallback</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">connectHistoryApiFallback </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;connect-history-api-fallback&quot;</span><span class="s1">);</span>
      <span class="s3">const </span><span class="s1">{ </span><span class="s2">historyApiFallback </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">;</span>

      <span class="s3">if </span><span class="s1">(</span>
        <span class="s3">typeof </span><span class="s1">(</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ConnectHistoryApiFallbackOptions} */</span>
          <span class="s1">(</span><span class="s2">historyApiFallback</span><span class="s1">).</span><span class="s2">logger</span>
        <span class="s1">) === </span><span class="s0">&quot;undefined&quot; </span><span class="s1">&amp;&amp;</span>
        <span class="s1">!(</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ConnectHistoryApiFallbackOptions} */</span>
          <span class="s1">(</span><span class="s2">historyApiFallback</span><span class="s1">).</span><span class="s2">verbose</span>
        <span class="s1">)</span>
      <span class="s1">) {</span>
        <span class="s6">// @ts-ignore</span>
        <span class="s2">historyApiFallback</span><span class="s1">.</span><span class="s2">logger </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">logger</span><span class="s1">.</span><span class="s2">log</span><span class="s1">.</span><span class="s2">bind</span><span class="s1">(</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">logger</span><span class="s1">,</span>
          <span class="s0">&quot;[connect-history-api-fallback]&quot;</span>
        <span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s6">// Fall back to /index.html if nothing else matches.</span>
      <span class="s2">middlewares</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({</span>
        <span class="s2">name</span><span class="s1">: </span><span class="s0">&quot;connect-history-api-fallback&quot;</span><span class="s1">,</span>
        <span class="s2">middleware</span><span class="s1">: </span><span class="s2">connectHistoryApiFallback</span><span class="s1">(</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ConnectHistoryApiFallbackOptions} */</span>
          <span class="s1">(</span><span class="s2">historyApiFallback</span><span class="s1">)</span>
        <span class="s1">),</span>
      <span class="s1">});</span>

      <span class="s6">// include our middleware to ensure</span>
      <span class="s6">// it is able to handle '/index.html' request after redirect</span>
      <span class="s2">middlewares</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({</span>
        <span class="s2">name</span><span class="s1">: </span><span class="s0">&quot;webpack-dev-middleware&quot;</span><span class="s1">,</span>
        <span class="s2">middleware</span><span class="s1">:</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;webpack-dev-middleware&quot;).Middleware&lt;Request, Response&gt;}*/</span>
          <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">middleware</span><span class="s1">),</span>
      <span class="s1">});</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{NormalizedStatic[]} */ </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">static</span><span class="s1">).</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s8">0</span><span class="s1">) {</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{NormalizedStatic[]} */</span>
        <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">static</span><span class="s1">).</span><span class="s2">forEach</span><span class="s1">((</span><span class="s2">staticOption</span><span class="s1">) =&gt; {</span>
          <span class="s2">staticOption</span><span class="s1">.</span><span class="s2">publicPath</span><span class="s1">.</span><span class="s2">forEach</span><span class="s1">((</span><span class="s2">publicPath</span><span class="s1">) =&gt; {</span>
            <span class="s2">middlewares</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({</span>
              <span class="s2">name</span><span class="s1">: </span><span class="s0">&quot;express-static&quot;</span><span class="s1">,</span>
              <span class="s2">path</span><span class="s1">: </span><span class="s2">publicPath</span><span class="s1">,</span>
              <span class="s2">middleware</span><span class="s1">: </span><span class="s2">getExpress</span><span class="s1">().</span><span class="s2">static</span><span class="s1">(</span>
                <span class="s2">staticOption</span><span class="s1">.</span><span class="s2">directory</span><span class="s1">,</span>
                <span class="s2">staticOption</span><span class="s1">.</span><span class="s2">staticOptions</span>
              <span class="s1">),</span>
            <span class="s1">});</span>
          <span class="s1">});</span>
        <span class="s1">});</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{NormalizedStatic[]} */ </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">static</span><span class="s1">).</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s8">0</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">serveIndex </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;serve-index&quot;</span><span class="s1">);</span>

      <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{NormalizedStatic[]} */</span>
      <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">static</span><span class="s1">).</span><span class="s2">forEach</span><span class="s1">((</span><span class="s2">staticOption</span><span class="s1">) =&gt; {</span>
        <span class="s2">staticOption</span><span class="s1">.</span><span class="s2">publicPath</span><span class="s1">.</span><span class="s2">forEach</span><span class="s1">((</span><span class="s2">publicPath</span><span class="s1">) =&gt; {</span>
          <span class="s3">if </span><span class="s1">(</span><span class="s2">staticOption</span><span class="s1">.</span><span class="s2">serveIndex</span><span class="s1">) {</span>
            <span class="s2">middlewares</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({</span>
              <span class="s2">name</span><span class="s1">: </span><span class="s0">&quot;serve-index&quot;</span><span class="s1">,</span>
              <span class="s2">path</span><span class="s1">: </span><span class="s2">publicPath</span><span class="s1">,</span>
              <span class="s4">/**</span>
               <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Request} req</span>
               <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Response} res</span>
               <span class="s4">* </span><span class="s5">@param </span><span class="s4">{NextFunction} next</span>
               <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{void}</span>
               <span class="s4">*/</span>
              <span class="s2">middleware</span><span class="s1">: (</span><span class="s2">req</span><span class="s1">, </span><span class="s2">res</span><span class="s1">, </span><span class="s2">next</span><span class="s1">) =&gt; {</span>
                <span class="s6">// serve-index doesn't fallthrough non-get/head request to next middleware</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">req</span><span class="s1">.</span><span class="s2">method </span><span class="s1">!== </span><span class="s0">&quot;GET&quot; </span><span class="s1">&amp;&amp; </span><span class="s2">req</span><span class="s1">.</span><span class="s2">method </span><span class="s1">!== </span><span class="s0">&quot;HEAD&quot;</span><span class="s1">) {</span>
                  <span class="s3">return </span><span class="s2">next</span><span class="s1">();</span>
                <span class="s1">}</span>

                <span class="s2">serveIndex</span><span class="s1">(</span>
                  <span class="s2">staticOption</span><span class="s1">.</span><span class="s2">directory</span><span class="s1">,</span>
                  <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ServeIndexOptions} */</span>
                  <span class="s1">(</span><span class="s2">staticOption</span><span class="s1">.</span><span class="s2">serveIndex</span><span class="s1">)</span>
                <span class="s1">)(</span><span class="s2">req</span><span class="s1">, </span><span class="s2">res</span><span class="s1">, </span><span class="s2">next</span><span class="s1">);</span>
              <span class="s1">},</span>
            <span class="s1">});</span>
          <span class="s1">}</span>
        <span class="s1">});</span>
      <span class="s1">});</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">magicHtml</span><span class="s1">) {</span>
      <span class="s2">middlewares</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({</span>
        <span class="s2">name</span><span class="s1">: </span><span class="s0">&quot;serve-magic-html&quot;</span><span class="s1">,</span>
        <span class="s2">middleware</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">serveMagicHtml</span><span class="s1">.</span><span class="s2">bind</span><span class="s1">(</span><span class="s3">this</span><span class="s1">),</span>
      <span class="s1">});</span>
    <span class="s1">}</span>

    <span class="s6">// Register this middleware always as the last one so that it's only used as a</span>
    <span class="s6">// fallback when no other middleware responses.</span>
    <span class="s2">middlewares</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({</span>
      <span class="s2">name</span><span class="s1">: </span><span class="s0">&quot;options-middleware&quot;</span><span class="s1">,</span>
      <span class="s2">path</span><span class="s1">: </span><span class="s0">&quot;*&quot;</span><span class="s1">,</span>
      <span class="s4">/**</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Request} req</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Response} res</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{NextFunction} next</span>
       <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{void}</span>
       <span class="s4">*/</span>
      <span class="s2">middleware</span><span class="s1">: (</span><span class="s2">req</span><span class="s1">, </span><span class="s2">res</span><span class="s1">, </span><span class="s2">next</span><span class="s1">) =&gt; {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">req</span><span class="s1">.</span><span class="s2">method </span><span class="s1">=== </span><span class="s0">&quot;OPTIONS&quot;</span><span class="s1">) {</span>
          <span class="s2">res</span><span class="s1">.</span><span class="s2">statusCode </span><span class="s1">= </span><span class="s8">204</span><span class="s1">;</span>
          <span class="s2">res</span><span class="s1">.</span><span class="s2">setHeader</span><span class="s1">(</span><span class="s0">&quot;Content-Length&quot;</span><span class="s1">, </span><span class="s0">&quot;0&quot;</span><span class="s1">);</span>
          <span class="s2">res</span><span class="s1">.</span><span class="s2">end</span><span class="s1">();</span>
          <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s2">next</span><span class="s1">();</span>
      <span class="s1">},</span>
    <span class="s1">});</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">setupMiddlewares </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span><span class="s1">) {</span>
      <span class="s2">middlewares </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">setupMiddlewares</span><span class="s1">(</span><span class="s2">middlewares</span><span class="s1">, </span><span class="s3">this</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s2">middlewares</span><span class="s1">.</span><span class="s2">forEach</span><span class="s1">((</span><span class="s2">middleware</span><span class="s1">) =&gt; {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">middleware </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span><span class="s1">) {</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;express&quot;).Application} */</span>
        <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">app</span><span class="s1">).</span><span class="s2">use</span><span class="s1">(</span><span class="s2">middleware</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">middleware</span><span class="s1">.</span><span class="s2">path </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span><span class="s1">) {</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;express&quot;).Application} */</span>
        <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">app</span><span class="s1">).</span><span class="s2">use</span><span class="s1">(</span><span class="s2">middleware</span><span class="s1">.</span><span class="s2">path</span><span class="s1">, </span><span class="s2">middleware</span><span class="s1">.</span><span class="s2">middleware</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;express&quot;).Application} */</span>
        <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">app</span><span class="s1">).</span><span class="s2">use</span><span class="s1">(</span><span class="s2">middleware</span><span class="s1">.</span><span class="s2">middleware</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">});</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">onAfterSetupMiddleware </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">onAfterSetupMiddleware</span><span class="s1">(</span><span class="s3">this</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{void}</span>
   <span class="s4">*/</span>
  <span class="s2">createServer</span><span class="s1">() {</span>
    <span class="s3">const </span><span class="s1">{ </span><span class="s2">type</span><span class="s1">, </span><span class="s2">options </span><span class="s1">} = </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ServerConfiguration} */ </span><span class="s1">(</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">server</span>
    <span class="s1">);</span>

    <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;http&quot;).Server | undefined | null} */</span>
    <span class="s6">// eslint-disable-next-line import/no-dynamic-require</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">server </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{string} */ </span><span class="s1">(</span><span class="s2">type</span><span class="s1">)).</span><span class="s2">createServer</span><span class="s1">(</span>
      <span class="s2">options</span><span class="s1">,</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">app</span>
    <span class="s1">);</span>

    <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;http&quot;).Server} */</span>
    <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">server</span><span class="s1">).</span><span class="s2">on</span><span class="s1">(</span>
      <span class="s0">&quot;connection&quot;</span><span class="s1">,</span>
      <span class="s4">/**</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Socket} socket</span>
       <span class="s4">*/</span>
      <span class="s1">(</span><span class="s2">socket</span><span class="s1">) =&gt; {</span>
        <span class="s6">// Add socket to list</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">sockets</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">socket</span><span class="s1">);</span>

        <span class="s2">socket</span><span class="s1">.</span><span class="s2">once</span><span class="s1">(</span><span class="s0">&quot;close&quot;</span><span class="s1">, () =&gt; {</span>
          <span class="s6">// Remove socket from list</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">sockets</span><span class="s1">.</span><span class="s2">splice</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">sockets</span><span class="s1">.</span><span class="s2">indexOf</span><span class="s1">(</span><span class="s2">socket</span><span class="s1">), </span><span class="s8">1</span><span class="s1">);</span>
        <span class="s1">});</span>
      <span class="s1">}</span>
    <span class="s1">);</span>

    <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;http&quot;).Server} */</span>
    <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">server</span><span class="s1">).</span><span class="s2">on</span><span class="s1">(</span>
      <span class="s0">&quot;error&quot;</span><span class="s1">,</span>
      <span class="s4">/**</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Error} error</span>
       <span class="s4">*/</span>
      <span class="s1">(</span><span class="s2">error</span><span class="s1">) =&gt; {</span>
        <span class="s3">throw </span><span class="s2">error</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{void}</span>
   <span class="s4">*/</span>
  <span class="s6">// TODO: remove `--web-socket-server` in favor of `--web-socket-server-type`</span>
  <span class="s2">createWebSocketServer</span><span class="s1">() {</span>
    <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{WebSocketServerImplementation | undefined | null} */</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">webSocketServer </span><span class="s1">= </span><span class="s3">new </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{any} */ </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">getServerTransport</span><span class="s1">())(</span>
      <span class="s3">this</span>
    <span class="s1">);</span>
    <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{WebSocketServerImplementation} */</span>
    <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">webSocketServer</span><span class="s1">).</span><span class="s2">implementation</span><span class="s1">.</span><span class="s2">on</span><span class="s1">(</span>
      <span class="s0">&quot;connection&quot;</span><span class="s1">,</span>
      <span class="s4">/**</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{ClientConnection} client</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{IncomingMessage} request</span>
       <span class="s4">*/</span>
      <span class="s1">(</span><span class="s2">client</span><span class="s1">, </span><span class="s2">request</span><span class="s1">) =&gt; {</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{{ [key: string]: string | undefined } | undefined} */</span>
        <span class="s3">const </span><span class="s2">headers </span><span class="s1">=</span>
          <span class="s6">// eslint-disable-next-line no-nested-ternary</span>
          <span class="s3">typeof </span><span class="s2">request </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot;</span>
            <span class="s1">? </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{{ [key: string]: string | undefined }} */</span>
              <span class="s1">(</span><span class="s2">request</span><span class="s1">.</span><span class="s2">headers</span><span class="s1">)</span>
            <span class="s1">: </span><span class="s3">typeof </span><span class="s1">(</span>
                <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;sockjs&quot;).Connection} */ </span><span class="s1">(</span><span class="s2">client</span><span class="s1">).</span><span class="s2">headers</span>
              <span class="s1">) !== </span><span class="s0">&quot;undefined&quot;</span>
            <span class="s1">? </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;sockjs&quot;).Connection} */ </span><span class="s1">(</span><span class="s2">client</span><span class="s1">).</span><span class="s2">headers</span>
            <span class="s1">: </span><span class="s6">// eslint-disable-next-line no-undefined</span>
              <span class="s2">undefined</span><span class="s1">;</span>

        <span class="s3">if </span><span class="s1">(!</span><span class="s2">headers</span><span class="s1">) {</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">logger</span><span class="s1">.</span><span class="s2">warn</span><span class="s1">(</span>
            <span class="s0">'webSocketServer implementation must pass headers for the &quot;connection&quot; event'</span>
          <span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span>
          <span class="s1">!</span><span class="s2">headers </span><span class="s1">||</span>
          <span class="s1">!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">checkHeader</span><span class="s1">(</span><span class="s2">headers</span><span class="s1">, </span><span class="s0">&quot;host&quot;</span><span class="s1">) ||</span>
          <span class="s1">!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">checkHeader</span><span class="s1">(</span><span class="s2">headers</span><span class="s1">, </span><span class="s0">&quot;origin&quot;</span><span class="s1">)</span>
        <span class="s1">) {</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">sendMessage</span><span class="s1">([</span><span class="s2">client</span><span class="s1">], </span><span class="s0">&quot;error&quot;</span><span class="s1">, </span><span class="s0">&quot;Invalid Host/Origin header&quot;</span><span class="s1">);</span>

          <span class="s6">// With https enabled, the sendMessage above is encrypted asynchronously so not yet sent</span>
          <span class="s6">// Terminate would prevent it sending, so use close to allow it to be sent</span>
          <span class="s2">client</span><span class="s1">.</span><span class="s2">close</span><span class="s1">();</span>

          <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">hot </span><span class="s1">=== </span><span class="s3">true </span><span class="s1">|| </span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">hot </span><span class="s1">=== </span><span class="s0">&quot;only&quot;</span><span class="s1">) {</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">sendMessage</span><span class="s1">([</span><span class="s2">client</span><span class="s1">], </span><span class="s0">&quot;hot&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">liveReload</span><span class="s1">) {</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">sendMessage</span><span class="s1">([</span><span class="s2">client</span><span class="s1">], </span><span class="s0">&quot;liveReload&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">client </span><span class="s1">&amp;&amp;</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ClientConfiguration} */</span>
          <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">).</span><span class="s2">progress</span>
        <span class="s1">) {</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">sendMessage</span><span class="s1">(</span>
            <span class="s1">[</span><span class="s2">client</span><span class="s1">],</span>
            <span class="s0">&quot;progress&quot;</span><span class="s1">,</span>
            <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ClientConfiguration} */</span>
            <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">).</span><span class="s2">progress</span>
          <span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">client </span><span class="s1">&amp;&amp;</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ClientConfiguration} */ </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">).</span><span class="s2">reconnect</span>
        <span class="s1">) {</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">sendMessage</span><span class="s1">(</span>
            <span class="s1">[</span><span class="s2">client</span><span class="s1">],</span>
            <span class="s0">&quot;reconnect&quot;</span><span class="s1">,</span>
            <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ClientConfiguration} */</span>
            <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">).</span><span class="s2">reconnect</span>
          <span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">client </span><span class="s1">&amp;&amp;</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ClientConfiguration} */</span>
          <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">).</span><span class="s2">overlay</span>
        <span class="s1">) {</span>
          <span class="s3">const </span><span class="s2">overlayConfig </span><span class="s1">= </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ClientConfiguration} */ </span><span class="s1">(</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">client</span>
          <span class="s1">).</span><span class="s2">overlay</span><span class="s1">;</span>

          <span class="s3">this</span><span class="s1">.</span><span class="s2">sendMessage</span><span class="s1">(</span>
            <span class="s1">[</span><span class="s2">client</span><span class="s1">],</span>
            <span class="s0">&quot;overlay&quot;</span><span class="s1">,</span>
            <span class="s3">typeof </span><span class="s2">overlayConfig </span><span class="s1">=== </span><span class="s0">&quot;object&quot;</span>
              <span class="s1">? {</span>
                  <span class="s2">...overlayConfig</span><span class="s1">,</span>
                  <span class="s2">errors</span><span class="s1">:</span>
                    <span class="s2">overlayConfig</span><span class="s1">.</span><span class="s2">errors </span><span class="s1">&amp;&amp;</span>
                    <span class="s2">encodeOverlaySettings</span><span class="s1">(</span><span class="s2">overlayConfig</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">),</span>
                  <span class="s2">warnings</span><span class="s1">:</span>
                    <span class="s2">overlayConfig</span><span class="s1">.</span><span class="s2">warnings </span><span class="s1">&amp;&amp;</span>
                    <span class="s2">encodeOverlaySettings</span><span class="s1">(</span><span class="s2">overlayConfig</span><span class="s1">.</span><span class="s2">warnings</span><span class="s1">),</span>
                  <span class="s2">runtimeErrors</span><span class="s1">:</span>
                    <span class="s2">overlayConfig</span><span class="s1">.</span><span class="s2">runtimeErrors </span><span class="s1">&amp;&amp;</span>
                    <span class="s2">encodeOverlaySettings</span><span class="s1">(</span><span class="s2">overlayConfig</span><span class="s1">.</span><span class="s2">runtimeErrors</span><span class="s1">),</span>
                <span class="s1">}</span>
              <span class="s1">: </span><span class="s2">overlayConfig</span>
          <span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">stats</span><span class="s1">) {</span>
          <span class="s3">return</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">this</span><span class="s1">.</span><span class="s2">sendStats</span><span class="s1">([</span><span class="s2">client</span><span class="s1">], </span><span class="s3">this</span><span class="s1">.</span><span class="s2">getStats</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">stats</span><span class="s1">), </span><span class="s3">true</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{string} defaultOpenTarget</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{void}</span>
   <span class="s4">*/</span>
  <span class="s2">openBrowser</span><span class="s1">(</span><span class="s2">defaultOpenTarget</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">open </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;open&quot;</span><span class="s1">);</span>

    <span class="s2">Promise</span><span class="s1">.</span><span class="s2">all</span><span class="s1">(</span>
      <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{NormalizedOpen[]} */</span>
      <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">open</span><span class="s1">).</span><span class="s2">map</span><span class="s1">((</span><span class="s2">item</span><span class="s1">) =&gt; {</span>
        <span class="s4">/**</span>
         <span class="s4">* </span><span class="s5">@type </span><span class="s4">{string}</span>
         <span class="s4">*/</span>
        <span class="s3">let </span><span class="s2">openTarget</span><span class="s1">;</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">target </span><span class="s1">=== </span><span class="s0">&quot;&lt;url&gt;&quot;</span><span class="s1">) {</span>
          <span class="s2">openTarget </span><span class="s1">= </span><span class="s2">defaultOpenTarget</span><span class="s1">;</span>
        <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
          <span class="s2">openTarget </span><span class="s1">= </span><span class="s2">Server</span><span class="s1">.</span><span class="s2">isAbsoluteURL</span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">target</span><span class="s1">)</span>
            <span class="s1">? </span><span class="s2">item</span><span class="s1">.</span><span class="s2">target</span>
            <span class="s1">: </span><span class="s3">new </span><span class="s2">URL</span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">target</span><span class="s1">, </span><span class="s2">defaultOpenTarget</span><span class="s1">).</span><span class="s2">toString</span><span class="s1">();</span>
        <span class="s1">}</span>

        <span class="s3">return </span><span class="s2">open</span><span class="s1">(</span><span class="s2">openTarget</span><span class="s1">, </span><span class="s2">item</span><span class="s1">.</span><span class="s2">options</span><span class="s1">).</span><span class="s2">catch</span><span class="s1">(() =&gt; {</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">logger</span><span class="s1">.</span><span class="s2">warn</span><span class="s1">(</span>
            <span class="s0">`Unable to open &quot;</span><span class="s2">$</span><span class="s1">{</span><span class="s2">openTarget</span><span class="s1">}</span><span class="s0">&quot; page</span><span class="s2">$</span><span class="s1">{</span>
              <span class="s2">item</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">app</span>
                <span class="s1">? </span><span class="s0">` in &quot;</span><span class="s2">$</span><span class="s1">{</span>
                    <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;open&quot;).App} */</span>
                    <span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">app</span><span class="s1">).</span><span class="s2">name</span>
                  <span class="s1">}</span><span class="s0">&quot; app</span><span class="s2">$</span><span class="s1">{</span>
                    <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;open&quot;).App} */</span>
                    <span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">app</span><span class="s1">).</span><span class="s2">arguments</span>
                      <span class="s1">? </span><span class="s0">` with &quot;</span><span class="s2">$</span><span class="s1">{</span>
                          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;open&quot;).App} */</span>
                          <span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">app</span><span class="s1">).</span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s0">&quot; &quot;</span><span class="s1">)</span>
                        <span class="s1">}</span><span class="s0">&quot; arguments`</span>
                      <span class="s1">: </span><span class="s0">&quot;&quot;</span>
                  <span class="s1">}</span><span class="s0">`</span>
                <span class="s1">: </span><span class="s0">&quot;&quot;</span>
            <span class="s1">}</span><span class="s0">. If you are running in a headless environment, please do not use the &quot;open&quot; option or related flags like &quot;--open&quot;, &quot;--open-target&quot;, and &quot;--open-app&quot;.`</span>
          <span class="s1">);</span>
        <span class="s1">});</span>
      <span class="s1">})</span>
    <span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{void}</span>
   <span class="s4">*/</span>
  <span class="s2">runBonjour</span><span class="s1">() {</span>
    <span class="s3">const </span><span class="s1">{ </span><span class="s2">Bonjour </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;bonjour-service&quot;</span><span class="s1">);</span>
    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@private</span>
     <span class="s4">* </span><span class="s5">@type </span><span class="s4">{Bonjour | undefined}</span>
     <span class="s4">*/</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">bonjour </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Bonjour</span><span class="s1">();</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">bonjour</span><span class="s1">.</span><span class="s2">publish</span><span class="s1">({</span>
      <span class="s6">// @ts-expect-error</span>
      <span class="s2">name</span><span class="s1">: </span><span class="s0">`Webpack Dev Server </span><span class="s2">$</span><span class="s1">{</span><span class="s2">os</span><span class="s1">.</span><span class="s2">hostname</span><span class="s1">()}</span><span class="s0">:</span><span class="s2">$</span><span class="s1">{</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">port</span><span class="s1">}</span><span class="s0">`</span><span class="s1">,</span>
      <span class="s6">// @ts-expect-error</span>
      <span class="s2">port</span><span class="s1">: </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{number} */ </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">port</span><span class="s1">),</span>
      <span class="s6">// @ts-expect-error</span>
      <span class="s2">type</span><span class="s1">:</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ServerConfiguration} */</span>
        <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">server</span><span class="s1">).</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">&quot;http&quot; </span><span class="s1">? </span><span class="s0">&quot;http&quot; </span><span class="s1">: </span><span class="s0">&quot;https&quot;</span><span class="s1">,</span>
      <span class="s2">subtypes</span><span class="s1">: [</span><span class="s0">&quot;webpack&quot;</span><span class="s1">],</span>
      <span class="s2">...</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{BonjourOptions} */ </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">bonjour</span><span class="s1">),</span>
    <span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{void}</span>
   <span class="s4">*/</span>
  <span class="s2">stopBonjour</span><span class="s1">(</span><span class="s2">callback </span><span class="s1">= () =&gt; {}) {</span>
    <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{Bonjour} */</span>
    <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">bonjour</span><span class="s1">).</span><span class="s2">unpublishAll</span><span class="s1">(() =&gt; {</span>
      <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{Bonjour} */</span>
      <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">bonjour</span><span class="s1">).</span><span class="s2">destroy</span><span class="s1">();</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">callback</span><span class="s1">) {</span>
        <span class="s2">callback</span><span class="s1">();</span>
      <span class="s1">}</span>
    <span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{void}</span>
   <span class="s4">*/</span>
  <span class="s2">logStatus</span><span class="s1">() {</span>
    <span class="s3">const </span><span class="s1">{ </span><span class="s2">isColorSupported</span><span class="s1">, </span><span class="s2">cyan</span><span class="s1">, </span><span class="s2">red </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;colorette&quot;</span><span class="s1">);</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Compiler[&quot;options&quot;]} compilerOptions</span>
     <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{boolean}</span>
     <span class="s4">*/</span>
    <span class="s3">const </span><span class="s2">getColorsOption </span><span class="s1">= (</span><span class="s2">compilerOptions</span><span class="s1">) =&gt; {</span>
      <span class="s4">/**</span>
       <span class="s4">* </span><span class="s5">@type </span><span class="s4">{boolean}</span>
       <span class="s4">*/</span>
      <span class="s3">let </span><span class="s2">colorsEnabled</span><span class="s1">;</span>

      <span class="s3">if </span><span class="s1">(</span>
        <span class="s2">compilerOptions</span><span class="s1">.</span><span class="s2">stats </span><span class="s1">&amp;&amp;</span>
        <span class="s3">typeof </span><span class="s1">(</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{StatsOptions} */ </span><span class="s1">(</span><span class="s2">compilerOptions</span><span class="s1">.</span><span class="s2">stats</span><span class="s1">).</span><span class="s2">colors</span><span class="s1">) !==</span>
          <span class="s0">&quot;undefined&quot;</span>
      <span class="s1">) {</span>
        <span class="s2">colorsEnabled </span><span class="s1">=</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{boolean} */</span>
          <span class="s1">(</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{StatsOptions} */ </span><span class="s1">(</span><span class="s2">compilerOptions</span><span class="s1">.</span><span class="s2">stats</span><span class="s1">).</span><span class="s2">colors</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s2">colorsEnabled </span><span class="s1">= </span><span class="s2">isColorSupported</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s3">return </span><span class="s2">colorsEnabled</span><span class="s1">;</span>
    <span class="s1">};</span>

    <span class="s3">const </span><span class="s2">colors </span><span class="s1">= {</span>
      <span class="s4">/**</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{boolean} useColor</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{string} msg</span>
       <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{string}</span>
       <span class="s4">*/</span>
      <span class="s2">info</span><span class="s1">(</span><span class="s2">useColor</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">useColor</span><span class="s1">) {</span>
          <span class="s3">return </span><span class="s2">cyan</span><span class="s1">(</span><span class="s2">msg</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">return </span><span class="s2">msg</span><span class="s1">;</span>
      <span class="s1">},</span>
      <span class="s4">/**</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{boolean} useColor</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{string} msg</span>
       <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{string}</span>
       <span class="s4">*/</span>
      <span class="s2">error</span><span class="s1">(</span><span class="s2">useColor</span><span class="s1">, </span><span class="s2">msg</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">useColor</span><span class="s1">) {</span>
          <span class="s3">return </span><span class="s2">red</span><span class="s1">(</span><span class="s2">msg</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">return </span><span class="s2">msg</span><span class="s1">;</span>
      <span class="s1">},</span>
    <span class="s1">};</span>
    <span class="s3">const </span><span class="s2">useColor </span><span class="s1">= </span><span class="s2">getColorsOption</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">getCompilerOptions</span><span class="s1">());</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">ipc</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">logger</span><span class="s1">.</span><span class="s2">info</span><span class="s1">(</span>
        <span class="s0">`Project is running at: &quot;</span><span class="s2">$</span><span class="s1">{</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;http&quot;).Server} */</span>
          <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">server</span><span class="s1">).</span><span class="s2">address</span><span class="s1">()</span>
        <span class="s1">}</span><span class="s0">&quot;`</span>
      <span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">const </span><span class="s2">protocol </span><span class="s1">=</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ServerConfiguration} */</span>
        <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">server</span><span class="s1">).</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">&quot;http&quot; </span><span class="s1">? </span><span class="s0">&quot;http&quot; </span><span class="s1">: </span><span class="s0">&quot;https&quot;</span><span class="s1">;</span>
      <span class="s3">const </span><span class="s1">{ </span><span class="s2">address</span><span class="s1">, </span><span class="s2">port </span><span class="s1">} =</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;net&quot;).AddressInfo} */</span>
        <span class="s1">(</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;http&quot;).Server} */</span>
          <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">server</span><span class="s1">).</span><span class="s2">address</span><span class="s1">()</span>
        <span class="s1">);</span>
      <span class="s4">/**</span>
       <span class="s4">* </span><span class="s5">@param </span><span class="s4">{string} newHostname</span>
       <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{string}</span>
       <span class="s4">*/</span>
      <span class="s3">const </span><span class="s2">prettyPrintURL </span><span class="s1">= (</span><span class="s2">newHostname</span><span class="s1">) =&gt;</span>
        <span class="s2">url</span><span class="s1">.</span><span class="s2">format</span><span class="s1">({ </span><span class="s2">protocol</span><span class="s1">, </span><span class="s2">hostname</span><span class="s1">: </span><span class="s2">newHostname</span><span class="s1">, </span><span class="s2">port</span><span class="s1">, </span><span class="s2">pathname</span><span class="s1">: </span><span class="s0">&quot;/&quot; </span><span class="s1">});</span>

      <span class="s3">let </span><span class="s2">server</span><span class="s1">;</span>
      <span class="s3">let </span><span class="s2">localhost</span><span class="s1">;</span>
      <span class="s3">let </span><span class="s2">loopbackIPv4</span><span class="s1">;</span>
      <span class="s3">let </span><span class="s2">loopbackIPv6</span><span class="s1">;</span>
      <span class="s3">let </span><span class="s2">networkUrlIPv4</span><span class="s1">;</span>
      <span class="s3">let </span><span class="s2">networkUrlIPv6</span><span class="s1">;</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">host</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">host </span><span class="s1">=== </span><span class="s0">&quot;localhost&quot;</span><span class="s1">) {</span>
          <span class="s2">localhost </span><span class="s1">= </span><span class="s2">prettyPrintURL</span><span class="s1">(</span><span class="s0">&quot;localhost&quot;</span><span class="s1">);</span>
        <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
          <span class="s3">let </span><span class="s2">isIP</span><span class="s1">;</span>

          <span class="s3">try </span><span class="s1">{</span>
            <span class="s2">isIP </span><span class="s1">= </span><span class="s2">ipaddr</span><span class="s1">.</span><span class="s2">parse</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">host</span><span class="s1">);</span>
          <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) {</span>
            <span class="s6">// Ignore</span>
          <span class="s1">}</span>

          <span class="s3">if </span><span class="s1">(!</span><span class="s2">isIP</span><span class="s1">) {</span>
            <span class="s2">server </span><span class="s1">= </span><span class="s2">prettyPrintURL</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">host</span><span class="s1">);</span>
          <span class="s1">}</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s3">const </span><span class="s2">parsedIP </span><span class="s1">= </span><span class="s2">ipaddr</span><span class="s1">.</span><span class="s2">parse</span><span class="s1">(</span><span class="s2">address</span><span class="s1">);</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">parsedIP</span><span class="s1">.</span><span class="s2">range</span><span class="s1">() === </span><span class="s0">&quot;unspecified&quot;</span><span class="s1">) {</span>
        <span class="s2">localhost </span><span class="s1">= </span><span class="s2">prettyPrintURL</span><span class="s1">(</span><span class="s0">&quot;localhost&quot;</span><span class="s1">);</span>

        <span class="s3">const </span><span class="s2">networkIPv4 </span><span class="s1">= </span><span class="s2">Server</span><span class="s1">.</span><span class="s2">internalIPSync</span><span class="s1">(</span><span class="s0">&quot;v4&quot;</span><span class="s1">);</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">networkIPv4</span><span class="s1">) {</span>
          <span class="s2">networkUrlIPv4 </span><span class="s1">= </span><span class="s2">prettyPrintURL</span><span class="s1">(</span><span class="s2">networkIPv4</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s3">const </span><span class="s2">networkIPv6 </span><span class="s1">= </span><span class="s2">Server</span><span class="s1">.</span><span class="s2">internalIPSync</span><span class="s1">(</span><span class="s0">&quot;v6&quot;</span><span class="s1">);</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">networkIPv6</span><span class="s1">) {</span>
          <span class="s2">networkUrlIPv6 </span><span class="s1">= </span><span class="s2">prettyPrintURL</span><span class="s1">(</span><span class="s2">networkIPv6</span><span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">parsedIP</span><span class="s1">.</span><span class="s2">range</span><span class="s1">() === </span><span class="s0">&quot;loopback&quot;</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">parsedIP</span><span class="s1">.</span><span class="s2">kind</span><span class="s1">() === </span><span class="s0">&quot;ipv4&quot;</span><span class="s1">) {</span>
          <span class="s2">loopbackIPv4 </span><span class="s1">= </span><span class="s2">prettyPrintURL</span><span class="s1">(</span><span class="s2">parsedIP</span><span class="s1">.</span><span class="s2">toString</span><span class="s1">());</span>
        <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">parsedIP</span><span class="s1">.</span><span class="s2">kind</span><span class="s1">() === </span><span class="s0">&quot;ipv6&quot;</span><span class="s1">) {</span>
          <span class="s2">loopbackIPv6 </span><span class="s1">= </span><span class="s2">prettyPrintURL</span><span class="s1">(</span><span class="s2">parsedIP</span><span class="s1">.</span><span class="s2">toString</span><span class="s1">());</span>
        <span class="s1">}</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s2">networkUrlIPv4 </span><span class="s1">=</span>
          <span class="s2">parsedIP</span><span class="s1">.</span><span class="s2">kind</span><span class="s1">() === </span><span class="s0">&quot;ipv6&quot; </span><span class="s1">&amp;&amp;</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{IPv6} */</span>
          <span class="s1">(</span><span class="s2">parsedIP</span><span class="s1">).</span><span class="s2">isIPv4MappedAddress</span><span class="s1">()</span>
            <span class="s1">? </span><span class="s2">prettyPrintURL</span><span class="s1">(</span>
                <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{IPv6} */</span>
                <span class="s1">(</span><span class="s2">parsedIP</span><span class="s1">).</span><span class="s2">toIPv4Address</span><span class="s1">().</span><span class="s2">toString</span><span class="s1">()</span>
              <span class="s1">)</span>
            <span class="s1">: </span><span class="s2">prettyPrintURL</span><span class="s1">(</span><span class="s2">address</span><span class="s1">);</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">parsedIP</span><span class="s1">.</span><span class="s2">kind</span><span class="s1">() === </span><span class="s0">&quot;ipv6&quot;</span><span class="s1">) {</span>
          <span class="s2">networkUrlIPv6 </span><span class="s1">= </span><span class="s2">prettyPrintURL</span><span class="s1">(</span><span class="s2">address</span><span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s3">this</span><span class="s1">.</span><span class="s2">logger</span><span class="s1">.</span><span class="s2">info</span><span class="s1">(</span><span class="s0">&quot;Project is running at:&quot;</span><span class="s1">);</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">server</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">logger</span><span class="s1">.</span><span class="s2">info</span><span class="s1">(</span><span class="s0">`Server: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">colors</span><span class="s1">.</span><span class="s2">info</span><span class="s1">(</span><span class="s2">useColor</span><span class="s1">, </span><span class="s2">server</span><span class="s1">)}</span><span class="s0">`</span><span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">localhost </span><span class="s1">|| </span><span class="s2">loopbackIPv4 </span><span class="s1">|| </span><span class="s2">loopbackIPv6</span><span class="s1">) {</span>
        <span class="s3">const </span><span class="s2">loopbacks </span><span class="s1">= [];</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">localhost</span><span class="s1">) {</span>
          <span class="s2">loopbacks</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">colors</span><span class="s1">.</span><span class="s2">info</span><span class="s1">(</span><span class="s2">useColor</span><span class="s1">, </span><span class="s2">localhost</span><span class="s1">)]);</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">loopbackIPv4</span><span class="s1">) {</span>
          <span class="s2">loopbacks</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">colors</span><span class="s1">.</span><span class="s2">info</span><span class="s1">(</span><span class="s2">useColor</span><span class="s1">, </span><span class="s2">loopbackIPv4</span><span class="s1">)]);</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">loopbackIPv6</span><span class="s1">) {</span>
          <span class="s2">loopbacks</span><span class="s1">.</span><span class="s2">push</span><span class="s1">([</span><span class="s2">colors</span><span class="s1">.</span><span class="s2">info</span><span class="s1">(</span><span class="s2">useColor</span><span class="s1">, </span><span class="s2">loopbackIPv6</span><span class="s1">)]);</span>
        <span class="s1">}</span>

        <span class="s3">this</span><span class="s1">.</span><span class="s2">logger</span><span class="s1">.</span><span class="s2">info</span><span class="s1">(</span><span class="s0">`Loopback: </span><span class="s2">$</span><span class="s1">{</span><span class="s2">loopbacks</span><span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s0">&quot;, &quot;</span><span class="s1">)}</span><span class="s0">`</span><span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">networkUrlIPv4</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">logger</span><span class="s1">.</span><span class="s2">info</span><span class="s1">(</span>
          <span class="s0">`On Your Network (IPv4): </span><span class="s2">$</span><span class="s1">{</span><span class="s2">colors</span><span class="s1">.</span><span class="s2">info</span><span class="s1">(</span><span class="s2">useColor</span><span class="s1">, </span><span class="s2">networkUrlIPv4</span><span class="s1">)}</span><span class="s0">`</span>
        <span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">networkUrlIPv6</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">logger</span><span class="s1">.</span><span class="s2">info</span><span class="s1">(</span>
          <span class="s0">`On Your Network (IPv6): </span><span class="s2">$</span><span class="s1">{</span><span class="s2">colors</span><span class="s1">.</span><span class="s2">info</span><span class="s1">(</span><span class="s2">useColor</span><span class="s1">, </span><span class="s2">networkUrlIPv6</span><span class="s1">)}</span><span class="s0">`</span>
        <span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{NormalizedOpen[]} */ </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">open</span><span class="s1">).</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s8">0</span><span class="s1">) {</span>
        <span class="s3">const </span><span class="s2">openTarget </span><span class="s1">= </span><span class="s2">prettyPrintURL</span><span class="s1">(</span>
          <span class="s1">!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">host </span><span class="s1">||</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">host </span><span class="s1">=== </span><span class="s0">&quot;0.0.0.0&quot; </span><span class="s1">||</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">host </span><span class="s1">=== </span><span class="s0">&quot;::&quot;</span>
            <span class="s1">? </span><span class="s0">&quot;localhost&quot;</span>
            <span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">host</span>
        <span class="s1">);</span>

        <span class="s3">this</span><span class="s1">.</span><span class="s2">openBrowser</span><span class="s1">(</span><span class="s2">openTarget</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{NormalizedStatic[]} */ </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">static</span><span class="s1">).</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s8">0</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">logger</span><span class="s1">.</span><span class="s2">info</span><span class="s1">(</span>
        <span class="s0">`Content not from webpack is served from '</span><span class="s2">$</span><span class="s1">{</span><span class="s2">colors</span><span class="s1">.</span><span class="s2">info</span><span class="s1">(</span>
          <span class="s2">useColor</span><span class="s1">,</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{NormalizedStatic[]} */</span>
          <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">static</span><span class="s1">)</span>
            <span class="s1">.</span><span class="s2">map</span><span class="s1">((</span><span class="s2">staticOption</span><span class="s1">) =&gt; </span><span class="s2">staticOption</span><span class="s1">.</span><span class="s2">directory</span><span class="s1">)</span>
            <span class="s1">.</span><span class="s2">join</span><span class="s1">(</span><span class="s0">&quot;, &quot;</span><span class="s1">)</span>
        <span class="s1">)}</span><span class="s0">' directory`</span>
      <span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">historyApiFallback</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">logger</span><span class="s1">.</span><span class="s2">info</span><span class="s1">(</span>
        <span class="s0">`404s will fallback to '</span><span class="s2">$</span><span class="s1">{</span><span class="s2">colors</span><span class="s1">.</span><span class="s2">info</span><span class="s1">(</span>
          <span class="s2">useColor</span><span class="s1">,</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ConnectHistoryApiFallbackOptions} */ </span><span class="s1">(</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">historyApiFallback</span>
          <span class="s1">).</span><span class="s2">index </span><span class="s1">|| </span><span class="s0">&quot;/index.html&quot;</span>
        <span class="s1">)}</span><span class="s0">'`</span>
      <span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">bonjour</span><span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">bonjourProtocol </span><span class="s1">=</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{BonjourOptions} */</span>
        <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">bonjour</span><span class="s1">).</span><span class="s2">type </span><span class="s1">||</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ServerConfiguration} */</span>
        <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">server</span><span class="s1">).</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">&quot;http&quot;</span>
          <span class="s1">? </span><span class="s0">&quot;http&quot;</span>
          <span class="s1">: </span><span class="s0">&quot;https&quot;</span><span class="s1">;</span>

      <span class="s3">this</span><span class="s1">.</span><span class="s2">logger</span><span class="s1">.</span><span class="s2">info</span><span class="s1">(</span>
        <span class="s0">`Broadcasting &quot;</span><span class="s2">$</span><span class="s1">{</span><span class="s2">bonjourProtocol</span><span class="s1">}</span><span class="s0">&quot; with subtype of &quot;webpack&quot; via ZeroConf DNS (Bonjour)`</span>
      <span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Request} req</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Response} res</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{NextFunction} next</span>
   <span class="s4">*/</span>
  <span class="s2">setHeaders</span><span class="s1">(</span><span class="s2">req</span><span class="s1">, </span><span class="s2">res</span><span class="s1">, </span><span class="s2">next</span><span class="s1">) {</span>
    <span class="s3">let </span><span class="s1">{ </span><span class="s2">headers </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">headers</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">headers </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span><span class="s1">) {</span>
        <span class="s2">headers </span><span class="s1">= </span><span class="s2">headers</span><span class="s1">(</span>
          <span class="s2">req</span><span class="s1">,</span>
          <span class="s2">res</span><span class="s1">,</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;webpack-dev-middleware&quot;).API&lt;Request, Response&gt;}*/</span>
          <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">middleware</span><span class="s1">).</span><span class="s2">context</span>
        <span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s4">/**</span>
       <span class="s4">* </span><span class="s5">@type </span><span class="s4">{{key: string, value: string}[]}</span>
       <span class="s4">*/</span>
      <span class="s3">const </span><span class="s2">allHeaders </span><span class="s1">= [];</span>

      <span class="s3">if </span><span class="s1">(!</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">headers</span><span class="s1">)) {</span>
        <span class="s6">// eslint-disable-next-line guard-for-in</span>
        <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">name </span><span class="s3">in </span><span class="s2">headers</span><span class="s1">) {</span>
          <span class="s6">// @ts-ignore</span>
          <span class="s2">allHeaders</span><span class="s1">.</span><span class="s2">push</span><span class="s1">({ </span><span class="s2">key</span><span class="s1">: </span><span class="s2">name</span><span class="s1">, </span><span class="s2">value</span><span class="s1">: </span><span class="s2">headers</span><span class="s1">[</span><span class="s2">name</span><span class="s1">] });</span>
        <span class="s1">}</span>

        <span class="s2">headers </span><span class="s1">= </span><span class="s2">allHeaders</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s2">headers</span><span class="s1">.</span><span class="s2">forEach</span><span class="s1">(</span>
        <span class="s4">/**</span>
         <span class="s4">* </span><span class="s5">@param </span><span class="s4">{{key: string, value: any}} header</span>
         <span class="s4">*/</span>
        <span class="s1">(</span><span class="s2">header</span><span class="s1">) =&gt; {</span>
          <span class="s2">res</span><span class="s1">.</span><span class="s2">setHeader</span><span class="s1">(</span><span class="s2">header</span><span class="s1">.</span><span class="s2">key</span><span class="s1">, </span><span class="s2">header</span><span class="s1">.</span><span class="s2">value</span><span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s2">next</span><span class="s1">();</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{{ [key: string]: string | undefined }} headers</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{string} headerToCheck</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{boolean}</span>
   <span class="s4">*/</span>
  <span class="s2">checkHeader</span><span class="s1">(</span><span class="s2">headers</span><span class="s1">, </span><span class="s2">headerToCheck</span><span class="s1">) {</span>
    <span class="s6">// allow user to opt out of this security check, at their own risk</span>
    <span class="s6">// by explicitly enabling allowedHosts</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">allowedHosts </span><span class="s1">=== </span><span class="s0">&quot;all&quot;</span><span class="s1">) {</span>
      <span class="s3">return true</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s6">// get the Host header and extract hostname</span>
    <span class="s6">// we don't care about port not matching</span>
    <span class="s3">const </span><span class="s2">hostHeader </span><span class="s1">= </span><span class="s2">headers</span><span class="s1">[</span><span class="s2">headerToCheck</span><span class="s1">];</span>

    <span class="s3">if </span><span class="s1">(!</span><span class="s2">hostHeader</span><span class="s1">) {</span>
      <span class="s3">return false</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s7">/^(file|.+-extension):/i</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">hostHeader</span><span class="s1">)) {</span>
      <span class="s3">return true</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s6">// use the node url-parser to retrieve the hostname from the host-header.</span>
    <span class="s3">const </span><span class="s2">hostname </span><span class="s1">= </span><span class="s2">url</span><span class="s1">.</span><span class="s2">parse</span><span class="s1">(</span>
      <span class="s6">// if hostHeader doesn't have scheme, add // for parsing.</span>
      <span class="s7">/^(.+:)?\/\//</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">hostHeader</span><span class="s1">) ? </span><span class="s2">hostHeader </span><span class="s1">: </span><span class="s0">`//</span><span class="s2">$</span><span class="s1">{</span><span class="s2">hostHeader</span><span class="s1">}</span><span class="s0">`</span><span class="s1">,</span>
      <span class="s3">false</span><span class="s1">,</span>
      <span class="s3">true</span>
    <span class="s1">).</span><span class="s2">hostname</span><span class="s1">;</span>

    <span class="s6">// always allow requests with explicit IPv4 or IPv6-address.</span>
    <span class="s6">// A note on IPv6 addresses:</span>
    <span class="s6">// hostHeader will always contain the brackets denoting</span>
    <span class="s6">// an IPv6-address in URLs,</span>
    <span class="s6">// these are removed from the hostname in url.parse(),</span>
    <span class="s6">// so we have the pure IPv6-address in hostname.</span>
    <span class="s6">// For convenience, always allow localhost (hostname === 'localhost')</span>
    <span class="s6">// and its subdomains (hostname.endsWith(&quot;.localhost&quot;)).</span>
    <span class="s6">// allow hostname of listening address  (hostname === this.options.host)</span>
    <span class="s3">const </span><span class="s2">isValidHostname </span><span class="s1">=</span>
      <span class="s1">(</span><span class="s2">hostname </span><span class="s1">!== </span><span class="s3">null </span><span class="s1">&amp;&amp; </span><span class="s2">ipaddr</span><span class="s1">.</span><span class="s2">IPv4</span><span class="s1">.</span><span class="s2">isValid</span><span class="s1">(</span><span class="s2">hostname</span><span class="s1">)) ||</span>
      <span class="s1">(</span><span class="s2">hostname </span><span class="s1">!== </span><span class="s3">null </span><span class="s1">&amp;&amp; </span><span class="s2">ipaddr</span><span class="s1">.</span><span class="s2">IPv6</span><span class="s1">.</span><span class="s2">isValid</span><span class="s1">(</span><span class="s2">hostname</span><span class="s1">)) ||</span>
      <span class="s2">hostname </span><span class="s1">=== </span><span class="s0">&quot;localhost&quot; </span><span class="s1">||</span>
      <span class="s1">(</span><span class="s2">hostname </span><span class="s1">!== </span><span class="s3">null </span><span class="s1">&amp;&amp; </span><span class="s2">hostname</span><span class="s1">.</span><span class="s2">endsWith</span><span class="s1">(</span><span class="s0">&quot;.localhost&quot;</span><span class="s1">)) ||</span>
      <span class="s2">hostname </span><span class="s1">=== </span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">host</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">isValidHostname</span><span class="s1">) {</span>
      <span class="s3">return true</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">const </span><span class="s1">{ </span><span class="s2">allowedHosts </span><span class="s1">} = </span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">;</span>

    <span class="s6">// always allow localhost host, for convenience</span>
    <span class="s6">// allow if hostname is in allowedHosts</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">Array</span><span class="s1">.</span><span class="s2">isArray</span><span class="s1">(</span><span class="s2">allowedHosts</span><span class="s1">) &amp;&amp; </span><span class="s2">allowedHosts</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s8">0</span><span class="s1">) {</span>
      <span class="s3">for </span><span class="s1">(</span><span class="s3">let </span><span class="s2">hostIdx </span><span class="s1">= </span><span class="s8">0</span><span class="s1">; </span><span class="s2">hostIdx </span><span class="s1">&lt; </span><span class="s2">allowedHosts</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">hostIdx</span><span class="s1">++) {</span>
        <span class="s3">const </span><span class="s2">allowedHost </span><span class="s1">= </span><span class="s2">allowedHosts</span><span class="s1">[</span><span class="s2">hostIdx</span><span class="s1">];</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">allowedHost </span><span class="s1">=== </span><span class="s2">hostname</span><span class="s1">) {</span>
          <span class="s3">return true</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s6">// support &quot;.&quot; as a subdomain wildcard</span>
        <span class="s6">// e.g. &quot;.example.com&quot; will allow &quot;example.com&quot;, &quot;www.example.com&quot;, &quot;subdomain.example.com&quot;, etc</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">allowedHost</span><span class="s1">[</span><span class="s8">0</span><span class="s1">] === </span><span class="s0">&quot;.&quot;</span><span class="s1">) {</span>
          <span class="s6">// &quot;example.com&quot;  (hostname === allowedHost.substring(1))</span>
          <span class="s6">// &quot;*.example.com&quot;  (hostname.endsWith(allowedHost))</span>
          <span class="s3">if </span><span class="s1">(</span>
            <span class="s2">hostname </span><span class="s1">=== </span><span class="s2">allowedHost</span><span class="s1">.</span><span class="s2">substring</span><span class="s1">(</span><span class="s8">1</span><span class="s1">) ||</span>
            <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{string} */ </span><span class="s1">(</span><span class="s2">hostname</span><span class="s1">).</span><span class="s2">endsWith</span><span class="s1">(</span><span class="s2">allowedHost</span><span class="s1">)</span>
          <span class="s1">) {</span>
            <span class="s3">return true</span><span class="s1">;</span>
          <span class="s1">}</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s6">// Also allow if `client.webSocketURL.hostname` provided</span>
    <span class="s3">if </span><span class="s1">(</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">client </span><span class="s1">&amp;&amp;</span>
      <span class="s3">typeof </span><span class="s1">(</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ClientConfiguration} */ </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">).</span><span class="s2">webSocketURL</span>
      <span class="s1">) !== </span><span class="s0">&quot;undefined&quot;</span>
    <span class="s1">) {</span>
      <span class="s3">return </span><span class="s1">(</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{WebSocketURL} */</span>
        <span class="s1">(</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{ClientConfiguration} */ </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">client</span><span class="s1">).</span><span class="s2">webSocketURL</span><span class="s1">)</span>
          <span class="s1">.</span><span class="s2">hostname </span><span class="s1">=== </span><span class="s2">hostname</span>
      <span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s6">// disallow</span>
    <span class="s3">return false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{ClientConnection[]} clients</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{string} type</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{any} [data]</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{any} [params]</span>
   <span class="s4">*/</span>
  <span class="s6">// eslint-disable-next-line class-methods-use-this</span>
  <span class="s2">sendMessage</span><span class="s1">(</span><span class="s2">clients</span><span class="s1">, </span><span class="s2">type</span><span class="s1">, </span><span class="s2">data</span><span class="s1">, </span><span class="s2">params</span><span class="s1">) {</span>
    <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">client of clients</span><span class="s1">) {</span>
      <span class="s6">// `sockjs` uses `1` to indicate client is ready to accept data</span>
      <span class="s6">// `ws` uses `WebSocket.OPEN`, but it is mean `1` too</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">client</span><span class="s1">.</span><span class="s2">readyState </span><span class="s1">=== </span><span class="s8">1</span><span class="s1">) {</span>
        <span class="s2">client</span><span class="s1">.</span><span class="s2">send</span><span class="s1">(</span><span class="s2">JSON</span><span class="s1">.</span><span class="s2">stringify</span><span class="s1">({ </span><span class="s2">type</span><span class="s1">, </span><span class="s2">data</span><span class="s1">, </span><span class="s2">params </span><span class="s1">}));</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Request} req</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Response} res</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{NextFunction} next</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{void}</span>
   <span class="s4">*/</span>
  <span class="s2">serveMagicHtml</span><span class="s1">(</span><span class="s2">req</span><span class="s1">, </span><span class="s2">res</span><span class="s1">, </span><span class="s2">next</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">req</span><span class="s1">.</span><span class="s2">method </span><span class="s1">!== </span><span class="s0">&quot;GET&quot; </span><span class="s1">&amp;&amp; </span><span class="s2">req</span><span class="s1">.</span><span class="s2">method </span><span class="s1">!== </span><span class="s0">&quot;HEAD&quot;</span><span class="s1">) {</span>
      <span class="s3">return </span><span class="s2">next</span><span class="s1">();</span>
    <span class="s1">}</span>

    <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;webpack-dev-middleware&quot;).API&lt;Request, Response&gt;}*/</span>
    <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">middleware</span><span class="s1">).</span><span class="s2">waitUntilValid</span><span class="s1">(() =&gt; {</span>
      <span class="s3">const </span><span class="s2">_path </span><span class="s1">= </span><span class="s2">req</span><span class="s1">.</span><span class="s2">path</span><span class="s1">;</span>

      <span class="s3">try </span><span class="s1">{</span>
        <span class="s3">const </span><span class="s2">filename </span><span class="s1">=</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;webpack-dev-middleware&quot;).API&lt;Request, Response&gt;}*/</span>
          <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">middleware</span><span class="s1">).</span><span class="s2">getFilenameFromUrl</span><span class="s1">(</span><span class="s0">`</span><span class="s2">$</span><span class="s1">{</span><span class="s2">_path</span><span class="s1">}</span><span class="s0">.js`</span><span class="s1">);</span>
        <span class="s3">const </span><span class="s2">isFile </span><span class="s1">=</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{Compiler[&quot;outputFileSystem&quot;] &amp; { statSync: import(&quot;fs&quot;).StatSyncFn }}*/</span>
          <span class="s1">(</span>
            <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;webpack-dev-middleware&quot;).API&lt;Request, Response&gt;}*/</span>
            <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">middleware</span><span class="s1">).</span><span class="s2">context</span><span class="s1">.</span><span class="s2">outputFileSystem</span>
          <span class="s1">)</span>
            <span class="s1">.</span><span class="s2">statSync</span><span class="s1">(</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;fs&quot;).PathLike} */ </span><span class="s1">(</span><span class="s2">filename</span><span class="s1">))</span>
            <span class="s1">.</span><span class="s2">isFile</span><span class="s1">();</span>

        <span class="s3">if </span><span class="s1">(!</span><span class="s2">isFile</span><span class="s1">) {</span>
          <span class="s3">return </span><span class="s2">next</span><span class="s1">();</span>
        <span class="s1">}</span>

        <span class="s6">// Serve a page that executes the javascript</span>
        <span class="s6">// @ts-ignore</span>
        <span class="s3">const </span><span class="s2">queries </span><span class="s1">= </span><span class="s2">req</span><span class="s1">.</span><span class="s2">_parsedUrl</span><span class="s1">.</span><span class="s2">search </span><span class="s1">|| </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
        <span class="s3">const </span><span class="s2">responsePage </span><span class="s1">= </span><span class="s0">`&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset=&quot;utf-8&quot;/&gt;&lt;/head&gt;&lt;body&gt;&lt;script type=&quot;text/javascript&quot; charset=&quot;utf-8&quot; src=&quot;</span><span class="s2">$</span><span class="s1">{</span><span class="s2">_path</span><span class="s1">}</span><span class="s0">.js</span><span class="s2">$</span><span class="s1">{</span><span class="s2">queries</span><span class="s1">}</span><span class="s0">&quot;&gt;&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;`</span><span class="s1">;</span>

        <span class="s2">res</span><span class="s1">.</span><span class="s2">send</span><span class="s1">(</span><span class="s2">responsePage</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) {</span>
        <span class="s3">return </span><span class="s2">next</span><span class="s1">();</span>
      <span class="s1">}</span>
    <span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s6">// Send stats to a socket or multiple sockets</span>
  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@private</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{ClientConnection[]} clients</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{StatsCompilation} stats</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{boolean} [force]</span>
   <span class="s4">*/</span>
  <span class="s2">sendStats</span><span class="s1">(</span><span class="s2">clients</span><span class="s1">, </span><span class="s2">stats</span><span class="s1">, </span><span class="s2">force</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">shouldEmit </span><span class="s1">=</span>
      <span class="s1">!</span><span class="s2">force </span><span class="s1">&amp;&amp;</span>
      <span class="s2">stats </span><span class="s1">&amp;&amp;</span>
      <span class="s1">(!</span><span class="s2">stats</span><span class="s1">.</span><span class="s2">errors </span><span class="s1">|| </span><span class="s2">stats</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s8">0</span><span class="s1">) &amp;&amp;</span>
      <span class="s1">(!</span><span class="s2">stats</span><span class="s1">.</span><span class="s2">warnings </span><span class="s1">|| </span><span class="s2">stats</span><span class="s1">.</span><span class="s2">warnings</span><span class="s1">.</span><span class="s2">length </span><span class="s1">=== </span><span class="s8">0</span><span class="s1">) &amp;&amp;</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">currentHash </span><span class="s1">=== </span><span class="s2">stats</span><span class="s1">.</span><span class="s2">hash</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">shouldEmit</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">sendMessage</span><span class="s1">(</span><span class="s2">clients</span><span class="s1">, </span><span class="s0">&quot;still-ok&quot;</span><span class="s1">);</span>

      <span class="s3">return</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">currentHash </span><span class="s1">= </span><span class="s2">stats</span><span class="s1">.</span><span class="s2">hash</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">sendMessage</span><span class="s1">(</span><span class="s2">clients</span><span class="s1">, </span><span class="s0">&quot;hash&quot;</span><span class="s1">, </span><span class="s2">stats</span><span class="s1">.</span><span class="s2">hash</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(</span>
      <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{NonNullable&lt;StatsCompilation[&quot;errors&quot;]&gt;} */</span>
      <span class="s1">(</span><span class="s2">stats</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">).</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s8">0 </span><span class="s1">||</span>
      <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{NonNullable&lt;StatsCompilation[&quot;warnings&quot;]&gt;} */</span>
      <span class="s1">(</span><span class="s2">stats</span><span class="s1">.</span><span class="s2">warnings</span><span class="s1">).</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s8">0</span>
    <span class="s1">) {</span>
      <span class="s3">const </span><span class="s2">hasErrors </span><span class="s1">=</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{NonNullable&lt;StatsCompilation[&quot;errors&quot;]&gt;} */</span>
        <span class="s1">(</span><span class="s2">stats</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">).</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s8">0</span><span class="s1">;</span>

      <span class="s3">if </span><span class="s1">(</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{NonNullable&lt;StatsCompilation[&quot;warnings&quot;]&gt;} */</span>
        <span class="s1">(</span><span class="s2">stats</span><span class="s1">.</span><span class="s2">warnings</span><span class="s1">).</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s8">0</span>
      <span class="s1">) {</span>
        <span class="s3">let </span><span class="s2">params</span><span class="s1">;</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">hasErrors</span><span class="s1">) {</span>
          <span class="s2">params </span><span class="s1">= { </span><span class="s2">preventReloading</span><span class="s1">: </span><span class="s3">true </span><span class="s1">};</span>
        <span class="s1">}</span>

        <span class="s3">this</span><span class="s1">.</span><span class="s2">sendMessage</span><span class="s1">(</span><span class="s2">clients</span><span class="s1">, </span><span class="s0">&quot;warnings&quot;</span><span class="s1">, </span><span class="s2">stats</span><span class="s1">.</span><span class="s2">warnings</span><span class="s1">, </span><span class="s2">params</span><span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s3">if </span><span class="s1">(</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{NonNullable&lt;StatsCompilation[&quot;errors&quot;]&gt;} */ </span><span class="s1">(</span><span class="s2">stats</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">)</span>
          <span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s8">0</span>
      <span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">sendMessage</span><span class="s1">(</span><span class="s2">clients</span><span class="s1">, </span><span class="s0">&quot;errors&quot;</span><span class="s1">, </span><span class="s2">stats</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">sendMessage</span><span class="s1">(</span><span class="s2">clients</span><span class="s1">, </span><span class="s0">&quot;ok&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{string | string[]} watchPath</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{WatchOptions} [watchOptions]</span>
   <span class="s4">*/</span>
  <span class="s2">watchFiles</span><span class="s1">(</span><span class="s2">watchPath</span><span class="s1">, </span><span class="s2">watchOptions</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">chokidar </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;chokidar&quot;</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s2">watcher </span><span class="s1">= </span><span class="s2">chokidar</span><span class="s1">.</span><span class="s2">watch</span><span class="s1">(</span><span class="s2">watchPath</span><span class="s1">, </span><span class="s2">watchOptions</span><span class="s1">);</span>

    <span class="s6">// disabling refreshing on changing the content</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">liveReload</span><span class="s1">) {</span>
      <span class="s2">watcher</span><span class="s1">.</span><span class="s2">on</span><span class="s1">(</span><span class="s0">&quot;change&quot;</span><span class="s1">, (</span><span class="s2">item</span><span class="s1">) =&gt; {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">webSocketServer</span><span class="s1">) {</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">sendMessage</span><span class="s1">(</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">webSocketServer</span><span class="s1">.</span><span class="s2">clients</span><span class="s1">,</span>
            <span class="s0">&quot;static-changed&quot;</span><span class="s1">,</span>
            <span class="s2">item</span>
          <span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">});</span>
    <span class="s1">}</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">staticWatchers</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">watcher</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{import(&quot;webpack-dev-middleware&quot;).Callback} [callback]</span>
   <span class="s4">*/</span>
  <span class="s2">invalidate</span><span class="s1">(</span><span class="s2">callback </span><span class="s1">= () =&gt; {}) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">middleware</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">middleware</span><span class="s1">.</span><span class="s2">invalidate</span><span class="s1">(</span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{Promise&lt;void&gt;}</span>
   <span class="s4">*/</span>
  <span class="s2">async start</span><span class="s1">() {</span>
    <span class="s3">await this</span><span class="s1">.</span><span class="s2">normalizeOptions</span><span class="s1">();</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">ipc</span><span class="s1">) {</span>
      <span class="s3">await </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{Promise&lt;void&gt;} */ </span><span class="s1">(</span>
        <span class="s3">new </span><span class="s2">Promise</span><span class="s1">((</span><span class="s2">resolve</span><span class="s1">, </span><span class="s2">reject</span><span class="s1">) =&gt; {</span>
          <span class="s3">const </span><span class="s2">net </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;net&quot;</span><span class="s1">);</span>
          <span class="s3">const </span><span class="s2">socket </span><span class="s1">= </span><span class="s3">new </span><span class="s2">net</span><span class="s1">.</span><span class="s2">Socket</span><span class="s1">();</span>

          <span class="s2">socket</span><span class="s1">.</span><span class="s2">on</span><span class="s1">(</span>
            <span class="s0">&quot;error&quot;</span><span class="s1">,</span>
            <span class="s4">/**</span>
             <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Error &amp; { code?: string }} error</span>
             <span class="s4">*/</span>
            <span class="s1">(</span><span class="s2">error</span><span class="s1">) =&gt; {</span>
              <span class="s3">if </span><span class="s1">(</span><span class="s2">error</span><span class="s1">.</span><span class="s2">code </span><span class="s1">=== </span><span class="s0">&quot;ECONNREFUSED&quot;</span><span class="s1">) {</span>
                <span class="s6">// No other server listening on this socket, so it can be safely removed</span>
                <span class="s2">fs</span><span class="s1">.</span><span class="s2">unlinkSync</span><span class="s1">(</span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{string} */ </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">ipc</span><span class="s1">));</span>

                <span class="s2">resolve</span><span class="s1">();</span>

                <span class="s3">return</span><span class="s1">;</span>
              <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">error</span><span class="s1">.</span><span class="s2">code </span><span class="s1">=== </span><span class="s0">&quot;ENOENT&quot;</span><span class="s1">) {</span>
                <span class="s2">resolve</span><span class="s1">();</span>

                <span class="s3">return</span><span class="s1">;</span>
              <span class="s1">}</span>

              <span class="s2">reject</span><span class="s1">(</span><span class="s2">error</span><span class="s1">);</span>
            <span class="s1">}</span>
          <span class="s1">);</span>

          <span class="s2">socket</span><span class="s1">.</span><span class="s2">connect</span><span class="s1">(</span>
            <span class="s1">{ </span><span class="s2">path</span><span class="s1">: </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{string} */ </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">ipc</span><span class="s1">) },</span>
            <span class="s1">() =&gt; {</span>
              <span class="s3">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s0">`IPC &quot;</span><span class="s2">$</span><span class="s1">{</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">ipc</span><span class="s1">}</span><span class="s0">&quot; is already used`</span><span class="s1">);</span>
            <span class="s1">}</span>
          <span class="s1">);</span>
        <span class="s1">})</span>
      <span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">host </span><span class="s1">= </span><span class="s3">await </span><span class="s2">Server</span><span class="s1">.</span><span class="s2">getHostname</span><span class="s1">(</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{Host} */ </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">host</span><span class="s1">)</span>
      <span class="s1">);</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">port </span><span class="s1">= </span><span class="s3">await </span><span class="s2">Server</span><span class="s1">.</span><span class="s2">getFreePort</span><span class="s1">(</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{Port} */ </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">port</span><span class="s1">),</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">host</span>
      <span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">await this</span><span class="s1">.</span><span class="s2">initialize</span><span class="s1">();</span>

    <span class="s3">const </span><span class="s2">listenOptions </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">ipc</span>
      <span class="s1">? { </span><span class="s2">path</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">ipc </span><span class="s1">}</span>
      <span class="s1">: { </span><span class="s2">host</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">host</span><span class="s1">, </span><span class="s2">port</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">port </span><span class="s1">};</span>

    <span class="s3">await </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{Promise&lt;void&gt;} */ </span><span class="s1">(</span>
      <span class="s3">new </span><span class="s2">Promise</span><span class="s1">((</span><span class="s2">resolve</span><span class="s1">) =&gt; {</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;http&quot;).Server} */</span>
        <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">server</span><span class="s1">).</span><span class="s2">listen</span><span class="s1">(</span><span class="s2">listenOptions</span><span class="s1">, () =&gt; {</span>
          <span class="s2">resolve</span><span class="s1">();</span>
        <span class="s1">});</span>
      <span class="s1">})</span>
    <span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">ipc</span><span class="s1">) {</span>
      <span class="s6">// chmod 666 (rw rw rw)</span>
      <span class="s3">const </span><span class="s2">READ_WRITE </span><span class="s1">= </span><span class="s8">438</span><span class="s1">;</span>

      <span class="s3">await </span><span class="s2">fs</span><span class="s1">.</span><span class="s2">promises</span><span class="s1">.</span><span class="s2">chmod</span><span class="s1">(</span>
        <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{string} */ </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">ipc</span><span class="s1">),</span>
        <span class="s2">READ_WRITE</span>
      <span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">webSocketServer</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">createWebSocketServer</span><span class="s1">();</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">bonjour</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">runBonjour</span><span class="s1">();</span>
    <span class="s1">}</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">logStatus</span><span class="s1">();</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">onListening </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">onListening</span><span class="s1">(</span><span class="s3">this</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{(err?: Error) =&gt; void} [callback]</span>
   <span class="s4">*/</span>
  <span class="s2">startCallback</span><span class="s1">(</span><span class="s2">callback </span><span class="s1">= () =&gt; {}) {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">start</span><span class="s1">()</span>
      <span class="s1">.</span><span class="s2">then</span><span class="s1">(() =&gt; </span><span class="s2">callback</span><span class="s1">(), </span><span class="s2">callback</span><span class="s1">)</span>
      <span class="s1">.</span><span class="s2">catch</span><span class="s1">(</span><span class="s2">callback</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{Promise&lt;void&gt;}</span>
   <span class="s4">*/</span>
  <span class="s2">async stop</span><span class="s1">() {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">bonjour</span><span class="s1">) {</span>
      <span class="s3">await </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{Promise&lt;void&gt;} */ </span><span class="s1">(</span>
        <span class="s3">new </span><span class="s2">Promise</span><span class="s1">((</span><span class="s2">resolve</span><span class="s1">) =&gt; {</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s2">stopBonjour</span><span class="s1">(() =&gt; {</span>
            <span class="s2">resolve</span><span class="s1">();</span>
          <span class="s1">});</span>
        <span class="s1">})</span>
      <span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">webSocketProxies </span><span class="s1">= [];</span>

    <span class="s3">await </span><span class="s2">Promise</span><span class="s1">.</span><span class="s2">all</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">staticWatchers</span><span class="s1">.</span><span class="s2">map</span><span class="s1">((</span><span class="s2">watcher</span><span class="s1">) =&gt; </span><span class="s2">watcher</span><span class="s1">.</span><span class="s2">close</span><span class="s1">()));</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">staticWatchers </span><span class="s1">= [];</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">webSocketServer</span><span class="s1">) {</span>
      <span class="s3">await </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{Promise&lt;void&gt;} */ </span><span class="s1">(</span>
        <span class="s3">new </span><span class="s2">Promise</span><span class="s1">((</span><span class="s2">resolve</span><span class="s1">) =&gt; {</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{WebSocketServerImplementation} */</span>
          <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">webSocketServer</span><span class="s1">).</span><span class="s2">implementation</span><span class="s1">.</span><span class="s2">close</span><span class="s1">(() =&gt; {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">webSocketServer </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>

            <span class="s2">resolve</span><span class="s1">();</span>
          <span class="s1">});</span>

          <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">client of </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{WebSocketServerImplementation} */ </span><span class="s1">(</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">webSocketServer</span>
          <span class="s1">).</span><span class="s2">clients</span><span class="s1">) {</span>
            <span class="s2">client</span><span class="s1">.</span><span class="s2">terminate</span><span class="s1">();</span>
          <span class="s1">}</span>

          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{WebSocketServerImplementation} */</span>
          <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">webSocketServer</span><span class="s1">).</span><span class="s2">clients </span><span class="s1">= [];</span>
        <span class="s1">})</span>
      <span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">server</span><span class="s1">) {</span>
      <span class="s3">await </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{Promise&lt;void&gt;} */ </span><span class="s1">(</span>
        <span class="s3">new </span><span class="s2">Promise</span><span class="s1">((</span><span class="s2">resolve</span><span class="s1">) =&gt; {</span>
          <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;http&quot;).Server} */</span>
          <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">server</span><span class="s1">).</span><span class="s2">close</span><span class="s1">(() =&gt; {</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">server </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>

            <span class="s2">resolve</span><span class="s1">();</span>
          <span class="s1">});</span>

          <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">socket of </span><span class="s3">this</span><span class="s1">.</span><span class="s2">sockets</span><span class="s1">) {</span>
            <span class="s2">socket</span><span class="s1">.</span><span class="s2">destroy</span><span class="s1">();</span>
          <span class="s1">}</span>

          <span class="s3">this</span><span class="s1">.</span><span class="s2">sockets </span><span class="s1">= [];</span>
        <span class="s1">})</span>
      <span class="s1">);</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">middleware</span><span class="s1">) {</span>
        <span class="s3">await </span><span class="s4">/** </span><span class="s5">@type </span><span class="s4">{Promise&lt;void&gt;} */ </span><span class="s1">(</span>
          <span class="s3">new </span><span class="s2">Promise</span><span class="s1">((</span><span class="s2">resolve</span><span class="s1">, </span><span class="s2">reject</span><span class="s1">) =&gt; {</span>
            <span class="s4">/** </span><span class="s5">@type </span><span class="s4">{import(&quot;webpack-dev-middleware&quot;).API&lt;Request, Response&gt;}*/</span>
            <span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">middleware</span><span class="s1">).</span><span class="s2">close</span><span class="s1">((</span><span class="s2">error</span><span class="s1">) =&gt; {</span>
              <span class="s3">if </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) {</span>
                <span class="s2">reject</span><span class="s1">(</span><span class="s2">error</span><span class="s1">);</span>

                <span class="s3">return</span><span class="s1">;</span>
              <span class="s1">}</span>

              <span class="s2">resolve</span><span class="s1">();</span>
            <span class="s1">});</span>
          <span class="s1">})</span>
        <span class="s1">);</span>

        <span class="s3">this</span><span class="s1">.</span><span class="s2">middleware </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s6">// We add listeners to signals when creating a new Server instance</span>
    <span class="s6">// So ensure they are removed to prevent EventEmitter memory leak warnings</span>
    <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s2">item of </span><span class="s3">this</span><span class="s1">.</span><span class="s2">listeners</span><span class="s1">) {</span>
      <span class="s2">process</span><span class="s1">.</span><span class="s2">removeListener</span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">name</span><span class="s1">, </span><span class="s2">item</span><span class="s1">.</span><span class="s2">listener</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{(err?: Error) =&gt; void} [callback]</span>
   <span class="s4">*/</span>
  <span class="s2">stopCallback</span><span class="s1">(</span><span class="s2">callback </span><span class="s1">= () =&gt; {}) {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">stop</span><span class="s1">()</span>
      <span class="s1">.</span><span class="s2">then</span><span class="s1">(() =&gt; </span><span class="s2">callback</span><span class="s1">(), </span><span class="s2">callback</span><span class="s1">)</span>
      <span class="s1">.</span><span class="s2">catch</span><span class="s1">(</span><span class="s2">callback</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s6">// TODO remove in the next major release</span>
  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Port} port</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Host} hostname</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{(err?: Error) =&gt; void} fn</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{void}</span>
   <span class="s4">*/</span>
  <span class="s2">listen</span><span class="s1">(</span><span class="s2">port</span><span class="s1">, </span><span class="s2">hostname</span><span class="s1">, </span><span class="s2">fn</span><span class="s1">) {</span>
    <span class="s2">util</span><span class="s1">.</span><span class="s2">deprecate</span><span class="s1">(</span>
      <span class="s1">() =&gt; {},</span>
      <span class="s0">&quot;'listen' is deprecated. Please use the async 'start' or 'startCallback' method.&quot;</span><span class="s1">,</span>
      <span class="s0">&quot;DEP_WEBPACK_DEV_SERVER_LISTEN&quot;</span>
    <span class="s1">)();</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s2">port </span><span class="s1">=== </span><span class="s0">&quot;function&quot;</span><span class="s1">) {</span>
      <span class="s2">fn </span><span class="s1">= </span><span class="s2">port</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span>
      <span class="s3">typeof </span><span class="s2">port </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot; </span><span class="s1">&amp;&amp;</span>
      <span class="s3">typeof this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">port </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot; </span><span class="s1">&amp;&amp;</span>
      <span class="s2">port </span><span class="s1">!== </span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">port</span>
    <span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">port </span><span class="s1">= </span><span class="s2">port</span><span class="s1">;</span>

      <span class="s3">this</span><span class="s1">.</span><span class="s2">logger</span><span class="s1">.</span><span class="s2">warn</span><span class="s1">(</span>
        <span class="s0">'The &quot;port&quot; specified in options is different from the port passed as an argument. Will be used from arguments.'</span>
      <span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">port</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">port </span><span class="s1">= </span><span class="s2">port</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span>
      <span class="s3">typeof </span><span class="s2">hostname </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot; </span><span class="s1">&amp;&amp;</span>
      <span class="s3">typeof this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">host </span><span class="s1">!== </span><span class="s0">&quot;undefined&quot; </span><span class="s1">&amp;&amp;</span>
      <span class="s2">hostname </span><span class="s1">!== </span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">host</span>
    <span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">host </span><span class="s1">= </span><span class="s2">hostname</span><span class="s1">;</span>

      <span class="s3">this</span><span class="s1">.</span><span class="s2">logger</span><span class="s1">.</span><span class="s2">warn</span><span class="s1">(</span>
        <span class="s0">'The &quot;host&quot; specified in options is different from the host passed as an argument. Will be used from arguments.'</span>
      <span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">host</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s2">options</span><span class="s1">.</span><span class="s2">host </span><span class="s1">= </span><span class="s2">hostname</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">start</span><span class="s1">()</span>
      <span class="s1">.</span><span class="s2">then</span><span class="s1">(() =&gt; {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">fn</span><span class="s1">) {</span>
          <span class="s2">fn</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">server</span><span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">})</span>
      <span class="s1">.</span><span class="s2">catch</span><span class="s1">((</span><span class="s2">error</span><span class="s1">) =&gt; {</span>
        <span class="s6">// Nothing</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">fn</span><span class="s1">) {</span>
          <span class="s2">fn</span><span class="s1">.</span><span class="s2">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">server</span><span class="s1">, </span><span class="s2">error</span><span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* </span><span class="s5">@param </span><span class="s4">{(err?: Error) =&gt; void} [callback]</span>
   <span class="s4">* </span><span class="s5">@returns </span><span class="s4">{void}</span>
   <span class="s4">*/</span>
  <span class="s6">// TODO remove in the next major release</span>
  <span class="s2">close</span><span class="s1">(</span><span class="s2">callback</span><span class="s1">) {</span>
    <span class="s2">util</span><span class="s1">.</span><span class="s2">deprecate</span><span class="s1">(</span>
      <span class="s1">() =&gt; {},</span>
      <span class="s0">&quot;'close' is deprecated. Please use the async 'stop' or 'stopCallback' method.&quot;</span><span class="s1">,</span>
      <span class="s0">&quot;DEP_WEBPACK_DEV_SERVER_CLOSE&quot;</span>
    <span class="s1">)();</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">stop</span><span class="s1">()</span>
      <span class="s1">.</span><span class="s2">then</span><span class="s1">(() =&gt; {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">callback</span><span class="s1">) {</span>
          <span class="s2">callback</span><span class="s1">();</span>
        <span class="s1">}</span>
      <span class="s1">})</span>
      <span class="s1">.</span><span class="s2">catch</span><span class="s1">((</span><span class="s2">error</span><span class="s1">) =&gt; {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">callback</span><span class="s1">) {</span>
          <span class="s2">callback</span><span class="s1">(</span><span class="s2">error</span><span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">});</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s2">module</span><span class="s1">.</span><span class="s2">exports </span><span class="s1">= </span><span class="s2">Server</span><span class="s1">;</span>
</pre>
</body>
</html>