<html>
<head>
<title>web.structured-clone.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #6aab73;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #cf8e6d;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
web.structured-clone.js</font>
</center></td></tr></table>
<pre><span class="s0">'use strict'</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">IS_PURE </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/is-pure'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">$ </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/export'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">global </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/global'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">getBuiltIn </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/get-built-in'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">uncurryThis </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/function-uncurry-this'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">fails </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/fails'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">uid </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/uid'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">isCallable </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/is-callable'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">isConstructor </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/is-constructor'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">isNullOrUndefined </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/is-null-or-undefined'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">isObject </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/is-object'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">isSymbol </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/is-symbol'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">iterate </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/iterate'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">anObject </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/an-object'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">classof </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/classof'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">hasOwn </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/has-own-property'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">createProperty </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/create-property'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">createNonEnumerableProperty </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/create-non-enumerable-property'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">lengthOfArrayLike </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/length-of-array-like'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">validateArgumentsLength </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/validate-arguments-length'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">getRegExpFlags </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/regexp-get-flags'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">MapHelpers </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/map-helpers'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">SetHelpers </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/set-helpers'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">setIterate </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/set-iterate'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">detachTransferable </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/detach-transferable'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">ERROR_STACK_INSTALLABLE </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/error-stack-installable'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">PROPER_STRUCTURED_CLONE_TRANSFER </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../internals/structured-clone-proper-transfer'</span><span class="s1">);</span>

<span class="s3">var </span><span class="s2">Object </span><span class="s1">= </span><span class="s2">global</span><span class="s1">.</span><span class="s2">Object</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">Array </span><span class="s1">= </span><span class="s2">global</span><span class="s1">.</span><span class="s2">Array</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">Date </span><span class="s1">= </span><span class="s2">global</span><span class="s1">.</span><span class="s2">Date</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">Error </span><span class="s1">= </span><span class="s2">global</span><span class="s1">.</span><span class="s2">Error</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">TypeError </span><span class="s1">= </span><span class="s2">global</span><span class="s1">.</span><span class="s2">TypeError</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">PerformanceMark </span><span class="s1">= </span><span class="s2">global</span><span class="s1">.</span><span class="s2">PerformanceMark</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">DOMException </span><span class="s1">= </span><span class="s2">getBuiltIn</span><span class="s1">(</span><span class="s0">'DOMException'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">Map </span><span class="s1">= </span><span class="s2">MapHelpers</span><span class="s1">.</span><span class="s2">Map</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">mapHas </span><span class="s1">= </span><span class="s2">MapHelpers</span><span class="s1">.</span><span class="s2">has</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">mapGet </span><span class="s1">= </span><span class="s2">MapHelpers</span><span class="s1">.</span><span class="s2">get</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">mapSet </span><span class="s1">= </span><span class="s2">MapHelpers</span><span class="s1">.</span><span class="s2">set</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">Set </span><span class="s1">= </span><span class="s2">SetHelpers</span><span class="s1">.</span><span class="s2">Set</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">setAdd </span><span class="s1">= </span><span class="s2">SetHelpers</span><span class="s1">.</span><span class="s2">add</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">setHas </span><span class="s1">= </span><span class="s2">SetHelpers</span><span class="s1">.</span><span class="s2">has</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">objectKeys </span><span class="s1">= </span><span class="s2">getBuiltIn</span><span class="s1">(</span><span class="s0">'Object'</span><span class="s1">, </span><span class="s0">'keys'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">push </span><span class="s1">= </span><span class="s2">uncurryThis</span><span class="s1">([].</span><span class="s2">push</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">thisBooleanValue </span><span class="s1">= </span><span class="s2">uncurryThis</span><span class="s1">(</span><span class="s3">true</span><span class="s1">.</span><span class="s2">valueOf</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">thisNumberValue </span><span class="s1">= </span><span class="s2">uncurryThis</span><span class="s1">(</span><span class="s4">1.0</span><span class="s1">.</span><span class="s2">valueOf</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">thisStringValue </span><span class="s1">= </span><span class="s2">uncurryThis</span><span class="s1">(</span><span class="s0">''</span><span class="s1">.</span><span class="s2">valueOf</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">thisTimeValue </span><span class="s1">= </span><span class="s2">uncurryThis</span><span class="s1">(</span><span class="s2">Date</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">getTime</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">PERFORMANCE_MARK </span><span class="s1">= </span><span class="s2">uid</span><span class="s1">(</span><span class="s0">'structuredClone'</span><span class="s1">);</span>
<span class="s3">var </span><span class="s2">DATA_CLONE_ERROR </span><span class="s1">= </span><span class="s0">'DataCloneError'</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">TRANSFERRING </span><span class="s1">= </span><span class="s0">'Transferring'</span><span class="s1">;</span>

<span class="s3">var </span><span class="s2">checkBasicSemantic </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">structuredCloneImplementation</span><span class="s1">) {</span>
  <span class="s3">return </span><span class="s1">!</span><span class="s2">fails</span><span class="s1">(</span><span class="s3">function </span><span class="s1">() {</span>
    <span class="s3">var </span><span class="s2">set1 </span><span class="s1">= </span><span class="s3">new </span><span class="s2">global</span><span class="s1">.</span><span class="s2">Set</span><span class="s1">([</span><span class="s4">7</span><span class="s1">]);</span>
    <span class="s3">var </span><span class="s2">set2 </span><span class="s1">= </span><span class="s2">structuredCloneImplementation</span><span class="s1">(</span><span class="s2">set1</span><span class="s1">);</span>
    <span class="s3">var </span><span class="s2">number </span><span class="s1">= </span><span class="s2">structuredCloneImplementation</span><span class="s1">(</span><span class="s2">Object</span><span class="s1">(</span><span class="s4">7</span><span class="s1">));</span>
    <span class="s3">return </span><span class="s2">set2 </span><span class="s1">=== </span><span class="s2">set1 </span><span class="s1">|| !</span><span class="s2">set2</span><span class="s1">.</span><span class="s2">has</span><span class="s1">(</span><span class="s4">7</span><span class="s1">) || !</span><span class="s2">isObject</span><span class="s1">(</span><span class="s2">number</span><span class="s1">) || +</span><span class="s2">number </span><span class="s1">!== </span><span class="s4">7</span><span class="s1">;</span>
  <span class="s1">}) &amp;&amp; </span><span class="s2">structuredCloneImplementation</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s3">var </span><span class="s2">checkErrorsCloning </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">structuredCloneImplementation</span><span class="s1">, </span><span class="s2">$Error</span><span class="s1">) {</span>
  <span class="s3">return </span><span class="s1">!</span><span class="s2">fails</span><span class="s1">(</span><span class="s3">function </span><span class="s1">() {</span>
    <span class="s3">var </span><span class="s2">error </span><span class="s1">= </span><span class="s3">new </span><span class="s2">$Error</span><span class="s1">();</span>
    <span class="s3">var </span><span class="s2">test </span><span class="s1">= </span><span class="s2">structuredCloneImplementation</span><span class="s1">({ </span><span class="s2">a</span><span class="s1">: </span><span class="s2">error</span><span class="s1">, </span><span class="s2">b</span><span class="s1">: </span><span class="s2">error </span><span class="s1">});</span>
    <span class="s3">return </span><span class="s1">!(</span><span class="s2">test </span><span class="s1">&amp;&amp; </span><span class="s2">test</span><span class="s1">.</span><span class="s2">a </span><span class="s1">=== </span><span class="s2">test</span><span class="s1">.</span><span class="s2">b </span><span class="s1">&amp;&amp; </span><span class="s2">test</span><span class="s1">.</span><span class="s2">a </span><span class="s3">instanceof </span><span class="s2">$Error </span><span class="s1">&amp;&amp; </span><span class="s2">test</span><span class="s1">.</span><span class="s2">a</span><span class="s1">.</span><span class="s2">stack </span><span class="s1">=== </span><span class="s2">error</span><span class="s1">.</span><span class="s2">stack</span><span class="s1">);</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s5">// https://github.com/whatwg/html/pull/5749</span>
<span class="s3">var </span><span class="s2">checkNewErrorsCloningSemantic </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">structuredCloneImplementation</span><span class="s1">) {</span>
  <span class="s3">return </span><span class="s1">!</span><span class="s2">fails</span><span class="s1">(</span><span class="s3">function </span><span class="s1">() {</span>
    <span class="s3">var </span><span class="s2">test </span><span class="s1">= </span><span class="s2">structuredCloneImplementation</span><span class="s1">(</span><span class="s3">new </span><span class="s2">global</span><span class="s1">.</span><span class="s2">AggregateError</span><span class="s1">([</span><span class="s4">1</span><span class="s1">], </span><span class="s2">PERFORMANCE_MARK</span><span class="s1">, { </span><span class="s2">cause</span><span class="s1">: </span><span class="s4">3 </span><span class="s1">}));</span>
    <span class="s3">return </span><span class="s2">test</span><span class="s1">.</span><span class="s2">name </span><span class="s1">!== </span><span class="s0">'AggregateError' </span><span class="s1">|| </span><span class="s2">test</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] !== </span><span class="s4">1 </span><span class="s1">|| </span><span class="s2">test</span><span class="s1">.</span><span class="s2">message </span><span class="s1">!== </span><span class="s2">PERFORMANCE_MARK </span><span class="s1">|| </span><span class="s2">test</span><span class="s1">.</span><span class="s2">cause </span><span class="s1">!== </span><span class="s4">3</span><span class="s1">;</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s5">// FF94+, Safari 15.4+, Chrome 98+, NodeJS 17.0+, Deno 1.13+</span>
<span class="s5">// FF&lt;103 and Safari implementations can't clone errors</span>
<span class="s5">// https://bugzilla.mozilla.org/show_bug.cgi?id=1556604</span>
<span class="s5">// FF103 can clone errors, but `.stack` of clone is an empty string</span>
<span class="s5">// https://bugzilla.mozilla.org/show_bug.cgi?id=1778762</span>
<span class="s5">// FF104+ fixed it on usual errors, but not on DOMExceptions</span>
<span class="s5">// https://bugzilla.mozilla.org/show_bug.cgi?id=1777321</span>
<span class="s5">// Chrome &lt;102 returns `null` if cloned object contains multiple references to one error</span>
<span class="s5">// https://bugs.chromium.org/p/v8/issues/detail?id=12542</span>
<span class="s5">// NodeJS implementation can't clone DOMExceptions</span>
<span class="s5">// https://github.com/nodejs/node/issues/41038</span>
<span class="s5">// only FF103+ supports new (html/5749) error cloning semantic</span>
<span class="s3">var </span><span class="s2">nativeStructuredClone </span><span class="s1">= </span><span class="s2">global</span><span class="s1">.</span><span class="s2">structuredClone</span><span class="s1">;</span>

<span class="s3">var </span><span class="s2">FORCED_REPLACEMENT </span><span class="s1">= </span><span class="s2">IS_PURE</span>
  <span class="s1">|| !</span><span class="s2">checkErrorsCloning</span><span class="s1">(</span><span class="s2">nativeStructuredClone</span><span class="s1">, </span><span class="s2">Error</span><span class="s1">)</span>
  <span class="s1">|| !</span><span class="s2">checkErrorsCloning</span><span class="s1">(</span><span class="s2">nativeStructuredClone</span><span class="s1">, </span><span class="s2">DOMException</span><span class="s1">)</span>
  <span class="s1">|| !</span><span class="s2">checkNewErrorsCloningSemantic</span><span class="s1">(</span><span class="s2">nativeStructuredClone</span><span class="s1">);</span>

<span class="s5">// Chrome 82+, Safari 14.1+, Deno 1.11+</span>
<span class="s5">// Chrome 78-81 implementation swaps `.name` and `.message` of cloned `DOMException`</span>
<span class="s5">// Chrome returns `null` if cloned object contains multiple references to one error</span>
<span class="s5">// Safari 14.1 implementation doesn't clone some `RegExp` flags, so requires a workaround</span>
<span class="s5">// Safari implementation can't clone errors</span>
<span class="s5">// Deno 1.2-1.10 implementations too naive</span>
<span class="s5">// NodeJS 16.0+ does not have `PerformanceMark` constructor</span>
<span class="s5">// NodeJS &lt;17.2 structured cloning implementation from `performance.mark` is too naive</span>
<span class="s5">// and can't clone, for example, `RegExp` or some boxed primitives</span>
<span class="s5">// https://github.com/nodejs/node/issues/40840</span>
<span class="s5">// no one of those implementations supports new (html/5749) error cloning semantic</span>
<span class="s3">var </span><span class="s2">structuredCloneFromMark </span><span class="s1">= !</span><span class="s2">nativeStructuredClone </span><span class="s1">&amp;&amp; </span><span class="s2">checkBasicSemantic</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">value</span><span class="s1">) {</span>
  <span class="s3">return new </span><span class="s2">PerformanceMark</span><span class="s1">(</span><span class="s2">PERFORMANCE_MARK</span><span class="s1">, { </span><span class="s2">detail</span><span class="s1">: </span><span class="s2">value </span><span class="s1">}).</span><span class="s2">detail</span><span class="s1">;</span>
<span class="s1">});</span>

<span class="s3">var </span><span class="s2">nativeRestrictedStructuredClone </span><span class="s1">= </span><span class="s2">checkBasicSemantic</span><span class="s1">(</span><span class="s2">nativeStructuredClone</span><span class="s1">) || </span><span class="s2">structuredCloneFromMark</span><span class="s1">;</span>

<span class="s3">var </span><span class="s2">throwUncloneable </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">type</span><span class="s1">) {</span>
  <span class="s3">throw new </span><span class="s2">DOMException</span><span class="s1">(</span><span class="s0">'Uncloneable type: ' </span><span class="s1">+ </span><span class="s2">type</span><span class="s1">, </span><span class="s2">DATA_CLONE_ERROR</span><span class="s1">);</span>
<span class="s1">};</span>

<span class="s3">var </span><span class="s2">throwUnpolyfillable </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">type</span><span class="s1">, </span><span class="s2">action</span><span class="s1">) {</span>
  <span class="s3">throw new </span><span class="s2">DOMException</span><span class="s1">((</span><span class="s2">action </span><span class="s1">|| </span><span class="s0">'Cloning'</span><span class="s1">) + </span><span class="s0">' of ' </span><span class="s1">+ </span><span class="s2">type </span><span class="s1">+ </span><span class="s0">' cannot be properly polyfilled in this engine'</span><span class="s1">, </span><span class="s2">DATA_CLONE_ERROR</span><span class="s1">);</span>
<span class="s1">};</span>

<span class="s3">var </span><span class="s2">tryNativeRestrictedStructuredClone </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">value</span><span class="s1">, </span><span class="s2">type</span><span class="s1">) {</span>
  <span class="s3">if </span><span class="s1">(!</span><span class="s2">nativeRestrictedStructuredClone</span><span class="s1">) </span><span class="s2">throwUnpolyfillable</span><span class="s1">(</span><span class="s2">type</span><span class="s1">);</span>
  <span class="s3">return </span><span class="s2">nativeRestrictedStructuredClone</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>
<span class="s1">};</span>

<span class="s3">var </span><span class="s2">createDataTransfer </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {</span>
  <span class="s3">var </span><span class="s2">dataTransfer</span><span class="s1">;</span>
  <span class="s3">try </span><span class="s1">{</span>
    <span class="s2">dataTransfer </span><span class="s1">= </span><span class="s3">new </span><span class="s2">global</span><span class="s1">.</span><span class="s2">DataTransfer</span><span class="s1">();</span>
  <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) {</span>
    <span class="s3">try </span><span class="s1">{</span>
      <span class="s2">dataTransfer </span><span class="s1">= </span><span class="s3">new </span><span class="s2">global</span><span class="s1">.</span><span class="s2">ClipboardEvent</span><span class="s1">(</span><span class="s0">''</span><span class="s1">).</span><span class="s2">clipboardData</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">error2</span><span class="s1">) { </span><span class="s5">/* empty */ </span><span class="s1">}</span>
  <span class="s1">}</span>
  <span class="s3">return </span><span class="s2">dataTransfer </span><span class="s1">&amp;&amp; </span><span class="s2">dataTransfer</span><span class="s1">.</span><span class="s2">items </span><span class="s1">&amp;&amp; </span><span class="s2">dataTransfer</span><span class="s1">.</span><span class="s2">files </span><span class="s1">? </span><span class="s2">dataTransfer </span><span class="s1">: </span><span class="s3">null</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s3">var </span><span class="s2">cloneBuffer </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">value</span><span class="s1">, </span><span class="s2">map</span><span class="s1">, </span><span class="s2">$type</span><span class="s1">) {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">mapHas</span><span class="s1">(</span><span class="s2">map</span><span class="s1">, </span><span class="s2">value</span><span class="s1">)) </span><span class="s3">return </span><span class="s2">mapGet</span><span class="s1">(</span><span class="s2">map</span><span class="s1">, </span><span class="s2">value</span><span class="s1">);</span>

  <span class="s3">var </span><span class="s2">type </span><span class="s1">= </span><span class="s2">$type </span><span class="s1">|| </span><span class="s2">classof</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>
  <span class="s3">var </span><span class="s2">clone</span><span class="s1">, </span><span class="s2">length</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">source</span><span class="s1">, </span><span class="s2">target</span><span class="s1">, </span><span class="s2">i</span><span class="s1">;</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">'SharedArrayBuffer'</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">nativeRestrictedStructuredClone</span><span class="s1">) </span><span class="s2">clone </span><span class="s1">= </span><span class="s2">nativeRestrictedStructuredClone</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>
    <span class="s5">// SharedArrayBuffer should use shared memory, we can't polyfill it, so return the original</span>
    <span class="s3">else </span><span class="s2">clone </span><span class="s1">= </span><span class="s2">value</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s3">var </span><span class="s2">DataView </span><span class="s1">= </span><span class="s2">global</span><span class="s1">.</span><span class="s2">DataView</span><span class="s1">;</span>

    <span class="s5">// `ArrayBuffer#slice` is not available in IE10</span>
    <span class="s5">// `ArrayBuffer#slice` and `DataView` are not available in old FF</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s2">DataView </span><span class="s1">&amp;&amp; !</span><span class="s2">isCallable</span><span class="s1">(</span><span class="s2">value</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">)) </span><span class="s2">throwUnpolyfillable</span><span class="s1">(</span><span class="s0">'ArrayBuffer'</span><span class="s1">);</span>
    <span class="s5">// detached buffers throws in `DataView` and `.slice`</span>
    <span class="s3">try </span><span class="s1">{</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">isCallable</span><span class="s1">(</span><span class="s2">value</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">) &amp;&amp; !</span><span class="s2">value</span><span class="s1">.</span><span class="s2">resizable</span><span class="s1">) {</span>
        <span class="s2">clone </span><span class="s1">= </span><span class="s2">value</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s4">0</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s2">length </span><span class="s1">= </span><span class="s2">value</span><span class="s1">.</span><span class="s2">byteLength</span><span class="s1">;</span>
        <span class="s2">options </span><span class="s1">= </span><span class="s0">'maxByteLength' </span><span class="s3">in </span><span class="s2">value </span><span class="s1">? { </span><span class="s2">maxByteLength</span><span class="s1">: </span><span class="s2">value</span><span class="s1">.</span><span class="s2">maxByteLength </span><span class="s1">} : </span><span class="s2">undefined</span><span class="s1">;</span>
        <span class="s5">// eslint-disable-next-line es/no-resizable-and-growable-arraybuffers -- safe</span>
        <span class="s2">clone </span><span class="s1">= </span><span class="s3">new </span><span class="s2">ArrayBuffer</span><span class="s1">(</span><span class="s2">length</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
        <span class="s2">source </span><span class="s1">= </span><span class="s3">new </span><span class="s2">DataView</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>
        <span class="s2">target </span><span class="s1">= </span><span class="s3">new </span><span class="s2">DataView</span><span class="s1">(</span><span class="s2">clone</span><span class="s1">);</span>
        <span class="s3">for </span><span class="s1">(</span><span class="s2">i </span><span class="s1">= </span><span class="s4">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">length</span><span class="s1">; </span><span class="s2">i</span><span class="s1">++) {</span>
          <span class="s2">target</span><span class="s1">.</span><span class="s2">setUint8</span><span class="s1">(</span><span class="s2">i</span><span class="s1">, </span><span class="s2">source</span><span class="s1">.</span><span class="s2">getUint8</span><span class="s1">(</span><span class="s2">i</span><span class="s1">));</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) {</span>
      <span class="s3">throw new </span><span class="s2">DOMException</span><span class="s1">(</span><span class="s0">'ArrayBuffer is detached'</span><span class="s1">, </span><span class="s2">DATA_CLONE_ERROR</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">mapSet</span><span class="s1">(</span><span class="s2">map</span><span class="s1">, </span><span class="s2">value</span><span class="s1">, </span><span class="s2">clone</span><span class="s1">);</span>

  <span class="s3">return </span><span class="s2">clone</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s3">var </span><span class="s2">cloneView </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">value</span><span class="s1">, </span><span class="s2">type</span><span class="s1">, </span><span class="s2">offset</span><span class="s1">, </span><span class="s2">length</span><span class="s1">, </span><span class="s2">map</span><span class="s1">) {</span>
  <span class="s3">var </span><span class="s2">C </span><span class="s1">= </span><span class="s2">global</span><span class="s1">[</span><span class="s2">type</span><span class="s1">];</span>
  <span class="s5">// in some old engines like Safari 9, typeof C is 'object'</span>
  <span class="s5">// on Uint8ClampedArray or some other constructors</span>
  <span class="s3">if </span><span class="s1">(!</span><span class="s2">isObject</span><span class="s1">(</span><span class="s2">C</span><span class="s1">)) </span><span class="s2">throwUnpolyfillable</span><span class="s1">(</span><span class="s2">type</span><span class="s1">);</span>
  <span class="s3">return new </span><span class="s2">C</span><span class="s1">(</span><span class="s2">cloneBuffer</span><span class="s1">(</span><span class="s2">value</span><span class="s1">.</span><span class="s2">buffer</span><span class="s1">, </span><span class="s2">map</span><span class="s1">), </span><span class="s2">offset</span><span class="s1">, </span><span class="s2">length</span><span class="s1">);</span>
<span class="s1">};</span>

<span class="s3">var </span><span class="s2">structuredCloneInternal </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">value</span><span class="s1">, </span><span class="s2">map</span><span class="s1">) {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">isSymbol</span><span class="s1">(</span><span class="s2">value</span><span class="s1">)) </span><span class="s2">throwUncloneable</span><span class="s1">(</span><span class="s0">'Symbol'</span><span class="s1">);</span>
  <span class="s3">if </span><span class="s1">(!</span><span class="s2">isObject</span><span class="s1">(</span><span class="s2">value</span><span class="s1">)) </span><span class="s3">return </span><span class="s2">value</span><span class="s1">;</span>
  <span class="s5">// effectively preserves circular references</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s2">map</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">mapHas</span><span class="s1">(</span><span class="s2">map</span><span class="s1">, </span><span class="s2">value</span><span class="s1">)) </span><span class="s3">return </span><span class="s2">mapGet</span><span class="s1">(</span><span class="s2">map</span><span class="s1">, </span><span class="s2">value</span><span class="s1">);</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s2">map </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Map</span><span class="s1">();</span>

  <span class="s3">var </span><span class="s2">type </span><span class="s1">= </span><span class="s2">classof</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>
  <span class="s3">var </span><span class="s2">C</span><span class="s1">, </span><span class="s2">name</span><span class="s1">, </span><span class="s2">cloned</span><span class="s1">, </span><span class="s2">dataTransfer</span><span class="s1">, </span><span class="s2">i</span><span class="s1">, </span><span class="s2">length</span><span class="s1">, </span><span class="s2">keys</span><span class="s1">, </span><span class="s2">key</span><span class="s1">;</span>

  <span class="s3">switch </span><span class="s1">(</span><span class="s2">type</span><span class="s1">) {</span>
    <span class="s3">case </span><span class="s0">'Array'</span><span class="s1">:</span>
      <span class="s2">cloned </span><span class="s1">= </span><span class="s2">Array</span><span class="s1">(</span><span class="s2">lengthOfArrayLike</span><span class="s1">(</span><span class="s2">value</span><span class="s1">));</span>
      <span class="s3">break</span><span class="s1">;</span>
    <span class="s3">case </span><span class="s0">'Object'</span><span class="s1">:</span>
      <span class="s2">cloned </span><span class="s1">= {};</span>
      <span class="s3">break</span><span class="s1">;</span>
    <span class="s3">case </span><span class="s0">'Map'</span><span class="s1">:</span>
      <span class="s2">cloned </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Map</span><span class="s1">();</span>
      <span class="s3">break</span><span class="s1">;</span>
    <span class="s3">case </span><span class="s0">'Set'</span><span class="s1">:</span>
      <span class="s2">cloned </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Set</span><span class="s1">();</span>
      <span class="s3">break</span><span class="s1">;</span>
    <span class="s3">case </span><span class="s0">'RegExp'</span><span class="s1">:</span>
      <span class="s5">// in this block because of a Safari 14.1 bug</span>
      <span class="s5">// old FF does not clone regexes passed to the constructor, so get the source and flags directly</span>
      <span class="s2">cloned </span><span class="s1">= </span><span class="s3">new </span><span class="s2">RegExp</span><span class="s1">(</span><span class="s2">value</span><span class="s1">.</span><span class="s2">source</span><span class="s1">, </span><span class="s2">getRegExpFlags</span><span class="s1">(</span><span class="s2">value</span><span class="s1">));</span>
      <span class="s3">break</span><span class="s1">;</span>
    <span class="s3">case </span><span class="s0">'Error'</span><span class="s1">:</span>
      <span class="s2">name </span><span class="s1">= </span><span class="s2">value</span><span class="s1">.</span><span class="s2">name</span><span class="s1">;</span>
      <span class="s3">switch </span><span class="s1">(</span><span class="s2">name</span><span class="s1">) {</span>
        <span class="s3">case </span><span class="s0">'AggregateError'</span><span class="s1">:</span>
          <span class="s2">cloned </span><span class="s1">= </span><span class="s3">new </span><span class="s1">(</span><span class="s2">getBuiltIn</span><span class="s1">(</span><span class="s2">name</span><span class="s1">))([]);</span>
          <span class="s3">break</span><span class="s1">;</span>
        <span class="s3">case </span><span class="s0">'EvalError'</span><span class="s1">:</span>
        <span class="s3">case </span><span class="s0">'RangeError'</span><span class="s1">:</span>
        <span class="s3">case </span><span class="s0">'ReferenceError'</span><span class="s1">:</span>
        <span class="s3">case </span><span class="s0">'SuppressedError'</span><span class="s1">:</span>
        <span class="s3">case </span><span class="s0">'SyntaxError'</span><span class="s1">:</span>
        <span class="s3">case </span><span class="s0">'TypeError'</span><span class="s1">:</span>
        <span class="s3">case </span><span class="s0">'URIError'</span><span class="s1">:</span>
          <span class="s2">cloned </span><span class="s1">= </span><span class="s3">new </span><span class="s1">(</span><span class="s2">getBuiltIn</span><span class="s1">(</span><span class="s2">name</span><span class="s1">))();</span>
          <span class="s3">break</span><span class="s1">;</span>
        <span class="s3">case </span><span class="s0">'CompileError'</span><span class="s1">:</span>
        <span class="s3">case </span><span class="s0">'LinkError'</span><span class="s1">:</span>
        <span class="s3">case </span><span class="s0">'RuntimeError'</span><span class="s1">:</span>
          <span class="s2">cloned </span><span class="s1">= </span><span class="s3">new </span><span class="s1">(</span><span class="s2">getBuiltIn</span><span class="s1">(</span><span class="s0">'WebAssembly'</span><span class="s1">, </span><span class="s2">name</span><span class="s1">))();</span>
          <span class="s3">break</span><span class="s1">;</span>
        <span class="s3">default</span><span class="s1">:</span>
          <span class="s2">cloned </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Error</span><span class="s1">();</span>
      <span class="s1">}</span>
      <span class="s3">break</span><span class="s1">;</span>
    <span class="s3">case </span><span class="s0">'DOMException'</span><span class="s1">:</span>
      <span class="s2">cloned </span><span class="s1">= </span><span class="s3">new </span><span class="s2">DOMException</span><span class="s1">(</span><span class="s2">value</span><span class="s1">.</span><span class="s2">message</span><span class="s1">, </span><span class="s2">value</span><span class="s1">.</span><span class="s2">name</span><span class="s1">);</span>
      <span class="s3">break</span><span class="s1">;</span>
    <span class="s3">case </span><span class="s0">'ArrayBuffer'</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">'SharedArrayBuffer'</span><span class="s1">:</span>
      <span class="s2">cloned </span><span class="s1">= </span><span class="s2">cloneBuffer</span><span class="s1">(</span><span class="s2">value</span><span class="s1">, </span><span class="s2">map</span><span class="s1">, </span><span class="s2">type</span><span class="s1">);</span>
      <span class="s3">break</span><span class="s1">;</span>
    <span class="s3">case </span><span class="s0">'DataView'</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">'Int8Array'</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">'Uint8Array'</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">'Uint8ClampedArray'</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">'Int16Array'</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">'Uint16Array'</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">'Int32Array'</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">'Uint32Array'</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">'Float16Array'</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">'Float32Array'</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">'Float64Array'</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">'BigInt64Array'</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">'BigUint64Array'</span><span class="s1">:</span>
      <span class="s2">length </span><span class="s1">= </span><span class="s2">type </span><span class="s1">=== </span><span class="s0">'DataView' </span><span class="s1">? </span><span class="s2">value</span><span class="s1">.</span><span class="s2">byteLength </span><span class="s1">: </span><span class="s2">value</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>
      <span class="s2">cloned </span><span class="s1">= </span><span class="s2">cloneView</span><span class="s1">(</span><span class="s2">value</span><span class="s1">, </span><span class="s2">type</span><span class="s1">, </span><span class="s2">value</span><span class="s1">.</span><span class="s2">byteOffset</span><span class="s1">, </span><span class="s2">length</span><span class="s1">, </span><span class="s2">map</span><span class="s1">);</span>
      <span class="s3">break</span><span class="s1">;</span>
    <span class="s3">case </span><span class="s0">'DOMQuad'</span><span class="s1">:</span>
      <span class="s3">try </span><span class="s1">{</span>
        <span class="s2">cloned </span><span class="s1">= </span><span class="s3">new </span><span class="s2">DOMQuad</span><span class="s1">(</span>
          <span class="s2">structuredCloneInternal</span><span class="s1">(</span><span class="s2">value</span><span class="s1">.</span><span class="s2">p1</span><span class="s1">, </span><span class="s2">map</span><span class="s1">),</span>
          <span class="s2">structuredCloneInternal</span><span class="s1">(</span><span class="s2">value</span><span class="s1">.</span><span class="s2">p2</span><span class="s1">, </span><span class="s2">map</span><span class="s1">),</span>
          <span class="s2">structuredCloneInternal</span><span class="s1">(</span><span class="s2">value</span><span class="s1">.</span><span class="s2">p3</span><span class="s1">, </span><span class="s2">map</span><span class="s1">),</span>
          <span class="s2">structuredCloneInternal</span><span class="s1">(</span><span class="s2">value</span><span class="s1">.</span><span class="s2">p4</span><span class="s1">, </span><span class="s2">map</span><span class="s1">)</span>
        <span class="s1">);</span>
      <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) {</span>
        <span class="s2">cloned </span><span class="s1">= </span><span class="s2">tryNativeRestrictedStructuredClone</span><span class="s1">(</span><span class="s2">value</span><span class="s1">, </span><span class="s2">type</span><span class="s1">);</span>
      <span class="s1">}</span>
      <span class="s3">break</span><span class="s1">;</span>
    <span class="s3">case </span><span class="s0">'File'</span><span class="s1">:</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">nativeRestrictedStructuredClone</span><span class="s1">) </span><span class="s3">try </span><span class="s1">{</span>
        <span class="s2">cloned </span><span class="s1">= </span><span class="s2">nativeRestrictedStructuredClone</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>
        <span class="s5">// NodeJS 20.0.0 bug, https://github.com/nodejs/node/issues/47612</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">classof</span><span class="s1">(</span><span class="s2">cloned</span><span class="s1">) !== </span><span class="s2">type</span><span class="s1">) </span><span class="s2">cloned </span><span class="s1">= </span><span class="s2">undefined</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) { </span><span class="s5">/* empty */ </span><span class="s1">}</span>
      <span class="s3">if </span><span class="s1">(!</span><span class="s2">cloned</span><span class="s1">) </span><span class="s3">try </span><span class="s1">{</span>
        <span class="s2">cloned </span><span class="s1">= </span><span class="s3">new </span><span class="s2">File</span><span class="s1">([</span><span class="s2">value</span><span class="s1">], </span><span class="s2">value</span><span class="s1">.</span><span class="s2">name</span><span class="s1">, </span><span class="s2">value</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) { </span><span class="s5">/* empty */ </span><span class="s1">}</span>
      <span class="s3">if </span><span class="s1">(!</span><span class="s2">cloned</span><span class="s1">) </span><span class="s2">throwUnpolyfillable</span><span class="s1">(</span><span class="s2">type</span><span class="s1">);</span>
      <span class="s3">break</span><span class="s1">;</span>
    <span class="s3">case </span><span class="s0">'FileList'</span><span class="s1">:</span>
      <span class="s2">dataTransfer </span><span class="s1">= </span><span class="s2">createDataTransfer</span><span class="s1">();</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">dataTransfer</span><span class="s1">) {</span>
        <span class="s3">for </span><span class="s1">(</span><span class="s2">i </span><span class="s1">= </span><span class="s4">0</span><span class="s1">, </span><span class="s2">length </span><span class="s1">= </span><span class="s2">lengthOfArrayLike</span><span class="s1">(</span><span class="s2">value</span><span class="s1">); </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">length</span><span class="s1">; </span><span class="s2">i</span><span class="s1">++) {</span>
          <span class="s2">dataTransfer</span><span class="s1">.</span><span class="s2">items</span><span class="s1">.</span><span class="s2">add</span><span class="s1">(</span><span class="s2">structuredCloneInternal</span><span class="s1">(</span><span class="s2">value</span><span class="s1">[</span><span class="s2">i</span><span class="s1">], </span><span class="s2">map</span><span class="s1">));</span>
        <span class="s1">}</span>
        <span class="s2">cloned </span><span class="s1">= </span><span class="s2">dataTransfer</span><span class="s1">.</span><span class="s2">files</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s2">cloned </span><span class="s1">= </span><span class="s2">tryNativeRestrictedStructuredClone</span><span class="s1">(</span><span class="s2">value</span><span class="s1">, </span><span class="s2">type</span><span class="s1">);</span>
      <span class="s3">break</span><span class="s1">;</span>
    <span class="s3">case </span><span class="s0">'ImageData'</span><span class="s1">:</span>
      <span class="s5">// Safari 9 ImageData is a constructor, but typeof ImageData is 'object'</span>
      <span class="s3">try </span><span class="s1">{</span>
        <span class="s2">cloned </span><span class="s1">= </span><span class="s3">new </span><span class="s2">ImageData</span><span class="s1">(</span>
          <span class="s2">structuredCloneInternal</span><span class="s1">(</span><span class="s2">value</span><span class="s1">.</span><span class="s2">data</span><span class="s1">, </span><span class="s2">map</span><span class="s1">),</span>
          <span class="s2">value</span><span class="s1">.</span><span class="s2">width</span><span class="s1">,</span>
          <span class="s2">value</span><span class="s1">.</span><span class="s2">height</span><span class="s1">,</span>
          <span class="s1">{ </span><span class="s2">colorSpace</span><span class="s1">: </span><span class="s2">value</span><span class="s1">.</span><span class="s2">colorSpace </span><span class="s1">}</span>
        <span class="s1">);</span>
      <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) {</span>
        <span class="s2">cloned </span><span class="s1">= </span><span class="s2">tryNativeRestrictedStructuredClone</span><span class="s1">(</span><span class="s2">value</span><span class="s1">, </span><span class="s2">type</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s3">break</span><span class="s1">;</span>
    <span class="s3">default</span><span class="s1">:</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">nativeRestrictedStructuredClone</span><span class="s1">) {</span>
        <span class="s2">cloned </span><span class="s1">= </span><span class="s2">nativeRestrictedStructuredClone</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s3">else switch </span><span class="s1">(</span><span class="s2">type</span><span class="s1">) {</span>
        <span class="s3">case </span><span class="s0">'BigInt'</span><span class="s1">:</span>
          <span class="s5">// can be a 3rd party polyfill</span>
          <span class="s2">cloned </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">(</span><span class="s2">value</span><span class="s1">.</span><span class="s2">valueOf</span><span class="s1">());</span>
          <span class="s3">break</span><span class="s1">;</span>
        <span class="s3">case </span><span class="s0">'Boolean'</span><span class="s1">:</span>
          <span class="s2">cloned </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">(</span><span class="s2">thisBooleanValue</span><span class="s1">(</span><span class="s2">value</span><span class="s1">));</span>
          <span class="s3">break</span><span class="s1">;</span>
        <span class="s3">case </span><span class="s0">'Number'</span><span class="s1">:</span>
          <span class="s2">cloned </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">(</span><span class="s2">thisNumberValue</span><span class="s1">(</span><span class="s2">value</span><span class="s1">));</span>
          <span class="s3">break</span><span class="s1">;</span>
        <span class="s3">case </span><span class="s0">'String'</span><span class="s1">:</span>
          <span class="s2">cloned </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">(</span><span class="s2">thisStringValue</span><span class="s1">(</span><span class="s2">value</span><span class="s1">));</span>
          <span class="s3">break</span><span class="s1">;</span>
        <span class="s3">case </span><span class="s0">'Date'</span><span class="s1">:</span>
          <span class="s2">cloned </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Date</span><span class="s1">(</span><span class="s2">thisTimeValue</span><span class="s1">(</span><span class="s2">value</span><span class="s1">));</span>
          <span class="s3">break</span><span class="s1">;</span>
        <span class="s3">case </span><span class="s0">'Blob'</span><span class="s1">:</span>
          <span class="s3">try </span><span class="s1">{</span>
            <span class="s2">cloned </span><span class="s1">= </span><span class="s2">value</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">value</span><span class="s1">.</span><span class="s2">size</span><span class="s1">, </span><span class="s2">value</span><span class="s1">.</span><span class="s2">type</span><span class="s1">);</span>
          <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) {</span>
            <span class="s2">throwUnpolyfillable</span><span class="s1">(</span><span class="s2">type</span><span class="s1">);</span>
          <span class="s1">} </span><span class="s3">break</span><span class="s1">;</span>
        <span class="s3">case </span><span class="s0">'DOMPoint'</span><span class="s1">:</span>
        <span class="s3">case </span><span class="s0">'DOMPointReadOnly'</span><span class="s1">:</span>
          <span class="s2">C </span><span class="s1">= </span><span class="s2">global</span><span class="s1">[</span><span class="s2">type</span><span class="s1">];</span>
          <span class="s3">try </span><span class="s1">{</span>
            <span class="s2">cloned </span><span class="s1">= </span><span class="s2">C</span><span class="s1">.</span><span class="s2">fromPoint</span>
              <span class="s1">? </span><span class="s2">C</span><span class="s1">.</span><span class="s2">fromPoint</span><span class="s1">(</span><span class="s2">value</span><span class="s1">)</span>
              <span class="s1">: </span><span class="s3">new </span><span class="s2">C</span><span class="s1">(</span><span class="s2">value</span><span class="s1">.</span><span class="s2">x</span><span class="s1">, </span><span class="s2">value</span><span class="s1">.</span><span class="s2">y</span><span class="s1">, </span><span class="s2">value</span><span class="s1">.</span><span class="s2">z</span><span class="s1">, </span><span class="s2">value</span><span class="s1">.</span><span class="s2">w</span><span class="s1">);</span>
          <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) {</span>
            <span class="s2">throwUnpolyfillable</span><span class="s1">(</span><span class="s2">type</span><span class="s1">);</span>
          <span class="s1">} </span><span class="s3">break</span><span class="s1">;</span>
        <span class="s3">case </span><span class="s0">'DOMRect'</span><span class="s1">:</span>
        <span class="s3">case </span><span class="s0">'DOMRectReadOnly'</span><span class="s1">:</span>
          <span class="s2">C </span><span class="s1">= </span><span class="s2">global</span><span class="s1">[</span><span class="s2">type</span><span class="s1">];</span>
          <span class="s3">try </span><span class="s1">{</span>
            <span class="s2">cloned </span><span class="s1">= </span><span class="s2">C</span><span class="s1">.</span><span class="s2">fromRect</span>
              <span class="s1">? </span><span class="s2">C</span><span class="s1">.</span><span class="s2">fromRect</span><span class="s1">(</span><span class="s2">value</span><span class="s1">)</span>
              <span class="s1">: </span><span class="s3">new </span><span class="s2">C</span><span class="s1">(</span><span class="s2">value</span><span class="s1">.</span><span class="s2">x</span><span class="s1">, </span><span class="s2">value</span><span class="s1">.</span><span class="s2">y</span><span class="s1">, </span><span class="s2">value</span><span class="s1">.</span><span class="s2">width</span><span class="s1">, </span><span class="s2">value</span><span class="s1">.</span><span class="s2">height</span><span class="s1">);</span>
          <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) {</span>
            <span class="s2">throwUnpolyfillable</span><span class="s1">(</span><span class="s2">type</span><span class="s1">);</span>
          <span class="s1">} </span><span class="s3">break</span><span class="s1">;</span>
        <span class="s3">case </span><span class="s0">'DOMMatrix'</span><span class="s1">:</span>
        <span class="s3">case </span><span class="s0">'DOMMatrixReadOnly'</span><span class="s1">:</span>
          <span class="s2">C </span><span class="s1">= </span><span class="s2">global</span><span class="s1">[</span><span class="s2">type</span><span class="s1">];</span>
          <span class="s3">try </span><span class="s1">{</span>
            <span class="s2">cloned </span><span class="s1">= </span><span class="s2">C</span><span class="s1">.</span><span class="s2">fromMatrix</span>
              <span class="s1">? </span><span class="s2">C</span><span class="s1">.</span><span class="s2">fromMatrix</span><span class="s1">(</span><span class="s2">value</span><span class="s1">)</span>
              <span class="s1">: </span><span class="s3">new </span><span class="s2">C</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>
          <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) {</span>
            <span class="s2">throwUnpolyfillable</span><span class="s1">(</span><span class="s2">type</span><span class="s1">);</span>
          <span class="s1">} </span><span class="s3">break</span><span class="s1">;</span>
        <span class="s3">case </span><span class="s0">'AudioData'</span><span class="s1">:</span>
        <span class="s3">case </span><span class="s0">'VideoFrame'</span><span class="s1">:</span>
          <span class="s3">if </span><span class="s1">(!</span><span class="s2">isCallable</span><span class="s1">(</span><span class="s2">value</span><span class="s1">.</span><span class="s2">clone</span><span class="s1">)) </span><span class="s2">throwUnpolyfillable</span><span class="s1">(</span><span class="s2">type</span><span class="s1">);</span>
          <span class="s3">try </span><span class="s1">{</span>
            <span class="s2">cloned </span><span class="s1">= </span><span class="s2">value</span><span class="s1">.</span><span class="s2">clone</span><span class="s1">();</span>
          <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) {</span>
            <span class="s2">throwUncloneable</span><span class="s1">(</span><span class="s2">type</span><span class="s1">);</span>
          <span class="s1">} </span><span class="s3">break</span><span class="s1">;</span>
        <span class="s3">case </span><span class="s0">'CropTarget'</span><span class="s1">:</span>
        <span class="s3">case </span><span class="s0">'CryptoKey'</span><span class="s1">:</span>
        <span class="s3">case </span><span class="s0">'FileSystemDirectoryHandle'</span><span class="s1">:</span>
        <span class="s3">case </span><span class="s0">'FileSystemFileHandle'</span><span class="s1">:</span>
        <span class="s3">case </span><span class="s0">'FileSystemHandle'</span><span class="s1">:</span>
        <span class="s3">case </span><span class="s0">'GPUCompilationInfo'</span><span class="s1">:</span>
        <span class="s3">case </span><span class="s0">'GPUCompilationMessage'</span><span class="s1">:</span>
        <span class="s3">case </span><span class="s0">'ImageBitmap'</span><span class="s1">:</span>
        <span class="s3">case </span><span class="s0">'RTCCertificate'</span><span class="s1">:</span>
        <span class="s3">case </span><span class="s0">'WebAssembly.Module'</span><span class="s1">:</span>
          <span class="s2">throwUnpolyfillable</span><span class="s1">(</span><span class="s2">type</span><span class="s1">);</span>
          <span class="s5">// break omitted</span>
        <span class="s3">default</span><span class="s1">:</span>
          <span class="s2">throwUncloneable</span><span class="s1">(</span><span class="s2">type</span><span class="s1">);</span>
      <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">mapSet</span><span class="s1">(</span><span class="s2">map</span><span class="s1">, </span><span class="s2">value</span><span class="s1">, </span><span class="s2">cloned</span><span class="s1">);</span>

  <span class="s3">switch </span><span class="s1">(</span><span class="s2">type</span><span class="s1">) {</span>
    <span class="s3">case </span><span class="s0">'Array'</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">'Object'</span><span class="s1">:</span>
      <span class="s2">keys </span><span class="s1">= </span><span class="s2">objectKeys</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>
      <span class="s3">for </span><span class="s1">(</span><span class="s2">i </span><span class="s1">= </span><span class="s4">0</span><span class="s1">, </span><span class="s2">length </span><span class="s1">= </span><span class="s2">lengthOfArrayLike</span><span class="s1">(</span><span class="s2">keys</span><span class="s1">); </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">length</span><span class="s1">; </span><span class="s2">i</span><span class="s1">++) {</span>
        <span class="s2">key </span><span class="s1">= </span><span class="s2">keys</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>
        <span class="s2">createProperty</span><span class="s1">(</span><span class="s2">cloned</span><span class="s1">, </span><span class="s2">key</span><span class="s1">, </span><span class="s2">structuredCloneInternal</span><span class="s1">(</span><span class="s2">value</span><span class="s1">[</span><span class="s2">key</span><span class="s1">], </span><span class="s2">map</span><span class="s1">));</span>
      <span class="s1">} </span><span class="s3">break</span><span class="s1">;</span>
    <span class="s3">case </span><span class="s0">'Map'</span><span class="s1">:</span>
      <span class="s2">value</span><span class="s1">.</span><span class="s2">forEach</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">v</span><span class="s1">, </span><span class="s2">k</span><span class="s1">) {</span>
        <span class="s2">mapSet</span><span class="s1">(</span><span class="s2">cloned</span><span class="s1">, </span><span class="s2">structuredCloneInternal</span><span class="s1">(</span><span class="s2">k</span><span class="s1">, </span><span class="s2">map</span><span class="s1">), </span><span class="s2">structuredCloneInternal</span><span class="s1">(</span><span class="s2">v</span><span class="s1">, </span><span class="s2">map</span><span class="s1">));</span>
      <span class="s1">});</span>
      <span class="s3">break</span><span class="s1">;</span>
    <span class="s3">case </span><span class="s0">'Set'</span><span class="s1">:</span>
      <span class="s2">value</span><span class="s1">.</span><span class="s2">forEach</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">v</span><span class="s1">) {</span>
        <span class="s2">setAdd</span><span class="s1">(</span><span class="s2">cloned</span><span class="s1">, </span><span class="s2">structuredCloneInternal</span><span class="s1">(</span><span class="s2">v</span><span class="s1">, </span><span class="s2">map</span><span class="s1">));</span>
      <span class="s1">});</span>
      <span class="s3">break</span><span class="s1">;</span>
    <span class="s3">case </span><span class="s0">'Error'</span><span class="s1">:</span>
      <span class="s2">createNonEnumerableProperty</span><span class="s1">(</span><span class="s2">cloned</span><span class="s1">, </span><span class="s0">'message'</span><span class="s1">, </span><span class="s2">structuredCloneInternal</span><span class="s1">(</span><span class="s2">value</span><span class="s1">.</span><span class="s2">message</span><span class="s1">, </span><span class="s2">map</span><span class="s1">));</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">hasOwn</span><span class="s1">(</span><span class="s2">value</span><span class="s1">, </span><span class="s0">'cause'</span><span class="s1">)) {</span>
        <span class="s2">createNonEnumerableProperty</span><span class="s1">(</span><span class="s2">cloned</span><span class="s1">, </span><span class="s0">'cause'</span><span class="s1">, </span><span class="s2">structuredCloneInternal</span><span class="s1">(</span><span class="s2">value</span><span class="s1">.</span><span class="s2">cause</span><span class="s1">, </span><span class="s2">map</span><span class="s1">));</span>
      <span class="s1">}</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">name </span><span class="s1">=== </span><span class="s0">'AggregateError'</span><span class="s1">) {</span>
        <span class="s2">cloned</span><span class="s1">.</span><span class="s2">errors </span><span class="s1">= </span><span class="s2">structuredCloneInternal</span><span class="s1">(</span><span class="s2">value</span><span class="s1">.</span><span class="s2">errors</span><span class="s1">, </span><span class="s2">map</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">name </span><span class="s1">=== </span><span class="s0">'SuppressedError'</span><span class="s1">) {</span>
        <span class="s2">cloned</span><span class="s1">.</span><span class="s2">error </span><span class="s1">= </span><span class="s2">structuredCloneInternal</span><span class="s1">(</span><span class="s2">value</span><span class="s1">.</span><span class="s2">error</span><span class="s1">, </span><span class="s2">map</span><span class="s1">);</span>
        <span class="s2">cloned</span><span class="s1">.</span><span class="s2">suppressed </span><span class="s1">= </span><span class="s2">structuredCloneInternal</span><span class="s1">(</span><span class="s2">value</span><span class="s1">.</span><span class="s2">suppressed</span><span class="s1">, </span><span class="s2">map</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s5">// break omitted</span>
    <span class="s3">case </span><span class="s0">'DOMException'</span><span class="s1">:</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">ERROR_STACK_INSTALLABLE</span><span class="s1">) {</span>
        <span class="s2">createNonEnumerableProperty</span><span class="s1">(</span><span class="s2">cloned</span><span class="s1">, </span><span class="s0">'stack'</span><span class="s1">, </span><span class="s2">structuredCloneInternal</span><span class="s1">(</span><span class="s2">value</span><span class="s1">.</span><span class="s2">stack</span><span class="s1">, </span><span class="s2">map</span><span class="s1">));</span>
      <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s2">cloned</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s3">var </span><span class="s2">tryToTransfer </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">rawTransfer</span><span class="s1">, </span><span class="s2">map</span><span class="s1">) {</span>
  <span class="s3">if </span><span class="s1">(!</span><span class="s2">isObject</span><span class="s1">(</span><span class="s2">rawTransfer</span><span class="s1">)) </span><span class="s3">throw new </span><span class="s2">TypeError</span><span class="s1">(</span><span class="s0">'Transfer option cannot be converted to a sequence'</span><span class="s1">);</span>

  <span class="s3">var </span><span class="s2">transfer </span><span class="s1">= [];</span>

  <span class="s2">iterate</span><span class="s1">(</span><span class="s2">rawTransfer</span><span class="s1">, </span><span class="s3">function </span><span class="s1">(</span><span class="s2">value</span><span class="s1">) {</span>
    <span class="s2">push</span><span class="s1">(</span><span class="s2">transfer</span><span class="s1">, </span><span class="s2">anObject</span><span class="s1">(</span><span class="s2">value</span><span class="s1">));</span>
  <span class="s1">});</span>

  <span class="s3">var </span><span class="s2">i </span><span class="s1">= </span><span class="s4">0</span><span class="s1">;</span>
  <span class="s3">var </span><span class="s2">length </span><span class="s1">= </span><span class="s2">lengthOfArrayLike</span><span class="s1">(</span><span class="s2">transfer</span><span class="s1">);</span>
  <span class="s3">var </span><span class="s2">buffers </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Set</span><span class="s1">();</span>
  <span class="s3">var </span><span class="s2">value</span><span class="s1">, </span><span class="s2">type</span><span class="s1">, </span><span class="s2">C</span><span class="s1">, </span><span class="s2">transferred</span><span class="s1">, </span><span class="s2">canvas</span><span class="s1">, </span><span class="s2">context</span><span class="s1">;</span>

  <span class="s3">while </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">length</span><span class="s1">) {</span>
    <span class="s2">value </span><span class="s1">= </span><span class="s2">transfer</span><span class="s1">[</span><span class="s2">i</span><span class="s1">++];</span>

    <span class="s2">type </span><span class="s1">= </span><span class="s2">classof</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">'ArrayBuffer' </span><span class="s1">? </span><span class="s2">setHas</span><span class="s1">(</span><span class="s2">buffers</span><span class="s1">, </span><span class="s2">value</span><span class="s1">) : </span><span class="s2">mapHas</span><span class="s1">(</span><span class="s2">map</span><span class="s1">, </span><span class="s2">value</span><span class="s1">)) {</span>
      <span class="s3">throw new </span><span class="s2">DOMException</span><span class="s1">(</span><span class="s0">'Duplicate transferable'</span><span class="s1">, </span><span class="s2">DATA_CLONE_ERROR</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">'ArrayBuffer'</span><span class="s1">) {</span>
      <span class="s2">setAdd</span><span class="s1">(</span><span class="s2">buffers</span><span class="s1">, </span><span class="s2">value</span><span class="s1">);</span>
      <span class="s3">continue</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">PROPER_STRUCTURED_CLONE_TRANSFER</span><span class="s1">) {</span>
      <span class="s2">transferred </span><span class="s1">= </span><span class="s2">nativeStructuredClone</span><span class="s1">(</span><span class="s2">value</span><span class="s1">, { </span><span class="s2">transfer</span><span class="s1">: [</span><span class="s2">value</span><span class="s1">] });</span>
    <span class="s1">} </span><span class="s3">else switch </span><span class="s1">(</span><span class="s2">type</span><span class="s1">) {</span>
      <span class="s3">case </span><span class="s0">'ImageBitmap'</span><span class="s1">:</span>
        <span class="s2">C </span><span class="s1">= </span><span class="s2">global</span><span class="s1">.</span><span class="s2">OffscreenCanvas</span><span class="s1">;</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">isConstructor</span><span class="s1">(</span><span class="s2">C</span><span class="s1">)) </span><span class="s2">throwUnpolyfillable</span><span class="s1">(</span><span class="s2">type</span><span class="s1">, </span><span class="s2">TRANSFERRING</span><span class="s1">);</span>
        <span class="s3">try </span><span class="s1">{</span>
          <span class="s2">canvas </span><span class="s1">= </span><span class="s3">new </span><span class="s2">C</span><span class="s1">(</span><span class="s2">value</span><span class="s1">.</span><span class="s2">width</span><span class="s1">, </span><span class="s2">value</span><span class="s1">.</span><span class="s2">height</span><span class="s1">);</span>
          <span class="s2">context </span><span class="s1">= </span><span class="s2">canvas</span><span class="s1">.</span><span class="s2">getContext</span><span class="s1">(</span><span class="s0">'bitmaprenderer'</span><span class="s1">);</span>
          <span class="s2">context</span><span class="s1">.</span><span class="s2">transferFromImageBitmap</span><span class="s1">(</span><span class="s2">value</span><span class="s1">);</span>
          <span class="s2">transferred </span><span class="s1">= </span><span class="s2">canvas</span><span class="s1">.</span><span class="s2">transferToImageBitmap</span><span class="s1">();</span>
        <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) { </span><span class="s5">/* empty */ </span><span class="s1">}</span>
        <span class="s3">break</span><span class="s1">;</span>
      <span class="s3">case </span><span class="s0">'AudioData'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'VideoFrame'</span><span class="s1">:</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">isCallable</span><span class="s1">(</span><span class="s2">value</span><span class="s1">.</span><span class="s2">clone</span><span class="s1">) || !</span><span class="s2">isCallable</span><span class="s1">(</span><span class="s2">value</span><span class="s1">.</span><span class="s2">close</span><span class="s1">)) </span><span class="s2">throwUnpolyfillable</span><span class="s1">(</span><span class="s2">type</span><span class="s1">, </span><span class="s2">TRANSFERRING</span><span class="s1">);</span>
        <span class="s3">try </span><span class="s1">{</span>
          <span class="s2">transferred </span><span class="s1">= </span><span class="s2">value</span><span class="s1">.</span><span class="s2">clone</span><span class="s1">();</span>
          <span class="s2">value</span><span class="s1">.</span><span class="s2">close</span><span class="s1">();</span>
        <span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s2">error</span><span class="s1">) { </span><span class="s5">/* empty */ </span><span class="s1">}</span>
        <span class="s3">break</span><span class="s1">;</span>
      <span class="s3">case </span><span class="s0">'MediaSourceHandle'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'MessagePort'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'OffscreenCanvas'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'ReadableStream'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'TransformStream'</span><span class="s1">:</span>
      <span class="s3">case </span><span class="s0">'WritableStream'</span><span class="s1">:</span>
        <span class="s2">throwUnpolyfillable</span><span class="s1">(</span><span class="s2">type</span><span class="s1">, </span><span class="s2">TRANSFERRING</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">transferred </span><span class="s1">=== </span><span class="s2">undefined</span><span class="s1">) </span><span class="s3">throw new </span><span class="s2">DOMException</span><span class="s1">(</span><span class="s0">'This object cannot be transferred: ' </span><span class="s1">+ </span><span class="s2">type</span><span class="s1">, </span><span class="s2">DATA_CLONE_ERROR</span><span class="s1">);</span>

    <span class="s2">mapSet</span><span class="s1">(</span><span class="s2">map</span><span class="s1">, </span><span class="s2">value</span><span class="s1">, </span><span class="s2">transferred</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s2">buffers</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s3">var </span><span class="s2">detachBuffers </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s2">buffers</span><span class="s1">) {</span>
  <span class="s2">setIterate</span><span class="s1">(</span><span class="s2">buffers</span><span class="s1">, </span><span class="s3">function </span><span class="s1">(</span><span class="s2">buffer</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">PROPER_STRUCTURED_CLONE_TRANSFER</span><span class="s1">) {</span>
      <span class="s2">nativeRestrictedStructuredClone</span><span class="s1">(</span><span class="s2">buffer</span><span class="s1">, { </span><span class="s2">transfer</span><span class="s1">: [</span><span class="s2">buffer</span><span class="s1">] });</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">isCallable</span><span class="s1">(</span><span class="s2">buffer</span><span class="s1">.</span><span class="s2">transfer</span><span class="s1">)) {</span>
      <span class="s2">buffer</span><span class="s1">.</span><span class="s2">transfer</span><span class="s1">();</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">detachTransferable</span><span class="s1">) {</span>
      <span class="s2">detachTransferable</span><span class="s1">(</span><span class="s2">buffer</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s2">throwUnpolyfillable</span><span class="s1">(</span><span class="s0">'ArrayBuffer'</span><span class="s1">, </span><span class="s2">TRANSFERRING</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s5">// `structuredClone` method</span>
<span class="s5">// https://html.spec.whatwg.org/multipage/structured-data.html#dom-structuredclone</span>
<span class="s2">$</span><span class="s1">({ </span><span class="s2">global</span><span class="s1">: </span><span class="s3">true</span><span class="s1">, </span><span class="s2">enumerable</span><span class="s1">: </span><span class="s3">true</span><span class="s1">, </span><span class="s2">sham</span><span class="s1">: !</span><span class="s2">PROPER_STRUCTURED_CLONE_TRANSFER</span><span class="s1">, </span><span class="s2">forced</span><span class="s1">: </span><span class="s2">FORCED_REPLACEMENT </span><span class="s1">}, {</span>
  <span class="s2">structuredClone</span><span class="s1">: </span><span class="s3">function </span><span class="s2">structuredClone</span><span class="s1">(</span><span class="s2">value </span><span class="s5">/* , { transfer } */</span><span class="s1">) {</span>
    <span class="s3">var </span><span class="s2">options </span><span class="s1">= </span><span class="s2">validateArgumentsLength</span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">.</span><span class="s2">length</span><span class="s1">, </span><span class="s4">1</span><span class="s1">) &gt; </span><span class="s4">1 </span><span class="s1">&amp;&amp; !</span><span class="s2">isNullOrUndefined</span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">[</span><span class="s4">1</span><span class="s1">]) ? </span><span class="s2">anObject</span><span class="s1">(</span><span class="s2">arguments</span><span class="s1">[</span><span class="s4">1</span><span class="s1">]) : </span><span class="s2">undefined</span><span class="s1">;</span>
    <span class="s3">var </span><span class="s2">transfer </span><span class="s1">= </span><span class="s2">options </span><span class="s1">? </span><span class="s2">options</span><span class="s1">.</span><span class="s2">transfer </span><span class="s1">: </span><span class="s2">undefined</span><span class="s1">;</span>
    <span class="s3">var </span><span class="s2">map</span><span class="s1">, </span><span class="s2">buffers</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">transfer </span><span class="s1">!== </span><span class="s2">undefined</span><span class="s1">) {</span>
      <span class="s2">map </span><span class="s1">= </span><span class="s3">new </span><span class="s2">Map</span><span class="s1">();</span>
      <span class="s2">buffers </span><span class="s1">= </span><span class="s2">tryToTransfer</span><span class="s1">(</span><span class="s2">transfer</span><span class="s1">, </span><span class="s2">map</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">var </span><span class="s2">clone </span><span class="s1">= </span><span class="s2">structuredCloneInternal</span><span class="s1">(</span><span class="s2">value</span><span class="s1">, </span><span class="s2">map</span><span class="s1">);</span>

    <span class="s5">// since of an issue with cloning views of transferred buffers, we a forced to detach them later</span>
    <span class="s5">// https://github.com/zloirock/core-js/issues/1265</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">buffers</span><span class="s1">) </span><span class="s2">detachBuffers</span><span class="s1">(</span><span class="s2">buffers</span><span class="s1">);</span>

    <span class="s3">return </span><span class="s2">clone</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">});</span>
</pre>
</body>
</html>