<html>
<head>
<title>jsbn.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
jsbn.js</font>
</center></td></tr></table>
<pre><span class="s0">// Copyright (c) 2005  Tom Wu</span>
<span class="s0">// All Rights Reserved.</span>
<span class="s0">// See &quot;LICENSE&quot; for details.</span>

<span class="s0">// Basic JavaScript BN library - subset useful for RSA encryption.</span>

<span class="s0">/* 
Licensing (LICENSE) 
------------------- 
 
This software is covered under the following copyright: 
*/</span>
<span class="s0">/* 
 * Copyright (c) 2003-2005  Tom Wu 
 * All Rights Reserved. 
 * 
 * Permission is hereby granted, free of charge, to any person obtaining 
 * a copy of this software and associated documentation files (the 
 * &quot;Software&quot;), to deal in the Software without restriction, including 
 * without limitation the rights to use, copy, modify, merge, publish, 
 * distribute, sublicense, and/or sell copies of the Software, and to 
 * permit persons to whom the Software is furnished to do so, subject to 
 * the following conditions: 
 * 
 * The above copyright notice and this permission notice shall be 
 * included in all copies or substantial portions of the Software. 
 * 
 * THE SOFTWARE IS PROVIDED &quot;AS-IS&quot; AND WITHOUT WARRANTY OF ANY KIND, 
 * EXPRESS, IMPLIED OR OTHERWISE, INCLUDING WITHOUT LIMITATION, ANY 
 * WARRANTY OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. 
 * 
 * IN NO EVENT SHALL TOM WU BE LIABLE FOR ANY SPECIAL, INCIDENTAL, 
 * INDIRECT OR CONSEQUENTIAL DAMAGES OF ANY KIND, OR ANY DAMAGES WHATSOEVER 
 * RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER OR NOT ADVISED OF 
 * THE POSSIBILITY OF DAMAGE, AND ON ANY THEORY OF LIABILITY, ARISING OUT 
 * OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE. 
 * 
 * In addition, the following condition applies: 
 * 
 * All redistributions must retain an intact copy of this copyright notice 
 * and disclaimer. 
 */</span>
<span class="s0">/* 
Address all questions regarding this license to: 
 
  Tom Wu 
  tjw@cs.Stanford.EDU 
*/</span>
<span class="s2">var </span><span class="s1">forge </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s4">'./forge'</span><span class="s3">);</span>

<span class="s1">module</span><span class="s3">.</span><span class="s1">exports </span><span class="s3">= </span><span class="s1">forge</span><span class="s3">.</span><span class="s1">jsbn </span><span class="s3">= </span><span class="s1">forge</span><span class="s3">.</span><span class="s1">jsbn </span><span class="s3">|| {};</span>

<span class="s0">// Bits per digit</span>
<span class="s2">var </span><span class="s1">dbits</span><span class="s3">;</span>

<span class="s0">// JavaScript engine analysis</span>
<span class="s2">var </span><span class="s1">canary </span><span class="s3">= </span><span class="s5">0xdeadbeefcafe</span><span class="s3">;</span>
<span class="s2">var </span><span class="s1">j_lm </span><span class="s3">= ((</span><span class="s1">canary</span><span class="s3">&amp;</span><span class="s5">0xffffff</span><span class="s3">)==</span><span class="s5">0xefcafe</span><span class="s3">);</span>

<span class="s0">// (public) Constructor</span>
<span class="s2">function </span><span class="s1">BigInteger</span><span class="s3">(</span><span class="s1">a</span><span class="s3">,</span><span class="s1">b</span><span class="s3">,</span><span class="s1">c</span><span class="s3">) {</span>
  <span class="s2">this</span><span class="s3">.</span><span class="s1">data </span><span class="s3">= [];</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">a </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">)</span>
    <span class="s2">if</span><span class="s3">(</span><span class="s4">&quot;number&quot; </span><span class="s3">== </span><span class="s2">typeof </span><span class="s1">a</span><span class="s3">) </span><span class="s2">this</span><span class="s3">.</span><span class="s1">fromNumber</span><span class="s3">(</span><span class="s1">a</span><span class="s3">,</span><span class="s1">b</span><span class="s3">,</span><span class="s1">c</span><span class="s3">);</span>
    <span class="s2">else if</span><span class="s3">(</span><span class="s1">b </span><span class="s3">== </span><span class="s2">null </span><span class="s3">&amp;&amp; </span><span class="s4">&quot;string&quot; </span><span class="s3">!= </span><span class="s2">typeof </span><span class="s1">a</span><span class="s3">) </span><span class="s2">this</span><span class="s3">.</span><span class="s1">fromString</span><span class="s3">(</span><span class="s1">a</span><span class="s3">,</span><span class="s5">256</span><span class="s3">);</span>
    <span class="s2">else this</span><span class="s3">.</span><span class="s1">fromString</span><span class="s3">(</span><span class="s1">a</span><span class="s3">,</span><span class="s1">b</span><span class="s3">);</span>
<span class="s3">}</span>
<span class="s1">forge</span><span class="s3">.</span><span class="s1">jsbn</span><span class="s3">.</span><span class="s1">BigInteger </span><span class="s3">= </span><span class="s1">BigInteger</span><span class="s3">;</span>

<span class="s0">// return new, unset BigInteger</span>
<span class="s2">function </span><span class="s1">nbi</span><span class="s3">() { </span><span class="s2">return new </span><span class="s1">BigInteger</span><span class="s3">(</span><span class="s2">null</span><span class="s3">); }</span>

<span class="s0">// am: Compute w_j += (x*this_i), propagate carries,</span>
<span class="s0">// c is initial carry, returns final carry.</span>
<span class="s0">// c &lt; 3*dvalue, x &lt; 2*dvalue, this_i &lt; dvalue</span>
<span class="s0">// We need to select the fastest one that works in this environment.</span>

<span class="s0">// am1: use a single mult and divide to get the high bits,</span>
<span class="s0">// max digit bits should be 26 because</span>
<span class="s0">// max internal value = 2*dvalue^2-2*dvalue (&lt; 2^53)</span>
<span class="s2">function </span><span class="s1">am1</span><span class="s3">(</span><span class="s1">i</span><span class="s3">,</span><span class="s1">x</span><span class="s3">,</span><span class="s1">w</span><span class="s3">,</span><span class="s1">j</span><span class="s3">,</span><span class="s1">c</span><span class="s3">,</span><span class="s1">n</span><span class="s3">) {</span>
  <span class="s2">while</span><span class="s3">(--</span><span class="s1">n </span><span class="s3">&gt;= </span><span class="s5">0</span><span class="s3">) {</span>
    <span class="s2">var </span><span class="s1">v </span><span class="s3">= </span><span class="s1">x</span><span class="s3">*</span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">++]+</span><span class="s1">w</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">j</span><span class="s3">]+</span><span class="s1">c</span><span class="s3">;</span>
    <span class="s1">c </span><span class="s3">= </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">floor</span><span class="s3">(</span><span class="s1">v</span><span class="s3">/</span><span class="s5">0x4000000</span><span class="s3">);</span>
    <span class="s1">w</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">j</span><span class="s3">++] = </span><span class="s1">v</span><span class="s3">&amp;</span><span class="s5">0x3ffffff</span><span class="s3">;</span>
  <span class="s3">}</span>
  <span class="s2">return </span><span class="s1">c</span><span class="s3">;</span>
<span class="s3">}</span>
<span class="s0">// am2 avoids a big mult-and-extract completely.</span>
<span class="s0">// Max digit bits should be &lt;= 30 because we do bitwise ops</span>
<span class="s0">// on values up to 2*hdvalue^2-hdvalue-1 (&lt; 2^31)</span>
<span class="s2">function </span><span class="s1">am2</span><span class="s3">(</span><span class="s1">i</span><span class="s3">,</span><span class="s1">x</span><span class="s3">,</span><span class="s1">w</span><span class="s3">,</span><span class="s1">j</span><span class="s3">,</span><span class="s1">c</span><span class="s3">,</span><span class="s1">n</span><span class="s3">) {</span>
  <span class="s2">var </span><span class="s1">xl </span><span class="s3">= </span><span class="s1">x</span><span class="s3">&amp;</span><span class="s5">0x7fff</span><span class="s3">, </span><span class="s1">xh </span><span class="s3">= </span><span class="s1">x</span><span class="s3">&gt;&gt;</span><span class="s5">15</span><span class="s3">;</span>
  <span class="s2">while</span><span class="s3">(--</span><span class="s1">n </span><span class="s3">&gt;= </span><span class="s5">0</span><span class="s3">) {</span>
    <span class="s2">var </span><span class="s1">l </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]&amp;</span><span class="s5">0x7fff</span><span class="s3">;</span>
    <span class="s2">var </span><span class="s1">h </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">++]&gt;&gt;</span><span class="s5">15</span><span class="s3">;</span>
    <span class="s2">var </span><span class="s1">m </span><span class="s3">= </span><span class="s1">xh</span><span class="s3">*</span><span class="s1">l</span><span class="s3">+</span><span class="s1">h</span><span class="s3">*</span><span class="s1">xl</span><span class="s3">;</span>
    <span class="s1">l </span><span class="s3">= </span><span class="s1">xl</span><span class="s3">*</span><span class="s1">l</span><span class="s3">+((</span><span class="s1">m</span><span class="s3">&amp;</span><span class="s5">0x7fff</span><span class="s3">)&lt;&lt;</span><span class="s5">15</span><span class="s3">)+</span><span class="s1">w</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">j</span><span class="s3">]+(</span><span class="s1">c</span><span class="s3">&amp;</span><span class="s5">0x3fffffff</span><span class="s3">);</span>
    <span class="s1">c </span><span class="s3">= (</span><span class="s1">l</span><span class="s3">&gt;&gt;&gt;</span><span class="s5">30</span><span class="s3">)+(</span><span class="s1">m</span><span class="s3">&gt;&gt;&gt;</span><span class="s5">15</span><span class="s3">)+</span><span class="s1">xh</span><span class="s3">*</span><span class="s1">h</span><span class="s3">+(</span><span class="s1">c</span><span class="s3">&gt;&gt;&gt;</span><span class="s5">30</span><span class="s3">);</span>
    <span class="s1">w</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">j</span><span class="s3">++] = </span><span class="s1">l</span><span class="s3">&amp;</span><span class="s5">0x3fffffff</span><span class="s3">;</span>
  <span class="s3">}</span>
  <span class="s2">return </span><span class="s1">c</span><span class="s3">;</span>
<span class="s3">}</span>
<span class="s0">// Alternately, set max digit bits to 28 since some</span>
<span class="s0">// browsers slow down when dealing with 32-bit numbers.</span>
<span class="s2">function </span><span class="s1">am3</span><span class="s3">(</span><span class="s1">i</span><span class="s3">,</span><span class="s1">x</span><span class="s3">,</span><span class="s1">w</span><span class="s3">,</span><span class="s1">j</span><span class="s3">,</span><span class="s1">c</span><span class="s3">,</span><span class="s1">n</span><span class="s3">) {</span>
  <span class="s2">var </span><span class="s1">xl </span><span class="s3">= </span><span class="s1">x</span><span class="s3">&amp;</span><span class="s5">0x3fff</span><span class="s3">, </span><span class="s1">xh </span><span class="s3">= </span><span class="s1">x</span><span class="s3">&gt;&gt;</span><span class="s5">14</span><span class="s3">;</span>
  <span class="s2">while</span><span class="s3">(--</span><span class="s1">n </span><span class="s3">&gt;= </span><span class="s5">0</span><span class="s3">) {</span>
    <span class="s2">var </span><span class="s1">l </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]&amp;</span><span class="s5">0x3fff</span><span class="s3">;</span>
    <span class="s2">var </span><span class="s1">h </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">++]&gt;&gt;</span><span class="s5">14</span><span class="s3">;</span>
    <span class="s2">var </span><span class="s1">m </span><span class="s3">= </span><span class="s1">xh</span><span class="s3">*</span><span class="s1">l</span><span class="s3">+</span><span class="s1">h</span><span class="s3">*</span><span class="s1">xl</span><span class="s3">;</span>
    <span class="s1">l </span><span class="s3">= </span><span class="s1">xl</span><span class="s3">*</span><span class="s1">l</span><span class="s3">+((</span><span class="s1">m</span><span class="s3">&amp;</span><span class="s5">0x3fff</span><span class="s3">)&lt;&lt;</span><span class="s5">14</span><span class="s3">)+</span><span class="s1">w</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">j</span><span class="s3">]+</span><span class="s1">c</span><span class="s3">;</span>
    <span class="s1">c </span><span class="s3">= (</span><span class="s1">l</span><span class="s3">&gt;&gt;</span><span class="s5">28</span><span class="s3">)+(</span><span class="s1">m</span><span class="s3">&gt;&gt;</span><span class="s5">14</span><span class="s3">)+</span><span class="s1">xh</span><span class="s3">*</span><span class="s1">h</span><span class="s3">;</span>
    <span class="s1">w</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">j</span><span class="s3">++] = </span><span class="s1">l</span><span class="s3">&amp;</span><span class="s5">0xfffffff</span><span class="s3">;</span>
  <span class="s3">}</span>
  <span class="s2">return </span><span class="s1">c</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">// node.js (no browser)</span>
<span class="s2">if</span><span class="s3">(</span><span class="s2">typeof</span><span class="s3">(</span><span class="s1">navigator</span><span class="s3">) === </span><span class="s4">'undefined'</span><span class="s3">)</span>
<span class="s3">{</span>
   <span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">am </span><span class="s3">= </span><span class="s1">am3</span><span class="s3">;</span>
   <span class="s1">dbits </span><span class="s3">= </span><span class="s5">28</span><span class="s3">;</span>
<span class="s3">} </span><span class="s2">else if</span><span class="s3">(</span><span class="s1">j_lm </span><span class="s3">&amp;&amp; (</span><span class="s1">navigator</span><span class="s3">.</span><span class="s1">appName </span><span class="s3">== </span><span class="s4">&quot;Microsoft Internet Explorer&quot;</span><span class="s3">)) {</span>
  <span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">am </span><span class="s3">= </span><span class="s1">am2</span><span class="s3">;</span>
  <span class="s1">dbits </span><span class="s3">= </span><span class="s5">30</span><span class="s3">;</span>
<span class="s3">} </span><span class="s2">else if</span><span class="s3">(</span><span class="s1">j_lm </span><span class="s3">&amp;&amp; (</span><span class="s1">navigator</span><span class="s3">.</span><span class="s1">appName </span><span class="s3">!= </span><span class="s4">&quot;Netscape&quot;</span><span class="s3">)) {</span>
  <span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">am </span><span class="s3">= </span><span class="s1">am1</span><span class="s3">;</span>
  <span class="s1">dbits </span><span class="s3">= </span><span class="s5">26</span><span class="s3">;</span>
<span class="s3">} </span><span class="s2">else </span><span class="s3">{ </span><span class="s0">// Mozilla/Netscape seems to prefer am3</span>
  <span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">am </span><span class="s3">= </span><span class="s1">am3</span><span class="s3">;</span>
  <span class="s1">dbits </span><span class="s3">= </span><span class="s5">28</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">DB </span><span class="s3">= </span><span class="s1">dbits</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">DM </span><span class="s3">= ((</span><span class="s5">1</span><span class="s3">&lt;&lt;</span><span class="s1">dbits</span><span class="s3">)-</span><span class="s5">1</span><span class="s3">);</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">DV </span><span class="s3">= (</span><span class="s5">1</span><span class="s3">&lt;&lt;</span><span class="s1">dbits</span><span class="s3">);</span>

<span class="s2">var </span><span class="s1">BI_FP </span><span class="s3">= </span><span class="s5">52</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">FV </span><span class="s3">= </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">pow</span><span class="s3">(</span><span class="s5">2</span><span class="s3">,</span><span class="s1">BI_FP</span><span class="s3">);</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">F1 </span><span class="s3">= </span><span class="s1">BI_FP</span><span class="s3">-</span><span class="s1">dbits</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">F2 </span><span class="s3">= </span><span class="s5">2</span><span class="s3">*</span><span class="s1">dbits</span><span class="s3">-</span><span class="s1">BI_FP</span><span class="s3">;</span>

<span class="s0">// Digit conversions</span>
<span class="s2">var </span><span class="s1">BI_RM </span><span class="s3">= </span><span class="s4">&quot;0123456789abcdefghijklmnopqrstuvwxyz&quot;</span><span class="s3">;</span>
<span class="s2">var </span><span class="s1">BI_RC </span><span class="s3">= </span><span class="s2">new </span><span class="s1">Array</span><span class="s3">();</span>
<span class="s2">var </span><span class="s1">rr</span><span class="s3">,</span><span class="s1">vv</span><span class="s3">;</span>
<span class="s1">rr </span><span class="s3">= </span><span class="s4">&quot;0&quot;</span><span class="s3">.</span><span class="s1">charCodeAt</span><span class="s3">(</span><span class="s5">0</span><span class="s3">);</span>
<span class="s2">for</span><span class="s3">(</span><span class="s1">vv </span><span class="s3">= </span><span class="s5">0</span><span class="s3">; </span><span class="s1">vv </span><span class="s3">&lt;= </span><span class="s5">9</span><span class="s3">; ++</span><span class="s1">vv</span><span class="s3">) </span><span class="s1">BI_RC</span><span class="s3">[</span><span class="s1">rr</span><span class="s3">++] = </span><span class="s1">vv</span><span class="s3">;</span>
<span class="s1">rr </span><span class="s3">= </span><span class="s4">&quot;a&quot;</span><span class="s3">.</span><span class="s1">charCodeAt</span><span class="s3">(</span><span class="s5">0</span><span class="s3">);</span>
<span class="s2">for</span><span class="s3">(</span><span class="s1">vv </span><span class="s3">= </span><span class="s5">10</span><span class="s3">; </span><span class="s1">vv </span><span class="s3">&lt; </span><span class="s5">36</span><span class="s3">; ++</span><span class="s1">vv</span><span class="s3">) </span><span class="s1">BI_RC</span><span class="s3">[</span><span class="s1">rr</span><span class="s3">++] = </span><span class="s1">vv</span><span class="s3">;</span>
<span class="s1">rr </span><span class="s3">= </span><span class="s4">&quot;A&quot;</span><span class="s3">.</span><span class="s1">charCodeAt</span><span class="s3">(</span><span class="s5">0</span><span class="s3">);</span>
<span class="s2">for</span><span class="s3">(</span><span class="s1">vv </span><span class="s3">= </span><span class="s5">10</span><span class="s3">; </span><span class="s1">vv </span><span class="s3">&lt; </span><span class="s5">36</span><span class="s3">; ++</span><span class="s1">vv</span><span class="s3">) </span><span class="s1">BI_RC</span><span class="s3">[</span><span class="s1">rr</span><span class="s3">++] = </span><span class="s1">vv</span><span class="s3">;</span>

<span class="s2">function </span><span class="s1">int2char</span><span class="s3">(</span><span class="s1">n</span><span class="s3">) { </span><span class="s2">return </span><span class="s1">BI_RM</span><span class="s3">.</span><span class="s1">charAt</span><span class="s3">(</span><span class="s1">n</span><span class="s3">); }</span>
<span class="s2">function </span><span class="s1">intAt</span><span class="s3">(</span><span class="s1">s</span><span class="s3">,</span><span class="s1">i</span><span class="s3">) {</span>
  <span class="s2">var </span><span class="s1">c </span><span class="s3">= </span><span class="s1">BI_RC</span><span class="s3">[</span><span class="s1">s</span><span class="s3">.</span><span class="s1">charCodeAt</span><span class="s3">(</span><span class="s1">i</span><span class="s3">)];</span>
  <span class="s2">return </span><span class="s3">(</span><span class="s1">c</span><span class="s3">==</span><span class="s2">null</span><span class="s3">)?-</span><span class="s5">1</span><span class="s3">:</span><span class="s1">c</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">// (protected) copy this to r</span>
<span class="s2">function </span><span class="s1">bnpCopyTo</span><span class="s3">(</span><span class="s1">r</span><span class="s3">) {</span>
  <span class="s2">for</span><span class="s3">(</span><span class="s2">var </span><span class="s1">i </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">-</span><span class="s5">1</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&gt;= </span><span class="s5">0</span><span class="s3">; --</span><span class="s1">i</span><span class="s3">) </span><span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">];</span>
  <span class="s1">r</span><span class="s3">.</span><span class="s1">t </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">;</span>
  <span class="s1">r</span><span class="s3">.</span><span class="s1">s </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">// (protected) set from integer value x, -DV &lt;= x &lt; DV</span>
<span class="s2">function </span><span class="s1">bnpFromInt</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) {</span>
  <span class="s2">this</span><span class="s3">.</span><span class="s1">t </span><span class="s3">= </span><span class="s5">1</span><span class="s3">;</span>
  <span class="s2">this</span><span class="s3">.</span><span class="s1">s </span><span class="s3">= (</span><span class="s1">x</span><span class="s3">&lt;</span><span class="s5">0</span><span class="s3">)?-</span><span class="s5">1</span><span class="s3">:</span><span class="s5">0</span><span class="s3">;</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">x </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">) </span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] = </span><span class="s1">x</span><span class="s3">;</span>
  <span class="s2">else if</span><span class="s3">(</span><span class="s1">x </span><span class="s3">&lt; -</span><span class="s5">1</span><span class="s3">) </span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] = </span><span class="s1">x</span><span class="s3">+</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DV</span><span class="s3">;</span>
  <span class="s2">else this</span><span class="s3">.</span><span class="s1">t </span><span class="s3">= </span><span class="s5">0</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">// return bigint initialized to value</span>
<span class="s2">function </span><span class="s1">nbv</span><span class="s3">(</span><span class="s1">i</span><span class="s3">) { </span><span class="s2">var </span><span class="s1">r </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">(); </span><span class="s1">r</span><span class="s3">.</span><span class="s1">fromInt</span><span class="s3">(</span><span class="s1">i</span><span class="s3">); </span><span class="s2">return </span><span class="s1">r</span><span class="s3">; }</span>

<span class="s0">// (protected) set from string and radix</span>
<span class="s2">function </span><span class="s1">bnpFromString</span><span class="s3">(</span><span class="s1">s</span><span class="s3">,</span><span class="s1">b</span><span class="s3">) {</span>
  <span class="s2">var </span><span class="s1">k</span><span class="s3">;</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">b </span><span class="s3">== </span><span class="s5">16</span><span class="s3">) </span><span class="s1">k </span><span class="s3">= </span><span class="s5">4</span><span class="s3">;</span>
  <span class="s2">else if</span><span class="s3">(</span><span class="s1">b </span><span class="s3">== </span><span class="s5">8</span><span class="s3">) </span><span class="s1">k </span><span class="s3">= </span><span class="s5">3</span><span class="s3">;</span>
  <span class="s2">else if</span><span class="s3">(</span><span class="s1">b </span><span class="s3">== </span><span class="s5">256</span><span class="s3">) </span><span class="s1">k </span><span class="s3">= </span><span class="s5">8</span><span class="s3">; </span><span class="s0">// byte array</span>
  <span class="s2">else if</span><span class="s3">(</span><span class="s1">b </span><span class="s3">== </span><span class="s5">2</span><span class="s3">) </span><span class="s1">k </span><span class="s3">= </span><span class="s5">1</span><span class="s3">;</span>
  <span class="s2">else if</span><span class="s3">(</span><span class="s1">b </span><span class="s3">== </span><span class="s5">32</span><span class="s3">) </span><span class="s1">k </span><span class="s3">= </span><span class="s5">5</span><span class="s3">;</span>
  <span class="s2">else if</span><span class="s3">(</span><span class="s1">b </span><span class="s3">== </span><span class="s5">4</span><span class="s3">) </span><span class="s1">k </span><span class="s3">= </span><span class="s5">2</span><span class="s3">;</span>
  <span class="s2">else </span><span class="s3">{ </span><span class="s2">this</span><span class="s3">.</span><span class="s1">fromRadix</span><span class="s3">(</span><span class="s1">s</span><span class="s3">,</span><span class="s1">b</span><span class="s3">); </span><span class="s2">return</span><span class="s3">; }</span>
  <span class="s2">this</span><span class="s3">.</span><span class="s1">t </span><span class="s3">= </span><span class="s5">0</span><span class="s3">;</span>
  <span class="s2">this</span><span class="s3">.</span><span class="s1">s </span><span class="s3">= </span><span class="s5">0</span><span class="s3">;</span>
  <span class="s2">var </span><span class="s1">i </span><span class="s3">= </span><span class="s1">s</span><span class="s3">.</span><span class="s1">length</span><span class="s3">, </span><span class="s1">mi </span><span class="s3">= </span><span class="s2">false</span><span class="s3">, </span><span class="s1">sh </span><span class="s3">= </span><span class="s5">0</span><span class="s3">;</span>
  <span class="s2">while</span><span class="s3">(--</span><span class="s1">i </span><span class="s3">&gt;= </span><span class="s5">0</span><span class="s3">) {</span>
    <span class="s2">var </span><span class="s1">x </span><span class="s3">= (</span><span class="s1">k</span><span class="s3">==</span><span class="s5">8</span><span class="s3">)?</span><span class="s1">s</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]&amp;</span><span class="s5">0xff</span><span class="s3">:</span><span class="s1">intAt</span><span class="s3">(</span><span class="s1">s</span><span class="s3">,</span><span class="s1">i</span><span class="s3">);</span>
    <span class="s2">if</span><span class="s3">(</span><span class="s1">x </span><span class="s3">&lt; </span><span class="s5">0</span><span class="s3">) {</span>
      <span class="s2">if</span><span class="s3">(</span><span class="s1">s</span><span class="s3">.</span><span class="s1">charAt</span><span class="s3">(</span><span class="s1">i</span><span class="s3">) == </span><span class="s4">&quot;-&quot;</span><span class="s3">) </span><span class="s1">mi </span><span class="s3">= </span><span class="s2">true</span><span class="s3">;</span>
      <span class="s2">continue</span><span class="s3">;</span>
    <span class="s3">}</span>
    <span class="s1">mi </span><span class="s3">= </span><span class="s2">false</span><span class="s3">;</span>
    <span class="s2">if</span><span class="s3">(</span><span class="s1">sh </span><span class="s3">== </span><span class="s5">0</span><span class="s3">)</span>
      <span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">++] = </span><span class="s1">x</span><span class="s3">;</span>
    <span class="s2">else if</span><span class="s3">(</span><span class="s1">sh</span><span class="s3">+</span><span class="s1">k </span><span class="s3">&gt; </span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">) {</span>
      <span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">-</span><span class="s5">1</span><span class="s3">] |= (</span><span class="s1">x</span><span class="s3">&amp;((</span><span class="s5">1</span><span class="s3">&lt;&lt;(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">-</span><span class="s1">sh</span><span class="s3">))-</span><span class="s5">1</span><span class="s3">))&lt;&lt;</span><span class="s1">sh</span><span class="s3">;</span>
      <span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">++] = (</span><span class="s1">x</span><span class="s3">&gt;&gt;(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">-</span><span class="s1">sh</span><span class="s3">));</span>
    <span class="s3">} </span><span class="s2">else</span>
      <span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">-</span><span class="s5">1</span><span class="s3">] |= </span><span class="s1">x</span><span class="s3">&lt;&lt;</span><span class="s1">sh</span><span class="s3">;</span>
    <span class="s1">sh </span><span class="s3">+= </span><span class="s1">k</span><span class="s3">;</span>
    <span class="s2">if</span><span class="s3">(</span><span class="s1">sh </span><span class="s3">&gt;= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">) </span><span class="s1">sh </span><span class="s3">-= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">;</span>
  <span class="s3">}</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">k </span><span class="s3">== </span><span class="s5">8 </span><span class="s3">&amp;&amp; (</span><span class="s1">s</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]&amp;</span><span class="s5">0x80</span><span class="s3">) != </span><span class="s5">0</span><span class="s3">) {</span>
    <span class="s2">this</span><span class="s3">.</span><span class="s1">s </span><span class="s3">= -</span><span class="s5">1</span><span class="s3">;</span>
    <span class="s2">if</span><span class="s3">(</span><span class="s1">sh </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">) </span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">-</span><span class="s5">1</span><span class="s3">] |= ((</span><span class="s5">1</span><span class="s3">&lt;&lt;(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">-</span><span class="s1">sh</span><span class="s3">))-</span><span class="s5">1</span><span class="s3">)&lt;&lt;</span><span class="s1">sh</span><span class="s3">;</span>
  <span class="s3">}</span>
  <span class="s2">this</span><span class="s3">.</span><span class="s1">clamp</span><span class="s3">();</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">mi</span><span class="s3">) </span><span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">ZERO</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s2">this</span><span class="s3">,</span><span class="s2">this</span><span class="s3">);</span>
<span class="s3">}</span>

<span class="s0">// (protected) clamp off excess high words</span>
<span class="s2">function </span><span class="s1">bnpClamp</span><span class="s3">() {</span>
  <span class="s2">var </span><span class="s1">c </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">&amp;</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DM</span><span class="s3">;</span>
  <span class="s2">while</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t </span><span class="s3">&gt; </span><span class="s5">0 </span><span class="s3">&amp;&amp; </span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">-</span><span class="s5">1</span><span class="s3">] == </span><span class="s1">c</span><span class="s3">) --</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">// (public) return string representation in given radix</span>
<span class="s2">function </span><span class="s1">bnToString</span><span class="s3">(</span><span class="s1">b</span><span class="s3">) {</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">s </span><span class="s3">&lt; </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return </span><span class="s4">&quot;-&quot;</span><span class="s3">+</span><span class="s2">this</span><span class="s3">.</span><span class="s1">negate</span><span class="s3">().</span><span class="s1">toString</span><span class="s3">(</span><span class="s1">b</span><span class="s3">);</span>
  <span class="s2">var </span><span class="s1">k</span><span class="s3">;</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">b </span><span class="s3">== </span><span class="s5">16</span><span class="s3">) </span><span class="s1">k </span><span class="s3">= </span><span class="s5">4</span><span class="s3">;</span>
  <span class="s2">else if</span><span class="s3">(</span><span class="s1">b </span><span class="s3">== </span><span class="s5">8</span><span class="s3">) </span><span class="s1">k </span><span class="s3">= </span><span class="s5">3</span><span class="s3">;</span>
  <span class="s2">else if</span><span class="s3">(</span><span class="s1">b </span><span class="s3">== </span><span class="s5">2</span><span class="s3">) </span><span class="s1">k </span><span class="s3">= </span><span class="s5">1</span><span class="s3">;</span>
  <span class="s2">else if</span><span class="s3">(</span><span class="s1">b </span><span class="s3">== </span><span class="s5">32</span><span class="s3">) </span><span class="s1">k </span><span class="s3">= </span><span class="s5">5</span><span class="s3">;</span>
  <span class="s2">else if</span><span class="s3">(</span><span class="s1">b </span><span class="s3">== </span><span class="s5">4</span><span class="s3">) </span><span class="s1">k </span><span class="s3">= </span><span class="s5">2</span><span class="s3">;</span>
  <span class="s2">else return this</span><span class="s3">.</span><span class="s1">toRadix</span><span class="s3">(</span><span class="s1">b</span><span class="s3">);</span>
  <span class="s2">var </span><span class="s1">km </span><span class="s3">= (</span><span class="s5">1</span><span class="s3">&lt;&lt;</span><span class="s1">k</span><span class="s3">)-</span><span class="s5">1</span><span class="s3">, </span><span class="s1">d</span><span class="s3">, </span><span class="s1">m </span><span class="s3">= </span><span class="s2">false</span><span class="s3">, </span><span class="s1">r </span><span class="s3">= </span><span class="s4">&quot;&quot;</span><span class="s3">, </span><span class="s1">i </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">;</span>
  <span class="s2">var </span><span class="s1">p </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">-(</span><span class="s1">i</span><span class="s3">*</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">)%</span><span class="s1">k</span><span class="s3">;</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">i</span><span class="s3">-- &gt; </span><span class="s5">0</span><span class="s3">) {</span>
    <span class="s2">if</span><span class="s3">(</span><span class="s1">p </span><span class="s3">&lt; </span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB </span><span class="s3">&amp;&amp; (</span><span class="s1">d </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]&gt;&gt;</span><span class="s1">p</span><span class="s3">) &gt; </span><span class="s5">0</span><span class="s3">) { </span><span class="s1">m </span><span class="s3">= </span><span class="s2">true</span><span class="s3">; </span><span class="s1">r </span><span class="s3">= </span><span class="s1">int2char</span><span class="s3">(</span><span class="s1">d</span><span class="s3">); }</span>
    <span class="s2">while</span><span class="s3">(</span><span class="s1">i </span><span class="s3">&gt;= </span><span class="s5">0</span><span class="s3">) {</span>
      <span class="s2">if</span><span class="s3">(</span><span class="s1">p </span><span class="s3">&lt; </span><span class="s1">k</span><span class="s3">) {</span>
        <span class="s1">d </span><span class="s3">= (</span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]&amp;((</span><span class="s5">1</span><span class="s3">&lt;&lt;</span><span class="s1">p</span><span class="s3">)-</span><span class="s5">1</span><span class="s3">))&lt;&lt;(</span><span class="s1">k</span><span class="s3">-</span><span class="s1">p</span><span class="s3">);</span>
        <span class="s1">d </span><span class="s3">|= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[--</span><span class="s1">i</span><span class="s3">]&gt;&gt;(</span><span class="s1">p</span><span class="s3">+=</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">-</span><span class="s1">k</span><span class="s3">);</span>
      <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
        <span class="s1">d </span><span class="s3">= (</span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]&gt;&gt;(</span><span class="s1">p</span><span class="s3">-=</span><span class="s1">k</span><span class="s3">))&amp;</span><span class="s1">km</span><span class="s3">;</span>
        <span class="s2">if</span><span class="s3">(</span><span class="s1">p </span><span class="s3">&lt;= </span><span class="s5">0</span><span class="s3">) { </span><span class="s1">p </span><span class="s3">+= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">; --</span><span class="s1">i</span><span class="s3">; }</span>
      <span class="s3">}</span>
      <span class="s2">if</span><span class="s3">(</span><span class="s1">d </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">) </span><span class="s1">m </span><span class="s3">= </span><span class="s2">true</span><span class="s3">;</span>
      <span class="s2">if</span><span class="s3">(</span><span class="s1">m</span><span class="s3">) </span><span class="s1">r </span><span class="s3">+= </span><span class="s1">int2char</span><span class="s3">(</span><span class="s1">d</span><span class="s3">);</span>
    <span class="s3">}</span>
  <span class="s3">}</span>
  <span class="s2">return </span><span class="s1">m</span><span class="s3">?</span><span class="s1">r</span><span class="s3">:</span><span class="s4">&quot;0&quot;</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">// (public) -this</span>
<span class="s2">function </span><span class="s1">bnNegate</span><span class="s3">() { </span><span class="s2">var </span><span class="s1">r </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">(); </span><span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">ZERO</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s2">this</span><span class="s3">,</span><span class="s1">r</span><span class="s3">); </span><span class="s2">return </span><span class="s1">r</span><span class="s3">; }</span>

<span class="s0">// (public) |this|</span>
<span class="s2">function </span><span class="s1">bnAbs</span><span class="s3">() { </span><span class="s2">return </span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">&lt;</span><span class="s5">0</span><span class="s3">)?</span><span class="s2">this</span><span class="s3">.</span><span class="s1">negate</span><span class="s3">():</span><span class="s2">this</span><span class="s3">; }</span>

<span class="s0">// (public) return + if this &gt; a, - if this &lt; a, 0 if equal</span>
<span class="s2">function </span><span class="s1">bnCompareTo</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) {</span>
  <span class="s2">var </span><span class="s1">r </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">-</span><span class="s1">a</span><span class="s3">.</span><span class="s1">s</span><span class="s3">;</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">r </span><span class="s3">!= </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return </span><span class="s1">r</span><span class="s3">;</span>
  <span class="s2">var </span><span class="s1">i </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">;</span>
  <span class="s1">r </span><span class="s3">= </span><span class="s1">i</span><span class="s3">-</span><span class="s1">a</span><span class="s3">.</span><span class="s1">t</span><span class="s3">;</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">r </span><span class="s3">!= </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return </span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">&lt;</span><span class="s5">0</span><span class="s3">)?-</span><span class="s1">r</span><span class="s3">:</span><span class="s1">r</span><span class="s3">;</span>
  <span class="s2">while</span><span class="s3">(--</span><span class="s1">i </span><span class="s3">&gt;= </span><span class="s5">0</span><span class="s3">) </span><span class="s2">if</span><span class="s3">((</span><span class="s1">r</span><span class="s3">=</span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]-</span><span class="s1">a</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]) != </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return </span><span class="s1">r</span><span class="s3">;</span>
  <span class="s2">return </span><span class="s5">0</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">// returns bit length of the integer x</span>
<span class="s2">function </span><span class="s1">nbits</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) {</span>
  <span class="s2">var </span><span class="s1">r </span><span class="s3">= </span><span class="s5">1</span><span class="s3">, </span><span class="s1">t</span><span class="s3">;</span>
  <span class="s2">if</span><span class="s3">((</span><span class="s1">t</span><span class="s3">=</span><span class="s1">x</span><span class="s3">&gt;&gt;&gt;</span><span class="s5">16</span><span class="s3">) != </span><span class="s5">0</span><span class="s3">) { </span><span class="s1">x </span><span class="s3">= </span><span class="s1">t</span><span class="s3">; </span><span class="s1">r </span><span class="s3">+= </span><span class="s5">16</span><span class="s3">; }</span>
  <span class="s2">if</span><span class="s3">((</span><span class="s1">t</span><span class="s3">=</span><span class="s1">x</span><span class="s3">&gt;&gt;</span><span class="s5">8</span><span class="s3">) != </span><span class="s5">0</span><span class="s3">) { </span><span class="s1">x </span><span class="s3">= </span><span class="s1">t</span><span class="s3">; </span><span class="s1">r </span><span class="s3">+= </span><span class="s5">8</span><span class="s3">; }</span>
  <span class="s2">if</span><span class="s3">((</span><span class="s1">t</span><span class="s3">=</span><span class="s1">x</span><span class="s3">&gt;&gt;</span><span class="s5">4</span><span class="s3">) != </span><span class="s5">0</span><span class="s3">) { </span><span class="s1">x </span><span class="s3">= </span><span class="s1">t</span><span class="s3">; </span><span class="s1">r </span><span class="s3">+= </span><span class="s5">4</span><span class="s3">; }</span>
  <span class="s2">if</span><span class="s3">((</span><span class="s1">t</span><span class="s3">=</span><span class="s1">x</span><span class="s3">&gt;&gt;</span><span class="s5">2</span><span class="s3">) != </span><span class="s5">0</span><span class="s3">) { </span><span class="s1">x </span><span class="s3">= </span><span class="s1">t</span><span class="s3">; </span><span class="s1">r </span><span class="s3">+= </span><span class="s5">2</span><span class="s3">; }</span>
  <span class="s2">if</span><span class="s3">((</span><span class="s1">t</span><span class="s3">=</span><span class="s1">x</span><span class="s3">&gt;&gt;</span><span class="s5">1</span><span class="s3">) != </span><span class="s5">0</span><span class="s3">) { </span><span class="s1">x </span><span class="s3">= </span><span class="s1">t</span><span class="s3">; </span><span class="s1">r </span><span class="s3">+= </span><span class="s5">1</span><span class="s3">; }</span>
  <span class="s2">return </span><span class="s1">r</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">// (public) return the number of bits in &quot;this&quot;</span>
<span class="s2">function </span><span class="s1">bnBitLength</span><span class="s3">() {</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t </span><span class="s3">&lt;= </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return </span><span class="s5">0</span><span class="s3">;</span>
  <span class="s2">return this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">*(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">-</span><span class="s5">1</span><span class="s3">)+</span><span class="s1">nbits</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">-</span><span class="s5">1</span><span class="s3">]^(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">&amp;</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DM</span><span class="s3">));</span>
<span class="s3">}</span>

<span class="s0">// (protected) r = this &lt;&lt; n*DB</span>
<span class="s2">function </span><span class="s1">bnpDLShiftTo</span><span class="s3">(</span><span class="s1">n</span><span class="s3">,</span><span class="s1">r</span><span class="s3">) {</span>
  <span class="s2">var </span><span class="s1">i</span><span class="s3">;</span>
  <span class="s2">for</span><span class="s3">(</span><span class="s1">i </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">-</span><span class="s5">1</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&gt;= </span><span class="s5">0</span><span class="s3">; --</span><span class="s1">i</span><span class="s3">) </span><span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">+</span><span class="s1">n</span><span class="s3">] = </span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">];</span>
  <span class="s2">for</span><span class="s3">(</span><span class="s1">i </span><span class="s3">= </span><span class="s1">n</span><span class="s3">-</span><span class="s5">1</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&gt;= </span><span class="s5">0</span><span class="s3">; --</span><span class="s1">i</span><span class="s3">) </span><span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s5">0</span><span class="s3">;</span>
  <span class="s1">r</span><span class="s3">.</span><span class="s1">t </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">+</span><span class="s1">n</span><span class="s3">;</span>
  <span class="s1">r</span><span class="s3">.</span><span class="s1">s </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">// (protected) r = this &gt;&gt; n*DB</span>
<span class="s2">function </span><span class="s1">bnpDRShiftTo</span><span class="s3">(</span><span class="s1">n</span><span class="s3">,</span><span class="s1">r</span><span class="s3">) {</span>
  <span class="s2">for</span><span class="s3">(</span><span class="s2">var </span><span class="s1">i </span><span class="s3">= </span><span class="s1">n</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">; ++</span><span class="s1">i</span><span class="s3">) </span><span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">-</span><span class="s1">n</span><span class="s3">] = </span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">];</span>
  <span class="s1">r</span><span class="s3">.</span><span class="s1">t </span><span class="s3">= </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">-</span><span class="s1">n</span><span class="s3">,</span><span class="s5">0</span><span class="s3">);</span>
  <span class="s1">r</span><span class="s3">.</span><span class="s1">s </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">// (protected) r = this &lt;&lt; n</span>
<span class="s2">function </span><span class="s1">bnpLShiftTo</span><span class="s3">(</span><span class="s1">n</span><span class="s3">,</span><span class="s1">r</span><span class="s3">) {</span>
  <span class="s2">var </span><span class="s1">bs </span><span class="s3">= </span><span class="s1">n</span><span class="s3">%</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">;</span>
  <span class="s2">var </span><span class="s1">cbs </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">-</span><span class="s1">bs</span><span class="s3">;</span>
  <span class="s2">var </span><span class="s1">bm </span><span class="s3">= (</span><span class="s5">1</span><span class="s3">&lt;&lt;</span><span class="s1">cbs</span><span class="s3">)-</span><span class="s5">1</span><span class="s3">;</span>
  <span class="s2">var </span><span class="s1">ds </span><span class="s3">= </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">floor</span><span class="s3">(</span><span class="s1">n</span><span class="s3">/</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">), </span><span class="s1">c </span><span class="s3">= (</span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">&lt;&lt;</span><span class="s1">bs</span><span class="s3">)&amp;</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DM</span><span class="s3">, </span><span class="s1">i</span><span class="s3">;</span>
  <span class="s2">for</span><span class="s3">(</span><span class="s1">i </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">-</span><span class="s5">1</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&gt;= </span><span class="s5">0</span><span class="s3">; --</span><span class="s1">i</span><span class="s3">) {</span>
    <span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">+</span><span class="s1">ds</span><span class="s3">+</span><span class="s5">1</span><span class="s3">] = (</span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]&gt;&gt;</span><span class="s1">cbs</span><span class="s3">)|</span><span class="s1">c</span><span class="s3">;</span>
    <span class="s1">c </span><span class="s3">= (</span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]&amp;</span><span class="s1">bm</span><span class="s3">)&lt;&lt;</span><span class="s1">bs</span><span class="s3">;</span>
  <span class="s3">}</span>
  <span class="s2">for</span><span class="s3">(</span><span class="s1">i </span><span class="s3">= </span><span class="s1">ds</span><span class="s3">-</span><span class="s5">1</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&gt;= </span><span class="s5">0</span><span class="s3">; --</span><span class="s1">i</span><span class="s3">) </span><span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s5">0</span><span class="s3">;</span>
  <span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">ds</span><span class="s3">] = </span><span class="s1">c</span><span class="s3">;</span>
  <span class="s1">r</span><span class="s3">.</span><span class="s1">t </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">+</span><span class="s1">ds</span><span class="s3">+</span><span class="s5">1</span><span class="s3">;</span>
  <span class="s1">r</span><span class="s3">.</span><span class="s1">s </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">;</span>
  <span class="s1">r</span><span class="s3">.</span><span class="s1">clamp</span><span class="s3">();</span>
<span class="s3">}</span>

<span class="s0">// (protected) r = this &gt;&gt; n</span>
<span class="s2">function </span><span class="s1">bnpRShiftTo</span><span class="s3">(</span><span class="s1">n</span><span class="s3">,</span><span class="s1">r</span><span class="s3">) {</span>
  <span class="s1">r</span><span class="s3">.</span><span class="s1">s </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">;</span>
  <span class="s2">var </span><span class="s1">ds </span><span class="s3">= </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">floor</span><span class="s3">(</span><span class="s1">n</span><span class="s3">/</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">);</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">ds </span><span class="s3">&gt;= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">) { </span><span class="s1">r</span><span class="s3">.</span><span class="s1">t </span><span class="s3">= </span><span class="s5">0</span><span class="s3">; </span><span class="s2">return</span><span class="s3">; }</span>
  <span class="s2">var </span><span class="s1">bs </span><span class="s3">= </span><span class="s1">n</span><span class="s3">%</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">;</span>
  <span class="s2">var </span><span class="s1">cbs </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">-</span><span class="s1">bs</span><span class="s3">;</span>
  <span class="s2">var </span><span class="s1">bm </span><span class="s3">= (</span><span class="s5">1</span><span class="s3">&lt;&lt;</span><span class="s1">bs</span><span class="s3">)-</span><span class="s5">1</span><span class="s3">;</span>
  <span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] = </span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">ds</span><span class="s3">]&gt;&gt;</span><span class="s1">bs</span><span class="s3">;</span>
  <span class="s2">for</span><span class="s3">(</span><span class="s2">var </span><span class="s1">i </span><span class="s3">= </span><span class="s1">ds</span><span class="s3">+</span><span class="s5">1</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">; ++</span><span class="s1">i</span><span class="s3">) {</span>
    <span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">-</span><span class="s1">ds</span><span class="s3">-</span><span class="s5">1</span><span class="s3">] |= (</span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]&amp;</span><span class="s1">bm</span><span class="s3">)&lt;&lt;</span><span class="s1">cbs</span><span class="s3">;</span>
    <span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">-</span><span class="s1">ds</span><span class="s3">] = </span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]&gt;&gt;</span><span class="s1">bs</span><span class="s3">;</span>
  <span class="s3">}</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">bs </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">) </span><span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">-</span><span class="s1">ds</span><span class="s3">-</span><span class="s5">1</span><span class="s3">] |= (</span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">&amp;</span><span class="s1">bm</span><span class="s3">)&lt;&lt;</span><span class="s1">cbs</span><span class="s3">;</span>
  <span class="s1">r</span><span class="s3">.</span><span class="s1">t </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">-</span><span class="s1">ds</span><span class="s3">;</span>
  <span class="s1">r</span><span class="s3">.</span><span class="s1">clamp</span><span class="s3">();</span>
<span class="s3">}</span>

<span class="s0">// (protected) r = this - a</span>
<span class="s2">function </span><span class="s1">bnpSubTo</span><span class="s3">(</span><span class="s1">a</span><span class="s3">,</span><span class="s1">r</span><span class="s3">) {</span>
  <span class="s2">var </span><span class="s1">i </span><span class="s3">= </span><span class="s5">0</span><span class="s3">, </span><span class="s1">c </span><span class="s3">= </span><span class="s5">0</span><span class="s3">, </span><span class="s1">m </span><span class="s3">= </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(</span><span class="s1">a</span><span class="s3">.</span><span class="s1">t</span><span class="s3">,</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">);</span>
  <span class="s2">while</span><span class="s3">(</span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">m</span><span class="s3">) {</span>
    <span class="s1">c </span><span class="s3">+= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]-</span><span class="s1">a</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">];</span>
    <span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">++] = </span><span class="s1">c</span><span class="s3">&amp;</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DM</span><span class="s3">;</span>
    <span class="s1">c </span><span class="s3">&gt;&gt;= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">;</span>
  <span class="s3">}</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">a</span><span class="s3">.</span><span class="s1">t </span><span class="s3">&lt; </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">) {</span>
    <span class="s1">c </span><span class="s3">-= </span><span class="s1">a</span><span class="s3">.</span><span class="s1">s</span><span class="s3">;</span>
    <span class="s2">while</span><span class="s3">(</span><span class="s1">i </span><span class="s3">&lt; </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">) {</span>
      <span class="s1">c </span><span class="s3">+= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">];</span>
      <span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">++] = </span><span class="s1">c</span><span class="s3">&amp;</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DM</span><span class="s3">;</span>
      <span class="s1">c </span><span class="s3">&gt;&gt;= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">;</span>
    <span class="s3">}</span>
    <span class="s1">c </span><span class="s3">+= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">;</span>
  <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
    <span class="s1">c </span><span class="s3">+= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">;</span>
    <span class="s2">while</span><span class="s3">(</span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">a</span><span class="s3">.</span><span class="s1">t</span><span class="s3">) {</span>
      <span class="s1">c </span><span class="s3">-= </span><span class="s1">a</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">];</span>
      <span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">++] = </span><span class="s1">c</span><span class="s3">&amp;</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DM</span><span class="s3">;</span>
      <span class="s1">c </span><span class="s3">&gt;&gt;= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">;</span>
    <span class="s3">}</span>
    <span class="s1">c </span><span class="s3">-= </span><span class="s1">a</span><span class="s3">.</span><span class="s1">s</span><span class="s3">;</span>
  <span class="s3">}</span>
  <span class="s1">r</span><span class="s3">.</span><span class="s1">s </span><span class="s3">= (</span><span class="s1">c</span><span class="s3">&lt;</span><span class="s5">0</span><span class="s3">)?-</span><span class="s5">1</span><span class="s3">:</span><span class="s5">0</span><span class="s3">;</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">c </span><span class="s3">&lt; -</span><span class="s5">1</span><span class="s3">) </span><span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">++] = </span><span class="s2">this</span><span class="s3">.</span><span class="s1">DV</span><span class="s3">+</span><span class="s1">c</span><span class="s3">;</span>
  <span class="s2">else if</span><span class="s3">(</span><span class="s1">c </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">) </span><span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">++] = </span><span class="s1">c</span><span class="s3">;</span>
  <span class="s1">r</span><span class="s3">.</span><span class="s1">t </span><span class="s3">= </span><span class="s1">i</span><span class="s3">;</span>
  <span class="s1">r</span><span class="s3">.</span><span class="s1">clamp</span><span class="s3">();</span>
<span class="s3">}</span>

<span class="s0">// (protected) r = this * a, r != this,a (HAC 14.12)</span>
<span class="s0">// &quot;this&quot; should be the larger one if appropriate.</span>
<span class="s2">function </span><span class="s1">bnpMultiplyTo</span><span class="s3">(</span><span class="s1">a</span><span class="s3">,</span><span class="s1">r</span><span class="s3">) {</span>
  <span class="s2">var </span><span class="s1">x </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(), </span><span class="s1">y </span><span class="s3">= </span><span class="s1">a</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">();</span>
  <span class="s2">var </span><span class="s1">i </span><span class="s3">= </span><span class="s1">x</span><span class="s3">.</span><span class="s1">t</span><span class="s3">;</span>
  <span class="s1">r</span><span class="s3">.</span><span class="s1">t </span><span class="s3">= </span><span class="s1">i</span><span class="s3">+</span><span class="s1">y</span><span class="s3">.</span><span class="s1">t</span><span class="s3">;</span>
  <span class="s2">while</span><span class="s3">(--</span><span class="s1">i </span><span class="s3">&gt;= </span><span class="s5">0</span><span class="s3">) </span><span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s5">0</span><span class="s3">;</span>
  <span class="s2">for</span><span class="s3">(</span><span class="s1">i </span><span class="s3">= </span><span class="s5">0</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">y</span><span class="s3">.</span><span class="s1">t</span><span class="s3">; ++</span><span class="s1">i</span><span class="s3">) </span><span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">+</span><span class="s1">x</span><span class="s3">.</span><span class="s1">t</span><span class="s3">] = </span><span class="s1">x</span><span class="s3">.</span><span class="s1">am</span><span class="s3">(</span><span class="s5">0</span><span class="s3">,</span><span class="s1">y</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">],</span><span class="s1">r</span><span class="s3">,</span><span class="s1">i</span><span class="s3">,</span><span class="s5">0</span><span class="s3">,</span><span class="s1">x</span><span class="s3">.</span><span class="s1">t</span><span class="s3">);</span>
  <span class="s1">r</span><span class="s3">.</span><span class="s1">s </span><span class="s3">= </span><span class="s5">0</span><span class="s3">;</span>
  <span class="s1">r</span><span class="s3">.</span><span class="s1">clamp</span><span class="s3">();</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">s </span><span class="s3">!= </span><span class="s1">a</span><span class="s3">.</span><span class="s1">s</span><span class="s3">) </span><span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">ZERO</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s1">r</span><span class="s3">,</span><span class="s1">r</span><span class="s3">);</span>
<span class="s3">}</span>

<span class="s0">// (protected) r = this^2, r != this (HAC 14.16)</span>
<span class="s2">function </span><span class="s1">bnpSquareTo</span><span class="s3">(</span><span class="s1">r</span><span class="s3">) {</span>
  <span class="s2">var </span><span class="s1">x </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">();</span>
  <span class="s2">var </span><span class="s1">i </span><span class="s3">= </span><span class="s1">r</span><span class="s3">.</span><span class="s1">t </span><span class="s3">= </span><span class="s5">2</span><span class="s3">*</span><span class="s1">x</span><span class="s3">.</span><span class="s1">t</span><span class="s3">;</span>
  <span class="s2">while</span><span class="s3">(--</span><span class="s1">i </span><span class="s3">&gt;= </span><span class="s5">0</span><span class="s3">) </span><span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s5">0</span><span class="s3">;</span>
  <span class="s2">for</span><span class="s3">(</span><span class="s1">i </span><span class="s3">= </span><span class="s5">0</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">x</span><span class="s3">.</span><span class="s1">t</span><span class="s3">-</span><span class="s5">1</span><span class="s3">; ++</span><span class="s1">i</span><span class="s3">) {</span>
    <span class="s2">var </span><span class="s1">c </span><span class="s3">= </span><span class="s1">x</span><span class="s3">.</span><span class="s1">am</span><span class="s3">(</span><span class="s1">i</span><span class="s3">,</span><span class="s1">x</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">],</span><span class="s1">r</span><span class="s3">,</span><span class="s5">2</span><span class="s3">*</span><span class="s1">i</span><span class="s3">,</span><span class="s5">0</span><span class="s3">,</span><span class="s5">1</span><span class="s3">);</span>
    <span class="s2">if</span><span class="s3">((</span><span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">+</span><span class="s1">x</span><span class="s3">.</span><span class="s1">t</span><span class="s3">]+=</span><span class="s1">x</span><span class="s3">.</span><span class="s1">am</span><span class="s3">(</span><span class="s1">i</span><span class="s3">+</span><span class="s5">1</span><span class="s3">,</span><span class="s5">2</span><span class="s3">*</span><span class="s1">x</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">],</span><span class="s1">r</span><span class="s3">,</span><span class="s5">2</span><span class="s3">*</span><span class="s1">i</span><span class="s3">+</span><span class="s5">1</span><span class="s3">,</span><span class="s1">c</span><span class="s3">,</span><span class="s1">x</span><span class="s3">.</span><span class="s1">t</span><span class="s3">-</span><span class="s1">i</span><span class="s3">-</span><span class="s5">1</span><span class="s3">)) &gt;= </span><span class="s1">x</span><span class="s3">.</span><span class="s1">DV</span><span class="s3">) {</span>
      <span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">+</span><span class="s1">x</span><span class="s3">.</span><span class="s1">t</span><span class="s3">] -= </span><span class="s1">x</span><span class="s3">.</span><span class="s1">DV</span><span class="s3">;</span>
      <span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">+</span><span class="s1">x</span><span class="s3">.</span><span class="s1">t</span><span class="s3">+</span><span class="s5">1</span><span class="s3">] = </span><span class="s5">1</span><span class="s3">;</span>
    <span class="s3">}</span>
  <span class="s3">}</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">r</span><span class="s3">.</span><span class="s1">t </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">) </span><span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">r</span><span class="s3">.</span><span class="s1">t</span><span class="s3">-</span><span class="s5">1</span><span class="s3">] += </span><span class="s1">x</span><span class="s3">.</span><span class="s1">am</span><span class="s3">(</span><span class="s1">i</span><span class="s3">,</span><span class="s1">x</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">],</span><span class="s1">r</span><span class="s3">,</span><span class="s5">2</span><span class="s3">*</span><span class="s1">i</span><span class="s3">,</span><span class="s5">0</span><span class="s3">,</span><span class="s5">1</span><span class="s3">);</span>
  <span class="s1">r</span><span class="s3">.</span><span class="s1">s </span><span class="s3">= </span><span class="s5">0</span><span class="s3">;</span>
  <span class="s1">r</span><span class="s3">.</span><span class="s1">clamp</span><span class="s3">();</span>
<span class="s3">}</span>

<span class="s0">// (protected) divide this by m, quotient and remainder to q, r (HAC 14.20)</span>
<span class="s0">// r != q, this != m.  q or r may be null.</span>
<span class="s2">function </span><span class="s1">bnpDivRemTo</span><span class="s3">(</span><span class="s1">m</span><span class="s3">,</span><span class="s1">q</span><span class="s3">,</span><span class="s1">r</span><span class="s3">) {</span>
  <span class="s2">var </span><span class="s1">pm </span><span class="s3">= </span><span class="s1">m</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">();</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">pm</span><span class="s3">.</span><span class="s1">t </span><span class="s3">&lt;= </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return</span><span class="s3">;</span>
  <span class="s2">var </span><span class="s1">pt </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">();</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">pt</span><span class="s3">.</span><span class="s1">t </span><span class="s3">&lt; </span><span class="s1">pm</span><span class="s3">.</span><span class="s1">t</span><span class="s3">) {</span>
    <span class="s2">if</span><span class="s3">(</span><span class="s1">q </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">) </span><span class="s1">q</span><span class="s3">.</span><span class="s1">fromInt</span><span class="s3">(</span><span class="s5">0</span><span class="s3">);</span>
    <span class="s2">if</span><span class="s3">(</span><span class="s1">r </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">) </span><span class="s2">this</span><span class="s3">.</span><span class="s1">copyTo</span><span class="s3">(</span><span class="s1">r</span><span class="s3">);</span>
    <span class="s2">return</span><span class="s3">;</span>
  <span class="s3">}</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">r </span><span class="s3">== </span><span class="s2">null</span><span class="s3">) </span><span class="s1">r </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">();</span>
  <span class="s2">var </span><span class="s1">y </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">(), </span><span class="s1">ts </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">, </span><span class="s1">ms </span><span class="s3">= </span><span class="s1">m</span><span class="s3">.</span><span class="s1">s</span><span class="s3">;</span>
  <span class="s2">var </span><span class="s1">nsh </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">-</span><span class="s1">nbits</span><span class="s3">(</span><span class="s1">pm</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">pm</span><span class="s3">.</span><span class="s1">t</span><span class="s3">-</span><span class="s5">1</span><span class="s3">]);	</span><span class="s0">// normalize modulus</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">nsh </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">) { </span><span class="s1">pm</span><span class="s3">.</span><span class="s1">lShiftTo</span><span class="s3">(</span><span class="s1">nsh</span><span class="s3">,</span><span class="s1">y</span><span class="s3">); </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">lShiftTo</span><span class="s3">(</span><span class="s1">nsh</span><span class="s3">,</span><span class="s1">r</span><span class="s3">); } </span><span class="s2">else </span><span class="s3">{ </span><span class="s1">pm</span><span class="s3">.</span><span class="s1">copyTo</span><span class="s3">(</span><span class="s1">y</span><span class="s3">); </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">copyTo</span><span class="s3">(</span><span class="s1">r</span><span class="s3">); }</span>
  <span class="s2">var </span><span class="s1">ys </span><span class="s3">= </span><span class="s1">y</span><span class="s3">.</span><span class="s1">t</span><span class="s3">;</span>
  <span class="s2">var </span><span class="s1">y0 </span><span class="s3">= </span><span class="s1">y</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">ys</span><span class="s3">-</span><span class="s5">1</span><span class="s3">];</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">y0 </span><span class="s3">== </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return</span><span class="s3">;</span>
  <span class="s2">var </span><span class="s1">yt </span><span class="s3">= </span><span class="s1">y0</span><span class="s3">*(</span><span class="s5">1</span><span class="s3">&lt;&lt;</span><span class="s2">this</span><span class="s3">.</span><span class="s1">F1</span><span class="s3">)+((</span><span class="s1">ys</span><span class="s3">&gt;</span><span class="s5">1</span><span class="s3">)?</span><span class="s1">y</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">ys</span><span class="s3">-</span><span class="s5">2</span><span class="s3">]&gt;&gt;</span><span class="s2">this</span><span class="s3">.</span><span class="s1">F2</span><span class="s3">:</span><span class="s5">0</span><span class="s3">);</span>
  <span class="s2">var </span><span class="s1">d1 </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">FV</span><span class="s3">/</span><span class="s1">yt</span><span class="s3">, </span><span class="s1">d2 </span><span class="s3">= (</span><span class="s5">1</span><span class="s3">&lt;&lt;</span><span class="s2">this</span><span class="s3">.</span><span class="s1">F1</span><span class="s3">)/</span><span class="s1">yt</span><span class="s3">, </span><span class="s1">e </span><span class="s3">= </span><span class="s5">1</span><span class="s3">&lt;&lt;</span><span class="s2">this</span><span class="s3">.</span><span class="s1">F2</span><span class="s3">;</span>
  <span class="s2">var </span><span class="s1">i </span><span class="s3">= </span><span class="s1">r</span><span class="s3">.</span><span class="s1">t</span><span class="s3">, </span><span class="s1">j </span><span class="s3">= </span><span class="s1">i</span><span class="s3">-</span><span class="s1">ys</span><span class="s3">, </span><span class="s1">t </span><span class="s3">= (</span><span class="s1">q</span><span class="s3">==</span><span class="s2">null</span><span class="s3">)?</span><span class="s1">nbi</span><span class="s3">():</span><span class="s1">q</span><span class="s3">;</span>
  <span class="s1">y</span><span class="s3">.</span><span class="s1">dlShiftTo</span><span class="s3">(</span><span class="s1">j</span><span class="s3">,</span><span class="s1">t</span><span class="s3">);</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">r</span><span class="s3">.</span><span class="s1">compareTo</span><span class="s3">(</span><span class="s1">t</span><span class="s3">) &gt;= </span><span class="s5">0</span><span class="s3">) {</span>
    <span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">r</span><span class="s3">.</span><span class="s1">t</span><span class="s3">++] = </span><span class="s5">1</span><span class="s3">;</span>
    <span class="s1">r</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s1">t</span><span class="s3">,</span><span class="s1">r</span><span class="s3">);</span>
  <span class="s3">}</span>
  <span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">ONE</span><span class="s3">.</span><span class="s1">dlShiftTo</span><span class="s3">(</span><span class="s1">ys</span><span class="s3">,</span><span class="s1">t</span><span class="s3">);</span>
  <span class="s1">t</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s1">y</span><span class="s3">,</span><span class="s1">y</span><span class="s3">);	</span><span class="s0">// &quot;negative&quot; y so we can replace sub with am later</span>
  <span class="s2">while</span><span class="s3">(</span><span class="s1">y</span><span class="s3">.</span><span class="s1">t </span><span class="s3">&lt; </span><span class="s1">ys</span><span class="s3">) </span><span class="s1">y</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">y</span><span class="s3">.</span><span class="s1">t</span><span class="s3">++] = </span><span class="s5">0</span><span class="s3">;</span>
  <span class="s2">while</span><span class="s3">(--</span><span class="s1">j </span><span class="s3">&gt;= </span><span class="s5">0</span><span class="s3">) {</span>
    <span class="s0">// Estimate quotient digit</span>
    <span class="s2">var </span><span class="s1">qd </span><span class="s3">= (</span><span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[--</span><span class="s1">i</span><span class="s3">]==</span><span class="s1">y0</span><span class="s3">)?</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DM</span><span class="s3">:</span><span class="s1">Math</span><span class="s3">.</span><span class="s1">floor</span><span class="s3">(</span><span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]*</span><span class="s1">d1</span><span class="s3">+(</span><span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">-</span><span class="s5">1</span><span class="s3">]+</span><span class="s1">e</span><span class="s3">)*</span><span class="s1">d2</span><span class="s3">);</span>
    <span class="s2">if</span><span class="s3">((</span><span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]+=</span><span class="s1">y</span><span class="s3">.</span><span class="s1">am</span><span class="s3">(</span><span class="s5">0</span><span class="s3">,</span><span class="s1">qd</span><span class="s3">,</span><span class="s1">r</span><span class="s3">,</span><span class="s1">j</span><span class="s3">,</span><span class="s5">0</span><span class="s3">,</span><span class="s1">ys</span><span class="s3">)) &lt; </span><span class="s1">qd</span><span class="s3">) {	</span><span class="s0">// Try it out</span>
      <span class="s1">y</span><span class="s3">.</span><span class="s1">dlShiftTo</span><span class="s3">(</span><span class="s1">j</span><span class="s3">,</span><span class="s1">t</span><span class="s3">);</span>
      <span class="s1">r</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s1">t</span><span class="s3">,</span><span class="s1">r</span><span class="s3">);</span>
      <span class="s2">while</span><span class="s3">(</span><span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] &lt; --</span><span class="s1">qd</span><span class="s3">) </span><span class="s1">r</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s1">t</span><span class="s3">,</span><span class="s1">r</span><span class="s3">);</span>
    <span class="s3">}</span>
  <span class="s3">}</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">q </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">) {</span>
    <span class="s1">r</span><span class="s3">.</span><span class="s1">drShiftTo</span><span class="s3">(</span><span class="s1">ys</span><span class="s3">,</span><span class="s1">q</span><span class="s3">);</span>
    <span class="s2">if</span><span class="s3">(</span><span class="s1">ts </span><span class="s3">!= </span><span class="s1">ms</span><span class="s3">) </span><span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">ZERO</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s1">q</span><span class="s3">,</span><span class="s1">q</span><span class="s3">);</span>
  <span class="s3">}</span>
  <span class="s1">r</span><span class="s3">.</span><span class="s1">t </span><span class="s3">= </span><span class="s1">ys</span><span class="s3">;</span>
  <span class="s1">r</span><span class="s3">.</span><span class="s1">clamp</span><span class="s3">();</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">nsh </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">) </span><span class="s1">r</span><span class="s3">.</span><span class="s1">rShiftTo</span><span class="s3">(</span><span class="s1">nsh</span><span class="s3">,</span><span class="s1">r</span><span class="s3">);	</span><span class="s0">// Denormalize remainder</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">ts </span><span class="s3">&lt; </span><span class="s5">0</span><span class="s3">) </span><span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">ZERO</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s1">r</span><span class="s3">,</span><span class="s1">r</span><span class="s3">);</span>
<span class="s3">}</span>

<span class="s0">// (public) this mod a</span>
<span class="s2">function </span><span class="s1">bnMod</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) {</span>
  <span class="s2">var </span><span class="s1">r </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">();</span>
  <span class="s2">this</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">().</span><span class="s1">divRemTo</span><span class="s3">(</span><span class="s1">a</span><span class="s3">,</span><span class="s2">null</span><span class="s3">,</span><span class="s1">r</span><span class="s3">);</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">s </span><span class="s3">&lt; </span><span class="s5">0 </span><span class="s3">&amp;&amp; </span><span class="s1">r</span><span class="s3">.</span><span class="s1">compareTo</span><span class="s3">(</span><span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">ZERO</span><span class="s3">) &gt; </span><span class="s5">0</span><span class="s3">) </span><span class="s1">a</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s1">r</span><span class="s3">,</span><span class="s1">r</span><span class="s3">);</span>
  <span class="s2">return </span><span class="s1">r</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">// Modular reduction using &quot;classic&quot; algorithm</span>
<span class="s2">function </span><span class="s1">Classic</span><span class="s3">(</span><span class="s1">m</span><span class="s3">) { </span><span class="s2">this</span><span class="s3">.</span><span class="s1">m </span><span class="s3">= </span><span class="s1">m</span><span class="s3">; }</span>
<span class="s2">function </span><span class="s1">cConvert</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) {</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">s </span><span class="s3">&lt; </span><span class="s5">0 </span><span class="s3">|| </span><span class="s1">x</span><span class="s3">.</span><span class="s1">compareTo</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">m</span><span class="s3">) &gt;= </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return </span><span class="s1">x</span><span class="s3">.</span><span class="s1">mod</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">m</span><span class="s3">);</span>
  <span class="s2">else return </span><span class="s1">x</span><span class="s3">;</span>
<span class="s3">}</span>
<span class="s2">function </span><span class="s1">cRevert</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) { </span><span class="s2">return </span><span class="s1">x</span><span class="s3">; }</span>
<span class="s2">function </span><span class="s1">cReduce</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) { </span><span class="s1">x</span><span class="s3">.</span><span class="s1">divRemTo</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">m</span><span class="s3">,</span><span class="s2">null</span><span class="s3">,</span><span class="s1">x</span><span class="s3">); }</span>
<span class="s2">function </span><span class="s1">cMulTo</span><span class="s3">(</span><span class="s1">x</span><span class="s3">,</span><span class="s1">y</span><span class="s3">,</span><span class="s1">r</span><span class="s3">) { </span><span class="s1">x</span><span class="s3">.</span><span class="s1">multiplyTo</span><span class="s3">(</span><span class="s1">y</span><span class="s3">,</span><span class="s1">r</span><span class="s3">); </span><span class="s2">this</span><span class="s3">.</span><span class="s1">reduce</span><span class="s3">(</span><span class="s1">r</span><span class="s3">); }</span>
<span class="s2">function </span><span class="s1">cSqrTo</span><span class="s3">(</span><span class="s1">x</span><span class="s3">,</span><span class="s1">r</span><span class="s3">) { </span><span class="s1">x</span><span class="s3">.</span><span class="s1">squareTo</span><span class="s3">(</span><span class="s1">r</span><span class="s3">); </span><span class="s2">this</span><span class="s3">.</span><span class="s1">reduce</span><span class="s3">(</span><span class="s1">r</span><span class="s3">); }</span>

<span class="s1">Classic</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">convert </span><span class="s3">= </span><span class="s1">cConvert</span><span class="s3">;</span>
<span class="s1">Classic</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">revert </span><span class="s3">= </span><span class="s1">cRevert</span><span class="s3">;</span>
<span class="s1">Classic</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">reduce </span><span class="s3">= </span><span class="s1">cReduce</span><span class="s3">;</span>
<span class="s1">Classic</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">mulTo </span><span class="s3">= </span><span class="s1">cMulTo</span><span class="s3">;</span>
<span class="s1">Classic</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">sqrTo </span><span class="s3">= </span><span class="s1">cSqrTo</span><span class="s3">;</span>

<span class="s0">// (protected) return &quot;-1/this % 2^DB&quot;; useful for Mont. reduction</span>
<span class="s0">// justification:</span>
<span class="s0">//         xy == 1 (mod m)</span>
<span class="s0">//         xy =  1+km</span>
<span class="s0">//   xy(2-xy) = (1+km)(1-km)</span>
<span class="s0">// x[y(2-xy)] = 1-k^2m^2</span>
<span class="s0">// x[y(2-xy)] == 1 (mod m^2)</span>
<span class="s0">// if y is 1/x mod m, then y(2-xy) is 1/x mod m^2</span>
<span class="s0">// should reduce x and y(2-xy) by m^2 at each step to keep size bounded.</span>
<span class="s0">// JS multiply &quot;overflows&quot; differently from C/C++, so care is needed here.</span>
<span class="s2">function </span><span class="s1">bnpInvDigit</span><span class="s3">() {</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t </span><span class="s3">&lt; </span><span class="s5">1</span><span class="s3">) </span><span class="s2">return </span><span class="s5">0</span><span class="s3">;</span>
  <span class="s2">var </span><span class="s1">x </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s5">0</span><span class="s3">];</span>
  <span class="s2">if</span><span class="s3">((</span><span class="s1">x</span><span class="s3">&amp;</span><span class="s5">1</span><span class="s3">) == </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return </span><span class="s5">0</span><span class="s3">;</span>
  <span class="s2">var </span><span class="s1">y </span><span class="s3">= </span><span class="s1">x</span><span class="s3">&amp;</span><span class="s5">3</span><span class="s3">;		</span><span class="s0">// y == 1/x mod 2^2</span>
  <span class="s1">y </span><span class="s3">= (</span><span class="s1">y</span><span class="s3">*(</span><span class="s5">2</span><span class="s3">-(</span><span class="s1">x</span><span class="s3">&amp;</span><span class="s5">0xf</span><span class="s3">)*</span><span class="s1">y</span><span class="s3">))&amp;</span><span class="s5">0xf</span><span class="s3">;	</span><span class="s0">// y == 1/x mod 2^4</span>
  <span class="s1">y </span><span class="s3">= (</span><span class="s1">y</span><span class="s3">*(</span><span class="s5">2</span><span class="s3">-(</span><span class="s1">x</span><span class="s3">&amp;</span><span class="s5">0xff</span><span class="s3">)*</span><span class="s1">y</span><span class="s3">))&amp;</span><span class="s5">0xff</span><span class="s3">;	</span><span class="s0">// y == 1/x mod 2^8</span>
  <span class="s1">y </span><span class="s3">= (</span><span class="s1">y</span><span class="s3">*(</span><span class="s5">2</span><span class="s3">-(((</span><span class="s1">x</span><span class="s3">&amp;</span><span class="s5">0xffff</span><span class="s3">)*</span><span class="s1">y</span><span class="s3">)&amp;</span><span class="s5">0xffff</span><span class="s3">)))&amp;</span><span class="s5">0xffff</span><span class="s3">;	</span><span class="s0">// y == 1/x mod 2^16</span>
  <span class="s0">// last step - calculate inverse mod DV directly;</span>
  <span class="s0">// assumes 16 &lt; DB &lt;= 32 and assumes ability to handle 48-bit ints</span>
  <span class="s1">y </span><span class="s3">= (</span><span class="s1">y</span><span class="s3">*(</span><span class="s5">2</span><span class="s3">-</span><span class="s1">x</span><span class="s3">*</span><span class="s1">y</span><span class="s3">%</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DV</span><span class="s3">))%</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DV</span><span class="s3">;		</span><span class="s0">// y == 1/x mod 2^dbits</span>
  <span class="s0">// we really want the negative inverse, and -DV &lt; y &lt; DV</span>
  <span class="s2">return </span><span class="s3">(</span><span class="s1">y</span><span class="s3">&gt;</span><span class="s5">0</span><span class="s3">)?</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DV</span><span class="s3">-</span><span class="s1">y</span><span class="s3">:-</span><span class="s1">y</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">// Montgomery reduction</span>
<span class="s2">function </span><span class="s1">Montgomery</span><span class="s3">(</span><span class="s1">m</span><span class="s3">) {</span>
  <span class="s2">this</span><span class="s3">.</span><span class="s1">m </span><span class="s3">= </span><span class="s1">m</span><span class="s3">;</span>
  <span class="s2">this</span><span class="s3">.</span><span class="s1">mp </span><span class="s3">= </span><span class="s1">m</span><span class="s3">.</span><span class="s1">invDigit</span><span class="s3">();</span>
  <span class="s2">this</span><span class="s3">.</span><span class="s1">mpl </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">mp</span><span class="s3">&amp;</span><span class="s5">0x7fff</span><span class="s3">;</span>
  <span class="s2">this</span><span class="s3">.</span><span class="s1">mph </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">mp</span><span class="s3">&gt;&gt;</span><span class="s5">15</span><span class="s3">;</span>
  <span class="s2">this</span><span class="s3">.</span><span class="s1">um </span><span class="s3">= (</span><span class="s5">1</span><span class="s3">&lt;&lt;(</span><span class="s1">m</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">-</span><span class="s5">15</span><span class="s3">))-</span><span class="s5">1</span><span class="s3">;</span>
  <span class="s2">this</span><span class="s3">.</span><span class="s1">mt2 </span><span class="s3">= </span><span class="s5">2</span><span class="s3">*</span><span class="s1">m</span><span class="s3">.</span><span class="s1">t</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">// xR mod m</span>
<span class="s2">function </span><span class="s1">montConvert</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) {</span>
  <span class="s2">var </span><span class="s1">r </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">();</span>
  <span class="s1">x</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">().</span><span class="s1">dlShiftTo</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">m</span><span class="s3">.</span><span class="s1">t</span><span class="s3">,</span><span class="s1">r</span><span class="s3">);</span>
  <span class="s1">r</span><span class="s3">.</span><span class="s1">divRemTo</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">m</span><span class="s3">,</span><span class="s2">null</span><span class="s3">,</span><span class="s1">r</span><span class="s3">);</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">s </span><span class="s3">&lt; </span><span class="s5">0 </span><span class="s3">&amp;&amp; </span><span class="s1">r</span><span class="s3">.</span><span class="s1">compareTo</span><span class="s3">(</span><span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">ZERO</span><span class="s3">) &gt; </span><span class="s5">0</span><span class="s3">) </span><span class="s2">this</span><span class="s3">.</span><span class="s1">m</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s1">r</span><span class="s3">,</span><span class="s1">r</span><span class="s3">);</span>
  <span class="s2">return </span><span class="s1">r</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">// x/R mod m</span>
<span class="s2">function </span><span class="s1">montRevert</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) {</span>
  <span class="s2">var </span><span class="s1">r </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">();</span>
  <span class="s1">x</span><span class="s3">.</span><span class="s1">copyTo</span><span class="s3">(</span><span class="s1">r</span><span class="s3">);</span>
  <span class="s2">this</span><span class="s3">.</span><span class="s1">reduce</span><span class="s3">(</span><span class="s1">r</span><span class="s3">);</span>
  <span class="s2">return </span><span class="s1">r</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">// x = x/R mod m (HAC 14.32)</span>
<span class="s2">function </span><span class="s1">montReduce</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) {</span>
  <span class="s2">while</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">t </span><span class="s3">&lt;= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">mt2</span><span class="s3">)	</span><span class="s0">// pad x so am has enough room later</span>
    <span class="s1">x</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">x</span><span class="s3">.</span><span class="s1">t</span><span class="s3">++] = </span><span class="s5">0</span><span class="s3">;</span>
  <span class="s2">for</span><span class="s3">(</span><span class="s2">var </span><span class="s1">i </span><span class="s3">= </span><span class="s5">0</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s2">this</span><span class="s3">.</span><span class="s1">m</span><span class="s3">.</span><span class="s1">t</span><span class="s3">; ++</span><span class="s1">i</span><span class="s3">) {</span>
    <span class="s0">// faster way of calculating u0 = x.data[i]*mp mod DV</span>
    <span class="s2">var </span><span class="s1">j </span><span class="s3">= </span><span class="s1">x</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]&amp;</span><span class="s5">0x7fff</span><span class="s3">;</span>
    <span class="s2">var </span><span class="s1">u0 </span><span class="s3">= (</span><span class="s1">j</span><span class="s3">*</span><span class="s2">this</span><span class="s3">.</span><span class="s1">mpl</span><span class="s3">+(((</span><span class="s1">j</span><span class="s3">*</span><span class="s2">this</span><span class="s3">.</span><span class="s1">mph</span><span class="s3">+(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]&gt;&gt;</span><span class="s5">15</span><span class="s3">)*</span><span class="s2">this</span><span class="s3">.</span><span class="s1">mpl</span><span class="s3">)&amp;</span><span class="s2">this</span><span class="s3">.</span><span class="s1">um</span><span class="s3">)&lt;&lt;</span><span class="s5">15</span><span class="s3">))&amp;</span><span class="s1">x</span><span class="s3">.</span><span class="s1">DM</span><span class="s3">;</span>
    <span class="s0">// use am to combine the multiply-shift-add into one call</span>
    <span class="s1">j </span><span class="s3">= </span><span class="s1">i</span><span class="s3">+</span><span class="s2">this</span><span class="s3">.</span><span class="s1">m</span><span class="s3">.</span><span class="s1">t</span><span class="s3">;</span>
    <span class="s1">x</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">j</span><span class="s3">] += </span><span class="s2">this</span><span class="s3">.</span><span class="s1">m</span><span class="s3">.</span><span class="s1">am</span><span class="s3">(</span><span class="s5">0</span><span class="s3">,</span><span class="s1">u0</span><span class="s3">,</span><span class="s1">x</span><span class="s3">,</span><span class="s1">i</span><span class="s3">,</span><span class="s5">0</span><span class="s3">,</span><span class="s2">this</span><span class="s3">.</span><span class="s1">m</span><span class="s3">.</span><span class="s1">t</span><span class="s3">);</span>
    <span class="s0">// propagate carry</span>
    <span class="s2">while</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">j</span><span class="s3">] &gt;= </span><span class="s1">x</span><span class="s3">.</span><span class="s1">DV</span><span class="s3">) { </span><span class="s1">x</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">j</span><span class="s3">] -= </span><span class="s1">x</span><span class="s3">.</span><span class="s1">DV</span><span class="s3">; </span><span class="s1">x</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[++</span><span class="s1">j</span><span class="s3">]++; }</span>
  <span class="s3">}</span>
  <span class="s1">x</span><span class="s3">.</span><span class="s1">clamp</span><span class="s3">();</span>
  <span class="s1">x</span><span class="s3">.</span><span class="s1">drShiftTo</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">m</span><span class="s3">.</span><span class="s1">t</span><span class="s3">,</span><span class="s1">x</span><span class="s3">);</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">compareTo</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">m</span><span class="s3">) &gt;= </span><span class="s5">0</span><span class="s3">) </span><span class="s1">x</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">m</span><span class="s3">,</span><span class="s1">x</span><span class="s3">);</span>
<span class="s3">}</span>

<span class="s0">// r = &quot;x^2/R mod m&quot;; x != r</span>
<span class="s2">function </span><span class="s1">montSqrTo</span><span class="s3">(</span><span class="s1">x</span><span class="s3">,</span><span class="s1">r</span><span class="s3">) { </span><span class="s1">x</span><span class="s3">.</span><span class="s1">squareTo</span><span class="s3">(</span><span class="s1">r</span><span class="s3">); </span><span class="s2">this</span><span class="s3">.</span><span class="s1">reduce</span><span class="s3">(</span><span class="s1">r</span><span class="s3">); }</span>

<span class="s0">// r = &quot;xy/R mod m&quot;; x,y != r</span>
<span class="s2">function </span><span class="s1">montMulTo</span><span class="s3">(</span><span class="s1">x</span><span class="s3">,</span><span class="s1">y</span><span class="s3">,</span><span class="s1">r</span><span class="s3">) { </span><span class="s1">x</span><span class="s3">.</span><span class="s1">multiplyTo</span><span class="s3">(</span><span class="s1">y</span><span class="s3">,</span><span class="s1">r</span><span class="s3">); </span><span class="s2">this</span><span class="s3">.</span><span class="s1">reduce</span><span class="s3">(</span><span class="s1">r</span><span class="s3">); }</span>

<span class="s1">Montgomery</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">convert </span><span class="s3">= </span><span class="s1">montConvert</span><span class="s3">;</span>
<span class="s1">Montgomery</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">revert </span><span class="s3">= </span><span class="s1">montRevert</span><span class="s3">;</span>
<span class="s1">Montgomery</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">reduce </span><span class="s3">= </span><span class="s1">montReduce</span><span class="s3">;</span>
<span class="s1">Montgomery</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">mulTo </span><span class="s3">= </span><span class="s1">montMulTo</span><span class="s3">;</span>
<span class="s1">Montgomery</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">sqrTo </span><span class="s3">= </span><span class="s1">montSqrTo</span><span class="s3">;</span>

<span class="s0">// (protected) true iff this is even</span>
<span class="s2">function </span><span class="s1">bnpIsEven</span><span class="s3">() { </span><span class="s2">return </span><span class="s3">((</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">&gt;</span><span class="s5">0</span><span class="s3">)?(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]&amp;</span><span class="s5">1</span><span class="s3">):</span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">) == </span><span class="s5">0</span><span class="s3">; }</span>

<span class="s0">// (protected) this^e, e &lt; 2^32, doing sqr and mul with &quot;r&quot; (HAC 14.79)</span>
<span class="s2">function </span><span class="s1">bnpExp</span><span class="s3">(</span><span class="s1">e</span><span class="s3">,</span><span class="s1">z</span><span class="s3">) {</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">e </span><span class="s3">&gt; </span><span class="s5">0xffffffff </span><span class="s3">|| </span><span class="s1">e </span><span class="s3">&lt; </span><span class="s5">1</span><span class="s3">) </span><span class="s2">return </span><span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">ONE</span><span class="s3">;</span>
  <span class="s2">var </span><span class="s1">r </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">(), </span><span class="s1">r2 </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">(), </span><span class="s1">g </span><span class="s3">= </span><span class="s1">z</span><span class="s3">.</span><span class="s1">convert</span><span class="s3">(</span><span class="s2">this</span><span class="s3">), </span><span class="s1">i </span><span class="s3">= </span><span class="s1">nbits</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)-</span><span class="s5">1</span><span class="s3">;</span>
  <span class="s1">g</span><span class="s3">.</span><span class="s1">copyTo</span><span class="s3">(</span><span class="s1">r</span><span class="s3">);</span>
  <span class="s2">while</span><span class="s3">(--</span><span class="s1">i </span><span class="s3">&gt;= </span><span class="s5">0</span><span class="s3">) {</span>
    <span class="s1">z</span><span class="s3">.</span><span class="s1">sqrTo</span><span class="s3">(</span><span class="s1">r</span><span class="s3">,</span><span class="s1">r2</span><span class="s3">);</span>
    <span class="s2">if</span><span class="s3">((</span><span class="s1">e</span><span class="s3">&amp;(</span><span class="s5">1</span><span class="s3">&lt;&lt;</span><span class="s1">i</span><span class="s3">)) &gt; </span><span class="s5">0</span><span class="s3">) </span><span class="s1">z</span><span class="s3">.</span><span class="s1">mulTo</span><span class="s3">(</span><span class="s1">r2</span><span class="s3">,</span><span class="s1">g</span><span class="s3">,</span><span class="s1">r</span><span class="s3">);</span>
    <span class="s2">else </span><span class="s3">{ </span><span class="s2">var </span><span class="s1">t </span><span class="s3">= </span><span class="s1">r</span><span class="s3">; </span><span class="s1">r </span><span class="s3">= </span><span class="s1">r2</span><span class="s3">; </span><span class="s1">r2 </span><span class="s3">= </span><span class="s1">t</span><span class="s3">; }</span>
  <span class="s3">}</span>
  <span class="s2">return </span><span class="s1">z</span><span class="s3">.</span><span class="s1">revert</span><span class="s3">(</span><span class="s1">r</span><span class="s3">);</span>
<span class="s3">}</span>

<span class="s0">// (public) this^e % m, 0 &lt;= e &lt; 2^32</span>
<span class="s2">function </span><span class="s1">bnModPowInt</span><span class="s3">(</span><span class="s1">e</span><span class="s3">,</span><span class="s1">m</span><span class="s3">) {</span>
  <span class="s2">var </span><span class="s1">z</span><span class="s3">;</span>
  <span class="s2">if</span><span class="s3">(</span><span class="s1">e </span><span class="s3">&lt; </span><span class="s5">256 </span><span class="s3">|| </span><span class="s1">m</span><span class="s3">.</span><span class="s1">isEven</span><span class="s3">()) </span><span class="s1">z </span><span class="s3">= </span><span class="s2">new </span><span class="s1">Classic</span><span class="s3">(</span><span class="s1">m</span><span class="s3">); </span><span class="s2">else </span><span class="s1">z </span><span class="s3">= </span><span class="s2">new </span><span class="s1">Montgomery</span><span class="s3">(</span><span class="s1">m</span><span class="s3">);</span>
  <span class="s2">return this</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">e</span><span class="s3">,</span><span class="s1">z</span><span class="s3">);</span>
<span class="s3">}</span>

<span class="s0">// protected</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">copyTo </span><span class="s3">= </span><span class="s1">bnpCopyTo</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">fromInt </span><span class="s3">= </span><span class="s1">bnpFromInt</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">fromString </span><span class="s3">= </span><span class="s1">bnpFromString</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">clamp </span><span class="s3">= </span><span class="s1">bnpClamp</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">dlShiftTo </span><span class="s3">= </span><span class="s1">bnpDLShiftTo</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">drShiftTo </span><span class="s3">= </span><span class="s1">bnpDRShiftTo</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">lShiftTo </span><span class="s3">= </span><span class="s1">bnpLShiftTo</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">rShiftTo </span><span class="s3">= </span><span class="s1">bnpRShiftTo</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">subTo </span><span class="s3">= </span><span class="s1">bnpSubTo</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">multiplyTo </span><span class="s3">= </span><span class="s1">bnpMultiplyTo</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">squareTo </span><span class="s3">= </span><span class="s1">bnpSquareTo</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">divRemTo </span><span class="s3">= </span><span class="s1">bnpDivRemTo</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">invDigit </span><span class="s3">= </span><span class="s1">bnpInvDigit</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">isEven </span><span class="s3">= </span><span class="s1">bnpIsEven</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">exp </span><span class="s3">= </span><span class="s1">bnpExp</span><span class="s3">;</span>

<span class="s0">// public</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">toString </span><span class="s3">= </span><span class="s1">bnToString</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">negate </span><span class="s3">= </span><span class="s1">bnNegate</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">abs </span><span class="s3">= </span><span class="s1">bnAbs</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">compareTo </span><span class="s3">= </span><span class="s1">bnCompareTo</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">bitLength </span><span class="s3">= </span><span class="s1">bnBitLength</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">mod </span><span class="s3">= </span><span class="s1">bnMod</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">modPowInt </span><span class="s3">= </span><span class="s1">bnModPowInt</span><span class="s3">;</span>

<span class="s0">// &quot;constants&quot;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">ZERO </span><span class="s3">= </span><span class="s1">nbv</span><span class="s3">(</span><span class="s5">0</span><span class="s3">);</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">ONE </span><span class="s3">= </span><span class="s1">nbv</span><span class="s3">(</span><span class="s5">1</span><span class="s3">);</span>

<span class="s0">// jsbn2 lib</span>

<span class="s0">//Copyright (c) 2005-2009  Tom Wu</span>
<span class="s0">//All Rights Reserved.</span>
<span class="s0">//See &quot;LICENSE&quot; for details (See jsbn.js for LICENSE).</span>

<span class="s0">//Extended JavaScript BN functions, required for RSA private ops.</span>

<span class="s0">//Version 1.1: new BigInteger(&quot;0&quot;, 10) returns &quot;proper&quot; zero</span>

<span class="s0">//(public)</span>
<span class="s2">function </span><span class="s1">bnClone</span><span class="s3">() { </span><span class="s2">var </span><span class="s1">r </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">(); </span><span class="s2">this</span><span class="s3">.</span><span class="s1">copyTo</span><span class="s3">(</span><span class="s1">r</span><span class="s3">); </span><span class="s2">return </span><span class="s1">r</span><span class="s3">; }</span>

<span class="s0">//(public) return value as integer</span>
<span class="s2">function </span><span class="s1">bnIntValue</span><span class="s3">() {</span>
<span class="s2">if</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">s </span><span class="s3">&lt; </span><span class="s5">0</span><span class="s3">) {</span>
 <span class="s2">if</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t </span><span class="s3">== </span><span class="s5">1</span><span class="s3">) </span><span class="s2">return this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]-</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DV</span><span class="s3">;</span>
 <span class="s2">else if</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t </span><span class="s3">== </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return </span><span class="s3">-</span><span class="s5">1</span><span class="s3">;</span>
<span class="s3">} </span><span class="s2">else if</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t </span><span class="s3">== </span><span class="s5">1</span><span class="s3">) </span><span class="s2">return this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s5">0</span><span class="s3">];</span>
<span class="s2">else if</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t </span><span class="s3">== </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return </span><span class="s5">0</span><span class="s3">;</span>
<span class="s0">// assumes 16 &lt; DB &lt; 32</span>
<span class="s2">return </span><span class="s3">((</span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]&amp;((</span><span class="s5">1</span><span class="s3">&lt;&lt;(</span><span class="s5">32</span><span class="s3">-</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">))-</span><span class="s5">1</span><span class="s3">))&lt;&lt;</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">)|</span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s5">0</span><span class="s3">];</span>
<span class="s3">}</span>

<span class="s0">//(public) return value as byte</span>
<span class="s2">function </span><span class="s1">bnByteValue</span><span class="s3">() { </span><span class="s2">return </span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">==</span><span class="s5">0</span><span class="s3">)?</span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">:(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]&lt;&lt;</span><span class="s5">24</span><span class="s3">)&gt;&gt;</span><span class="s5">24</span><span class="s3">; }</span>

<span class="s0">//(public) return value as short (assumes DB&gt;=16)</span>
<span class="s2">function </span><span class="s1">bnShortValue</span><span class="s3">() { </span><span class="s2">return </span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">==</span><span class="s5">0</span><span class="s3">)?</span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">:(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]&lt;&lt;</span><span class="s5">16</span><span class="s3">)&gt;&gt;</span><span class="s5">16</span><span class="s3">; }</span>

<span class="s0">//(protected) return x s.t. r^x &lt; DV</span>
<span class="s2">function </span><span class="s1">bnpChunkSize</span><span class="s3">(</span><span class="s1">r</span><span class="s3">) { </span><span class="s2">return </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">floor</span><span class="s3">(</span><span class="s1">Math</span><span class="s3">.</span><span class="s1">LN2</span><span class="s3">*</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">/</span><span class="s1">Math</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">r</span><span class="s3">)); }</span>

<span class="s0">//(public) 0 if this == 0, 1 if this &gt; 0</span>
<span class="s2">function </span><span class="s1">bnSigNum</span><span class="s3">() {</span>
<span class="s2">if</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">s </span><span class="s3">&lt; </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return </span><span class="s3">-</span><span class="s5">1</span><span class="s3">;</span>
<span class="s2">else if</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t </span><span class="s3">&lt;= </span><span class="s5">0 </span><span class="s3">|| (</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t </span><span class="s3">== </span><span class="s5">1 </span><span class="s3">&amp;&amp; </span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] &lt;= </span><span class="s5">0</span><span class="s3">)) </span><span class="s2">return </span><span class="s5">0</span><span class="s3">;</span>
<span class="s2">else return </span><span class="s5">1</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">//(protected) convert to radix string</span>
<span class="s2">function </span><span class="s1">bnpToRadix</span><span class="s3">(</span><span class="s1">b</span><span class="s3">) {</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">b </span><span class="s3">== </span><span class="s2">null</span><span class="s3">) </span><span class="s1">b </span><span class="s3">= </span><span class="s5">10</span><span class="s3">;</span>
<span class="s2">if</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">signum</span><span class="s3">() == </span><span class="s5">0 </span><span class="s3">|| </span><span class="s1">b </span><span class="s3">&lt; </span><span class="s5">2 </span><span class="s3">|| </span><span class="s1">b </span><span class="s3">&gt; </span><span class="s5">36</span><span class="s3">) </span><span class="s2">return </span><span class="s4">&quot;0&quot;</span><span class="s3">;</span>
<span class="s2">var </span><span class="s1">cs </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">chunkSize</span><span class="s3">(</span><span class="s1">b</span><span class="s3">);</span>
<span class="s2">var </span><span class="s1">a </span><span class="s3">= </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">pow</span><span class="s3">(</span><span class="s1">b</span><span class="s3">,</span><span class="s1">cs</span><span class="s3">);</span>
<span class="s2">var </span><span class="s1">d </span><span class="s3">= </span><span class="s1">nbv</span><span class="s3">(</span><span class="s1">a</span><span class="s3">), </span><span class="s1">y </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">(), </span><span class="s1">z </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">(), </span><span class="s1">r </span><span class="s3">= </span><span class="s4">&quot;&quot;</span><span class="s3">;</span>
<span class="s2">this</span><span class="s3">.</span><span class="s1">divRemTo</span><span class="s3">(</span><span class="s1">d</span><span class="s3">,</span><span class="s1">y</span><span class="s3">,</span><span class="s1">z</span><span class="s3">);</span>
<span class="s2">while</span><span class="s3">(</span><span class="s1">y</span><span class="s3">.</span><span class="s1">signum</span><span class="s3">() &gt; </span><span class="s5">0</span><span class="s3">) {</span>
 <span class="s1">r </span><span class="s3">= (</span><span class="s1">a</span><span class="s3">+</span><span class="s1">z</span><span class="s3">.</span><span class="s1">intValue</span><span class="s3">()).</span><span class="s1">toString</span><span class="s3">(</span><span class="s1">b</span><span class="s3">).</span><span class="s1">substr</span><span class="s3">(</span><span class="s5">1</span><span class="s3">) + </span><span class="s1">r</span><span class="s3">;</span>
 <span class="s1">y</span><span class="s3">.</span><span class="s1">divRemTo</span><span class="s3">(</span><span class="s1">d</span><span class="s3">,</span><span class="s1">y</span><span class="s3">,</span><span class="s1">z</span><span class="s3">);</span>
<span class="s3">}</span>
<span class="s2">return </span><span class="s1">z</span><span class="s3">.</span><span class="s1">intValue</span><span class="s3">().</span><span class="s1">toString</span><span class="s3">(</span><span class="s1">b</span><span class="s3">) + </span><span class="s1">r</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">//(protected) convert from radix string</span>
<span class="s2">function </span><span class="s1">bnpFromRadix</span><span class="s3">(</span><span class="s1">s</span><span class="s3">,</span><span class="s1">b</span><span class="s3">) {</span>
<span class="s2">this</span><span class="s3">.</span><span class="s1">fromInt</span><span class="s3">(</span><span class="s5">0</span><span class="s3">);</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">b </span><span class="s3">== </span><span class="s2">null</span><span class="s3">) </span><span class="s1">b </span><span class="s3">= </span><span class="s5">10</span><span class="s3">;</span>
<span class="s2">var </span><span class="s1">cs </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">chunkSize</span><span class="s3">(</span><span class="s1">b</span><span class="s3">);</span>
<span class="s2">var </span><span class="s1">d </span><span class="s3">= </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">pow</span><span class="s3">(</span><span class="s1">b</span><span class="s3">,</span><span class="s1">cs</span><span class="s3">), </span><span class="s1">mi </span><span class="s3">= </span><span class="s2">false</span><span class="s3">, </span><span class="s1">j </span><span class="s3">= </span><span class="s5">0</span><span class="s3">, </span><span class="s1">w </span><span class="s3">= </span><span class="s5">0</span><span class="s3">;</span>
<span class="s2">for</span><span class="s3">(</span><span class="s2">var </span><span class="s1">i </span><span class="s3">= </span><span class="s5">0</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">s</span><span class="s3">.</span><span class="s1">length</span><span class="s3">; ++</span><span class="s1">i</span><span class="s3">) {</span>
 <span class="s2">var </span><span class="s1">x </span><span class="s3">= </span><span class="s1">intAt</span><span class="s3">(</span><span class="s1">s</span><span class="s3">,</span><span class="s1">i</span><span class="s3">);</span>
 <span class="s2">if</span><span class="s3">(</span><span class="s1">x </span><span class="s3">&lt; </span><span class="s5">0</span><span class="s3">) {</span>
   <span class="s2">if</span><span class="s3">(</span><span class="s1">s</span><span class="s3">.</span><span class="s1">charAt</span><span class="s3">(</span><span class="s1">i</span><span class="s3">) == </span><span class="s4">&quot;-&quot; </span><span class="s3">&amp;&amp; </span><span class="s2">this</span><span class="s3">.</span><span class="s1">signum</span><span class="s3">() == </span><span class="s5">0</span><span class="s3">) </span><span class="s1">mi </span><span class="s3">= </span><span class="s2">true</span><span class="s3">;</span>
   <span class="s2">continue</span><span class="s3">;</span>
 <span class="s3">}</span>
 <span class="s1">w </span><span class="s3">= </span><span class="s1">b</span><span class="s3">*</span><span class="s1">w</span><span class="s3">+</span><span class="s1">x</span><span class="s3">;</span>
 <span class="s2">if</span><span class="s3">(++</span><span class="s1">j </span><span class="s3">&gt;= </span><span class="s1">cs</span><span class="s3">) {</span>
   <span class="s2">this</span><span class="s3">.</span><span class="s1">dMultiply</span><span class="s3">(</span><span class="s1">d</span><span class="s3">);</span>
   <span class="s2">this</span><span class="s3">.</span><span class="s1">dAddOffset</span><span class="s3">(</span><span class="s1">w</span><span class="s3">,</span><span class="s5">0</span><span class="s3">);</span>
   <span class="s1">j </span><span class="s3">= </span><span class="s5">0</span><span class="s3">;</span>
   <span class="s1">w </span><span class="s3">= </span><span class="s5">0</span><span class="s3">;</span>
 <span class="s3">}</span>
<span class="s3">}</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">j </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">) {</span>
 <span class="s2">this</span><span class="s3">.</span><span class="s1">dMultiply</span><span class="s3">(</span><span class="s1">Math</span><span class="s3">.</span><span class="s1">pow</span><span class="s3">(</span><span class="s1">b</span><span class="s3">,</span><span class="s1">j</span><span class="s3">));</span>
 <span class="s2">this</span><span class="s3">.</span><span class="s1">dAddOffset</span><span class="s3">(</span><span class="s1">w</span><span class="s3">,</span><span class="s5">0</span><span class="s3">);</span>
<span class="s3">}</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">mi</span><span class="s3">) </span><span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">ZERO</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s2">this</span><span class="s3">,</span><span class="s2">this</span><span class="s3">);</span>
<span class="s3">}</span>

<span class="s0">//(protected) alternate constructor</span>
<span class="s2">function </span><span class="s1">bnpFromNumber</span><span class="s3">(</span><span class="s1">a</span><span class="s3">,</span><span class="s1">b</span><span class="s3">,</span><span class="s1">c</span><span class="s3">) {</span>
<span class="s2">if</span><span class="s3">(</span><span class="s4">&quot;number&quot; </span><span class="s3">== </span><span class="s2">typeof </span><span class="s1">b</span><span class="s3">) {</span>
 <span class="s0">// new BigInteger(int,int,RNG)</span>
 <span class="s2">if</span><span class="s3">(</span><span class="s1">a </span><span class="s3">&lt; </span><span class="s5">2</span><span class="s3">) </span><span class="s2">this</span><span class="s3">.</span><span class="s1">fromInt</span><span class="s3">(</span><span class="s5">1</span><span class="s3">);</span>
 <span class="s2">else </span><span class="s3">{</span>
   <span class="s2">this</span><span class="s3">.</span><span class="s1">fromNumber</span><span class="s3">(</span><span class="s1">a</span><span class="s3">,</span><span class="s1">c</span><span class="s3">);</span>
   <span class="s2">if</span><span class="s3">(!</span><span class="s2">this</span><span class="s3">.</span><span class="s1">testBit</span><span class="s3">(</span><span class="s1">a</span><span class="s3">-</span><span class="s5">1</span><span class="s3">))  </span><span class="s0">// force MSB set</span>
     <span class="s2">this</span><span class="s3">.</span><span class="s1">bitwiseTo</span><span class="s3">(</span><span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">ONE</span><span class="s3">.</span><span class="s1">shiftLeft</span><span class="s3">(</span><span class="s1">a</span><span class="s3">-</span><span class="s5">1</span><span class="s3">),</span><span class="s1">op_or</span><span class="s3">,</span><span class="s2">this</span><span class="s3">);</span>
   <span class="s2">if</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">isEven</span><span class="s3">()) </span><span class="s2">this</span><span class="s3">.</span><span class="s1">dAddOffset</span><span class="s3">(</span><span class="s5">1</span><span class="s3">,</span><span class="s5">0</span><span class="s3">); </span><span class="s0">// force odd</span>
   <span class="s2">while</span><span class="s3">(!</span><span class="s2">this</span><span class="s3">.</span><span class="s1">isProbablePrime</span><span class="s3">(</span><span class="s1">b</span><span class="s3">)) {</span>
     <span class="s2">this</span><span class="s3">.</span><span class="s1">dAddOffset</span><span class="s3">(</span><span class="s5">2</span><span class="s3">,</span><span class="s5">0</span><span class="s3">);</span>
     <span class="s2">if</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">bitLength</span><span class="s3">() &gt; </span><span class="s1">a</span><span class="s3">) </span><span class="s2">this</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">ONE</span><span class="s3">.</span><span class="s1">shiftLeft</span><span class="s3">(</span><span class="s1">a</span><span class="s3">-</span><span class="s5">1</span><span class="s3">),</span><span class="s2">this</span><span class="s3">);</span>
   <span class="s3">}</span>
 <span class="s3">}</span>
<span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
 <span class="s0">// new BigInteger(int,RNG)</span>
 <span class="s2">var </span><span class="s1">x </span><span class="s3">= </span><span class="s2">new </span><span class="s1">Array</span><span class="s3">(), </span><span class="s1">t </span><span class="s3">= </span><span class="s1">a</span><span class="s3">&amp;</span><span class="s5">7</span><span class="s3">;</span>
 <span class="s1">x</span><span class="s3">.</span><span class="s1">length </span><span class="s3">= (</span><span class="s1">a</span><span class="s3">&gt;&gt;</span><span class="s5">3</span><span class="s3">)+</span><span class="s5">1</span><span class="s3">;</span>
 <span class="s1">b</span><span class="s3">.</span><span class="s1">nextBytes</span><span class="s3">(</span><span class="s1">x</span><span class="s3">);</span>
 <span class="s2">if</span><span class="s3">(</span><span class="s1">t </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">) </span><span class="s1">x</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] &amp;= ((</span><span class="s5">1</span><span class="s3">&lt;&lt;</span><span class="s1">t</span><span class="s3">)-</span><span class="s5">1</span><span class="s3">); </span><span class="s2">else </span><span class="s1">x</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] = </span><span class="s5">0</span><span class="s3">;</span>
 <span class="s2">this</span><span class="s3">.</span><span class="s1">fromString</span><span class="s3">(</span><span class="s1">x</span><span class="s3">,</span><span class="s5">256</span><span class="s3">);</span>
<span class="s3">}</span>
<span class="s3">}</span>

<span class="s0">//(public) convert to bigendian byte array</span>
<span class="s2">function </span><span class="s1">bnToByteArray</span><span class="s3">() {</span>
<span class="s2">var </span><span class="s1">i </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">, </span><span class="s1">r </span><span class="s3">= </span><span class="s2">new </span><span class="s1">Array</span><span class="s3">();</span>
<span class="s1">r</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] = </span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">;</span>
<span class="s2">var </span><span class="s1">p </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">-(</span><span class="s1">i</span><span class="s3">*</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">)%</span><span class="s5">8</span><span class="s3">, </span><span class="s1">d</span><span class="s3">, </span><span class="s1">k </span><span class="s3">= </span><span class="s5">0</span><span class="s3">;</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">i</span><span class="s3">-- &gt; </span><span class="s5">0</span><span class="s3">) {</span>
 <span class="s2">if</span><span class="s3">(</span><span class="s1">p </span><span class="s3">&lt; </span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB </span><span class="s3">&amp;&amp; (</span><span class="s1">d </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]&gt;&gt;</span><span class="s1">p</span><span class="s3">) != (</span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">&amp;</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DM</span><span class="s3">)&gt;&gt;</span><span class="s1">p</span><span class="s3">)</span>
   <span class="s1">r</span><span class="s3">[</span><span class="s1">k</span><span class="s3">++] = </span><span class="s1">d</span><span class="s3">|(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">&lt;&lt;(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">-</span><span class="s1">p</span><span class="s3">));</span>
 <span class="s2">while</span><span class="s3">(</span><span class="s1">i </span><span class="s3">&gt;= </span><span class="s5">0</span><span class="s3">) {</span>
   <span class="s2">if</span><span class="s3">(</span><span class="s1">p </span><span class="s3">&lt; </span><span class="s5">8</span><span class="s3">) {</span>
     <span class="s1">d </span><span class="s3">= (</span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]&amp;((</span><span class="s5">1</span><span class="s3">&lt;&lt;</span><span class="s1">p</span><span class="s3">)-</span><span class="s5">1</span><span class="s3">))&lt;&lt;(</span><span class="s5">8</span><span class="s3">-</span><span class="s1">p</span><span class="s3">);</span>
     <span class="s1">d </span><span class="s3">|= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[--</span><span class="s1">i</span><span class="s3">]&gt;&gt;(</span><span class="s1">p</span><span class="s3">+=</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">-</span><span class="s5">8</span><span class="s3">);</span>
   <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
     <span class="s1">d </span><span class="s3">= (</span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]&gt;&gt;(</span><span class="s1">p</span><span class="s3">-=</span><span class="s5">8</span><span class="s3">))&amp;</span><span class="s5">0xff</span><span class="s3">;</span>
     <span class="s2">if</span><span class="s3">(</span><span class="s1">p </span><span class="s3">&lt;= </span><span class="s5">0</span><span class="s3">) { </span><span class="s1">p </span><span class="s3">+= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">; --</span><span class="s1">i</span><span class="s3">; }</span>
   <span class="s3">}</span>
   <span class="s2">if</span><span class="s3">((</span><span class="s1">d</span><span class="s3">&amp;</span><span class="s5">0x80</span><span class="s3">) != </span><span class="s5">0</span><span class="s3">) </span><span class="s1">d </span><span class="s3">|= -</span><span class="s5">256</span><span class="s3">;</span>
   <span class="s2">if</span><span class="s3">(</span><span class="s1">k </span><span class="s3">== </span><span class="s5">0 </span><span class="s3">&amp;&amp; (</span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">&amp;</span><span class="s5">0x80</span><span class="s3">) != (</span><span class="s1">d</span><span class="s3">&amp;</span><span class="s5">0x80</span><span class="s3">)) ++</span><span class="s1">k</span><span class="s3">;</span>
   <span class="s2">if</span><span class="s3">(</span><span class="s1">k </span><span class="s3">&gt; </span><span class="s5">0 </span><span class="s3">|| </span><span class="s1">d </span><span class="s3">!= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">) </span><span class="s1">r</span><span class="s3">[</span><span class="s1">k</span><span class="s3">++] = </span><span class="s1">d</span><span class="s3">;</span>
 <span class="s3">}</span>
<span class="s3">}</span>
<span class="s2">return </span><span class="s1">r</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s2">function </span><span class="s1">bnEquals</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) { </span><span class="s2">return</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">compareTo</span><span class="s3">(</span><span class="s1">a</span><span class="s3">)==</span><span class="s5">0</span><span class="s3">); }</span>
<span class="s2">function </span><span class="s1">bnMin</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) { </span><span class="s2">return</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">compareTo</span><span class="s3">(</span><span class="s1">a</span><span class="s3">)&lt;</span><span class="s5">0</span><span class="s3">)?</span><span class="s2">this</span><span class="s3">:</span><span class="s1">a</span><span class="s3">; }</span>
<span class="s2">function </span><span class="s1">bnMax</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) { </span><span class="s2">return</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">compareTo</span><span class="s3">(</span><span class="s1">a</span><span class="s3">)&gt;</span><span class="s5">0</span><span class="s3">)?</span><span class="s2">this</span><span class="s3">:</span><span class="s1">a</span><span class="s3">; }</span>

<span class="s0">//(protected) r = this op a (bitwise)</span>
<span class="s2">function </span><span class="s1">bnpBitwiseTo</span><span class="s3">(</span><span class="s1">a</span><span class="s3">,</span><span class="s1">op</span><span class="s3">,</span><span class="s1">r</span><span class="s3">) {</span>
<span class="s2">var </span><span class="s1">i</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s1">m </span><span class="s3">= </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(</span><span class="s1">a</span><span class="s3">.</span><span class="s1">t</span><span class="s3">,</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">);</span>
<span class="s2">for</span><span class="s3">(</span><span class="s1">i </span><span class="s3">= </span><span class="s5">0</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">m</span><span class="s3">; ++</span><span class="s1">i</span><span class="s3">) </span><span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s1">op</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">],</span><span class="s1">a</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]);</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">a</span><span class="s3">.</span><span class="s1">t </span><span class="s3">&lt; </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">) {</span>
 <span class="s1">f </span><span class="s3">= </span><span class="s1">a</span><span class="s3">.</span><span class="s1">s</span><span class="s3">&amp;</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DM</span><span class="s3">;</span>
 <span class="s2">for</span><span class="s3">(</span><span class="s1">i </span><span class="s3">= </span><span class="s1">m</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">; ++</span><span class="s1">i</span><span class="s3">) </span><span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s1">op</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">],</span><span class="s1">f</span><span class="s3">);</span>
 <span class="s1">r</span><span class="s3">.</span><span class="s1">t </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">;</span>
<span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
 <span class="s1">f </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">&amp;</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DM</span><span class="s3">;</span>
 <span class="s2">for</span><span class="s3">(</span><span class="s1">i </span><span class="s3">= </span><span class="s1">m</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">a</span><span class="s3">.</span><span class="s1">t</span><span class="s3">; ++</span><span class="s1">i</span><span class="s3">) </span><span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s1">op</span><span class="s3">(</span><span class="s1">f</span><span class="s3">,</span><span class="s1">a</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]);</span>
 <span class="s1">r</span><span class="s3">.</span><span class="s1">t </span><span class="s3">= </span><span class="s1">a</span><span class="s3">.</span><span class="s1">t</span><span class="s3">;</span>
<span class="s3">}</span>
<span class="s1">r</span><span class="s3">.</span><span class="s1">s </span><span class="s3">= </span><span class="s1">op</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">,</span><span class="s1">a</span><span class="s3">.</span><span class="s1">s</span><span class="s3">);</span>
<span class="s1">r</span><span class="s3">.</span><span class="s1">clamp</span><span class="s3">();</span>
<span class="s3">}</span>

<span class="s0">//(public) this &amp; a</span>
<span class="s2">function </span><span class="s1">op_and</span><span class="s3">(</span><span class="s1">x</span><span class="s3">,</span><span class="s1">y</span><span class="s3">) { </span><span class="s2">return </span><span class="s1">x</span><span class="s3">&amp;</span><span class="s1">y</span><span class="s3">; }</span>
<span class="s2">function </span><span class="s1">bnAnd</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) { </span><span class="s2">var </span><span class="s1">r </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">(); </span><span class="s2">this</span><span class="s3">.</span><span class="s1">bitwiseTo</span><span class="s3">(</span><span class="s1">a</span><span class="s3">,</span><span class="s1">op_and</span><span class="s3">,</span><span class="s1">r</span><span class="s3">); </span><span class="s2">return </span><span class="s1">r</span><span class="s3">; }</span>

<span class="s0">//(public) this | a</span>
<span class="s2">function </span><span class="s1">op_or</span><span class="s3">(</span><span class="s1">x</span><span class="s3">,</span><span class="s1">y</span><span class="s3">) { </span><span class="s2">return </span><span class="s1">x</span><span class="s3">|</span><span class="s1">y</span><span class="s3">; }</span>
<span class="s2">function </span><span class="s1">bnOr</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) { </span><span class="s2">var </span><span class="s1">r </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">(); </span><span class="s2">this</span><span class="s3">.</span><span class="s1">bitwiseTo</span><span class="s3">(</span><span class="s1">a</span><span class="s3">,</span><span class="s1">op_or</span><span class="s3">,</span><span class="s1">r</span><span class="s3">); </span><span class="s2">return </span><span class="s1">r</span><span class="s3">; }</span>

<span class="s0">//(public) this ^ a</span>
<span class="s2">function </span><span class="s1">op_xor</span><span class="s3">(</span><span class="s1">x</span><span class="s3">,</span><span class="s1">y</span><span class="s3">) { </span><span class="s2">return </span><span class="s1">x</span><span class="s3">^</span><span class="s1">y</span><span class="s3">; }</span>
<span class="s2">function </span><span class="s1">bnXor</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) { </span><span class="s2">var </span><span class="s1">r </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">(); </span><span class="s2">this</span><span class="s3">.</span><span class="s1">bitwiseTo</span><span class="s3">(</span><span class="s1">a</span><span class="s3">,</span><span class="s1">op_xor</span><span class="s3">,</span><span class="s1">r</span><span class="s3">); </span><span class="s2">return </span><span class="s1">r</span><span class="s3">; }</span>

<span class="s0">//(public) this &amp; ~a</span>
<span class="s2">function </span><span class="s1">op_andnot</span><span class="s3">(</span><span class="s1">x</span><span class="s3">,</span><span class="s1">y</span><span class="s3">) { </span><span class="s2">return </span><span class="s1">x</span><span class="s3">&amp;~</span><span class="s1">y</span><span class="s3">; }</span>
<span class="s2">function </span><span class="s1">bnAndNot</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) { </span><span class="s2">var </span><span class="s1">r </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">(); </span><span class="s2">this</span><span class="s3">.</span><span class="s1">bitwiseTo</span><span class="s3">(</span><span class="s1">a</span><span class="s3">,</span><span class="s1">op_andnot</span><span class="s3">,</span><span class="s1">r</span><span class="s3">); </span><span class="s2">return </span><span class="s1">r</span><span class="s3">; }</span>

<span class="s0">//(public) ~this</span>
<span class="s2">function </span><span class="s1">bnNot</span><span class="s3">() {</span>
<span class="s2">var </span><span class="s1">r </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">();</span>
<span class="s2">for</span><span class="s3">(</span><span class="s2">var </span><span class="s1">i </span><span class="s3">= </span><span class="s5">0</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">; ++</span><span class="s1">i</span><span class="s3">) </span><span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s2">this</span><span class="s3">.</span><span class="s1">DM</span><span class="s3">&amp;~</span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">];</span>
<span class="s1">r</span><span class="s3">.</span><span class="s1">t </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">;</span>
<span class="s1">r</span><span class="s3">.</span><span class="s1">s </span><span class="s3">= ~</span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">;</span>
<span class="s2">return </span><span class="s1">r</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">//(public) this &lt;&lt; n</span>
<span class="s2">function </span><span class="s1">bnShiftLeft</span><span class="s3">(</span><span class="s1">n</span><span class="s3">) {</span>
<span class="s2">var </span><span class="s1">r </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">();</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">n </span><span class="s3">&lt; </span><span class="s5">0</span><span class="s3">) </span><span class="s2">this</span><span class="s3">.</span><span class="s1">rShiftTo</span><span class="s3">(-</span><span class="s1">n</span><span class="s3">,</span><span class="s1">r</span><span class="s3">); </span><span class="s2">else this</span><span class="s3">.</span><span class="s1">lShiftTo</span><span class="s3">(</span><span class="s1">n</span><span class="s3">,</span><span class="s1">r</span><span class="s3">);</span>
<span class="s2">return </span><span class="s1">r</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">//(public) this &gt;&gt; n</span>
<span class="s2">function </span><span class="s1">bnShiftRight</span><span class="s3">(</span><span class="s1">n</span><span class="s3">) {</span>
<span class="s2">var </span><span class="s1">r </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">();</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">n </span><span class="s3">&lt; </span><span class="s5">0</span><span class="s3">) </span><span class="s2">this</span><span class="s3">.</span><span class="s1">lShiftTo</span><span class="s3">(-</span><span class="s1">n</span><span class="s3">,</span><span class="s1">r</span><span class="s3">); </span><span class="s2">else this</span><span class="s3">.</span><span class="s1">rShiftTo</span><span class="s3">(</span><span class="s1">n</span><span class="s3">,</span><span class="s1">r</span><span class="s3">);</span>
<span class="s2">return </span><span class="s1">r</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">//return index of lowest 1-bit in x, x &lt; 2^31</span>
<span class="s2">function </span><span class="s1">lbit</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) {</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">x </span><span class="s3">== </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return </span><span class="s3">-</span><span class="s5">1</span><span class="s3">;</span>
<span class="s2">var </span><span class="s1">r </span><span class="s3">= </span><span class="s5">0</span><span class="s3">;</span>
<span class="s2">if</span><span class="s3">((</span><span class="s1">x</span><span class="s3">&amp;</span><span class="s5">0xffff</span><span class="s3">) == </span><span class="s5">0</span><span class="s3">) { </span><span class="s1">x </span><span class="s3">&gt;&gt;= </span><span class="s5">16</span><span class="s3">; </span><span class="s1">r </span><span class="s3">+= </span><span class="s5">16</span><span class="s3">; }</span>
<span class="s2">if</span><span class="s3">((</span><span class="s1">x</span><span class="s3">&amp;</span><span class="s5">0xff</span><span class="s3">) == </span><span class="s5">0</span><span class="s3">) { </span><span class="s1">x </span><span class="s3">&gt;&gt;= </span><span class="s5">8</span><span class="s3">; </span><span class="s1">r </span><span class="s3">+= </span><span class="s5">8</span><span class="s3">; }</span>
<span class="s2">if</span><span class="s3">((</span><span class="s1">x</span><span class="s3">&amp;</span><span class="s5">0xf</span><span class="s3">) == </span><span class="s5">0</span><span class="s3">) { </span><span class="s1">x </span><span class="s3">&gt;&gt;= </span><span class="s5">4</span><span class="s3">; </span><span class="s1">r </span><span class="s3">+= </span><span class="s5">4</span><span class="s3">; }</span>
<span class="s2">if</span><span class="s3">((</span><span class="s1">x</span><span class="s3">&amp;</span><span class="s5">3</span><span class="s3">) == </span><span class="s5">0</span><span class="s3">) { </span><span class="s1">x </span><span class="s3">&gt;&gt;= </span><span class="s5">2</span><span class="s3">; </span><span class="s1">r </span><span class="s3">+= </span><span class="s5">2</span><span class="s3">; }</span>
<span class="s2">if</span><span class="s3">((</span><span class="s1">x</span><span class="s3">&amp;</span><span class="s5">1</span><span class="s3">) == </span><span class="s5">0</span><span class="s3">) ++</span><span class="s1">r</span><span class="s3">;</span>
<span class="s2">return </span><span class="s1">r</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">//(public) returns index of lowest 1-bit (or -1 if none)</span>
<span class="s2">function </span><span class="s1">bnGetLowestSetBit</span><span class="s3">() {</span>
<span class="s2">for</span><span class="s3">(</span><span class="s2">var </span><span class="s1">i </span><span class="s3">= </span><span class="s5">0</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">; ++</span><span class="s1">i</span><span class="s3">)</span>
 <span class="s2">if</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] != </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return </span><span class="s1">i</span><span class="s3">*</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">+</span><span class="s1">lbit</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]);</span>
<span class="s2">if</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">s </span><span class="s3">&lt; </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">*</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">;</span>
<span class="s2">return </span><span class="s3">-</span><span class="s5">1</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">//return number of 1 bits in x</span>
<span class="s2">function </span><span class="s1">cbit</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) {</span>
<span class="s2">var </span><span class="s1">r </span><span class="s3">= </span><span class="s5">0</span><span class="s3">;</span>
<span class="s2">while</span><span class="s3">(</span><span class="s1">x </span><span class="s3">!= </span><span class="s5">0</span><span class="s3">) { </span><span class="s1">x </span><span class="s3">&amp;= </span><span class="s1">x</span><span class="s3">-</span><span class="s5">1</span><span class="s3">; ++</span><span class="s1">r</span><span class="s3">; }</span>
<span class="s2">return </span><span class="s1">r</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">//(public) return number of set bits</span>
<span class="s2">function </span><span class="s1">bnBitCount</span><span class="s3">() {</span>
<span class="s2">var </span><span class="s1">r </span><span class="s3">= </span><span class="s5">0</span><span class="s3">, </span><span class="s1">x </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">&amp;</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DM</span><span class="s3">;</span>
<span class="s2">for</span><span class="s3">(</span><span class="s2">var </span><span class="s1">i </span><span class="s3">= </span><span class="s5">0</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">; ++</span><span class="s1">i</span><span class="s3">) </span><span class="s1">r </span><span class="s3">+= </span><span class="s1">cbit</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]^</span><span class="s1">x</span><span class="s3">);</span>
<span class="s2">return </span><span class="s1">r</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">//(public) true iff nth bit is set</span>
<span class="s2">function </span><span class="s1">bnTestBit</span><span class="s3">(</span><span class="s1">n</span><span class="s3">) {</span>
<span class="s2">var </span><span class="s1">j </span><span class="s3">= </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">floor</span><span class="s3">(</span><span class="s1">n</span><span class="s3">/</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">);</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">j </span><span class="s3">&gt;= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">) </span><span class="s2">return</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">!=</span><span class="s5">0</span><span class="s3">);</span>
<span class="s2">return</span><span class="s3">((</span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">j</span><span class="s3">]&amp;(</span><span class="s5">1</span><span class="s3">&lt;&lt;(</span><span class="s1">n</span><span class="s3">%</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">)))!=</span><span class="s5">0</span><span class="s3">);</span>
<span class="s3">}</span>

<span class="s0">//(protected) this op (1&lt;&lt;n)</span>
<span class="s2">function </span><span class="s1">bnpChangeBit</span><span class="s3">(</span><span class="s1">n</span><span class="s3">,</span><span class="s1">op</span><span class="s3">) {</span>
<span class="s2">var </span><span class="s1">r </span><span class="s3">= </span><span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">ONE</span><span class="s3">.</span><span class="s1">shiftLeft</span><span class="s3">(</span><span class="s1">n</span><span class="s3">);</span>
<span class="s2">this</span><span class="s3">.</span><span class="s1">bitwiseTo</span><span class="s3">(</span><span class="s1">r</span><span class="s3">,</span><span class="s1">op</span><span class="s3">,</span><span class="s1">r</span><span class="s3">);</span>
<span class="s2">return </span><span class="s1">r</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">//(public) this | (1&lt;&lt;n)</span>
<span class="s2">function </span><span class="s1">bnSetBit</span><span class="s3">(</span><span class="s1">n</span><span class="s3">) { </span><span class="s2">return this</span><span class="s3">.</span><span class="s1">changeBit</span><span class="s3">(</span><span class="s1">n</span><span class="s3">,</span><span class="s1">op_or</span><span class="s3">); }</span>

<span class="s0">//(public) this &amp; ~(1&lt;&lt;n)</span>
<span class="s2">function </span><span class="s1">bnClearBit</span><span class="s3">(</span><span class="s1">n</span><span class="s3">) { </span><span class="s2">return this</span><span class="s3">.</span><span class="s1">changeBit</span><span class="s3">(</span><span class="s1">n</span><span class="s3">,</span><span class="s1">op_andnot</span><span class="s3">); }</span>

<span class="s0">//(public) this ^ (1&lt;&lt;n)</span>
<span class="s2">function </span><span class="s1">bnFlipBit</span><span class="s3">(</span><span class="s1">n</span><span class="s3">) { </span><span class="s2">return this</span><span class="s3">.</span><span class="s1">changeBit</span><span class="s3">(</span><span class="s1">n</span><span class="s3">,</span><span class="s1">op_xor</span><span class="s3">); }</span>

<span class="s0">//(protected) r = this + a</span>
<span class="s2">function </span><span class="s1">bnpAddTo</span><span class="s3">(</span><span class="s1">a</span><span class="s3">,</span><span class="s1">r</span><span class="s3">) {</span>
<span class="s2">var </span><span class="s1">i </span><span class="s3">= </span><span class="s5">0</span><span class="s3">, </span><span class="s1">c </span><span class="s3">= </span><span class="s5">0</span><span class="s3">, </span><span class="s1">m </span><span class="s3">= </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(</span><span class="s1">a</span><span class="s3">.</span><span class="s1">t</span><span class="s3">,</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">);</span>
<span class="s2">while</span><span class="s3">(</span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">m</span><span class="s3">) {</span>
 <span class="s1">c </span><span class="s3">+= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]+</span><span class="s1">a</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">];</span>
 <span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">++] = </span><span class="s1">c</span><span class="s3">&amp;</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DM</span><span class="s3">;</span>
 <span class="s1">c </span><span class="s3">&gt;&gt;= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">;</span>
<span class="s3">}</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">a</span><span class="s3">.</span><span class="s1">t </span><span class="s3">&lt; </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">) {</span>
 <span class="s1">c </span><span class="s3">+= </span><span class="s1">a</span><span class="s3">.</span><span class="s1">s</span><span class="s3">;</span>
 <span class="s2">while</span><span class="s3">(</span><span class="s1">i </span><span class="s3">&lt; </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">) {</span>
   <span class="s1">c </span><span class="s3">+= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">];</span>
   <span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">++] = </span><span class="s1">c</span><span class="s3">&amp;</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DM</span><span class="s3">;</span>
   <span class="s1">c </span><span class="s3">&gt;&gt;= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">;</span>
 <span class="s3">}</span>
 <span class="s1">c </span><span class="s3">+= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">;</span>
<span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
 <span class="s1">c </span><span class="s3">+= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">;</span>
 <span class="s2">while</span><span class="s3">(</span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">a</span><span class="s3">.</span><span class="s1">t</span><span class="s3">) {</span>
   <span class="s1">c </span><span class="s3">+= </span><span class="s1">a</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">];</span>
   <span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">++] = </span><span class="s1">c</span><span class="s3">&amp;</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DM</span><span class="s3">;</span>
   <span class="s1">c </span><span class="s3">&gt;&gt;= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">;</span>
 <span class="s3">}</span>
 <span class="s1">c </span><span class="s3">+= </span><span class="s1">a</span><span class="s3">.</span><span class="s1">s</span><span class="s3">;</span>
<span class="s3">}</span>
<span class="s1">r</span><span class="s3">.</span><span class="s1">s </span><span class="s3">= (</span><span class="s1">c</span><span class="s3">&lt;</span><span class="s5">0</span><span class="s3">)?-</span><span class="s5">1</span><span class="s3">:</span><span class="s5">0</span><span class="s3">;</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">c </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">) </span><span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">++] = </span><span class="s1">c</span><span class="s3">;</span>
<span class="s2">else if</span><span class="s3">(</span><span class="s1">c </span><span class="s3">&lt; -</span><span class="s5">1</span><span class="s3">) </span><span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">++] = </span><span class="s2">this</span><span class="s3">.</span><span class="s1">DV</span><span class="s3">+</span><span class="s1">c</span><span class="s3">;</span>
<span class="s1">r</span><span class="s3">.</span><span class="s1">t </span><span class="s3">= </span><span class="s1">i</span><span class="s3">;</span>
<span class="s1">r</span><span class="s3">.</span><span class="s1">clamp</span><span class="s3">();</span>
<span class="s3">}</span>

<span class="s0">//(public) this + a</span>
<span class="s2">function </span><span class="s1">bnAdd</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) { </span><span class="s2">var </span><span class="s1">r </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">(); </span><span class="s2">this</span><span class="s3">.</span><span class="s1">addTo</span><span class="s3">(</span><span class="s1">a</span><span class="s3">,</span><span class="s1">r</span><span class="s3">); </span><span class="s2">return </span><span class="s1">r</span><span class="s3">; }</span>

<span class="s0">//(public) this - a</span>
<span class="s2">function </span><span class="s1">bnSubtract</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) { </span><span class="s2">var </span><span class="s1">r </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">(); </span><span class="s2">this</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s1">a</span><span class="s3">,</span><span class="s1">r</span><span class="s3">); </span><span class="s2">return </span><span class="s1">r</span><span class="s3">; }</span>

<span class="s0">//(public) this * a</span>
<span class="s2">function </span><span class="s1">bnMultiply</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) { </span><span class="s2">var </span><span class="s1">r </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">(); </span><span class="s2">this</span><span class="s3">.</span><span class="s1">multiplyTo</span><span class="s3">(</span><span class="s1">a</span><span class="s3">,</span><span class="s1">r</span><span class="s3">); </span><span class="s2">return </span><span class="s1">r</span><span class="s3">; }</span>

<span class="s0">//(public) this / a</span>
<span class="s2">function </span><span class="s1">bnDivide</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) { </span><span class="s2">var </span><span class="s1">r </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">(); </span><span class="s2">this</span><span class="s3">.</span><span class="s1">divRemTo</span><span class="s3">(</span><span class="s1">a</span><span class="s3">,</span><span class="s1">r</span><span class="s3">,</span><span class="s2">null</span><span class="s3">); </span><span class="s2">return </span><span class="s1">r</span><span class="s3">; }</span>

<span class="s0">//(public) this % a</span>
<span class="s2">function </span><span class="s1">bnRemainder</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) { </span><span class="s2">var </span><span class="s1">r </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">(); </span><span class="s2">this</span><span class="s3">.</span><span class="s1">divRemTo</span><span class="s3">(</span><span class="s1">a</span><span class="s3">,</span><span class="s2">null</span><span class="s3">,</span><span class="s1">r</span><span class="s3">); </span><span class="s2">return </span><span class="s1">r</span><span class="s3">; }</span>

<span class="s0">//(public) [this/a,this%a]</span>
<span class="s2">function </span><span class="s1">bnDivideAndRemainder</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) {</span>
<span class="s2">var </span><span class="s1">q </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">(), </span><span class="s1">r </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">();</span>
<span class="s2">this</span><span class="s3">.</span><span class="s1">divRemTo</span><span class="s3">(</span><span class="s1">a</span><span class="s3">,</span><span class="s1">q</span><span class="s3">,</span><span class="s1">r</span><span class="s3">);</span>
<span class="s2">return new </span><span class="s1">Array</span><span class="s3">(</span><span class="s1">q</span><span class="s3">,</span><span class="s1">r</span><span class="s3">);</span>
<span class="s3">}</span>

<span class="s0">//(protected) this *= n, this &gt;= 0, 1 &lt; n &lt; DV</span>
<span class="s2">function </span><span class="s1">bnpDMultiply</span><span class="s3">(</span><span class="s1">n</span><span class="s3">) {</span>
<span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">] = </span><span class="s2">this</span><span class="s3">.</span><span class="s1">am</span><span class="s3">(</span><span class="s5">0</span><span class="s3">,</span><span class="s1">n</span><span class="s3">-</span><span class="s5">1</span><span class="s3">,</span><span class="s2">this</span><span class="s3">,</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">,</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">);</span>
<span class="s3">++</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">;</span>
<span class="s2">this</span><span class="s3">.</span><span class="s1">clamp</span><span class="s3">();</span>
<span class="s3">}</span>

<span class="s0">//(protected) this += n &lt;&lt; w words, this &gt;= 0</span>
<span class="s2">function </span><span class="s1">bnpDAddOffset</span><span class="s3">(</span><span class="s1">n</span><span class="s3">,</span><span class="s1">w</span><span class="s3">) {</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">n </span><span class="s3">== </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return</span><span class="s3">;</span>
<span class="s2">while</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t </span><span class="s3">&lt;= </span><span class="s1">w</span><span class="s3">) </span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">++] = </span><span class="s5">0</span><span class="s3">;</span>
<span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">w</span><span class="s3">] += </span><span class="s1">n</span><span class="s3">;</span>
<span class="s2">while</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">w</span><span class="s3">] &gt;= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">DV</span><span class="s3">) {</span>
 <span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">w</span><span class="s3">] -= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">DV</span><span class="s3">;</span>
 <span class="s2">if</span><span class="s3">(++</span><span class="s1">w </span><span class="s3">&gt;= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">) </span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">++] = </span><span class="s5">0</span><span class="s3">;</span>
 <span class="s3">++</span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">w</span><span class="s3">];</span>
<span class="s3">}</span>
<span class="s3">}</span>

<span class="s0">//A &quot;null&quot; reducer</span>
<span class="s2">function </span><span class="s1">NullExp</span><span class="s3">() {}</span>
<span class="s2">function </span><span class="s1">nNop</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) { </span><span class="s2">return </span><span class="s1">x</span><span class="s3">; }</span>
<span class="s2">function </span><span class="s1">nMulTo</span><span class="s3">(</span><span class="s1">x</span><span class="s3">,</span><span class="s1">y</span><span class="s3">,</span><span class="s1">r</span><span class="s3">) { </span><span class="s1">x</span><span class="s3">.</span><span class="s1">multiplyTo</span><span class="s3">(</span><span class="s1">y</span><span class="s3">,</span><span class="s1">r</span><span class="s3">); }</span>
<span class="s2">function </span><span class="s1">nSqrTo</span><span class="s3">(</span><span class="s1">x</span><span class="s3">,</span><span class="s1">r</span><span class="s3">) { </span><span class="s1">x</span><span class="s3">.</span><span class="s1">squareTo</span><span class="s3">(</span><span class="s1">r</span><span class="s3">); }</span>

<span class="s1">NullExp</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">convert </span><span class="s3">= </span><span class="s1">nNop</span><span class="s3">;</span>
<span class="s1">NullExp</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">revert </span><span class="s3">= </span><span class="s1">nNop</span><span class="s3">;</span>
<span class="s1">NullExp</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">mulTo </span><span class="s3">= </span><span class="s1">nMulTo</span><span class="s3">;</span>
<span class="s1">NullExp</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">sqrTo </span><span class="s3">= </span><span class="s1">nSqrTo</span><span class="s3">;</span>

<span class="s0">//(public) this^e</span>
<span class="s2">function </span><span class="s1">bnPow</span><span class="s3">(</span><span class="s1">e</span><span class="s3">) { </span><span class="s2">return this</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">e</span><span class="s3">,</span><span class="s2">new </span><span class="s1">NullExp</span><span class="s3">()); }</span>

<span class="s0">//(protected) r = lower n words of &quot;this * a&quot;, a.t &lt;= n</span>
<span class="s0">//&quot;this&quot; should be the larger one if appropriate.</span>
<span class="s2">function </span><span class="s1">bnpMultiplyLowerTo</span><span class="s3">(</span><span class="s1">a</span><span class="s3">,</span><span class="s1">n</span><span class="s3">,</span><span class="s1">r</span><span class="s3">) {</span>
<span class="s2">var </span><span class="s1">i </span><span class="s3">= </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">+</span><span class="s1">a</span><span class="s3">.</span><span class="s1">t</span><span class="s3">,</span><span class="s1">n</span><span class="s3">);</span>
<span class="s1">r</span><span class="s3">.</span><span class="s1">s </span><span class="s3">= </span><span class="s5">0</span><span class="s3">; </span><span class="s0">// assumes a,this &gt;= 0</span>
<span class="s1">r</span><span class="s3">.</span><span class="s1">t </span><span class="s3">= </span><span class="s1">i</span><span class="s3">;</span>
<span class="s2">while</span><span class="s3">(</span><span class="s1">i </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">) </span><span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[--</span><span class="s1">i</span><span class="s3">] = </span><span class="s5">0</span><span class="s3">;</span>
<span class="s2">var </span><span class="s1">j</span><span class="s3">;</span>
<span class="s2">for</span><span class="s3">(</span><span class="s1">j </span><span class="s3">= </span><span class="s1">r</span><span class="s3">.</span><span class="s1">t</span><span class="s3">-</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">j</span><span class="s3">; ++</span><span class="s1">i</span><span class="s3">) </span><span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">+</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">] = </span><span class="s2">this</span><span class="s3">.</span><span class="s1">am</span><span class="s3">(</span><span class="s5">0</span><span class="s3">,</span><span class="s1">a</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">],</span><span class="s1">r</span><span class="s3">,</span><span class="s1">i</span><span class="s3">,</span><span class="s5">0</span><span class="s3">,</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">);</span>
<span class="s2">for</span><span class="s3">(</span><span class="s1">j </span><span class="s3">= </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(</span><span class="s1">a</span><span class="s3">.</span><span class="s1">t</span><span class="s3">,</span><span class="s1">n</span><span class="s3">); </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">j</span><span class="s3">; ++</span><span class="s1">i</span><span class="s3">) </span><span class="s2">this</span><span class="s3">.</span><span class="s1">am</span><span class="s3">(</span><span class="s5">0</span><span class="s3">,</span><span class="s1">a</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">],</span><span class="s1">r</span><span class="s3">,</span><span class="s1">i</span><span class="s3">,</span><span class="s5">0</span><span class="s3">,</span><span class="s1">n</span><span class="s3">-</span><span class="s1">i</span><span class="s3">);</span>
<span class="s1">r</span><span class="s3">.</span><span class="s1">clamp</span><span class="s3">();</span>
<span class="s3">}</span>

<span class="s0">//(protected) r = &quot;this * a&quot; without lower n words, n &gt; 0</span>
<span class="s0">//&quot;this&quot; should be the larger one if appropriate.</span>
<span class="s2">function </span><span class="s1">bnpMultiplyUpperTo</span><span class="s3">(</span><span class="s1">a</span><span class="s3">,</span><span class="s1">n</span><span class="s3">,</span><span class="s1">r</span><span class="s3">) {</span>
<span class="s3">--</span><span class="s1">n</span><span class="s3">;</span>
<span class="s2">var </span><span class="s1">i </span><span class="s3">= </span><span class="s1">r</span><span class="s3">.</span><span class="s1">t </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">+</span><span class="s1">a</span><span class="s3">.</span><span class="s1">t</span><span class="s3">-</span><span class="s1">n</span><span class="s3">;</span>
<span class="s1">r</span><span class="s3">.</span><span class="s1">s </span><span class="s3">= </span><span class="s5">0</span><span class="s3">; </span><span class="s0">// assumes a,this &gt;= 0</span>
<span class="s2">while</span><span class="s3">(--</span><span class="s1">i </span><span class="s3">&gt;= </span><span class="s5">0</span><span class="s3">) </span><span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s5">0</span><span class="s3">;</span>
<span class="s2">for</span><span class="s3">(</span><span class="s1">i </span><span class="s3">= </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">n</span><span class="s3">-</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">,</span><span class="s5">0</span><span class="s3">); </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">a</span><span class="s3">.</span><span class="s1">t</span><span class="s3">; ++</span><span class="s1">i</span><span class="s3">)</span>
 <span class="s1">r</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">+</span><span class="s1">i</span><span class="s3">-</span><span class="s1">n</span><span class="s3">] = </span><span class="s2">this</span><span class="s3">.</span><span class="s1">am</span><span class="s3">(</span><span class="s1">n</span><span class="s3">-</span><span class="s1">i</span><span class="s3">,</span><span class="s1">a</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">],</span><span class="s1">r</span><span class="s3">,</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">,</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">+</span><span class="s1">i</span><span class="s3">-</span><span class="s1">n</span><span class="s3">);</span>
<span class="s1">r</span><span class="s3">.</span><span class="s1">clamp</span><span class="s3">();</span>
<span class="s1">r</span><span class="s3">.</span><span class="s1">drShiftTo</span><span class="s3">(</span><span class="s5">1</span><span class="s3">,</span><span class="s1">r</span><span class="s3">);</span>
<span class="s3">}</span>

<span class="s0">//Barrett modular reduction</span>
<span class="s2">function </span><span class="s1">Barrett</span><span class="s3">(</span><span class="s1">m</span><span class="s3">) {</span>
<span class="s0">// setup Barrett</span>
<span class="s2">this</span><span class="s3">.</span><span class="s1">r2 </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">();</span>
<span class="s2">this</span><span class="s3">.</span><span class="s1">q3 </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">();</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">ONE</span><span class="s3">.</span><span class="s1">dlShiftTo</span><span class="s3">(</span><span class="s5">2</span><span class="s3">*</span><span class="s1">m</span><span class="s3">.</span><span class="s1">t</span><span class="s3">,</span><span class="s2">this</span><span class="s3">.</span><span class="s1">r2</span><span class="s3">);</span>
<span class="s2">this</span><span class="s3">.</span><span class="s1">mu </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">r2</span><span class="s3">.</span><span class="s1">divide</span><span class="s3">(</span><span class="s1">m</span><span class="s3">);</span>
<span class="s2">this</span><span class="s3">.</span><span class="s1">m </span><span class="s3">= </span><span class="s1">m</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s2">function </span><span class="s1">barrettConvert</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) {</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">s </span><span class="s3">&lt; </span><span class="s5">0 </span><span class="s3">|| </span><span class="s1">x</span><span class="s3">.</span><span class="s1">t </span><span class="s3">&gt; </span><span class="s5">2</span><span class="s3">*</span><span class="s2">this</span><span class="s3">.</span><span class="s1">m</span><span class="s3">.</span><span class="s1">t</span><span class="s3">) </span><span class="s2">return </span><span class="s1">x</span><span class="s3">.</span><span class="s1">mod</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">m</span><span class="s3">);</span>
<span class="s2">else if</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">compareTo</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">m</span><span class="s3">) &lt; </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return </span><span class="s1">x</span><span class="s3">;</span>
<span class="s2">else </span><span class="s3">{ </span><span class="s2">var </span><span class="s1">r </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">(); </span><span class="s1">x</span><span class="s3">.</span><span class="s1">copyTo</span><span class="s3">(</span><span class="s1">r</span><span class="s3">); </span><span class="s2">this</span><span class="s3">.</span><span class="s1">reduce</span><span class="s3">(</span><span class="s1">r</span><span class="s3">); </span><span class="s2">return </span><span class="s1">r</span><span class="s3">; }</span>
<span class="s3">}</span>

<span class="s2">function </span><span class="s1">barrettRevert</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) { </span><span class="s2">return </span><span class="s1">x</span><span class="s3">; }</span>

<span class="s0">//x = x mod m (HAC 14.42)</span>
<span class="s2">function </span><span class="s1">barrettReduce</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) {</span>
<span class="s1">x</span><span class="s3">.</span><span class="s1">drShiftTo</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">m</span><span class="s3">.</span><span class="s1">t</span><span class="s3">-</span><span class="s5">1</span><span class="s3">,</span><span class="s2">this</span><span class="s3">.</span><span class="s1">r2</span><span class="s3">);</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">t </span><span class="s3">&gt; </span><span class="s2">this</span><span class="s3">.</span><span class="s1">m</span><span class="s3">.</span><span class="s1">t</span><span class="s3">+</span><span class="s5">1</span><span class="s3">) { </span><span class="s1">x</span><span class="s3">.</span><span class="s1">t </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">m</span><span class="s3">.</span><span class="s1">t</span><span class="s3">+</span><span class="s5">1</span><span class="s3">; </span><span class="s1">x</span><span class="s3">.</span><span class="s1">clamp</span><span class="s3">(); }</span>
<span class="s2">this</span><span class="s3">.</span><span class="s1">mu</span><span class="s3">.</span><span class="s1">multiplyUpperTo</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">r2</span><span class="s3">,</span><span class="s2">this</span><span class="s3">.</span><span class="s1">m</span><span class="s3">.</span><span class="s1">t</span><span class="s3">+</span><span class="s5">1</span><span class="s3">,</span><span class="s2">this</span><span class="s3">.</span><span class="s1">q3</span><span class="s3">);</span>
<span class="s2">this</span><span class="s3">.</span><span class="s1">m</span><span class="s3">.</span><span class="s1">multiplyLowerTo</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">q3</span><span class="s3">,</span><span class="s2">this</span><span class="s3">.</span><span class="s1">m</span><span class="s3">.</span><span class="s1">t</span><span class="s3">+</span><span class="s5">1</span><span class="s3">,</span><span class="s2">this</span><span class="s3">.</span><span class="s1">r2</span><span class="s3">);</span>
<span class="s2">while</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">compareTo</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">r2</span><span class="s3">) &lt; </span><span class="s5">0</span><span class="s3">) </span><span class="s1">x</span><span class="s3">.</span><span class="s1">dAddOffset</span><span class="s3">(</span><span class="s5">1</span><span class="s3">,</span><span class="s2">this</span><span class="s3">.</span><span class="s1">m</span><span class="s3">.</span><span class="s1">t</span><span class="s3">+</span><span class="s5">1</span><span class="s3">);</span>
<span class="s1">x</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">r2</span><span class="s3">,</span><span class="s1">x</span><span class="s3">);</span>
<span class="s2">while</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">compareTo</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">m</span><span class="s3">) &gt;= </span><span class="s5">0</span><span class="s3">) </span><span class="s1">x</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">m</span><span class="s3">,</span><span class="s1">x</span><span class="s3">);</span>
<span class="s3">}</span>

<span class="s0">//r = x^2 mod m; x != r</span>
<span class="s2">function </span><span class="s1">barrettSqrTo</span><span class="s3">(</span><span class="s1">x</span><span class="s3">,</span><span class="s1">r</span><span class="s3">) { </span><span class="s1">x</span><span class="s3">.</span><span class="s1">squareTo</span><span class="s3">(</span><span class="s1">r</span><span class="s3">); </span><span class="s2">this</span><span class="s3">.</span><span class="s1">reduce</span><span class="s3">(</span><span class="s1">r</span><span class="s3">); }</span>

<span class="s0">//r = x*y mod m; x,y != r</span>
<span class="s2">function </span><span class="s1">barrettMulTo</span><span class="s3">(</span><span class="s1">x</span><span class="s3">,</span><span class="s1">y</span><span class="s3">,</span><span class="s1">r</span><span class="s3">) { </span><span class="s1">x</span><span class="s3">.</span><span class="s1">multiplyTo</span><span class="s3">(</span><span class="s1">y</span><span class="s3">,</span><span class="s1">r</span><span class="s3">); </span><span class="s2">this</span><span class="s3">.</span><span class="s1">reduce</span><span class="s3">(</span><span class="s1">r</span><span class="s3">); }</span>

<span class="s1">Barrett</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">convert </span><span class="s3">= </span><span class="s1">barrettConvert</span><span class="s3">;</span>
<span class="s1">Barrett</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">revert </span><span class="s3">= </span><span class="s1">barrettRevert</span><span class="s3">;</span>
<span class="s1">Barrett</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">reduce </span><span class="s3">= </span><span class="s1">barrettReduce</span><span class="s3">;</span>
<span class="s1">Barrett</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">mulTo </span><span class="s3">= </span><span class="s1">barrettMulTo</span><span class="s3">;</span>
<span class="s1">Barrett</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">sqrTo </span><span class="s3">= </span><span class="s1">barrettSqrTo</span><span class="s3">;</span>

<span class="s0">//(public) this^e % m (HAC 14.85)</span>
<span class="s2">function </span><span class="s1">bnModPow</span><span class="s3">(</span><span class="s1">e</span><span class="s3">,</span><span class="s1">m</span><span class="s3">) {</span>
<span class="s2">var </span><span class="s1">i </span><span class="s3">= </span><span class="s1">e</span><span class="s3">.</span><span class="s1">bitLength</span><span class="s3">(), </span><span class="s1">k</span><span class="s3">, </span><span class="s1">r </span><span class="s3">= </span><span class="s1">nbv</span><span class="s3">(</span><span class="s5">1</span><span class="s3">), </span><span class="s1">z</span><span class="s3">;</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">i </span><span class="s3">&lt;= </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return </span><span class="s1">r</span><span class="s3">;</span>
<span class="s2">else if</span><span class="s3">(</span><span class="s1">i </span><span class="s3">&lt; </span><span class="s5">18</span><span class="s3">) </span><span class="s1">k </span><span class="s3">= </span><span class="s5">1</span><span class="s3">;</span>
<span class="s2">else if</span><span class="s3">(</span><span class="s1">i </span><span class="s3">&lt; </span><span class="s5">48</span><span class="s3">) </span><span class="s1">k </span><span class="s3">= </span><span class="s5">3</span><span class="s3">;</span>
<span class="s2">else if</span><span class="s3">(</span><span class="s1">i </span><span class="s3">&lt; </span><span class="s5">144</span><span class="s3">) </span><span class="s1">k </span><span class="s3">= </span><span class="s5">4</span><span class="s3">;</span>
<span class="s2">else if</span><span class="s3">(</span><span class="s1">i </span><span class="s3">&lt; </span><span class="s5">768</span><span class="s3">) </span><span class="s1">k </span><span class="s3">= </span><span class="s5">5</span><span class="s3">;</span>
<span class="s2">else </span><span class="s1">k </span><span class="s3">= </span><span class="s5">6</span><span class="s3">;</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">i </span><span class="s3">&lt; </span><span class="s5">8</span><span class="s3">)</span>
 <span class="s1">z </span><span class="s3">= </span><span class="s2">new </span><span class="s1">Classic</span><span class="s3">(</span><span class="s1">m</span><span class="s3">);</span>
<span class="s2">else if</span><span class="s3">(</span><span class="s1">m</span><span class="s3">.</span><span class="s1">isEven</span><span class="s3">())</span>
 <span class="s1">z </span><span class="s3">= </span><span class="s2">new </span><span class="s1">Barrett</span><span class="s3">(</span><span class="s1">m</span><span class="s3">);</span>
<span class="s2">else</span>
 <span class="s1">z </span><span class="s3">= </span><span class="s2">new </span><span class="s1">Montgomery</span><span class="s3">(</span><span class="s1">m</span><span class="s3">);</span>

<span class="s0">// precomputation</span>
<span class="s2">var </span><span class="s1">g </span><span class="s3">= </span><span class="s2">new </span><span class="s1">Array</span><span class="s3">(), </span><span class="s1">n </span><span class="s3">= </span><span class="s5">3</span><span class="s3">, </span><span class="s1">k1 </span><span class="s3">= </span><span class="s1">k</span><span class="s3">-</span><span class="s5">1</span><span class="s3">, </span><span class="s1">km </span><span class="s3">= (</span><span class="s5">1</span><span class="s3">&lt;&lt;</span><span class="s1">k</span><span class="s3">)-</span><span class="s5">1</span><span class="s3">;</span>
<span class="s1">g</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] = </span><span class="s1">z</span><span class="s3">.</span><span class="s1">convert</span><span class="s3">(</span><span class="s2">this</span><span class="s3">);</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">k </span><span class="s3">&gt; </span><span class="s5">1</span><span class="s3">) {</span>
 <span class="s2">var </span><span class="s1">g2 </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">();</span>
 <span class="s1">z</span><span class="s3">.</span><span class="s1">sqrTo</span><span class="s3">(</span><span class="s1">g</span><span class="s3">[</span><span class="s5">1</span><span class="s3">],</span><span class="s1">g2</span><span class="s3">);</span>
 <span class="s2">while</span><span class="s3">(</span><span class="s1">n </span><span class="s3">&lt;= </span><span class="s1">km</span><span class="s3">) {</span>
   <span class="s1">g</span><span class="s3">[</span><span class="s1">n</span><span class="s3">] = </span><span class="s1">nbi</span><span class="s3">();</span>
   <span class="s1">z</span><span class="s3">.</span><span class="s1">mulTo</span><span class="s3">(</span><span class="s1">g2</span><span class="s3">,</span><span class="s1">g</span><span class="s3">[</span><span class="s1">n</span><span class="s3">-</span><span class="s5">2</span><span class="s3">],</span><span class="s1">g</span><span class="s3">[</span><span class="s1">n</span><span class="s3">]);</span>
   <span class="s1">n </span><span class="s3">+= </span><span class="s5">2</span><span class="s3">;</span>
 <span class="s3">}</span>
<span class="s3">}</span>

<span class="s2">var </span><span class="s1">j </span><span class="s3">= </span><span class="s1">e</span><span class="s3">.</span><span class="s1">t</span><span class="s3">-</span><span class="s5">1</span><span class="s3">, </span><span class="s1">w</span><span class="s3">, </span><span class="s1">is1 </span><span class="s3">= </span><span class="s2">true</span><span class="s3">, </span><span class="s1">r2 </span><span class="s3">= </span><span class="s1">nbi</span><span class="s3">(), </span><span class="s1">t</span><span class="s3">;</span>
<span class="s1">i </span><span class="s3">= </span><span class="s1">nbits</span><span class="s3">(</span><span class="s1">e</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">j</span><span class="s3">])-</span><span class="s5">1</span><span class="s3">;</span>
<span class="s2">while</span><span class="s3">(</span><span class="s1">j </span><span class="s3">&gt;= </span><span class="s5">0</span><span class="s3">) {</span>
 <span class="s2">if</span><span class="s3">(</span><span class="s1">i </span><span class="s3">&gt;= </span><span class="s1">k1</span><span class="s3">) </span><span class="s1">w </span><span class="s3">= (</span><span class="s1">e</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">j</span><span class="s3">]&gt;&gt;(</span><span class="s1">i</span><span class="s3">-</span><span class="s1">k1</span><span class="s3">))&amp;</span><span class="s1">km</span><span class="s3">;</span>
 <span class="s2">else </span><span class="s3">{</span>
   <span class="s1">w </span><span class="s3">= (</span><span class="s1">e</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">j</span><span class="s3">]&amp;((</span><span class="s5">1</span><span class="s3">&lt;&lt;(</span><span class="s1">i</span><span class="s3">+</span><span class="s5">1</span><span class="s3">))-</span><span class="s5">1</span><span class="s3">))&lt;&lt;(</span><span class="s1">k1</span><span class="s3">-</span><span class="s1">i</span><span class="s3">);</span>
   <span class="s2">if</span><span class="s3">(</span><span class="s1">j </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">) </span><span class="s1">w </span><span class="s3">|= </span><span class="s1">e</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">j</span><span class="s3">-</span><span class="s5">1</span><span class="s3">]&gt;&gt;(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">+</span><span class="s1">i</span><span class="s3">-</span><span class="s1">k1</span><span class="s3">);</span>
 <span class="s3">}</span>

 <span class="s1">n </span><span class="s3">= </span><span class="s1">k</span><span class="s3">;</span>
 <span class="s2">while</span><span class="s3">((</span><span class="s1">w</span><span class="s3">&amp;</span><span class="s5">1</span><span class="s3">) == </span><span class="s5">0</span><span class="s3">) { </span><span class="s1">w </span><span class="s3">&gt;&gt;= </span><span class="s5">1</span><span class="s3">; --</span><span class="s1">n</span><span class="s3">; }</span>
 <span class="s2">if</span><span class="s3">((</span><span class="s1">i </span><span class="s3">-= </span><span class="s1">n</span><span class="s3">) &lt; </span><span class="s5">0</span><span class="s3">) { </span><span class="s1">i </span><span class="s3">+= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">; --</span><span class="s1">j</span><span class="s3">; }</span>
 <span class="s2">if</span><span class="s3">(</span><span class="s1">is1</span><span class="s3">) {  </span><span class="s0">// ret == 1, don't bother squaring or multiplying it</span>
   <span class="s1">g</span><span class="s3">[</span><span class="s1">w</span><span class="s3">].</span><span class="s1">copyTo</span><span class="s3">(</span><span class="s1">r</span><span class="s3">);</span>
   <span class="s1">is1 </span><span class="s3">= </span><span class="s2">false</span><span class="s3">;</span>
 <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
   <span class="s2">while</span><span class="s3">(</span><span class="s1">n </span><span class="s3">&gt; </span><span class="s5">1</span><span class="s3">) { </span><span class="s1">z</span><span class="s3">.</span><span class="s1">sqrTo</span><span class="s3">(</span><span class="s1">r</span><span class="s3">,</span><span class="s1">r2</span><span class="s3">); </span><span class="s1">z</span><span class="s3">.</span><span class="s1">sqrTo</span><span class="s3">(</span><span class="s1">r2</span><span class="s3">,</span><span class="s1">r</span><span class="s3">); </span><span class="s1">n </span><span class="s3">-= </span><span class="s5">2</span><span class="s3">; }</span>
   <span class="s2">if</span><span class="s3">(</span><span class="s1">n </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">) </span><span class="s1">z</span><span class="s3">.</span><span class="s1">sqrTo</span><span class="s3">(</span><span class="s1">r</span><span class="s3">,</span><span class="s1">r2</span><span class="s3">); </span><span class="s2">else </span><span class="s3">{ </span><span class="s1">t </span><span class="s3">= </span><span class="s1">r</span><span class="s3">; </span><span class="s1">r </span><span class="s3">= </span><span class="s1">r2</span><span class="s3">; </span><span class="s1">r2 </span><span class="s3">= </span><span class="s1">t</span><span class="s3">; }</span>
   <span class="s1">z</span><span class="s3">.</span><span class="s1">mulTo</span><span class="s3">(</span><span class="s1">r2</span><span class="s3">,</span><span class="s1">g</span><span class="s3">[</span><span class="s1">w</span><span class="s3">],</span><span class="s1">r</span><span class="s3">);</span>
 <span class="s3">}</span>

 <span class="s2">while</span><span class="s3">(</span><span class="s1">j </span><span class="s3">&gt;= </span><span class="s5">0 </span><span class="s3">&amp;&amp; (</span><span class="s1">e</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">j</span><span class="s3">]&amp;(</span><span class="s5">1</span><span class="s3">&lt;&lt;</span><span class="s1">i</span><span class="s3">)) == </span><span class="s5">0</span><span class="s3">) {</span>
   <span class="s1">z</span><span class="s3">.</span><span class="s1">sqrTo</span><span class="s3">(</span><span class="s1">r</span><span class="s3">,</span><span class="s1">r2</span><span class="s3">); </span><span class="s1">t </span><span class="s3">= </span><span class="s1">r</span><span class="s3">; </span><span class="s1">r </span><span class="s3">= </span><span class="s1">r2</span><span class="s3">; </span><span class="s1">r2 </span><span class="s3">= </span><span class="s1">t</span><span class="s3">;</span>
   <span class="s2">if</span><span class="s3">(--</span><span class="s1">i </span><span class="s3">&lt; </span><span class="s5">0</span><span class="s3">) { </span><span class="s1">i </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">DB</span><span class="s3">-</span><span class="s5">1</span><span class="s3">; --</span><span class="s1">j</span><span class="s3">; }</span>
 <span class="s3">}</span>
<span class="s3">}</span>
<span class="s2">return </span><span class="s1">z</span><span class="s3">.</span><span class="s1">revert</span><span class="s3">(</span><span class="s1">r</span><span class="s3">);</span>
<span class="s3">}</span>

<span class="s0">//(public) gcd(this,a) (HAC 14.54)</span>
<span class="s2">function </span><span class="s1">bnGCD</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) {</span>
<span class="s2">var </span><span class="s1">x </span><span class="s3">= (</span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">&lt;</span><span class="s5">0</span><span class="s3">)?</span><span class="s2">this</span><span class="s3">.</span><span class="s1">negate</span><span class="s3">():</span><span class="s2">this</span><span class="s3">.</span><span class="s1">clone</span><span class="s3">();</span>
<span class="s2">var </span><span class="s1">y </span><span class="s3">= (</span><span class="s1">a</span><span class="s3">.</span><span class="s1">s</span><span class="s3">&lt;</span><span class="s5">0</span><span class="s3">)?</span><span class="s1">a</span><span class="s3">.</span><span class="s1">negate</span><span class="s3">():</span><span class="s1">a</span><span class="s3">.</span><span class="s1">clone</span><span class="s3">();</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">compareTo</span><span class="s3">(</span><span class="s1">y</span><span class="s3">) &lt; </span><span class="s5">0</span><span class="s3">) { </span><span class="s2">var </span><span class="s1">t </span><span class="s3">= </span><span class="s1">x</span><span class="s3">; </span><span class="s1">x </span><span class="s3">= </span><span class="s1">y</span><span class="s3">; </span><span class="s1">y </span><span class="s3">= </span><span class="s1">t</span><span class="s3">; }</span>
<span class="s2">var </span><span class="s1">i </span><span class="s3">= </span><span class="s1">x</span><span class="s3">.</span><span class="s1">getLowestSetBit</span><span class="s3">(), </span><span class="s1">g </span><span class="s3">= </span><span class="s1">y</span><span class="s3">.</span><span class="s1">getLowestSetBit</span><span class="s3">();</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">g </span><span class="s3">&lt; </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return </span><span class="s1">x</span><span class="s3">;</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">g</span><span class="s3">) </span><span class="s1">g </span><span class="s3">= </span><span class="s1">i</span><span class="s3">;</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">g </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">) {</span>
 <span class="s1">x</span><span class="s3">.</span><span class="s1">rShiftTo</span><span class="s3">(</span><span class="s1">g</span><span class="s3">,</span><span class="s1">x</span><span class="s3">);</span>
 <span class="s1">y</span><span class="s3">.</span><span class="s1">rShiftTo</span><span class="s3">(</span><span class="s1">g</span><span class="s3">,</span><span class="s1">y</span><span class="s3">);</span>
<span class="s3">}</span>
<span class="s2">while</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">signum</span><span class="s3">() &gt; </span><span class="s5">0</span><span class="s3">) {</span>
 <span class="s2">if</span><span class="s3">((</span><span class="s1">i </span><span class="s3">= </span><span class="s1">x</span><span class="s3">.</span><span class="s1">getLowestSetBit</span><span class="s3">()) &gt; </span><span class="s5">0</span><span class="s3">) </span><span class="s1">x</span><span class="s3">.</span><span class="s1">rShiftTo</span><span class="s3">(</span><span class="s1">i</span><span class="s3">,</span><span class="s1">x</span><span class="s3">);</span>
 <span class="s2">if</span><span class="s3">((</span><span class="s1">i </span><span class="s3">= </span><span class="s1">y</span><span class="s3">.</span><span class="s1">getLowestSetBit</span><span class="s3">()) &gt; </span><span class="s5">0</span><span class="s3">) </span><span class="s1">y</span><span class="s3">.</span><span class="s1">rShiftTo</span><span class="s3">(</span><span class="s1">i</span><span class="s3">,</span><span class="s1">y</span><span class="s3">);</span>
 <span class="s2">if</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">compareTo</span><span class="s3">(</span><span class="s1">y</span><span class="s3">) &gt;= </span><span class="s5">0</span><span class="s3">) {</span>
   <span class="s1">x</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s1">y</span><span class="s3">,</span><span class="s1">x</span><span class="s3">);</span>
   <span class="s1">x</span><span class="s3">.</span><span class="s1">rShiftTo</span><span class="s3">(</span><span class="s5">1</span><span class="s3">,</span><span class="s1">x</span><span class="s3">);</span>
 <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
   <span class="s1">y</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s1">x</span><span class="s3">,</span><span class="s1">y</span><span class="s3">);</span>
   <span class="s1">y</span><span class="s3">.</span><span class="s1">rShiftTo</span><span class="s3">(</span><span class="s5">1</span><span class="s3">,</span><span class="s1">y</span><span class="s3">);</span>
 <span class="s3">}</span>
<span class="s3">}</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">g </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">) </span><span class="s1">y</span><span class="s3">.</span><span class="s1">lShiftTo</span><span class="s3">(</span><span class="s1">g</span><span class="s3">,</span><span class="s1">y</span><span class="s3">);</span>
<span class="s2">return </span><span class="s1">y</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">//(protected) this % n, n &lt; 2^26</span>
<span class="s2">function </span><span class="s1">bnpModInt</span><span class="s3">(</span><span class="s1">n</span><span class="s3">) {</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">n </span><span class="s3">&lt;= </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return </span><span class="s5">0</span><span class="s3">;</span>
<span class="s2">var </span><span class="s1">d </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">DV</span><span class="s3">%</span><span class="s1">n</span><span class="s3">, </span><span class="s1">r </span><span class="s3">= (</span><span class="s2">this</span><span class="s3">.</span><span class="s1">s</span><span class="s3">&lt;</span><span class="s5">0</span><span class="s3">)?</span><span class="s1">n</span><span class="s3">-</span><span class="s5">1</span><span class="s3">:</span><span class="s5">0</span><span class="s3">;</span>
<span class="s2">if</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">t </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">)</span>
 <span class="s2">if</span><span class="s3">(</span><span class="s1">d </span><span class="s3">== </span><span class="s5">0</span><span class="s3">) </span><span class="s1">r </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]%</span><span class="s1">n</span><span class="s3">;</span>
 <span class="s2">else for</span><span class="s3">(</span><span class="s2">var </span><span class="s1">i </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">t</span><span class="s3">-</span><span class="s5">1</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&gt;= </span><span class="s5">0</span><span class="s3">; --</span><span class="s1">i</span><span class="s3">) </span><span class="s1">r </span><span class="s3">= (</span><span class="s1">d</span><span class="s3">*</span><span class="s1">r</span><span class="s3">+</span><span class="s2">this</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">])%</span><span class="s1">n</span><span class="s3">;</span>
<span class="s2">return </span><span class="s1">r</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">//(public) 1/this % m (HAC 14.61)</span>
<span class="s2">function </span><span class="s1">bnModInverse</span><span class="s3">(</span><span class="s1">m</span><span class="s3">) {</span>
<span class="s2">var </span><span class="s1">ac </span><span class="s3">= </span><span class="s1">m</span><span class="s3">.</span><span class="s1">isEven</span><span class="s3">();</span>
<span class="s2">if</span><span class="s3">((</span><span class="s2">this</span><span class="s3">.</span><span class="s1">isEven</span><span class="s3">() &amp;&amp; </span><span class="s1">ac</span><span class="s3">) || </span><span class="s1">m</span><span class="s3">.</span><span class="s1">signum</span><span class="s3">() == </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return </span><span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">ZERO</span><span class="s3">;</span>
<span class="s2">var </span><span class="s1">u </span><span class="s3">= </span><span class="s1">m</span><span class="s3">.</span><span class="s1">clone</span><span class="s3">(), </span><span class="s1">v </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">clone</span><span class="s3">();</span>
<span class="s2">var </span><span class="s1">a </span><span class="s3">= </span><span class="s1">nbv</span><span class="s3">(</span><span class="s5">1</span><span class="s3">), </span><span class="s1">b </span><span class="s3">= </span><span class="s1">nbv</span><span class="s3">(</span><span class="s5">0</span><span class="s3">), </span><span class="s1">c </span><span class="s3">= </span><span class="s1">nbv</span><span class="s3">(</span><span class="s5">0</span><span class="s3">), </span><span class="s1">d </span><span class="s3">= </span><span class="s1">nbv</span><span class="s3">(</span><span class="s5">1</span><span class="s3">);</span>
<span class="s2">while</span><span class="s3">(</span><span class="s1">u</span><span class="s3">.</span><span class="s1">signum</span><span class="s3">() != </span><span class="s5">0</span><span class="s3">) {</span>
 <span class="s2">while</span><span class="s3">(</span><span class="s1">u</span><span class="s3">.</span><span class="s1">isEven</span><span class="s3">()) {</span>
   <span class="s1">u</span><span class="s3">.</span><span class="s1">rShiftTo</span><span class="s3">(</span><span class="s5">1</span><span class="s3">,</span><span class="s1">u</span><span class="s3">);</span>
   <span class="s2">if</span><span class="s3">(</span><span class="s1">ac</span><span class="s3">) {</span>
     <span class="s2">if</span><span class="s3">(!</span><span class="s1">a</span><span class="s3">.</span><span class="s1">isEven</span><span class="s3">() || !</span><span class="s1">b</span><span class="s3">.</span><span class="s1">isEven</span><span class="s3">()) { </span><span class="s1">a</span><span class="s3">.</span><span class="s1">addTo</span><span class="s3">(</span><span class="s2">this</span><span class="s3">,</span><span class="s1">a</span><span class="s3">); </span><span class="s1">b</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s1">m</span><span class="s3">,</span><span class="s1">b</span><span class="s3">); }</span>
     <span class="s1">a</span><span class="s3">.</span><span class="s1">rShiftTo</span><span class="s3">(</span><span class="s5">1</span><span class="s3">,</span><span class="s1">a</span><span class="s3">);</span>
   <span class="s3">} </span><span class="s2">else if</span><span class="s3">(!</span><span class="s1">b</span><span class="s3">.</span><span class="s1">isEven</span><span class="s3">()) </span><span class="s1">b</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s1">m</span><span class="s3">,</span><span class="s1">b</span><span class="s3">);</span>
   <span class="s1">b</span><span class="s3">.</span><span class="s1">rShiftTo</span><span class="s3">(</span><span class="s5">1</span><span class="s3">,</span><span class="s1">b</span><span class="s3">);</span>
 <span class="s3">}</span>
 <span class="s2">while</span><span class="s3">(</span><span class="s1">v</span><span class="s3">.</span><span class="s1">isEven</span><span class="s3">()) {</span>
   <span class="s1">v</span><span class="s3">.</span><span class="s1">rShiftTo</span><span class="s3">(</span><span class="s5">1</span><span class="s3">,</span><span class="s1">v</span><span class="s3">);</span>
   <span class="s2">if</span><span class="s3">(</span><span class="s1">ac</span><span class="s3">) {</span>
     <span class="s2">if</span><span class="s3">(!</span><span class="s1">c</span><span class="s3">.</span><span class="s1">isEven</span><span class="s3">() || !</span><span class="s1">d</span><span class="s3">.</span><span class="s1">isEven</span><span class="s3">()) { </span><span class="s1">c</span><span class="s3">.</span><span class="s1">addTo</span><span class="s3">(</span><span class="s2">this</span><span class="s3">,</span><span class="s1">c</span><span class="s3">); </span><span class="s1">d</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s1">m</span><span class="s3">,</span><span class="s1">d</span><span class="s3">); }</span>
     <span class="s1">c</span><span class="s3">.</span><span class="s1">rShiftTo</span><span class="s3">(</span><span class="s5">1</span><span class="s3">,</span><span class="s1">c</span><span class="s3">);</span>
   <span class="s3">} </span><span class="s2">else if</span><span class="s3">(!</span><span class="s1">d</span><span class="s3">.</span><span class="s1">isEven</span><span class="s3">()) </span><span class="s1">d</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s1">m</span><span class="s3">,</span><span class="s1">d</span><span class="s3">);</span>
   <span class="s1">d</span><span class="s3">.</span><span class="s1">rShiftTo</span><span class="s3">(</span><span class="s5">1</span><span class="s3">,</span><span class="s1">d</span><span class="s3">);</span>
 <span class="s3">}</span>
 <span class="s2">if</span><span class="s3">(</span><span class="s1">u</span><span class="s3">.</span><span class="s1">compareTo</span><span class="s3">(</span><span class="s1">v</span><span class="s3">) &gt;= </span><span class="s5">0</span><span class="s3">) {</span>
   <span class="s1">u</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s1">v</span><span class="s3">,</span><span class="s1">u</span><span class="s3">);</span>
   <span class="s2">if</span><span class="s3">(</span><span class="s1">ac</span><span class="s3">) </span><span class="s1">a</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s1">c</span><span class="s3">,</span><span class="s1">a</span><span class="s3">);</span>
   <span class="s1">b</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s1">d</span><span class="s3">,</span><span class="s1">b</span><span class="s3">);</span>
 <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
   <span class="s1">v</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s1">u</span><span class="s3">,</span><span class="s1">v</span><span class="s3">);</span>
   <span class="s2">if</span><span class="s3">(</span><span class="s1">ac</span><span class="s3">) </span><span class="s1">c</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s1">a</span><span class="s3">,</span><span class="s1">c</span><span class="s3">);</span>
   <span class="s1">d</span><span class="s3">.</span><span class="s1">subTo</span><span class="s3">(</span><span class="s1">b</span><span class="s3">,</span><span class="s1">d</span><span class="s3">);</span>
 <span class="s3">}</span>
<span class="s3">}</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">v</span><span class="s3">.</span><span class="s1">compareTo</span><span class="s3">(</span><span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">ONE</span><span class="s3">) != </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return </span><span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">ZERO</span><span class="s3">;</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">d</span><span class="s3">.</span><span class="s1">compareTo</span><span class="s3">(</span><span class="s1">m</span><span class="s3">) &gt;= </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return </span><span class="s1">d</span><span class="s3">.</span><span class="s1">subtract</span><span class="s3">(</span><span class="s1">m</span><span class="s3">);</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">d</span><span class="s3">.</span><span class="s1">signum</span><span class="s3">() &lt; </span><span class="s5">0</span><span class="s3">) </span><span class="s1">d</span><span class="s3">.</span><span class="s1">addTo</span><span class="s3">(</span><span class="s1">m</span><span class="s3">,</span><span class="s1">d</span><span class="s3">); </span><span class="s2">else return </span><span class="s1">d</span><span class="s3">;</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">d</span><span class="s3">.</span><span class="s1">signum</span><span class="s3">() &lt; </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return </span><span class="s1">d</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">m</span><span class="s3">); </span><span class="s2">else return </span><span class="s1">d</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s2">var </span><span class="s1">lowprimes </span><span class="s3">= [</span><span class="s5">2</span><span class="s3">,</span><span class="s5">3</span><span class="s3">,</span><span class="s5">5</span><span class="s3">,</span><span class="s5">7</span><span class="s3">,</span><span class="s5">11</span><span class="s3">,</span><span class="s5">13</span><span class="s3">,</span><span class="s5">17</span><span class="s3">,</span><span class="s5">19</span><span class="s3">,</span><span class="s5">23</span><span class="s3">,</span><span class="s5">29</span><span class="s3">,</span><span class="s5">31</span><span class="s3">,</span><span class="s5">37</span><span class="s3">,</span><span class="s5">41</span><span class="s3">,</span><span class="s5">43</span><span class="s3">,</span><span class="s5">47</span><span class="s3">,</span><span class="s5">53</span><span class="s3">,</span><span class="s5">59</span><span class="s3">,</span><span class="s5">61</span><span class="s3">,</span><span class="s5">67</span><span class="s3">,</span><span class="s5">71</span><span class="s3">,</span><span class="s5">73</span><span class="s3">,</span><span class="s5">79</span><span class="s3">,</span><span class="s5">83</span><span class="s3">,</span><span class="s5">89</span><span class="s3">,</span><span class="s5">97</span><span class="s3">,</span><span class="s5">101</span><span class="s3">,</span><span class="s5">103</span><span class="s3">,</span><span class="s5">107</span><span class="s3">,</span><span class="s5">109</span><span class="s3">,</span><span class="s5">113</span><span class="s3">,</span><span class="s5">127</span><span class="s3">,</span><span class="s5">131</span><span class="s3">,</span><span class="s5">137</span><span class="s3">,</span><span class="s5">139</span><span class="s3">,</span><span class="s5">149</span><span class="s3">,</span><span class="s5">151</span><span class="s3">,</span><span class="s5">157</span><span class="s3">,</span><span class="s5">163</span><span class="s3">,</span><span class="s5">167</span><span class="s3">,</span><span class="s5">173</span><span class="s3">,</span><span class="s5">179</span><span class="s3">,</span><span class="s5">181</span><span class="s3">,</span><span class="s5">191</span><span class="s3">,</span><span class="s5">193</span><span class="s3">,</span><span class="s5">197</span><span class="s3">,</span><span class="s5">199</span><span class="s3">,</span><span class="s5">211</span><span class="s3">,</span><span class="s5">223</span><span class="s3">,</span><span class="s5">227</span><span class="s3">,</span><span class="s5">229</span><span class="s3">,</span><span class="s5">233</span><span class="s3">,</span><span class="s5">239</span><span class="s3">,</span><span class="s5">241</span><span class="s3">,</span><span class="s5">251</span><span class="s3">,</span><span class="s5">257</span><span class="s3">,</span><span class="s5">263</span><span class="s3">,</span><span class="s5">269</span><span class="s3">,</span><span class="s5">271</span><span class="s3">,</span><span class="s5">277</span><span class="s3">,</span><span class="s5">281</span><span class="s3">,</span><span class="s5">283</span><span class="s3">,</span><span class="s5">293</span><span class="s3">,</span><span class="s5">307</span><span class="s3">,</span><span class="s5">311</span><span class="s3">,</span><span class="s5">313</span><span class="s3">,</span><span class="s5">317</span><span class="s3">,</span><span class="s5">331</span><span class="s3">,</span><span class="s5">337</span><span class="s3">,</span><span class="s5">347</span><span class="s3">,</span><span class="s5">349</span><span class="s3">,</span><span class="s5">353</span><span class="s3">,</span><span class="s5">359</span><span class="s3">,</span><span class="s5">367</span><span class="s3">,</span><span class="s5">373</span><span class="s3">,</span><span class="s5">379</span><span class="s3">,</span><span class="s5">383</span><span class="s3">,</span><span class="s5">389</span><span class="s3">,</span><span class="s5">397</span><span class="s3">,</span><span class="s5">401</span><span class="s3">,</span><span class="s5">409</span><span class="s3">,</span><span class="s5">419</span><span class="s3">,</span><span class="s5">421</span><span class="s3">,</span><span class="s5">431</span><span class="s3">,</span><span class="s5">433</span><span class="s3">,</span><span class="s5">439</span><span class="s3">,</span><span class="s5">443</span><span class="s3">,</span><span class="s5">449</span><span class="s3">,</span><span class="s5">457</span><span class="s3">,</span><span class="s5">461</span><span class="s3">,</span><span class="s5">463</span><span class="s3">,</span><span class="s5">467</span><span class="s3">,</span><span class="s5">479</span><span class="s3">,</span><span class="s5">487</span><span class="s3">,</span><span class="s5">491</span><span class="s3">,</span><span class="s5">499</span><span class="s3">,</span><span class="s5">503</span><span class="s3">,</span><span class="s5">509</span><span class="s3">];</span>
<span class="s2">var </span><span class="s1">lplim </span><span class="s3">= (</span><span class="s5">1</span><span class="s3">&lt;&lt;</span><span class="s5">26</span><span class="s3">)/</span><span class="s1">lowprimes</span><span class="s3">[</span><span class="s1">lowprimes</span><span class="s3">.</span><span class="s1">length</span><span class="s3">-</span><span class="s5">1</span><span class="s3">];</span>

<span class="s0">//(public) test primality with certainty &gt;= 1-.5^t</span>
<span class="s2">function </span><span class="s1">bnIsProbablePrime</span><span class="s3">(</span><span class="s1">t</span><span class="s3">) {</span>
<span class="s2">var </span><span class="s1">i</span><span class="s3">, </span><span class="s1">x </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">();</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">t </span><span class="s3">== </span><span class="s5">1 </span><span class="s3">&amp;&amp; </span><span class="s1">x</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] &lt;= </span><span class="s1">lowprimes</span><span class="s3">[</span><span class="s1">lowprimes</span><span class="s3">.</span><span class="s1">length</span><span class="s3">-</span><span class="s5">1</span><span class="s3">]) {</span>
 <span class="s2">for</span><span class="s3">(</span><span class="s1">i </span><span class="s3">= </span><span class="s5">0</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">lowprimes</span><span class="s3">.</span><span class="s1">length</span><span class="s3">; ++</span><span class="s1">i</span><span class="s3">)</span>
   <span class="s2">if</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] == </span><span class="s1">lowprimes</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]) </span><span class="s2">return true</span><span class="s3">;</span>
 <span class="s2">return false</span><span class="s3">;</span>
<span class="s3">}</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">isEven</span><span class="s3">()) </span><span class="s2">return false</span><span class="s3">;</span>
<span class="s1">i </span><span class="s3">= </span><span class="s5">1</span><span class="s3">;</span>
<span class="s2">while</span><span class="s3">(</span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">lowprimes</span><span class="s3">.</span><span class="s1">length</span><span class="s3">) {</span>
 <span class="s2">var </span><span class="s1">m </span><span class="s3">= </span><span class="s1">lowprimes</span><span class="s3">[</span><span class="s1">i</span><span class="s3">], </span><span class="s1">j </span><span class="s3">= </span><span class="s1">i</span><span class="s3">+</span><span class="s5">1</span><span class="s3">;</span>
 <span class="s2">while</span><span class="s3">(</span><span class="s1">j </span><span class="s3">&lt; </span><span class="s1">lowprimes</span><span class="s3">.</span><span class="s1">length </span><span class="s3">&amp;&amp; </span><span class="s1">m </span><span class="s3">&lt; </span><span class="s1">lplim</span><span class="s3">) </span><span class="s1">m </span><span class="s3">*= </span><span class="s1">lowprimes</span><span class="s3">[</span><span class="s1">j</span><span class="s3">++];</span>
 <span class="s1">m </span><span class="s3">= </span><span class="s1">x</span><span class="s3">.</span><span class="s1">modInt</span><span class="s3">(</span><span class="s1">m</span><span class="s3">);</span>
 <span class="s2">while</span><span class="s3">(</span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">j</span><span class="s3">) </span><span class="s2">if</span><span class="s3">(</span><span class="s1">m</span><span class="s3">%</span><span class="s1">lowprimes</span><span class="s3">[</span><span class="s1">i</span><span class="s3">++] == </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return false</span><span class="s3">;</span>
<span class="s3">}</span>
<span class="s2">return </span><span class="s1">x</span><span class="s3">.</span><span class="s1">millerRabin</span><span class="s3">(</span><span class="s1">t</span><span class="s3">);</span>
<span class="s3">}</span>

<span class="s0">//(protected) true if probably prime (HAC 4.24, Miller-Rabin)</span>
<span class="s2">function </span><span class="s1">bnpMillerRabin</span><span class="s3">(</span><span class="s1">t</span><span class="s3">) {</span>
<span class="s2">var </span><span class="s1">n1 </span><span class="s3">= </span><span class="s2">this</span><span class="s3">.</span><span class="s1">subtract</span><span class="s3">(</span><span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">ONE</span><span class="s3">);</span>
<span class="s2">var </span><span class="s1">k </span><span class="s3">= </span><span class="s1">n1</span><span class="s3">.</span><span class="s1">getLowestSetBit</span><span class="s3">();</span>
<span class="s2">if</span><span class="s3">(</span><span class="s1">k </span><span class="s3">&lt;= </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return false</span><span class="s3">;</span>
<span class="s2">var </span><span class="s1">r </span><span class="s3">= </span><span class="s1">n1</span><span class="s3">.</span><span class="s1">shiftRight</span><span class="s3">(</span><span class="s1">k</span><span class="s3">);</span>
<span class="s2">var </span><span class="s1">prng </span><span class="s3">= </span><span class="s1">bnGetPrng</span><span class="s3">();</span>
<span class="s2">var </span><span class="s1">a</span><span class="s3">;</span>
<span class="s2">for</span><span class="s3">(</span><span class="s2">var </span><span class="s1">i </span><span class="s3">= </span><span class="s5">0</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">t</span><span class="s3">; ++</span><span class="s1">i</span><span class="s3">) {</span>
 <span class="s0">// select witness 'a' at random from between 1 and n1</span>
 <span class="s2">do </span><span class="s3">{</span>
   <span class="s1">a </span><span class="s3">= </span><span class="s2">new </span><span class="s1">BigInteger</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">bitLength</span><span class="s3">(), </span><span class="s1">prng</span><span class="s3">);</span>
 <span class="s3">}</span>
 <span class="s2">while</span><span class="s3">(</span><span class="s1">a</span><span class="s3">.</span><span class="s1">compareTo</span><span class="s3">(</span><span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">ONE</span><span class="s3">) &lt;= </span><span class="s5">0 </span><span class="s3">|| </span><span class="s1">a</span><span class="s3">.</span><span class="s1">compareTo</span><span class="s3">(</span><span class="s1">n1</span><span class="s3">) &gt;= </span><span class="s5">0</span><span class="s3">);</span>
 <span class="s2">var </span><span class="s1">y </span><span class="s3">= </span><span class="s1">a</span><span class="s3">.</span><span class="s1">modPow</span><span class="s3">(</span><span class="s1">r</span><span class="s3">,</span><span class="s2">this</span><span class="s3">);</span>
 <span class="s2">if</span><span class="s3">(</span><span class="s1">y</span><span class="s3">.</span><span class="s1">compareTo</span><span class="s3">(</span><span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">ONE</span><span class="s3">) != </span><span class="s5">0 </span><span class="s3">&amp;&amp; </span><span class="s1">y</span><span class="s3">.</span><span class="s1">compareTo</span><span class="s3">(</span><span class="s1">n1</span><span class="s3">) != </span><span class="s5">0</span><span class="s3">) {</span>
   <span class="s2">var </span><span class="s1">j </span><span class="s3">= </span><span class="s5">1</span><span class="s3">;</span>
   <span class="s2">while</span><span class="s3">(</span><span class="s1">j</span><span class="s3">++ &lt; </span><span class="s1">k </span><span class="s3">&amp;&amp; </span><span class="s1">y</span><span class="s3">.</span><span class="s1">compareTo</span><span class="s3">(</span><span class="s1">n1</span><span class="s3">) != </span><span class="s5">0</span><span class="s3">) {</span>
     <span class="s1">y </span><span class="s3">= </span><span class="s1">y</span><span class="s3">.</span><span class="s1">modPowInt</span><span class="s3">(</span><span class="s5">2</span><span class="s3">,</span><span class="s2">this</span><span class="s3">);</span>
     <span class="s2">if</span><span class="s3">(</span><span class="s1">y</span><span class="s3">.</span><span class="s1">compareTo</span><span class="s3">(</span><span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">ONE</span><span class="s3">) == </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return false</span><span class="s3">;</span>
   <span class="s3">}</span>
   <span class="s2">if</span><span class="s3">(</span><span class="s1">y</span><span class="s3">.</span><span class="s1">compareTo</span><span class="s3">(</span><span class="s1">n1</span><span class="s3">) != </span><span class="s5">0</span><span class="s3">) </span><span class="s2">return false</span><span class="s3">;</span>
 <span class="s3">}</span>
<span class="s3">}</span>
<span class="s2">return true</span><span class="s3">;</span>
<span class="s3">}</span>

<span class="s0">// get pseudo random number generator</span>
<span class="s2">function </span><span class="s1">bnGetPrng</span><span class="s3">() {</span>
  <span class="s0">// create prng with api that matches BigInteger secure random</span>
  <span class="s2">return </span><span class="s3">{</span>
    <span class="s0">// x is an array to fill with bytes</span>
    <span class="s1">nextBytes</span><span class="s3">: </span><span class="s2">function</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) {</span>
      <span class="s2">for</span><span class="s3">(</span><span class="s2">var </span><span class="s1">i </span><span class="s3">= </span><span class="s5">0</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">x</span><span class="s3">.</span><span class="s1">length</span><span class="s3">; ++</span><span class="s1">i</span><span class="s3">) {</span>
        <span class="s1">x</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">floor</span><span class="s3">(</span><span class="s1">Math</span><span class="s3">.</span><span class="s1">random</span><span class="s3">() * </span><span class="s5">0x0100</span><span class="s3">);</span>
      <span class="s3">}</span>
    <span class="s3">}</span>
  <span class="s3">};</span>
<span class="s3">}</span>

<span class="s0">//protected</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">chunkSize </span><span class="s3">= </span><span class="s1">bnpChunkSize</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">toRadix </span><span class="s3">= </span><span class="s1">bnpToRadix</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">fromRadix </span><span class="s3">= </span><span class="s1">bnpFromRadix</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">fromNumber </span><span class="s3">= </span><span class="s1">bnpFromNumber</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">bitwiseTo </span><span class="s3">= </span><span class="s1">bnpBitwiseTo</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">changeBit </span><span class="s3">= </span><span class="s1">bnpChangeBit</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">addTo </span><span class="s3">= </span><span class="s1">bnpAddTo</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">dMultiply </span><span class="s3">= </span><span class="s1">bnpDMultiply</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">dAddOffset </span><span class="s3">= </span><span class="s1">bnpDAddOffset</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">multiplyLowerTo </span><span class="s3">= </span><span class="s1">bnpMultiplyLowerTo</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">multiplyUpperTo </span><span class="s3">= </span><span class="s1">bnpMultiplyUpperTo</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">modInt </span><span class="s3">= </span><span class="s1">bnpModInt</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">millerRabin </span><span class="s3">= </span><span class="s1">bnpMillerRabin</span><span class="s3">;</span>

<span class="s0">//public</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">clone </span><span class="s3">= </span><span class="s1">bnClone</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">intValue </span><span class="s3">= </span><span class="s1">bnIntValue</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">byteValue </span><span class="s3">= </span><span class="s1">bnByteValue</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">shortValue </span><span class="s3">= </span><span class="s1">bnShortValue</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">signum </span><span class="s3">= </span><span class="s1">bnSigNum</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">toByteArray </span><span class="s3">= </span><span class="s1">bnToByteArray</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">equals </span><span class="s3">= </span><span class="s1">bnEquals</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">min </span><span class="s3">= </span><span class="s1">bnMin</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">max </span><span class="s3">= </span><span class="s1">bnMax</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">and </span><span class="s3">= </span><span class="s1">bnAnd</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">or </span><span class="s3">= </span><span class="s1">bnOr</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">xor </span><span class="s3">= </span><span class="s1">bnXor</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">andNot </span><span class="s3">= </span><span class="s1">bnAndNot</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">not </span><span class="s3">= </span><span class="s1">bnNot</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">shiftLeft </span><span class="s3">= </span><span class="s1">bnShiftLeft</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">shiftRight </span><span class="s3">= </span><span class="s1">bnShiftRight</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">getLowestSetBit </span><span class="s3">= </span><span class="s1">bnGetLowestSetBit</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">bitCount </span><span class="s3">= </span><span class="s1">bnBitCount</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">testBit </span><span class="s3">= </span><span class="s1">bnTestBit</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">setBit </span><span class="s3">= </span><span class="s1">bnSetBit</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">clearBit </span><span class="s3">= </span><span class="s1">bnClearBit</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">flipBit </span><span class="s3">= </span><span class="s1">bnFlipBit</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">add </span><span class="s3">= </span><span class="s1">bnAdd</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">subtract </span><span class="s3">= </span><span class="s1">bnSubtract</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">multiply </span><span class="s3">= </span><span class="s1">bnMultiply</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">divide </span><span class="s3">= </span><span class="s1">bnDivide</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">remainder </span><span class="s3">= </span><span class="s1">bnRemainder</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">divideAndRemainder </span><span class="s3">= </span><span class="s1">bnDivideAndRemainder</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">modPow </span><span class="s3">= </span><span class="s1">bnModPow</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">modInverse </span><span class="s3">= </span><span class="s1">bnModInverse</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">pow </span><span class="s3">= </span><span class="s1">bnPow</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">gcd </span><span class="s3">= </span><span class="s1">bnGCD</span><span class="s3">;</span>
<span class="s1">BigInteger</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">isProbablePrime </span><span class="s3">= </span><span class="s1">bnIsProbablePrime</span><span class="s3">;</span>

<span class="s0">//BigInteger interfaces not implemented in jsbn:</span>

<span class="s0">//BigInteger(int signum, byte[] magnitude)</span>
<span class="s0">//double doubleValue()</span>
<span class="s0">//float floatValue()</span>
<span class="s0">//int hashCode()</span>
<span class="s0">//long longValue()</span>
<span class="s0">//static BigInteger valueOf(long val)</span>
</pre>
</body>
</html>