<html>
<head>
<title>consolidate.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #6aab73;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #cf8e6d;}
.s6 { color: #67a37c; font-style: italic;}
.s7 { color: #42c3d4;}
.s8 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
consolidate.js</font>
</center></td></tr></table>
<pre><span class="s0">'use strict'</span><span class="s1">;</span>
<span class="s3">/* 
 * Engines which do not support caching of their file contents 
 * should use the `read()` function defined in consolidate.js 
 * On top of this, when an engine compiles to a `Function`, 
 * these functions should either be cached within consolidate.js 
 * or the engine itself via `options.cache`. This will allow 
 * users and frameworks to pass `options.cache = true` for 
 * `NODE_ENV=production`, however edit the file(s) without 
 * re-loading the application in development. 
 */</span>

<span class="s4">/**</span>
 <span class="s4">* Module dependencies.</span>
 <span class="s4">*/</span>

<span class="s5">var </span><span class="s2">fs </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'fs'</span><span class="s1">);</span>
<span class="s5">var </span><span class="s2">path </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'path'</span><span class="s1">);</span>
<span class="s5">var </span><span class="s2">Promise </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'bluebird'</span><span class="s1">);</span>

<span class="s5">var </span><span class="s2">join </span><span class="s1">= </span><span class="s2">path</span><span class="s1">.</span><span class="s2">join</span><span class="s1">;</span>
<span class="s5">var </span><span class="s2">resolve </span><span class="s1">= </span><span class="s2">path</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">;</span>
<span class="s5">var </span><span class="s2">extname </span><span class="s1">= </span><span class="s2">path</span><span class="s1">.</span><span class="s2">extname</span><span class="s1">;</span>
<span class="s5">var </span><span class="s2">dirname </span><span class="s1">= </span><span class="s2">path</span><span class="s1">.</span><span class="s2">dirname</span><span class="s1">;</span>
<span class="s5">var </span><span class="s2">isAbsolute </span><span class="s1">= </span><span class="s2">path</span><span class="s1">.</span><span class="s2">isAbsolute</span><span class="s1">;</span>

<span class="s5">var </span><span class="s2">readCache </span><span class="s1">= {};</span>

<span class="s4">/**</span>
 <span class="s4">* Require cache.</span>
 <span class="s4">*/</span>

<span class="s5">var </span><span class="s2">cacheStore </span><span class="s1">= {};</span>

<span class="s4">/**</span>
 <span class="s4">* Require cache.</span>
 <span class="s4">*/</span>

<span class="s5">var </span><span class="s2">requires </span><span class="s1">= {};</span>

<span class="s4">/**</span>
 <span class="s4">* Clear the cache.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s6">@api </span><span class="s4">public</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">clearCache </span><span class="s1">= </span><span class="s5">function</span><span class="s1">() {</span>
  <span class="s2">readCache </span><span class="s1">= {};</span>
  <span class="s2">cacheStore </span><span class="s1">= {};</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Conditionally cache `compiled` template based</span>
 <span class="s4">* on the `options` filename and `.cache` boolean.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s6">@param </span><span class="s4">{Object} options</span>
 <span class="s4">* </span><span class="s6">@param </span><span class="s4">{Function} compiled</span>
 <span class="s4">* </span><span class="s6">@return </span><span class="s4">{Function}</span>
 <span class="s4">* </span><span class="s6">@api </span><span class="s4">private</span>
 <span class="s4">*/</span>

<span class="s5">function </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">compiled</span><span class="s1">) {</span>
  <span class="s3">// cachable</span>
  <span class="s5">if </span><span class="s1">(</span><span class="s2">compiled </span><span class="s1">&amp;&amp; </span><span class="s2">options</span><span class="s1">.</span><span class="s2">filename </span><span class="s1">&amp;&amp; </span><span class="s2">options</span><span class="s1">.</span><span class="s2">cache</span><span class="s1">) {</span>
    <span class="s5">delete </span><span class="s2">readCache</span><span class="s1">[</span><span class="s2">options</span><span class="s1">.</span><span class="s2">filename</span><span class="s1">];</span>
    <span class="s2">cacheStore</span><span class="s1">[</span><span class="s2">options</span><span class="s1">.</span><span class="s2">filename</span><span class="s1">] = </span><span class="s2">compiled</span><span class="s1">;</span>
    <span class="s5">return </span><span class="s2">compiled</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">// check cache</span>
  <span class="s5">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">filename </span><span class="s1">&amp;&amp; </span><span class="s2">options</span><span class="s1">.</span><span class="s2">cache</span><span class="s1">) {</span>
    <span class="s5">return </span><span class="s2">cacheStore</span><span class="s1">[</span><span class="s2">options</span><span class="s1">.</span><span class="s2">filename</span><span class="s1">];</span>
  <span class="s1">}</span>

  <span class="s5">return </span><span class="s2">compiled</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s4">/**</span>
 <span class="s4">* Read `path` with `options` with</span>
 <span class="s4">* callback `(err, str)`. When `options.cache`</span>
 <span class="s4">* is true the template string will be cached.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s6">@param </span><span class="s4">{String} options</span>
 <span class="s4">* </span><span class="s6">@param </span><span class="s4">{Function} cb</span>
 <span class="s4">* </span><span class="s6">@api </span><span class="s4">private</span>
 <span class="s4">*/</span>

<span class="s5">function </span><span class="s2">read</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">var </span><span class="s2">str </span><span class="s1">= </span><span class="s2">readCache</span><span class="s1">[</span><span class="s2">path</span><span class="s1">];</span>
  <span class="s5">var </span><span class="s2">cached </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">cache </span><span class="s1">&amp;&amp; </span><span class="s2">str </span><span class="s1">&amp;&amp; </span><span class="s5">typeof </span><span class="s2">str </span><span class="s1">=== </span><span class="s0">'string'</span><span class="s1">;</span>

  <span class="s3">// cached (only if cached is a string and not a compiled template function)</span>
  <span class="s5">if </span><span class="s1">(</span><span class="s2">cached</span><span class="s1">) </span><span class="s5">return </span><span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">str</span><span class="s1">);</span>

  <span class="s3">// read</span>
  <span class="s2">fs</span><span class="s1">.</span><span class="s2">readFile</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s0">'utf8'</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">err</span><span class="s1">, </span><span class="s2">str</span><span class="s1">) {</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) </span><span class="s5">return </span><span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s3">// remove extraneous utf8 BOM marker</span>
    <span class="s2">str </span><span class="s1">= </span><span class="s2">str</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s7">/^\uFEFF/</span><span class="s1">, </span><span class="s0">''</span><span class="s1">);</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">cache</span><span class="s1">) </span><span class="s2">readCache</span><span class="s1">[</span><span class="s2">path</span><span class="s1">] = </span><span class="s2">str</span><span class="s1">;</span>
    <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">str</span><span class="s1">);</span>
  <span class="s1">});</span>
<span class="s1">}</span>

<span class="s4">/**</span>
 <span class="s4">* Read `path` with `options` with</span>
 <span class="s4">* callback `(err, str)`. When `options.cache`</span>
 <span class="s4">* is true the partial string will be cached.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s6">@param </span><span class="s4">{String} options</span>
 <span class="s4">* </span><span class="s6">@param </span><span class="s4">{Function} fn</span>
 <span class="s4">* </span><span class="s6">@api </span><span class="s4">private</span>
 <span class="s4">*/</span>

<span class="s5">function </span><span class="s2">readPartials</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">if </span><span class="s1">(!</span><span class="s2">options</span><span class="s1">.</span><span class="s2">partials</span><span class="s1">) </span><span class="s5">return </span><span class="s2">cb</span><span class="s1">();</span>
  <span class="s5">var </span><span class="s2">partials </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">partials</span><span class="s1">;</span>
  <span class="s5">var </span><span class="s2">keys </span><span class="s1">= </span><span class="s2">Object</span><span class="s1">.</span><span class="s2">keys</span><span class="s1">(</span><span class="s2">partials</span><span class="s1">);</span>

  <span class="s5">function </span><span class="s2">next</span><span class="s1">(</span><span class="s2">index</span><span class="s1">) {</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">index </span><span class="s1">=== </span><span class="s2">keys</span><span class="s1">.</span><span class="s2">length</span><span class="s1">) </span><span class="s5">return </span><span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">);</span>
    <span class="s5">var </span><span class="s2">key </span><span class="s1">= </span><span class="s2">keys</span><span class="s1">[</span><span class="s2">index</span><span class="s1">];</span>
    <span class="s5">var </span><span class="s2">partialPath </span><span class="s1">= </span><span class="s2">partials</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>

    <span class="s5">if </span><span class="s1">(</span><span class="s2">partialPath </span><span class="s1">=== </span><span class="s2">undefined </span><span class="s1">|| </span><span class="s2">partialPath </span><span class="s1">=== </span><span class="s5">null </span><span class="s1">|| </span><span class="s2">partialPath </span><span class="s1">=== </span><span class="s5">false</span><span class="s1">) {</span>
      <span class="s5">return </span><span class="s2">next</span><span class="s1">(++</span><span class="s2">index</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s5">var </span><span class="s2">file</span><span class="s1">;</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">isAbsolute</span><span class="s1">(</span><span class="s2">partialPath</span><span class="s1">)) {</span>
      <span class="s5">if </span><span class="s1">(</span><span class="s2">extname</span><span class="s1">(</span><span class="s2">partialPath</span><span class="s1">) !== </span><span class="s0">''</span><span class="s1">) {</span>
        <span class="s2">file </span><span class="s1">= </span><span class="s2">partialPath</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s5">else </span><span class="s1">{</span>
        <span class="s2">file </span><span class="s1">= </span><span class="s2">join</span><span class="s1">(</span><span class="s2">partialPath </span><span class="s1">+ </span><span class="s2">extname</span><span class="s1">(</span><span class="s2">path</span><span class="s1">));</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s5">else </span><span class="s1">{</span>
      <span class="s2">file </span><span class="s1">= </span><span class="s2">join</span><span class="s1">(</span><span class="s2">dirname</span><span class="s1">(</span><span class="s2">path</span><span class="s1">), </span><span class="s2">partialPath </span><span class="s1">+ </span><span class="s2">extname</span><span class="s1">(</span><span class="s2">path</span><span class="s1">));</span>
    <span class="s1">}</span>

    <span class="s2">read</span><span class="s1">(</span><span class="s2">file</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">err</span><span class="s1">, </span><span class="s2">str</span><span class="s1">) {</span>
      <span class="s5">if </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) </span><span class="s5">return </span><span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">partials</span><span class="s1">[</span><span class="s2">key</span><span class="s1">] = </span><span class="s2">str</span><span class="s1">;</span>
      <span class="s2">next</span><span class="s1">(++</span><span class="s2">index</span><span class="s1">);</span>
    <span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s2">next</span><span class="s1">(</span><span class="s8">0</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s4">/**</span>
 <span class="s4">* promisify</span>
 <span class="s4">*/</span>
<span class="s5">function </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s2">fn</span><span class="s1">) {</span>
  <span class="s5">return new </span><span class="s2">Promise</span><span class="s1">(</span><span class="s5">function</span><span class="s1">(</span><span class="s2">resolve</span><span class="s1">, </span><span class="s2">reject</span><span class="s1">) {</span>
    <span class="s2">cb </span><span class="s1">= </span><span class="s2">cb </span><span class="s1">|| </span><span class="s5">function</span><span class="s1">(</span><span class="s2">err</span><span class="s1">, </span><span class="s2">html</span><span class="s1">) {</span>
      <span class="s5">if </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
        <span class="s5">return </span><span class="s2">reject</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
      <span class="s1">}</span>
      <span class="s2">resolve</span><span class="s1">(</span><span class="s2">html</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s2">fn</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">);</span>
  <span class="s1">});</span>
<span class="s1">}</span>

<span class="s4">/**</span>
 <span class="s4">* fromStringRenderer</span>
 <span class="s4">*/</span>

<span class="s5">function </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s2">name</span><span class="s1">) {</span>
  <span class="s5">return function</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">filename </span><span class="s1">= </span><span class="s2">path</span><span class="s1">;</span>

    <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
      <span class="s2">readPartials</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
        <span class="s5">if </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) </span><span class="s5">return </span><span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
        <span class="s5">if </span><span class="s1">(</span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">)) {</span>
          <span class="s2">exports</span><span class="s1">[</span><span class="s2">name</span><span class="s1">].</span><span class="s2">render</span><span class="s1">(</span><span class="s0">''</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">);</span>
        <span class="s1">} </span><span class="s5">else </span><span class="s1">{</span>
          <span class="s2">read</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">err</span><span class="s1">, </span><span class="s2">str</span><span class="s1">) {</span>
            <span class="s5">if </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) </span><span class="s5">return </span><span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
            <span class="s2">exports</span><span class="s1">[</span><span class="s2">name</span><span class="s1">].</span><span class="s2">render</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">);</span>
          <span class="s1">});</span>
        <span class="s1">}</span>
      <span class="s1">});</span>
    <span class="s1">});</span>
  <span class="s1">};</span>
<span class="s1">}</span>

<span class="s4">/**</span>
 <span class="s4">* velocity support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">velocityjs </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'velocityjs'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* velocity string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">velocityjs</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">velocityjs </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">velocityjs </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'velocityjs'</span><span class="s1">));</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">locals </span><span class="s1">= </span><span class="s2">options</span><span class="s1">;</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">render</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">).</span><span class="s2">trimLeft</span><span class="s1">());</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Liquid support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">liquid </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'liquid'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* Liquid string support.</span>
 <span class="s4">*/</span>

<span class="s4">/**</span>
 <span class="s4">* Note that in order to get filters and custom tags we've had to push</span>
 <span class="s4">* all user-defined locals down into @locals. However, just to make things</span>
 <span class="s4">* backwards-compatible, any property of `options` that is left after</span>
 <span class="s4">* processing and removing `locals`, `meta`, `filters`, `customTags` and</span>
 <span class="s4">* `includeDir` will also become a local.</span>
 <span class="s4">*/</span>

<span class="s5">function </span><span class="s2">_renderTinyliquid</span><span class="s1">(</span><span class="s2">engine</span><span class="s1">, </span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">var </span><span class="s2">context </span><span class="s1">= </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">newContext</span><span class="s1">();</span>
  <span class="s5">var </span><span class="s2">k</span><span class="s1">;</span>

  <span class="s4">/**</span>
   <span class="s4">* Note that there's a bug in the library that doesn't allow us to pass</span>
   <span class="s4">* the locals to newContext(), hence looping through the keys:</span>
   <span class="s4">*/</span>

  <span class="s5">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">locals</span><span class="s1">) {</span>
    <span class="s5">for </span><span class="s1">(</span><span class="s2">k </span><span class="s5">in </span><span class="s2">options</span><span class="s1">.</span><span class="s2">locals</span><span class="s1">) {</span>
      <span class="s2">context</span><span class="s1">.</span><span class="s2">setLocals</span><span class="s1">(</span><span class="s2">k</span><span class="s1">, </span><span class="s2">options</span><span class="s1">.</span><span class="s2">locals</span><span class="s1">[</span><span class="s2">k</span><span class="s1">]);</span>
    <span class="s1">}</span>
    <span class="s5">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">locals</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s5">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">meta</span><span class="s1">) {</span>
    <span class="s2">context</span><span class="s1">.</span><span class="s2">setLocals</span><span class="s1">(</span><span class="s0">'page'</span><span class="s1">, </span><span class="s2">options</span><span class="s1">.</span><span class="s2">meta</span><span class="s1">);</span>
    <span class="s5">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">meta</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* Add any defined filters:</span>
   <span class="s4">*/</span>

  <span class="s5">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">filters</span><span class="s1">) {</span>
    <span class="s5">for </span><span class="s1">(</span><span class="s2">k </span><span class="s5">in </span><span class="s2">options</span><span class="s1">.</span><span class="s2">filters</span><span class="s1">) {</span>
      <span class="s2">context</span><span class="s1">.</span><span class="s2">setFilter</span><span class="s1">(</span><span class="s2">k</span><span class="s1">, </span><span class="s2">options</span><span class="s1">.</span><span class="s2">filters</span><span class="s1">[</span><span class="s2">k</span><span class="s1">]);</span>
    <span class="s1">}</span>
    <span class="s5">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">filters</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* Set up a callback for the include directory:</span>
   <span class="s4">*/</span>

  <span class="s5">var </span><span class="s2">includeDir </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">includeDir </span><span class="s1">|| </span><span class="s2">process</span><span class="s1">.</span><span class="s2">cwd</span><span class="s1">();</span>

  <span class="s2">context</span><span class="s1">.</span><span class="s2">onInclude</span><span class="s1">(</span><span class="s5">function</span><span class="s1">(</span><span class="s2">name</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">extname </span><span class="s1">= </span><span class="s2">path</span><span class="s1">.</span><span class="s2">extname</span><span class="s1">(</span><span class="s2">name</span><span class="s1">) ? </span><span class="s0">'' </span><span class="s1">: </span><span class="s0">'.liquid'</span><span class="s1">;</span>
    <span class="s5">var </span><span class="s2">filename </span><span class="s1">= </span><span class="s2">path</span><span class="s1">.</span><span class="s2">resolve</span><span class="s1">(</span><span class="s2">includeDir</span><span class="s1">, </span><span class="s2">name </span><span class="s1">+ </span><span class="s2">extname</span><span class="s1">);</span>

    <span class="s2">fs</span><span class="s1">.</span><span class="s2">readFile</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, {</span><span class="s2">encoding</span><span class="s1">: </span><span class="s0">'utf8'</span><span class="s1">}, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">err</span><span class="s1">, </span><span class="s2">data</span><span class="s1">) {</span>
      <span class="s5">if </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) </span><span class="s5">return </span><span class="s2">callback</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
      <span class="s2">callback</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">parse</span><span class="s1">(</span><span class="s2">data</span><span class="s1">));</span>
    <span class="s1">});</span>
  <span class="s1">});</span>
  <span class="s5">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">includeDir</span><span class="s1">;</span>

  <span class="s4">/**</span>
   <span class="s4">* The custom tag functions need to have their results pushed back</span>
   <span class="s4">* through the parser, so set up a shim before calling the provided</span>
   <span class="s4">* callback:</span>
   <span class="s4">*/</span>

  <span class="s5">var </span><span class="s2">compileOptions </span><span class="s1">= {</span>
    <span class="s2">customTags</span><span class="s1">: {}</span>
  <span class="s1">};</span>

  <span class="s5">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">customTags</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">tagFunctions </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">customTags</span><span class="s1">;</span>

    <span class="s5">for </span><span class="s1">(</span><span class="s2">k </span><span class="s5">in </span><span class="s2">options</span><span class="s1">.</span><span class="s2">customTags</span><span class="s1">) {</span>
      <span class="s3">/*Tell jshint there's no problem with having this function in the loop */</span>
      <span class="s3">/*jshint -W083 */</span>
      <span class="s2">compileOptions</span><span class="s1">.</span><span class="s2">customTags</span><span class="s1">[</span><span class="s2">k</span><span class="s1">] = </span><span class="s5">function</span><span class="s1">(</span><span class="s2">context</span><span class="s1">, </span><span class="s2">name</span><span class="s1">, </span><span class="s2">body</span><span class="s1">) {</span>
        <span class="s5">var </span><span class="s2">tpl </span><span class="s1">= </span><span class="s2">tagFunctions</span><span class="s1">[</span><span class="s2">name</span><span class="s1">](</span><span class="s2">body</span><span class="s1">.</span><span class="s2">trim</span><span class="s1">());</span>
        <span class="s2">context</span><span class="s1">.</span><span class="s2">astStack</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">engine</span><span class="s1">.</span><span class="s2">parse</span><span class="s1">(</span><span class="s2">tpl</span><span class="s1">));</span>
      <span class="s1">};</span>
      <span class="s3">/*jshint +W083 */</span>
    <span class="s1">}</span>
    <span class="s5">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">customTags</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* Now anything left in `options` becomes a local:</span>
   <span class="s4">*/</span>

  <span class="s5">for </span><span class="s1">(</span><span class="s2">k </span><span class="s5">in </span><span class="s2">options</span><span class="s1">) {</span>
    <span class="s2">context</span><span class="s1">.</span><span class="s2">setLocals</span><span class="s1">(</span><span class="s2">k</span><span class="s1">, </span><span class="s2">options</span><span class="s1">[</span><span class="s2">k</span><span class="s1">]);</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* Finally, execute the template:</span>
   <span class="s4">*/</span>

  <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">context</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">context</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">compile</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">compileOptions</span><span class="s1">));</span>
  <span class="s2">tmpl</span><span class="s1">(</span><span class="s2">context</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">liquid</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">liquid</span><span class="s1">;</span>
    <span class="s5">var </span><span class="s2">Liquid</span><span class="s1">;</span>

    <span class="s5">try </span><span class="s1">{</span>
      <span class="s3">// set up tinyliquid engine</span>
      <span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">liquid </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'tinyliquid'</span><span class="s1">);</span>

      <span class="s3">// use tinyliquid engine</span>
      <span class="s2">_renderTinyliquid</span><span class="s1">(</span><span class="s2">engine</span><span class="s1">, </span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">);</span>

      <span class="s5">return</span><span class="s1">;</span>

    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>

      <span class="s3">// set up liquid-node engine</span>
      <span class="s5">try </span><span class="s1">{</span>
        <span class="s2">Liquid </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">liquid </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'liquid-node'</span><span class="s1">);</span>
        <span class="s2">engine </span><span class="s1">= </span><span class="s5">new </span><span class="s2">Liquid</span><span class="s1">.</span><span class="s2">Engine</span><span class="s1">();</span>
      <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
        <span class="s5">throw </span><span class="s2">err</span><span class="s1">;</span>
      <span class="s1">}</span>

    <span class="s1">}</span>

    <span class="s3">// use liquid-node engine</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">var </span><span class="s2">locals </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">locals </span><span class="s1">|| {};</span>

      <span class="s5">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">meta</span><span class="s1">) {</span>
        <span class="s2">locals</span><span class="s1">.</span><span class="s2">pages </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">meta</span><span class="s1">;</span>
        <span class="s5">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">meta</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s4">/**</span>
       <span class="s4">* Add any defined filters:</span>
       <span class="s4">*/</span>

      <span class="s5">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">filters</span><span class="s1">) {</span>
        <span class="s2">engine</span><span class="s1">.</span><span class="s2">registerFilters</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">filters</span><span class="s1">);</span>
        <span class="s5">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">filters</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s4">/**</span>
       <span class="s4">* Set up a callback for the include directory:</span>
       <span class="s4">*/</span>

      <span class="s5">var </span><span class="s2">includeDir </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">includeDir </span><span class="s1">|| </span><span class="s2">process</span><span class="s1">.</span><span class="s2">cwd</span><span class="s1">();</span>
      <span class="s2">engine</span><span class="s1">.</span><span class="s2">fileSystem </span><span class="s1">= </span><span class="s5">new </span><span class="s2">Liquid</span><span class="s1">.</span><span class="s2">LocalFileSystem</span><span class="s1">(</span><span class="s2">includeDir</span><span class="s1">, </span><span class="s0">'liquid'</span><span class="s1">);</span>
      <span class="s5">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">includeDir</span><span class="s1">;</span>

      <span class="s4">/**</span>
       <span class="s4">* The custom tag functions need to have their results pushed back</span>
       <span class="s4">* through the parser, so set up a shim before calling the provided</span>
       <span class="s4">* callback:</span>
       <span class="s4">*/</span>

      <span class="s5">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">customTags</span><span class="s1">) {</span>
        <span class="s5">var </span><span class="s2">tagFunctions </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">customTags</span><span class="s1">;</span>

        <span class="s5">for </span><span class="s1">(</span><span class="s2">k </span><span class="s5">in </span><span class="s2">options</span><span class="s1">.</span><span class="s2">customTags</span><span class="s1">) {</span>
          <span class="s2">engine</span><span class="s1">.</span><span class="s2">registerTag</span><span class="s1">(</span><span class="s2">k</span><span class="s1">, </span><span class="s2">tagFunctions</span><span class="s1">[</span><span class="s2">k</span><span class="s1">]);</span>
        <span class="s1">}</span>
        <span class="s5">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">customTags</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s4">/**</span>
       <span class="s4">* Now anything left in `options` becomes a local:</span>
       <span class="s4">*/</span>

      <span class="s5">for </span><span class="s1">(</span><span class="s5">var </span><span class="s2">k </span><span class="s5">in </span><span class="s2">options</span><span class="s1">) {</span>
        <span class="s2">locals</span><span class="s1">[</span><span class="s2">k</span><span class="s1">] = </span><span class="s2">options</span><span class="s1">[</span><span class="s2">k</span><span class="s1">];</span>
      <span class="s1">}</span>

      <span class="s4">/**</span>
       <span class="s4">* Finally, execute the template:</span>
       <span class="s4">*/</span>

      <span class="s5">return </span><span class="s2">engine</span>
        <span class="s1">.</span><span class="s2">parseAndRender</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">locals</span><span class="s1">)</span>
        <span class="s1">.</span><span class="s2">nodeify</span><span class="s1">(</span><span class="s5">function</span><span class="s1">(</span><span class="s2">err</span><span class="s1">, </span><span class="s2">result</span><span class="s1">) {</span>
          <span class="s5">if </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
            <span class="s5">throw new </span><span class="s2">Error</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
          <span class="s1">} </span><span class="s5">else </span><span class="s1">{</span>
            <span class="s5">return </span><span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">result</span><span class="s1">);</span>
          <span class="s1">}</span>
        <span class="s1">});</span>

    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Jade support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">jade </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">jade</span><span class="s1">;</span>
    <span class="s5">if </span><span class="s1">(!</span><span class="s2">engine</span><span class="s1">) {</span>
      <span class="s5">try </span><span class="s1">{</span>
        <span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">jade </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'jade'</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
        <span class="s5">try </span><span class="s1">{</span>
          <span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">jade </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'then-jade'</span><span class="s1">);</span>
        <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">otherError</span><span class="s1">) {</span>
          <span class="s5">throw </span><span class="s2">err</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">compileFile</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">));</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">tmpl</span><span class="s1">(</span><span class="s2">options</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Jade string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">jade</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">jade</span><span class="s1">;</span>
    <span class="s5">if </span><span class="s1">(!</span><span class="s2">engine</span><span class="s1">) {</span>
      <span class="s5">try </span><span class="s1">{</span>
        <span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">jade </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'jade'</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
        <span class="s5">try </span><span class="s1">{</span>
          <span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">jade </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'then-jade'</span><span class="s1">);</span>
        <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">otherError</span><span class="s1">) {</span>
          <span class="s5">throw </span><span class="s2">err</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">compile</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">));</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">tmpl</span><span class="s1">(</span><span class="s2">options</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Dust support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">dust </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'dust'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* Dust string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">dust</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">dust</span><span class="s1">;</span>
    <span class="s5">if </span><span class="s1">(!</span><span class="s2">engine</span><span class="s1">) {</span>
      <span class="s5">try </span><span class="s1">{</span>
        <span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">dust </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'dust'</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
        <span class="s5">try </span><span class="s1">{</span>
          <span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">dust </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'dustjs-helpers'</span><span class="s1">);</span>
        <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
          <span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">dust </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'dustjs-linkedin'</span><span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s5">var </span><span class="s2">ext </span><span class="s1">= </span><span class="s0">'dust'</span><span class="s1">;</span>
    <span class="s5">var </span><span class="s2">views </span><span class="s1">= </span><span class="s0">'.'</span><span class="s1">;</span>

    <span class="s5">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">) {</span>
      <span class="s5">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">ext</span><span class="s1">) </span><span class="s2">ext </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">ext</span><span class="s1">;</span>
      <span class="s5">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">views</span><span class="s1">) </span><span class="s2">views </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">views</span><span class="s1">;</span>
      <span class="s5">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">settings </span><span class="s1">&amp;&amp; </span><span class="s2">options</span><span class="s1">.</span><span class="s2">settings</span><span class="s1">.</span><span class="s2">views</span><span class="s1">) </span><span class="s2">views </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">settings</span><span class="s1">.</span><span class="s2">views</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s5">if </span><span class="s1">(!</span><span class="s2">options </span><span class="s1">|| (</span><span class="s2">options </span><span class="s1">&amp;&amp; !</span><span class="s2">options</span><span class="s1">.</span><span class="s2">cache</span><span class="s1">)) </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">cache </span><span class="s1">= {};</span>

    <span class="s2">engine</span><span class="s1">.</span><span class="s2">onLoad </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">) {</span>
      <span class="s5">if </span><span class="s1">(</span><span class="s2">extname</span><span class="s1">(</span><span class="s2">path</span><span class="s1">) === </span><span class="s0">''</span><span class="s1">) </span><span class="s2">path </span><span class="s1">+= </span><span class="s0">'.' </span><span class="s1">+ </span><span class="s2">ext</span><span class="s1">;</span>
      <span class="s5">if </span><span class="s1">(</span><span class="s2">path</span><span class="s1">[</span><span class="s8">0</span><span class="s1">] !== </span><span class="s0">'/'</span><span class="s1">) </span><span class="s2">path </span><span class="s1">= </span><span class="s2">views </span><span class="s1">+ </span><span class="s0">'/' </span><span class="s1">+ </span><span class="s2">path</span><span class="s1">;</span>
      <span class="s2">read</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">callback</span><span class="s1">);</span>
    <span class="s1">};</span>

    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">var </span><span class="s2">templateName</span><span class="s1">;</span>
      <span class="s5">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">filename</span><span class="s1">) {</span>
        <span class="s2">templateName </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">filename</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s5">new </span><span class="s2">RegExp</span><span class="s1">(</span><span class="s0">'^' </span><span class="s1">+ </span><span class="s2">views </span><span class="s1">+ </span><span class="s0">'/'</span><span class="s1">), </span><span class="s0">''</span><span class="s1">).</span><span class="s2">replace</span><span class="s1">(</span><span class="s5">new </span><span class="s2">RegExp</span><span class="s1">(</span><span class="s0">'</span><span class="s5">\\</span><span class="s0">.' </span><span class="s1">+ </span><span class="s2">ext</span><span class="s1">), </span><span class="s0">''</span><span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">compileFn</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">templateName</span><span class="s1">));</span>
      <span class="s2">tmpl</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Swig support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">swig </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'swig'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* Swig string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">swig</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">swig</span><span class="s1">;</span>
    <span class="s5">if </span><span class="s1">(!</span><span class="s2">engine</span><span class="s1">) {</span>
      <span class="s5">try </span><span class="s1">{</span>
        <span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">swig </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'swig'</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
        <span class="s5">try </span><span class="s1">{</span>
          <span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">swig </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'swig-templates'</span><span class="s1">);</span>
        <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">otherError</span><span class="s1">) {</span>
          <span class="s5">throw </span><span class="s2">err</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">cache </span><span class="s1">=== </span><span class="s5">true</span><span class="s1">) </span><span class="s2">options</span><span class="s1">.</span><span class="s2">cache </span><span class="s1">= </span><span class="s0">'memory'</span><span class="s1">;</span>
      <span class="s2">engine</span><span class="s1">.</span><span class="s2">setDefaults</span><span class="s1">({ </span><span class="s2">cache</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">cache </span><span class="s1">});</span>
      <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">compile</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">));</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">tmpl</span><span class="s1">(</span><span class="s2">options</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Atpl support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">atpl </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'atpl'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* Atpl string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">atpl</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">atpl </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">atpl </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'atpl'</span><span class="s1">));</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">compile</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">));</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">tmpl</span><span class="s1">(</span><span class="s2">options</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Liquor support,</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">liquor </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'liquor'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* Liquor string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">liquor</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">liquor </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">liquor </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'liquor'</span><span class="s1">));</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">compile</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">));</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">tmpl</span><span class="s1">(</span><span class="s2">options</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Twig support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">twig </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'twig'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* Twig string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">twig</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">twig </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">twig </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'twig'</span><span class="s1">).</span><span class="s2">twig</span><span class="s1">);</span>
    <span class="s5">var </span><span class="s2">templateData </span><span class="s1">= {</span>
      <span class="s2">data</span><span class="s1">: </span><span class="s2">str</span>
    <span class="s1">};</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">templateData</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">templateData</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">(</span><span class="s2">templateData</span><span class="s1">));</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">tmpl</span><span class="s1">.</span><span class="s2">render</span><span class="s1">(</span><span class="s2">options</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* EJS support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">ejs </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'ejs'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* EJS string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">ejs</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">ejs </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">ejs </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'ejs'</span><span class="s1">));</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">compile</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">));</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">tmpl</span><span class="s1">(</span><span class="s2">options</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Eco support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">eco </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'eco'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* Eco string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">eco</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">eco </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">eco </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'eco'</span><span class="s1">));</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">render</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Jazz support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">jazz </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'jazz'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* Jazz string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">jazz</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">jazz </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">jazz </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'jazz'</span><span class="s1">));</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">compile</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">));</span>
      <span class="s2">tmpl</span><span class="s1">.</span><span class="s2">eval</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">) {</span>
        <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">str</span><span class="s1">);</span>
      <span class="s1">});</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* JQTPL support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">jqtpl </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'jqtpl'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* JQTPL string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">jqtpl</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">jqtpl </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">jqtpl </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'jqtpl'</span><span class="s1">));</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s2">engine</span><span class="s1">.</span><span class="s2">template</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">str</span><span class="s1">);</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">tmpl</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Haml support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">haml </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'haml'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* Haml string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">haml</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">haml </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">haml </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'hamljs'</span><span class="s1">));</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">locals </span><span class="s1">= </span><span class="s2">options</span><span class="s1">;</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">render</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">).</span><span class="s2">trimLeft</span><span class="s1">());</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Hamlet support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">hamlet </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'hamlet'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* Hamlet string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">hamlet</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">hamlet </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">hamlet </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'hamlet'</span><span class="s1">));</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">locals </span><span class="s1">= </span><span class="s2">options</span><span class="s1">;</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">render</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">).</span><span class="s2">trimLeft</span><span class="s1">());</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Whiskers support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">whiskers </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">whiskers </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">whiskers </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'whiskers'</span><span class="s1">));</span>
    <span class="s2">engine</span><span class="s1">.</span><span class="s2">__express</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">);</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Whiskers string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">whiskers</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">whiskers </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">whiskers </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'whiskers'</span><span class="s1">));</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">render</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Coffee-HAML support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">[</span><span class="s0">'haml-coffee'</span><span class="s1">] = </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'haml-coffee'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* Coffee-HAML string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">[</span><span class="s0">'haml-coffee'</span><span class="s1">].</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">[</span><span class="s0">'haml-coffee'</span><span class="s1">] || (</span><span class="s2">requires</span><span class="s1">[</span><span class="s0">'haml-coffee'</span><span class="s1">] = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'haml-coffee'</span><span class="s1">));</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">compile</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">));</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">tmpl</span><span class="s1">(</span><span class="s2">options</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Hogan support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">hogan </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'hogan'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* Hogan string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">hogan</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">hogan </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">hogan </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'hogan.js'</span><span class="s1">));</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">compile</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">));</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">tmpl</span><span class="s1">.</span><span class="s2">render</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">options</span><span class="s1">.</span><span class="s2">partials</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* templayed.js support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">templayed </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'templayed'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* templayed.js string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">templayed</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">templayed </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">templayed </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'templayed'</span><span class="s1">));</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">(</span><span class="s2">str</span><span class="s1">));</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">tmpl</span><span class="s1">(</span><span class="s2">options</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Handlebars support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">handlebars </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'handlebars'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* Handlebars string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">handlebars</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">handlebars </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">handlebars </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'handlebars'</span><span class="s1">));</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">for </span><span class="s1">(</span><span class="s5">var </span><span class="s2">partial </span><span class="s5">in </span><span class="s2">options</span><span class="s1">.</span><span class="s2">partials</span><span class="s1">) {</span>
        <span class="s2">engine</span><span class="s1">.</span><span class="s2">registerPartial</span><span class="s1">(</span><span class="s2">partial</span><span class="s1">, </span><span class="s2">options</span><span class="s1">.</span><span class="s2">partials</span><span class="s1">[</span><span class="s2">partial</span><span class="s1">]);</span>
      <span class="s1">}</span>
      <span class="s5">for </span><span class="s1">(</span><span class="s5">var </span><span class="s2">helper </span><span class="s5">in </span><span class="s2">options</span><span class="s1">.</span><span class="s2">helpers</span><span class="s1">) {</span>
        <span class="s2">engine</span><span class="s1">.</span><span class="s2">registerHelper</span><span class="s1">(</span><span class="s2">helper</span><span class="s1">, </span><span class="s2">options</span><span class="s1">.</span><span class="s2">helpers</span><span class="s1">[</span><span class="s2">helper</span><span class="s1">]);</span>
      <span class="s1">}</span>
      <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">compile</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">));</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">tmpl</span><span class="s1">(</span><span class="s2">options</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Underscore support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">underscore </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'underscore'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* Underscore string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">underscore</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">underscore </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">underscore </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'underscore'</span><span class="s1">));</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">for </span><span class="s1">(</span><span class="s5">var </span><span class="s2">partial </span><span class="s5">in </span><span class="s2">options</span><span class="s1">.</span><span class="s2">partials</span><span class="s1">) {</span>
        <span class="s2">options</span><span class="s1">.</span><span class="s2">partials</span><span class="s1">[</span><span class="s2">partial</span><span class="s1">] = </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">template</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">partials</span><span class="s1">[</span><span class="s2">partial</span><span class="s1">]);</span>
      <span class="s1">}</span>
      <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">template</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s5">null</span><span class="s1">, </span><span class="s2">options</span><span class="s1">));</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">tmpl</span><span class="s1">(</span><span class="s2">options</span><span class="s1">).</span><span class="s2">replace</span><span class="s1">(</span><span class="s7">/\n$/</span><span class="s1">, </span><span class="s0">''</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Lodash support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">lodash </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'lodash'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* Lodash string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">lodash</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">lodash </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">lodash </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'lodash'</span><span class="s1">));</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">template</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">));</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">tmpl</span><span class="s1">(</span><span class="s2">options</span><span class="s1">).</span><span class="s2">replace</span><span class="s1">(</span><span class="s7">/\n$/</span><span class="s1">, </span><span class="s0">''</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Pug support. (formerly Jade)</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">pug </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">pug</span><span class="s1">;</span>
    <span class="s5">if </span><span class="s1">(!</span><span class="s2">engine</span><span class="s1">) {</span>
      <span class="s5">try </span><span class="s1">{</span>
        <span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">pug </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'pug'</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
        <span class="s5">try </span><span class="s1">{</span>
          <span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">pug </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'then-pug'</span><span class="s1">);</span>
        <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">otherError</span><span class="s1">) {</span>
          <span class="s5">throw </span><span class="s2">err</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">compileFile</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">));</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">tmpl</span><span class="s1">(</span><span class="s2">options</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Pug string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">pug</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">pug</span><span class="s1">;</span>
    <span class="s5">if </span><span class="s1">(!</span><span class="s2">engine</span><span class="s1">) {</span>
      <span class="s5">try </span><span class="s1">{</span>
        <span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">pug </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'pug'</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
        <span class="s5">try </span><span class="s1">{</span>
          <span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">pug </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'then-pug'</span><span class="s1">);</span>
        <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">otherError</span><span class="s1">) {</span>
          <span class="s5">throw </span><span class="s2">err</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">compile</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">));</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">tmpl</span><span class="s1">(</span><span class="s2">options</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* QEJS support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">qejs </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'qejs'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* QEJS string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">qejs</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">qejs </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">qejs </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'qejs'</span><span class="s1">));</span>
      <span class="s2">engine</span><span class="s1">.</span><span class="s2">render</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">).</span><span class="s2">then</span><span class="s1">(</span><span class="s5">function</span><span class="s1">(</span><span class="s2">result</span><span class="s1">) {</span>
        <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">result</span><span class="s1">);</span>
      <span class="s1">}, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
        <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
      <span class="s1">}).</span><span class="s2">done</span><span class="s1">();</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Walrus support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">walrus </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'walrus'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* Walrus string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">walrus</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">walrus </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">walrus </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'walrus'</span><span class="s1">));</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">parse</span><span class="s1">(</span><span class="s2">str</span><span class="s1">));</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">tmpl</span><span class="s1">.</span><span class="s2">compile</span><span class="s1">(</span><span class="s2">options</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Mustache support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">mustache </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'mustache'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* Mustache string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">mustache</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">mustache </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">mustache </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'mustache'</span><span class="s1">));</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">to_html</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">options</span><span class="s1">.</span><span class="s2">partials</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Just support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">just </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">just</span><span class="s1">;</span>
    <span class="s5">if </span><span class="s1">(!</span><span class="s2">engine</span><span class="s1">) {</span>
      <span class="s5">var </span><span class="s2">JUST </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'just'</span><span class="s1">);</span>
      <span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">just </span><span class="s1">= </span><span class="s5">new </span><span class="s2">JUST</span><span class="s1">();</span>
    <span class="s1">}</span>
    <span class="s2">engine</span><span class="s1">.</span><span class="s2">configure</span><span class="s1">({ </span><span class="s2">useCache</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">cache </span><span class="s1">});</span>
    <span class="s2">engine</span><span class="s1">.</span><span class="s2">render</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">);</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Just string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">just</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">JUST </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'just'</span><span class="s1">);</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s5">new </span><span class="s2">JUST</span><span class="s1">({ </span><span class="s2">root</span><span class="s1">: { </span><span class="s2">page</span><span class="s1">: </span><span class="s2">str </span><span class="s1">}});</span>
    <span class="s2">engine</span><span class="s1">.</span><span class="s2">render</span><span class="s1">(</span><span class="s0">'page'</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">);</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* ECT support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">ect </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">ect</span><span class="s1">;</span>
    <span class="s5">if </span><span class="s1">(!</span><span class="s2">engine</span><span class="s1">) {</span>
      <span class="s5">var </span><span class="s2">ECT </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'ect'</span><span class="s1">);</span>
      <span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">ect </span><span class="s1">= </span><span class="s5">new </span><span class="s2">ECT</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s2">engine</span><span class="s1">.</span><span class="s2">configure</span><span class="s1">({ </span><span class="s2">cache</span><span class="s1">: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">cache </span><span class="s1">});</span>
    <span class="s2">engine</span><span class="s1">.</span><span class="s2">render</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">);</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* ECT string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">ect</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">ECT </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'ect'</span><span class="s1">);</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s5">new </span><span class="s2">ECT</span><span class="s1">({ </span><span class="s2">root</span><span class="s1">: { </span><span class="s2">page</span><span class="s1">: </span><span class="s2">str </span><span class="s1">}});</span>
    <span class="s2">engine</span><span class="s1">.</span><span class="s2">render</span><span class="s1">(</span><span class="s0">'page'</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">);</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* mote support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">mote </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'mote'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* mote string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">mote</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">mote </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">mote </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'mote'</span><span class="s1">));</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">compile</span><span class="s1">(</span><span class="s2">str</span><span class="s1">));</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">tmpl</span><span class="s1">(</span><span class="s2">options</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Toffee support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">toffee </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">toffee </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">toffee </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">toffee </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'toffee'</span><span class="s1">));</span>
    <span class="s2">toffee</span><span class="s1">.</span><span class="s2">__consolidate_engine_render</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">);</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Toffee string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">toffee</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">toffee </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">toffee </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'toffee'</span><span class="s1">));</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s2">engine</span><span class="s1">.</span><span class="s2">str_render</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* doT support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">dot </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'dot'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* doT string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">dot</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">dot </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">dot </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'dot'</span><span class="s1">));</span>
    <span class="s5">var </span><span class="s2">extend </span><span class="s1">= (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">extend </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">extend </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'util'</span><span class="s1">).</span><span class="s2">_extend</span><span class="s1">));</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">var </span><span class="s2">settings </span><span class="s1">= {};</span>
      <span class="s2">settings </span><span class="s1">= </span><span class="s2">extend</span><span class="s1">(</span><span class="s2">settings</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">templateSettings</span><span class="s1">);</span>
      <span class="s2">settings </span><span class="s1">= </span><span class="s2">extend</span><span class="s1">(</span><span class="s2">settings</span><span class="s1">, </span><span class="s2">options </span><span class="s1">? </span><span class="s2">options</span><span class="s1">.</span><span class="s2">dot </span><span class="s1">: {});</span>
      <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">template</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">settings</span><span class="s1">, </span><span class="s2">options</span><span class="s1">));</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">tmpl</span><span class="s1">(</span><span class="s2">options</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* bracket support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">bracket </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'bracket'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* bracket string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">bracket</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">bracket </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">bracket </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'bracket-template'</span><span class="s1">));</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">default</span><span class="s1">.</span><span class="s2">compile</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">));</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">tmpl</span><span class="s1">(</span><span class="s2">options</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Ractive support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">ractive </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'ractive'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* Ractive string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">ractive</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">Engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">ractive </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">ractive </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'ractive'</span><span class="s1">));</span>

    <span class="s5">var </span><span class="s2">template </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">Engine</span><span class="s1">.</span><span class="s2">parse</span><span class="s1">(</span><span class="s2">str</span><span class="s1">));</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">template </span><span class="s1">= </span><span class="s2">template</span><span class="s1">;</span>

    <span class="s5">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">data </span><span class="s1">=== </span><span class="s5">null </span><span class="s1">|| </span><span class="s2">options</span><span class="s1">.</span><span class="s2">data </span><span class="s1">=== </span><span class="s2">undefined</span><span class="s1">) {</span>
      <span class="s5">var </span><span class="s2">extend </span><span class="s1">= (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">extend </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">extend </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'util'</span><span class="s1">).</span><span class="s2">_extend</span><span class="s1">));</span>

      <span class="s3">// Shallow clone the options object</span>
      <span class="s2">options</span><span class="s1">.</span><span class="s2">data </span><span class="s1">= </span><span class="s2">extend</span><span class="s1">({}, </span><span class="s2">options</span><span class="s1">);</span>

      <span class="s3">// Remove consolidate-specific properties from the clone</span>
      <span class="s5">var </span><span class="s2">i</span><span class="s1">;</span>
      <span class="s5">var </span><span class="s2">length</span><span class="s1">;</span>
      <span class="s5">var </span><span class="s2">properties </span><span class="s1">= [</span><span class="s0">'template'</span><span class="s1">, </span><span class="s0">'filename'</span><span class="s1">, </span><span class="s0">'cache'</span><span class="s1">, </span><span class="s0">'partials'</span><span class="s1">];</span>
      <span class="s5">for </span><span class="s1">(</span><span class="s2">i </span><span class="s1">= </span><span class="s8">0</span><span class="s1">, </span><span class="s2">length </span><span class="s1">= </span><span class="s2">properties</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">length</span><span class="s1">; </span><span class="s2">i</span><span class="s1">++) {</span>
        <span class="s5">var </span><span class="s2">property </span><span class="s1">= </span><span class="s2">properties</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>
        <span class="s5">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">data</span><span class="s1">[</span><span class="s2">property</span><span class="s1">];</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s5">try </span><span class="s1">{</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s5">new </span><span class="s2">Engine</span><span class="s1">(</span><span class="s2">options</span><span class="s1">).</span><span class="s2">toHTML</span><span class="s1">());</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Nunjucks support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">nunjucks </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'nunjucks'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* Nunjucks string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">nunjucks</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>

    <span class="s5">try </span><span class="s1">{</span>

      <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">nunjucksEnv </span><span class="s1">|| </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">nunjucks </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">nunjucks </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'nunjucks'</span><span class="s1">));</span>

      <span class="s5">var </span><span class="s2">env </span><span class="s1">= </span><span class="s2">engine</span><span class="s1">;</span>

      <span class="s3">// deprecated fallback support for express</span>
      <span class="s3">// &lt;https://github.com/tj/consolidate.js/pull/152&gt;</span>
      <span class="s3">// &lt;https://github.com/tj/consolidate.js/pull/224&gt;</span>
      <span class="s5">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">settings </span><span class="s1">&amp;&amp; </span><span class="s2">options</span><span class="s1">.</span><span class="s2">settings</span><span class="s1">.</span><span class="s2">views</span><span class="s1">) {</span>
        <span class="s2">env </span><span class="s1">= </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">configure</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">settings</span><span class="s1">.</span><span class="s2">views</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s5">else if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">nunjucks </span><span class="s1">&amp;&amp; </span><span class="s2">options</span><span class="s1">.</span><span class="s2">nunjucks</span><span class="s1">.</span><span class="s2">configure</span><span class="s1">) {</span>
        <span class="s2">env </span><span class="s1">= </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">configure</span><span class="s1">.</span><span class="s2">apply</span><span class="s1">(</span><span class="s2">engine</span><span class="s1">, </span><span class="s2">options</span><span class="s1">.</span><span class="s2">nunjucks</span><span class="s1">.</span><span class="s2">configure</span><span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s3">//</span>
      <span class="s3">// because `renderString` does not initiate loaders</span>
      <span class="s3">// we must manually create a loader for it based off</span>
      <span class="s3">// either `options.settings.views` or `options.nunjucks` or `options.nunjucks.root`</span>
      <span class="s3">//</span>
      <span class="s3">// &lt;https://github.com/mozilla/nunjucks/issues/730&gt;</span>
      <span class="s3">// &lt;https://github.com/crocodilejs/node-email-templates/issues/182&gt;</span>
      <span class="s3">//</span>

      <span class="s3">// so instead we simply check if we passed a custom loader</span>
      <span class="s3">// otherwise we create a simple file based loader</span>
      <span class="s5">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">loader</span><span class="s1">) {</span>
        <span class="s2">env </span><span class="s1">= </span><span class="s5">new </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">Environment</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">loader</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s5">else if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">settings </span><span class="s1">&amp;&amp; </span><span class="s2">options</span><span class="s1">.</span><span class="s2">settings</span><span class="s1">.</span><span class="s2">views</span><span class="s1">) {</span>
        <span class="s2">env </span><span class="s1">= </span><span class="s5">new </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">Environment</span><span class="s1">(</span>
          <span class="s5">new </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">FileSystemLoader</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">settings</span><span class="s1">.</span><span class="s2">views</span><span class="s1">)</span>
        <span class="s1">);</span>
      <span class="s1">} </span><span class="s5">else if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">nunjucks </span><span class="s1">&amp;&amp; </span><span class="s2">options</span><span class="s1">.</span><span class="s2">nunjucks</span><span class="s1">.</span><span class="s2">loader</span><span class="s1">) {</span>
        <span class="s5">if </span><span class="s1">(</span><span class="s5">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">nunjucks</span><span class="s1">.</span><span class="s2">loader </span><span class="s1">=== </span><span class="s0">'string'</span><span class="s1">) {</span>
          <span class="s2">env </span><span class="s1">= </span><span class="s5">new </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">Environment</span><span class="s1">(</span><span class="s5">new </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">FileSystemLoader</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">nunjucks</span><span class="s1">.</span><span class="s2">loader</span><span class="s1">));</span>
        <span class="s1">} </span><span class="s5">else </span><span class="s1">{</span>
          <span class="s2">env </span><span class="s1">= </span><span class="s5">new </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">Environment</span><span class="s1">(</span>
            <span class="s5">new </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">FileSystemLoader</span><span class="s1">(</span>
              <span class="s2">options</span><span class="s1">.</span><span class="s2">nunjucks</span><span class="s1">.</span><span class="s2">loader</span><span class="s1">[</span><span class="s8">0</span><span class="s1">],</span>
              <span class="s2">options</span><span class="s1">.</span><span class="s2">nunjucks</span><span class="s1">.</span><span class="s2">loader</span><span class="s1">[</span><span class="s8">1</span><span class="s1">]</span>
            <span class="s1">)</span>
          <span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s2">env</span><span class="s1">.</span><span class="s2">renderString</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s5">throw </span><span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* HTMLing support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">htmling </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'htmling'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* HTMLing string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">htmling</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">htmling </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">htmling </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'htmling'</span><span class="s1">));</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">string</span><span class="s1">(</span><span class="s2">str</span><span class="s1">));</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">tmpl</span><span class="s1">.</span><span class="s2">render</span><span class="s1">(</span><span class="s2">options</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">*  Rendering function</span>
 <span class="s4">*/</span>
<span class="s5">function </span><span class="s2">requireReact</span><span class="s1">(</span><span class="s2">module</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">) {</span>
  <span class="s5">var </span><span class="s2">babel </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">babel </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">babel </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'babel-core'</span><span class="s1">));</span>

  <span class="s5">var </span><span class="s2">compiled </span><span class="s1">= </span><span class="s2">babel</span><span class="s1">.</span><span class="s2">transformFileSync</span><span class="s1">(</span><span class="s2">filename</span><span class="s1">, { </span><span class="s2">presets</span><span class="s1">: [ </span><span class="s0">'react' </span><span class="s1">] }).</span><span class="s2">code</span><span class="s1">;</span>

  <span class="s5">return </span><span class="s2">module</span><span class="s1">.</span><span class="s2">_compile</span><span class="s1">(</span><span class="s2">compiled</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">requireReact </span><span class="s1">= </span><span class="s2">requireReact</span><span class="s1">;</span>

<span class="s4">/**</span>
 <span class="s4">*  Converting a string into a node module.</span>
 <span class="s4">*/</span>
<span class="s5">function </span><span class="s2">requireReactString</span><span class="s1">(</span><span class="s2">src</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">) {</span>
  <span class="s5">var </span><span class="s2">babel </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">babel </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">babel </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'babel-core'</span><span class="s1">));</span>

  <span class="s5">if </span><span class="s1">(!</span><span class="s2">filename</span><span class="s1">) </span><span class="s2">filename </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
  <span class="s5">var </span><span class="s2">m </span><span class="s1">= </span><span class="s5">new </span><span class="s2">module</span><span class="s1">.</span><span class="s2">constructor</span><span class="s1">();</span>
  <span class="s2">filename </span><span class="s1">= </span><span class="s2">filename </span><span class="s1">|| </span><span class="s0">''</span><span class="s1">;</span>

  <span class="s3">// Compile Using React</span>
  <span class="s5">var </span><span class="s2">compiled </span><span class="s1">= </span><span class="s2">babel</span><span class="s1">.</span><span class="s2">transform</span><span class="s1">(</span><span class="s2">src</span><span class="s1">, { </span><span class="s2">presets</span><span class="s1">: [ </span><span class="s0">'react' </span><span class="s1">] }).</span><span class="s2">code</span><span class="s1">;</span>

  <span class="s3">// Compile as a module</span>
  <span class="s2">m</span><span class="s1">.</span><span class="s2">paths </span><span class="s1">= </span><span class="s2">module</span><span class="s1">.</span><span class="s2">paths</span><span class="s1">;</span>
  <span class="s2">m</span><span class="s1">.</span><span class="s2">_compile</span><span class="s1">(</span><span class="s2">compiled</span><span class="s1">, </span><span class="s2">filename</span><span class="s1">);</span>

  <span class="s5">return </span><span class="s2">m</span><span class="s1">.</span><span class="s2">exports</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s4">/**</span>
 <span class="s4">* A naive helper to replace {{tags}} with options.tags content</span>
 <span class="s4">*/</span>
<span class="s5">function </span><span class="s2">reactBaseTmpl</span><span class="s1">(</span><span class="s2">data</span><span class="s1">, </span><span class="s2">options</span><span class="s1">) {</span>

  <span class="s5">var </span><span class="s2">exp</span><span class="s1">;</span>
  <span class="s5">var </span><span class="s2">regex</span><span class="s1">;</span>

  <span class="s3">// Iterates through the keys in file object</span>
  <span class="s3">// and interpolate / replace {{key}} with it's value</span>
  <span class="s5">for </span><span class="s1">(</span><span class="s5">var </span><span class="s2">k </span><span class="s5">in </span><span class="s2">options</span><span class="s1">) {</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">hasOwnProperty</span><span class="s1">(</span><span class="s2">k</span><span class="s1">)) {</span>
      <span class="s2">exp </span><span class="s1">= </span><span class="s0">'{{' </span><span class="s1">+ </span><span class="s2">k </span><span class="s1">+ </span><span class="s0">'}}'</span><span class="s1">;</span>
      <span class="s2">regex </span><span class="s1">= </span><span class="s5">new </span><span class="s2">RegExp</span><span class="s1">(</span><span class="s2">exp</span><span class="s1">, </span><span class="s0">'g'</span><span class="s1">);</span>
      <span class="s5">if </span><span class="s1">(</span><span class="s2">data</span><span class="s1">.</span><span class="s2">match</span><span class="s1">(</span><span class="s2">regex</span><span class="s1">)) {</span>
        <span class="s2">data </span><span class="s1">= </span><span class="s2">data</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s2">regex</span><span class="s1">, </span><span class="s2">options</span><span class="s1">[</span><span class="s2">k</span><span class="s1">]);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s5">return </span><span class="s2">data</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s4">/**</span>
<span class="s4">* Plates Support.</span>
<span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">plates </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'plates'</span><span class="s1">);</span>

<span class="s4">/**</span>
<span class="s4">* Plates string support.</span>
<span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">plates</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">plates </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">plates </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'plates'</span><span class="s1">));</span>
    <span class="s5">var </span><span class="s2">map </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">map </span><span class="s1">|| </span><span class="s2">undefined</span><span class="s1">;</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">bind</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">map</span><span class="s1">);</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">tmpl</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">*  The main render parser for React bsaed templates</span>
 <span class="s4">*/</span>
<span class="s5">function </span><span class="s2">reactRenderer</span><span class="s1">(</span><span class="s2">type</span><span class="s1">) {</span>

  <span class="s5">if </span><span class="s1">(</span><span class="s2">require</span><span class="s1">.</span><span class="s2">extensions</span><span class="s1">) {</span>

    <span class="s3">// Ensure JSX is transformed on require</span>
    <span class="s5">if </span><span class="s1">(!</span><span class="s2">require</span><span class="s1">.</span><span class="s2">extensions</span><span class="s1">[</span><span class="s0">'.jsx'</span><span class="s1">]) {</span>
      <span class="s2">require</span><span class="s1">.</span><span class="s2">extensions</span><span class="s1">[</span><span class="s0">'.jsx'</span><span class="s1">] = </span><span class="s2">requireReact</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">// Supporting .react extension as well as test cases</span>
    <span class="s3">// Using .react extension is not recommended.</span>
    <span class="s5">if </span><span class="s1">(!</span><span class="s2">require</span><span class="s1">.</span><span class="s2">extensions</span><span class="s1">[</span><span class="s0">'.react'</span><span class="s1">]) {</span>
      <span class="s2">require</span><span class="s1">.</span><span class="s2">extensions</span><span class="s1">[</span><span class="s0">'.react'</span><span class="s1">] = </span><span class="s2">requireReact</span><span class="s1">;</span>
    <span class="s1">}</span>

  <span class="s1">}</span>

  <span class="s3">// Return rendering fx</span>
  <span class="s5">return function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
      <span class="s3">// React Import</span>
      <span class="s5">var </span><span class="s2">ReactDOM </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">ReactDOM </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">ReactDOM </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'react-dom/server'</span><span class="s1">));</span>
      <span class="s5">var </span><span class="s2">react </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">react </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">react </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'react'</span><span class="s1">));</span>

      <span class="s3">// Assign HTML Base</span>
      <span class="s5">var </span><span class="s2">base </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">base</span><span class="s1">;</span>
      <span class="s5">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">base</span><span class="s1">;</span>

      <span class="s5">var </span><span class="s2">enableCache </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">cache</span><span class="s1">;</span>
      <span class="s5">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">cache</span><span class="s1">;</span>

      <span class="s5">var </span><span class="s2">isNonStatic </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">isNonStatic</span><span class="s1">;</span>
      <span class="s5">delete </span><span class="s2">options</span><span class="s1">.</span><span class="s2">isNonStatic</span><span class="s1">;</span>

      <span class="s3">// Start Conversion</span>
      <span class="s5">try </span><span class="s1">{</span>

        <span class="s5">var </span><span class="s2">Code</span><span class="s1">;</span>
        <span class="s5">var </span><span class="s2">Factory</span><span class="s1">;</span>

        <span class="s5">var </span><span class="s2">baseStr</span><span class="s1">;</span>
        <span class="s5">var </span><span class="s2">content</span><span class="s1">;</span>
        <span class="s5">var </span><span class="s2">parsed</span><span class="s1">;</span>

        <span class="s5">if </span><span class="s1">(!</span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">)) {</span>
          <span class="s3">// Parsing</span>
          <span class="s5">if </span><span class="s1">(</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">'path'</span><span class="s1">) {</span>
            <span class="s5">var </span><span class="s2">path </span><span class="s1">= </span><span class="s2">resolve</span><span class="s1">(</span><span class="s2">str</span><span class="s1">);</span>
            <span class="s5">delete </span><span class="s2">require</span><span class="s1">.</span><span class="s2">cache</span><span class="s1">[</span><span class="s2">path</span><span class="s1">];</span>
            <span class="s2">Code </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s2">path</span><span class="s1">);</span>
          <span class="s1">} </span><span class="s5">else </span><span class="s1">{</span>
            <span class="s2">Code </span><span class="s1">= </span><span class="s2">requireReactString</span><span class="s1">(</span><span class="s2">str</span><span class="s1">);</span>
          <span class="s1">}</span>
          <span class="s2">Factory </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">react</span><span class="s1">.</span><span class="s2">createFactory</span><span class="s1">(</span><span class="s2">Code</span><span class="s1">));</span>

        <span class="s1">} </span><span class="s5">else </span><span class="s1">{</span>
          <span class="s2">Factory </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s2">parsed </span><span class="s1">= </span><span class="s5">new </span><span class="s2">Factory</span><span class="s1">(</span><span class="s2">options</span><span class="s1">);</span>
        <span class="s2">content </span><span class="s1">= (</span><span class="s2">isNonStatic</span><span class="s1">) ? </span><span class="s2">ReactDOM</span><span class="s1">.</span><span class="s2">renderToString</span><span class="s1">(</span><span class="s2">parsed</span><span class="s1">) : </span><span class="s2">ReactDOM</span><span class="s1">.</span><span class="s2">renderToStaticMarkup</span><span class="s1">(</span><span class="s2">parsed</span><span class="s1">);</span>

        <span class="s5">if </span><span class="s1">(</span><span class="s2">base</span><span class="s1">) {</span>
          <span class="s2">baseStr </span><span class="s1">= </span><span class="s2">readCache</span><span class="s1">[</span><span class="s2">str</span><span class="s1">] || </span><span class="s2">fs</span><span class="s1">.</span><span class="s2">readFileSync</span><span class="s1">(</span><span class="s2">resolve</span><span class="s1">(</span><span class="s2">base</span><span class="s1">), </span><span class="s0">'utf8'</span><span class="s1">);</span>

          <span class="s5">if </span><span class="s1">(</span><span class="s2">enableCache</span><span class="s1">) {</span>
            <span class="s2">readCache</span><span class="s1">[</span><span class="s2">str</span><span class="s1">] = </span><span class="s2">baseStr</span><span class="s1">;</span>
          <span class="s1">}</span>

          <span class="s2">options</span><span class="s1">.</span><span class="s2">content </span><span class="s1">= </span><span class="s2">content</span><span class="s1">;</span>
          <span class="s2">content </span><span class="s1">= </span><span class="s2">reactBaseTmpl</span><span class="s1">(</span><span class="s2">baseStr</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">content</span><span class="s1">);</span>

      <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
        <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">});</span>
  <span class="s1">};</span>
<span class="s1">}</span>

<span class="s4">/**</span>
 <span class="s4">* React JS Support</span>
 <span class="s4">*/</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">react </span><span class="s1">= </span><span class="s2">reactRenderer</span><span class="s1">(</span><span class="s0">'path'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* React JS string support.</span>
 <span class="s4">*/</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">react</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s2">reactRenderer</span><span class="s1">(</span><span class="s0">'string'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* ARC-templates support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">[</span><span class="s0">'arc-templates'</span><span class="s1">] = </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'arc-templates'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* ARC-templates string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">[</span><span class="s0">'arc-templates'</span><span class="s1">].</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">var </span><span class="s2">readFileWithOptions </span><span class="s1">= </span><span class="s2">Promise</span><span class="s1">.</span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">read</span><span class="s1">);</span>
  <span class="s5">var </span><span class="s2">consolidateFileSystem </span><span class="s1">= {};</span>
  <span class="s2">consolidateFileSystem</span><span class="s1">.</span><span class="s2">readFile </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">path</span><span class="s1">) {</span>
    <span class="s5">return </span><span class="s2">readFileWithOptions</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">);</span>
  <span class="s1">};</span>

  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">[</span><span class="s0">'arc-templates'</span><span class="s1">];</span>
      <span class="s5">if </span><span class="s1">(!</span><span class="s2">engine</span><span class="s1">) {</span>
        <span class="s5">var </span><span class="s2">Engine </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'arc-templates/dist/es5'</span><span class="s1">);</span>
        <span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">[</span><span class="s0">'arc-templates'</span><span class="s1">] = </span><span class="s5">new </span><span class="s2">Engine</span><span class="s1">({ </span><span class="s2">filesystem</span><span class="s1">: </span><span class="s2">consolidateFileSystem </span><span class="s1">});</span>
      <span class="s1">}</span>

      <span class="s5">var </span><span class="s2">compiler </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">compileString</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">.</span><span class="s2">filename</span><span class="s1">));</span>
      <span class="s2">compiler</span><span class="s1">.</span><span class="s2">then</span><span class="s1">(</span><span class="s5">function</span><span class="s1">(</span><span class="s2">func</span><span class="s1">) { </span><span class="s5">return </span><span class="s2">func</span><span class="s1">(</span><span class="s2">options</span><span class="s1">); })</span>
        <span class="s1">.</span><span class="s2">then</span><span class="s1">(</span><span class="s5">function</span><span class="s1">(</span><span class="s2">result</span><span class="s1">) { </span><span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">result</span><span class="s1">.</span><span class="s2">content</span><span class="s1">); })</span>
        <span class="s1">.</span><span class="s2">catch</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Vash support</span>
 <span class="s4">*/</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">vash </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'vash'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* Vash string support</span>
 <span class="s4">*/</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">vash</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">vash </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">vash </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'vash'</span><span class="s1">));</span>

    <span class="s5">try </span><span class="s1">{</span>
      <span class="s3">// helper system : https://github.com/kirbysayshi/vash#helper-system</span>
      <span class="s5">if </span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">helpers</span><span class="s1">) {</span>
        <span class="s5">for </span><span class="s1">(</span><span class="s5">var </span><span class="s2">key </span><span class="s5">in </span><span class="s2">options</span><span class="s1">.</span><span class="s2">helpers</span><span class="s1">) {</span>
          <span class="s5">if </span><span class="s1">(!</span><span class="s2">options</span><span class="s1">.</span><span class="s2">helpers</span><span class="s1">.</span><span class="s2">hasOwnProperty</span><span class="s1">(</span><span class="s2">key</span><span class="s1">) || </span><span class="s5">typeof </span><span class="s2">options</span><span class="s1">.</span><span class="s2">helpers</span><span class="s1">[</span><span class="s2">key</span><span class="s1">] !== </span><span class="s0">'function'</span><span class="s1">) {</span>
            <span class="s5">continue</span><span class="s1">;</span>
          <span class="s1">}</span>
          <span class="s2">engine</span><span class="s1">.</span><span class="s2">helpers</span><span class="s1">[</span><span class="s2">key</span><span class="s1">] = </span><span class="s2">options</span><span class="s1">.</span><span class="s2">helpers</span><span class="s1">[</span><span class="s2">key</span><span class="s1">];</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">compile</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">));</span>
      <span class="s2">tmpl</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s5">function </span><span class="s2">sealLayout</span><span class="s1">(</span><span class="s2">err</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">) {</span>
        <span class="s5">if </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) </span><span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
        <span class="s2">ctx</span><span class="s1">.</span><span class="s2">finishLayout</span><span class="s1">();</span>
        <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">ctx</span><span class="s1">.</span><span class="s2">toString</span><span class="s1">().</span><span class="s2">replace</span><span class="s1">(</span><span class="s7">/\n$/</span><span class="s1">, </span><span class="s0">''</span><span class="s1">));</span>
      <span class="s1">});</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Slm support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">slm </span><span class="s1">= </span><span class="s2">fromStringRenderer</span><span class="s1">(</span><span class="s0">'slm'</span><span class="s1">);</span>

<span class="s4">/**</span>
 <span class="s4">* Slm string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">slm</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">slm </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">slm </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'slm'</span><span class="s1">));</span>

    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">compile</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">));</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">tmpl</span><span class="s1">(</span><span class="s2">options</span><span class="s1">));</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Marko support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">marko </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">marko </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">marko </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'marko'</span><span class="s1">));</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">writeToDisk </span><span class="s1">= !!</span><span class="s2">options</span><span class="s1">.</span><span class="s2">cache</span><span class="s1">;</span>

    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">load</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">));</span>
      <span class="s2">tmpl</span><span class="s1">.</span><span class="s2">renderToString</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Marko string support.</span>
 <span class="s4">*/</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">marko</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">marko </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">marko </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'marko'</span><span class="s1">));</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">writeToDisk </span><span class="s1">= !!</span><span class="s2">options</span><span class="s1">.</span><span class="s2">cache</span><span class="s1">;</span>
    <span class="s2">options</span><span class="s1">.</span><span class="s2">filename </span><span class="s1">= </span><span class="s2">options</span><span class="s1">.</span><span class="s2">filename </span><span class="s1">|| </span><span class="s0">'string.marko'</span><span class="s1">;</span>

    <span class="s5">try </span><span class="s1">{</span>
      <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">) || </span><span class="s2">cache</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">engine</span><span class="s1">.</span><span class="s2">load</span><span class="s1">(</span><span class="s2">options</span><span class="s1">.</span><span class="s2">filename</span><span class="s1">, </span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">));</span>
      <span class="s2">tmpl</span><span class="s1">.</span><span class="s2">renderToString</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s5">catch </span><span class="s1">(</span><span class="s2">err</span><span class="s1">) {</span>
      <span class="s2">cb</span><span class="s1">(</span><span class="s2">err</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Teacup support.</span>
 <span class="s4">*/</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">teacup </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s5">var </span><span class="s2">engine </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">.</span><span class="s2">teacup </span><span class="s1">|| (</span><span class="s2">requires</span><span class="s1">.</span><span class="s2">teacup </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'teacup/lib/express'</span><span class="s1">));</span>
    <span class="s2">require</span><span class="s1">.</span><span class="s2">extensions</span><span class="s1">[</span><span class="s0">'.teacup'</span><span class="s1">] = </span><span class="s2">require</span><span class="s1">.</span><span class="s2">extensions</span><span class="s1">[</span><span class="s0">'.coffee'</span><span class="s1">];</span>
    <span class="s5">if </span><span class="s1">(</span><span class="s2">path</span><span class="s1">[</span><span class="s8">0</span><span class="s1">] !== </span><span class="s0">'/'</span><span class="s1">) {</span>
      <span class="s2">path </span><span class="s1">= </span><span class="s2">join</span><span class="s1">(</span><span class="s2">process</span><span class="s1">.</span><span class="s2">cwd</span><span class="s1">(), </span><span class="s2">path</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s5">if </span><span class="s1">(!</span><span class="s2">options</span><span class="s1">.</span><span class="s2">cache</span><span class="s1">) {</span>
      <span class="s5">var </span><span class="s2">callback </span><span class="s1">= </span><span class="s2">cb</span><span class="s1">;</span>
      <span class="s2">cb </span><span class="s1">= </span><span class="s5">function</span><span class="s1">() {</span>
        <span class="s5">delete </span><span class="s2">require</span><span class="s1">.</span><span class="s2">cache</span><span class="s1">[</span><span class="s2">path</span><span class="s1">];</span>
        <span class="s2">callback</span><span class="s1">.</span><span class="s2">apply</span><span class="s1">(</span><span class="s5">this</span><span class="s1">, </span><span class="s2">arguments</span><span class="s1">);</span>
      <span class="s1">};</span>
    <span class="s1">}</span>
    <span class="s2">engine</span><span class="s1">.</span><span class="s2">renderFile</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">);</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* Teacup string support.</span>
 <span class="s4">*/</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">teacup</span><span class="s1">.</span><span class="s2">render </span><span class="s1">= </span><span class="s5">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">, </span><span class="s2">options</span><span class="s1">, </span><span class="s2">cb</span><span class="s1">) {</span>
  <span class="s5">var </span><span class="s2">coffee </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'coffee-script'</span><span class="s1">);</span>
  <span class="s5">var </span><span class="s2">vm </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'vm'</span><span class="s1">);</span>
  <span class="s5">var </span><span class="s2">sandbox </span><span class="s1">= {</span>
    <span class="s2">module</span><span class="s1">: {</span><span class="s2">exports</span><span class="s1">: {}},</span>
    <span class="s2">require</span><span class="s1">: </span><span class="s2">require</span>
  <span class="s1">};</span>
  <span class="s5">return </span><span class="s2">promisify</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">, </span><span class="s5">function</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) {</span>
    <span class="s2">vm</span><span class="s1">.</span><span class="s2">runInNewContext</span><span class="s1">(</span><span class="s2">coffee</span><span class="s1">.</span><span class="s2">compile</span><span class="s1">(</span><span class="s2">str</span><span class="s1">), </span><span class="s2">sandbox</span><span class="s1">);</span>
    <span class="s5">var </span><span class="s2">tmpl </span><span class="s1">= </span><span class="s2">sandbox</span><span class="s1">.</span><span class="s2">module</span><span class="s1">.</span><span class="s2">exports</span><span class="s1">;</span>
    <span class="s2">cb</span><span class="s1">(</span><span class="s5">null</span><span class="s1">, </span><span class="s2">tmpl</span><span class="s1">(</span><span class="s2">options</span><span class="s1">));</span>
  <span class="s1">});</span>
<span class="s1">};</span>

<span class="s4">/**</span>
 <span class="s4">* expose the instance of the engine</span>
 <span class="s4">*/</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">requires </span><span class="s1">= </span><span class="s2">requires</span><span class="s1">;</span>
</pre>
</body>
</html>