<html>
<head>
<title>utf7.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #6aab73;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #cf8e6d;}
.s4 { color: #7a7e85;}
.s5 { color: #42c3d4;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
utf7.js</font>
</center></td></tr></table>
<pre><span class="s0">&quot;use strict&quot;</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">Buffer </span><span class="s1">= </span><span class="s2">require</span><span class="s1">(</span><span class="s0">&quot;safer-buffer&quot;</span><span class="s1">).</span><span class="s2">Buffer</span><span class="s1">;</span>

<span class="s4">// UTF-7 codec, according to https://tools.ietf.org/html/rfc2152</span>
<span class="s4">// See also below a UTF-7-IMAP codec, according to http://tools.ietf.org/html/rfc3501#section-5.1.3</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">utf7 </span><span class="s1">= </span><span class="s2">Utf7Codec</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">unicode11utf7 </span><span class="s1">= </span><span class="s0">'utf7'</span><span class="s1">; </span><span class="s4">// Alias UNICODE-1-1-UTF-7</span>
<span class="s3">function </span><span class="s2">Utf7Codec</span><span class="s1">(</span><span class="s2">codecOptions</span><span class="s1">, </span><span class="s2">iconv</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">iconv </span><span class="s1">= </span><span class="s2">iconv</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s2">Utf7Codec</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">encoder </span><span class="s1">= </span><span class="s2">Utf7Encoder</span><span class="s1">;</span>
<span class="s2">Utf7Codec</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">decoder </span><span class="s1">= </span><span class="s2">Utf7Decoder</span><span class="s1">;</span>
<span class="s2">Utf7Codec</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">bomAware </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>


<span class="s4">// -- Encoding</span>

<span class="s3">var </span><span class="s2">nonDirectChars </span><span class="s1">= </span><span class="s5">/[^A-Za-z0-9'\(\),-\.\/:\? \n\r\t]+/g</span><span class="s1">;</span>

<span class="s3">function </span><span class="s2">Utf7Encoder</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">codec</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">iconv </span><span class="s1">= </span><span class="s2">codec</span><span class="s1">.</span><span class="s2">iconv</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">Utf7Encoder</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">write </span><span class="s1">= </span><span class="s3">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">) {</span>
    <span class="s4">// Naive implementation.</span>
    <span class="s4">// Non-direct chars are encoded as &quot;+&lt;base64&gt;-&quot;; single &quot;+&quot; char is encoded as &quot;+-&quot;.</span>
    <span class="s3">return </span><span class="s2">Buffer</span><span class="s1">.</span><span class="s2">from</span><span class="s1">(</span><span class="s2">str</span><span class="s1">.</span><span class="s2">replace</span><span class="s1">(</span><span class="s2">nonDirectChars</span><span class="s1">, </span><span class="s3">function</span><span class="s1">(</span><span class="s2">chunk</span><span class="s1">) {</span>
        <span class="s3">return </span><span class="s0">&quot;+&quot; </span><span class="s1">+ (</span><span class="s2">chunk </span><span class="s1">=== </span><span class="s0">'+' </span><span class="s1">? </span><span class="s0">'' </span><span class="s1">: </span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">iconv</span><span class="s1">.</span><span class="s2">encode</span><span class="s1">(</span><span class="s2">chunk</span><span class="s1">, </span><span class="s0">'utf16-be'</span><span class="s1">).</span><span class="s2">toString</span><span class="s1">(</span><span class="s0">'base64'</span><span class="s1">).</span><span class="s2">replace</span><span class="s1">(</span><span class="s5">/=+$/</span><span class="s1">, </span><span class="s0">''</span><span class="s1">)) </span>
            <span class="s1">+ </span><span class="s0">&quot;-&quot;</span><span class="s1">;</span>
    <span class="s1">}.</span><span class="s2">bind</span><span class="s1">(</span><span class="s3">this</span><span class="s1">)));</span>
<span class="s1">}</span>

<span class="s2">Utf7Encoder</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">end </span><span class="s1">= </span><span class="s3">function</span><span class="s1">() {</span>
<span class="s1">}</span>


<span class="s4">// -- Decoding</span>

<span class="s3">function </span><span class="s2">Utf7Decoder</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">codec</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">iconv </span><span class="s1">= </span><span class="s2">codec</span><span class="s1">.</span><span class="s2">iconv</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">inBase64 </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">base64Accum </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">var </span><span class="s2">base64Regex </span><span class="s1">= </span><span class="s5">/[A-Za-z0-9\/+]/</span><span class="s1">;</span>
<span class="s3">var </span><span class="s2">base64Chars </span><span class="s1">= [];</span>
<span class="s3">for </span><span class="s1">(</span><span class="s3">var </span><span class="s2">i </span><span class="s1">= </span><span class="s6">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s6">256</span><span class="s1">; </span><span class="s2">i</span><span class="s1">++)</span>
    <span class="s2">base64Chars</span><span class="s1">[</span><span class="s2">i</span><span class="s1">] = </span><span class="s2">base64Regex</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">String</span><span class="s1">.</span><span class="s2">fromCharCode</span><span class="s1">(</span><span class="s2">i</span><span class="s1">));</span>

<span class="s3">var </span><span class="s2">plusChar </span><span class="s1">= </span><span class="s0">'+'</span><span class="s1">.</span><span class="s2">charCodeAt</span><span class="s1">(</span><span class="s6">0</span><span class="s1">), </span>
    <span class="s2">minusChar </span><span class="s1">= </span><span class="s0">'-'</span><span class="s1">.</span><span class="s2">charCodeAt</span><span class="s1">(</span><span class="s6">0</span><span class="s1">),</span>
    <span class="s2">andChar </span><span class="s1">= </span><span class="s0">'&amp;'</span><span class="s1">.</span><span class="s2">charCodeAt</span><span class="s1">(</span><span class="s6">0</span><span class="s1">);</span>

<span class="s2">Utf7Decoder</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">write </span><span class="s1">= </span><span class="s3">function</span><span class="s1">(</span><span class="s2">buf</span><span class="s1">) {</span>
    <span class="s3">var </span><span class="s2">res </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">, </span><span class="s2">lastI </span><span class="s1">= </span><span class="s6">0</span><span class="s1">,</span>
        <span class="s2">inBase64 </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">inBase64</span><span class="s1">,</span>
        <span class="s2">base64Accum </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">base64Accum</span><span class="s1">;</span>

    <span class="s4">// The decoder is more involved as we must handle chunks in stream.</span>

    <span class="s3">for </span><span class="s1">(</span><span class="s3">var </span><span class="s2">i </span><span class="s1">= </span><span class="s6">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">buf</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">i</span><span class="s1">++) {</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">inBase64</span><span class="s1">) { </span><span class="s4">// We're in direct mode.</span>
            <span class="s4">// Write direct chars until '+'</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">buf</span><span class="s1">[</span><span class="s2">i</span><span class="s1">] == </span><span class="s2">plusChar</span><span class="s1">) {</span>
                <span class="s2">res </span><span class="s1">+= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">iconv</span><span class="s1">.</span><span class="s2">decode</span><span class="s1">(</span><span class="s2">buf</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">lastI</span><span class="s1">, </span><span class="s2">i</span><span class="s1">), </span><span class="s0">&quot;ascii&quot;</span><span class="s1">); </span><span class="s4">// Write direct chars.</span>
                <span class="s2">lastI </span><span class="s1">= </span><span class="s2">i</span><span class="s1">+</span><span class="s6">1</span><span class="s1">;</span>
                <span class="s2">inBase64 </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">} </span><span class="s3">else </span><span class="s1">{ </span><span class="s4">// We decode base64.</span>
            <span class="s3">if </span><span class="s1">(!</span><span class="s2">base64Chars</span><span class="s1">[</span><span class="s2">buf</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]]) { </span><span class="s4">// Base64 ended.</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">i </span><span class="s1">== </span><span class="s2">lastI </span><span class="s1">&amp;&amp; </span><span class="s2">buf</span><span class="s1">[</span><span class="s2">i</span><span class="s1">] == </span><span class="s2">minusChar</span><span class="s1">) {</span><span class="s4">// &quot;+-&quot; -&gt; &quot;+&quot;</span>
                    <span class="s2">res </span><span class="s1">+= </span><span class="s0">&quot;+&quot;</span><span class="s1">;</span>
                <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
                    <span class="s3">var </span><span class="s2">b64str </span><span class="s1">= </span><span class="s2">base64Accum </span><span class="s1">+ </span><span class="s2">buf</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">lastI</span><span class="s1">, </span><span class="s2">i</span><span class="s1">).</span><span class="s2">toString</span><span class="s1">();</span>
                    <span class="s2">res </span><span class="s1">+= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">iconv</span><span class="s1">.</span><span class="s2">decode</span><span class="s1">(</span><span class="s2">Buffer</span><span class="s1">.</span><span class="s2">from</span><span class="s1">(</span><span class="s2">b64str</span><span class="s1">, </span><span class="s0">'base64'</span><span class="s1">), </span><span class="s0">&quot;utf16-be&quot;</span><span class="s1">);</span>
                <span class="s1">}</span>

                <span class="s3">if </span><span class="s1">(</span><span class="s2">buf</span><span class="s1">[</span><span class="s2">i</span><span class="s1">] != </span><span class="s2">minusChar</span><span class="s1">) </span><span class="s4">// Minus is absorbed after base64.</span>
                    <span class="s2">i</span><span class="s1">--;</span>

                <span class="s2">lastI </span><span class="s1">= </span><span class="s2">i</span><span class="s1">+</span><span class="s6">1</span><span class="s1">;</span>
                <span class="s2">inBase64 </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
                <span class="s2">base64Accum </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(!</span><span class="s2">inBase64</span><span class="s1">) {</span>
        <span class="s2">res </span><span class="s1">+= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">iconv</span><span class="s1">.</span><span class="s2">decode</span><span class="s1">(</span><span class="s2">buf</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">lastI</span><span class="s1">), </span><span class="s0">&quot;ascii&quot;</span><span class="s1">); </span><span class="s4">// Write direct chars.</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s3">var </span><span class="s2">b64str </span><span class="s1">= </span><span class="s2">base64Accum </span><span class="s1">+ </span><span class="s2">buf</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">lastI</span><span class="s1">).</span><span class="s2">toString</span><span class="s1">();</span>

        <span class="s3">var </span><span class="s2">canBeDecoded </span><span class="s1">= </span><span class="s2">b64str</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- (</span><span class="s2">b64str</span><span class="s1">.</span><span class="s2">length </span><span class="s1">% </span><span class="s6">8</span><span class="s1">); </span><span class="s4">// Minimal chunk: 2 quads -&gt; 2x3 bytes -&gt; 3 chars.</span>
        <span class="s2">base64Accum </span><span class="s1">= </span><span class="s2">b64str</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">canBeDecoded</span><span class="s1">); </span><span class="s4">// The rest will be decoded in future.</span>
        <span class="s2">b64str </span><span class="s1">= </span><span class="s2">b64str</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s6">0</span><span class="s1">, </span><span class="s2">canBeDecoded</span><span class="s1">);</span>

        <span class="s2">res </span><span class="s1">+= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">iconv</span><span class="s1">.</span><span class="s2">decode</span><span class="s1">(</span><span class="s2">Buffer</span><span class="s1">.</span><span class="s2">from</span><span class="s1">(</span><span class="s2">b64str</span><span class="s1">, </span><span class="s0">'base64'</span><span class="s1">), </span><span class="s0">&quot;utf16-be&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">inBase64 </span><span class="s1">= </span><span class="s2">inBase64</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">base64Accum </span><span class="s1">= </span><span class="s2">base64Accum</span><span class="s1">;</span>

    <span class="s3">return </span><span class="s2">res</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">Utf7Decoder</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">end </span><span class="s1">= </span><span class="s3">function</span><span class="s1">() {</span>
    <span class="s3">var </span><span class="s2">res </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">inBase64 </span><span class="s1">&amp;&amp; </span><span class="s3">this</span><span class="s1">.</span><span class="s2">base64Accum</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s6">0</span><span class="s1">)</span>
        <span class="s2">res </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">iconv</span><span class="s1">.</span><span class="s2">decode</span><span class="s1">(</span><span class="s2">Buffer</span><span class="s1">.</span><span class="s2">from</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">base64Accum</span><span class="s1">, </span><span class="s0">'base64'</span><span class="s1">), </span><span class="s0">&quot;utf16-be&quot;</span><span class="s1">);</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">inBase64 </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">base64Accum </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
    <span class="s3">return </span><span class="s2">res</span><span class="s1">;</span>
<span class="s1">}</span>


<span class="s4">// UTF-7-IMAP codec.</span>
<span class="s4">// RFC3501 Sec. 5.1.3 Modified UTF-7 (http://tools.ietf.org/html/rfc3501#section-5.1.3)</span>
<span class="s4">// Differences:</span>
<span class="s4">//  * Base64 part is started by &quot;&amp;&quot; instead of &quot;+&quot;</span>
<span class="s4">//  * Direct characters are 0x20-0x7E, except &quot;&amp;&quot; (0x26)</span>
<span class="s4">//  * In Base64, &quot;,&quot; is used instead of &quot;/&quot;</span>
<span class="s4">//  * Base64 must not be used to represent direct characters.</span>
<span class="s4">//  * No implicit shift back from Base64 (should always end with '-')</span>
<span class="s4">//  * String must end in non-shifted position.</span>
<span class="s4">//  * &quot;-&amp;&quot; while in base64 is not allowed.</span>


<span class="s2">exports</span><span class="s1">.</span><span class="s2">utf7imap </span><span class="s1">= </span><span class="s2">Utf7IMAPCodec</span><span class="s1">;</span>
<span class="s3">function </span><span class="s2">Utf7IMAPCodec</span><span class="s1">(</span><span class="s2">codecOptions</span><span class="s1">, </span><span class="s2">iconv</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">iconv </span><span class="s1">= </span><span class="s2">iconv</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s2">Utf7IMAPCodec</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">encoder </span><span class="s1">= </span><span class="s2">Utf7IMAPEncoder</span><span class="s1">;</span>
<span class="s2">Utf7IMAPCodec</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">decoder </span><span class="s1">= </span><span class="s2">Utf7IMAPDecoder</span><span class="s1">;</span>
<span class="s2">Utf7IMAPCodec</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">bomAware </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>


<span class="s4">// -- Encoding</span>

<span class="s3">function </span><span class="s2">Utf7IMAPEncoder</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">codec</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">iconv </span><span class="s1">= </span><span class="s2">codec</span><span class="s1">.</span><span class="s2">iconv</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">inBase64 </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">base64Accum </span><span class="s1">= </span><span class="s2">Buffer</span><span class="s1">.</span><span class="s2">alloc</span><span class="s1">(</span><span class="s6">6</span><span class="s1">);</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">base64AccumIdx </span><span class="s1">= </span><span class="s6">0</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">Utf7IMAPEncoder</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">write </span><span class="s1">= </span><span class="s3">function</span><span class="s1">(</span><span class="s2">str</span><span class="s1">) {</span>
    <span class="s3">var </span><span class="s2">inBase64 </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">inBase64</span><span class="s1">,</span>
        <span class="s2">base64Accum </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">base64Accum</span><span class="s1">,</span>
        <span class="s2">base64AccumIdx </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">base64AccumIdx</span><span class="s1">,</span>
        <span class="s2">buf </span><span class="s1">= </span><span class="s2">Buffer</span><span class="s1">.</span><span class="s2">alloc</span><span class="s1">(</span><span class="s2">str</span><span class="s1">.</span><span class="s2">length</span><span class="s1">*</span><span class="s6">5 </span><span class="s1">+ </span><span class="s6">10</span><span class="s1">), </span><span class="s2">bufIdx </span><span class="s1">= </span><span class="s6">0</span><span class="s1">;</span>

    <span class="s3">for </span><span class="s1">(</span><span class="s3">var </span><span class="s2">i </span><span class="s1">= </span><span class="s6">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">str</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">i</span><span class="s1">++) {</span>
        <span class="s3">var </span><span class="s2">uChar </span><span class="s1">= </span><span class="s2">str</span><span class="s1">.</span><span class="s2">charCodeAt</span><span class="s1">(</span><span class="s2">i</span><span class="s1">);</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s6">0x20 </span><span class="s1">&lt;= </span><span class="s2">uChar </span><span class="s1">&amp;&amp; </span><span class="s2">uChar </span><span class="s1">&lt;= </span><span class="s6">0x7E</span><span class="s1">) { </span><span class="s4">// Direct character or '&amp;'.</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">inBase64</span><span class="s1">) {</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">base64AccumIdx </span><span class="s1">&gt; </span><span class="s6">0</span><span class="s1">) {</span>
                    <span class="s2">bufIdx </span><span class="s1">+= </span><span class="s2">buf</span><span class="s1">.</span><span class="s2">write</span><span class="s1">(</span><span class="s2">base64Accum</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s6">0</span><span class="s1">, </span><span class="s2">base64AccumIdx</span><span class="s1">).</span><span class="s2">toString</span><span class="s1">(</span><span class="s0">'base64'</span><span class="s1">).</span><span class="s2">replace</span><span class="s1">(</span><span class="s5">/\//g</span><span class="s1">, </span><span class="s0">','</span><span class="s1">).</span><span class="s2">replace</span><span class="s1">(</span><span class="s5">/=+$/</span><span class="s1">, </span><span class="s0">''</span><span class="s1">), </span><span class="s2">bufIdx</span><span class="s1">);</span>
                    <span class="s2">base64AccumIdx </span><span class="s1">= </span><span class="s6">0</span><span class="s1">;</span>
                <span class="s1">}</span>

                <span class="s2">buf</span><span class="s1">[</span><span class="s2">bufIdx</span><span class="s1">++] = </span><span class="s2">minusChar</span><span class="s1">; </span><span class="s4">// Write '-', then go to direct mode.</span>
                <span class="s2">inBase64 </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
            <span class="s1">}</span>

            <span class="s3">if </span><span class="s1">(!</span><span class="s2">inBase64</span><span class="s1">) {</span>
                <span class="s2">buf</span><span class="s1">[</span><span class="s2">bufIdx</span><span class="s1">++] = </span><span class="s2">uChar</span><span class="s1">; </span><span class="s4">// Write direct character</span>

                <span class="s3">if </span><span class="s1">(</span><span class="s2">uChar </span><span class="s1">=== </span><span class="s2">andChar</span><span class="s1">)  </span><span class="s4">// Ampersand -&gt; '&amp;-'</span>
                    <span class="s2">buf</span><span class="s1">[</span><span class="s2">bufIdx</span><span class="s1">++] = </span><span class="s2">minusChar</span><span class="s1">;</span>
            <span class="s1">}</span>

        <span class="s1">} </span><span class="s3">else </span><span class="s1">{ </span><span class="s4">// Non-direct character</span>
            <span class="s3">if </span><span class="s1">(!</span><span class="s2">inBase64</span><span class="s1">) {</span>
                <span class="s2">buf</span><span class="s1">[</span><span class="s2">bufIdx</span><span class="s1">++] = </span><span class="s2">andChar</span><span class="s1">; </span><span class="s4">// Write '&amp;', then go to base64 mode.</span>
                <span class="s2">inBase64 </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">inBase64</span><span class="s1">) {</span>
                <span class="s2">base64Accum</span><span class="s1">[</span><span class="s2">base64AccumIdx</span><span class="s1">++] = </span><span class="s2">uChar </span><span class="s1">&gt;&gt; </span><span class="s6">8</span><span class="s1">;</span>
                <span class="s2">base64Accum</span><span class="s1">[</span><span class="s2">base64AccumIdx</span><span class="s1">++] = </span><span class="s2">uChar </span><span class="s1">&amp; </span><span class="s6">0xFF</span><span class="s1">;</span>

                <span class="s3">if </span><span class="s1">(</span><span class="s2">base64AccumIdx </span><span class="s1">== </span><span class="s2">base64Accum</span><span class="s1">.</span><span class="s2">length</span><span class="s1">) {</span>
                    <span class="s2">bufIdx </span><span class="s1">+= </span><span class="s2">buf</span><span class="s1">.</span><span class="s2">write</span><span class="s1">(</span><span class="s2">base64Accum</span><span class="s1">.</span><span class="s2">toString</span><span class="s1">(</span><span class="s0">'base64'</span><span class="s1">).</span><span class="s2">replace</span><span class="s1">(</span><span class="s5">/\//g</span><span class="s1">, </span><span class="s0">','</span><span class="s1">), </span><span class="s2">bufIdx</span><span class="s1">);</span>
                    <span class="s2">base64AccumIdx </span><span class="s1">= </span><span class="s6">0</span><span class="s1">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">inBase64 </span><span class="s1">= </span><span class="s2">inBase64</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">base64AccumIdx </span><span class="s1">= </span><span class="s2">base64AccumIdx</span><span class="s1">;</span>

    <span class="s3">return </span><span class="s2">buf</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s6">0</span><span class="s1">, </span><span class="s2">bufIdx</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s2">Utf7IMAPEncoder</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">end </span><span class="s1">= </span><span class="s3">function</span><span class="s1">() {</span>
    <span class="s3">var </span><span class="s2">buf </span><span class="s1">= </span><span class="s2">Buffer</span><span class="s1">.</span><span class="s2">alloc</span><span class="s1">(</span><span class="s6">10</span><span class="s1">), </span><span class="s2">bufIdx </span><span class="s1">= </span><span class="s6">0</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">inBase64</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">base64AccumIdx </span><span class="s1">&gt; </span><span class="s6">0</span><span class="s1">) {</span>
            <span class="s2">bufIdx </span><span class="s1">+= </span><span class="s2">buf</span><span class="s1">.</span><span class="s2">write</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">base64Accum</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s6">0</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s2">base64AccumIdx</span><span class="s1">).</span><span class="s2">toString</span><span class="s1">(</span><span class="s0">'base64'</span><span class="s1">).</span><span class="s2">replace</span><span class="s1">(</span><span class="s5">/\//g</span><span class="s1">, </span><span class="s0">','</span><span class="s1">).</span><span class="s2">replace</span><span class="s1">(</span><span class="s5">/=+$/</span><span class="s1">, </span><span class="s0">''</span><span class="s1">), </span><span class="s2">bufIdx</span><span class="s1">);</span>
            <span class="s3">this</span><span class="s1">.</span><span class="s2">base64AccumIdx </span><span class="s1">= </span><span class="s6">0</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s2">buf</span><span class="s1">[</span><span class="s2">bufIdx</span><span class="s1">++] = </span><span class="s2">minusChar</span><span class="s1">; </span><span class="s4">// Write '-', then go to direct mode.</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s2">inBase64 </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s2">buf</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s6">0</span><span class="s1">, </span><span class="s2">bufIdx</span><span class="s1">);</span>
<span class="s1">}</span>


<span class="s4">// -- Decoding</span>

<span class="s3">function </span><span class="s2">Utf7IMAPDecoder</span><span class="s1">(</span><span class="s2">options</span><span class="s1">, </span><span class="s2">codec</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">iconv </span><span class="s1">= </span><span class="s2">codec</span><span class="s1">.</span><span class="s2">iconv</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">inBase64 </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">base64Accum </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">var </span><span class="s2">base64IMAPChars </span><span class="s1">= </span><span class="s2">base64Chars</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">();</span>
<span class="s2">base64IMAPChars</span><span class="s1">[</span><span class="s0">','</span><span class="s1">.</span><span class="s2">charCodeAt</span><span class="s1">(</span><span class="s6">0</span><span class="s1">)] = </span><span class="s3">true</span><span class="s1">;</span>

<span class="s2">Utf7IMAPDecoder</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">write </span><span class="s1">= </span><span class="s3">function</span><span class="s1">(</span><span class="s2">buf</span><span class="s1">) {</span>
    <span class="s3">var </span><span class="s2">res </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">, </span><span class="s2">lastI </span><span class="s1">= </span><span class="s6">0</span><span class="s1">,</span>
        <span class="s2">inBase64 </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">inBase64</span><span class="s1">,</span>
        <span class="s2">base64Accum </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">base64Accum</span><span class="s1">;</span>

    <span class="s4">// The decoder is more involved as we must handle chunks in stream.</span>
    <span class="s4">// It is forgiving, closer to standard UTF-7 (for example, '-' is optional at the end).</span>

    <span class="s3">for </span><span class="s1">(</span><span class="s3">var </span><span class="s2">i </span><span class="s1">= </span><span class="s6">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">buf</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">i</span><span class="s1">++) {</span>
        <span class="s3">if </span><span class="s1">(!</span><span class="s2">inBase64</span><span class="s1">) { </span><span class="s4">// We're in direct mode.</span>
            <span class="s4">// Write direct chars until '&amp;'</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">buf</span><span class="s1">[</span><span class="s2">i</span><span class="s1">] == </span><span class="s2">andChar</span><span class="s1">) {</span>
                <span class="s2">res </span><span class="s1">+= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">iconv</span><span class="s1">.</span><span class="s2">decode</span><span class="s1">(</span><span class="s2">buf</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">lastI</span><span class="s1">, </span><span class="s2">i</span><span class="s1">), </span><span class="s0">&quot;ascii&quot;</span><span class="s1">); </span><span class="s4">// Write direct chars.</span>
                <span class="s2">lastI </span><span class="s1">= </span><span class="s2">i</span><span class="s1">+</span><span class="s6">1</span><span class="s1">;</span>
                <span class="s2">inBase64 </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">} </span><span class="s3">else </span><span class="s1">{ </span><span class="s4">// We decode base64.</span>
            <span class="s3">if </span><span class="s1">(!</span><span class="s2">base64IMAPChars</span><span class="s1">[</span><span class="s2">buf</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]]) { </span><span class="s4">// Base64 ended.</span>
                <span class="s3">if </span><span class="s1">(</span><span class="s2">i </span><span class="s1">== </span><span class="s2">lastI </span><span class="s1">&amp;&amp; </span><span class="s2">buf</span><span class="s1">[</span><span class="s2">i</span><span class="s1">] == </span><span class="s2">minusChar</span><span class="s1">) { </span><span class="s4">// &quot;&amp;-&quot; -&gt; &quot;&amp;&quot;</span>
                    <span class="s2">res </span><span class="s1">+= </span><span class="s0">&quot;&amp;&quot;</span><span class="s1">;</span>
                <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
                    <span class="s3">var </span><span class="s2">b64str </span><span class="s1">= </span><span class="s2">base64Accum </span><span class="s1">+ </span><span class="s2">buf</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">lastI</span><span class="s1">, </span><span class="s2">i</span><span class="s1">).</span><span class="s2">toString</span><span class="s1">().</span><span class="s2">replace</span><span class="s1">(</span><span class="s5">/,/g</span><span class="s1">, </span><span class="s0">'/'</span><span class="s1">);</span>
                    <span class="s2">res </span><span class="s1">+= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">iconv</span><span class="s1">.</span><span class="s2">decode</span><span class="s1">(</span><span class="s2">Buffer</span><span class="s1">.</span><span class="s2">from</span><span class="s1">(</span><span class="s2">b64str</span><span class="s1">, </span><span class="s0">'base64'</span><span class="s1">), </span><span class="s0">&quot;utf16-be&quot;</span><span class="s1">);</span>
                <span class="s1">}</span>

                <span class="s3">if </span><span class="s1">(</span><span class="s2">buf</span><span class="s1">[</span><span class="s2">i</span><span class="s1">] != </span><span class="s2">minusChar</span><span class="s1">) </span><span class="s4">// Minus may be absorbed after base64.</span>
                    <span class="s2">i</span><span class="s1">--;</span>

                <span class="s2">lastI </span><span class="s1">= </span><span class="s2">i</span><span class="s1">+</span><span class="s6">1</span><span class="s1">;</span>
                <span class="s2">inBase64 </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
                <span class="s2">base64Accum </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(!</span><span class="s2">inBase64</span><span class="s1">) {</span>
        <span class="s2">res </span><span class="s1">+= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">iconv</span><span class="s1">.</span><span class="s2">decode</span><span class="s1">(</span><span class="s2">buf</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">lastI</span><span class="s1">), </span><span class="s0">&quot;ascii&quot;</span><span class="s1">); </span><span class="s4">// Write direct chars.</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s3">var </span><span class="s2">b64str </span><span class="s1">= </span><span class="s2">base64Accum </span><span class="s1">+ </span><span class="s2">buf</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">lastI</span><span class="s1">).</span><span class="s2">toString</span><span class="s1">().</span><span class="s2">replace</span><span class="s1">(</span><span class="s5">/,/g</span><span class="s1">, </span><span class="s0">'/'</span><span class="s1">);</span>

        <span class="s3">var </span><span class="s2">canBeDecoded </span><span class="s1">= </span><span class="s2">b64str</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- (</span><span class="s2">b64str</span><span class="s1">.</span><span class="s2">length </span><span class="s1">% </span><span class="s6">8</span><span class="s1">); </span><span class="s4">// Minimal chunk: 2 quads -&gt; 2x3 bytes -&gt; 3 chars.</span>
        <span class="s2">base64Accum </span><span class="s1">= </span><span class="s2">b64str</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s2">canBeDecoded</span><span class="s1">); </span><span class="s4">// The rest will be decoded in future.</span>
        <span class="s2">b64str </span><span class="s1">= </span><span class="s2">b64str</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s6">0</span><span class="s1">, </span><span class="s2">canBeDecoded</span><span class="s1">);</span>

        <span class="s2">res </span><span class="s1">+= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">iconv</span><span class="s1">.</span><span class="s2">decode</span><span class="s1">(</span><span class="s2">Buffer</span><span class="s1">.</span><span class="s2">from</span><span class="s1">(</span><span class="s2">b64str</span><span class="s1">, </span><span class="s0">'base64'</span><span class="s1">), </span><span class="s0">&quot;utf16-be&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">inBase64 </span><span class="s1">= </span><span class="s2">inBase64</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">base64Accum </span><span class="s1">= </span><span class="s2">base64Accum</span><span class="s1">;</span>

    <span class="s3">return </span><span class="s2">res</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">Utf7IMAPDecoder</span><span class="s1">.</span><span class="s2">prototype</span><span class="s1">.</span><span class="s2">end </span><span class="s1">= </span><span class="s3">function</span><span class="s1">() {</span>
    <span class="s3">var </span><span class="s2">res </span><span class="s1">= </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">inBase64 </span><span class="s1">&amp;&amp; </span><span class="s3">this</span><span class="s1">.</span><span class="s2">base64Accum</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&gt; </span><span class="s6">0</span><span class="s1">)</span>
        <span class="s2">res </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s2">iconv</span><span class="s1">.</span><span class="s2">decode</span><span class="s1">(</span><span class="s2">Buffer</span><span class="s1">.</span><span class="s2">from</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s2">base64Accum</span><span class="s1">, </span><span class="s0">'base64'</span><span class="s1">), </span><span class="s0">&quot;utf16-be&quot;</span><span class="s1">);</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s2">inBase64 </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s2">base64Accum </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
    <span class="s3">return </span><span class="s2">res</span><span class="s1">;</span>
<span class="s1">}</span>


</pre>
</body>
</html>