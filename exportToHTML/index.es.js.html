<html>
<head>
<title>index.es.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #bcbec4;}
.s1 { color: #bcbec4;}
.s2 { color: #6aab73;}
.s3 { color: #cf8e6d;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
.s6 { color: #42c3d4;}
.s7 { color: #5f826b; font-style: italic;}
.s8 { color: #67a37c; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
index.es.js</font>
</center></td></tr></table>
<pre><span class="s0">process</span><span class="s1">.</span><span class="s0">emitWarning</span><span class="s1">(</span><span class="s2">&quot;The .es.js file is deprecated. Use .mjs instead.&quot;</span><span class="s1">);</span>

<span class="s3">import </span><span class="s0">Stream from </span><span class="s2">'stream'</span><span class="s1">;</span>
<span class="s3">import </span><span class="s0">http from </span><span class="s2">'http'</span><span class="s1">;</span>
<span class="s3">import </span><span class="s0">Url from </span><span class="s2">'url'</span><span class="s1">;</span>
<span class="s3">import </span><span class="s0">whatwgUrl from </span><span class="s2">'whatwg-url'</span><span class="s1">;</span>
<span class="s3">import </span><span class="s0">https from </span><span class="s2">'https'</span><span class="s1">;</span>
<span class="s3">import </span><span class="s0">zlib from </span><span class="s2">'zlib'</span><span class="s1">;</span>

<span class="s4">// Based on https://github.com/tmpvar/jsdom/blob/aa85b2abf07766ff7bf5c1f6daafb3726f2f2db5/lib/jsdom/living/blob.js</span>

<span class="s4">// fix for &quot;Readable&quot; isn't a named export issue</span>
<span class="s3">const </span><span class="s0">Readable </span><span class="s1">= </span><span class="s0">Stream</span><span class="s1">.</span><span class="s0">Readable</span><span class="s1">;</span>

<span class="s3">const </span><span class="s0">BUFFER </span><span class="s1">= </span><span class="s0">Symbol</span><span class="s1">(</span><span class="s2">'buffer'</span><span class="s1">);</span>
<span class="s3">const </span><span class="s0">TYPE </span><span class="s1">= </span><span class="s0">Symbol</span><span class="s1">(</span><span class="s2">'type'</span><span class="s1">);</span>

<span class="s3">class </span><span class="s0">Blob </span><span class="s1">{</span>
	<span class="s0">constructor</span><span class="s1">() {</span>
		<span class="s3">this</span><span class="s1">[</span><span class="s0">TYPE</span><span class="s1">] = </span><span class="s2">''</span><span class="s1">;</span>

		<span class="s3">const </span><span class="s0">blobParts </span><span class="s1">= </span><span class="s0">arguments</span><span class="s1">[</span><span class="s5">0</span><span class="s1">];</span>
		<span class="s3">const </span><span class="s0">options </span><span class="s1">= </span><span class="s0">arguments</span><span class="s1">[</span><span class="s5">1</span><span class="s1">];</span>

		<span class="s3">const </span><span class="s0">buffers </span><span class="s1">= [];</span>
		<span class="s3">let </span><span class="s0">size </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>

		<span class="s3">if </span><span class="s1">(</span><span class="s0">blobParts</span><span class="s1">) {</span>
			<span class="s3">const </span><span class="s0">a </span><span class="s1">= </span><span class="s0">blobParts</span><span class="s1">;</span>
			<span class="s3">const </span><span class="s0">length </span><span class="s1">= </span><span class="s0">Number</span><span class="s1">(</span><span class="s0">a</span><span class="s1">.</span><span class="s0">length</span><span class="s1">);</span>
			<span class="s3">for </span><span class="s1">(</span><span class="s3">let </span><span class="s0">i </span><span class="s1">= </span><span class="s5">0</span><span class="s1">; </span><span class="s0">i </span><span class="s1">&lt; </span><span class="s0">length</span><span class="s1">; </span><span class="s0">i</span><span class="s1">++) {</span>
				<span class="s3">const </span><span class="s0">element </span><span class="s1">= </span><span class="s0">a</span><span class="s1">[</span><span class="s0">i</span><span class="s1">];</span>
				<span class="s3">let </span><span class="s0">buffer</span><span class="s1">;</span>
				<span class="s3">if </span><span class="s1">(</span><span class="s0">element </span><span class="s3">instanceof </span><span class="s0">Buffer</span><span class="s1">) {</span>
					<span class="s0">buffer </span><span class="s1">= </span><span class="s0">element</span><span class="s1">;</span>
				<span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s0">ArrayBuffer</span><span class="s1">.</span><span class="s0">isView</span><span class="s1">(</span><span class="s0">element</span><span class="s1">)) {</span>
					<span class="s0">buffer </span><span class="s1">= </span><span class="s0">Buffer</span><span class="s1">.</span><span class="s0">from</span><span class="s1">(</span><span class="s0">element</span><span class="s1">.</span><span class="s0">buffer</span><span class="s1">, </span><span class="s0">element</span><span class="s1">.</span><span class="s0">byteOffset</span><span class="s1">, </span><span class="s0">element</span><span class="s1">.</span><span class="s0">byteLength</span><span class="s1">);</span>
				<span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s0">element </span><span class="s3">instanceof </span><span class="s0">ArrayBuffer</span><span class="s1">) {</span>
					<span class="s0">buffer </span><span class="s1">= </span><span class="s0">Buffer</span><span class="s1">.</span><span class="s0">from</span><span class="s1">(</span><span class="s0">element</span><span class="s1">);</span>
				<span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s0">element </span><span class="s3">instanceof </span><span class="s0">Blob</span><span class="s1">) {</span>
					<span class="s0">buffer </span><span class="s1">= </span><span class="s0">element</span><span class="s1">[</span><span class="s0">BUFFER</span><span class="s1">];</span>
				<span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
					<span class="s0">buffer </span><span class="s1">= </span><span class="s0">Buffer</span><span class="s1">.</span><span class="s0">from</span><span class="s1">(</span><span class="s3">typeof </span><span class="s0">element </span><span class="s1">=== </span><span class="s2">'string' </span><span class="s1">? </span><span class="s0">element </span><span class="s1">: </span><span class="s0">String</span><span class="s1">(</span><span class="s0">element</span><span class="s1">));</span>
				<span class="s1">}</span>
				<span class="s0">size </span><span class="s1">+= </span><span class="s0">buffer</span><span class="s1">.</span><span class="s0">length</span><span class="s1">;</span>
				<span class="s0">buffers</span><span class="s1">.</span><span class="s0">push</span><span class="s1">(</span><span class="s0">buffer</span><span class="s1">);</span>
			<span class="s1">}</span>
		<span class="s1">}</span>

		<span class="s3">this</span><span class="s1">[</span><span class="s0">BUFFER</span><span class="s1">] = </span><span class="s0">Buffer</span><span class="s1">.</span><span class="s0">concat</span><span class="s1">(</span><span class="s0">buffers</span><span class="s1">);</span>

		<span class="s3">let </span><span class="s0">type </span><span class="s1">= </span><span class="s0">options </span><span class="s1">&amp;&amp; </span><span class="s0">options</span><span class="s1">.</span><span class="s0">type </span><span class="s1">!== </span><span class="s0">undefined </span><span class="s1">&amp;&amp; </span><span class="s0">String</span><span class="s1">(</span><span class="s0">options</span><span class="s1">.</span><span class="s0">type</span><span class="s1">).</span><span class="s0">toLowerCase</span><span class="s1">();</span>
		<span class="s3">if </span><span class="s1">(</span><span class="s0">type </span><span class="s1">&amp;&amp; !</span><span class="s6">/[^\u0020-\u007E]/</span><span class="s1">.</span><span class="s0">test</span><span class="s1">(</span><span class="s0">type</span><span class="s1">)) {</span>
			<span class="s3">this</span><span class="s1">[</span><span class="s0">TYPE</span><span class="s1">] = </span><span class="s0">type</span><span class="s1">;</span>
		<span class="s1">}</span>
	<span class="s1">}</span>
	<span class="s0">get size</span><span class="s1">() {</span>
		<span class="s3">return this</span><span class="s1">[</span><span class="s0">BUFFER</span><span class="s1">].</span><span class="s0">length</span><span class="s1">;</span>
	<span class="s1">}</span>
	<span class="s0">get type</span><span class="s1">() {</span>
		<span class="s3">return this</span><span class="s1">[</span><span class="s0">TYPE</span><span class="s1">];</span>
	<span class="s1">}</span>
	<span class="s0">text</span><span class="s1">() {</span>
		<span class="s3">return </span><span class="s0">Promise</span><span class="s1">.</span><span class="s0">resolve</span><span class="s1">(</span><span class="s3">this</span><span class="s1">[</span><span class="s0">BUFFER</span><span class="s1">].</span><span class="s0">toString</span><span class="s1">());</span>
	<span class="s1">}</span>
	<span class="s0">arrayBuffer</span><span class="s1">() {</span>
		<span class="s3">const </span><span class="s0">buf </span><span class="s1">= </span><span class="s3">this</span><span class="s1">[</span><span class="s0">BUFFER</span><span class="s1">];</span>
		<span class="s3">const </span><span class="s0">ab </span><span class="s1">= </span><span class="s0">buf</span><span class="s1">.</span><span class="s0">buffer</span><span class="s1">.</span><span class="s0">slice</span><span class="s1">(</span><span class="s0">buf</span><span class="s1">.</span><span class="s0">byteOffset</span><span class="s1">, </span><span class="s0">buf</span><span class="s1">.</span><span class="s0">byteOffset </span><span class="s1">+ </span><span class="s0">buf</span><span class="s1">.</span><span class="s0">byteLength</span><span class="s1">);</span>
		<span class="s3">return </span><span class="s0">Promise</span><span class="s1">.</span><span class="s0">resolve</span><span class="s1">(</span><span class="s0">ab</span><span class="s1">);</span>
	<span class="s1">}</span>
	<span class="s0">stream</span><span class="s1">() {</span>
		<span class="s3">const </span><span class="s0">readable </span><span class="s1">= </span><span class="s3">new </span><span class="s0">Readable</span><span class="s1">();</span>
		<span class="s0">readable</span><span class="s1">.</span><span class="s0">_read </span><span class="s1">= </span><span class="s3">function </span><span class="s1">() {};</span>
		<span class="s0">readable</span><span class="s1">.</span><span class="s0">push</span><span class="s1">(</span><span class="s3">this</span><span class="s1">[</span><span class="s0">BUFFER</span><span class="s1">]);</span>
		<span class="s0">readable</span><span class="s1">.</span><span class="s0">push</span><span class="s1">(</span><span class="s3">null</span><span class="s1">);</span>
		<span class="s3">return </span><span class="s0">readable</span><span class="s1">;</span>
	<span class="s1">}</span>
	<span class="s0">toString</span><span class="s1">() {</span>
		<span class="s3">return </span><span class="s2">'[object Blob]'</span><span class="s1">;</span>
	<span class="s1">}</span>
	<span class="s0">slice</span><span class="s1">() {</span>
		<span class="s3">const </span><span class="s0">size </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s0">size</span><span class="s1">;</span>

		<span class="s3">const </span><span class="s0">start </span><span class="s1">= </span><span class="s0">arguments</span><span class="s1">[</span><span class="s5">0</span><span class="s1">];</span>
		<span class="s3">const </span><span class="s0">end </span><span class="s1">= </span><span class="s0">arguments</span><span class="s1">[</span><span class="s5">1</span><span class="s1">];</span>
		<span class="s3">let </span><span class="s0">relativeStart</span><span class="s1">, </span><span class="s0">relativeEnd</span><span class="s1">;</span>
		<span class="s3">if </span><span class="s1">(</span><span class="s0">start </span><span class="s1">=== </span><span class="s0">undefined</span><span class="s1">) {</span>
			<span class="s0">relativeStart </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
		<span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s0">start </span><span class="s1">&lt; </span><span class="s5">0</span><span class="s1">) {</span>
			<span class="s0">relativeStart </span><span class="s1">= </span><span class="s0">Math</span><span class="s1">.</span><span class="s0">max</span><span class="s1">(</span><span class="s0">size </span><span class="s1">+ </span><span class="s0">start</span><span class="s1">, </span><span class="s5">0</span><span class="s1">);</span>
		<span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
			<span class="s0">relativeStart </span><span class="s1">= </span><span class="s0">Math</span><span class="s1">.</span><span class="s0">min</span><span class="s1">(</span><span class="s0">start</span><span class="s1">, </span><span class="s0">size</span><span class="s1">);</span>
		<span class="s1">}</span>
		<span class="s3">if </span><span class="s1">(</span><span class="s0">end </span><span class="s1">=== </span><span class="s0">undefined</span><span class="s1">) {</span>
			<span class="s0">relativeEnd </span><span class="s1">= </span><span class="s0">size</span><span class="s1">;</span>
		<span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s0">end </span><span class="s1">&lt; </span><span class="s5">0</span><span class="s1">) {</span>
			<span class="s0">relativeEnd </span><span class="s1">= </span><span class="s0">Math</span><span class="s1">.</span><span class="s0">max</span><span class="s1">(</span><span class="s0">size </span><span class="s1">+ </span><span class="s0">end</span><span class="s1">, </span><span class="s5">0</span><span class="s1">);</span>
		<span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
			<span class="s0">relativeEnd </span><span class="s1">= </span><span class="s0">Math</span><span class="s1">.</span><span class="s0">min</span><span class="s1">(</span><span class="s0">end</span><span class="s1">, </span><span class="s0">size</span><span class="s1">);</span>
		<span class="s1">}</span>
		<span class="s3">const </span><span class="s0">span </span><span class="s1">= </span><span class="s0">Math</span><span class="s1">.</span><span class="s0">max</span><span class="s1">(</span><span class="s0">relativeEnd </span><span class="s1">- </span><span class="s0">relativeStart</span><span class="s1">, </span><span class="s5">0</span><span class="s1">);</span>

		<span class="s3">const </span><span class="s0">buffer </span><span class="s1">= </span><span class="s3">this</span><span class="s1">[</span><span class="s0">BUFFER</span><span class="s1">];</span>
		<span class="s3">const </span><span class="s0">slicedBuffer </span><span class="s1">= </span><span class="s0">buffer</span><span class="s1">.</span><span class="s0">slice</span><span class="s1">(</span><span class="s0">relativeStart</span><span class="s1">, </span><span class="s0">relativeStart </span><span class="s1">+ </span><span class="s0">span</span><span class="s1">);</span>
		<span class="s3">const </span><span class="s0">blob </span><span class="s1">= </span><span class="s3">new </span><span class="s0">Blob</span><span class="s1">([], { </span><span class="s0">type</span><span class="s1">: </span><span class="s0">arguments</span><span class="s1">[</span><span class="s5">2</span><span class="s1">] });</span>
		<span class="s0">blob</span><span class="s1">[</span><span class="s0">BUFFER</span><span class="s1">] = </span><span class="s0">slicedBuffer</span><span class="s1">;</span>
		<span class="s3">return </span><span class="s0">blob</span><span class="s1">;</span>
	<span class="s1">}</span>
<span class="s1">}</span>

<span class="s0">Object</span><span class="s1">.</span><span class="s0">defineProperties</span><span class="s1">(</span><span class="s0">Blob</span><span class="s1">.</span><span class="s0">prototype</span><span class="s1">, {</span>
	<span class="s0">size</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">},</span>
	<span class="s0">type</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">},</span>
	<span class="s0">slice</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">}</span>
<span class="s1">});</span>

<span class="s0">Object</span><span class="s1">.</span><span class="s0">defineProperty</span><span class="s1">(</span><span class="s0">Blob</span><span class="s1">.</span><span class="s0">prototype</span><span class="s1">, </span><span class="s0">Symbol</span><span class="s1">.</span><span class="s0">toStringTag</span><span class="s1">, {</span>
	<span class="s0">value</span><span class="s1">: </span><span class="s2">'Blob'</span><span class="s1">,</span>
	<span class="s0">writable</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
	<span class="s0">enumerable</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
	<span class="s0">configurable</span><span class="s1">: </span><span class="s3">true</span>
<span class="s1">});</span>

<span class="s7">/**</span>
 <span class="s7">* fetch-error.js</span>
 <span class="s7">*</span>
 <span class="s7">* FetchError interface for operational errors</span>
 <span class="s7">*/</span>

<span class="s7">/**</span>
 <span class="s7">* Create FetchError instance</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param   </span><span class="s7">String      message      Error message for human</span>
 <span class="s7">* </span><span class="s8">@param   </span><span class="s7">String      type         Error type for machine</span>
 <span class="s7">* </span><span class="s8">@param   </span><span class="s7">String      systemError  For Node.js system error</span>
 <span class="s7">* </span><span class="s8">@return  </span><span class="s7">FetchError</span>
 <span class="s7">*/</span>
<span class="s3">function </span><span class="s0">FetchError</span><span class="s1">(</span><span class="s0">message</span><span class="s1">, </span><span class="s0">type</span><span class="s1">, </span><span class="s0">systemError</span><span class="s1">) {</span>
  <span class="s0">Error</span><span class="s1">.</span><span class="s0">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s0">message</span><span class="s1">);</span>

  <span class="s3">this</span><span class="s1">.</span><span class="s0">message </span><span class="s1">= </span><span class="s0">message</span><span class="s1">;</span>
  <span class="s3">this</span><span class="s1">.</span><span class="s0">type </span><span class="s1">= </span><span class="s0">type</span><span class="s1">;</span>

  <span class="s4">// when err.type is `system`, err.code contains system error code</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s0">systemError</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s0">code </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s0">errno </span><span class="s1">= </span><span class="s0">systemError</span><span class="s1">.</span><span class="s0">code</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s4">// hide custom error implementation details from end-users</span>
  <span class="s0">Error</span><span class="s1">.</span><span class="s0">captureStackTrace</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s0">constructor</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s0">FetchError</span><span class="s1">.</span><span class="s0">prototype </span><span class="s1">= </span><span class="s0">Object</span><span class="s1">.</span><span class="s0">create</span><span class="s1">(</span><span class="s0">Error</span><span class="s1">.</span><span class="s0">prototype</span><span class="s1">);</span>
<span class="s0">FetchError</span><span class="s1">.</span><span class="s0">prototype</span><span class="s1">.</span><span class="s0">constructor </span><span class="s1">= </span><span class="s0">FetchError</span><span class="s1">;</span>
<span class="s0">FetchError</span><span class="s1">.</span><span class="s0">prototype</span><span class="s1">.</span><span class="s0">name </span><span class="s1">= </span><span class="s2">'FetchError'</span><span class="s1">;</span>

<span class="s3">let </span><span class="s0">convert</span><span class="s1">;</span>
<span class="s3">try </span><span class="s1">{</span>
	<span class="s0">convert </span><span class="s1">= </span><span class="s0">require</span><span class="s1">(</span><span class="s2">'encoding'</span><span class="s1">).</span><span class="s0">convert</span><span class="s1">;</span>
<span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s0">e</span><span class="s1">) {}</span>

<span class="s3">const </span><span class="s0">INTERNALS </span><span class="s1">= </span><span class="s0">Symbol</span><span class="s1">(</span><span class="s2">'Body internals'</span><span class="s1">);</span>

<span class="s4">// fix an issue where &quot;PassThrough&quot; isn't a named export for node &lt;10</span>
<span class="s3">const </span><span class="s0">PassThrough </span><span class="s1">= </span><span class="s0">Stream</span><span class="s1">.</span><span class="s0">PassThrough</span><span class="s1">;</span>

<span class="s7">/**</span>
 <span class="s7">* Body mixin</span>
 <span class="s7">*</span>
 <span class="s7">* Ref: https://fetch.spec.whatwg.org/#body</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param   </span><span class="s7">Stream  body  Readable stream</span>
 <span class="s7">* </span><span class="s8">@param   </span><span class="s7">Object  opts  Response options</span>
 <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Void</span>
 <span class="s7">*/</span>
<span class="s3">function </span><span class="s0">Body</span><span class="s1">(</span><span class="s0">body</span><span class="s1">) {</span>
	<span class="s3">var </span><span class="s0">_this </span><span class="s1">= </span><span class="s3">this</span><span class="s1">;</span>

	<span class="s3">var </span><span class="s0">_ref </span><span class="s1">= </span><span class="s0">arguments</span><span class="s1">.</span><span class="s0">length </span><span class="s1">&gt; </span><span class="s5">1 </span><span class="s1">&amp;&amp; </span><span class="s0">arguments</span><span class="s1">[</span><span class="s5">1</span><span class="s1">] !== </span><span class="s0">undefined </span><span class="s1">? </span><span class="s0">arguments</span><span class="s1">[</span><span class="s5">1</span><span class="s1">] : {},</span>
	    <span class="s0">_ref$size </span><span class="s1">= </span><span class="s0">_ref</span><span class="s1">.</span><span class="s0">size</span><span class="s1">;</span>

	<span class="s3">let </span><span class="s0">size </span><span class="s1">= </span><span class="s0">_ref$size </span><span class="s1">=== </span><span class="s0">undefined </span><span class="s1">? </span><span class="s5">0 </span><span class="s1">: </span><span class="s0">_ref$size</span><span class="s1">;</span>
	<span class="s3">var </span><span class="s0">_ref$timeout </span><span class="s1">= </span><span class="s0">_ref</span><span class="s1">.</span><span class="s0">timeout</span><span class="s1">;</span>
	<span class="s3">let </span><span class="s0">timeout </span><span class="s1">= </span><span class="s0">_ref$timeout </span><span class="s1">=== </span><span class="s0">undefined </span><span class="s1">? </span><span class="s5">0 </span><span class="s1">: </span><span class="s0">_ref$timeout</span><span class="s1">;</span>

	<span class="s3">if </span><span class="s1">(</span><span class="s0">body </span><span class="s1">== </span><span class="s3">null</span><span class="s1">) {</span>
		<span class="s4">// body is undefined or null</span>
		<span class="s0">body </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
	<span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s0">isURLSearchParams</span><span class="s1">(</span><span class="s0">body</span><span class="s1">)) {</span>
		<span class="s4">// body is a URLSearchParams</span>
		<span class="s0">body </span><span class="s1">= </span><span class="s0">Buffer</span><span class="s1">.</span><span class="s0">from</span><span class="s1">(</span><span class="s0">body</span><span class="s1">.</span><span class="s0">toString</span><span class="s1">());</span>
	<span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s0">isBlob</span><span class="s1">(</span><span class="s0">body</span><span class="s1">)) ; </span><span class="s3">else if </span><span class="s1">(</span><span class="s0">Buffer</span><span class="s1">.</span><span class="s0">isBuffer</span><span class="s1">(</span><span class="s0">body</span><span class="s1">)) ; </span><span class="s3">else if </span><span class="s1">(</span><span class="s0">Object</span><span class="s1">.</span><span class="s0">prototype</span><span class="s1">.</span><span class="s0">toString</span><span class="s1">.</span><span class="s0">call</span><span class="s1">(</span><span class="s0">body</span><span class="s1">) === </span><span class="s2">'[object ArrayBuffer]'</span><span class="s1">) {</span>
		<span class="s4">// body is ArrayBuffer</span>
		<span class="s0">body </span><span class="s1">= </span><span class="s0">Buffer</span><span class="s1">.</span><span class="s0">from</span><span class="s1">(</span><span class="s0">body</span><span class="s1">);</span>
	<span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s0">ArrayBuffer</span><span class="s1">.</span><span class="s0">isView</span><span class="s1">(</span><span class="s0">body</span><span class="s1">)) {</span>
		<span class="s4">// body is ArrayBufferView</span>
		<span class="s0">body </span><span class="s1">= </span><span class="s0">Buffer</span><span class="s1">.</span><span class="s0">from</span><span class="s1">(</span><span class="s0">body</span><span class="s1">.</span><span class="s0">buffer</span><span class="s1">, </span><span class="s0">body</span><span class="s1">.</span><span class="s0">byteOffset</span><span class="s1">, </span><span class="s0">body</span><span class="s1">.</span><span class="s0">byteLength</span><span class="s1">);</span>
	<span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s0">body </span><span class="s3">instanceof </span><span class="s0">Stream</span><span class="s1">) ; </span><span class="s3">else </span><span class="s1">{</span>
		<span class="s4">// none of the above</span>
		<span class="s4">// coerce to string then buffer</span>
		<span class="s0">body </span><span class="s1">= </span><span class="s0">Buffer</span><span class="s1">.</span><span class="s0">from</span><span class="s1">(</span><span class="s0">String</span><span class="s1">(</span><span class="s0">body</span><span class="s1">));</span>
	<span class="s1">}</span>
	<span class="s3">this</span><span class="s1">[</span><span class="s0">INTERNALS</span><span class="s1">] = {</span>
		<span class="s0">body</span><span class="s1">,</span>
		<span class="s0">disturbed</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
		<span class="s0">error</span><span class="s1">: </span><span class="s3">null</span>
	<span class="s1">};</span>
	<span class="s3">this</span><span class="s1">.</span><span class="s0">size </span><span class="s1">= </span><span class="s0">size</span><span class="s1">;</span>
	<span class="s3">this</span><span class="s1">.</span><span class="s0">timeout </span><span class="s1">= </span><span class="s0">timeout</span><span class="s1">;</span>

	<span class="s3">if </span><span class="s1">(</span><span class="s0">body </span><span class="s3">instanceof </span><span class="s0">Stream</span><span class="s1">) {</span>
		<span class="s0">body</span><span class="s1">.</span><span class="s0">on</span><span class="s1">(</span><span class="s2">'error'</span><span class="s1">, </span><span class="s3">function </span><span class="s1">(</span><span class="s0">err</span><span class="s1">) {</span>
			<span class="s3">const </span><span class="s0">error </span><span class="s1">= </span><span class="s0">err</span><span class="s1">.</span><span class="s0">name </span><span class="s1">=== </span><span class="s2">'AbortError' </span><span class="s1">? </span><span class="s0">err </span><span class="s1">: </span><span class="s3">new </span><span class="s0">FetchError</span><span class="s1">(</span><span class="s2">`Invalid response body while trying to fetch </span><span class="s0">$</span><span class="s1">{</span><span class="s0">_this</span><span class="s1">.</span><span class="s0">url</span><span class="s1">}</span><span class="s2">: </span><span class="s0">$</span><span class="s1">{</span><span class="s0">err</span><span class="s1">.</span><span class="s0">message</span><span class="s1">}</span><span class="s2">`</span><span class="s1">, </span><span class="s2">'system'</span><span class="s1">, </span><span class="s0">err</span><span class="s1">);</span>
			<span class="s0">_this</span><span class="s1">[</span><span class="s0">INTERNALS</span><span class="s1">].</span><span class="s0">error </span><span class="s1">= </span><span class="s0">error</span><span class="s1">;</span>
		<span class="s1">});</span>
	<span class="s1">}</span>
<span class="s1">}</span>

<span class="s0">Body</span><span class="s1">.</span><span class="s0">prototype </span><span class="s1">= {</span>
	<span class="s0">get body</span><span class="s1">() {</span>
		<span class="s3">return this</span><span class="s1">[</span><span class="s0">INTERNALS</span><span class="s1">].</span><span class="s0">body</span><span class="s1">;</span>
	<span class="s1">},</span>

	<span class="s0">get bodyUsed</span><span class="s1">() {</span>
		<span class="s3">return this</span><span class="s1">[</span><span class="s0">INTERNALS</span><span class="s1">].</span><span class="s0">disturbed</span><span class="s1">;</span>
	<span class="s1">},</span>

	<span class="s7">/**</span>
  <span class="s7">* Decode response as ArrayBuffer</span>
  <span class="s7">*</span>
  <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Promise</span>
  <span class="s7">*/</span>
	<span class="s0">arrayBuffer</span><span class="s1">() {</span>
		<span class="s3">return </span><span class="s0">consumeBody</span><span class="s1">.</span><span class="s0">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">).</span><span class="s0">then</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s0">buf</span><span class="s1">) {</span>
			<span class="s3">return </span><span class="s0">buf</span><span class="s1">.</span><span class="s0">buffer</span><span class="s1">.</span><span class="s0">slice</span><span class="s1">(</span><span class="s0">buf</span><span class="s1">.</span><span class="s0">byteOffset</span><span class="s1">, </span><span class="s0">buf</span><span class="s1">.</span><span class="s0">byteOffset </span><span class="s1">+ </span><span class="s0">buf</span><span class="s1">.</span><span class="s0">byteLength</span><span class="s1">);</span>
		<span class="s1">});</span>
	<span class="s1">},</span>

	<span class="s7">/**</span>
  <span class="s7">* Return raw response as Blob</span>
  <span class="s7">*</span>
  <span class="s7">* </span><span class="s8">@return </span><span class="s7">Promise</span>
  <span class="s7">*/</span>
	<span class="s0">blob</span><span class="s1">() {</span>
		<span class="s3">let </span><span class="s0">ct </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s0">headers </span><span class="s1">&amp;&amp; </span><span class="s3">this</span><span class="s1">.</span><span class="s0">headers</span><span class="s1">.</span><span class="s0">get</span><span class="s1">(</span><span class="s2">'content-type'</span><span class="s1">) || </span><span class="s2">''</span><span class="s1">;</span>
		<span class="s3">return </span><span class="s0">consumeBody</span><span class="s1">.</span><span class="s0">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">).</span><span class="s0">then</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s0">buf</span><span class="s1">) {</span>
			<span class="s3">return </span><span class="s0">Object</span><span class="s1">.</span><span class="s0">assign</span><span class="s1">(</span>
			<span class="s4">// Prevent copying</span>
			<span class="s3">new </span><span class="s0">Blob</span><span class="s1">([], {</span>
				<span class="s0">type</span><span class="s1">: </span><span class="s0">ct</span><span class="s1">.</span><span class="s0">toLowerCase</span><span class="s1">()</span>
			<span class="s1">}), {</span>
				<span class="s1">[</span><span class="s0">BUFFER</span><span class="s1">]: </span><span class="s0">buf</span>
			<span class="s1">});</span>
		<span class="s1">});</span>
	<span class="s1">},</span>

	<span class="s7">/**</span>
  <span class="s7">* Decode response as json</span>
  <span class="s7">*</span>
  <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Promise</span>
  <span class="s7">*/</span>
	<span class="s0">json</span><span class="s1">() {</span>
		<span class="s3">var </span><span class="s0">_this2 </span><span class="s1">= </span><span class="s3">this</span><span class="s1">;</span>

		<span class="s3">return </span><span class="s0">consumeBody</span><span class="s1">.</span><span class="s0">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">).</span><span class="s0">then</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s0">buffer</span><span class="s1">) {</span>
			<span class="s3">try </span><span class="s1">{</span>
				<span class="s3">return </span><span class="s0">JSON</span><span class="s1">.</span><span class="s0">parse</span><span class="s1">(</span><span class="s0">buffer</span><span class="s1">.</span><span class="s0">toString</span><span class="s1">());</span>
			<span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s0">err</span><span class="s1">) {</span>
				<span class="s3">return </span><span class="s0">Body</span><span class="s1">.</span><span class="s0">Promise</span><span class="s1">.</span><span class="s0">reject</span><span class="s1">(</span><span class="s3">new </span><span class="s0">FetchError</span><span class="s1">(</span><span class="s2">`invalid json response body at </span><span class="s0">$</span><span class="s1">{</span><span class="s0">_this2</span><span class="s1">.</span><span class="s0">url</span><span class="s1">} </span><span class="s2">reason: </span><span class="s0">$</span><span class="s1">{</span><span class="s0">err</span><span class="s1">.</span><span class="s0">message</span><span class="s1">}</span><span class="s2">`</span><span class="s1">, </span><span class="s2">'invalid-json'</span><span class="s1">));</span>
			<span class="s1">}</span>
		<span class="s1">});</span>
	<span class="s1">},</span>

	<span class="s7">/**</span>
  <span class="s7">* Decode response as text</span>
  <span class="s7">*</span>
  <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Promise</span>
  <span class="s7">*/</span>
	<span class="s0">text</span><span class="s1">() {</span>
		<span class="s3">return </span><span class="s0">consumeBody</span><span class="s1">.</span><span class="s0">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">).</span><span class="s0">then</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s0">buffer</span><span class="s1">) {</span>
			<span class="s3">return </span><span class="s0">buffer</span><span class="s1">.</span><span class="s0">toString</span><span class="s1">();</span>
		<span class="s1">});</span>
	<span class="s1">},</span>

	<span class="s7">/**</span>
  <span class="s7">* Decode response as buffer (non-spec api)</span>
  <span class="s7">*</span>
  <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Promise</span>
  <span class="s7">*/</span>
	<span class="s0">buffer</span><span class="s1">() {</span>
		<span class="s3">return </span><span class="s0">consumeBody</span><span class="s1">.</span><span class="s0">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">);</span>
	<span class="s1">},</span>

	<span class="s7">/**</span>
  <span class="s7">* Decode response as text, while automatically detecting the encoding and</span>
  <span class="s7">* trying to decode to UTF-8 (non-spec api)</span>
  <span class="s7">*</span>
  <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Promise</span>
  <span class="s7">*/</span>
	<span class="s0">textConverted</span><span class="s1">() {</span>
		<span class="s3">var </span><span class="s0">_this3 </span><span class="s1">= </span><span class="s3">this</span><span class="s1">;</span>

		<span class="s3">return </span><span class="s0">consumeBody</span><span class="s1">.</span><span class="s0">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">).</span><span class="s0">then</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s0">buffer</span><span class="s1">) {</span>
			<span class="s3">return </span><span class="s0">convertBody</span><span class="s1">(</span><span class="s0">buffer</span><span class="s1">, </span><span class="s0">_this3</span><span class="s1">.</span><span class="s0">headers</span><span class="s1">);</span>
		<span class="s1">});</span>
	<span class="s1">}</span>
<span class="s1">};</span>

<span class="s4">// In browsers, all properties are enumerable.</span>
<span class="s0">Object</span><span class="s1">.</span><span class="s0">defineProperties</span><span class="s1">(</span><span class="s0">Body</span><span class="s1">.</span><span class="s0">prototype</span><span class="s1">, {</span>
	<span class="s0">body</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">},</span>
	<span class="s0">bodyUsed</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">},</span>
	<span class="s0">arrayBuffer</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">},</span>
	<span class="s0">blob</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">},</span>
	<span class="s0">json</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">},</span>
	<span class="s0">text</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">}</span>
<span class="s1">});</span>

<span class="s0">Body</span><span class="s1">.</span><span class="s0">mixIn </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s0">proto</span><span class="s1">) {</span>
	<span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s0">name of Object</span><span class="s1">.</span><span class="s0">getOwnPropertyNames</span><span class="s1">(</span><span class="s0">Body</span><span class="s1">.</span><span class="s0">prototype</span><span class="s1">)) {</span>
		<span class="s4">// istanbul ignore else: future proof</span>
		<span class="s3">if </span><span class="s1">(!(</span><span class="s0">name </span><span class="s3">in </span><span class="s0">proto</span><span class="s1">)) {</span>
			<span class="s3">const </span><span class="s0">desc </span><span class="s1">= </span><span class="s0">Object</span><span class="s1">.</span><span class="s0">getOwnPropertyDescriptor</span><span class="s1">(</span><span class="s0">Body</span><span class="s1">.</span><span class="s0">prototype</span><span class="s1">, </span><span class="s0">name</span><span class="s1">);</span>
			<span class="s0">Object</span><span class="s1">.</span><span class="s0">defineProperty</span><span class="s1">(</span><span class="s0">proto</span><span class="s1">, </span><span class="s0">name</span><span class="s1">, </span><span class="s0">desc</span><span class="s1">);</span>
		<span class="s1">}</span>
	<span class="s1">}</span>
<span class="s1">};</span>

<span class="s7">/**</span>
 <span class="s7">* Consume and convert an entire Body to a Buffer.</span>
 <span class="s7">*</span>
 <span class="s7">* Ref: https://fetch.spec.whatwg.org/#concept-body-consume-body</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Promise</span>
 <span class="s7">*/</span>
<span class="s3">function </span><span class="s0">consumeBody</span><span class="s1">() {</span>
	<span class="s3">var </span><span class="s0">_this4 </span><span class="s1">= </span><span class="s3">this</span><span class="s1">;</span>

	<span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">[</span><span class="s0">INTERNALS</span><span class="s1">].</span><span class="s0">disturbed</span><span class="s1">) {</span>
		<span class="s3">return </span><span class="s0">Body</span><span class="s1">.</span><span class="s0">Promise</span><span class="s1">.</span><span class="s0">reject</span><span class="s1">(</span><span class="s3">new </span><span class="s0">TypeError</span><span class="s1">(</span><span class="s2">`body used already for: </span><span class="s0">$</span><span class="s1">{</span><span class="s3">this</span><span class="s1">.</span><span class="s0">url</span><span class="s1">}</span><span class="s2">`</span><span class="s1">));</span>
	<span class="s1">}</span>

	<span class="s3">this</span><span class="s1">[</span><span class="s0">INTERNALS</span><span class="s1">].</span><span class="s0">disturbed </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>

	<span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">[</span><span class="s0">INTERNALS</span><span class="s1">].</span><span class="s0">error</span><span class="s1">) {</span>
		<span class="s3">return </span><span class="s0">Body</span><span class="s1">.</span><span class="s0">Promise</span><span class="s1">.</span><span class="s0">reject</span><span class="s1">(</span><span class="s3">this</span><span class="s1">[</span><span class="s0">INTERNALS</span><span class="s1">].</span><span class="s0">error</span><span class="s1">);</span>
	<span class="s1">}</span>

	<span class="s3">let </span><span class="s0">body </span><span class="s1">= </span><span class="s3">this</span><span class="s1">.</span><span class="s0">body</span><span class="s1">;</span>

	<span class="s4">// body is null</span>
	<span class="s3">if </span><span class="s1">(</span><span class="s0">body </span><span class="s1">=== </span><span class="s3">null</span><span class="s1">) {</span>
		<span class="s3">return </span><span class="s0">Body</span><span class="s1">.</span><span class="s0">Promise</span><span class="s1">.</span><span class="s0">resolve</span><span class="s1">(</span><span class="s0">Buffer</span><span class="s1">.</span><span class="s0">alloc</span><span class="s1">(</span><span class="s5">0</span><span class="s1">));</span>
	<span class="s1">}</span>

	<span class="s4">// body is blob</span>
	<span class="s3">if </span><span class="s1">(</span><span class="s0">isBlob</span><span class="s1">(</span><span class="s0">body</span><span class="s1">)) {</span>
		<span class="s0">body </span><span class="s1">= </span><span class="s0">body</span><span class="s1">.</span><span class="s0">stream</span><span class="s1">();</span>
	<span class="s1">}</span>

	<span class="s4">// body is buffer</span>
	<span class="s3">if </span><span class="s1">(</span><span class="s0">Buffer</span><span class="s1">.</span><span class="s0">isBuffer</span><span class="s1">(</span><span class="s0">body</span><span class="s1">)) {</span>
		<span class="s3">return </span><span class="s0">Body</span><span class="s1">.</span><span class="s0">Promise</span><span class="s1">.</span><span class="s0">resolve</span><span class="s1">(</span><span class="s0">body</span><span class="s1">);</span>
	<span class="s1">}</span>

	<span class="s4">// istanbul ignore if: should never happen</span>
	<span class="s3">if </span><span class="s1">(!(</span><span class="s0">body </span><span class="s3">instanceof </span><span class="s0">Stream</span><span class="s1">)) {</span>
		<span class="s3">return </span><span class="s0">Body</span><span class="s1">.</span><span class="s0">Promise</span><span class="s1">.</span><span class="s0">resolve</span><span class="s1">(</span><span class="s0">Buffer</span><span class="s1">.</span><span class="s0">alloc</span><span class="s1">(</span><span class="s5">0</span><span class="s1">));</span>
	<span class="s1">}</span>

	<span class="s4">// body is stream</span>
	<span class="s4">// get ready to actually consume the body</span>
	<span class="s3">let </span><span class="s0">accum </span><span class="s1">= [];</span>
	<span class="s3">let </span><span class="s0">accumBytes </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
	<span class="s3">let </span><span class="s0">abort </span><span class="s1">= </span><span class="s3">false</span><span class="s1">;</span>

	<span class="s3">return new </span><span class="s0">Body</span><span class="s1">.</span><span class="s0">Promise</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s0">resolve</span><span class="s1">, </span><span class="s0">reject</span><span class="s1">) {</span>
		<span class="s3">let </span><span class="s0">resTimeout</span><span class="s1">;</span>

		<span class="s4">// allow timeout on slow response body</span>
		<span class="s3">if </span><span class="s1">(</span><span class="s0">_this4</span><span class="s1">.</span><span class="s0">timeout</span><span class="s1">) {</span>
			<span class="s0">resTimeout </span><span class="s1">= </span><span class="s0">setTimeout</span><span class="s1">(</span><span class="s3">function </span><span class="s1">() {</span>
				<span class="s0">abort </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
				<span class="s0">reject</span><span class="s1">(</span><span class="s3">new </span><span class="s0">FetchError</span><span class="s1">(</span><span class="s2">`Response timeout while trying to fetch </span><span class="s0">$</span><span class="s1">{</span><span class="s0">_this4</span><span class="s1">.</span><span class="s0">url</span><span class="s1">} </span><span class="s2">(over </span><span class="s0">$</span><span class="s1">{</span><span class="s0">_this4</span><span class="s1">.</span><span class="s0">timeout</span><span class="s1">}</span><span class="s2">ms)`</span><span class="s1">, </span><span class="s2">'body-timeout'</span><span class="s1">));</span>
			<span class="s1">}, </span><span class="s0">_this4</span><span class="s1">.</span><span class="s0">timeout</span><span class="s1">);</span>
		<span class="s1">}</span>

		<span class="s4">// handle stream errors</span>
		<span class="s0">body</span><span class="s1">.</span><span class="s0">on</span><span class="s1">(</span><span class="s2">'error'</span><span class="s1">, </span><span class="s3">function </span><span class="s1">(</span><span class="s0">err</span><span class="s1">) {</span>
			<span class="s3">if </span><span class="s1">(</span><span class="s0">err</span><span class="s1">.</span><span class="s0">name </span><span class="s1">=== </span><span class="s2">'AbortError'</span><span class="s1">) {</span>
				<span class="s4">// if the request was aborted, reject with this Error</span>
				<span class="s0">abort </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
				<span class="s0">reject</span><span class="s1">(</span><span class="s0">err</span><span class="s1">);</span>
			<span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
				<span class="s4">// other errors, such as incorrect content-encoding</span>
				<span class="s0">reject</span><span class="s1">(</span><span class="s3">new </span><span class="s0">FetchError</span><span class="s1">(</span><span class="s2">`Invalid response body while trying to fetch </span><span class="s0">$</span><span class="s1">{</span><span class="s0">_this4</span><span class="s1">.</span><span class="s0">url</span><span class="s1">}</span><span class="s2">: </span><span class="s0">$</span><span class="s1">{</span><span class="s0">err</span><span class="s1">.</span><span class="s0">message</span><span class="s1">}</span><span class="s2">`</span><span class="s1">, </span><span class="s2">'system'</span><span class="s1">, </span><span class="s0">err</span><span class="s1">));</span>
			<span class="s1">}</span>
		<span class="s1">});</span>

		<span class="s0">body</span><span class="s1">.</span><span class="s0">on</span><span class="s1">(</span><span class="s2">'data'</span><span class="s1">, </span><span class="s3">function </span><span class="s1">(</span><span class="s0">chunk</span><span class="s1">) {</span>
			<span class="s3">if </span><span class="s1">(</span><span class="s0">abort </span><span class="s1">|| </span><span class="s0">chunk </span><span class="s1">=== </span><span class="s3">null</span><span class="s1">) {</span>
				<span class="s3">return</span><span class="s1">;</span>
			<span class="s1">}</span>

			<span class="s3">if </span><span class="s1">(</span><span class="s0">_this4</span><span class="s1">.</span><span class="s0">size </span><span class="s1">&amp;&amp; </span><span class="s0">accumBytes </span><span class="s1">+ </span><span class="s0">chunk</span><span class="s1">.</span><span class="s0">length </span><span class="s1">&gt; </span><span class="s0">_this4</span><span class="s1">.</span><span class="s0">size</span><span class="s1">) {</span>
				<span class="s0">abort </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
				<span class="s0">reject</span><span class="s1">(</span><span class="s3">new </span><span class="s0">FetchError</span><span class="s1">(</span><span class="s2">`content size at </span><span class="s0">$</span><span class="s1">{</span><span class="s0">_this4</span><span class="s1">.</span><span class="s0">url</span><span class="s1">} </span><span class="s2">over limit: </span><span class="s0">$</span><span class="s1">{</span><span class="s0">_this4</span><span class="s1">.</span><span class="s0">size</span><span class="s1">}</span><span class="s2">`</span><span class="s1">, </span><span class="s2">'max-size'</span><span class="s1">));</span>
				<span class="s3">return</span><span class="s1">;</span>
			<span class="s1">}</span>

			<span class="s0">accumBytes </span><span class="s1">+= </span><span class="s0">chunk</span><span class="s1">.</span><span class="s0">length</span><span class="s1">;</span>
			<span class="s0">accum</span><span class="s1">.</span><span class="s0">push</span><span class="s1">(</span><span class="s0">chunk</span><span class="s1">);</span>
		<span class="s1">});</span>

		<span class="s0">body</span><span class="s1">.</span><span class="s0">on</span><span class="s1">(</span><span class="s2">'end'</span><span class="s1">, </span><span class="s3">function </span><span class="s1">() {</span>
			<span class="s3">if </span><span class="s1">(</span><span class="s0">abort</span><span class="s1">) {</span>
				<span class="s3">return</span><span class="s1">;</span>
			<span class="s1">}</span>

			<span class="s0">clearTimeout</span><span class="s1">(</span><span class="s0">resTimeout</span><span class="s1">);</span>

			<span class="s3">try </span><span class="s1">{</span>
				<span class="s0">resolve</span><span class="s1">(</span><span class="s0">Buffer</span><span class="s1">.</span><span class="s0">concat</span><span class="s1">(</span><span class="s0">accum</span><span class="s1">, </span><span class="s0">accumBytes</span><span class="s1">));</span>
			<span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s0">err</span><span class="s1">) {</span>
				<span class="s4">// handle streams that have accumulated too much data (issue #414)</span>
				<span class="s0">reject</span><span class="s1">(</span><span class="s3">new </span><span class="s0">FetchError</span><span class="s1">(</span><span class="s2">`Could not create Buffer from response body for </span><span class="s0">$</span><span class="s1">{</span><span class="s0">_this4</span><span class="s1">.</span><span class="s0">url</span><span class="s1">}</span><span class="s2">: </span><span class="s0">$</span><span class="s1">{</span><span class="s0">err</span><span class="s1">.</span><span class="s0">message</span><span class="s1">}</span><span class="s2">`</span><span class="s1">, </span><span class="s2">'system'</span><span class="s1">, </span><span class="s0">err</span><span class="s1">));</span>
			<span class="s1">}</span>
		<span class="s1">});</span>
	<span class="s1">});</span>
<span class="s1">}</span>

<span class="s7">/**</span>
 <span class="s7">* Detect buffer encoding and convert to target encoding</span>
 <span class="s7">* ref: http://www.w3.org/TR/2011/WD-html5-20110113/parsing.html#determining-the-character-encoding</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param   </span><span class="s7">Buffer  buffer    Incoming buffer</span>
 <span class="s7">* </span><span class="s8">@param   </span><span class="s7">String  encoding  Target encoding</span>
 <span class="s7">* </span><span class="s8">@return  </span><span class="s7">String</span>
 <span class="s7">*/</span>
<span class="s3">function </span><span class="s0">convertBody</span><span class="s1">(</span><span class="s0">buffer</span><span class="s1">, </span><span class="s0">headers</span><span class="s1">) {</span>
	<span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s0">convert </span><span class="s1">!== </span><span class="s2">'function'</span><span class="s1">) {</span>
		<span class="s3">throw new </span><span class="s0">Error</span><span class="s1">(</span><span class="s2">'The package `encoding` must be installed to use the textConverted() function'</span><span class="s1">);</span>
	<span class="s1">}</span>

	<span class="s3">const </span><span class="s0">ct </span><span class="s1">= </span><span class="s0">headers</span><span class="s1">.</span><span class="s0">get</span><span class="s1">(</span><span class="s2">'content-type'</span><span class="s1">);</span>
	<span class="s3">let </span><span class="s0">charset </span><span class="s1">= </span><span class="s2">'utf-8'</span><span class="s1">;</span>
	<span class="s3">let </span><span class="s0">res</span><span class="s1">, </span><span class="s0">str</span><span class="s1">;</span>

	<span class="s4">// header</span>
	<span class="s3">if </span><span class="s1">(</span><span class="s0">ct</span><span class="s1">) {</span>
		<span class="s0">res </span><span class="s1">= </span><span class="s6">/charset=([^;]*)/i</span><span class="s1">.</span><span class="s0">exec</span><span class="s1">(</span><span class="s0">ct</span><span class="s1">);</span>
	<span class="s1">}</span>

	<span class="s4">// no charset in content type, peek at response body for at most 1024 bytes</span>
	<span class="s0">str </span><span class="s1">= </span><span class="s0">buffer</span><span class="s1">.</span><span class="s0">slice</span><span class="s1">(</span><span class="s5">0</span><span class="s1">, </span><span class="s5">1024</span><span class="s1">).</span><span class="s0">toString</span><span class="s1">();</span>

	<span class="s4">// html5</span>
	<span class="s3">if </span><span class="s1">(!</span><span class="s0">res </span><span class="s1">&amp;&amp; </span><span class="s0">str</span><span class="s1">) {</span>
		<span class="s0">res </span><span class="s1">= </span><span class="s6">/&lt;meta.+?charset=(['&quot;])(.+?)\1/i</span><span class="s1">.</span><span class="s0">exec</span><span class="s1">(</span><span class="s0">str</span><span class="s1">);</span>
	<span class="s1">}</span>

	<span class="s4">// html4</span>
	<span class="s3">if </span><span class="s1">(!</span><span class="s0">res </span><span class="s1">&amp;&amp; </span><span class="s0">str</span><span class="s1">) {</span>
		<span class="s0">res </span><span class="s1">= </span><span class="s6">/&lt;meta[\s]+?http-equiv=(['&quot;])content-type\1[\s]+?content=(['&quot;])(.+?)\2/i</span><span class="s1">.</span><span class="s0">exec</span><span class="s1">(</span><span class="s0">str</span><span class="s1">);</span>
		<span class="s3">if </span><span class="s1">(!</span><span class="s0">res</span><span class="s1">) {</span>
			<span class="s0">res </span><span class="s1">= </span><span class="s6">/&lt;meta[\s]+?content=(['&quot;])(.+?)\1[\s]+?http-equiv=(['&quot;])content-type\3/i</span><span class="s1">.</span><span class="s0">exec</span><span class="s1">(</span><span class="s0">str</span><span class="s1">);</span>
			<span class="s3">if </span><span class="s1">(</span><span class="s0">res</span><span class="s1">) {</span>
				<span class="s0">res</span><span class="s1">.</span><span class="s0">pop</span><span class="s1">(); </span><span class="s4">// drop last quote</span>
			<span class="s1">}</span>
		<span class="s1">}</span>

		<span class="s3">if </span><span class="s1">(</span><span class="s0">res</span><span class="s1">) {</span>
			<span class="s0">res </span><span class="s1">= </span><span class="s6">/charset=(.*)/i</span><span class="s1">.</span><span class="s0">exec</span><span class="s1">(</span><span class="s0">res</span><span class="s1">.</span><span class="s0">pop</span><span class="s1">());</span>
		<span class="s1">}</span>
	<span class="s1">}</span>

	<span class="s4">// xml</span>
	<span class="s3">if </span><span class="s1">(!</span><span class="s0">res </span><span class="s1">&amp;&amp; </span><span class="s0">str</span><span class="s1">) {</span>
		<span class="s0">res </span><span class="s1">= </span><span class="s6">/&lt;\?xml.+?encoding=(['&quot;])(.+?)\1/i</span><span class="s1">.</span><span class="s0">exec</span><span class="s1">(</span><span class="s0">str</span><span class="s1">);</span>
	<span class="s1">}</span>

	<span class="s4">// found charset</span>
	<span class="s3">if </span><span class="s1">(</span><span class="s0">res</span><span class="s1">) {</span>
		<span class="s0">charset </span><span class="s1">= </span><span class="s0">res</span><span class="s1">.</span><span class="s0">pop</span><span class="s1">();</span>

		<span class="s4">// prevent decode issues when sites use incorrect encoding</span>
		<span class="s4">// ref: https://hsivonen.fi/encoding-menu/</span>
		<span class="s3">if </span><span class="s1">(</span><span class="s0">charset </span><span class="s1">=== </span><span class="s2">'gb2312' </span><span class="s1">|| </span><span class="s0">charset </span><span class="s1">=== </span><span class="s2">'gbk'</span><span class="s1">) {</span>
			<span class="s0">charset </span><span class="s1">= </span><span class="s2">'gb18030'</span><span class="s1">;</span>
		<span class="s1">}</span>
	<span class="s1">}</span>

	<span class="s4">// turn raw buffers into a single utf-8 buffer</span>
	<span class="s3">return </span><span class="s0">convert</span><span class="s1">(</span><span class="s0">buffer</span><span class="s1">, </span><span class="s2">'UTF-8'</span><span class="s1">, </span><span class="s0">charset</span><span class="s1">).</span><span class="s0">toString</span><span class="s1">();</span>
<span class="s1">}</span>

<span class="s7">/**</span>
 <span class="s7">* Detect a URLSearchParams object</span>
 <span class="s7">* ref: https://github.com/bitinn/node-fetch/issues/296#issuecomment-307598143</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param   </span><span class="s7">Object  obj     Object to detect by type or brand</span>
 <span class="s7">* </span><span class="s8">@return  </span><span class="s7">String</span>
 <span class="s7">*/</span>
<span class="s3">function </span><span class="s0">isURLSearchParams</span><span class="s1">(</span><span class="s0">obj</span><span class="s1">) {</span>
	<span class="s4">// Duck-typing as a necessary condition.</span>
	<span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s0">obj </span><span class="s1">!== </span><span class="s2">'object' </span><span class="s1">|| </span><span class="s3">typeof </span><span class="s0">obj</span><span class="s1">.</span><span class="s0">append </span><span class="s1">!== </span><span class="s2">'function' </span><span class="s1">|| </span><span class="s3">typeof </span><span class="s0">obj</span><span class="s1">.</span><span class="s0">delete </span><span class="s1">!== </span><span class="s2">'function' </span><span class="s1">|| </span><span class="s3">typeof </span><span class="s0">obj</span><span class="s1">.</span><span class="s0">get </span><span class="s1">!== </span><span class="s2">'function' </span><span class="s1">|| </span><span class="s3">typeof </span><span class="s0">obj</span><span class="s1">.</span><span class="s0">getAll </span><span class="s1">!== </span><span class="s2">'function' </span><span class="s1">|| </span><span class="s3">typeof </span><span class="s0">obj</span><span class="s1">.</span><span class="s0">has </span><span class="s1">!== </span><span class="s2">'function' </span><span class="s1">|| </span><span class="s3">typeof </span><span class="s0">obj</span><span class="s1">.</span><span class="s0">set </span><span class="s1">!== </span><span class="s2">'function'</span><span class="s1">) {</span>
		<span class="s3">return false</span><span class="s1">;</span>
	<span class="s1">}</span>

	<span class="s4">// Brand-checking and more duck-typing as optional condition.</span>
	<span class="s3">return </span><span class="s0">obj</span><span class="s1">.</span><span class="s0">constructor</span><span class="s1">.</span><span class="s0">name </span><span class="s1">=== </span><span class="s2">'URLSearchParams' </span><span class="s1">|| </span><span class="s0">Object</span><span class="s1">.</span><span class="s0">prototype</span><span class="s1">.</span><span class="s0">toString</span><span class="s1">.</span><span class="s0">call</span><span class="s1">(</span><span class="s0">obj</span><span class="s1">) === </span><span class="s2">'[object URLSearchParams]' </span><span class="s1">|| </span><span class="s3">typeof </span><span class="s0">obj</span><span class="s1">.</span><span class="s0">sort </span><span class="s1">=== </span><span class="s2">'function'</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s7">/**</span>
 <span class="s7">* Check if `obj` is a W3C `Blob` object (which `File` inherits from)</span>
 <span class="s7">* </span><span class="s8">@param  </span><span class="s7">{*} obj</span>
 <span class="s7">* </span><span class="s8">@return </span><span class="s7">{boolean}</span>
 <span class="s7">*/</span>
<span class="s3">function </span><span class="s0">isBlob</span><span class="s1">(</span><span class="s0">obj</span><span class="s1">) {</span>
	<span class="s3">return typeof </span><span class="s0">obj </span><span class="s1">=== </span><span class="s2">'object' </span><span class="s1">&amp;&amp; </span><span class="s3">typeof </span><span class="s0">obj</span><span class="s1">.</span><span class="s0">arrayBuffer </span><span class="s1">=== </span><span class="s2">'function' </span><span class="s1">&amp;&amp; </span><span class="s3">typeof </span><span class="s0">obj</span><span class="s1">.</span><span class="s0">type </span><span class="s1">=== </span><span class="s2">'string' </span><span class="s1">&amp;&amp; </span><span class="s3">typeof </span><span class="s0">obj</span><span class="s1">.</span><span class="s0">stream </span><span class="s1">=== </span><span class="s2">'function' </span><span class="s1">&amp;&amp; </span><span class="s3">typeof </span><span class="s0">obj</span><span class="s1">.</span><span class="s0">constructor </span><span class="s1">=== </span><span class="s2">'function' </span><span class="s1">&amp;&amp; </span><span class="s3">typeof </span><span class="s0">obj</span><span class="s1">.</span><span class="s0">constructor</span><span class="s1">.</span><span class="s0">name </span><span class="s1">=== </span><span class="s2">'string' </span><span class="s1">&amp;&amp; </span><span class="s6">/^(Blob|File)$/</span><span class="s1">.</span><span class="s0">test</span><span class="s1">(</span><span class="s0">obj</span><span class="s1">.</span><span class="s0">constructor</span><span class="s1">.</span><span class="s0">name</span><span class="s1">) &amp;&amp; </span><span class="s6">/^(Blob|File)$/</span><span class="s1">.</span><span class="s0">test</span><span class="s1">(</span><span class="s0">obj</span><span class="s1">[</span><span class="s0">Symbol</span><span class="s1">.</span><span class="s0">toStringTag</span><span class="s1">]);</span>
<span class="s1">}</span>

<span class="s7">/**</span>
 <span class="s7">* Clone body given Res/Req instance</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param   </span><span class="s7">Mixed  instance  Response or Request instance</span>
 <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Mixed</span>
 <span class="s7">*/</span>
<span class="s3">function </span><span class="s0">clone</span><span class="s1">(</span><span class="s0">instance</span><span class="s1">) {</span>
	<span class="s3">let </span><span class="s0">p1</span><span class="s1">, </span><span class="s0">p2</span><span class="s1">;</span>
	<span class="s3">let </span><span class="s0">body </span><span class="s1">= </span><span class="s0">instance</span><span class="s1">.</span><span class="s0">body</span><span class="s1">;</span>

	<span class="s4">// don't allow cloning a used body</span>
	<span class="s3">if </span><span class="s1">(</span><span class="s0">instance</span><span class="s1">.</span><span class="s0">bodyUsed</span><span class="s1">) {</span>
		<span class="s3">throw new </span><span class="s0">Error</span><span class="s1">(</span><span class="s2">'cannot clone body after it is used'</span><span class="s1">);</span>
	<span class="s1">}</span>

	<span class="s4">// check that body is a stream and not form-data object</span>
	<span class="s4">// note: we can't clone the form-data object without having it as a dependency</span>
	<span class="s3">if </span><span class="s1">(</span><span class="s0">body </span><span class="s3">instanceof </span><span class="s0">Stream </span><span class="s1">&amp;&amp; </span><span class="s3">typeof </span><span class="s0">body</span><span class="s1">.</span><span class="s0">getBoundary </span><span class="s1">!== </span><span class="s2">'function'</span><span class="s1">) {</span>
		<span class="s4">// tee instance body</span>
		<span class="s0">p1 </span><span class="s1">= </span><span class="s3">new </span><span class="s0">PassThrough</span><span class="s1">();</span>
		<span class="s0">p2 </span><span class="s1">= </span><span class="s3">new </span><span class="s0">PassThrough</span><span class="s1">();</span>
		<span class="s0">body</span><span class="s1">.</span><span class="s0">pipe</span><span class="s1">(</span><span class="s0">p1</span><span class="s1">);</span>
		<span class="s0">body</span><span class="s1">.</span><span class="s0">pipe</span><span class="s1">(</span><span class="s0">p2</span><span class="s1">);</span>
		<span class="s4">// set instance body to teed body and return the other teed body</span>
		<span class="s0">instance</span><span class="s1">[</span><span class="s0">INTERNALS</span><span class="s1">].</span><span class="s0">body </span><span class="s1">= </span><span class="s0">p1</span><span class="s1">;</span>
		<span class="s0">body </span><span class="s1">= </span><span class="s0">p2</span><span class="s1">;</span>
	<span class="s1">}</span>

	<span class="s3">return </span><span class="s0">body</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s7">/**</span>
 <span class="s7">* Performs the operation &quot;extract a `Content-Type` value from |object|&quot; as</span>
 <span class="s7">* specified in the specification:</span>
 <span class="s7">* https://fetch.spec.whatwg.org/#concept-bodyinit-extract</span>
 <span class="s7">*</span>
 <span class="s7">* This function assumes that instance.body is present.</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param   </span><span class="s7">Mixed  instance  Any options.body input</span>
 <span class="s7">*/</span>
<span class="s3">function </span><span class="s0">extractContentType</span><span class="s1">(</span><span class="s0">body</span><span class="s1">) {</span>
	<span class="s3">if </span><span class="s1">(</span><span class="s0">body </span><span class="s1">=== </span><span class="s3">null</span><span class="s1">) {</span>
		<span class="s4">// body is null</span>
		<span class="s3">return null</span><span class="s1">;</span>
	<span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s0">body </span><span class="s1">=== </span><span class="s2">'string'</span><span class="s1">) {</span>
		<span class="s4">// body is string</span>
		<span class="s3">return </span><span class="s2">'text/plain;charset=UTF-8'</span><span class="s1">;</span>
	<span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s0">isURLSearchParams</span><span class="s1">(</span><span class="s0">body</span><span class="s1">)) {</span>
		<span class="s4">// body is a URLSearchParams</span>
		<span class="s3">return </span><span class="s2">'application/x-www-form-urlencoded;charset=UTF-8'</span><span class="s1">;</span>
	<span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s0">isBlob</span><span class="s1">(</span><span class="s0">body</span><span class="s1">)) {</span>
		<span class="s4">// body is blob</span>
		<span class="s3">return </span><span class="s0">body</span><span class="s1">.</span><span class="s0">type </span><span class="s1">|| </span><span class="s3">null</span><span class="s1">;</span>
	<span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s0">Buffer</span><span class="s1">.</span><span class="s0">isBuffer</span><span class="s1">(</span><span class="s0">body</span><span class="s1">)) {</span>
		<span class="s4">// body is buffer</span>
		<span class="s3">return null</span><span class="s1">;</span>
	<span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s0">Object</span><span class="s1">.</span><span class="s0">prototype</span><span class="s1">.</span><span class="s0">toString</span><span class="s1">.</span><span class="s0">call</span><span class="s1">(</span><span class="s0">body</span><span class="s1">) === </span><span class="s2">'[object ArrayBuffer]'</span><span class="s1">) {</span>
		<span class="s4">// body is ArrayBuffer</span>
		<span class="s3">return null</span><span class="s1">;</span>
	<span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s0">ArrayBuffer</span><span class="s1">.</span><span class="s0">isView</span><span class="s1">(</span><span class="s0">body</span><span class="s1">)) {</span>
		<span class="s4">// body is ArrayBufferView</span>
		<span class="s3">return null</span><span class="s1">;</span>
	<span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s0">body</span><span class="s1">.</span><span class="s0">getBoundary </span><span class="s1">=== </span><span class="s2">'function'</span><span class="s1">) {</span>
		<span class="s4">// detect form data input from form-data module</span>
		<span class="s3">return </span><span class="s2">`multipart/form-data;boundary=</span><span class="s0">$</span><span class="s1">{</span><span class="s0">body</span><span class="s1">.</span><span class="s0">getBoundary</span><span class="s1">()}</span><span class="s2">`</span><span class="s1">;</span>
	<span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s0">body </span><span class="s3">instanceof </span><span class="s0">Stream</span><span class="s1">) {</span>
		<span class="s4">// body is stream</span>
		<span class="s4">// can't really do much about this</span>
		<span class="s3">return null</span><span class="s1">;</span>
	<span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
		<span class="s4">// Body constructor defaults other things to string</span>
		<span class="s3">return </span><span class="s2">'text/plain;charset=UTF-8'</span><span class="s1">;</span>
	<span class="s1">}</span>
<span class="s1">}</span>

<span class="s7">/**</span>
 <span class="s7">* The Fetch Standard treats this as if &quot;total bytes&quot; is a property on the body.</span>
 <span class="s7">* For us, we have to explicitly get it with a function.</span>
 <span class="s7">*</span>
 <span class="s7">* ref: https://fetch.spec.whatwg.org/#concept-body-total-bytes</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param   </span><span class="s7">Body    instance   Instance of Body</span>
 <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Number?            Number of bytes, or null if not possible</span>
 <span class="s7">*/</span>
<span class="s3">function </span><span class="s0">getTotalBytes</span><span class="s1">(</span><span class="s0">instance</span><span class="s1">) {</span>
	<span class="s3">const </span><span class="s0">body </span><span class="s1">= </span><span class="s0">instance</span><span class="s1">.</span><span class="s0">body</span><span class="s1">;</span>


	<span class="s3">if </span><span class="s1">(</span><span class="s0">body </span><span class="s1">=== </span><span class="s3">null</span><span class="s1">) {</span>
		<span class="s4">// body is null</span>
		<span class="s3">return </span><span class="s5">0</span><span class="s1">;</span>
	<span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s0">isBlob</span><span class="s1">(</span><span class="s0">body</span><span class="s1">)) {</span>
		<span class="s3">return </span><span class="s0">body</span><span class="s1">.</span><span class="s0">size</span><span class="s1">;</span>
	<span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s0">Buffer</span><span class="s1">.</span><span class="s0">isBuffer</span><span class="s1">(</span><span class="s0">body</span><span class="s1">)) {</span>
		<span class="s4">// body is buffer</span>
		<span class="s3">return </span><span class="s0">body</span><span class="s1">.</span><span class="s0">length</span><span class="s1">;</span>
	<span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s0">body </span><span class="s1">&amp;&amp; </span><span class="s3">typeof </span><span class="s0">body</span><span class="s1">.</span><span class="s0">getLengthSync </span><span class="s1">=== </span><span class="s2">'function'</span><span class="s1">) {</span>
		<span class="s4">// detect form data input from form-data module</span>
		<span class="s3">if </span><span class="s1">(</span><span class="s0">body</span><span class="s1">.</span><span class="s0">_lengthRetrievers </span><span class="s1">&amp;&amp; </span><span class="s0">body</span><span class="s1">.</span><span class="s0">_lengthRetrievers</span><span class="s1">.</span><span class="s0">length </span><span class="s1">== </span><span class="s5">0 </span><span class="s1">|| </span><span class="s4">// 1.x</span>
		<span class="s0">body</span><span class="s1">.</span><span class="s0">hasKnownLength </span><span class="s1">&amp;&amp; </span><span class="s0">body</span><span class="s1">.</span><span class="s0">hasKnownLength</span><span class="s1">()) {</span>
			<span class="s4">// 2.x</span>
			<span class="s3">return </span><span class="s0">body</span><span class="s1">.</span><span class="s0">getLengthSync</span><span class="s1">();</span>
		<span class="s1">}</span>
		<span class="s3">return null</span><span class="s1">;</span>
	<span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
		<span class="s4">// body is stream</span>
		<span class="s3">return null</span><span class="s1">;</span>
	<span class="s1">}</span>
<span class="s1">}</span>

<span class="s7">/**</span>
 <span class="s7">* Write a Body to a Node.js WritableStream (e.g. http.Request) object.</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param   </span><span class="s7">Body    instance   Instance of Body</span>
 <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Void</span>
 <span class="s7">*/</span>
<span class="s3">function </span><span class="s0">writeToStream</span><span class="s1">(</span><span class="s0">dest</span><span class="s1">, </span><span class="s0">instance</span><span class="s1">) {</span>
	<span class="s3">const </span><span class="s0">body </span><span class="s1">= </span><span class="s0">instance</span><span class="s1">.</span><span class="s0">body</span><span class="s1">;</span>


	<span class="s3">if </span><span class="s1">(</span><span class="s0">body </span><span class="s1">=== </span><span class="s3">null</span><span class="s1">) {</span>
		<span class="s4">// body is null</span>
		<span class="s0">dest</span><span class="s1">.</span><span class="s0">end</span><span class="s1">();</span>
	<span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s0">isBlob</span><span class="s1">(</span><span class="s0">body</span><span class="s1">)) {</span>
		<span class="s0">body</span><span class="s1">.</span><span class="s0">stream</span><span class="s1">().</span><span class="s0">pipe</span><span class="s1">(</span><span class="s0">dest</span><span class="s1">);</span>
	<span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s0">Buffer</span><span class="s1">.</span><span class="s0">isBuffer</span><span class="s1">(</span><span class="s0">body</span><span class="s1">)) {</span>
		<span class="s4">// body is buffer</span>
		<span class="s0">dest</span><span class="s1">.</span><span class="s0">write</span><span class="s1">(</span><span class="s0">body</span><span class="s1">);</span>
		<span class="s0">dest</span><span class="s1">.</span><span class="s0">end</span><span class="s1">();</span>
	<span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
		<span class="s4">// body is stream</span>
		<span class="s0">body</span><span class="s1">.</span><span class="s0">pipe</span><span class="s1">(</span><span class="s0">dest</span><span class="s1">);</span>
	<span class="s1">}</span>
<span class="s1">}</span>

<span class="s4">// expose Promise</span>
<span class="s0">Body</span><span class="s1">.</span><span class="s0">Promise </span><span class="s1">= </span><span class="s0">global</span><span class="s1">.</span><span class="s0">Promise</span><span class="s1">;</span>

<span class="s7">/**</span>
 <span class="s7">* headers.js</span>
 <span class="s7">*</span>
 <span class="s7">* Headers class offers convenient helpers</span>
 <span class="s7">*/</span>

<span class="s3">const </span><span class="s0">invalidTokenRegex </span><span class="s1">= </span><span class="s6">/[^\^_`a-zA-Z\-0-9!#$%&amp;'*+.|~]/</span><span class="s1">;</span>
<span class="s3">const </span><span class="s0">invalidHeaderCharRegex </span><span class="s1">= </span><span class="s6">/[^\t\x20-\x7e\x80-\xff]/</span><span class="s1">;</span>

<span class="s3">function </span><span class="s0">validateName</span><span class="s1">(</span><span class="s0">name</span><span class="s1">) {</span>
	<span class="s0">name </span><span class="s1">= </span><span class="s2">`</span><span class="s0">$</span><span class="s1">{</span><span class="s0">name</span><span class="s1">}</span><span class="s2">`</span><span class="s1">;</span>
	<span class="s3">if </span><span class="s1">(</span><span class="s0">invalidTokenRegex</span><span class="s1">.</span><span class="s0">test</span><span class="s1">(</span><span class="s0">name</span><span class="s1">) || </span><span class="s0">name </span><span class="s1">=== </span><span class="s2">''</span><span class="s1">) {</span>
		<span class="s3">throw new </span><span class="s0">TypeError</span><span class="s1">(</span><span class="s2">`</span><span class="s0">$</span><span class="s1">{</span><span class="s0">name</span><span class="s1">} </span><span class="s2">is not a legal HTTP header name`</span><span class="s1">);</span>
	<span class="s1">}</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s0">validateValue</span><span class="s1">(</span><span class="s0">value</span><span class="s1">) {</span>
	<span class="s0">value </span><span class="s1">= </span><span class="s2">`</span><span class="s0">$</span><span class="s1">{</span><span class="s0">value</span><span class="s1">}</span><span class="s2">`</span><span class="s1">;</span>
	<span class="s3">if </span><span class="s1">(</span><span class="s0">invalidHeaderCharRegex</span><span class="s1">.</span><span class="s0">test</span><span class="s1">(</span><span class="s0">value</span><span class="s1">)) {</span>
		<span class="s3">throw new </span><span class="s0">TypeError</span><span class="s1">(</span><span class="s2">`</span><span class="s0">$</span><span class="s1">{</span><span class="s0">value</span><span class="s1">} </span><span class="s2">is not a legal HTTP header value`</span><span class="s1">);</span>
	<span class="s1">}</span>
<span class="s1">}</span>

<span class="s7">/**</span>
 <span class="s7">* Find the key in the map object given a header name.</span>
 <span class="s7">*</span>
 <span class="s7">* Returns undefined if not found.</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param   </span><span class="s7">String  name  Header name</span>
 <span class="s7">* </span><span class="s8">@return  </span><span class="s7">String|Undefined</span>
 <span class="s7">*/</span>
<span class="s3">function </span><span class="s0">find</span><span class="s1">(</span><span class="s0">map</span><span class="s1">, </span><span class="s0">name</span><span class="s1">) {</span>
	<span class="s0">name </span><span class="s1">= </span><span class="s0">name</span><span class="s1">.</span><span class="s0">toLowerCase</span><span class="s1">();</span>
	<span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s0">key </span><span class="s3">in </span><span class="s0">map</span><span class="s1">) {</span>
		<span class="s3">if </span><span class="s1">(</span><span class="s0">key</span><span class="s1">.</span><span class="s0">toLowerCase</span><span class="s1">() === </span><span class="s0">name</span><span class="s1">) {</span>
			<span class="s3">return </span><span class="s0">key</span><span class="s1">;</span>
		<span class="s1">}</span>
	<span class="s1">}</span>
	<span class="s3">return </span><span class="s0">undefined</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">const </span><span class="s0">MAP </span><span class="s1">= </span><span class="s0">Symbol</span><span class="s1">(</span><span class="s2">'map'</span><span class="s1">);</span>
<span class="s3">class </span><span class="s0">Headers </span><span class="s1">{</span>
	<span class="s7">/**</span>
  <span class="s7">* Headers class</span>
  <span class="s7">*</span>
  <span class="s7">* </span><span class="s8">@param   </span><span class="s7">Object  headers  Response headers</span>
  <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Void</span>
  <span class="s7">*/</span>
	<span class="s0">constructor</span><span class="s1">() {</span>
		<span class="s3">let </span><span class="s0">init </span><span class="s1">= </span><span class="s0">arguments</span><span class="s1">.</span><span class="s0">length </span><span class="s1">&gt; </span><span class="s5">0 </span><span class="s1">&amp;&amp; </span><span class="s0">arguments</span><span class="s1">[</span><span class="s5">0</span><span class="s1">] !== </span><span class="s0">undefined </span><span class="s1">? </span><span class="s0">arguments</span><span class="s1">[</span><span class="s5">0</span><span class="s1">] : </span><span class="s0">undefined</span><span class="s1">;</span>

		<span class="s3">this</span><span class="s1">[</span><span class="s0">MAP</span><span class="s1">] = </span><span class="s0">Object</span><span class="s1">.</span><span class="s0">create</span><span class="s1">(</span><span class="s3">null</span><span class="s1">);</span>

		<span class="s3">if </span><span class="s1">(</span><span class="s0">init </span><span class="s3">instanceof </span><span class="s0">Headers</span><span class="s1">) {</span>
			<span class="s3">const </span><span class="s0">rawHeaders </span><span class="s1">= </span><span class="s0">init</span><span class="s1">.</span><span class="s0">raw</span><span class="s1">();</span>
			<span class="s3">const </span><span class="s0">headerNames </span><span class="s1">= </span><span class="s0">Object</span><span class="s1">.</span><span class="s0">keys</span><span class="s1">(</span><span class="s0">rawHeaders</span><span class="s1">);</span>

			<span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s0">headerName of headerNames</span><span class="s1">) {</span>
				<span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s0">value of rawHeaders</span><span class="s1">[</span><span class="s0">headerName</span><span class="s1">]) {</span>
					<span class="s3">this</span><span class="s1">.</span><span class="s0">append</span><span class="s1">(</span><span class="s0">headerName</span><span class="s1">, </span><span class="s0">value</span><span class="s1">);</span>
				<span class="s1">}</span>
			<span class="s1">}</span>

			<span class="s3">return</span><span class="s1">;</span>
		<span class="s1">}</span>

		<span class="s4">// We don't worry about converting prop to ByteString here as append()</span>
		<span class="s4">// will handle it.</span>
		<span class="s3">if </span><span class="s1">(</span><span class="s0">init </span><span class="s1">== </span><span class="s3">null</span><span class="s1">) ; </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s0">init </span><span class="s1">=== </span><span class="s2">'object'</span><span class="s1">) {</span>
			<span class="s3">const </span><span class="s0">method </span><span class="s1">= </span><span class="s0">init</span><span class="s1">[</span><span class="s0">Symbol</span><span class="s1">.</span><span class="s0">iterator</span><span class="s1">];</span>
			<span class="s3">if </span><span class="s1">(</span><span class="s0">method </span><span class="s1">!= </span><span class="s3">null</span><span class="s1">) {</span>
				<span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s0">method </span><span class="s1">!== </span><span class="s2">'function'</span><span class="s1">) {</span>
					<span class="s3">throw new </span><span class="s0">TypeError</span><span class="s1">(</span><span class="s2">'Header pairs must be iterable'</span><span class="s1">);</span>
				<span class="s1">}</span>

				<span class="s4">// sequence&lt;sequence&lt;ByteString&gt;&gt;</span>
				<span class="s4">// Note: per spec we have to first exhaust the lists then process them</span>
				<span class="s3">const </span><span class="s0">pairs </span><span class="s1">= [];</span>
				<span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s0">pair of init</span><span class="s1">) {</span>
					<span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s0">pair </span><span class="s1">!== </span><span class="s2">'object' </span><span class="s1">|| </span><span class="s3">typeof </span><span class="s0">pair</span><span class="s1">[</span><span class="s0">Symbol</span><span class="s1">.</span><span class="s0">iterator</span><span class="s1">] !== </span><span class="s2">'function'</span><span class="s1">) {</span>
						<span class="s3">throw new </span><span class="s0">TypeError</span><span class="s1">(</span><span class="s2">'Each header pair must be iterable'</span><span class="s1">);</span>
					<span class="s1">}</span>
					<span class="s0">pairs</span><span class="s1">.</span><span class="s0">push</span><span class="s1">(</span><span class="s0">Array</span><span class="s1">.</span><span class="s0">from</span><span class="s1">(</span><span class="s0">pair</span><span class="s1">));</span>
				<span class="s1">}</span>

				<span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s0">pair of pairs</span><span class="s1">) {</span>
					<span class="s3">if </span><span class="s1">(</span><span class="s0">pair</span><span class="s1">.</span><span class="s0">length </span><span class="s1">!== </span><span class="s5">2</span><span class="s1">) {</span>
						<span class="s3">throw new </span><span class="s0">TypeError</span><span class="s1">(</span><span class="s2">'Each header pair must be a name/value tuple'</span><span class="s1">);</span>
					<span class="s1">}</span>
					<span class="s3">this</span><span class="s1">.</span><span class="s0">append</span><span class="s1">(</span><span class="s0">pair</span><span class="s1">[</span><span class="s5">0</span><span class="s1">], </span><span class="s0">pair</span><span class="s1">[</span><span class="s5">1</span><span class="s1">]);</span>
				<span class="s1">}</span>
			<span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
				<span class="s4">// record&lt;ByteString, ByteString&gt;</span>
				<span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s0">key of Object</span><span class="s1">.</span><span class="s0">keys</span><span class="s1">(</span><span class="s0">init</span><span class="s1">)) {</span>
					<span class="s3">const </span><span class="s0">value </span><span class="s1">= </span><span class="s0">init</span><span class="s1">[</span><span class="s0">key</span><span class="s1">];</span>
					<span class="s3">this</span><span class="s1">.</span><span class="s0">append</span><span class="s1">(</span><span class="s0">key</span><span class="s1">, </span><span class="s0">value</span><span class="s1">);</span>
				<span class="s1">}</span>
			<span class="s1">}</span>
		<span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
			<span class="s3">throw new </span><span class="s0">TypeError</span><span class="s1">(</span><span class="s2">'Provided initializer must be an object'</span><span class="s1">);</span>
		<span class="s1">}</span>
	<span class="s1">}</span>

	<span class="s7">/**</span>
  <span class="s7">* Return combined header value given name</span>
  <span class="s7">*</span>
  <span class="s7">* </span><span class="s8">@param   </span><span class="s7">String  name  Header name</span>
  <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Mixed</span>
  <span class="s7">*/</span>
	<span class="s0">get</span><span class="s1">(</span><span class="s0">name</span><span class="s1">) {</span>
		<span class="s0">name </span><span class="s1">= </span><span class="s2">`</span><span class="s0">$</span><span class="s1">{</span><span class="s0">name</span><span class="s1">}</span><span class="s2">`</span><span class="s1">;</span>
		<span class="s0">validateName</span><span class="s1">(</span><span class="s0">name</span><span class="s1">);</span>
		<span class="s3">const </span><span class="s0">key </span><span class="s1">= </span><span class="s0">find</span><span class="s1">(</span><span class="s3">this</span><span class="s1">[</span><span class="s0">MAP</span><span class="s1">], </span><span class="s0">name</span><span class="s1">);</span>
		<span class="s3">if </span><span class="s1">(</span><span class="s0">key </span><span class="s1">=== </span><span class="s0">undefined</span><span class="s1">) {</span>
			<span class="s3">return null</span><span class="s1">;</span>
		<span class="s1">}</span>

		<span class="s3">return this</span><span class="s1">[</span><span class="s0">MAP</span><span class="s1">][</span><span class="s0">key</span><span class="s1">].</span><span class="s0">join</span><span class="s1">(</span><span class="s2">', '</span><span class="s1">);</span>
	<span class="s1">}</span>

	<span class="s7">/**</span>
  <span class="s7">* Iterate over all headers</span>
  <span class="s7">*</span>
  <span class="s7">* </span><span class="s8">@param   </span><span class="s7">Function  callback  Executed for each item with parameters (value, name, thisArg)</span>
  <span class="s7">* </span><span class="s8">@param   </span><span class="s7">Boolean   thisArg   `this` context for callback function</span>
  <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Void</span>
  <span class="s7">*/</span>
	<span class="s0">forEach</span><span class="s1">(</span><span class="s0">callback</span><span class="s1">) {</span>
		<span class="s3">let </span><span class="s0">thisArg </span><span class="s1">= </span><span class="s0">arguments</span><span class="s1">.</span><span class="s0">length </span><span class="s1">&gt; </span><span class="s5">1 </span><span class="s1">&amp;&amp; </span><span class="s0">arguments</span><span class="s1">[</span><span class="s5">1</span><span class="s1">] !== </span><span class="s0">undefined </span><span class="s1">? </span><span class="s0">arguments</span><span class="s1">[</span><span class="s5">1</span><span class="s1">] : </span><span class="s0">undefined</span><span class="s1">;</span>

		<span class="s3">let </span><span class="s0">pairs </span><span class="s1">= </span><span class="s0">getHeaders</span><span class="s1">(</span><span class="s3">this</span><span class="s1">);</span>
		<span class="s3">let </span><span class="s0">i </span><span class="s1">= </span><span class="s5">0</span><span class="s1">;</span>
		<span class="s3">while </span><span class="s1">(</span><span class="s0">i </span><span class="s1">&lt; </span><span class="s0">pairs</span><span class="s1">.</span><span class="s0">length</span><span class="s1">) {</span>
			<span class="s3">var </span><span class="s0">_pairs$i </span><span class="s1">= </span><span class="s0">pairs</span><span class="s1">[</span><span class="s0">i</span><span class="s1">];</span>
			<span class="s3">const </span><span class="s0">name </span><span class="s1">= </span><span class="s0">_pairs$i</span><span class="s1">[</span><span class="s5">0</span><span class="s1">],</span>
			      <span class="s0">value </span><span class="s1">= </span><span class="s0">_pairs$i</span><span class="s1">[</span><span class="s5">1</span><span class="s1">];</span>

			<span class="s0">callback</span><span class="s1">.</span><span class="s0">call</span><span class="s1">(</span><span class="s0">thisArg</span><span class="s1">, </span><span class="s0">value</span><span class="s1">, </span><span class="s0">name</span><span class="s1">, </span><span class="s3">this</span><span class="s1">);</span>
			<span class="s0">pairs </span><span class="s1">= </span><span class="s0">getHeaders</span><span class="s1">(</span><span class="s3">this</span><span class="s1">);</span>
			<span class="s0">i</span><span class="s1">++;</span>
		<span class="s1">}</span>
	<span class="s1">}</span>

	<span class="s7">/**</span>
  <span class="s7">* Overwrite header values given name</span>
  <span class="s7">*</span>
  <span class="s7">* </span><span class="s8">@param   </span><span class="s7">String  name   Header name</span>
  <span class="s7">* </span><span class="s8">@param   </span><span class="s7">String  value  Header value</span>
  <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Void</span>
  <span class="s7">*/</span>
	<span class="s0">set</span><span class="s1">(</span><span class="s0">name</span><span class="s1">, </span><span class="s0">value</span><span class="s1">) {</span>
		<span class="s0">name </span><span class="s1">= </span><span class="s2">`</span><span class="s0">$</span><span class="s1">{</span><span class="s0">name</span><span class="s1">}</span><span class="s2">`</span><span class="s1">;</span>
		<span class="s0">value </span><span class="s1">= </span><span class="s2">`</span><span class="s0">$</span><span class="s1">{</span><span class="s0">value</span><span class="s1">}</span><span class="s2">`</span><span class="s1">;</span>
		<span class="s0">validateName</span><span class="s1">(</span><span class="s0">name</span><span class="s1">);</span>
		<span class="s0">validateValue</span><span class="s1">(</span><span class="s0">value</span><span class="s1">);</span>
		<span class="s3">const </span><span class="s0">key </span><span class="s1">= </span><span class="s0">find</span><span class="s1">(</span><span class="s3">this</span><span class="s1">[</span><span class="s0">MAP</span><span class="s1">], </span><span class="s0">name</span><span class="s1">);</span>
		<span class="s3">this</span><span class="s1">[</span><span class="s0">MAP</span><span class="s1">][</span><span class="s0">key </span><span class="s1">!== </span><span class="s0">undefined </span><span class="s1">? </span><span class="s0">key </span><span class="s1">: </span><span class="s0">name</span><span class="s1">] = [</span><span class="s0">value</span><span class="s1">];</span>
	<span class="s1">}</span>

	<span class="s7">/**</span>
  <span class="s7">* Append a value onto existing header</span>
  <span class="s7">*</span>
  <span class="s7">* </span><span class="s8">@param   </span><span class="s7">String  name   Header name</span>
  <span class="s7">* </span><span class="s8">@param   </span><span class="s7">String  value  Header value</span>
  <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Void</span>
  <span class="s7">*/</span>
	<span class="s0">append</span><span class="s1">(</span><span class="s0">name</span><span class="s1">, </span><span class="s0">value</span><span class="s1">) {</span>
		<span class="s0">name </span><span class="s1">= </span><span class="s2">`</span><span class="s0">$</span><span class="s1">{</span><span class="s0">name</span><span class="s1">}</span><span class="s2">`</span><span class="s1">;</span>
		<span class="s0">value </span><span class="s1">= </span><span class="s2">`</span><span class="s0">$</span><span class="s1">{</span><span class="s0">value</span><span class="s1">}</span><span class="s2">`</span><span class="s1">;</span>
		<span class="s0">validateName</span><span class="s1">(</span><span class="s0">name</span><span class="s1">);</span>
		<span class="s0">validateValue</span><span class="s1">(</span><span class="s0">value</span><span class="s1">);</span>
		<span class="s3">const </span><span class="s0">key </span><span class="s1">= </span><span class="s0">find</span><span class="s1">(</span><span class="s3">this</span><span class="s1">[</span><span class="s0">MAP</span><span class="s1">], </span><span class="s0">name</span><span class="s1">);</span>
		<span class="s3">if </span><span class="s1">(</span><span class="s0">key </span><span class="s1">!== </span><span class="s0">undefined</span><span class="s1">) {</span>
			<span class="s3">this</span><span class="s1">[</span><span class="s0">MAP</span><span class="s1">][</span><span class="s0">key</span><span class="s1">].</span><span class="s0">push</span><span class="s1">(</span><span class="s0">value</span><span class="s1">);</span>
		<span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
			<span class="s3">this</span><span class="s1">[</span><span class="s0">MAP</span><span class="s1">][</span><span class="s0">name</span><span class="s1">] = [</span><span class="s0">value</span><span class="s1">];</span>
		<span class="s1">}</span>
	<span class="s1">}</span>

	<span class="s7">/**</span>
  <span class="s7">* Check for header name existence</span>
  <span class="s7">*</span>
  <span class="s7">* </span><span class="s8">@param   </span><span class="s7">String   name  Header name</span>
  <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Boolean</span>
  <span class="s7">*/</span>
	<span class="s0">has</span><span class="s1">(</span><span class="s0">name</span><span class="s1">) {</span>
		<span class="s0">name </span><span class="s1">= </span><span class="s2">`</span><span class="s0">$</span><span class="s1">{</span><span class="s0">name</span><span class="s1">}</span><span class="s2">`</span><span class="s1">;</span>
		<span class="s0">validateName</span><span class="s1">(</span><span class="s0">name</span><span class="s1">);</span>
		<span class="s3">return </span><span class="s0">find</span><span class="s1">(</span><span class="s3">this</span><span class="s1">[</span><span class="s0">MAP</span><span class="s1">], </span><span class="s0">name</span><span class="s1">) !== </span><span class="s0">undefined</span><span class="s1">;</span>
	<span class="s1">}</span>

	<span class="s7">/**</span>
  <span class="s7">* Delete all header values given name</span>
  <span class="s7">*</span>
  <span class="s7">* </span><span class="s8">@param   </span><span class="s7">String  name  Header name</span>
  <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Void</span>
  <span class="s7">*/</span>
	<span class="s3">delete</span><span class="s1">(</span><span class="s0">name</span><span class="s1">) {</span>
		<span class="s0">name </span><span class="s1">= </span><span class="s2">`</span><span class="s0">$</span><span class="s1">{</span><span class="s0">name</span><span class="s1">}</span><span class="s2">`</span><span class="s1">;</span>
		<span class="s0">validateName</span><span class="s1">(</span><span class="s0">name</span><span class="s1">);</span>
		<span class="s3">const </span><span class="s0">key </span><span class="s1">= </span><span class="s0">find</span><span class="s1">(</span><span class="s3">this</span><span class="s1">[</span><span class="s0">MAP</span><span class="s1">], </span><span class="s0">name</span><span class="s1">);</span>
		<span class="s3">if </span><span class="s1">(</span><span class="s0">key </span><span class="s1">!== </span><span class="s0">undefined</span><span class="s1">) {</span>
			<span class="s3">delete this</span><span class="s1">[</span><span class="s0">MAP</span><span class="s1">][</span><span class="s0">key</span><span class="s1">];</span>
		<span class="s1">}</span>
	<span class="s1">}</span>

	<span class="s7">/**</span>
  <span class="s7">* Return raw headers (non-spec api)</span>
  <span class="s7">*</span>
  <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Object</span>
  <span class="s7">*/</span>
	<span class="s0">raw</span><span class="s1">() {</span>
		<span class="s3">return this</span><span class="s1">[</span><span class="s0">MAP</span><span class="s1">];</span>
	<span class="s1">}</span>

	<span class="s7">/**</span>
  <span class="s7">* Get an iterator on keys.</span>
  <span class="s7">*</span>
  <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Iterator</span>
  <span class="s7">*/</span>
	<span class="s0">keys</span><span class="s1">() {</span>
		<span class="s3">return </span><span class="s0">createHeadersIterator</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s2">'key'</span><span class="s1">);</span>
	<span class="s1">}</span>

	<span class="s7">/**</span>
  <span class="s7">* Get an iterator on values.</span>
  <span class="s7">*</span>
  <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Iterator</span>
  <span class="s7">*/</span>
	<span class="s0">values</span><span class="s1">() {</span>
		<span class="s3">return </span><span class="s0">createHeadersIterator</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s2">'value'</span><span class="s1">);</span>
	<span class="s1">}</span>

	<span class="s7">/**</span>
  <span class="s7">* Get an iterator on entries.</span>
  <span class="s7">*</span>
  <span class="s7">* This is the default iterator of the Headers object.</span>
  <span class="s7">*</span>
  <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Iterator</span>
  <span class="s7">*/</span>
	<span class="s1">[</span><span class="s0">Symbol</span><span class="s1">.</span><span class="s0">iterator</span><span class="s1">]() {</span>
		<span class="s3">return </span><span class="s0">createHeadersIterator</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s2">'key+value'</span><span class="s1">);</span>
	<span class="s1">}</span>
<span class="s1">}</span>
<span class="s0">Headers</span><span class="s1">.</span><span class="s0">prototype</span><span class="s1">.</span><span class="s0">entries </span><span class="s1">= </span><span class="s0">Headers</span><span class="s1">.</span><span class="s0">prototype</span><span class="s1">[</span><span class="s0">Symbol</span><span class="s1">.</span><span class="s0">iterator</span><span class="s1">];</span>

<span class="s0">Object</span><span class="s1">.</span><span class="s0">defineProperty</span><span class="s1">(</span><span class="s0">Headers</span><span class="s1">.</span><span class="s0">prototype</span><span class="s1">, </span><span class="s0">Symbol</span><span class="s1">.</span><span class="s0">toStringTag</span><span class="s1">, {</span>
	<span class="s0">value</span><span class="s1">: </span><span class="s2">'Headers'</span><span class="s1">,</span>
	<span class="s0">writable</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
	<span class="s0">enumerable</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
	<span class="s0">configurable</span><span class="s1">: </span><span class="s3">true</span>
<span class="s1">});</span>

<span class="s0">Object</span><span class="s1">.</span><span class="s0">defineProperties</span><span class="s1">(</span><span class="s0">Headers</span><span class="s1">.</span><span class="s0">prototype</span><span class="s1">, {</span>
	<span class="s0">get</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">},</span>
	<span class="s0">forEach</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">},</span>
	<span class="s0">set</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">},</span>
	<span class="s0">append</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">},</span>
	<span class="s0">has</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">},</span>
	<span class="s3">delete</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">},</span>
	<span class="s0">keys</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">},</span>
	<span class="s0">values</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">},</span>
	<span class="s0">entries</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">}</span>
<span class="s1">});</span>

<span class="s3">function </span><span class="s0">getHeaders</span><span class="s1">(</span><span class="s0">headers</span><span class="s1">) {</span>
	<span class="s3">let </span><span class="s0">kind </span><span class="s1">= </span><span class="s0">arguments</span><span class="s1">.</span><span class="s0">length </span><span class="s1">&gt; </span><span class="s5">1 </span><span class="s1">&amp;&amp; </span><span class="s0">arguments</span><span class="s1">[</span><span class="s5">1</span><span class="s1">] !== </span><span class="s0">undefined </span><span class="s1">? </span><span class="s0">arguments</span><span class="s1">[</span><span class="s5">1</span><span class="s1">] : </span><span class="s2">'key+value'</span><span class="s1">;</span>

	<span class="s3">const </span><span class="s0">keys </span><span class="s1">= </span><span class="s0">Object</span><span class="s1">.</span><span class="s0">keys</span><span class="s1">(</span><span class="s0">headers</span><span class="s1">[</span><span class="s0">MAP</span><span class="s1">]).</span><span class="s0">sort</span><span class="s1">();</span>
	<span class="s3">return </span><span class="s0">keys</span><span class="s1">.</span><span class="s0">map</span><span class="s1">(</span><span class="s0">kind </span><span class="s1">=== </span><span class="s2">'key' </span><span class="s1">? </span><span class="s3">function </span><span class="s1">(</span><span class="s0">k</span><span class="s1">) {</span>
		<span class="s3">return </span><span class="s0">k</span><span class="s1">.</span><span class="s0">toLowerCase</span><span class="s1">();</span>
	<span class="s1">} : </span><span class="s0">kind </span><span class="s1">=== </span><span class="s2">'value' </span><span class="s1">? </span><span class="s3">function </span><span class="s1">(</span><span class="s0">k</span><span class="s1">) {</span>
		<span class="s3">return </span><span class="s0">headers</span><span class="s1">[</span><span class="s0">MAP</span><span class="s1">][</span><span class="s0">k</span><span class="s1">].</span><span class="s0">join</span><span class="s1">(</span><span class="s2">', '</span><span class="s1">);</span>
	<span class="s1">} : </span><span class="s3">function </span><span class="s1">(</span><span class="s0">k</span><span class="s1">) {</span>
		<span class="s3">return </span><span class="s1">[</span><span class="s0">k</span><span class="s1">.</span><span class="s0">toLowerCase</span><span class="s1">(), </span><span class="s0">headers</span><span class="s1">[</span><span class="s0">MAP</span><span class="s1">][</span><span class="s0">k</span><span class="s1">].</span><span class="s0">join</span><span class="s1">(</span><span class="s2">', '</span><span class="s1">)];</span>
	<span class="s1">});</span>
<span class="s1">}</span>

<span class="s3">const </span><span class="s0">INTERNAL </span><span class="s1">= </span><span class="s0">Symbol</span><span class="s1">(</span><span class="s2">'internal'</span><span class="s1">);</span>

<span class="s3">function </span><span class="s0">createHeadersIterator</span><span class="s1">(</span><span class="s0">target</span><span class="s1">, </span><span class="s0">kind</span><span class="s1">) {</span>
	<span class="s3">const </span><span class="s0">iterator </span><span class="s1">= </span><span class="s0">Object</span><span class="s1">.</span><span class="s0">create</span><span class="s1">(</span><span class="s0">HeadersIteratorPrototype</span><span class="s1">);</span>
	<span class="s0">iterator</span><span class="s1">[</span><span class="s0">INTERNAL</span><span class="s1">] = {</span>
		<span class="s0">target</span><span class="s1">,</span>
		<span class="s0">kind</span><span class="s1">,</span>
		<span class="s0">index</span><span class="s1">: </span><span class="s5">0</span>
	<span class="s1">};</span>
	<span class="s3">return </span><span class="s0">iterator</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">const </span><span class="s0">HeadersIteratorPrototype </span><span class="s1">= </span><span class="s0">Object</span><span class="s1">.</span><span class="s0">setPrototypeOf</span><span class="s1">({</span>
	<span class="s0">next</span><span class="s1">() {</span>
		<span class="s4">// istanbul ignore if</span>
		<span class="s3">if </span><span class="s1">(!</span><span class="s3">this </span><span class="s1">|| </span><span class="s0">Object</span><span class="s1">.</span><span class="s0">getPrototypeOf</span><span class="s1">(</span><span class="s3">this</span><span class="s1">) !== </span><span class="s0">HeadersIteratorPrototype</span><span class="s1">) {</span>
			<span class="s3">throw new </span><span class="s0">TypeError</span><span class="s1">(</span><span class="s2">'Value of `this` is not a HeadersIterator'</span><span class="s1">);</span>
		<span class="s1">}</span>

		<span class="s3">var </span><span class="s0">_INTERNAL </span><span class="s1">= </span><span class="s3">this</span><span class="s1">[</span><span class="s0">INTERNAL</span><span class="s1">];</span>
		<span class="s3">const </span><span class="s0">target </span><span class="s1">= </span><span class="s0">_INTERNAL</span><span class="s1">.</span><span class="s0">target</span><span class="s1">,</span>
		      <span class="s0">kind </span><span class="s1">= </span><span class="s0">_INTERNAL</span><span class="s1">.</span><span class="s0">kind</span><span class="s1">,</span>
		      <span class="s0">index </span><span class="s1">= </span><span class="s0">_INTERNAL</span><span class="s1">.</span><span class="s0">index</span><span class="s1">;</span>

		<span class="s3">const </span><span class="s0">values </span><span class="s1">= </span><span class="s0">getHeaders</span><span class="s1">(</span><span class="s0">target</span><span class="s1">, </span><span class="s0">kind</span><span class="s1">);</span>
		<span class="s3">const </span><span class="s0">len </span><span class="s1">= </span><span class="s0">values</span><span class="s1">.</span><span class="s0">length</span><span class="s1">;</span>
		<span class="s3">if </span><span class="s1">(</span><span class="s0">index </span><span class="s1">&gt;= </span><span class="s0">len</span><span class="s1">) {</span>
			<span class="s3">return </span><span class="s1">{</span>
				<span class="s0">value</span><span class="s1">: </span><span class="s0">undefined</span><span class="s1">,</span>
				<span class="s0">done</span><span class="s1">: </span><span class="s3">true</span>
			<span class="s1">};</span>
		<span class="s1">}</span>

		<span class="s3">this</span><span class="s1">[</span><span class="s0">INTERNAL</span><span class="s1">].</span><span class="s0">index </span><span class="s1">= </span><span class="s0">index </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">;</span>

		<span class="s3">return </span><span class="s1">{</span>
			<span class="s0">value</span><span class="s1">: </span><span class="s0">values</span><span class="s1">[</span><span class="s0">index</span><span class="s1">],</span>
			<span class="s0">done</span><span class="s1">: </span><span class="s3">false</span>
		<span class="s1">};</span>
	<span class="s1">}</span>
<span class="s1">}, </span><span class="s0">Object</span><span class="s1">.</span><span class="s0">getPrototypeOf</span><span class="s1">(</span><span class="s0">Object</span><span class="s1">.</span><span class="s0">getPrototypeOf</span><span class="s1">([][</span><span class="s0">Symbol</span><span class="s1">.</span><span class="s0">iterator</span><span class="s1">]())));</span>

<span class="s0">Object</span><span class="s1">.</span><span class="s0">defineProperty</span><span class="s1">(</span><span class="s0">HeadersIteratorPrototype</span><span class="s1">, </span><span class="s0">Symbol</span><span class="s1">.</span><span class="s0">toStringTag</span><span class="s1">, {</span>
	<span class="s0">value</span><span class="s1">: </span><span class="s2">'HeadersIterator'</span><span class="s1">,</span>
	<span class="s0">writable</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
	<span class="s0">enumerable</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
	<span class="s0">configurable</span><span class="s1">: </span><span class="s3">true</span>
<span class="s1">});</span>

<span class="s7">/**</span>
 <span class="s7">* Export the Headers object in a form that Node.js can consume.</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param   </span><span class="s7">Headers  headers</span>
 <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Object</span>
 <span class="s7">*/</span>
<span class="s3">function </span><span class="s0">exportNodeCompatibleHeaders</span><span class="s1">(</span><span class="s0">headers</span><span class="s1">) {</span>
	<span class="s3">const </span><span class="s0">obj </span><span class="s1">= </span><span class="s0">Object</span><span class="s1">.</span><span class="s0">assign</span><span class="s1">({ </span><span class="s0">__proto__</span><span class="s1">: </span><span class="s3">null </span><span class="s1">}, </span><span class="s0">headers</span><span class="s1">[</span><span class="s0">MAP</span><span class="s1">]);</span>

	<span class="s4">// http.request() only supports string as Host header. This hack makes</span>
	<span class="s4">// specifying custom Host header possible.</span>
	<span class="s3">const </span><span class="s0">hostHeaderKey </span><span class="s1">= </span><span class="s0">find</span><span class="s1">(</span><span class="s0">headers</span><span class="s1">[</span><span class="s0">MAP</span><span class="s1">], </span><span class="s2">'Host'</span><span class="s1">);</span>
	<span class="s3">if </span><span class="s1">(</span><span class="s0">hostHeaderKey </span><span class="s1">!== </span><span class="s0">undefined</span><span class="s1">) {</span>
		<span class="s0">obj</span><span class="s1">[</span><span class="s0">hostHeaderKey</span><span class="s1">] = </span><span class="s0">obj</span><span class="s1">[</span><span class="s0">hostHeaderKey</span><span class="s1">][</span><span class="s5">0</span><span class="s1">];</span>
	<span class="s1">}</span>

	<span class="s3">return </span><span class="s0">obj</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s7">/**</span>
 <span class="s7">* Create a Headers object from an object of headers, ignoring those that do</span>
 <span class="s7">* not conform to HTTP grammar productions.</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param   </span><span class="s7">Object  obj  Object of headers</span>
 <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Headers</span>
 <span class="s7">*/</span>
<span class="s3">function </span><span class="s0">createHeadersLenient</span><span class="s1">(</span><span class="s0">obj</span><span class="s1">) {</span>
	<span class="s3">const </span><span class="s0">headers </span><span class="s1">= </span><span class="s3">new </span><span class="s0">Headers</span><span class="s1">();</span>
	<span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s0">name of Object</span><span class="s1">.</span><span class="s0">keys</span><span class="s1">(</span><span class="s0">obj</span><span class="s1">)) {</span>
		<span class="s3">if </span><span class="s1">(</span><span class="s0">invalidTokenRegex</span><span class="s1">.</span><span class="s0">test</span><span class="s1">(</span><span class="s0">name</span><span class="s1">)) {</span>
			<span class="s3">continue</span><span class="s1">;</span>
		<span class="s1">}</span>
		<span class="s3">if </span><span class="s1">(</span><span class="s0">Array</span><span class="s1">.</span><span class="s0">isArray</span><span class="s1">(</span><span class="s0">obj</span><span class="s1">[</span><span class="s0">name</span><span class="s1">])) {</span>
			<span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s0">val of obj</span><span class="s1">[</span><span class="s0">name</span><span class="s1">]) {</span>
				<span class="s3">if </span><span class="s1">(</span><span class="s0">invalidHeaderCharRegex</span><span class="s1">.</span><span class="s0">test</span><span class="s1">(</span><span class="s0">val</span><span class="s1">)) {</span>
					<span class="s3">continue</span><span class="s1">;</span>
				<span class="s1">}</span>
				<span class="s3">if </span><span class="s1">(</span><span class="s0">headers</span><span class="s1">[</span><span class="s0">MAP</span><span class="s1">][</span><span class="s0">name</span><span class="s1">] === </span><span class="s0">undefined</span><span class="s1">) {</span>
					<span class="s0">headers</span><span class="s1">[</span><span class="s0">MAP</span><span class="s1">][</span><span class="s0">name</span><span class="s1">] = [</span><span class="s0">val</span><span class="s1">];</span>
				<span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
					<span class="s0">headers</span><span class="s1">[</span><span class="s0">MAP</span><span class="s1">][</span><span class="s0">name</span><span class="s1">].</span><span class="s0">push</span><span class="s1">(</span><span class="s0">val</span><span class="s1">);</span>
				<span class="s1">}</span>
			<span class="s1">}</span>
		<span class="s1">} </span><span class="s3">else if </span><span class="s1">(!</span><span class="s0">invalidHeaderCharRegex</span><span class="s1">.</span><span class="s0">test</span><span class="s1">(</span><span class="s0">obj</span><span class="s1">[</span><span class="s0">name</span><span class="s1">])) {</span>
			<span class="s0">headers</span><span class="s1">[</span><span class="s0">MAP</span><span class="s1">][</span><span class="s0">name</span><span class="s1">] = [</span><span class="s0">obj</span><span class="s1">[</span><span class="s0">name</span><span class="s1">]];</span>
		<span class="s1">}</span>
	<span class="s1">}</span>
	<span class="s3">return </span><span class="s0">headers</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">const </span><span class="s0">INTERNALS$1 </span><span class="s1">= </span><span class="s0">Symbol</span><span class="s1">(</span><span class="s2">'Response internals'</span><span class="s1">);</span>

<span class="s4">// fix an issue where &quot;STATUS_CODES&quot; aren't a named export for node &lt;10</span>
<span class="s3">const </span><span class="s0">STATUS_CODES </span><span class="s1">= </span><span class="s0">http</span><span class="s1">.</span><span class="s0">STATUS_CODES</span><span class="s1">;</span>

<span class="s7">/**</span>
 <span class="s7">* Response class</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param   </span><span class="s7">Stream  body  Readable stream</span>
 <span class="s7">* </span><span class="s8">@param   </span><span class="s7">Object  opts  Response options</span>
 <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Void</span>
 <span class="s7">*/</span>
<span class="s3">class </span><span class="s0">Response </span><span class="s1">{</span>
	<span class="s0">constructor</span><span class="s1">() {</span>
		<span class="s3">let </span><span class="s0">body </span><span class="s1">= </span><span class="s0">arguments</span><span class="s1">.</span><span class="s0">length </span><span class="s1">&gt; </span><span class="s5">0 </span><span class="s1">&amp;&amp; </span><span class="s0">arguments</span><span class="s1">[</span><span class="s5">0</span><span class="s1">] !== </span><span class="s0">undefined </span><span class="s1">? </span><span class="s0">arguments</span><span class="s1">[</span><span class="s5">0</span><span class="s1">] : </span><span class="s3">null</span><span class="s1">;</span>
		<span class="s3">let </span><span class="s0">opts </span><span class="s1">= </span><span class="s0">arguments</span><span class="s1">.</span><span class="s0">length </span><span class="s1">&gt; </span><span class="s5">1 </span><span class="s1">&amp;&amp; </span><span class="s0">arguments</span><span class="s1">[</span><span class="s5">1</span><span class="s1">] !== </span><span class="s0">undefined </span><span class="s1">? </span><span class="s0">arguments</span><span class="s1">[</span><span class="s5">1</span><span class="s1">] : {};</span>

		<span class="s0">Body</span><span class="s1">.</span><span class="s0">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s0">body</span><span class="s1">, </span><span class="s0">opts</span><span class="s1">);</span>

		<span class="s3">const </span><span class="s0">status </span><span class="s1">= </span><span class="s0">opts</span><span class="s1">.</span><span class="s0">status </span><span class="s1">|| </span><span class="s5">200</span><span class="s1">;</span>
		<span class="s3">const </span><span class="s0">headers </span><span class="s1">= </span><span class="s3">new </span><span class="s0">Headers</span><span class="s1">(</span><span class="s0">opts</span><span class="s1">.</span><span class="s0">headers</span><span class="s1">);</span>

		<span class="s3">if </span><span class="s1">(</span><span class="s0">body </span><span class="s1">!= </span><span class="s3">null </span><span class="s1">&amp;&amp; !</span><span class="s0">headers</span><span class="s1">.</span><span class="s0">has</span><span class="s1">(</span><span class="s2">'Content-Type'</span><span class="s1">)) {</span>
			<span class="s3">const </span><span class="s0">contentType </span><span class="s1">= </span><span class="s0">extractContentType</span><span class="s1">(</span><span class="s0">body</span><span class="s1">);</span>
			<span class="s3">if </span><span class="s1">(</span><span class="s0">contentType</span><span class="s1">) {</span>
				<span class="s0">headers</span><span class="s1">.</span><span class="s0">append</span><span class="s1">(</span><span class="s2">'Content-Type'</span><span class="s1">, </span><span class="s0">contentType</span><span class="s1">);</span>
			<span class="s1">}</span>
		<span class="s1">}</span>

		<span class="s3">this</span><span class="s1">[</span><span class="s0">INTERNALS$1</span><span class="s1">] = {</span>
			<span class="s0">url</span><span class="s1">: </span><span class="s0">opts</span><span class="s1">.</span><span class="s0">url</span><span class="s1">,</span>
			<span class="s0">status</span><span class="s1">,</span>
			<span class="s0">statusText</span><span class="s1">: </span><span class="s0">opts</span><span class="s1">.</span><span class="s0">statusText </span><span class="s1">|| </span><span class="s0">STATUS_CODES</span><span class="s1">[</span><span class="s0">status</span><span class="s1">],</span>
			<span class="s0">headers</span><span class="s1">,</span>
			<span class="s0">counter</span><span class="s1">: </span><span class="s0">opts</span><span class="s1">.</span><span class="s0">counter</span>
		<span class="s1">};</span>
	<span class="s1">}</span>

	<span class="s0">get url</span><span class="s1">() {</span>
		<span class="s3">return this</span><span class="s1">[</span><span class="s0">INTERNALS$1</span><span class="s1">].</span><span class="s0">url </span><span class="s1">|| </span><span class="s2">''</span><span class="s1">;</span>
	<span class="s1">}</span>

	<span class="s0">get status</span><span class="s1">() {</span>
		<span class="s3">return this</span><span class="s1">[</span><span class="s0">INTERNALS$1</span><span class="s1">].</span><span class="s0">status</span><span class="s1">;</span>
	<span class="s1">}</span>

	<span class="s7">/**</span>
  <span class="s7">* Convenience property representing if the request ended normally</span>
  <span class="s7">*/</span>
	<span class="s0">get ok</span><span class="s1">() {</span>
		<span class="s3">return this</span><span class="s1">[</span><span class="s0">INTERNALS$1</span><span class="s1">].</span><span class="s0">status </span><span class="s1">&gt;= </span><span class="s5">200 </span><span class="s1">&amp;&amp; </span><span class="s3">this</span><span class="s1">[</span><span class="s0">INTERNALS$1</span><span class="s1">].</span><span class="s0">status </span><span class="s1">&lt; </span><span class="s5">300</span><span class="s1">;</span>
	<span class="s1">}</span>

	<span class="s0">get redirected</span><span class="s1">() {</span>
		<span class="s3">return this</span><span class="s1">[</span><span class="s0">INTERNALS$1</span><span class="s1">].</span><span class="s0">counter </span><span class="s1">&gt; </span><span class="s5">0</span><span class="s1">;</span>
	<span class="s1">}</span>

	<span class="s0">get statusText</span><span class="s1">() {</span>
		<span class="s3">return this</span><span class="s1">[</span><span class="s0">INTERNALS$1</span><span class="s1">].</span><span class="s0">statusText</span><span class="s1">;</span>
	<span class="s1">}</span>

	<span class="s0">get headers</span><span class="s1">() {</span>
		<span class="s3">return this</span><span class="s1">[</span><span class="s0">INTERNALS$1</span><span class="s1">].</span><span class="s0">headers</span><span class="s1">;</span>
	<span class="s1">}</span>

	<span class="s7">/**</span>
  <span class="s7">* Clone this response</span>
  <span class="s7">*</span>
  <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Response</span>
  <span class="s7">*/</span>
	<span class="s0">clone</span><span class="s1">() {</span>
		<span class="s3">return new </span><span class="s0">Response</span><span class="s1">(</span><span class="s0">clone</span><span class="s1">(</span><span class="s3">this</span><span class="s1">), {</span>
			<span class="s0">url</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s0">url</span><span class="s1">,</span>
			<span class="s0">status</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s0">status</span><span class="s1">,</span>
			<span class="s0">statusText</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s0">statusText</span><span class="s1">,</span>
			<span class="s0">headers</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s0">headers</span><span class="s1">,</span>
			<span class="s0">ok</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s0">ok</span><span class="s1">,</span>
			<span class="s0">redirected</span><span class="s1">: </span><span class="s3">this</span><span class="s1">.</span><span class="s0">redirected</span>
		<span class="s1">});</span>
	<span class="s1">}</span>
<span class="s1">}</span>

<span class="s0">Body</span><span class="s1">.</span><span class="s0">mixIn</span><span class="s1">(</span><span class="s0">Response</span><span class="s1">.</span><span class="s0">prototype</span><span class="s1">);</span>

<span class="s0">Object</span><span class="s1">.</span><span class="s0">defineProperties</span><span class="s1">(</span><span class="s0">Response</span><span class="s1">.</span><span class="s0">prototype</span><span class="s1">, {</span>
	<span class="s0">url</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">},</span>
	<span class="s0">status</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">},</span>
	<span class="s0">ok</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">},</span>
	<span class="s0">redirected</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">},</span>
	<span class="s0">statusText</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">},</span>
	<span class="s0">headers</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">},</span>
	<span class="s0">clone</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">}</span>
<span class="s1">});</span>

<span class="s0">Object</span><span class="s1">.</span><span class="s0">defineProperty</span><span class="s1">(</span><span class="s0">Response</span><span class="s1">.</span><span class="s0">prototype</span><span class="s1">, </span><span class="s0">Symbol</span><span class="s1">.</span><span class="s0">toStringTag</span><span class="s1">, {</span>
	<span class="s0">value</span><span class="s1">: </span><span class="s2">'Response'</span><span class="s1">,</span>
	<span class="s0">writable</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
	<span class="s0">enumerable</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
	<span class="s0">configurable</span><span class="s1">: </span><span class="s3">true</span>
<span class="s1">});</span>

<span class="s3">const </span><span class="s0">INTERNALS$2 </span><span class="s1">= </span><span class="s0">Symbol</span><span class="s1">(</span><span class="s2">'Request internals'</span><span class="s1">);</span>
<span class="s3">const </span><span class="s0">URL </span><span class="s1">= </span><span class="s0">Url</span><span class="s1">.</span><span class="s0">URL </span><span class="s1">|| </span><span class="s0">whatwgUrl</span><span class="s1">.</span><span class="s0">URL</span><span class="s1">;</span>

<span class="s4">// fix an issue where &quot;format&quot;, &quot;parse&quot; aren't a named export for node &lt;10</span>
<span class="s3">const </span><span class="s0">parse_url </span><span class="s1">= </span><span class="s0">Url</span><span class="s1">.</span><span class="s0">parse</span><span class="s1">;</span>
<span class="s3">const </span><span class="s0">format_url </span><span class="s1">= </span><span class="s0">Url</span><span class="s1">.</span><span class="s0">format</span><span class="s1">;</span>

<span class="s7">/**</span>
 <span class="s7">* Wrapper around `new URL` to handle arbitrary URLs</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param  </span><span class="s7">{string} urlStr</span>
 <span class="s7">* </span><span class="s8">@return </span><span class="s7">{void}</span>
 <span class="s7">*/</span>
<span class="s3">function </span><span class="s0">parseURL</span><span class="s1">(</span><span class="s0">urlStr</span><span class="s1">) {</span>
	<span class="s4">/* 
    Check whether the URL is absolute or not 
        Scheme: https://tools.ietf.org/html/rfc3986#section-3.1 
    Absolute URL: https://tools.ietf.org/html/rfc3986#section-4.3 
 */</span>
	<span class="s3">if </span><span class="s1">(</span><span class="s6">/^[a-zA-Z][a-zA-Z\d+\-.]*:/</span><span class="s1">.</span><span class="s0">exec</span><span class="s1">(</span><span class="s0">urlStr</span><span class="s1">)) {</span>
		<span class="s0">urlStr </span><span class="s1">= </span><span class="s3">new </span><span class="s0">URL</span><span class="s1">(</span><span class="s0">urlStr</span><span class="s1">).</span><span class="s0">toString</span><span class="s1">();</span>
	<span class="s1">}</span>

	<span class="s4">// Fallback to old implementation for arbitrary URLs</span>
	<span class="s3">return </span><span class="s0">parse_url</span><span class="s1">(</span><span class="s0">urlStr</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s3">const </span><span class="s0">streamDestructionSupported </span><span class="s1">= </span><span class="s2">'destroy' </span><span class="s3">in </span><span class="s0">Stream</span><span class="s1">.</span><span class="s0">Readable</span><span class="s1">.</span><span class="s0">prototype</span><span class="s1">;</span>

<span class="s7">/**</span>
 <span class="s7">* Check if a value is an instance of Request.</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param   </span><span class="s7">Mixed   input</span>
 <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Boolean</span>
 <span class="s7">*/</span>
<span class="s3">function </span><span class="s0">isRequest</span><span class="s1">(</span><span class="s0">input</span><span class="s1">) {</span>
	<span class="s3">return typeof </span><span class="s0">input </span><span class="s1">=== </span><span class="s2">'object' </span><span class="s1">&amp;&amp; </span><span class="s3">typeof </span><span class="s0">input</span><span class="s1">[</span><span class="s0">INTERNALS$2</span><span class="s1">] === </span><span class="s2">'object'</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s0">isAbortSignal</span><span class="s1">(</span><span class="s0">signal</span><span class="s1">) {</span>
	<span class="s3">const </span><span class="s0">proto </span><span class="s1">= </span><span class="s0">signal </span><span class="s1">&amp;&amp; </span><span class="s3">typeof </span><span class="s0">signal </span><span class="s1">=== </span><span class="s2">'object' </span><span class="s1">&amp;&amp; </span><span class="s0">Object</span><span class="s1">.</span><span class="s0">getPrototypeOf</span><span class="s1">(</span><span class="s0">signal</span><span class="s1">);</span>
	<span class="s3">return </span><span class="s1">!!(</span><span class="s0">proto </span><span class="s1">&amp;&amp; </span><span class="s0">proto</span><span class="s1">.</span><span class="s0">constructor</span><span class="s1">.</span><span class="s0">name </span><span class="s1">=== </span><span class="s2">'AbortSignal'</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s7">/**</span>
 <span class="s7">* Request class</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param   </span><span class="s7">Mixed   input  Url or Request instance</span>
 <span class="s7">* </span><span class="s8">@param   </span><span class="s7">Object  init   Custom options</span>
 <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Void</span>
 <span class="s7">*/</span>
<span class="s3">class </span><span class="s0">Request </span><span class="s1">{</span>
	<span class="s0">constructor</span><span class="s1">(</span><span class="s0">input</span><span class="s1">) {</span>
		<span class="s3">let </span><span class="s0">init </span><span class="s1">= </span><span class="s0">arguments</span><span class="s1">.</span><span class="s0">length </span><span class="s1">&gt; </span><span class="s5">1 </span><span class="s1">&amp;&amp; </span><span class="s0">arguments</span><span class="s1">[</span><span class="s5">1</span><span class="s1">] !== </span><span class="s0">undefined </span><span class="s1">? </span><span class="s0">arguments</span><span class="s1">[</span><span class="s5">1</span><span class="s1">] : {};</span>

		<span class="s3">let </span><span class="s0">parsedURL</span><span class="s1">;</span>

		<span class="s4">// normalize input</span>
		<span class="s3">if </span><span class="s1">(!</span><span class="s0">isRequest</span><span class="s1">(</span><span class="s0">input</span><span class="s1">)) {</span>
			<span class="s3">if </span><span class="s1">(</span><span class="s0">input </span><span class="s1">&amp;&amp; </span><span class="s0">input</span><span class="s1">.</span><span class="s0">href</span><span class="s1">) {</span>
				<span class="s4">// in order to support Node.js' Url objects; though WHATWG's URL objects</span>
				<span class="s4">// will fall into this branch also (since their `toString()` will return</span>
				<span class="s4">// `href` property anyway)</span>
				<span class="s0">parsedURL </span><span class="s1">= </span><span class="s0">parseURL</span><span class="s1">(</span><span class="s0">input</span><span class="s1">.</span><span class="s0">href</span><span class="s1">);</span>
			<span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
				<span class="s4">// coerce input to a string before attempting to parse</span>
				<span class="s0">parsedURL </span><span class="s1">= </span><span class="s0">parseURL</span><span class="s1">(</span><span class="s2">`</span><span class="s0">$</span><span class="s1">{</span><span class="s0">input</span><span class="s1">}</span><span class="s2">`</span><span class="s1">);</span>
			<span class="s1">}</span>
			<span class="s0">input </span><span class="s1">= {};</span>
		<span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
			<span class="s0">parsedURL </span><span class="s1">= </span><span class="s0">parseURL</span><span class="s1">(</span><span class="s0">input</span><span class="s1">.</span><span class="s0">url</span><span class="s1">);</span>
		<span class="s1">}</span>

		<span class="s3">let </span><span class="s0">method </span><span class="s1">= </span><span class="s0">init</span><span class="s1">.</span><span class="s0">method </span><span class="s1">|| </span><span class="s0">input</span><span class="s1">.</span><span class="s0">method </span><span class="s1">|| </span><span class="s2">'GET'</span><span class="s1">;</span>
		<span class="s0">method </span><span class="s1">= </span><span class="s0">method</span><span class="s1">.</span><span class="s0">toUpperCase</span><span class="s1">();</span>

		<span class="s3">if </span><span class="s1">((</span><span class="s0">init</span><span class="s1">.</span><span class="s0">body </span><span class="s1">!= </span><span class="s3">null </span><span class="s1">|| </span><span class="s0">isRequest</span><span class="s1">(</span><span class="s0">input</span><span class="s1">) &amp;&amp; </span><span class="s0">input</span><span class="s1">.</span><span class="s0">body </span><span class="s1">!== </span><span class="s3">null</span><span class="s1">) &amp;&amp; (</span><span class="s0">method </span><span class="s1">=== </span><span class="s2">'GET' </span><span class="s1">|| </span><span class="s0">method </span><span class="s1">=== </span><span class="s2">'HEAD'</span><span class="s1">)) {</span>
			<span class="s3">throw new </span><span class="s0">TypeError</span><span class="s1">(</span><span class="s2">'Request with GET/HEAD method cannot have body'</span><span class="s1">);</span>
		<span class="s1">}</span>

		<span class="s3">let </span><span class="s0">inputBody </span><span class="s1">= </span><span class="s0">init</span><span class="s1">.</span><span class="s0">body </span><span class="s1">!= </span><span class="s3">null </span><span class="s1">? </span><span class="s0">init</span><span class="s1">.</span><span class="s0">body </span><span class="s1">: </span><span class="s0">isRequest</span><span class="s1">(</span><span class="s0">input</span><span class="s1">) &amp;&amp; </span><span class="s0">input</span><span class="s1">.</span><span class="s0">body </span><span class="s1">!== </span><span class="s3">null </span><span class="s1">? </span><span class="s0">clone</span><span class="s1">(</span><span class="s0">input</span><span class="s1">) : </span><span class="s3">null</span><span class="s1">;</span>

		<span class="s0">Body</span><span class="s1">.</span><span class="s0">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s0">inputBody</span><span class="s1">, {</span>
			<span class="s0">timeout</span><span class="s1">: </span><span class="s0">init</span><span class="s1">.</span><span class="s0">timeout </span><span class="s1">|| </span><span class="s0">input</span><span class="s1">.</span><span class="s0">timeout </span><span class="s1">|| </span><span class="s5">0</span><span class="s1">,</span>
			<span class="s0">size</span><span class="s1">: </span><span class="s0">init</span><span class="s1">.</span><span class="s0">size </span><span class="s1">|| </span><span class="s0">input</span><span class="s1">.</span><span class="s0">size </span><span class="s1">|| </span><span class="s5">0</span>
		<span class="s1">});</span>

		<span class="s3">const </span><span class="s0">headers </span><span class="s1">= </span><span class="s3">new </span><span class="s0">Headers</span><span class="s1">(</span><span class="s0">init</span><span class="s1">.</span><span class="s0">headers </span><span class="s1">|| </span><span class="s0">input</span><span class="s1">.</span><span class="s0">headers </span><span class="s1">|| {});</span>

		<span class="s3">if </span><span class="s1">(</span><span class="s0">inputBody </span><span class="s1">!= </span><span class="s3">null </span><span class="s1">&amp;&amp; !</span><span class="s0">headers</span><span class="s1">.</span><span class="s0">has</span><span class="s1">(</span><span class="s2">'Content-Type'</span><span class="s1">)) {</span>
			<span class="s3">const </span><span class="s0">contentType </span><span class="s1">= </span><span class="s0">extractContentType</span><span class="s1">(</span><span class="s0">inputBody</span><span class="s1">);</span>
			<span class="s3">if </span><span class="s1">(</span><span class="s0">contentType</span><span class="s1">) {</span>
				<span class="s0">headers</span><span class="s1">.</span><span class="s0">append</span><span class="s1">(</span><span class="s2">'Content-Type'</span><span class="s1">, </span><span class="s0">contentType</span><span class="s1">);</span>
			<span class="s1">}</span>
		<span class="s1">}</span>

		<span class="s3">let </span><span class="s0">signal </span><span class="s1">= </span><span class="s0">isRequest</span><span class="s1">(</span><span class="s0">input</span><span class="s1">) ? </span><span class="s0">input</span><span class="s1">.</span><span class="s0">signal </span><span class="s1">: </span><span class="s3">null</span><span class="s1">;</span>
		<span class="s3">if </span><span class="s1">(</span><span class="s2">'signal' </span><span class="s3">in </span><span class="s0">init</span><span class="s1">) </span><span class="s0">signal </span><span class="s1">= </span><span class="s0">init</span><span class="s1">.</span><span class="s0">signal</span><span class="s1">;</span>

		<span class="s3">if </span><span class="s1">(</span><span class="s0">signal </span><span class="s1">!= </span><span class="s3">null </span><span class="s1">&amp;&amp; !</span><span class="s0">isAbortSignal</span><span class="s1">(</span><span class="s0">signal</span><span class="s1">)) {</span>
			<span class="s3">throw new </span><span class="s0">TypeError</span><span class="s1">(</span><span class="s2">'Expected signal to be an instanceof AbortSignal'</span><span class="s1">);</span>
		<span class="s1">}</span>

		<span class="s3">this</span><span class="s1">[</span><span class="s0">INTERNALS$2</span><span class="s1">] = {</span>
			<span class="s0">method</span><span class="s1">,</span>
			<span class="s0">redirect</span><span class="s1">: </span><span class="s0">init</span><span class="s1">.</span><span class="s0">redirect </span><span class="s1">|| </span><span class="s0">input</span><span class="s1">.</span><span class="s0">redirect </span><span class="s1">|| </span><span class="s2">'follow'</span><span class="s1">,</span>
			<span class="s0">headers</span><span class="s1">,</span>
			<span class="s0">parsedURL</span><span class="s1">,</span>
			<span class="s0">signal</span>
		<span class="s1">};</span>

		<span class="s4">// node-fetch-only options</span>
		<span class="s3">this</span><span class="s1">.</span><span class="s0">follow </span><span class="s1">= </span><span class="s0">init</span><span class="s1">.</span><span class="s0">follow </span><span class="s1">!== </span><span class="s0">undefined </span><span class="s1">? </span><span class="s0">init</span><span class="s1">.</span><span class="s0">follow </span><span class="s1">: </span><span class="s0">input</span><span class="s1">.</span><span class="s0">follow </span><span class="s1">!== </span><span class="s0">undefined </span><span class="s1">? </span><span class="s0">input</span><span class="s1">.</span><span class="s0">follow </span><span class="s1">: </span><span class="s5">20</span><span class="s1">;</span>
		<span class="s3">this</span><span class="s1">.</span><span class="s0">compress </span><span class="s1">= </span><span class="s0">init</span><span class="s1">.</span><span class="s0">compress </span><span class="s1">!== </span><span class="s0">undefined </span><span class="s1">? </span><span class="s0">init</span><span class="s1">.</span><span class="s0">compress </span><span class="s1">: </span><span class="s0">input</span><span class="s1">.</span><span class="s0">compress </span><span class="s1">!== </span><span class="s0">undefined </span><span class="s1">? </span><span class="s0">input</span><span class="s1">.</span><span class="s0">compress </span><span class="s1">: </span><span class="s3">true</span><span class="s1">;</span>
		<span class="s3">this</span><span class="s1">.</span><span class="s0">counter </span><span class="s1">= </span><span class="s0">init</span><span class="s1">.</span><span class="s0">counter </span><span class="s1">|| </span><span class="s0">input</span><span class="s1">.</span><span class="s0">counter </span><span class="s1">|| </span><span class="s5">0</span><span class="s1">;</span>
		<span class="s3">this</span><span class="s1">.</span><span class="s0">agent </span><span class="s1">= </span><span class="s0">init</span><span class="s1">.</span><span class="s0">agent </span><span class="s1">|| </span><span class="s0">input</span><span class="s1">.</span><span class="s0">agent</span><span class="s1">;</span>
	<span class="s1">}</span>

	<span class="s0">get method</span><span class="s1">() {</span>
		<span class="s3">return this</span><span class="s1">[</span><span class="s0">INTERNALS$2</span><span class="s1">].</span><span class="s0">method</span><span class="s1">;</span>
	<span class="s1">}</span>

	<span class="s0">get url</span><span class="s1">() {</span>
		<span class="s3">return </span><span class="s0">format_url</span><span class="s1">(</span><span class="s3">this</span><span class="s1">[</span><span class="s0">INTERNALS$2</span><span class="s1">].</span><span class="s0">parsedURL</span><span class="s1">);</span>
	<span class="s1">}</span>

	<span class="s0">get headers</span><span class="s1">() {</span>
		<span class="s3">return this</span><span class="s1">[</span><span class="s0">INTERNALS$2</span><span class="s1">].</span><span class="s0">headers</span><span class="s1">;</span>
	<span class="s1">}</span>

	<span class="s0">get redirect</span><span class="s1">() {</span>
		<span class="s3">return this</span><span class="s1">[</span><span class="s0">INTERNALS$2</span><span class="s1">].</span><span class="s0">redirect</span><span class="s1">;</span>
	<span class="s1">}</span>

	<span class="s0">get signal</span><span class="s1">() {</span>
		<span class="s3">return this</span><span class="s1">[</span><span class="s0">INTERNALS$2</span><span class="s1">].</span><span class="s0">signal</span><span class="s1">;</span>
	<span class="s1">}</span>

	<span class="s7">/**</span>
  <span class="s7">* Clone this request</span>
  <span class="s7">*</span>
  <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Request</span>
  <span class="s7">*/</span>
	<span class="s0">clone</span><span class="s1">() {</span>
		<span class="s3">return new </span><span class="s0">Request</span><span class="s1">(</span><span class="s3">this</span><span class="s1">);</span>
	<span class="s1">}</span>
<span class="s1">}</span>

<span class="s0">Body</span><span class="s1">.</span><span class="s0">mixIn</span><span class="s1">(</span><span class="s0">Request</span><span class="s1">.</span><span class="s0">prototype</span><span class="s1">);</span>

<span class="s0">Object</span><span class="s1">.</span><span class="s0">defineProperty</span><span class="s1">(</span><span class="s0">Request</span><span class="s1">.</span><span class="s0">prototype</span><span class="s1">, </span><span class="s0">Symbol</span><span class="s1">.</span><span class="s0">toStringTag</span><span class="s1">, {</span>
	<span class="s0">value</span><span class="s1">: </span><span class="s2">'Request'</span><span class="s1">,</span>
	<span class="s0">writable</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
	<span class="s0">enumerable</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
	<span class="s0">configurable</span><span class="s1">: </span><span class="s3">true</span>
<span class="s1">});</span>

<span class="s0">Object</span><span class="s1">.</span><span class="s0">defineProperties</span><span class="s1">(</span><span class="s0">Request</span><span class="s1">.</span><span class="s0">prototype</span><span class="s1">, {</span>
	<span class="s0">method</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">},</span>
	<span class="s0">url</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">},</span>
	<span class="s0">headers</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">},</span>
	<span class="s0">redirect</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">},</span>
	<span class="s0">clone</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">},</span>
	<span class="s0">signal</span><span class="s1">: { </span><span class="s0">enumerable</span><span class="s1">: </span><span class="s3">true </span><span class="s1">}</span>
<span class="s1">});</span>

<span class="s7">/**</span>
 <span class="s7">* Convert a Request to Node.js http request options.</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param   </span><span class="s7">Request  A Request instance</span>
 <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Object   The options object to be passed to http.request</span>
 <span class="s7">*/</span>
<span class="s3">function </span><span class="s0">getNodeRequestOptions</span><span class="s1">(</span><span class="s0">request</span><span class="s1">) {</span>
	<span class="s3">const </span><span class="s0">parsedURL </span><span class="s1">= </span><span class="s0">request</span><span class="s1">[</span><span class="s0">INTERNALS$2</span><span class="s1">].</span><span class="s0">parsedURL</span><span class="s1">;</span>
	<span class="s3">const </span><span class="s0">headers </span><span class="s1">= </span><span class="s3">new </span><span class="s0">Headers</span><span class="s1">(</span><span class="s0">request</span><span class="s1">[</span><span class="s0">INTERNALS$2</span><span class="s1">].</span><span class="s0">headers</span><span class="s1">);</span>

	<span class="s4">// fetch step 1.3</span>
	<span class="s3">if </span><span class="s1">(!</span><span class="s0">headers</span><span class="s1">.</span><span class="s0">has</span><span class="s1">(</span><span class="s2">'Accept'</span><span class="s1">)) {</span>
		<span class="s0">headers</span><span class="s1">.</span><span class="s0">set</span><span class="s1">(</span><span class="s2">'Accept'</span><span class="s1">, </span><span class="s2">'*/*'</span><span class="s1">);</span>
	<span class="s1">}</span>

	<span class="s4">// Basic fetch</span>
	<span class="s3">if </span><span class="s1">(!</span><span class="s0">parsedURL</span><span class="s1">.</span><span class="s0">protocol </span><span class="s1">|| !</span><span class="s0">parsedURL</span><span class="s1">.</span><span class="s0">hostname</span><span class="s1">) {</span>
		<span class="s3">throw new </span><span class="s0">TypeError</span><span class="s1">(</span><span class="s2">'Only absolute URLs are supported'</span><span class="s1">);</span>
	<span class="s1">}</span>

	<span class="s3">if </span><span class="s1">(!</span><span class="s6">/^https?:$/</span><span class="s1">.</span><span class="s0">test</span><span class="s1">(</span><span class="s0">parsedURL</span><span class="s1">.</span><span class="s0">protocol</span><span class="s1">)) {</span>
		<span class="s3">throw new </span><span class="s0">TypeError</span><span class="s1">(</span><span class="s2">'Only HTTP(S) protocols are supported'</span><span class="s1">);</span>
	<span class="s1">}</span>

	<span class="s3">if </span><span class="s1">(</span><span class="s0">request</span><span class="s1">.</span><span class="s0">signal </span><span class="s1">&amp;&amp; </span><span class="s0">request</span><span class="s1">.</span><span class="s0">body </span><span class="s3">instanceof </span><span class="s0">Stream</span><span class="s1">.</span><span class="s0">Readable </span><span class="s1">&amp;&amp; !</span><span class="s0">streamDestructionSupported</span><span class="s1">) {</span>
		<span class="s3">throw new </span><span class="s0">Error</span><span class="s1">(</span><span class="s2">'Cancellation of streamed requests with AbortSignal is not supported in node &lt; 8'</span><span class="s1">);</span>
	<span class="s1">}</span>

	<span class="s4">// HTTP-network-or-cache fetch steps 2.4-2.7</span>
	<span class="s3">let </span><span class="s0">contentLengthValue </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
	<span class="s3">if </span><span class="s1">(</span><span class="s0">request</span><span class="s1">.</span><span class="s0">body </span><span class="s1">== </span><span class="s3">null </span><span class="s1">&amp;&amp; </span><span class="s6">/^(POST|PUT)$/i</span><span class="s1">.</span><span class="s0">test</span><span class="s1">(</span><span class="s0">request</span><span class="s1">.</span><span class="s0">method</span><span class="s1">)) {</span>
		<span class="s0">contentLengthValue </span><span class="s1">= </span><span class="s2">'0'</span><span class="s1">;</span>
	<span class="s1">}</span>
	<span class="s3">if </span><span class="s1">(</span><span class="s0">request</span><span class="s1">.</span><span class="s0">body </span><span class="s1">!= </span><span class="s3">null</span><span class="s1">) {</span>
		<span class="s3">const </span><span class="s0">totalBytes </span><span class="s1">= </span><span class="s0">getTotalBytes</span><span class="s1">(</span><span class="s0">request</span><span class="s1">);</span>
		<span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s0">totalBytes </span><span class="s1">=== </span><span class="s2">'number'</span><span class="s1">) {</span>
			<span class="s0">contentLengthValue </span><span class="s1">= </span><span class="s0">String</span><span class="s1">(</span><span class="s0">totalBytes</span><span class="s1">);</span>
		<span class="s1">}</span>
	<span class="s1">}</span>
	<span class="s3">if </span><span class="s1">(</span><span class="s0">contentLengthValue</span><span class="s1">) {</span>
		<span class="s0">headers</span><span class="s1">.</span><span class="s0">set</span><span class="s1">(</span><span class="s2">'Content-Length'</span><span class="s1">, </span><span class="s0">contentLengthValue</span><span class="s1">);</span>
	<span class="s1">}</span>

	<span class="s4">// HTTP-network-or-cache fetch step 2.11</span>
	<span class="s3">if </span><span class="s1">(!</span><span class="s0">headers</span><span class="s1">.</span><span class="s0">has</span><span class="s1">(</span><span class="s2">'User-Agent'</span><span class="s1">)) {</span>
		<span class="s0">headers</span><span class="s1">.</span><span class="s0">set</span><span class="s1">(</span><span class="s2">'User-Agent'</span><span class="s1">, </span><span class="s2">'node-fetch/1.0 (+https://github.com/bitinn/node-fetch)'</span><span class="s1">);</span>
	<span class="s1">}</span>

	<span class="s4">// HTTP-network-or-cache fetch step 2.15</span>
	<span class="s3">if </span><span class="s1">(</span><span class="s0">request</span><span class="s1">.</span><span class="s0">compress </span><span class="s1">&amp;&amp; !</span><span class="s0">headers</span><span class="s1">.</span><span class="s0">has</span><span class="s1">(</span><span class="s2">'Accept-Encoding'</span><span class="s1">)) {</span>
		<span class="s0">headers</span><span class="s1">.</span><span class="s0">set</span><span class="s1">(</span><span class="s2">'Accept-Encoding'</span><span class="s1">, </span><span class="s2">'gzip,deflate'</span><span class="s1">);</span>
	<span class="s1">}</span>

	<span class="s3">let </span><span class="s0">agent </span><span class="s1">= </span><span class="s0">request</span><span class="s1">.</span><span class="s0">agent</span><span class="s1">;</span>
	<span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s0">agent </span><span class="s1">=== </span><span class="s2">'function'</span><span class="s1">) {</span>
		<span class="s0">agent </span><span class="s1">= </span><span class="s0">agent</span><span class="s1">(</span><span class="s0">parsedURL</span><span class="s1">);</span>
	<span class="s1">}</span>

	<span class="s4">// HTTP-network fetch step 4.2</span>
	<span class="s4">// chunked encoding is handled by Node.js</span>

	<span class="s3">return </span><span class="s0">Object</span><span class="s1">.</span><span class="s0">assign</span><span class="s1">({}, </span><span class="s0">parsedURL</span><span class="s1">, {</span>
		<span class="s0">method</span><span class="s1">: </span><span class="s0">request</span><span class="s1">.</span><span class="s0">method</span><span class="s1">,</span>
		<span class="s0">headers</span><span class="s1">: </span><span class="s0">exportNodeCompatibleHeaders</span><span class="s1">(</span><span class="s0">headers</span><span class="s1">),</span>
		<span class="s0">agent</span>
	<span class="s1">});</span>
<span class="s1">}</span>

<span class="s7">/**</span>
 <span class="s7">* abort-error.js</span>
 <span class="s7">*</span>
 <span class="s7">* AbortError interface for cancelled requests</span>
 <span class="s7">*/</span>

<span class="s7">/**</span>
 <span class="s7">* Create AbortError instance</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param   </span><span class="s7">String      message      Error message for human</span>
 <span class="s7">* </span><span class="s8">@return  </span><span class="s7">AbortError</span>
 <span class="s7">*/</span>
<span class="s3">function </span><span class="s0">AbortError</span><span class="s1">(</span><span class="s0">message</span><span class="s1">) {</span>
  <span class="s0">Error</span><span class="s1">.</span><span class="s0">call</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s0">message</span><span class="s1">);</span>

  <span class="s3">this</span><span class="s1">.</span><span class="s0">type </span><span class="s1">= </span><span class="s2">'aborted'</span><span class="s1">;</span>
  <span class="s3">this</span><span class="s1">.</span><span class="s0">message </span><span class="s1">= </span><span class="s0">message</span><span class="s1">;</span>

  <span class="s4">// hide custom error implementation details from end-users</span>
  <span class="s0">Error</span><span class="s1">.</span><span class="s0">captureStackTrace</span><span class="s1">(</span><span class="s3">this</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s0">constructor</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s0">AbortError</span><span class="s1">.</span><span class="s0">prototype </span><span class="s1">= </span><span class="s0">Object</span><span class="s1">.</span><span class="s0">create</span><span class="s1">(</span><span class="s0">Error</span><span class="s1">.</span><span class="s0">prototype</span><span class="s1">);</span>
<span class="s0">AbortError</span><span class="s1">.</span><span class="s0">prototype</span><span class="s1">.</span><span class="s0">constructor </span><span class="s1">= </span><span class="s0">AbortError</span><span class="s1">;</span>
<span class="s0">AbortError</span><span class="s1">.</span><span class="s0">prototype</span><span class="s1">.</span><span class="s0">name </span><span class="s1">= </span><span class="s2">'AbortError'</span><span class="s1">;</span>

<span class="s3">const </span><span class="s0">URL$1 </span><span class="s1">= </span><span class="s0">Url</span><span class="s1">.</span><span class="s0">URL </span><span class="s1">|| </span><span class="s0">whatwgUrl</span><span class="s1">.</span><span class="s0">URL</span><span class="s1">;</span>

<span class="s4">// fix an issue where &quot;PassThrough&quot;, &quot;resolve&quot; aren't a named export for node &lt;10</span>
<span class="s3">const </span><span class="s0">PassThrough$1 </span><span class="s1">= </span><span class="s0">Stream</span><span class="s1">.</span><span class="s0">PassThrough</span><span class="s1">;</span>

<span class="s3">const </span><span class="s0">isDomainOrSubdomain </span><span class="s1">= </span><span class="s3">function </span><span class="s0">isDomainOrSubdomain</span><span class="s1">(</span><span class="s0">destination</span><span class="s1">, </span><span class="s0">original</span><span class="s1">) {</span>
	<span class="s3">const </span><span class="s0">orig </span><span class="s1">= </span><span class="s3">new </span><span class="s0">URL$1</span><span class="s1">(</span><span class="s0">original</span><span class="s1">).</span><span class="s0">hostname</span><span class="s1">;</span>
	<span class="s3">const </span><span class="s0">dest </span><span class="s1">= </span><span class="s3">new </span><span class="s0">URL$1</span><span class="s1">(</span><span class="s0">destination</span><span class="s1">).</span><span class="s0">hostname</span><span class="s1">;</span>

	<span class="s3">return </span><span class="s0">orig </span><span class="s1">=== </span><span class="s0">dest </span><span class="s1">|| </span><span class="s0">orig</span><span class="s1">[</span><span class="s0">orig</span><span class="s1">.</span><span class="s0">length </span><span class="s1">- </span><span class="s0">dest</span><span class="s1">.</span><span class="s0">length </span><span class="s1">- </span><span class="s5">1</span><span class="s1">] === </span><span class="s2">'.' </span><span class="s1">&amp;&amp; </span><span class="s0">orig</span><span class="s1">.</span><span class="s0">endsWith</span><span class="s1">(</span><span class="s0">dest</span><span class="s1">);</span>
<span class="s1">};</span>

<span class="s7">/**</span>
 <span class="s7">* isSameProtocol reports whether the two provided URLs use the same protocol.</span>
 <span class="s7">*</span>
 <span class="s7">* Both domains must already be in canonical form.</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{string|URL} original</span>
 <span class="s7">* </span><span class="s8">@param </span><span class="s7">{string|URL} destination</span>
 <span class="s7">*/</span>
<span class="s3">const </span><span class="s0">isSameProtocol </span><span class="s1">= </span><span class="s3">function </span><span class="s0">isSameProtocol</span><span class="s1">(</span><span class="s0">destination</span><span class="s1">, </span><span class="s0">original</span><span class="s1">) {</span>
	<span class="s3">const </span><span class="s0">orig </span><span class="s1">= </span><span class="s3">new </span><span class="s0">URL$1</span><span class="s1">(</span><span class="s0">original</span><span class="s1">).</span><span class="s0">protocol</span><span class="s1">;</span>
	<span class="s3">const </span><span class="s0">dest </span><span class="s1">= </span><span class="s3">new </span><span class="s0">URL$1</span><span class="s1">(</span><span class="s0">destination</span><span class="s1">).</span><span class="s0">protocol</span><span class="s1">;</span>

	<span class="s3">return </span><span class="s0">orig </span><span class="s1">=== </span><span class="s0">dest</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s7">/**</span>
 <span class="s7">* Fetch function</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param   </span><span class="s7">Mixed    url   Absolute url or Request instance</span>
 <span class="s7">* </span><span class="s8">@param   </span><span class="s7">Object   opts  Fetch options</span>
 <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Promise</span>
 <span class="s7">*/</span>
<span class="s3">function </span><span class="s0">fetch</span><span class="s1">(</span><span class="s0">url</span><span class="s1">, </span><span class="s0">opts</span><span class="s1">) {</span>

	<span class="s4">// allow custom promise</span>
	<span class="s3">if </span><span class="s1">(!</span><span class="s0">fetch</span><span class="s1">.</span><span class="s0">Promise</span><span class="s1">) {</span>
		<span class="s3">throw new </span><span class="s0">Error</span><span class="s1">(</span><span class="s2">'native promise missing, set fetch.Promise to your favorite alternative'</span><span class="s1">);</span>
	<span class="s1">}</span>

	<span class="s0">Body</span><span class="s1">.</span><span class="s0">Promise </span><span class="s1">= </span><span class="s0">fetch</span><span class="s1">.</span><span class="s0">Promise</span><span class="s1">;</span>

	<span class="s4">// wrap http.request into fetch</span>
	<span class="s3">return new </span><span class="s0">fetch</span><span class="s1">.</span><span class="s0">Promise</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s0">resolve</span><span class="s1">, </span><span class="s0">reject</span><span class="s1">) {</span>
		<span class="s4">// build request object</span>
		<span class="s3">const </span><span class="s0">request </span><span class="s1">= </span><span class="s3">new </span><span class="s0">Request</span><span class="s1">(</span><span class="s0">url</span><span class="s1">, </span><span class="s0">opts</span><span class="s1">);</span>
		<span class="s3">const </span><span class="s0">options </span><span class="s1">= </span><span class="s0">getNodeRequestOptions</span><span class="s1">(</span><span class="s0">request</span><span class="s1">);</span>

		<span class="s3">const </span><span class="s0">send </span><span class="s1">= (</span><span class="s0">options</span><span class="s1">.</span><span class="s0">protocol </span><span class="s1">=== </span><span class="s2">'https:' </span><span class="s1">? </span><span class="s0">https </span><span class="s1">: </span><span class="s0">http</span><span class="s1">).</span><span class="s0">request</span><span class="s1">;</span>
		<span class="s3">const </span><span class="s0">signal </span><span class="s1">= </span><span class="s0">request</span><span class="s1">.</span><span class="s0">signal</span><span class="s1">;</span>

		<span class="s3">let </span><span class="s0">response </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>

		<span class="s3">const </span><span class="s0">abort </span><span class="s1">= </span><span class="s3">function </span><span class="s0">abort</span><span class="s1">() {</span>
			<span class="s3">let </span><span class="s0">error </span><span class="s1">= </span><span class="s3">new </span><span class="s0">AbortError</span><span class="s1">(</span><span class="s2">'The user aborted a request.'</span><span class="s1">);</span>
			<span class="s0">reject</span><span class="s1">(</span><span class="s0">error</span><span class="s1">);</span>
			<span class="s3">if </span><span class="s1">(</span><span class="s0">request</span><span class="s1">.</span><span class="s0">body </span><span class="s1">&amp;&amp; </span><span class="s0">request</span><span class="s1">.</span><span class="s0">body </span><span class="s3">instanceof </span><span class="s0">Stream</span><span class="s1">.</span><span class="s0">Readable</span><span class="s1">) {</span>
				<span class="s0">destroyStream</span><span class="s1">(</span><span class="s0">request</span><span class="s1">.</span><span class="s0">body</span><span class="s1">, </span><span class="s0">error</span><span class="s1">);</span>
			<span class="s1">}</span>
			<span class="s3">if </span><span class="s1">(!</span><span class="s0">response </span><span class="s1">|| !</span><span class="s0">response</span><span class="s1">.</span><span class="s0">body</span><span class="s1">) </span><span class="s3">return</span><span class="s1">;</span>
			<span class="s0">response</span><span class="s1">.</span><span class="s0">body</span><span class="s1">.</span><span class="s0">emit</span><span class="s1">(</span><span class="s2">'error'</span><span class="s1">, </span><span class="s0">error</span><span class="s1">);</span>
		<span class="s1">};</span>

		<span class="s3">if </span><span class="s1">(</span><span class="s0">signal </span><span class="s1">&amp;&amp; </span><span class="s0">signal</span><span class="s1">.</span><span class="s0">aborted</span><span class="s1">) {</span>
			<span class="s0">abort</span><span class="s1">();</span>
			<span class="s3">return</span><span class="s1">;</span>
		<span class="s1">}</span>

		<span class="s3">const </span><span class="s0">abortAndFinalize </span><span class="s1">= </span><span class="s3">function </span><span class="s0">abortAndFinalize</span><span class="s1">() {</span>
			<span class="s0">abort</span><span class="s1">();</span>
			<span class="s0">finalize</span><span class="s1">();</span>
		<span class="s1">};</span>

		<span class="s4">// send request</span>
		<span class="s3">const </span><span class="s0">req </span><span class="s1">= </span><span class="s0">send</span><span class="s1">(</span><span class="s0">options</span><span class="s1">);</span>
		<span class="s3">let </span><span class="s0">reqTimeout</span><span class="s1">;</span>

		<span class="s3">if </span><span class="s1">(</span><span class="s0">signal</span><span class="s1">) {</span>
			<span class="s0">signal</span><span class="s1">.</span><span class="s0">addEventListener</span><span class="s1">(</span><span class="s2">'abort'</span><span class="s1">, </span><span class="s0">abortAndFinalize</span><span class="s1">);</span>
		<span class="s1">}</span>

		<span class="s3">function </span><span class="s0">finalize</span><span class="s1">() {</span>
			<span class="s0">req</span><span class="s1">.</span><span class="s0">abort</span><span class="s1">();</span>
			<span class="s3">if </span><span class="s1">(</span><span class="s0">signal</span><span class="s1">) </span><span class="s0">signal</span><span class="s1">.</span><span class="s0">removeEventListener</span><span class="s1">(</span><span class="s2">'abort'</span><span class="s1">, </span><span class="s0">abortAndFinalize</span><span class="s1">);</span>
			<span class="s0">clearTimeout</span><span class="s1">(</span><span class="s0">reqTimeout</span><span class="s1">);</span>
		<span class="s1">}</span>

		<span class="s3">if </span><span class="s1">(</span><span class="s0">request</span><span class="s1">.</span><span class="s0">timeout</span><span class="s1">) {</span>
			<span class="s0">req</span><span class="s1">.</span><span class="s0">once</span><span class="s1">(</span><span class="s2">'socket'</span><span class="s1">, </span><span class="s3">function </span><span class="s1">(</span><span class="s0">socket</span><span class="s1">) {</span>
				<span class="s0">reqTimeout </span><span class="s1">= </span><span class="s0">setTimeout</span><span class="s1">(</span><span class="s3">function </span><span class="s1">() {</span>
					<span class="s0">reject</span><span class="s1">(</span><span class="s3">new </span><span class="s0">FetchError</span><span class="s1">(</span><span class="s2">`network timeout at: </span><span class="s0">$</span><span class="s1">{</span><span class="s0">request</span><span class="s1">.</span><span class="s0">url</span><span class="s1">}</span><span class="s2">`</span><span class="s1">, </span><span class="s2">'request-timeout'</span><span class="s1">));</span>
					<span class="s0">finalize</span><span class="s1">();</span>
				<span class="s1">}, </span><span class="s0">request</span><span class="s1">.</span><span class="s0">timeout</span><span class="s1">);</span>
			<span class="s1">});</span>
		<span class="s1">}</span>

		<span class="s0">req</span><span class="s1">.</span><span class="s0">on</span><span class="s1">(</span><span class="s2">'error'</span><span class="s1">, </span><span class="s3">function </span><span class="s1">(</span><span class="s0">err</span><span class="s1">) {</span>
			<span class="s0">reject</span><span class="s1">(</span><span class="s3">new </span><span class="s0">FetchError</span><span class="s1">(</span><span class="s2">`request to </span><span class="s0">$</span><span class="s1">{</span><span class="s0">request</span><span class="s1">.</span><span class="s0">url</span><span class="s1">} </span><span class="s2">failed, reason: </span><span class="s0">$</span><span class="s1">{</span><span class="s0">err</span><span class="s1">.</span><span class="s0">message</span><span class="s1">}</span><span class="s2">`</span><span class="s1">, </span><span class="s2">'system'</span><span class="s1">, </span><span class="s0">err</span><span class="s1">));</span>

			<span class="s3">if </span><span class="s1">(</span><span class="s0">response </span><span class="s1">&amp;&amp; </span><span class="s0">response</span><span class="s1">.</span><span class="s0">body</span><span class="s1">) {</span>
				<span class="s0">destroyStream</span><span class="s1">(</span><span class="s0">response</span><span class="s1">.</span><span class="s0">body</span><span class="s1">, </span><span class="s0">err</span><span class="s1">);</span>
			<span class="s1">}</span>

			<span class="s0">finalize</span><span class="s1">();</span>
		<span class="s1">});</span>

		<span class="s0">fixResponseChunkedTransferBadEnding</span><span class="s1">(</span><span class="s0">req</span><span class="s1">, </span><span class="s3">function </span><span class="s1">(</span><span class="s0">err</span><span class="s1">) {</span>
			<span class="s3">if </span><span class="s1">(</span><span class="s0">signal </span><span class="s1">&amp;&amp; </span><span class="s0">signal</span><span class="s1">.</span><span class="s0">aborted</span><span class="s1">) {</span>
				<span class="s3">return</span><span class="s1">;</span>
			<span class="s1">}</span>

			<span class="s3">if </span><span class="s1">(</span><span class="s0">response </span><span class="s1">&amp;&amp; </span><span class="s0">response</span><span class="s1">.</span><span class="s0">body</span><span class="s1">) {</span>
				<span class="s0">destroyStream</span><span class="s1">(</span><span class="s0">response</span><span class="s1">.</span><span class="s0">body</span><span class="s1">, </span><span class="s0">err</span><span class="s1">);</span>
			<span class="s1">}</span>
		<span class="s1">});</span>

		<span class="s4">/* c8 ignore next 18 */</span>
		<span class="s3">if </span><span class="s1">(</span><span class="s0">parseInt</span><span class="s1">(</span><span class="s0">process</span><span class="s1">.</span><span class="s0">version</span><span class="s1">.</span><span class="s0">substring</span><span class="s1">(</span><span class="s5">1</span><span class="s1">)) &lt; </span><span class="s5">14</span><span class="s1">) {</span>
			<span class="s4">// Before Node.js 14, pipeline() does not fully support async iterators and does not always</span>
			<span class="s4">// properly handle when the socket close/end events are out of order.</span>
			<span class="s0">req</span><span class="s1">.</span><span class="s0">on</span><span class="s1">(</span><span class="s2">'socket'</span><span class="s1">, </span><span class="s3">function </span><span class="s1">(</span><span class="s0">s</span><span class="s1">) {</span>
				<span class="s0">s</span><span class="s1">.</span><span class="s0">addListener</span><span class="s1">(</span><span class="s2">'close'</span><span class="s1">, </span><span class="s3">function </span><span class="s1">(</span><span class="s0">hadError</span><span class="s1">) {</span>
					<span class="s4">// if a data listener is still present we didn't end cleanly</span>
					<span class="s3">const </span><span class="s0">hasDataListener </span><span class="s1">= </span><span class="s0">s</span><span class="s1">.</span><span class="s0">listenerCount</span><span class="s1">(</span><span class="s2">'data'</span><span class="s1">) &gt; </span><span class="s5">0</span><span class="s1">;</span>

					<span class="s4">// if end happened before close but the socket didn't emit an error, do it now</span>
					<span class="s3">if </span><span class="s1">(</span><span class="s0">response </span><span class="s1">&amp;&amp; </span><span class="s0">hasDataListener </span><span class="s1">&amp;&amp; !</span><span class="s0">hadError </span><span class="s1">&amp;&amp; !(</span><span class="s0">signal </span><span class="s1">&amp;&amp; </span><span class="s0">signal</span><span class="s1">.</span><span class="s0">aborted</span><span class="s1">)) {</span>
						<span class="s3">const </span><span class="s0">err </span><span class="s1">= </span><span class="s3">new </span><span class="s0">Error</span><span class="s1">(</span><span class="s2">'Premature close'</span><span class="s1">);</span>
						<span class="s0">err</span><span class="s1">.</span><span class="s0">code </span><span class="s1">= </span><span class="s2">'ERR_STREAM_PREMATURE_CLOSE'</span><span class="s1">;</span>
						<span class="s0">response</span><span class="s1">.</span><span class="s0">body</span><span class="s1">.</span><span class="s0">emit</span><span class="s1">(</span><span class="s2">'error'</span><span class="s1">, </span><span class="s0">err</span><span class="s1">);</span>
					<span class="s1">}</span>
				<span class="s1">});</span>
			<span class="s1">});</span>
		<span class="s1">}</span>

		<span class="s0">req</span><span class="s1">.</span><span class="s0">on</span><span class="s1">(</span><span class="s2">'response'</span><span class="s1">, </span><span class="s3">function </span><span class="s1">(</span><span class="s0">res</span><span class="s1">) {</span>
			<span class="s0">clearTimeout</span><span class="s1">(</span><span class="s0">reqTimeout</span><span class="s1">);</span>

			<span class="s3">const </span><span class="s0">headers </span><span class="s1">= </span><span class="s0">createHeadersLenient</span><span class="s1">(</span><span class="s0">res</span><span class="s1">.</span><span class="s0">headers</span><span class="s1">);</span>

			<span class="s4">// HTTP fetch step 5</span>
			<span class="s3">if </span><span class="s1">(</span><span class="s0">fetch</span><span class="s1">.</span><span class="s0">isRedirect</span><span class="s1">(</span><span class="s0">res</span><span class="s1">.</span><span class="s0">statusCode</span><span class="s1">)) {</span>
				<span class="s4">// HTTP fetch step 5.2</span>
				<span class="s3">const </span><span class="s0">location </span><span class="s1">= </span><span class="s0">headers</span><span class="s1">.</span><span class="s0">get</span><span class="s1">(</span><span class="s2">'Location'</span><span class="s1">);</span>

				<span class="s4">// HTTP fetch step 5.3</span>
				<span class="s3">let </span><span class="s0">locationURL </span><span class="s1">= </span><span class="s3">null</span><span class="s1">;</span>
				<span class="s3">try </span><span class="s1">{</span>
					<span class="s0">locationURL </span><span class="s1">= </span><span class="s0">location </span><span class="s1">=== </span><span class="s3">null </span><span class="s1">? </span><span class="s3">null </span><span class="s1">: </span><span class="s3">new </span><span class="s0">URL$1</span><span class="s1">(</span><span class="s0">location</span><span class="s1">, </span><span class="s0">request</span><span class="s1">.</span><span class="s0">url</span><span class="s1">).</span><span class="s0">toString</span><span class="s1">();</span>
				<span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s0">err</span><span class="s1">) {</span>
					<span class="s4">// error here can only be invalid URL in Location: header</span>
					<span class="s4">// do not throw when options.redirect == manual</span>
					<span class="s4">// let the user extract the errorneous redirect URL</span>
					<span class="s3">if </span><span class="s1">(</span><span class="s0">request</span><span class="s1">.</span><span class="s0">redirect </span><span class="s1">!== </span><span class="s2">'manual'</span><span class="s1">) {</span>
						<span class="s0">reject</span><span class="s1">(</span><span class="s3">new </span><span class="s0">FetchError</span><span class="s1">(</span><span class="s2">`uri requested responds with an invalid redirect URL: </span><span class="s0">$</span><span class="s1">{</span><span class="s0">location</span><span class="s1">}</span><span class="s2">`</span><span class="s1">, </span><span class="s2">'invalid-redirect'</span><span class="s1">));</span>
						<span class="s0">finalize</span><span class="s1">();</span>
						<span class="s3">return</span><span class="s1">;</span>
					<span class="s1">}</span>
				<span class="s1">}</span>

				<span class="s4">// HTTP fetch step 5.5</span>
				<span class="s3">switch </span><span class="s1">(</span><span class="s0">request</span><span class="s1">.</span><span class="s0">redirect</span><span class="s1">) {</span>
					<span class="s3">case </span><span class="s2">'error'</span><span class="s1">:</span>
						<span class="s0">reject</span><span class="s1">(</span><span class="s3">new </span><span class="s0">FetchError</span><span class="s1">(</span><span class="s2">`uri requested responds with a redirect, redirect mode is set to error: </span><span class="s0">$</span><span class="s1">{</span><span class="s0">request</span><span class="s1">.</span><span class="s0">url</span><span class="s1">}</span><span class="s2">`</span><span class="s1">, </span><span class="s2">'no-redirect'</span><span class="s1">));</span>
						<span class="s0">finalize</span><span class="s1">();</span>
						<span class="s3">return</span><span class="s1">;</span>
					<span class="s3">case </span><span class="s2">'manual'</span><span class="s1">:</span>
						<span class="s4">// node-fetch-specific step: make manual redirect a bit easier to use by setting the Location header value to the resolved URL.</span>
						<span class="s3">if </span><span class="s1">(</span><span class="s0">locationURL </span><span class="s1">!== </span><span class="s3">null</span><span class="s1">) {</span>
							<span class="s4">// handle corrupted header</span>
							<span class="s3">try </span><span class="s1">{</span>
								<span class="s0">headers</span><span class="s1">.</span><span class="s0">set</span><span class="s1">(</span><span class="s2">'Location'</span><span class="s1">, </span><span class="s0">locationURL</span><span class="s1">);</span>
							<span class="s1">} </span><span class="s3">catch </span><span class="s1">(</span><span class="s0">err</span><span class="s1">) {</span>
								<span class="s4">// istanbul ignore next: nodejs server prevent invalid response headers, we can't test this through normal request</span>
								<span class="s0">reject</span><span class="s1">(</span><span class="s0">err</span><span class="s1">);</span>
							<span class="s1">}</span>
						<span class="s1">}</span>
						<span class="s3">break</span><span class="s1">;</span>
					<span class="s3">case </span><span class="s2">'follow'</span><span class="s1">:</span>
						<span class="s4">// HTTP-redirect fetch step 2</span>
						<span class="s3">if </span><span class="s1">(</span><span class="s0">locationURL </span><span class="s1">=== </span><span class="s3">null</span><span class="s1">) {</span>
							<span class="s3">break</span><span class="s1">;</span>
						<span class="s1">}</span>

						<span class="s4">// HTTP-redirect fetch step 5</span>
						<span class="s3">if </span><span class="s1">(</span><span class="s0">request</span><span class="s1">.</span><span class="s0">counter </span><span class="s1">&gt;= </span><span class="s0">request</span><span class="s1">.</span><span class="s0">follow</span><span class="s1">) {</span>
							<span class="s0">reject</span><span class="s1">(</span><span class="s3">new </span><span class="s0">FetchError</span><span class="s1">(</span><span class="s2">`maximum redirect reached at: </span><span class="s0">$</span><span class="s1">{</span><span class="s0">request</span><span class="s1">.</span><span class="s0">url</span><span class="s1">}</span><span class="s2">`</span><span class="s1">, </span><span class="s2">'max-redirect'</span><span class="s1">));</span>
							<span class="s0">finalize</span><span class="s1">();</span>
							<span class="s3">return</span><span class="s1">;</span>
						<span class="s1">}</span>

						<span class="s4">// HTTP-redirect fetch step 6 (counter increment)</span>
						<span class="s4">// Create a new Request object.</span>
						<span class="s3">const </span><span class="s0">requestOpts </span><span class="s1">= {</span>
							<span class="s0">headers</span><span class="s1">: </span><span class="s3">new </span><span class="s0">Headers</span><span class="s1">(</span><span class="s0">request</span><span class="s1">.</span><span class="s0">headers</span><span class="s1">),</span>
							<span class="s0">follow</span><span class="s1">: </span><span class="s0">request</span><span class="s1">.</span><span class="s0">follow</span><span class="s1">,</span>
							<span class="s0">counter</span><span class="s1">: </span><span class="s0">request</span><span class="s1">.</span><span class="s0">counter </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">,</span>
							<span class="s0">agent</span><span class="s1">: </span><span class="s0">request</span><span class="s1">.</span><span class="s0">agent</span><span class="s1">,</span>
							<span class="s0">compress</span><span class="s1">: </span><span class="s0">request</span><span class="s1">.</span><span class="s0">compress</span><span class="s1">,</span>
							<span class="s0">method</span><span class="s1">: </span><span class="s0">request</span><span class="s1">.</span><span class="s0">method</span><span class="s1">,</span>
							<span class="s0">body</span><span class="s1">: </span><span class="s0">request</span><span class="s1">.</span><span class="s0">body</span><span class="s1">,</span>
							<span class="s0">signal</span><span class="s1">: </span><span class="s0">request</span><span class="s1">.</span><span class="s0">signal</span><span class="s1">,</span>
							<span class="s0">timeout</span><span class="s1">: </span><span class="s0">request</span><span class="s1">.</span><span class="s0">timeout</span><span class="s1">,</span>
							<span class="s0">size</span><span class="s1">: </span><span class="s0">request</span><span class="s1">.</span><span class="s0">size</span>
						<span class="s1">};</span>

						<span class="s3">if </span><span class="s1">(!</span><span class="s0">isDomainOrSubdomain</span><span class="s1">(</span><span class="s0">request</span><span class="s1">.</span><span class="s0">url</span><span class="s1">, </span><span class="s0">locationURL</span><span class="s1">) || !</span><span class="s0">isSameProtocol</span><span class="s1">(</span><span class="s0">request</span><span class="s1">.</span><span class="s0">url</span><span class="s1">, </span><span class="s0">locationURL</span><span class="s1">)) {</span>
							<span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s0">name of </span><span class="s1">[</span><span class="s2">'authorization'</span><span class="s1">, </span><span class="s2">'www-authenticate'</span><span class="s1">, </span><span class="s2">'cookie'</span><span class="s1">, </span><span class="s2">'cookie2'</span><span class="s1">]) {</span>
								<span class="s0">requestOpts</span><span class="s1">.</span><span class="s0">headers</span><span class="s1">.</span><span class="s0">delete</span><span class="s1">(</span><span class="s0">name</span><span class="s1">);</span>
							<span class="s1">}</span>
						<span class="s1">}</span>

						<span class="s4">// HTTP-redirect fetch step 9</span>
						<span class="s3">if </span><span class="s1">(</span><span class="s0">res</span><span class="s1">.</span><span class="s0">statusCode </span><span class="s1">!== </span><span class="s5">303 </span><span class="s1">&amp;&amp; </span><span class="s0">request</span><span class="s1">.</span><span class="s0">body </span><span class="s1">&amp;&amp; </span><span class="s0">getTotalBytes</span><span class="s1">(</span><span class="s0">request</span><span class="s1">) === </span><span class="s3">null</span><span class="s1">) {</span>
							<span class="s0">reject</span><span class="s1">(</span><span class="s3">new </span><span class="s0">FetchError</span><span class="s1">(</span><span class="s2">'Cannot follow redirect with body being a readable stream'</span><span class="s1">, </span><span class="s2">'unsupported-redirect'</span><span class="s1">));</span>
							<span class="s0">finalize</span><span class="s1">();</span>
							<span class="s3">return</span><span class="s1">;</span>
						<span class="s1">}</span>

						<span class="s4">// HTTP-redirect fetch step 11</span>
						<span class="s3">if </span><span class="s1">(</span><span class="s0">res</span><span class="s1">.</span><span class="s0">statusCode </span><span class="s1">=== </span><span class="s5">303 </span><span class="s1">|| (</span><span class="s0">res</span><span class="s1">.</span><span class="s0">statusCode </span><span class="s1">=== </span><span class="s5">301 </span><span class="s1">|| </span><span class="s0">res</span><span class="s1">.</span><span class="s0">statusCode </span><span class="s1">=== </span><span class="s5">302</span><span class="s1">) &amp;&amp; </span><span class="s0">request</span><span class="s1">.</span><span class="s0">method </span><span class="s1">=== </span><span class="s2">'POST'</span><span class="s1">) {</span>
							<span class="s0">requestOpts</span><span class="s1">.</span><span class="s0">method </span><span class="s1">= </span><span class="s2">'GET'</span><span class="s1">;</span>
							<span class="s0">requestOpts</span><span class="s1">.</span><span class="s0">body </span><span class="s1">= </span><span class="s0">undefined</span><span class="s1">;</span>
							<span class="s0">requestOpts</span><span class="s1">.</span><span class="s0">headers</span><span class="s1">.</span><span class="s0">delete</span><span class="s1">(</span><span class="s2">'content-length'</span><span class="s1">);</span>
						<span class="s1">}</span>

						<span class="s4">// HTTP-redirect fetch step 15</span>
						<span class="s0">resolve</span><span class="s1">(</span><span class="s0">fetch</span><span class="s1">(</span><span class="s3">new </span><span class="s0">Request</span><span class="s1">(</span><span class="s0">locationURL</span><span class="s1">, </span><span class="s0">requestOpts</span><span class="s1">)));</span>
						<span class="s0">finalize</span><span class="s1">();</span>
						<span class="s3">return</span><span class="s1">;</span>
				<span class="s1">}</span>
			<span class="s1">}</span>

			<span class="s4">// prepare response</span>
			<span class="s0">res</span><span class="s1">.</span><span class="s0">once</span><span class="s1">(</span><span class="s2">'end'</span><span class="s1">, </span><span class="s3">function </span><span class="s1">() {</span>
				<span class="s3">if </span><span class="s1">(</span><span class="s0">signal</span><span class="s1">) </span><span class="s0">signal</span><span class="s1">.</span><span class="s0">removeEventListener</span><span class="s1">(</span><span class="s2">'abort'</span><span class="s1">, </span><span class="s0">abortAndFinalize</span><span class="s1">);</span>
			<span class="s1">});</span>
			<span class="s3">let </span><span class="s0">body </span><span class="s1">= </span><span class="s0">res</span><span class="s1">.</span><span class="s0">pipe</span><span class="s1">(</span><span class="s3">new </span><span class="s0">PassThrough$1</span><span class="s1">());</span>

			<span class="s3">const </span><span class="s0">response_options </span><span class="s1">= {</span>
				<span class="s0">url</span><span class="s1">: </span><span class="s0">request</span><span class="s1">.</span><span class="s0">url</span><span class="s1">,</span>
				<span class="s0">status</span><span class="s1">: </span><span class="s0">res</span><span class="s1">.</span><span class="s0">statusCode</span><span class="s1">,</span>
				<span class="s0">statusText</span><span class="s1">: </span><span class="s0">res</span><span class="s1">.</span><span class="s0">statusMessage</span><span class="s1">,</span>
				<span class="s0">headers</span><span class="s1">: </span><span class="s0">headers</span><span class="s1">,</span>
				<span class="s0">size</span><span class="s1">: </span><span class="s0">request</span><span class="s1">.</span><span class="s0">size</span><span class="s1">,</span>
				<span class="s0">timeout</span><span class="s1">: </span><span class="s0">request</span><span class="s1">.</span><span class="s0">timeout</span><span class="s1">,</span>
				<span class="s0">counter</span><span class="s1">: </span><span class="s0">request</span><span class="s1">.</span><span class="s0">counter</span>
			<span class="s1">};</span>

			<span class="s4">// HTTP-network fetch step 12.1.1.3</span>
			<span class="s3">const </span><span class="s0">codings </span><span class="s1">= </span><span class="s0">headers</span><span class="s1">.</span><span class="s0">get</span><span class="s1">(</span><span class="s2">'Content-Encoding'</span><span class="s1">);</span>

			<span class="s4">// HTTP-network fetch step 12.1.1.4: handle content codings</span>

			<span class="s4">// in following scenarios we ignore compression support</span>
			<span class="s4">// 1. compression support is disabled</span>
			<span class="s4">// 2. HEAD request</span>
			<span class="s4">// 3. no Content-Encoding header</span>
			<span class="s4">// 4. no content response (204)</span>
			<span class="s4">// 5. content not modified response (304)</span>
			<span class="s3">if </span><span class="s1">(!</span><span class="s0">request</span><span class="s1">.</span><span class="s0">compress </span><span class="s1">|| </span><span class="s0">request</span><span class="s1">.</span><span class="s0">method </span><span class="s1">=== </span><span class="s2">'HEAD' </span><span class="s1">|| </span><span class="s0">codings </span><span class="s1">=== </span><span class="s3">null </span><span class="s1">|| </span><span class="s0">res</span><span class="s1">.</span><span class="s0">statusCode </span><span class="s1">=== </span><span class="s5">204 </span><span class="s1">|| </span><span class="s0">res</span><span class="s1">.</span><span class="s0">statusCode </span><span class="s1">=== </span><span class="s5">304</span><span class="s1">) {</span>
				<span class="s0">response </span><span class="s1">= </span><span class="s3">new </span><span class="s0">Response</span><span class="s1">(</span><span class="s0">body</span><span class="s1">, </span><span class="s0">response_options</span><span class="s1">);</span>
				<span class="s0">resolve</span><span class="s1">(</span><span class="s0">response</span><span class="s1">);</span>
				<span class="s3">return</span><span class="s1">;</span>
			<span class="s1">}</span>

			<span class="s4">// For Node v6+</span>
			<span class="s4">// Be less strict when decoding compressed responses, since sometimes</span>
			<span class="s4">// servers send slightly invalid responses that are still accepted</span>
			<span class="s4">// by common browsers.</span>
			<span class="s4">// Always using Z_SYNC_FLUSH is what cURL does.</span>
			<span class="s3">const </span><span class="s0">zlibOptions </span><span class="s1">= {</span>
				<span class="s0">flush</span><span class="s1">: </span><span class="s0">zlib</span><span class="s1">.</span><span class="s0">Z_SYNC_FLUSH</span><span class="s1">,</span>
				<span class="s0">finishFlush</span><span class="s1">: </span><span class="s0">zlib</span><span class="s1">.</span><span class="s0">Z_SYNC_FLUSH</span>
			<span class="s1">};</span>

			<span class="s4">// for gzip</span>
			<span class="s3">if </span><span class="s1">(</span><span class="s0">codings </span><span class="s1">== </span><span class="s2">'gzip' </span><span class="s1">|| </span><span class="s0">codings </span><span class="s1">== </span><span class="s2">'x-gzip'</span><span class="s1">) {</span>
				<span class="s0">body </span><span class="s1">= </span><span class="s0">body</span><span class="s1">.</span><span class="s0">pipe</span><span class="s1">(</span><span class="s0">zlib</span><span class="s1">.</span><span class="s0">createGunzip</span><span class="s1">(</span><span class="s0">zlibOptions</span><span class="s1">));</span>
				<span class="s0">response </span><span class="s1">= </span><span class="s3">new </span><span class="s0">Response</span><span class="s1">(</span><span class="s0">body</span><span class="s1">, </span><span class="s0">response_options</span><span class="s1">);</span>
				<span class="s0">resolve</span><span class="s1">(</span><span class="s0">response</span><span class="s1">);</span>
				<span class="s3">return</span><span class="s1">;</span>
			<span class="s1">}</span>

			<span class="s4">// for deflate</span>
			<span class="s3">if </span><span class="s1">(</span><span class="s0">codings </span><span class="s1">== </span><span class="s2">'deflate' </span><span class="s1">|| </span><span class="s0">codings </span><span class="s1">== </span><span class="s2">'x-deflate'</span><span class="s1">) {</span>
				<span class="s4">// handle the infamous raw deflate response from old servers</span>
				<span class="s4">// a hack for old IIS and Apache servers</span>
				<span class="s3">const </span><span class="s0">raw </span><span class="s1">= </span><span class="s0">res</span><span class="s1">.</span><span class="s0">pipe</span><span class="s1">(</span><span class="s3">new </span><span class="s0">PassThrough$1</span><span class="s1">());</span>
				<span class="s0">raw</span><span class="s1">.</span><span class="s0">once</span><span class="s1">(</span><span class="s2">'data'</span><span class="s1">, </span><span class="s3">function </span><span class="s1">(</span><span class="s0">chunk</span><span class="s1">) {</span>
					<span class="s4">// see http://stackoverflow.com/questions/37519828</span>
					<span class="s3">if </span><span class="s1">((</span><span class="s0">chunk</span><span class="s1">[</span><span class="s5">0</span><span class="s1">] &amp; </span><span class="s5">0x0F</span><span class="s1">) === </span><span class="s5">0x08</span><span class="s1">) {</span>
						<span class="s0">body </span><span class="s1">= </span><span class="s0">body</span><span class="s1">.</span><span class="s0">pipe</span><span class="s1">(</span><span class="s0">zlib</span><span class="s1">.</span><span class="s0">createInflate</span><span class="s1">());</span>
					<span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
						<span class="s0">body </span><span class="s1">= </span><span class="s0">body</span><span class="s1">.</span><span class="s0">pipe</span><span class="s1">(</span><span class="s0">zlib</span><span class="s1">.</span><span class="s0">createInflateRaw</span><span class="s1">());</span>
					<span class="s1">}</span>
					<span class="s0">response </span><span class="s1">= </span><span class="s3">new </span><span class="s0">Response</span><span class="s1">(</span><span class="s0">body</span><span class="s1">, </span><span class="s0">response_options</span><span class="s1">);</span>
					<span class="s0">resolve</span><span class="s1">(</span><span class="s0">response</span><span class="s1">);</span>
				<span class="s1">});</span>
				<span class="s0">raw</span><span class="s1">.</span><span class="s0">on</span><span class="s1">(</span><span class="s2">'end'</span><span class="s1">, </span><span class="s3">function </span><span class="s1">() {</span>
					<span class="s4">// some old IIS servers return zero-length OK deflate responses, so 'data' is never emitted.</span>
					<span class="s3">if </span><span class="s1">(!</span><span class="s0">response</span><span class="s1">) {</span>
						<span class="s0">response </span><span class="s1">= </span><span class="s3">new </span><span class="s0">Response</span><span class="s1">(</span><span class="s0">body</span><span class="s1">, </span><span class="s0">response_options</span><span class="s1">);</span>
						<span class="s0">resolve</span><span class="s1">(</span><span class="s0">response</span><span class="s1">);</span>
					<span class="s1">}</span>
				<span class="s1">});</span>
				<span class="s3">return</span><span class="s1">;</span>
			<span class="s1">}</span>

			<span class="s4">// for br</span>
			<span class="s3">if </span><span class="s1">(</span><span class="s0">codings </span><span class="s1">== </span><span class="s2">'br' </span><span class="s1">&amp;&amp; </span><span class="s3">typeof </span><span class="s0">zlib</span><span class="s1">.</span><span class="s0">createBrotliDecompress </span><span class="s1">=== </span><span class="s2">'function'</span><span class="s1">) {</span>
				<span class="s0">body </span><span class="s1">= </span><span class="s0">body</span><span class="s1">.</span><span class="s0">pipe</span><span class="s1">(</span><span class="s0">zlib</span><span class="s1">.</span><span class="s0">createBrotliDecompress</span><span class="s1">());</span>
				<span class="s0">response </span><span class="s1">= </span><span class="s3">new </span><span class="s0">Response</span><span class="s1">(</span><span class="s0">body</span><span class="s1">, </span><span class="s0">response_options</span><span class="s1">);</span>
				<span class="s0">resolve</span><span class="s1">(</span><span class="s0">response</span><span class="s1">);</span>
				<span class="s3">return</span><span class="s1">;</span>
			<span class="s1">}</span>

			<span class="s4">// otherwise, use response as-is</span>
			<span class="s0">response </span><span class="s1">= </span><span class="s3">new </span><span class="s0">Response</span><span class="s1">(</span><span class="s0">body</span><span class="s1">, </span><span class="s0">response_options</span><span class="s1">);</span>
			<span class="s0">resolve</span><span class="s1">(</span><span class="s0">response</span><span class="s1">);</span>
		<span class="s1">});</span>

		<span class="s0">writeToStream</span><span class="s1">(</span><span class="s0">req</span><span class="s1">, </span><span class="s0">request</span><span class="s1">);</span>
	<span class="s1">});</span>
<span class="s1">}</span>
<span class="s3">function </span><span class="s0">fixResponseChunkedTransferBadEnding</span><span class="s1">(</span><span class="s0">request</span><span class="s1">, </span><span class="s0">errorCallback</span><span class="s1">) {</span>
	<span class="s3">let </span><span class="s0">socket</span><span class="s1">;</span>

	<span class="s0">request</span><span class="s1">.</span><span class="s0">on</span><span class="s1">(</span><span class="s2">'socket'</span><span class="s1">, </span><span class="s3">function </span><span class="s1">(</span><span class="s0">s</span><span class="s1">) {</span>
		<span class="s0">socket </span><span class="s1">= </span><span class="s0">s</span><span class="s1">;</span>
	<span class="s1">});</span>

	<span class="s0">request</span><span class="s1">.</span><span class="s0">on</span><span class="s1">(</span><span class="s2">'response'</span><span class="s1">, </span><span class="s3">function </span><span class="s1">(</span><span class="s0">response</span><span class="s1">) {</span>
		<span class="s3">const </span><span class="s0">headers </span><span class="s1">= </span><span class="s0">response</span><span class="s1">.</span><span class="s0">headers</span><span class="s1">;</span>

		<span class="s3">if </span><span class="s1">(</span><span class="s0">headers</span><span class="s1">[</span><span class="s2">'transfer-encoding'</span><span class="s1">] === </span><span class="s2">'chunked' </span><span class="s1">&amp;&amp; !</span><span class="s0">headers</span><span class="s1">[</span><span class="s2">'content-length'</span><span class="s1">]) {</span>
			<span class="s0">response</span><span class="s1">.</span><span class="s0">once</span><span class="s1">(</span><span class="s2">'close'</span><span class="s1">, </span><span class="s3">function </span><span class="s1">(</span><span class="s0">hadError</span><span class="s1">) {</span>
				<span class="s4">// tests for socket presence, as in some situations the</span>
				<span class="s4">// the 'socket' event is not triggered for the request</span>
				<span class="s4">// (happens in deno), avoids `TypeError`</span>
				<span class="s4">// if a data listener is still present we didn't end cleanly</span>
				<span class="s3">const </span><span class="s0">hasDataListener </span><span class="s1">= </span><span class="s0">socket </span><span class="s1">&amp;&amp; </span><span class="s0">socket</span><span class="s1">.</span><span class="s0">listenerCount</span><span class="s1">(</span><span class="s2">'data'</span><span class="s1">) &gt; </span><span class="s5">0</span><span class="s1">;</span>

				<span class="s3">if </span><span class="s1">(</span><span class="s0">hasDataListener </span><span class="s1">&amp;&amp; !</span><span class="s0">hadError</span><span class="s1">) {</span>
					<span class="s3">const </span><span class="s0">err </span><span class="s1">= </span><span class="s3">new </span><span class="s0">Error</span><span class="s1">(</span><span class="s2">'Premature close'</span><span class="s1">);</span>
					<span class="s0">err</span><span class="s1">.</span><span class="s0">code </span><span class="s1">= </span><span class="s2">'ERR_STREAM_PREMATURE_CLOSE'</span><span class="s1">;</span>
					<span class="s0">errorCallback</span><span class="s1">(</span><span class="s0">err</span><span class="s1">);</span>
				<span class="s1">}</span>
			<span class="s1">});</span>
		<span class="s1">}</span>
	<span class="s1">});</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s0">destroyStream</span><span class="s1">(</span><span class="s0">stream</span><span class="s1">, </span><span class="s0">err</span><span class="s1">) {</span>
	<span class="s3">if </span><span class="s1">(</span><span class="s0">stream</span><span class="s1">.</span><span class="s0">destroy</span><span class="s1">) {</span>
		<span class="s0">stream</span><span class="s1">.</span><span class="s0">destroy</span><span class="s1">(</span><span class="s0">err</span><span class="s1">);</span>
	<span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
		<span class="s4">// node &lt; 8</span>
		<span class="s0">stream</span><span class="s1">.</span><span class="s0">emit</span><span class="s1">(</span><span class="s2">'error'</span><span class="s1">, </span><span class="s0">err</span><span class="s1">);</span>
		<span class="s0">stream</span><span class="s1">.</span><span class="s0">end</span><span class="s1">();</span>
	<span class="s1">}</span>
<span class="s1">}</span>

<span class="s7">/**</span>
 <span class="s7">* Redirect code matching</span>
 <span class="s7">*</span>
 <span class="s7">* </span><span class="s8">@param   </span><span class="s7">Number   code  Status code</span>
 <span class="s7">* </span><span class="s8">@return  </span><span class="s7">Boolean</span>
 <span class="s7">*/</span>
<span class="s0">fetch</span><span class="s1">.</span><span class="s0">isRedirect </span><span class="s1">= </span><span class="s3">function </span><span class="s1">(</span><span class="s0">code</span><span class="s1">) {</span>
	<span class="s3">return </span><span class="s0">code </span><span class="s1">=== </span><span class="s5">301 </span><span class="s1">|| </span><span class="s0">code </span><span class="s1">=== </span><span class="s5">302 </span><span class="s1">|| </span><span class="s0">code </span><span class="s1">=== </span><span class="s5">303 </span><span class="s1">|| </span><span class="s0">code </span><span class="s1">=== </span><span class="s5">307 </span><span class="s1">|| </span><span class="s0">code </span><span class="s1">=== </span><span class="s5">308</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s4">// expose Promise</span>
<span class="s0">fetch</span><span class="s1">.</span><span class="s0">Promise </span><span class="s1">= </span><span class="s0">global</span><span class="s1">.</span><span class="s0">Promise</span><span class="s1">;</span>

<span class="s3">export default </span><span class="s0">fetch</span><span class="s1">;</span>
<span class="s3">export </span><span class="s1">{ </span><span class="s0">Headers</span><span class="s1">, </span><span class="s0">Request</span><span class="s1">, </span><span class="s0">Response</span><span class="s1">, </span><span class="s0">FetchError</span><span class="s1">, </span><span class="s0">AbortError </span><span class="s1">};</span>
</pre>
</body>
</html>