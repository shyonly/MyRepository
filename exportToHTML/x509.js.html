<html>
<head>
<title>x509.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #67a37c; font-style: italic;}
.s2 { color: #bcbec4;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #7a7e85;}
.s7 { color: #2aacb8;}
.s8 { color: #42c3d4;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
x509.js</font>
</center></td></tr></table>
<pre><span class="s0">/**</span>
 <span class="s0">* Javascript implementation of X.509 and related components (such as</span>
 <span class="s0">* Certification Signing Requests) of a Public Key Infrastructure.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@author </span><span class="s0">Dave Longley</span>
 <span class="s0">*</span>
 <span class="s0">* Copyright (c) 2010-2014 Digital Bazaar, Inc.</span>
 <span class="s0">*</span>
 <span class="s0">* The ASN.1 representation of an X.509v3 certificate is as follows</span>
 <span class="s0">* (see RFC 2459):</span>
 <span class="s0">*</span>
 <span class="s0">* Certificate ::= SEQUENCE {</span>
 <span class="s0">*   tbsCertificate       TBSCertificate,</span>
 <span class="s0">*   signatureAlgorithm   AlgorithmIdentifier,</span>
 <span class="s0">*   signatureValue       BIT STRING</span>
 <span class="s0">* }</span>
 <span class="s0">*</span>
 <span class="s0">* TBSCertificate ::= SEQUENCE {</span>
 <span class="s0">*   version         [0]  EXPLICIT Version DEFAULT v1,</span>
 <span class="s0">*   serialNumber         CertificateSerialNumber,</span>
 <span class="s0">*   signature            AlgorithmIdentifier,</span>
 <span class="s0">*   issuer               Name,</span>
 <span class="s0">*   validity             Validity,</span>
 <span class="s0">*   subject              Name,</span>
 <span class="s0">*   subjectPublicKeyInfo SubjectPublicKeyInfo,</span>
 <span class="s0">*   issuerUniqueID  [1]  IMPLICIT UniqueIdentifier OPTIONAL,</span>
 <span class="s0">*                        -- If present, version shall be v2 or v3</span>
 <span class="s0">*   subjectUniqueID [2]  IMPLICIT UniqueIdentifier OPTIONAL,</span>
 <span class="s0">*                        -- If present, version shall be v2 or v3</span>
 <span class="s0">*   extensions      [3]  EXPLICIT Extensions OPTIONAL</span>
 <span class="s0">*                        -- If present, version shall be v3</span>
 <span class="s0">* }</span>
 <span class="s0">*</span>
 <span class="s0">* Version ::= INTEGER  { v1(0), v2(1), v3(2) }</span>
 <span class="s0">*</span>
 <span class="s0">* CertificateSerialNumber ::= INTEGER</span>
 <span class="s0">*</span>
 <span class="s0">* Name ::= CHOICE {</span>
 <span class="s0">*   // only one possible choice for now</span>
 <span class="s0">*   RDNSequence</span>
 <span class="s0">* }</span>
 <span class="s0">*</span>
 <span class="s0">* RDNSequence ::= SEQUENCE OF RelativeDistinguishedName</span>
 <span class="s0">*</span>
 <span class="s0">* RelativeDistinguishedName ::= SET OF AttributeTypeAndValue</span>
 <span class="s0">*</span>
 <span class="s0">* AttributeTypeAndValue ::= SEQUENCE {</span>
 <span class="s0">*   type     AttributeType,</span>
 <span class="s0">*   value    AttributeValue</span>
 <span class="s0">* }</span>
 <span class="s0">* AttributeType ::= OBJECT IDENTIFIER</span>
 <span class="s0">* AttributeValue ::= ANY DEFINED BY AttributeType</span>
 <span class="s0">*</span>
 <span class="s0">* Validity ::= SEQUENCE {</span>
 <span class="s0">*   notBefore      Time,</span>
 <span class="s0">*   notAfter       Time</span>
 <span class="s0">* }</span>
 <span class="s0">*</span>
 <span class="s0">* Time ::= CHOICE {</span>
 <span class="s0">*   utcTime        UTCTime,</span>
 <span class="s0">*   generalTime    GeneralizedTime</span>
 <span class="s0">* }</span>
 <span class="s0">*</span>
 <span class="s0">* UniqueIdentifier ::= BIT STRING</span>
 <span class="s0">*</span>
 <span class="s0">* SubjectPublicKeyInfo ::= SEQUENCE {</span>
 <span class="s0">*   algorithm            AlgorithmIdentifier,</span>
 <span class="s0">*   subjectPublicKey     BIT STRING</span>
 <span class="s0">* }</span>
 <span class="s0">*</span>
 <span class="s0">* Extensions ::= SEQUENCE SIZE (1..MAX) OF Extension</span>
 <span class="s0">*</span>
 <span class="s0">* Extension ::= SEQUENCE {</span>
 <span class="s0">*   extnID      OBJECT IDENTIFIER,</span>
 <span class="s0">*   critical    BOOLEAN DEFAULT FALSE,</span>
 <span class="s0">*   extnValue   OCTET STRING</span>
 <span class="s0">* }</span>
 <span class="s0">*</span>
 <span class="s0">* The only key algorithm currently supported for PKI is RSA.</span>
 <span class="s0">*</span>
 <span class="s0">* RSASSA-PSS signatures are described in RFC 3447 and RFC 4055.</span>
 <span class="s0">*</span>
 <span class="s0">* PKCS#10 v1.7 describes certificate signing requests:</span>
 <span class="s0">*</span>
 <span class="s0">* CertificationRequestInfo:</span>
 <span class="s0">*</span>
 <span class="s0">* CertificationRequestInfo ::= SEQUENCE {</span>
 <span class="s0">*   version       INTEGER { v1(0) } (v1,...),</span>
 <span class="s0">*   subject       Name,</span>
 <span class="s0">*   subjectPKInfo SubjectPublicKeyInfo{{ PKInfoAlgorithms }},</span>
 <span class="s0">*   attributes    [0] Attributes{{ CRIAttributes }}</span>
 <span class="s0">* }</span>
 <span class="s0">*</span>
 <span class="s0">* Attributes { ATTRIBUTE:IOSet } ::= SET OF Attribute{{ IOSet }}</span>
 <span class="s0">*</span>
 <span class="s0">* CRIAttributes  ATTRIBUTE  ::= {</span>
 <span class="s0">*   ... -- add any locally defined attributes here -- }</span>
 <span class="s0">*</span>
 <span class="s0">* Attribute { ATTRIBUTE:IOSet } ::= SEQUENCE {</span>
 <span class="s0">*   type   ATTRIBUTE.&amp;id({IOSet}),</span>
 <span class="s0">*   values SET SIZE(1..MAX) OF ATTRIBUTE.&amp;Type({IOSet}{</span><span class="s1">@type</span><span class="s0">})</span>
 <span class="s0">* }</span>
 <span class="s0">*</span>
 <span class="s0">* CertificationRequest ::= SEQUENCE {</span>
 <span class="s0">*   certificationRequestInfo CertificationRequestInfo,</span>
 <span class="s0">*   signatureAlgorithm AlgorithmIdentifier{{ SignatureAlgorithms }},</span>
 <span class="s0">*   signature          BIT STRING</span>
 <span class="s0">* }</span>
 <span class="s0">*/</span>
<span class="s3">var </span><span class="s2">forge </span><span class="s4">= </span><span class="s2">require</span><span class="s4">(</span><span class="s5">'./forge'</span><span class="s4">);</span>
<span class="s2">require</span><span class="s4">(</span><span class="s5">'./aes'</span><span class="s4">);</span>
<span class="s2">require</span><span class="s4">(</span><span class="s5">'./asn1'</span><span class="s4">);</span>
<span class="s2">require</span><span class="s4">(</span><span class="s5">'./des'</span><span class="s4">);</span>
<span class="s2">require</span><span class="s4">(</span><span class="s5">'./md'</span><span class="s4">);</span>
<span class="s2">require</span><span class="s4">(</span><span class="s5">'./mgf'</span><span class="s4">);</span>
<span class="s2">require</span><span class="s4">(</span><span class="s5">'./oids'</span><span class="s4">);</span>
<span class="s2">require</span><span class="s4">(</span><span class="s5">'./pem'</span><span class="s4">);</span>
<span class="s2">require</span><span class="s4">(</span><span class="s5">'./pss'</span><span class="s4">);</span>
<span class="s2">require</span><span class="s4">(</span><span class="s5">'./rsa'</span><span class="s4">);</span>
<span class="s2">require</span><span class="s4">(</span><span class="s5">'./util'</span><span class="s4">);</span>

<span class="s6">// shortcut for asn.1 API</span>
<span class="s3">var </span><span class="s2">asn1 </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">asn1</span><span class="s4">;</span>

<span class="s6">/* Public Key Infrastructure (PKI) implementation. */</span>
<span class="s3">var </span><span class="s2">pki </span><span class="s4">= </span><span class="s2">module</span><span class="s4">.</span><span class="s2">exports </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pki </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pki </span><span class="s4">|| {};</span>
<span class="s3">var </span><span class="s2">oids </span><span class="s4">= </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">oids</span><span class="s4">;</span>

<span class="s6">// short name OID mappings</span>
<span class="s3">var </span><span class="s2">_shortNames </span><span class="s4">= {};</span>
<span class="s2">_shortNames</span><span class="s4">[</span><span class="s5">'CN'</span><span class="s4">] = </span><span class="s2">oids</span><span class="s4">[</span><span class="s5">'commonName'</span><span class="s4">];</span>
<span class="s2">_shortNames</span><span class="s4">[</span><span class="s5">'commonName'</span><span class="s4">] = </span><span class="s5">'CN'</span><span class="s4">;</span>
<span class="s2">_shortNames</span><span class="s4">[</span><span class="s5">'C'</span><span class="s4">] = </span><span class="s2">oids</span><span class="s4">[</span><span class="s5">'countryName'</span><span class="s4">];</span>
<span class="s2">_shortNames</span><span class="s4">[</span><span class="s5">'countryName'</span><span class="s4">] = </span><span class="s5">'C'</span><span class="s4">;</span>
<span class="s2">_shortNames</span><span class="s4">[</span><span class="s5">'L'</span><span class="s4">] = </span><span class="s2">oids</span><span class="s4">[</span><span class="s5">'localityName'</span><span class="s4">];</span>
<span class="s2">_shortNames</span><span class="s4">[</span><span class="s5">'localityName'</span><span class="s4">] = </span><span class="s5">'L'</span><span class="s4">;</span>
<span class="s2">_shortNames</span><span class="s4">[</span><span class="s5">'ST'</span><span class="s4">] = </span><span class="s2">oids</span><span class="s4">[</span><span class="s5">'stateOrProvinceName'</span><span class="s4">];</span>
<span class="s2">_shortNames</span><span class="s4">[</span><span class="s5">'stateOrProvinceName'</span><span class="s4">] = </span><span class="s5">'ST'</span><span class="s4">;</span>
<span class="s2">_shortNames</span><span class="s4">[</span><span class="s5">'O'</span><span class="s4">] = </span><span class="s2">oids</span><span class="s4">[</span><span class="s5">'organizationName'</span><span class="s4">];</span>
<span class="s2">_shortNames</span><span class="s4">[</span><span class="s5">'organizationName'</span><span class="s4">] = </span><span class="s5">'O'</span><span class="s4">;</span>
<span class="s2">_shortNames</span><span class="s4">[</span><span class="s5">'OU'</span><span class="s4">] = </span><span class="s2">oids</span><span class="s4">[</span><span class="s5">'organizationalUnitName'</span><span class="s4">];</span>
<span class="s2">_shortNames</span><span class="s4">[</span><span class="s5">'organizationalUnitName'</span><span class="s4">] = </span><span class="s5">'OU'</span><span class="s4">;</span>
<span class="s2">_shortNames</span><span class="s4">[</span><span class="s5">'E'</span><span class="s4">] = </span><span class="s2">oids</span><span class="s4">[</span><span class="s5">'emailAddress'</span><span class="s4">];</span>
<span class="s2">_shortNames</span><span class="s4">[</span><span class="s5">'emailAddress'</span><span class="s4">] = </span><span class="s5">'E'</span><span class="s4">;</span>

<span class="s6">// validator for an SubjectPublicKeyInfo structure</span>
<span class="s6">// Note: Currently only works with an RSA public key</span>
<span class="s3">var </span><span class="s2">publicKeyValidator </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">rsa</span><span class="s4">.</span><span class="s2">publicKeyValidator</span><span class="s4">;</span>

<span class="s6">// validator for an X.509v3 certificate</span>
<span class="s3">var </span><span class="s2">x509CertificateValidator </span><span class="s4">= {</span>
  <span class="s2">name</span><span class="s4">: </span><span class="s5">'Certificate'</span><span class="s4">,</span>
  <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
  <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">,</span>
  <span class="s2">constructed</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
  <span class="s2">value</span><span class="s4">: [{</span>
    <span class="s2">name</span><span class="s4">: </span><span class="s5">'Certificate.TBSCertificate'</span><span class="s4">,</span>
    <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
    <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">,</span>
    <span class="s2">constructed</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
    <span class="s2">captureAsn1</span><span class="s4">: </span><span class="s5">'tbsCertificate'</span><span class="s4">,</span>
    <span class="s2">value</span><span class="s4">: [{</span>
      <span class="s2">name</span><span class="s4">: </span><span class="s5">'Certificate.TBSCertificate.version'</span><span class="s4">,</span>
      <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">CONTEXT_SPECIFIC</span><span class="s4">,</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s7">0</span><span class="s4">,</span>
      <span class="s2">constructed</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">optional</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">value</span><span class="s4">: [{</span>
        <span class="s2">name</span><span class="s4">: </span><span class="s5">'Certificate.TBSCertificate.version.integer'</span><span class="s4">,</span>
        <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
        <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">INTEGER</span><span class="s4">,</span>
        <span class="s2">constructed</span><span class="s4">: </span><span class="s3">false</span><span class="s4">,</span>
        <span class="s2">capture</span><span class="s4">: </span><span class="s5">'certVersion'</span>
      <span class="s4">}]</span>
    <span class="s4">}, {</span>
      <span class="s2">name</span><span class="s4">: </span><span class="s5">'Certificate.TBSCertificate.serialNumber'</span><span class="s4">,</span>
      <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">INTEGER</span><span class="s4">,</span>
      <span class="s2">constructed</span><span class="s4">: </span><span class="s3">false</span><span class="s4">,</span>
      <span class="s2">capture</span><span class="s4">: </span><span class="s5">'certSerialNumber'</span>
    <span class="s4">}, {</span>
      <span class="s2">name</span><span class="s4">: </span><span class="s5">'Certificate.TBSCertificate.signature'</span><span class="s4">,</span>
      <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">,</span>
      <span class="s2">constructed</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">value</span><span class="s4">: [{</span>
        <span class="s2">name</span><span class="s4">: </span><span class="s5">'Certificate.TBSCertificate.signature.algorithm'</span><span class="s4">,</span>
        <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
        <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">OID</span><span class="s4">,</span>
        <span class="s2">constructed</span><span class="s4">: </span><span class="s3">false</span><span class="s4">,</span>
        <span class="s2">capture</span><span class="s4">: </span><span class="s5">'certinfoSignatureOid'</span>
      <span class="s4">}, {</span>
        <span class="s2">name</span><span class="s4">: </span><span class="s5">'Certificate.TBSCertificate.signature.parameters'</span><span class="s4">,</span>
        <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
        <span class="s2">optional</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
        <span class="s2">captureAsn1</span><span class="s4">: </span><span class="s5">'certinfoSignatureParams'</span>
      <span class="s4">}]</span>
    <span class="s4">}, {</span>
      <span class="s2">name</span><span class="s4">: </span><span class="s5">'Certificate.TBSCertificate.issuer'</span><span class="s4">,</span>
      <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">,</span>
      <span class="s2">constructed</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">captureAsn1</span><span class="s4">: </span><span class="s5">'certIssuer'</span>
    <span class="s4">}, {</span>
      <span class="s2">name</span><span class="s4">: </span><span class="s5">'Certificate.TBSCertificate.validity'</span><span class="s4">,</span>
      <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">,</span>
      <span class="s2">constructed</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s6">// Note: UTC and generalized times may both appear so the capture</span>
      <span class="s6">// names are based on their detected order, the names used below</span>
      <span class="s6">// are only for the common case, which validity time really means</span>
      <span class="s6">// &quot;notBefore&quot; and which means &quot;notAfter&quot; will be determined by order</span>
      <span class="s2">value</span><span class="s4">: [{</span>
        <span class="s6">// notBefore (Time) (UTC time case)</span>
        <span class="s2">name</span><span class="s4">: </span><span class="s5">'Certificate.TBSCertificate.validity.notBefore (utc)'</span><span class="s4">,</span>
        <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
        <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">UTCTIME</span><span class="s4">,</span>
        <span class="s2">constructed</span><span class="s4">: </span><span class="s3">false</span><span class="s4">,</span>
        <span class="s2">optional</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
        <span class="s2">capture</span><span class="s4">: </span><span class="s5">'certValidity1UTCTime'</span>
      <span class="s4">}, {</span>
        <span class="s6">// notBefore (Time) (generalized time case)</span>
        <span class="s2">name</span><span class="s4">: </span><span class="s5">'Certificate.TBSCertificate.validity.notBefore (generalized)'</span><span class="s4">,</span>
        <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
        <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">GENERALIZEDTIME</span><span class="s4">,</span>
        <span class="s2">constructed</span><span class="s4">: </span><span class="s3">false</span><span class="s4">,</span>
        <span class="s2">optional</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
        <span class="s2">capture</span><span class="s4">: </span><span class="s5">'certValidity2GeneralizedTime'</span>
      <span class="s4">}, {</span>
        <span class="s6">// notAfter (Time) (only UTC time is supported)</span>
        <span class="s2">name</span><span class="s4">: </span><span class="s5">'Certificate.TBSCertificate.validity.notAfter (utc)'</span><span class="s4">,</span>
        <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
        <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">UTCTIME</span><span class="s4">,</span>
        <span class="s2">constructed</span><span class="s4">: </span><span class="s3">false</span><span class="s4">,</span>
        <span class="s2">optional</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
        <span class="s2">capture</span><span class="s4">: </span><span class="s5">'certValidity3UTCTime'</span>
      <span class="s4">}, {</span>
        <span class="s6">// notAfter (Time) (only UTC time is supported)</span>
        <span class="s2">name</span><span class="s4">: </span><span class="s5">'Certificate.TBSCertificate.validity.notAfter (generalized)'</span><span class="s4">,</span>
        <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
        <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">GENERALIZEDTIME</span><span class="s4">,</span>
        <span class="s2">constructed</span><span class="s4">: </span><span class="s3">false</span><span class="s4">,</span>
        <span class="s2">optional</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
        <span class="s2">capture</span><span class="s4">: </span><span class="s5">'certValidity4GeneralizedTime'</span>
      <span class="s4">}]</span>
    <span class="s4">}, {</span>
      <span class="s6">// Name (subject) (RDNSequence)</span>
      <span class="s2">name</span><span class="s4">: </span><span class="s5">'Certificate.TBSCertificate.subject'</span><span class="s4">,</span>
      <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">,</span>
      <span class="s2">constructed</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">captureAsn1</span><span class="s4">: </span><span class="s5">'certSubject'</span>
    <span class="s4">},</span>
    <span class="s6">// SubjectPublicKeyInfo</span>
    <span class="s2">publicKeyValidator</span><span class="s4">,</span>
    <span class="s4">{</span>
      <span class="s6">// issuerUniqueID (optional)</span>
      <span class="s2">name</span><span class="s4">: </span><span class="s5">'Certificate.TBSCertificate.issuerUniqueID'</span><span class="s4">,</span>
      <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">CONTEXT_SPECIFIC</span><span class="s4">,</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s7">1</span><span class="s4">,</span>
      <span class="s2">constructed</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">optional</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">value</span><span class="s4">: [{</span>
        <span class="s2">name</span><span class="s4">: </span><span class="s5">'Certificate.TBSCertificate.issuerUniqueID.id'</span><span class="s4">,</span>
        <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
        <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">BITSTRING</span><span class="s4">,</span>
        <span class="s2">constructed</span><span class="s4">: </span><span class="s3">false</span><span class="s4">,</span>
        <span class="s6">// TODO: support arbitrary bit length ids</span>
        <span class="s2">captureBitStringValue</span><span class="s4">: </span><span class="s5">'certIssuerUniqueId'</span>
      <span class="s4">}]</span>
    <span class="s4">}, {</span>
      <span class="s6">// subjectUniqueID (optional)</span>
      <span class="s2">name</span><span class="s4">: </span><span class="s5">'Certificate.TBSCertificate.subjectUniqueID'</span><span class="s4">,</span>
      <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">CONTEXT_SPECIFIC</span><span class="s4">,</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s7">2</span><span class="s4">,</span>
      <span class="s2">constructed</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">optional</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">value</span><span class="s4">: [{</span>
        <span class="s2">name</span><span class="s4">: </span><span class="s5">'Certificate.TBSCertificate.subjectUniqueID.id'</span><span class="s4">,</span>
        <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
        <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">BITSTRING</span><span class="s4">,</span>
        <span class="s2">constructed</span><span class="s4">: </span><span class="s3">false</span><span class="s4">,</span>
        <span class="s6">// TODO: support arbitrary bit length ids</span>
        <span class="s2">captureBitStringValue</span><span class="s4">: </span><span class="s5">'certSubjectUniqueId'</span>
      <span class="s4">}]</span>
    <span class="s4">}, {</span>
      <span class="s6">// Extensions (optional)</span>
      <span class="s2">name</span><span class="s4">: </span><span class="s5">'Certificate.TBSCertificate.extensions'</span><span class="s4">,</span>
      <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">CONTEXT_SPECIFIC</span><span class="s4">,</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s7">3</span><span class="s4">,</span>
      <span class="s2">constructed</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">captureAsn1</span><span class="s4">: </span><span class="s5">'certExtensions'</span><span class="s4">,</span>
      <span class="s2">optional</span><span class="s4">: </span><span class="s3">true</span>
    <span class="s4">}]</span>
  <span class="s4">}, {</span>
    <span class="s6">// AlgorithmIdentifier (signature algorithm)</span>
    <span class="s2">name</span><span class="s4">: </span><span class="s5">'Certificate.signatureAlgorithm'</span><span class="s4">,</span>
    <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
    <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">,</span>
    <span class="s2">constructed</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
    <span class="s2">value</span><span class="s4">: [{</span>
      <span class="s6">// algorithm</span>
      <span class="s2">name</span><span class="s4">: </span><span class="s5">'Certificate.signatureAlgorithm.algorithm'</span><span class="s4">,</span>
      <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">OID</span><span class="s4">,</span>
      <span class="s2">constructed</span><span class="s4">: </span><span class="s3">false</span><span class="s4">,</span>
      <span class="s2">capture</span><span class="s4">: </span><span class="s5">'certSignatureOid'</span>
    <span class="s4">}, {</span>
      <span class="s2">name</span><span class="s4">: </span><span class="s5">'Certificate.TBSCertificate.signature.parameters'</span><span class="s4">,</span>
      <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
      <span class="s2">optional</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">captureAsn1</span><span class="s4">: </span><span class="s5">'certSignatureParams'</span>
    <span class="s4">}]</span>
  <span class="s4">}, {</span>
    <span class="s6">// SignatureValue</span>
    <span class="s2">name</span><span class="s4">: </span><span class="s5">'Certificate.signatureValue'</span><span class="s4">,</span>
    <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
    <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">BITSTRING</span><span class="s4">,</span>
    <span class="s2">constructed</span><span class="s4">: </span><span class="s3">false</span><span class="s4">,</span>
    <span class="s2">captureBitStringValue</span><span class="s4">: </span><span class="s5">'certSignature'</span>
  <span class="s4">}]</span>
<span class="s4">};</span>

<span class="s3">var </span><span class="s2">rsassaPssParameterValidator </span><span class="s4">= {</span>
  <span class="s2">name</span><span class="s4">: </span><span class="s5">'rsapss'</span><span class="s4">,</span>
  <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
  <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">,</span>
  <span class="s2">constructed</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
  <span class="s2">value</span><span class="s4">: [{</span>
    <span class="s2">name</span><span class="s4">: </span><span class="s5">'rsapss.hashAlgorithm'</span><span class="s4">,</span>
    <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">CONTEXT_SPECIFIC</span><span class="s4">,</span>
    <span class="s2">type</span><span class="s4">: </span><span class="s7">0</span><span class="s4">,</span>
    <span class="s2">constructed</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
    <span class="s2">value</span><span class="s4">: [{</span>
      <span class="s2">name</span><span class="s4">: </span><span class="s5">'rsapss.hashAlgorithm.AlgorithmIdentifier'</span><span class="s4">,</span>
      <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">,</span>
      <span class="s2">constructed</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">optional</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">value</span><span class="s4">: [{</span>
        <span class="s2">name</span><span class="s4">: </span><span class="s5">'rsapss.hashAlgorithm.AlgorithmIdentifier.algorithm'</span><span class="s4">,</span>
        <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
        <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">OID</span><span class="s4">,</span>
        <span class="s2">constructed</span><span class="s4">: </span><span class="s3">false</span><span class="s4">,</span>
        <span class="s2">capture</span><span class="s4">: </span><span class="s5">'hashOid'</span>
        <span class="s6">/* parameter block omitted, for SHA1 NULL anyhow. */</span>
      <span class="s4">}]</span>
    <span class="s4">}]</span>
  <span class="s4">}, {</span>
    <span class="s2">name</span><span class="s4">: </span><span class="s5">'rsapss.maskGenAlgorithm'</span><span class="s4">,</span>
    <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">CONTEXT_SPECIFIC</span><span class="s4">,</span>
    <span class="s2">type</span><span class="s4">: </span><span class="s7">1</span><span class="s4">,</span>
    <span class="s2">constructed</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
    <span class="s2">value</span><span class="s4">: [{</span>
      <span class="s2">name</span><span class="s4">: </span><span class="s5">'rsapss.maskGenAlgorithm.AlgorithmIdentifier'</span><span class="s4">,</span>
      <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">,</span>
      <span class="s2">constructed</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">optional</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">value</span><span class="s4">: [{</span>
        <span class="s2">name</span><span class="s4">: </span><span class="s5">'rsapss.maskGenAlgorithm.AlgorithmIdentifier.algorithm'</span><span class="s4">,</span>
        <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
        <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">OID</span><span class="s4">,</span>
        <span class="s2">constructed</span><span class="s4">: </span><span class="s3">false</span><span class="s4">,</span>
        <span class="s2">capture</span><span class="s4">: </span><span class="s5">'maskGenOid'</span>
      <span class="s4">}, {</span>
        <span class="s2">name</span><span class="s4">: </span><span class="s5">'rsapss.maskGenAlgorithm.AlgorithmIdentifier.params'</span><span class="s4">,</span>
        <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
        <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">,</span>
        <span class="s2">constructed</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
        <span class="s2">value</span><span class="s4">: [{</span>
          <span class="s2">name</span><span class="s4">: </span><span class="s5">'rsapss.maskGenAlgorithm.AlgorithmIdentifier.params.algorithm'</span><span class="s4">,</span>
          <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
          <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">OID</span><span class="s4">,</span>
          <span class="s2">constructed</span><span class="s4">: </span><span class="s3">false</span><span class="s4">,</span>
          <span class="s2">capture</span><span class="s4">: </span><span class="s5">'maskGenHashOid'</span>
          <span class="s6">/* parameter block omitted, for SHA1 NULL anyhow. */</span>
        <span class="s4">}]</span>
      <span class="s4">}]</span>
    <span class="s4">}]</span>
  <span class="s4">}, {</span>
    <span class="s2">name</span><span class="s4">: </span><span class="s5">'rsapss.saltLength'</span><span class="s4">,</span>
    <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">CONTEXT_SPECIFIC</span><span class="s4">,</span>
    <span class="s2">type</span><span class="s4">: </span><span class="s7">2</span><span class="s4">,</span>
    <span class="s2">optional</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
    <span class="s2">value</span><span class="s4">: [{</span>
      <span class="s2">name</span><span class="s4">: </span><span class="s5">'rsapss.saltLength.saltLength'</span><span class="s4">,</span>
      <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">INTEGER</span><span class="s4">,</span>
      <span class="s2">constructed</span><span class="s4">: </span><span class="s3">false</span><span class="s4">,</span>
      <span class="s2">capture</span><span class="s4">: </span><span class="s5">'saltLength'</span>
    <span class="s4">}]</span>
  <span class="s4">}, {</span>
    <span class="s2">name</span><span class="s4">: </span><span class="s5">'rsapss.trailerField'</span><span class="s4">,</span>
    <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">CONTEXT_SPECIFIC</span><span class="s4">,</span>
    <span class="s2">type</span><span class="s4">: </span><span class="s7">3</span><span class="s4">,</span>
    <span class="s2">optional</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
    <span class="s2">value</span><span class="s4">: [{</span>
      <span class="s2">name</span><span class="s4">: </span><span class="s5">'rsapss.trailer.trailer'</span><span class="s4">,</span>
      <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">INTEGER</span><span class="s4">,</span>
      <span class="s2">constructed</span><span class="s4">: </span><span class="s3">false</span><span class="s4">,</span>
      <span class="s2">capture</span><span class="s4">: </span><span class="s5">'trailer'</span>
    <span class="s4">}]</span>
  <span class="s4">}]</span>
<span class="s4">};</span>

<span class="s6">// validator for a CertificationRequestInfo structure</span>
<span class="s3">var </span><span class="s2">certificationRequestInfoValidator </span><span class="s4">= {</span>
  <span class="s2">name</span><span class="s4">: </span><span class="s5">'CertificationRequestInfo'</span><span class="s4">,</span>
  <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
  <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">,</span>
  <span class="s2">constructed</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
  <span class="s2">captureAsn1</span><span class="s4">: </span><span class="s5">'certificationRequestInfo'</span><span class="s4">,</span>
  <span class="s2">value</span><span class="s4">: [{</span>
    <span class="s2">name</span><span class="s4">: </span><span class="s5">'CertificationRequestInfo.integer'</span><span class="s4">,</span>
    <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
    <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">INTEGER</span><span class="s4">,</span>
    <span class="s2">constructed</span><span class="s4">: </span><span class="s3">false</span><span class="s4">,</span>
    <span class="s2">capture</span><span class="s4">: </span><span class="s5">'certificationRequestInfoVersion'</span>
  <span class="s4">}, {</span>
    <span class="s6">// Name (subject) (RDNSequence)</span>
    <span class="s2">name</span><span class="s4">: </span><span class="s5">'CertificationRequestInfo.subject'</span><span class="s4">,</span>
    <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
    <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">,</span>
    <span class="s2">constructed</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
    <span class="s2">captureAsn1</span><span class="s4">: </span><span class="s5">'certificationRequestInfoSubject'</span>
  <span class="s4">},</span>
  <span class="s6">// SubjectPublicKeyInfo</span>
  <span class="s2">publicKeyValidator</span><span class="s4">,</span>
  <span class="s4">{</span>
    <span class="s2">name</span><span class="s4">: </span><span class="s5">'CertificationRequestInfo.attributes'</span><span class="s4">,</span>
    <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">CONTEXT_SPECIFIC</span><span class="s4">,</span>
    <span class="s2">type</span><span class="s4">: </span><span class="s7">0</span><span class="s4">,</span>
    <span class="s2">constructed</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
    <span class="s2">optional</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
    <span class="s2">capture</span><span class="s4">: </span><span class="s5">'certificationRequestInfoAttributes'</span><span class="s4">,</span>
    <span class="s2">value</span><span class="s4">: [{</span>
      <span class="s2">name</span><span class="s4">: </span><span class="s5">'CertificationRequestInfo.attributes'</span><span class="s4">,</span>
      <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">,</span>
      <span class="s2">constructed</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">value</span><span class="s4">: [{</span>
        <span class="s2">name</span><span class="s4">: </span><span class="s5">'CertificationRequestInfo.attributes.type'</span><span class="s4">,</span>
        <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
        <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">OID</span><span class="s4">,</span>
        <span class="s2">constructed</span><span class="s4">: </span><span class="s3">false</span>
      <span class="s4">}, {</span>
        <span class="s2">name</span><span class="s4">: </span><span class="s5">'CertificationRequestInfo.attributes.value'</span><span class="s4">,</span>
        <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
        <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SET</span><span class="s4">,</span>
        <span class="s2">constructed</span><span class="s4">: </span><span class="s3">true</span>
      <span class="s4">}]</span>
    <span class="s4">}]</span>
  <span class="s4">}]</span>
<span class="s4">};</span>

<span class="s6">// validator for a CertificationRequest structure</span>
<span class="s3">var </span><span class="s2">certificationRequestValidator </span><span class="s4">= {</span>
  <span class="s2">name</span><span class="s4">: </span><span class="s5">'CertificationRequest'</span><span class="s4">,</span>
  <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
  <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">,</span>
  <span class="s2">constructed</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
  <span class="s2">captureAsn1</span><span class="s4">: </span><span class="s5">'csr'</span><span class="s4">,</span>
  <span class="s2">value</span><span class="s4">: [</span>
    <span class="s2">certificationRequestInfoValidator</span><span class="s4">, {</span>
      <span class="s6">// AlgorithmIdentifier (signature algorithm)</span>
      <span class="s2">name</span><span class="s4">: </span><span class="s5">'CertificationRequest.signatureAlgorithm'</span><span class="s4">,</span>
      <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">,</span>
      <span class="s2">constructed</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">value</span><span class="s4">: [{</span>
        <span class="s6">// algorithm</span>
        <span class="s2">name</span><span class="s4">: </span><span class="s5">'CertificationRequest.signatureAlgorithm.algorithm'</span><span class="s4">,</span>
        <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
        <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">OID</span><span class="s4">,</span>
        <span class="s2">constructed</span><span class="s4">: </span><span class="s3">false</span><span class="s4">,</span>
        <span class="s2">capture</span><span class="s4">: </span><span class="s5">'csrSignatureOid'</span>
      <span class="s4">}, {</span>
        <span class="s2">name</span><span class="s4">: </span><span class="s5">'CertificationRequest.signatureAlgorithm.parameters'</span><span class="s4">,</span>
        <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
        <span class="s2">optional</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
        <span class="s2">captureAsn1</span><span class="s4">: </span><span class="s5">'csrSignatureParams'</span>
      <span class="s4">}]</span>
    <span class="s4">}, {</span>
      <span class="s6">// signature</span>
      <span class="s2">name</span><span class="s4">: </span><span class="s5">'CertificationRequest.signature'</span><span class="s4">,</span>
      <span class="s2">tagClass</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">,</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">BITSTRING</span><span class="s4">,</span>
      <span class="s2">constructed</span><span class="s4">: </span><span class="s3">false</span><span class="s4">,</span>
      <span class="s2">captureBitStringValue</span><span class="s4">: </span><span class="s5">'csrSignature'</span>
    <span class="s4">}</span>
  <span class="s4">]</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Converts an RDNSequence of ASN.1 DER-encoded RelativeDistinguishedName</span>
 <span class="s0">* sets into an array with objects that have type and value properties.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">rdn the RDNSequence to convert.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">md a message digest to append type and value to if provided.</span>
 <span class="s0">*/</span>
<span class="s2">pki</span><span class="s4">.</span><span class="s2">RDNAttributesAsArray </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">rdn</span><span class="s4">, </span><span class="s2">md</span><span class="s4">) {</span>
  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= [];</span>

  <span class="s6">// each value in 'rdn' in is a SET of RelativeDistinguishedName</span>
  <span class="s3">var </span><span class="s2">set</span><span class="s4">, </span><span class="s2">attr</span><span class="s4">, </span><span class="s2">obj</span><span class="s4">;</span>
  <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">si </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">si </span><span class="s4">&lt; </span><span class="s2">rdn</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">si</span><span class="s4">) {</span>
    <span class="s6">// get the RelativeDistinguishedName set</span>
    <span class="s2">set </span><span class="s4">= </span><span class="s2">rdn</span><span class="s4">.</span><span class="s2">value</span><span class="s4">[</span><span class="s2">si</span><span class="s4">];</span>

    <span class="s6">// each value in the SET is an AttributeTypeAndValue sequence</span>
    <span class="s6">// containing first a type (an OID) and second a value (defined by</span>
    <span class="s6">// the OID)</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">set</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s2">obj </span><span class="s4">= {};</span>
      <span class="s2">attr </span><span class="s4">= </span><span class="s2">set</span><span class="s4">.</span><span class="s2">value</span><span class="s4">[</span><span class="s2">i</span><span class="s4">];</span>
      <span class="s2">obj</span><span class="s4">.</span><span class="s2">type </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">derToOid</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">.</span><span class="s2">value</span><span class="s4">[</span><span class="s7">0</span><span class="s4">].</span><span class="s2">value</span><span class="s4">);</span>
      <span class="s2">obj</span><span class="s4">.</span><span class="s2">value </span><span class="s4">= </span><span class="s2">attr</span><span class="s4">.</span><span class="s2">value</span><span class="s4">[</span><span class="s7">1</span><span class="s4">].</span><span class="s2">value</span><span class="s4">;</span>
      <span class="s2">obj</span><span class="s4">.</span><span class="s2">valueTagClass </span><span class="s4">= </span><span class="s2">attr</span><span class="s4">.</span><span class="s2">value</span><span class="s4">[</span><span class="s7">1</span><span class="s4">].</span><span class="s2">type</span><span class="s4">;</span>
      <span class="s6">// if the OID is known, get its name and short name</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">obj</span><span class="s4">.</span><span class="s2">type </span><span class="s3">in </span><span class="s2">oids</span><span class="s4">) {</span>
        <span class="s2">obj</span><span class="s4">.</span><span class="s2">name </span><span class="s4">= </span><span class="s2">oids</span><span class="s4">[</span><span class="s2">obj</span><span class="s4">.</span><span class="s2">type</span><span class="s4">];</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s2">obj</span><span class="s4">.</span><span class="s2">name </span><span class="s3">in </span><span class="s2">_shortNames</span><span class="s4">) {</span>
          <span class="s2">obj</span><span class="s4">.</span><span class="s2">shortName </span><span class="s4">= </span><span class="s2">_shortNames</span><span class="s4">[</span><span class="s2">obj</span><span class="s4">.</span><span class="s2">name</span><span class="s4">];</span>
        <span class="s4">}</span>
      <span class="s4">}</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">md</span><span class="s4">) {</span>
        <span class="s2">md</span><span class="s4">.</span><span class="s2">update</span><span class="s4">(</span><span class="s2">obj</span><span class="s4">.</span><span class="s2">type</span><span class="s4">);</span>
        <span class="s2">md</span><span class="s4">.</span><span class="s2">update</span><span class="s4">(</span><span class="s2">obj</span><span class="s4">.</span><span class="s2">value</span><span class="s4">);</span>
      <span class="s4">}</span>
      <span class="s2">rval</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">obj</span><span class="s4">);</span>
    <span class="s4">}</span>
  <span class="s4">}</span>

  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Converts ASN.1 CRIAttributes into an array with objects that have type and</span>
 <span class="s0">* value properties.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">attributes the CRIAttributes to convert.</span>
 <span class="s0">*/</span>
<span class="s2">pki</span><span class="s4">.</span><span class="s2">CRIAttributesAsArray </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">attributes</span><span class="s4">) {</span>
  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= [];</span>

  <span class="s6">// each value in 'attributes' in is a SEQUENCE with an OID and a SET</span>
  <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">si </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">si </span><span class="s4">&lt; </span><span class="s2">attributes</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">si</span><span class="s4">) {</span>
    <span class="s6">// get the attribute sequence</span>
    <span class="s3">var </span><span class="s2">seq </span><span class="s4">= </span><span class="s2">attributes</span><span class="s4">[</span><span class="s2">si</span><span class="s4">];</span>

    <span class="s6">// each value in the SEQUENCE containing first a type (an OID) and</span>
    <span class="s6">// second a set of values (defined by the OID)</span>
    <span class="s3">var </span><span class="s2">type </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">derToOid</span><span class="s4">(</span><span class="s2">seq</span><span class="s4">.</span><span class="s2">value</span><span class="s4">[</span><span class="s7">0</span><span class="s4">].</span><span class="s2">value</span><span class="s4">);</span>
    <span class="s3">var </span><span class="s2">values </span><span class="s4">= </span><span class="s2">seq</span><span class="s4">.</span><span class="s2">value</span><span class="s4">[</span><span class="s7">1</span><span class="s4">].</span><span class="s2">value</span><span class="s4">;</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">vi </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">vi </span><span class="s4">&lt; </span><span class="s2">values</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">vi</span><span class="s4">) {</span>
      <span class="s3">var </span><span class="s2">obj </span><span class="s4">= {};</span>
      <span class="s2">obj</span><span class="s4">.</span><span class="s2">type </span><span class="s4">= </span><span class="s2">type</span><span class="s4">;</span>
      <span class="s2">obj</span><span class="s4">.</span><span class="s2">value </span><span class="s4">= </span><span class="s2">values</span><span class="s4">[</span><span class="s2">vi</span><span class="s4">].</span><span class="s2">value</span><span class="s4">;</span>
      <span class="s2">obj</span><span class="s4">.</span><span class="s2">valueTagClass </span><span class="s4">= </span><span class="s2">values</span><span class="s4">[</span><span class="s2">vi</span><span class="s4">].</span><span class="s2">type</span><span class="s4">;</span>
      <span class="s6">// if the OID is known, get its name and short name</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">obj</span><span class="s4">.</span><span class="s2">type </span><span class="s3">in </span><span class="s2">oids</span><span class="s4">) {</span>
        <span class="s2">obj</span><span class="s4">.</span><span class="s2">name </span><span class="s4">= </span><span class="s2">oids</span><span class="s4">[</span><span class="s2">obj</span><span class="s4">.</span><span class="s2">type</span><span class="s4">];</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s2">obj</span><span class="s4">.</span><span class="s2">name </span><span class="s3">in </span><span class="s2">_shortNames</span><span class="s4">) {</span>
          <span class="s2">obj</span><span class="s4">.</span><span class="s2">shortName </span><span class="s4">= </span><span class="s2">_shortNames</span><span class="s4">[</span><span class="s2">obj</span><span class="s4">.</span><span class="s2">name</span><span class="s4">];</span>
        <span class="s4">}</span>
      <span class="s4">}</span>
      <span class="s6">// parse extensions</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">obj</span><span class="s4">.</span><span class="s2">type </span><span class="s4">=== </span><span class="s2">oids</span><span class="s4">.</span><span class="s2">extensionRequest</span><span class="s4">) {</span>
        <span class="s2">obj</span><span class="s4">.</span><span class="s2">extensions </span><span class="s4">= [];</span>
        <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">ei </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">ei </span><span class="s4">&lt; </span><span class="s2">obj</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">ei</span><span class="s4">) {</span>
          <span class="s2">obj</span><span class="s4">.</span><span class="s2">extensions</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateExtensionFromAsn1</span><span class="s4">(</span><span class="s2">obj</span><span class="s4">.</span><span class="s2">value</span><span class="s4">[</span><span class="s2">ei</span><span class="s4">]));</span>
        <span class="s4">}</span>
      <span class="s4">}</span>
      <span class="s2">rval</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">obj</span><span class="s4">);</span>
    <span class="s4">}</span>
  <span class="s4">}</span>

  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Gets an issuer or subject attribute from its name, type, or short name.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">obj the issuer or subject object.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">options a short name string or an object with:</span>
 <span class="s0">*          shortName the short name for the attribute.</span>
 <span class="s0">*          name the name for the attribute.</span>
 <span class="s0">*          type the type for the attribute.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the attribute.</span>
 <span class="s0">*/</span>
<span class="s3">function </span><span class="s2">_getAttribute</span><span class="s4">(</span><span class="s2">obj</span><span class="s4">, </span><span class="s2">options</span><span class="s4">) {</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s3">typeof </span><span class="s2">options </span><span class="s4">=== </span><span class="s5">'string'</span><span class="s4">) {</span>
    <span class="s2">options </span><span class="s4">= {</span><span class="s2">shortName</span><span class="s4">: </span><span class="s2">options</span><span class="s4">};</span>
  <span class="s4">}</span>

  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">attr</span><span class="s4">;</span>
  <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">rval </span><span class="s4">=== </span><span class="s3">null </span><span class="s4">&amp;&amp; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">obj</span><span class="s4">.</span><span class="s2">attributes</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
    <span class="s2">attr </span><span class="s4">= </span><span class="s2">obj</span><span class="s4">.</span><span class="s2">attributes</span><span class="s4">[</span><span class="s2">i</span><span class="s4">];</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">options</span><span class="s4">.</span><span class="s2">type </span><span class="s4">&amp;&amp; </span><span class="s2">options</span><span class="s4">.</span><span class="s2">type </span><span class="s4">=== </span><span class="s2">attr</span><span class="s4">.</span><span class="s2">type</span><span class="s4">) {</span>
      <span class="s2">rval </span><span class="s4">= </span><span class="s2">attr</span><span class="s4">;</span>
    <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">options</span><span class="s4">.</span><span class="s2">name </span><span class="s4">&amp;&amp; </span><span class="s2">options</span><span class="s4">.</span><span class="s2">name </span><span class="s4">=== </span><span class="s2">attr</span><span class="s4">.</span><span class="s2">name</span><span class="s4">) {</span>
      <span class="s2">rval </span><span class="s4">= </span><span class="s2">attr</span><span class="s4">;</span>
    <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">options</span><span class="s4">.</span><span class="s2">shortName </span><span class="s4">&amp;&amp; </span><span class="s2">options</span><span class="s4">.</span><span class="s2">shortName </span><span class="s4">=== </span><span class="s2">attr</span><span class="s4">.</span><span class="s2">shortName</span><span class="s4">) {</span>
      <span class="s2">rval </span><span class="s4">= </span><span class="s2">attr</span><span class="s4">;</span>
    <span class="s4">}</span>
  <span class="s4">}</span>
  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">}</span>

<span class="s0">/**</span>
 <span class="s0">* Converts signature parameters from ASN.1 structure.</span>
 <span class="s0">*</span>
 <span class="s0">* Currently only RSASSA-PSS supported.  The PKCS#1 v1.5 signature scheme had</span>
 <span class="s0">* no parameters.</span>
 <span class="s0">*</span>
 <span class="s0">* RSASSA-PSS-params  ::=  SEQUENCE  {</span>
 <span class="s0">*   hashAlgorithm      [0] HashAlgorithm DEFAULT</span>
 <span class="s0">*                             sha1Identifier,</span>
 <span class="s0">*   maskGenAlgorithm   [1] MaskGenAlgorithm DEFAULT</span>
 <span class="s0">*                             mgf1SHA1Identifier,</span>
 <span class="s0">*   saltLength         [2] INTEGER DEFAULT 20,</span>
 <span class="s0">*   trailerField       [3] INTEGER DEFAULT 1</span>
 <span class="s0">* }</span>
 <span class="s0">*</span>
 <span class="s0">* HashAlgorithm  ::=  AlgorithmIdentifier</span>
 <span class="s0">*</span>
 <span class="s0">* MaskGenAlgorithm  ::=  AlgorithmIdentifier</span>
 <span class="s0">*</span>
 <span class="s0">* AlgorithmIdentifer ::= SEQUENCE {</span>
 <span class="s0">*   algorithm OBJECT IDENTIFIER,</span>
 <span class="s0">*   parameters ANY DEFINED BY algorithm OPTIONAL</span>
 <span class="s0">* }</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">oid The OID specifying the signature algorithm</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">obj The ASN.1 structure holding the parameters</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">fillDefaults Whether to use return default values where omitted</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">signature parameter object</span>
 <span class="s0">*/</span>
<span class="s3">var </span><span class="s2">_readSignatureParameters </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">oid</span><span class="s4">, </span><span class="s2">obj</span><span class="s4">, </span><span class="s2">fillDefaults</span><span class="s4">) {</span>
  <span class="s3">var </span><span class="s2">params </span><span class="s4">= {};</span>

  <span class="s3">if</span><span class="s4">(</span><span class="s2">oid </span><span class="s4">!== </span><span class="s2">oids</span><span class="s4">[</span><span class="s5">'RSASSA-PSS'</span><span class="s4">]) {</span>
    <span class="s3">return </span><span class="s2">params</span><span class="s4">;</span>
  <span class="s4">}</span>

  <span class="s3">if</span><span class="s4">(</span><span class="s2">fillDefaults</span><span class="s4">) {</span>
    <span class="s2">params </span><span class="s4">= {</span>
      <span class="s2">hash</span><span class="s4">: {</span>
        <span class="s2">algorithmOid</span><span class="s4">: </span><span class="s2">oids</span><span class="s4">[</span><span class="s5">'sha1'</span><span class="s4">]</span>
      <span class="s4">},</span>
      <span class="s2">mgf</span><span class="s4">: {</span>
        <span class="s2">algorithmOid</span><span class="s4">: </span><span class="s2">oids</span><span class="s4">[</span><span class="s5">'mgf1'</span><span class="s4">],</span>
        <span class="s2">hash</span><span class="s4">: {</span>
          <span class="s2">algorithmOid</span><span class="s4">: </span><span class="s2">oids</span><span class="s4">[</span><span class="s5">'sha1'</span><span class="s4">]</span>
        <span class="s4">}</span>
      <span class="s4">},</span>
      <span class="s2">saltLength</span><span class="s4">: </span><span class="s7">20</span>
    <span class="s4">};</span>
  <span class="s4">}</span>

  <span class="s3">var </span><span class="s2">capture </span><span class="s4">= {};</span>
  <span class="s3">var </span><span class="s2">errors </span><span class="s4">= [];</span>
  <span class="s3">if</span><span class="s4">(!</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">validate</span><span class="s4">(</span><span class="s2">obj</span><span class="s4">, </span><span class="s2">rsassaPssParameterValidator</span><span class="s4">, </span><span class="s2">capture</span><span class="s4">, </span><span class="s2">errors</span><span class="s4">)) {</span>
    <span class="s3">var </span><span class="s2">error </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Cannot read RSASSA-PSS parameter block.'</span><span class="s4">);</span>
    <span class="s2">error</span><span class="s4">.</span><span class="s2">errors </span><span class="s4">= </span><span class="s2">errors</span><span class="s4">;</span>
    <span class="s3">throw </span><span class="s2">error</span><span class="s4">;</span>
  <span class="s4">}</span>

  <span class="s3">if</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">hashOid </span><span class="s4">!== </span><span class="s2">undefined</span><span class="s4">) {</span>
    <span class="s2">params</span><span class="s4">.</span><span class="s2">hash </span><span class="s4">= </span><span class="s2">params</span><span class="s4">.</span><span class="s2">hash </span><span class="s4">|| {};</span>
    <span class="s2">params</span><span class="s4">.</span><span class="s2">hash</span><span class="s4">.</span><span class="s2">algorithmOid </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">derToOid</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">hashOid</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s3">if</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">maskGenOid </span><span class="s4">!== </span><span class="s2">undefined</span><span class="s4">) {</span>
    <span class="s2">params</span><span class="s4">.</span><span class="s2">mgf </span><span class="s4">= </span><span class="s2">params</span><span class="s4">.</span><span class="s2">mgf </span><span class="s4">|| {};</span>
    <span class="s2">params</span><span class="s4">.</span><span class="s2">mgf</span><span class="s4">.</span><span class="s2">algorithmOid </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">derToOid</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">maskGenOid</span><span class="s4">);</span>
    <span class="s2">params</span><span class="s4">.</span><span class="s2">mgf</span><span class="s4">.</span><span class="s2">hash </span><span class="s4">= </span><span class="s2">params</span><span class="s4">.</span><span class="s2">mgf</span><span class="s4">.</span><span class="s2">hash </span><span class="s4">|| {};</span>
    <span class="s2">params</span><span class="s4">.</span><span class="s2">mgf</span><span class="s4">.</span><span class="s2">hash</span><span class="s4">.</span><span class="s2">algorithmOid </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">derToOid</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">maskGenHashOid</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s3">if</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">saltLength </span><span class="s4">!== </span><span class="s2">undefined</span><span class="s4">) {</span>
    <span class="s2">params</span><span class="s4">.</span><span class="s2">saltLength </span><span class="s4">= </span><span class="s2">capture</span><span class="s4">.</span><span class="s2">saltLength</span><span class="s4">.</span><span class="s2">charCodeAt</span><span class="s4">(</span><span class="s7">0</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s3">return </span><span class="s2">params</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Create signature digest for OID.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">options</span>
 <span class="s0">*   signatureOid: the OID specifying the signature algorithm.</span>
 <span class="s0">*   type: a human readable type for error messages</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">a created md instance. throws if unknown oid.</span>
 <span class="s0">*/</span>
<span class="s3">var </span><span class="s2">_createSignatureDigest </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">options</span><span class="s4">) {</span>
  <span class="s3">switch</span><span class="s4">(</span><span class="s2">oids</span><span class="s4">[</span><span class="s2">options</span><span class="s4">.</span><span class="s2">signatureOid</span><span class="s4">]) {</span>
    <span class="s3">case </span><span class="s5">'sha1WithRSAEncryption'</span><span class="s4">:</span>
    <span class="s6">// deprecated alias</span>
    <span class="s3">case </span><span class="s5">'sha1WithRSASignature'</span><span class="s4">:</span>
      <span class="s3">return </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">sha1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">();</span>
    <span class="s3">case </span><span class="s5">'md5WithRSAEncryption'</span><span class="s4">:</span>
      <span class="s3">return </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">md5</span><span class="s4">.</span><span class="s2">create</span><span class="s4">();</span>
    <span class="s3">case </span><span class="s5">'sha256WithRSAEncryption'</span><span class="s4">:</span>
      <span class="s3">return </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">sha256</span><span class="s4">.</span><span class="s2">create</span><span class="s4">();</span>
    <span class="s3">case </span><span class="s5">'sha384WithRSAEncryption'</span><span class="s4">:</span>
      <span class="s3">return </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">sha384</span><span class="s4">.</span><span class="s2">create</span><span class="s4">();</span>
    <span class="s3">case </span><span class="s5">'sha512WithRSAEncryption'</span><span class="s4">:</span>
      <span class="s3">return </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">sha512</span><span class="s4">.</span><span class="s2">create</span><span class="s4">();</span>
    <span class="s3">case </span><span class="s5">'RSASSA-PSS'</span><span class="s4">:</span>
      <span class="s3">return </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">sha256</span><span class="s4">.</span><span class="s2">create</span><span class="s4">();</span>
    <span class="s3">default</span><span class="s4">:</span>
      <span class="s3">var </span><span class="s2">error </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Error</span><span class="s4">(</span>
        <span class="s5">'Could not compute ' </span><span class="s4">+ </span><span class="s2">options</span><span class="s4">.</span><span class="s2">type </span><span class="s4">+ </span><span class="s5">' digest. ' </span><span class="s4">+</span>
        <span class="s5">'Unknown signature OID.'</span><span class="s4">);</span>
      <span class="s2">error</span><span class="s4">.</span><span class="s2">signatureOid </span><span class="s4">= </span><span class="s2">options</span><span class="s4">.</span><span class="s2">signatureOid</span><span class="s4">;</span>
      <span class="s3">throw </span><span class="s2">error</span><span class="s4">;</span>
  <span class="s4">}</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Verify signature on certificate or CSR.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">options:</span>
 <span class="s0">*   certificate the certificate or CSR to verify.</span>
 <span class="s0">*   md the signature digest.</span>
 <span class="s0">*   signature the signature</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">a created md instance. throws if unknown oid.</span>
 <span class="s0">*/</span>
<span class="s3">var </span><span class="s2">_verifySignature </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">options</span><span class="s4">) {</span>
  <span class="s3">var </span><span class="s2">cert </span><span class="s4">= </span><span class="s2">options</span><span class="s4">.</span><span class="s2">certificate</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">scheme</span><span class="s4">;</span>

  <span class="s3">switch</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">signatureOid</span><span class="s4">) {</span>
    <span class="s3">case </span><span class="s2">oids</span><span class="s4">.</span><span class="s2">sha1WithRSAEncryption</span><span class="s4">:</span>
    <span class="s6">// deprecated alias</span>
    <span class="s3">case </span><span class="s2">oids</span><span class="s4">.</span><span class="s2">sha1WithRSASignature</span><span class="s4">:</span>
      <span class="s6">/* use PKCS#1 v1.5 padding scheme */</span>
      <span class="s3">break</span><span class="s4">;</span>
    <span class="s3">case </span><span class="s2">oids</span><span class="s4">[</span><span class="s5">'RSASSA-PSS'</span><span class="s4">]:</span>
      <span class="s3">var </span><span class="s2">hash</span><span class="s4">, </span><span class="s2">mgf</span><span class="s4">;</span>

      <span class="s6">/* initialize mgf */</span>
      <span class="s2">hash </span><span class="s4">= </span><span class="s2">oids</span><span class="s4">[</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">signatureParameters</span><span class="s4">.</span><span class="s2">mgf</span><span class="s4">.</span><span class="s2">hash</span><span class="s4">.</span><span class="s2">algorithmOid</span><span class="s4">];</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">hash </span><span class="s4">=== </span><span class="s2">undefined </span><span class="s4">|| </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">[</span><span class="s2">hash</span><span class="s4">] === </span><span class="s2">undefined</span><span class="s4">) {</span>
        <span class="s3">var </span><span class="s2">error </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Unsupported MGF hash function.'</span><span class="s4">);</span>
        <span class="s2">error</span><span class="s4">.</span><span class="s2">oid </span><span class="s4">= </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">signatureParameters</span><span class="s4">.</span><span class="s2">mgf</span><span class="s4">.</span><span class="s2">hash</span><span class="s4">.</span><span class="s2">algorithmOid</span><span class="s4">;</span>
        <span class="s2">error</span><span class="s4">.</span><span class="s2">name </span><span class="s4">= </span><span class="s2">hash</span><span class="s4">;</span>
        <span class="s3">throw </span><span class="s2">error</span><span class="s4">;</span>
      <span class="s4">}</span>

      <span class="s2">mgf </span><span class="s4">= </span><span class="s2">oids</span><span class="s4">[</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">signatureParameters</span><span class="s4">.</span><span class="s2">mgf</span><span class="s4">.</span><span class="s2">algorithmOid</span><span class="s4">];</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">mgf </span><span class="s4">=== </span><span class="s2">undefined </span><span class="s4">|| </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">mgf</span><span class="s4">[</span><span class="s2">mgf</span><span class="s4">] === </span><span class="s2">undefined</span><span class="s4">) {</span>
        <span class="s3">var </span><span class="s2">error </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Unsupported MGF function.'</span><span class="s4">);</span>
        <span class="s2">error</span><span class="s4">.</span><span class="s2">oid </span><span class="s4">= </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">signatureParameters</span><span class="s4">.</span><span class="s2">mgf</span><span class="s4">.</span><span class="s2">algorithmOid</span><span class="s4">;</span>
        <span class="s2">error</span><span class="s4">.</span><span class="s2">name </span><span class="s4">= </span><span class="s2">mgf</span><span class="s4">;</span>
        <span class="s3">throw </span><span class="s2">error</span><span class="s4">;</span>
      <span class="s4">}</span>

      <span class="s2">mgf </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">mgf</span><span class="s4">[</span><span class="s2">mgf</span><span class="s4">].</span><span class="s2">create</span><span class="s4">(</span><span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">[</span><span class="s2">hash</span><span class="s4">].</span><span class="s2">create</span><span class="s4">());</span>

      <span class="s6">/* initialize hash function */</span>
      <span class="s2">hash </span><span class="s4">= </span><span class="s2">oids</span><span class="s4">[</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">signatureParameters</span><span class="s4">.</span><span class="s2">hash</span><span class="s4">.</span><span class="s2">algorithmOid</span><span class="s4">];</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">hash </span><span class="s4">=== </span><span class="s2">undefined </span><span class="s4">|| </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">[</span><span class="s2">hash</span><span class="s4">] === </span><span class="s2">undefined</span><span class="s4">) {</span>
        <span class="s3">var </span><span class="s2">error </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Unsupported RSASSA-PSS hash function.'</span><span class="s4">);</span>
        <span class="s2">error</span><span class="s4">.</span><span class="s2">oid </span><span class="s4">= </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">signatureParameters</span><span class="s4">.</span><span class="s2">hash</span><span class="s4">.</span><span class="s2">algorithmOid</span><span class="s4">;</span>
        <span class="s2">error</span><span class="s4">.</span><span class="s2">name </span><span class="s4">= </span><span class="s2">hash</span><span class="s4">;</span>
        <span class="s3">throw </span><span class="s2">error</span><span class="s4">;</span>
      <span class="s4">}</span>

      <span class="s2">scheme </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pss</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span>
        <span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">[</span><span class="s2">hash</span><span class="s4">].</span><span class="s2">create</span><span class="s4">(), </span><span class="s2">mgf</span><span class="s4">, </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">signatureParameters</span><span class="s4">.</span><span class="s2">saltLength</span>
      <span class="s4">);</span>
      <span class="s3">break</span><span class="s4">;</span>
  <span class="s4">}</span>

  <span class="s6">// verify signature on cert using public key</span>
  <span class="s3">return </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">publicKey</span><span class="s4">.</span><span class="s2">verify</span><span class="s4">(</span>
    <span class="s2">options</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">digest</span><span class="s4">().</span><span class="s2">getBytes</span><span class="s4">(), </span><span class="s2">options</span><span class="s4">.</span><span class="s2">signature</span><span class="s4">, </span><span class="s2">scheme</span>
  <span class="s4">);</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Converts an X.509 certificate from PEM format.</span>
 <span class="s0">*</span>
 <span class="s0">* Note: If the certificate is to be verified then compute hash should</span>
 <span class="s0">* be set to true. This will scan the TBSCertificate part of the ASN.1</span>
 <span class="s0">* object while it is converted so it doesn't need to be converted back</span>
 <span class="s0">* to ASN.1-DER-encoding later.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">pem the PEM-formatted certificate.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">computeHash true to compute the hash for verification.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">strict true to be strict when checking ASN.1 value lengths, false to</span>
 <span class="s0">*          allow truncated values (default: true).</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the certificate.</span>
 <span class="s0">*/</span>
<span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateFromPem </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">pem</span><span class="s4">, </span><span class="s2">computeHash</span><span class="s4">, </span><span class="s2">strict</span><span class="s4">) {</span>
  <span class="s3">var </span><span class="s2">msg </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pem</span><span class="s4">.</span><span class="s2">decode</span><span class="s4">(</span><span class="s2">pem</span><span class="s4">)[</span><span class="s7">0</span><span class="s4">];</span>

  <span class="s3">if</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">.</span><span class="s2">type </span><span class="s4">!== </span><span class="s5">'CERTIFICATE' </span><span class="s4">&amp;&amp;</span>
    <span class="s2">msg</span><span class="s4">.</span><span class="s2">type </span><span class="s4">!== </span><span class="s5">'X509 CERTIFICATE' </span><span class="s4">&amp;&amp;</span>
    <span class="s2">msg</span><span class="s4">.</span><span class="s2">type </span><span class="s4">!== </span><span class="s5">'TRUSTED CERTIFICATE'</span><span class="s4">) {</span>
    <span class="s3">var </span><span class="s2">error </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Error</span><span class="s4">(</span>
      <span class="s5">'Could not convert certificate from PEM; PEM header type ' </span><span class="s4">+</span>
      <span class="s5">'is not &quot;CERTIFICATE&quot;, &quot;X509 CERTIFICATE&quot;, or &quot;TRUSTED CERTIFICATE&quot;.'</span><span class="s4">);</span>
    <span class="s2">error</span><span class="s4">.</span><span class="s2">headerType </span><span class="s4">= </span><span class="s2">msg</span><span class="s4">.</span><span class="s2">type</span><span class="s4">;</span>
    <span class="s3">throw </span><span class="s2">error</span><span class="s4">;</span>
  <span class="s4">}</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">.</span><span class="s2">procType </span><span class="s4">&amp;&amp; </span><span class="s2">msg</span><span class="s4">.</span><span class="s2">procType</span><span class="s4">.</span><span class="s2">type </span><span class="s4">=== </span><span class="s5">'ENCRYPTED'</span><span class="s4">) {</span>
    <span class="s3">throw new </span><span class="s2">Error</span><span class="s4">(</span>
      <span class="s5">'Could not convert certificate from PEM; PEM is encrypted.'</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s6">// convert DER to ASN.1 object</span>
  <span class="s3">var </span><span class="s2">obj </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">fromDer</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">.</span><span class="s2">body</span><span class="s4">, </span><span class="s2">strict</span><span class="s4">);</span>

  <span class="s3">return </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateFromAsn1</span><span class="s4">(</span><span class="s2">obj</span><span class="s4">, </span><span class="s2">computeHash</span><span class="s4">);</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Converts an X.509 certificate to PEM format.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">cert the certificate.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">maxline the maximum characters per line, defaults to 64.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the PEM-formatted certificate.</span>
 <span class="s0">*/</span>
<span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateToPem </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">, </span><span class="s2">maxline</span><span class="s4">) {</span>
  <span class="s6">// convert to ASN.1, then DER, then PEM-encode</span>
  <span class="s3">var </span><span class="s2">msg </span><span class="s4">= {</span>
    <span class="s2">type</span><span class="s4">: </span><span class="s5">'CERTIFICATE'</span><span class="s4">,</span>
    <span class="s2">body</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">toDer</span><span class="s4">(</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateToAsn1</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">)).</span><span class="s2">getBytes</span><span class="s4">()</span>
  <span class="s4">};</span>
  <span class="s3">return </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pem</span><span class="s4">.</span><span class="s2">encode</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">, {</span><span class="s2">maxline</span><span class="s4">: </span><span class="s2">maxline</span><span class="s4">});</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Converts an RSA public key from PEM format.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">pem the PEM-formatted public key.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the public key.</span>
 <span class="s0">*/</span>
<span class="s2">pki</span><span class="s4">.</span><span class="s2">publicKeyFromPem </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">pem</span><span class="s4">) {</span>
  <span class="s3">var </span><span class="s2">msg </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pem</span><span class="s4">.</span><span class="s2">decode</span><span class="s4">(</span><span class="s2">pem</span><span class="s4">)[</span><span class="s7">0</span><span class="s4">];</span>

  <span class="s3">if</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">.</span><span class="s2">type </span><span class="s4">!== </span><span class="s5">'PUBLIC KEY' </span><span class="s4">&amp;&amp; </span><span class="s2">msg</span><span class="s4">.</span><span class="s2">type </span><span class="s4">!== </span><span class="s5">'RSA PUBLIC KEY'</span><span class="s4">) {</span>
    <span class="s3">var </span><span class="s2">error </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Could not convert public key from PEM; PEM header ' </span><span class="s4">+</span>
      <span class="s5">'type is not &quot;PUBLIC KEY&quot; or &quot;RSA PUBLIC KEY&quot;.'</span><span class="s4">);</span>
    <span class="s2">error</span><span class="s4">.</span><span class="s2">headerType </span><span class="s4">= </span><span class="s2">msg</span><span class="s4">.</span><span class="s2">type</span><span class="s4">;</span>
    <span class="s3">throw </span><span class="s2">error</span><span class="s4">;</span>
  <span class="s4">}</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">.</span><span class="s2">procType </span><span class="s4">&amp;&amp; </span><span class="s2">msg</span><span class="s4">.</span><span class="s2">procType</span><span class="s4">.</span><span class="s2">type </span><span class="s4">=== </span><span class="s5">'ENCRYPTED'</span><span class="s4">) {</span>
    <span class="s3">throw new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Could not convert public key from PEM; PEM is encrypted.'</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s6">// convert DER to ASN.1 object</span>
  <span class="s3">var </span><span class="s2">obj </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">fromDer</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">.</span><span class="s2">body</span><span class="s4">);</span>

  <span class="s3">return </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">publicKeyFromAsn1</span><span class="s4">(</span><span class="s2">obj</span><span class="s4">);</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Converts an RSA public key to PEM format (using a SubjectPublicKeyInfo).</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">key the public key.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">maxline the maximum characters per line, defaults to 64.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the PEM-formatted public key.</span>
 <span class="s0">*/</span>
<span class="s2">pki</span><span class="s4">.</span><span class="s2">publicKeyToPem </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">key</span><span class="s4">, </span><span class="s2">maxline</span><span class="s4">) {</span>
  <span class="s6">// convert to ASN.1, then DER, then PEM-encode</span>
  <span class="s3">var </span><span class="s2">msg </span><span class="s4">= {</span>
    <span class="s2">type</span><span class="s4">: </span><span class="s5">'PUBLIC KEY'</span><span class="s4">,</span>
    <span class="s2">body</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">toDer</span><span class="s4">(</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">publicKeyToAsn1</span><span class="s4">(</span><span class="s2">key</span><span class="s4">)).</span><span class="s2">getBytes</span><span class="s4">()</span>
  <span class="s4">};</span>
  <span class="s3">return </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pem</span><span class="s4">.</span><span class="s2">encode</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">, {</span><span class="s2">maxline</span><span class="s4">: </span><span class="s2">maxline</span><span class="s4">});</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Converts an RSA public key to PEM format (using an RSAPublicKey).</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">key the public key.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">maxline the maximum characters per line, defaults to 64.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the PEM-formatted public key.</span>
 <span class="s0">*/</span>
<span class="s2">pki</span><span class="s4">.</span><span class="s2">publicKeyToRSAPublicKeyPem </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">key</span><span class="s4">, </span><span class="s2">maxline</span><span class="s4">) {</span>
  <span class="s6">// convert to ASN.1, then DER, then PEM-encode</span>
  <span class="s3">var </span><span class="s2">msg </span><span class="s4">= {</span>
    <span class="s2">type</span><span class="s4">: </span><span class="s5">'RSA PUBLIC KEY'</span><span class="s4">,</span>
    <span class="s2">body</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">toDer</span><span class="s4">(</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">publicKeyToRSAPublicKey</span><span class="s4">(</span><span class="s2">key</span><span class="s4">)).</span><span class="s2">getBytes</span><span class="s4">()</span>
  <span class="s4">};</span>
  <span class="s3">return </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pem</span><span class="s4">.</span><span class="s2">encode</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">, {</span><span class="s2">maxline</span><span class="s4">: </span><span class="s2">maxline</span><span class="s4">});</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Gets a fingerprint for the given public key.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">options the options to use.</span>
 <span class="s0">*          [md] the message digest object to use (defaults to forge.md.sha1).</span>
 <span class="s0">*          [type] the type of fingerprint, such as 'RSAPublicKey',</span>
 <span class="s0">*            'SubjectPublicKeyInfo' (defaults to 'RSAPublicKey').</span>
 <span class="s0">*          [encoding] an alternative output encoding, such as 'hex'</span>
 <span class="s0">*            (defaults to none, outputs a byte buffer).</span>
 <span class="s0">*          [delimiter] the delimiter to use between bytes for 'hex' encoded</span>
 <span class="s0">*            output, eg: ':' (defaults to none).</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the fingerprint as a byte buffer or other encoding based on options.</span>
 <span class="s0">*/</span>
<span class="s2">pki</span><span class="s4">.</span><span class="s2">getPublicKeyFingerprint </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">key</span><span class="s4">, </span><span class="s2">options</span><span class="s4">) {</span>
  <span class="s2">options </span><span class="s4">= </span><span class="s2">options </span><span class="s4">|| {};</span>
  <span class="s3">var </span><span class="s2">md </span><span class="s4">= </span><span class="s2">options</span><span class="s4">.</span><span class="s2">md </span><span class="s4">|| </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">sha1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">();</span>
  <span class="s3">var </span><span class="s2">type </span><span class="s4">= </span><span class="s2">options</span><span class="s4">.</span><span class="s2">type </span><span class="s4">|| </span><span class="s5">'RSAPublicKey'</span><span class="s4">;</span>

  <span class="s3">var </span><span class="s2">bytes</span><span class="s4">;</span>
  <span class="s3">switch</span><span class="s4">(</span><span class="s2">type</span><span class="s4">) {</span>
    <span class="s3">case </span><span class="s5">'RSAPublicKey'</span><span class="s4">:</span>
      <span class="s2">bytes </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">toDer</span><span class="s4">(</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">publicKeyToRSAPublicKey</span><span class="s4">(</span><span class="s2">key</span><span class="s4">)).</span><span class="s2">getBytes</span><span class="s4">();</span>
      <span class="s3">break</span><span class="s4">;</span>
    <span class="s3">case </span><span class="s5">'SubjectPublicKeyInfo'</span><span class="s4">:</span>
      <span class="s2">bytes </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">toDer</span><span class="s4">(</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">publicKeyToAsn1</span><span class="s4">(</span><span class="s2">key</span><span class="s4">)).</span><span class="s2">getBytes</span><span class="s4">();</span>
      <span class="s3">break</span><span class="s4">;</span>
    <span class="s3">default</span><span class="s4">:</span>
      <span class="s3">throw new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Unknown fingerprint type &quot;' </span><span class="s4">+ </span><span class="s2">options</span><span class="s4">.</span><span class="s2">type </span><span class="s4">+ </span><span class="s5">'&quot;.'</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s6">// hash public key bytes</span>
  <span class="s2">md</span><span class="s4">.</span><span class="s2">start</span><span class="s4">();</span>
  <span class="s2">md</span><span class="s4">.</span><span class="s2">update</span><span class="s4">(</span><span class="s2">bytes</span><span class="s4">);</span>
  <span class="s3">var </span><span class="s2">digest </span><span class="s4">= </span><span class="s2">md</span><span class="s4">.</span><span class="s2">digest</span><span class="s4">();</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">options</span><span class="s4">.</span><span class="s2">encoding </span><span class="s4">=== </span><span class="s5">'hex'</span><span class="s4">) {</span>
    <span class="s3">var </span><span class="s2">hex </span><span class="s4">= </span><span class="s2">digest</span><span class="s4">.</span><span class="s2">toHex</span><span class="s4">();</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">options</span><span class="s4">.</span><span class="s2">delimiter</span><span class="s4">) {</span>
      <span class="s3">return </span><span class="s2">hex</span><span class="s4">.</span><span class="s2">match</span><span class="s4">(</span><span class="s8">/.{2}/g</span><span class="s4">).</span><span class="s2">join</span><span class="s4">(</span><span class="s2">options</span><span class="s4">.</span><span class="s2">delimiter</span><span class="s4">);</span>
    <span class="s4">}</span>
    <span class="s3">return </span><span class="s2">hex</span><span class="s4">;</span>
  <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">options</span><span class="s4">.</span><span class="s2">encoding </span><span class="s4">=== </span><span class="s5">'binary'</span><span class="s4">) {</span>
    <span class="s3">return </span><span class="s2">digest</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">();</span>
  <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">options</span><span class="s4">.</span><span class="s2">encoding</span><span class="s4">) {</span>
    <span class="s3">throw new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Unknown encoding &quot;' </span><span class="s4">+ </span><span class="s2">options</span><span class="s4">.</span><span class="s2">encoding </span><span class="s4">+ </span><span class="s5">'&quot;.'</span><span class="s4">);</span>
  <span class="s4">}</span>
  <span class="s3">return </span><span class="s2">digest</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Converts a PKCS#10 certification request (CSR) from PEM format.</span>
 <span class="s0">*</span>
 <span class="s0">* Note: If the certification request is to be verified then compute hash</span>
 <span class="s0">* should be set to true. This will scan the CertificationRequestInfo part of</span>
 <span class="s0">* the ASN.1 object while it is converted so it doesn't need to be converted</span>
 <span class="s0">* back to ASN.1-DER-encoding later.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">pem the PEM-formatted certificate.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">computeHash true to compute the hash for verification.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">strict true to be strict when checking ASN.1 value lengths, false to</span>
 <span class="s0">*          allow truncated values (default: true).</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the certification request (CSR).</span>
 <span class="s0">*/</span>
<span class="s2">pki</span><span class="s4">.</span><span class="s2">certificationRequestFromPem </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">pem</span><span class="s4">, </span><span class="s2">computeHash</span><span class="s4">, </span><span class="s2">strict</span><span class="s4">) {</span>
  <span class="s3">var </span><span class="s2">msg </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pem</span><span class="s4">.</span><span class="s2">decode</span><span class="s4">(</span><span class="s2">pem</span><span class="s4">)[</span><span class="s7">0</span><span class="s4">];</span>

  <span class="s3">if</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">.</span><span class="s2">type </span><span class="s4">!== </span><span class="s5">'CERTIFICATE REQUEST'</span><span class="s4">) {</span>
    <span class="s3">var </span><span class="s2">error </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Could not convert certification request from PEM; ' </span><span class="s4">+</span>
      <span class="s5">'PEM header type is not &quot;CERTIFICATE REQUEST&quot;.'</span><span class="s4">);</span>
    <span class="s2">error</span><span class="s4">.</span><span class="s2">headerType </span><span class="s4">= </span><span class="s2">msg</span><span class="s4">.</span><span class="s2">type</span><span class="s4">;</span>
    <span class="s3">throw </span><span class="s2">error</span><span class="s4">;</span>
  <span class="s4">}</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">.</span><span class="s2">procType </span><span class="s4">&amp;&amp; </span><span class="s2">msg</span><span class="s4">.</span><span class="s2">procType</span><span class="s4">.</span><span class="s2">type </span><span class="s4">=== </span><span class="s5">'ENCRYPTED'</span><span class="s4">) {</span>
    <span class="s3">throw new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Could not convert certification request from PEM; ' </span><span class="s4">+</span>
      <span class="s5">'PEM is encrypted.'</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s6">// convert DER to ASN.1 object</span>
  <span class="s3">var </span><span class="s2">obj </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">fromDer</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">.</span><span class="s2">body</span><span class="s4">, </span><span class="s2">strict</span><span class="s4">);</span>

  <span class="s3">return </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificationRequestFromAsn1</span><span class="s4">(</span><span class="s2">obj</span><span class="s4">, </span><span class="s2">computeHash</span><span class="s4">);</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Converts a PKCS#10 certification request (CSR) to PEM format.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">csr the certification request.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">maxline the maximum characters per line, defaults to 64.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the PEM-formatted certification request.</span>
 <span class="s0">*/</span>
<span class="s2">pki</span><span class="s4">.</span><span class="s2">certificationRequestToPem </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">csr</span><span class="s4">, </span><span class="s2">maxline</span><span class="s4">) {</span>
  <span class="s6">// convert to ASN.1, then DER, then PEM-encode</span>
  <span class="s3">var </span><span class="s2">msg </span><span class="s4">= {</span>
    <span class="s2">type</span><span class="s4">: </span><span class="s5">'CERTIFICATE REQUEST'</span><span class="s4">,</span>
    <span class="s2">body</span><span class="s4">: </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">toDer</span><span class="s4">(</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificationRequestToAsn1</span><span class="s4">(</span><span class="s2">csr</span><span class="s4">)).</span><span class="s2">getBytes</span><span class="s4">()</span>
  <span class="s4">};</span>
  <span class="s3">return </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pem</span><span class="s4">.</span><span class="s2">encode</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">, {</span><span class="s2">maxline</span><span class="s4">: </span><span class="s2">maxline</span><span class="s4">});</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Creates an empty X.509v3 RSA certificate.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the certificate.</span>
 <span class="s0">*/</span>
<span class="s2">pki</span><span class="s4">.</span><span class="s2">createCertificate </span><span class="s4">= </span><span class="s3">function</span><span class="s4">() {</span>
  <span class="s3">var </span><span class="s2">cert </span><span class="s4">= {};</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">version </span><span class="s4">= </span><span class="s7">0x02</span><span class="s4">;</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">serialNumber </span><span class="s4">= </span><span class="s5">'00'</span><span class="s4">;</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">signatureOid </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">signature </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">siginfo </span><span class="s4">= {};</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">siginfo</span><span class="s4">.</span><span class="s2">algorithmOid </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">validity </span><span class="s4">= {};</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">validity</span><span class="s4">.</span><span class="s2">notBefore </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Date</span><span class="s4">();</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">validity</span><span class="s4">.</span><span class="s2">notAfter </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Date</span><span class="s4">();</span>

  <span class="s2">cert</span><span class="s4">.</span><span class="s2">issuer </span><span class="s4">= {};</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">issuer</span><span class="s4">.</span><span class="s2">getField </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">sn</span><span class="s4">) {</span>
    <span class="s3">return </span><span class="s2">_getAttribute</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">issuer</span><span class="s4">, </span><span class="s2">sn</span><span class="s4">);</span>
  <span class="s4">};</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">issuer</span><span class="s4">.</span><span class="s2">addField </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">) {</span>
    <span class="s2">_fillMissingFields</span><span class="s4">([</span><span class="s2">attr</span><span class="s4">]);</span>
    <span class="s2">cert</span><span class="s4">.</span><span class="s2">issuer</span><span class="s4">.</span><span class="s2">attributes</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">);</span>
  <span class="s4">};</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">issuer</span><span class="s4">.</span><span class="s2">attributes </span><span class="s4">= [];</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">issuer</span><span class="s4">.</span><span class="s2">hash </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>

  <span class="s2">cert</span><span class="s4">.</span><span class="s2">subject </span><span class="s4">= {};</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">getField </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">sn</span><span class="s4">) {</span>
    <span class="s3">return </span><span class="s2">_getAttribute</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">, </span><span class="s2">sn</span><span class="s4">);</span>
  <span class="s4">};</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">addField </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">) {</span>
    <span class="s2">_fillMissingFields</span><span class="s4">([</span><span class="s2">attr</span><span class="s4">]);</span>
    <span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">attributes</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">);</span>
  <span class="s4">};</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">attributes </span><span class="s4">= [];</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">hash </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>

  <span class="s2">cert</span><span class="s4">.</span><span class="s2">extensions </span><span class="s4">= [];</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">publicKey </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">md </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>

  <span class="s0">/**</span>
   <span class="s0">* Sets the subject of this certificate.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">attrs the array of subject attributes to use.</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">uniqueId an optional a unique ID to use.</span>
   <span class="s0">*/</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">setSubject </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">attrs</span><span class="s4">, </span><span class="s2">uniqueId</span><span class="s4">) {</span>
    <span class="s6">// set new attributes, clear hash</span>
    <span class="s2">_fillMissingFields</span><span class="s4">(</span><span class="s2">attrs</span><span class="s4">);</span>
    <span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">attributes </span><span class="s4">= </span><span class="s2">attrs</span><span class="s4">;</span>
    <span class="s3">delete </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">uniqueId</span><span class="s4">;</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">uniqueId</span><span class="s4">) {</span>
      <span class="s6">// TODO: support arbitrary bit length ids</span>
      <span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">uniqueId </span><span class="s4">= </span><span class="s2">uniqueId</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">hash </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Sets the issuer of this certificate.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">attrs the array of issuer attributes to use.</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">uniqueId an optional a unique ID to use.</span>
   <span class="s0">*/</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">setIssuer </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">attrs</span><span class="s4">, </span><span class="s2">uniqueId</span><span class="s4">) {</span>
    <span class="s6">// set new attributes, clear hash</span>
    <span class="s2">_fillMissingFields</span><span class="s4">(</span><span class="s2">attrs</span><span class="s4">);</span>
    <span class="s2">cert</span><span class="s4">.</span><span class="s2">issuer</span><span class="s4">.</span><span class="s2">attributes </span><span class="s4">= </span><span class="s2">attrs</span><span class="s4">;</span>
    <span class="s3">delete </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">issuer</span><span class="s4">.</span><span class="s2">uniqueId</span><span class="s4">;</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">uniqueId</span><span class="s4">) {</span>
      <span class="s6">// TODO: support arbitrary bit length ids</span>
      <span class="s2">cert</span><span class="s4">.</span><span class="s2">issuer</span><span class="s4">.</span><span class="s2">uniqueId </span><span class="s4">= </span><span class="s2">uniqueId</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s2">cert</span><span class="s4">.</span><span class="s2">issuer</span><span class="s4">.</span><span class="s2">hash </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Sets the extensions of this certificate.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">exts the array of extensions to use.</span>
   <span class="s0">*/</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">setExtensions </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">exts</span><span class="s4">) {</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">exts</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s2">_fillMissingExtensionFields</span><span class="s4">(</span><span class="s2">exts</span><span class="s4">[</span><span class="s2">i</span><span class="s4">], {</span><span class="s2">cert</span><span class="s4">: </span><span class="s2">cert</span><span class="s4">});</span>
    <span class="s4">}</span>
    <span class="s6">// set new extensions</span>
    <span class="s2">cert</span><span class="s4">.</span><span class="s2">extensions </span><span class="s4">= </span><span class="s2">exts</span><span class="s4">;</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Gets an extension by its name or id.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">options the name to use or an object with:</span>
   <span class="s0">*          name the name to use.</span>
   <span class="s0">*          id the id to use.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@return </span><span class="s0">the extension or null if not found.</span>
   <span class="s0">*/</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">getExtension </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">options</span><span class="s4">) {</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s3">typeof </span><span class="s2">options </span><span class="s4">=== </span><span class="s5">'string'</span><span class="s4">) {</span>
      <span class="s2">options </span><span class="s4">= {</span><span class="s2">name</span><span class="s4">: </span><span class="s2">options</span><span class="s4">};</span>
    <span class="s4">}</span>

    <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
    <span class="s3">var </span><span class="s2">ext</span><span class="s4">;</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">rval </span><span class="s4">=== </span><span class="s3">null </span><span class="s4">&amp;&amp; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">extensions</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s2">ext </span><span class="s4">= </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">extensions</span><span class="s4">[</span><span class="s2">i</span><span class="s4">];</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">options</span><span class="s4">.</span><span class="s2">id </span><span class="s4">&amp;&amp; </span><span class="s2">ext</span><span class="s4">.</span><span class="s2">id </span><span class="s4">=== </span><span class="s2">options</span><span class="s4">.</span><span class="s2">id</span><span class="s4">) {</span>
        <span class="s2">rval </span><span class="s4">= </span><span class="s2">ext</span><span class="s4">;</span>
      <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">options</span><span class="s4">.</span><span class="s2">name </span><span class="s4">&amp;&amp; </span><span class="s2">ext</span><span class="s4">.</span><span class="s2">name </span><span class="s4">=== </span><span class="s2">options</span><span class="s4">.</span><span class="s2">name</span><span class="s4">) {</span>
        <span class="s2">rval </span><span class="s4">= </span><span class="s2">ext</span><span class="s4">;</span>
      <span class="s4">}</span>
    <span class="s4">}</span>
    <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Signs this certificate using the given private key.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">key the private key to sign with.</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">md the message digest object to use (defaults to forge.md.sha1).</span>
   <span class="s0">*/</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">sign </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">key</span><span class="s4">, </span><span class="s2">md</span><span class="s4">) {</span>
    <span class="s6">// TODO: get signature OID from private key</span>
    <span class="s2">cert</span><span class="s4">.</span><span class="s2">md </span><span class="s4">= </span><span class="s2">md </span><span class="s4">|| </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">sha1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">();</span>
    <span class="s3">var </span><span class="s2">algorithmOid </span><span class="s4">= </span><span class="s2">oids</span><span class="s4">[</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">algorithm </span><span class="s4">+ </span><span class="s5">'WithRSAEncryption'</span><span class="s4">];</span>
    <span class="s3">if</span><span class="s4">(!</span><span class="s2">algorithmOid</span><span class="s4">) {</span>
      <span class="s3">var </span><span class="s2">error </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Could not compute certificate digest. ' </span><span class="s4">+</span>
        <span class="s5">'Unknown message digest algorithm OID.'</span><span class="s4">);</span>
      <span class="s2">error</span><span class="s4">.</span><span class="s2">algorithm </span><span class="s4">= </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">algorithm</span><span class="s4">;</span>
      <span class="s3">throw </span><span class="s2">error</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s2">cert</span><span class="s4">.</span><span class="s2">signatureOid </span><span class="s4">= </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">siginfo</span><span class="s4">.</span><span class="s2">algorithmOid </span><span class="s4">= </span><span class="s2">algorithmOid</span><span class="s4">;</span>

    <span class="s6">// get TBSCertificate, convert to DER</span>
    <span class="s2">cert</span><span class="s4">.</span><span class="s2">tbsCertificate </span><span class="s4">= </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">getTBSCertificate</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">);</span>
    <span class="s3">var </span><span class="s2">bytes </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">toDer</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">tbsCertificate</span><span class="s4">);</span>

    <span class="s6">// digest and sign</span>
    <span class="s2">cert</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">update</span><span class="s4">(</span><span class="s2">bytes</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">());</span>
    <span class="s2">cert</span><span class="s4">.</span><span class="s2">signature </span><span class="s4">= </span><span class="s2">key</span><span class="s4">.</span><span class="s2">sign</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">md</span><span class="s4">);</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Attempts verify the signature on the passed certificate using this</span>
   <span class="s0">* certificate's public key.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">child the certificate to verify.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@return </span><span class="s0">true if verified, false if not.</span>
   <span class="s0">*/</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">verify </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">child</span><span class="s4">) {</span>
    <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>

    <span class="s3">if</span><span class="s4">(!</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">issued</span><span class="s4">(</span><span class="s2">child</span><span class="s4">)) {</span>
      <span class="s3">var </span><span class="s2">issuer </span><span class="s4">= </span><span class="s2">child</span><span class="s4">.</span><span class="s2">issuer</span><span class="s4">;</span>
      <span class="s3">var </span><span class="s2">subject </span><span class="s4">= </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">;</span>
      <span class="s3">var </span><span class="s2">error </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Error</span><span class="s4">(</span>
        <span class="s5">'The parent certificate did not issue the given child ' </span><span class="s4">+</span>
        <span class="s5">'certificate; the child certificate</span><span class="s3">\'</span><span class="s5">s issuer does not match the ' </span><span class="s4">+</span>
        <span class="s5">'parent</span><span class="s3">\'</span><span class="s5">s subject.'</span><span class="s4">);</span>
      <span class="s2">error</span><span class="s4">.</span><span class="s2">expectedIssuer </span><span class="s4">= </span><span class="s2">subject</span><span class="s4">.</span><span class="s2">attributes</span><span class="s4">;</span>
      <span class="s2">error</span><span class="s4">.</span><span class="s2">actualIssuer </span><span class="s4">= </span><span class="s2">issuer</span><span class="s4">.</span><span class="s2">attributes</span><span class="s4">;</span>
      <span class="s3">throw </span><span class="s2">error</span><span class="s4">;</span>
    <span class="s4">}</span>

    <span class="s3">var </span><span class="s2">md </span><span class="s4">= </span><span class="s2">child</span><span class="s4">.</span><span class="s2">md</span><span class="s4">;</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">md </span><span class="s4">=== </span><span class="s3">null</span><span class="s4">) {</span>
      <span class="s6">// create digest for OID signature types</span>
      <span class="s2">md </span><span class="s4">= </span><span class="s2">_createSignatureDigest</span><span class="s4">({</span>
        <span class="s2">signatureOid</span><span class="s4">: </span><span class="s2">child</span><span class="s4">.</span><span class="s2">signatureOid</span><span class="s4">,</span>
        <span class="s2">type</span><span class="s4">: </span><span class="s5">'certificate'</span>
      <span class="s4">});</span>

      <span class="s6">// produce DER formatted TBSCertificate and digest it</span>
      <span class="s3">var </span><span class="s2">tbsCertificate </span><span class="s4">= </span><span class="s2">child</span><span class="s4">.</span><span class="s2">tbsCertificate </span><span class="s4">|| </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">getTBSCertificate</span><span class="s4">(</span><span class="s2">child</span><span class="s4">);</span>
      <span class="s3">var </span><span class="s2">bytes </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">toDer</span><span class="s4">(</span><span class="s2">tbsCertificate</span><span class="s4">);</span>
      <span class="s2">md</span><span class="s4">.</span><span class="s2">update</span><span class="s4">(</span><span class="s2">bytes</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">());</span>
    <span class="s4">}</span>

    <span class="s3">if</span><span class="s4">(</span><span class="s2">md </span><span class="s4">!== </span><span class="s3">null</span><span class="s4">) {</span>
      <span class="s2">rval </span><span class="s4">= </span><span class="s2">_verifySignature</span><span class="s4">({</span>
        <span class="s2">certificate</span><span class="s4">: </span><span class="s2">cert</span><span class="s4">, </span><span class="s2">md</span><span class="s4">: </span><span class="s2">md</span><span class="s4">, </span><span class="s2">signature</span><span class="s4">: </span><span class="s2">child</span><span class="s4">.</span><span class="s2">signature</span>
      <span class="s4">});</span>
    <span class="s4">}</span>

    <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Returns true if this certificate's issuer matches the passed</span>
   <span class="s0">* certificate's subject. Note that no signature check is performed.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">parent the certificate to check.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@return </span><span class="s0">true if this certificate's issuer matches the passed certificate's</span>
   <span class="s0">*         subject.</span>
   <span class="s0">*/</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">isIssuer </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">parent</span><span class="s4">) {</span>
    <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>

    <span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">issuer</span><span class="s4">;</span>
    <span class="s3">var </span><span class="s2">s </span><span class="s4">= </span><span class="s2">parent</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">;</span>

    <span class="s6">// compare hashes if present</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">i</span><span class="s4">.</span><span class="s2">hash </span><span class="s4">&amp;&amp; </span><span class="s2">s</span><span class="s4">.</span><span class="s2">hash</span><span class="s4">) {</span>
      <span class="s2">rval </span><span class="s4">= (</span><span class="s2">i</span><span class="s4">.</span><span class="s2">hash </span><span class="s4">=== </span><span class="s2">s</span><span class="s4">.</span><span class="s2">hash</span><span class="s4">);</span>
    <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">i</span><span class="s4">.</span><span class="s2">attributes</span><span class="s4">.</span><span class="s2">length </span><span class="s4">=== </span><span class="s2">s</span><span class="s4">.</span><span class="s2">attributes</span><span class="s4">.</span><span class="s2">length</span><span class="s4">) {</span>
      <span class="s6">// all attributes are the same so issuer matches subject</span>
      <span class="s2">rval </span><span class="s4">= </span><span class="s3">true</span><span class="s4">;</span>
      <span class="s3">var </span><span class="s2">iattr</span><span class="s4">, </span><span class="s2">sattr</span><span class="s4">;</span>
      <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">n </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">rval </span><span class="s4">&amp;&amp; </span><span class="s2">n </span><span class="s4">&lt; </span><span class="s2">i</span><span class="s4">.</span><span class="s2">attributes</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">n</span><span class="s4">) {</span>
        <span class="s2">iattr </span><span class="s4">= </span><span class="s2">i</span><span class="s4">.</span><span class="s2">attributes</span><span class="s4">[</span><span class="s2">n</span><span class="s4">];</span>
        <span class="s2">sattr </span><span class="s4">= </span><span class="s2">s</span><span class="s4">.</span><span class="s2">attributes</span><span class="s4">[</span><span class="s2">n</span><span class="s4">];</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s2">iattr</span><span class="s4">.</span><span class="s2">type </span><span class="s4">!== </span><span class="s2">sattr</span><span class="s4">.</span><span class="s2">type </span><span class="s4">|| </span><span class="s2">iattr</span><span class="s4">.</span><span class="s2">value </span><span class="s4">!== </span><span class="s2">sattr</span><span class="s4">.</span><span class="s2">value</span><span class="s4">) {</span>
          <span class="s6">// attribute mismatch</span>
          <span class="s2">rval </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>
        <span class="s4">}</span>
      <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Returns true if this certificate's subject matches the issuer of the</span>
   <span class="s0">* given certificate). Note that not signature check is performed.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">child the certificate to check.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@return </span><span class="s0">true if this certificate's subject matches the passed</span>
   <span class="s0">*         certificate's issuer.</span>
   <span class="s0">*/</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">issued </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">child</span><span class="s4">) {</span>
    <span class="s3">return </span><span class="s2">child</span><span class="s4">.</span><span class="s2">isIssuer</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">);</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Generates the subjectKeyIdentifier for this certificate as byte buffer.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@return </span><span class="s0">the subjectKeyIdentifier for this certificate as byte buffer.</span>
   <span class="s0">*/</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">generateSubjectKeyIdentifier </span><span class="s4">= </span><span class="s3">function</span><span class="s4">() {</span>
    <span class="s6">/* See: 4.2.1.2 section of the the RFC3280, keyIdentifier is either: 
 
      (1) The keyIdentifier is composed of the 160-bit SHA-1 hash of the 
        value of the BIT STRING subjectPublicKey (excluding the tag, 
        length, and number of unused bits). 
 
      (2) The keyIdentifier is composed of a four bit type field with 
        the value 0100 followed by the least significant 60 bits of the 
        SHA-1 hash of the value of the BIT STRING subjectPublicKey 
        (excluding the tag, length, and number of unused bit string bits). 
    */</span>

    <span class="s6">// skipping the tag, length, and number of unused bits is the same</span>
    <span class="s6">// as just using the RSAPublicKey (for RSA keys, which are the</span>
    <span class="s6">// only ones supported)</span>
    <span class="s3">return </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">getPublicKeyFingerprint</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">publicKey</span><span class="s4">, {</span><span class="s2">type</span><span class="s4">: </span><span class="s5">'RSAPublicKey'</span><span class="s4">});</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Verifies the subjectKeyIdentifier extension value for this certificate</span>
   <span class="s0">* against its public key. If no extension is found, false will be</span>
   <span class="s0">* returned.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@return </span><span class="s0">true if verified, false if not.</span>
   <span class="s0">*/</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">verifySubjectKeyIdentifier </span><span class="s4">= </span><span class="s3">function</span><span class="s4">() {</span>
    <span class="s3">var </span><span class="s2">oid </span><span class="s4">= </span><span class="s2">oids</span><span class="s4">[</span><span class="s5">'subjectKeyIdentifier'</span><span class="s4">];</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">extensions</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s3">var </span><span class="s2">ext </span><span class="s4">= </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">extensions</span><span class="s4">[</span><span class="s2">i</span><span class="s4">];</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">ext</span><span class="s4">.</span><span class="s2">id </span><span class="s4">=== </span><span class="s2">oid</span><span class="s4">) {</span>
        <span class="s3">var </span><span class="s2">ski </span><span class="s4">= </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">generateSubjectKeyIdentifier</span><span class="s4">().</span><span class="s2">getBytes</span><span class="s4">();</span>
        <span class="s3">return </span><span class="s4">(</span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">hexToBytes</span><span class="s4">(</span><span class="s2">ext</span><span class="s4">.</span><span class="s2">subjectKeyIdentifier</span><span class="s4">) === </span><span class="s2">ski</span><span class="s4">);</span>
      <span class="s4">}</span>
    <span class="s4">}</span>
    <span class="s3">return false</span><span class="s4">;</span>
  <span class="s4">};</span>

  <span class="s3">return </span><span class="s2">cert</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Converts an X.509v3 RSA certificate from an ASN.1 object.</span>
 <span class="s0">*</span>
 <span class="s0">* Note: If the certificate is to be verified then compute hash should</span>
 <span class="s0">* be set to true. There is currently no implementation for converting</span>
 <span class="s0">* a certificate back to ASN.1 so the TBSCertificate part of the ASN.1</span>
 <span class="s0">* object needs to be scanned before the cert object is created.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">obj the asn1 representation of an X.509v3 RSA certificate.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">computeHash true to compute the hash for verification.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the certificate.</span>
 <span class="s0">*/</span>
<span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateFromAsn1 </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">obj</span><span class="s4">, </span><span class="s2">computeHash</span><span class="s4">) {</span>
  <span class="s6">// validate certificate and capture data</span>
  <span class="s3">var </span><span class="s2">capture </span><span class="s4">= {};</span>
  <span class="s3">var </span><span class="s2">errors </span><span class="s4">= [];</span>
  <span class="s3">if</span><span class="s4">(!</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">validate</span><span class="s4">(</span><span class="s2">obj</span><span class="s4">, </span><span class="s2">x509CertificateValidator</span><span class="s4">, </span><span class="s2">capture</span><span class="s4">, </span><span class="s2">errors</span><span class="s4">)) {</span>
    <span class="s3">var </span><span class="s2">error </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Cannot read X.509 certificate. ' </span><span class="s4">+</span>
      <span class="s5">'ASN.1 object is not an X509v3 Certificate.'</span><span class="s4">);</span>
    <span class="s2">error</span><span class="s4">.</span><span class="s2">errors </span><span class="s4">= </span><span class="s2">errors</span><span class="s4">;</span>
    <span class="s3">throw </span><span class="s2">error</span><span class="s4">;</span>
  <span class="s4">}</span>

  <span class="s6">// get oid</span>
  <span class="s3">var </span><span class="s2">oid </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">derToOid</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">publicKeyOid</span><span class="s4">);</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">oid </span><span class="s4">!== </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">oids</span><span class="s4">.</span><span class="s2">rsaEncryption</span><span class="s4">) {</span>
    <span class="s3">throw new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Cannot read public key. OID is not RSA.'</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s6">// create certificate</span>
  <span class="s3">var </span><span class="s2">cert </span><span class="s4">= </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">createCertificate</span><span class="s4">();</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">version </span><span class="s4">= </span><span class="s2">capture</span><span class="s4">.</span><span class="s2">certVersion </span><span class="s4">?</span>
    <span class="s2">capture</span><span class="s4">.</span><span class="s2">certVersion</span><span class="s4">.</span><span class="s2">charCodeAt</span><span class="s4">(</span><span class="s7">0</span><span class="s4">) : </span><span class="s7">0</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">serial </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">certSerialNumber</span><span class="s4">);</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">serialNumber </span><span class="s4">= </span><span class="s2">serial</span><span class="s4">.</span><span class="s2">toHex</span><span class="s4">();</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">signatureOid </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">derToOid</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">certSignatureOid</span><span class="s4">);</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">signatureParameters </span><span class="s4">= </span><span class="s2">_readSignatureParameters</span><span class="s4">(</span>
    <span class="s2">cert</span><span class="s4">.</span><span class="s2">signatureOid</span><span class="s4">, </span><span class="s2">capture</span><span class="s4">.</span><span class="s2">certSignatureParams</span><span class="s4">, </span><span class="s3">true</span><span class="s4">);</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">siginfo</span><span class="s4">.</span><span class="s2">algorithmOid </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">derToOid</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">certinfoSignatureOid</span><span class="s4">);</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">siginfo</span><span class="s4">.</span><span class="s2">parameters </span><span class="s4">= </span><span class="s2">_readSignatureParameters</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">siginfo</span><span class="s4">.</span><span class="s2">algorithmOid</span><span class="s4">,</span>
    <span class="s2">capture</span><span class="s4">.</span><span class="s2">certinfoSignatureParams</span><span class="s4">, </span><span class="s3">false</span><span class="s4">);</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">signature </span><span class="s4">= </span><span class="s2">capture</span><span class="s4">.</span><span class="s2">certSignature</span><span class="s4">;</span>

  <span class="s3">var </span><span class="s2">validity </span><span class="s4">= [];</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">certValidity1UTCTime </span><span class="s4">!== </span><span class="s2">undefined</span><span class="s4">) {</span>
    <span class="s2">validity</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">utcTimeToDate</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">certValidity1UTCTime</span><span class="s4">));</span>
  <span class="s4">}</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">certValidity2GeneralizedTime </span><span class="s4">!== </span><span class="s2">undefined</span><span class="s4">) {</span>
    <span class="s2">validity</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">generalizedTimeToDate</span><span class="s4">(</span>
      <span class="s2">capture</span><span class="s4">.</span><span class="s2">certValidity2GeneralizedTime</span><span class="s4">));</span>
  <span class="s4">}</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">certValidity3UTCTime </span><span class="s4">!== </span><span class="s2">undefined</span><span class="s4">) {</span>
    <span class="s2">validity</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">utcTimeToDate</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">certValidity3UTCTime</span><span class="s4">));</span>
  <span class="s4">}</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">certValidity4GeneralizedTime </span><span class="s4">!== </span><span class="s2">undefined</span><span class="s4">) {</span>
    <span class="s2">validity</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">generalizedTimeToDate</span><span class="s4">(</span>
      <span class="s2">capture</span><span class="s4">.</span><span class="s2">certValidity4GeneralizedTime</span><span class="s4">));</span>
  <span class="s4">}</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">validity</span><span class="s4">.</span><span class="s2">length </span><span class="s4">&gt; </span><span class="s7">2</span><span class="s4">) {</span>
    <span class="s3">throw new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Cannot read notBefore/notAfter validity times; more ' </span><span class="s4">+</span>
      <span class="s5">'than two times were provided in the certificate.'</span><span class="s4">);</span>
  <span class="s4">}</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">validity</span><span class="s4">.</span><span class="s2">length </span><span class="s4">&lt; </span><span class="s7">2</span><span class="s4">) {</span>
    <span class="s3">throw new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Cannot read notBefore/notAfter validity times; they ' </span><span class="s4">+</span>
      <span class="s5">'were not provided as either UTCTime or GeneralizedTime.'</span><span class="s4">);</span>
  <span class="s4">}</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">validity</span><span class="s4">.</span><span class="s2">notBefore </span><span class="s4">= </span><span class="s2">validity</span><span class="s4">[</span><span class="s7">0</span><span class="s4">];</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">validity</span><span class="s4">.</span><span class="s2">notAfter </span><span class="s4">= </span><span class="s2">validity</span><span class="s4">[</span><span class="s7">1</span><span class="s4">];</span>

  <span class="s6">// keep TBSCertificate to preserve signature when exporting</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">tbsCertificate </span><span class="s4">= </span><span class="s2">capture</span><span class="s4">.</span><span class="s2">tbsCertificate</span><span class="s4">;</span>

  <span class="s3">if</span><span class="s4">(</span><span class="s2">computeHash</span><span class="s4">) {</span>
    <span class="s6">// create digest for OID signature type</span>
    <span class="s2">cert</span><span class="s4">.</span><span class="s2">md </span><span class="s4">= </span><span class="s2">_createSignatureDigest</span><span class="s4">({</span>
      <span class="s2">signatureOid</span><span class="s4">: </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">signatureOid</span><span class="s4">,</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s5">'certificate'</span>
    <span class="s4">});</span>

    <span class="s6">// produce DER formatted TBSCertificate and digest it</span>
    <span class="s3">var </span><span class="s2">bytes </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">toDer</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">tbsCertificate</span><span class="s4">);</span>
    <span class="s2">cert</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">update</span><span class="s4">(</span><span class="s2">bytes</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">());</span>
  <span class="s4">}</span>

  <span class="s6">// handle issuer, build issuer message digest</span>
  <span class="s3">var </span><span class="s2">imd </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">sha1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">();</span>
  <span class="s3">var </span><span class="s2">ibytes </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">toDer</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">certIssuer</span><span class="s4">);</span>
  <span class="s2">imd</span><span class="s4">.</span><span class="s2">update</span><span class="s4">(</span><span class="s2">ibytes</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">());</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">issuer</span><span class="s4">.</span><span class="s2">getField </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">sn</span><span class="s4">) {</span>
    <span class="s3">return </span><span class="s2">_getAttribute</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">issuer</span><span class="s4">, </span><span class="s2">sn</span><span class="s4">);</span>
  <span class="s4">};</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">issuer</span><span class="s4">.</span><span class="s2">addField </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">) {</span>
    <span class="s2">_fillMissingFields</span><span class="s4">([</span><span class="s2">attr</span><span class="s4">]);</span>
    <span class="s2">cert</span><span class="s4">.</span><span class="s2">issuer</span><span class="s4">.</span><span class="s2">attributes</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">);</span>
  <span class="s4">};</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">issuer</span><span class="s4">.</span><span class="s2">attributes </span><span class="s4">= </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">RDNAttributesAsArray</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">certIssuer</span><span class="s4">);</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">certIssuerUniqueId</span><span class="s4">) {</span>
    <span class="s2">cert</span><span class="s4">.</span><span class="s2">issuer</span><span class="s4">.</span><span class="s2">uniqueId </span><span class="s4">= </span><span class="s2">capture</span><span class="s4">.</span><span class="s2">certIssuerUniqueId</span><span class="s4">;</span>
  <span class="s4">}</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">issuer</span><span class="s4">.</span><span class="s2">hash </span><span class="s4">= </span><span class="s2">imd</span><span class="s4">.</span><span class="s2">digest</span><span class="s4">().</span><span class="s2">toHex</span><span class="s4">();</span>

  <span class="s6">// handle subject, build subject message digest</span>
  <span class="s3">var </span><span class="s2">smd </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">sha1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">();</span>
  <span class="s3">var </span><span class="s2">sbytes </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">toDer</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">certSubject</span><span class="s4">);</span>
  <span class="s2">smd</span><span class="s4">.</span><span class="s2">update</span><span class="s4">(</span><span class="s2">sbytes</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">());</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">getField </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">sn</span><span class="s4">) {</span>
    <span class="s3">return </span><span class="s2">_getAttribute</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">, </span><span class="s2">sn</span><span class="s4">);</span>
  <span class="s4">};</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">addField </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">) {</span>
    <span class="s2">_fillMissingFields</span><span class="s4">([</span><span class="s2">attr</span><span class="s4">]);</span>
    <span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">attributes</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">);</span>
  <span class="s4">};</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">attributes </span><span class="s4">= </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">RDNAttributesAsArray</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">certSubject</span><span class="s4">);</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">certSubjectUniqueId</span><span class="s4">) {</span>
    <span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">uniqueId </span><span class="s4">= </span><span class="s2">capture</span><span class="s4">.</span><span class="s2">certSubjectUniqueId</span><span class="s4">;</span>
  <span class="s4">}</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">hash </span><span class="s4">= </span><span class="s2">smd</span><span class="s4">.</span><span class="s2">digest</span><span class="s4">().</span><span class="s2">toHex</span><span class="s4">();</span>

  <span class="s6">// handle extensions</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">certExtensions</span><span class="s4">) {</span>
    <span class="s2">cert</span><span class="s4">.</span><span class="s2">extensions </span><span class="s4">= </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateExtensionsFromAsn1</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">certExtensions</span><span class="s4">);</span>
  <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
    <span class="s2">cert</span><span class="s4">.</span><span class="s2">extensions </span><span class="s4">= [];</span>
  <span class="s4">}</span>

  <span class="s6">// convert RSA public key from ASN.1</span>
  <span class="s2">cert</span><span class="s4">.</span><span class="s2">publicKey </span><span class="s4">= </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">publicKeyFromAsn1</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">subjectPublicKeyInfo</span><span class="s4">);</span>

  <span class="s3">return </span><span class="s2">cert</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Converts an ASN.1 extensions object (with extension sequences as its</span>
 <span class="s0">* values) into an array of extension objects with types and values.</span>
 <span class="s0">*</span>
 <span class="s0">* Supported extensions:</span>
 <span class="s0">*</span>
 <span class="s0">* id-ce-keyUsage OBJECT IDENTIFIER ::=  { id-ce 15 }</span>
 <span class="s0">* KeyUsage ::= BIT STRING {</span>
 <span class="s0">*   digitalSignature        (0),</span>
 <span class="s0">*   nonRepudiation          (1),</span>
 <span class="s0">*   keyEncipherment         (2),</span>
 <span class="s0">*   dataEncipherment        (3),</span>
 <span class="s0">*   keyAgreement            (4),</span>
 <span class="s0">*   keyCertSign             (5),</span>
 <span class="s0">*   cRLSign                 (6),</span>
 <span class="s0">*   encipherOnly            (7),</span>
 <span class="s0">*   decipherOnly            (8)</span>
 <span class="s0">* }</span>
 <span class="s0">*</span>
 <span class="s0">* id-ce-basicConstraints OBJECT IDENTIFIER ::=  { id-ce 19 }</span>
 <span class="s0">* BasicConstraints ::= SEQUENCE {</span>
 <span class="s0">*   cA                      BOOLEAN DEFAULT FALSE,</span>
 <span class="s0">*   pathLenConstraint       INTEGER (0..MAX) OPTIONAL</span>
 <span class="s0">* }</span>
 <span class="s0">*</span>
 <span class="s0">* subjectAltName EXTENSION ::= {</span>
 <span class="s0">*   SYNTAX GeneralNames</span>
 <span class="s0">*   IDENTIFIED BY id-ce-subjectAltName</span>
 <span class="s0">* }</span>
 <span class="s0">*</span>
 <span class="s0">* GeneralNames ::= SEQUENCE SIZE (1..MAX) OF GeneralName</span>
 <span class="s0">*</span>
 <span class="s0">* GeneralName ::= CHOICE {</span>
 <span class="s0">*   otherName      [0] INSTANCE OF OTHER-NAME,</span>
 <span class="s0">*   rfc822Name     [1] IA5String,</span>
 <span class="s0">*   dNSName        [2] IA5String,</span>
 <span class="s0">*   x400Address    [3] ORAddress,</span>
 <span class="s0">*   directoryName  [4] Name,</span>
 <span class="s0">*   ediPartyName   [5] EDIPartyName,</span>
 <span class="s0">*   uniformResourceIdentifier [6] IA5String,</span>
 <span class="s0">*   IPAddress      [7] OCTET STRING,</span>
 <span class="s0">*   registeredID   [8] OBJECT IDENTIFIER</span>
 <span class="s0">* }</span>
 <span class="s0">*</span>
 <span class="s0">* OTHER-NAME ::= TYPE-IDENTIFIER</span>
 <span class="s0">*</span>
 <span class="s0">* EDIPartyName ::= SEQUENCE {</span>
 <span class="s0">*   nameAssigner [0] DirectoryString {ub-name} OPTIONAL,</span>
 <span class="s0">*   partyName    [1] DirectoryString {ub-name}</span>
 <span class="s0">* }</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">exts the extensions ASN.1 with extension sequences to parse.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the array.</span>
 <span class="s0">*/</span>
<span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateExtensionsFromAsn1 </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">exts</span><span class="s4">) {</span>
  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= [];</span>
  <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">exts</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
    <span class="s6">// get extension sequence</span>
    <span class="s3">var </span><span class="s2">extseq </span><span class="s4">= </span><span class="s2">exts</span><span class="s4">.</span><span class="s2">value</span><span class="s4">[</span><span class="s2">i</span><span class="s4">];</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">ei </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">ei </span><span class="s4">&lt; </span><span class="s2">extseq</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">ei</span><span class="s4">) {</span>
      <span class="s2">rval</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateExtensionFromAsn1</span><span class="s4">(</span><span class="s2">extseq</span><span class="s4">.</span><span class="s2">value</span><span class="s4">[</span><span class="s2">ei</span><span class="s4">]));</span>
    <span class="s4">}</span>
  <span class="s4">}</span>

  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Parses a single certificate extension from ASN.1.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">ext the extension in ASN.1 format.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the parsed extension as an object.</span>
 <span class="s0">*/</span>
<span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateExtensionFromAsn1 </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">ext</span><span class="s4">) {</span>
  <span class="s6">// an extension has:</span>
  <span class="s6">// [0] extnID      OBJECT IDENTIFIER</span>
  <span class="s6">// [1] critical    BOOLEAN DEFAULT FALSE</span>
  <span class="s6">// [2] extnValue   OCTET STRING</span>
  <span class="s3">var </span><span class="s2">e </span><span class="s4">= {};</span>
  <span class="s2">e</span><span class="s4">.</span><span class="s2">id </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">derToOid</span><span class="s4">(</span><span class="s2">ext</span><span class="s4">.</span><span class="s2">value</span><span class="s4">[</span><span class="s7">0</span><span class="s4">].</span><span class="s2">value</span><span class="s4">);</span>
  <span class="s2">e</span><span class="s4">.</span><span class="s2">critical </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">ext</span><span class="s4">.</span><span class="s2">value</span><span class="s4">[</span><span class="s7">1</span><span class="s4">].</span><span class="s2">type </span><span class="s4">=== </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">BOOLEAN</span><span class="s4">) {</span>
    <span class="s2">e</span><span class="s4">.</span><span class="s2">critical </span><span class="s4">= (</span><span class="s2">ext</span><span class="s4">.</span><span class="s2">value</span><span class="s4">[</span><span class="s7">1</span><span class="s4">].</span><span class="s2">value</span><span class="s4">.</span><span class="s2">charCodeAt</span><span class="s4">(</span><span class="s7">0</span><span class="s4">) !== </span><span class="s7">0x00</span><span class="s4">);</span>
    <span class="s2">e</span><span class="s4">.</span><span class="s2">value </span><span class="s4">= </span><span class="s2">ext</span><span class="s4">.</span><span class="s2">value</span><span class="s4">[</span><span class="s7">2</span><span class="s4">].</span><span class="s2">value</span><span class="s4">;</span>
  <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
    <span class="s2">e</span><span class="s4">.</span><span class="s2">value </span><span class="s4">= </span><span class="s2">ext</span><span class="s4">.</span><span class="s2">value</span><span class="s4">[</span><span class="s7">1</span><span class="s4">].</span><span class="s2">value</span><span class="s4">;</span>
  <span class="s4">}</span>
  <span class="s6">// if the oid is known, get its name</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">id </span><span class="s3">in </span><span class="s2">oids</span><span class="s4">) {</span>
    <span class="s2">e</span><span class="s4">.</span><span class="s2">name </span><span class="s4">= </span><span class="s2">oids</span><span class="s4">[</span><span class="s2">e</span><span class="s4">.</span><span class="s2">id</span><span class="s4">];</span>

    <span class="s6">// handle key usage</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">name </span><span class="s4">=== </span><span class="s5">'keyUsage'</span><span class="s4">) {</span>
      <span class="s6">// get value as BIT STRING</span>
      <span class="s3">var </span><span class="s2">ev </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">fromDer</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">value</span><span class="s4">);</span>
      <span class="s3">var </span><span class="s2">b2 </span><span class="s4">= </span><span class="s7">0x00</span><span class="s4">;</span>
      <span class="s3">var </span><span class="s2">b3 </span><span class="s4">= </span><span class="s7">0x00</span><span class="s4">;</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">ev</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">length </span><span class="s4">&gt; </span><span class="s7">1</span><span class="s4">) {</span>
        <span class="s6">// skip first byte, just indicates unused bits which</span>
        <span class="s6">// will be padded with 0s anyway</span>
        <span class="s6">// get bytes with flag bits</span>
        <span class="s2">b2 </span><span class="s4">= </span><span class="s2">ev</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">charCodeAt</span><span class="s4">(</span><span class="s7">1</span><span class="s4">);</span>
        <span class="s2">b3 </span><span class="s4">= </span><span class="s2">ev</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">length </span><span class="s4">&gt; </span><span class="s7">2 </span><span class="s4">? </span><span class="s2">ev</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">charCodeAt</span><span class="s4">(</span><span class="s7">2</span><span class="s4">) : </span><span class="s7">0</span><span class="s4">;</span>
      <span class="s4">}</span>
      <span class="s6">// set flags</span>
      <span class="s2">e</span><span class="s4">.</span><span class="s2">digitalSignature </span><span class="s4">= (</span><span class="s2">b2 </span><span class="s4">&amp; </span><span class="s7">0x80</span><span class="s4">) === </span><span class="s7">0x80</span><span class="s4">;</span>
      <span class="s2">e</span><span class="s4">.</span><span class="s2">nonRepudiation </span><span class="s4">= (</span><span class="s2">b2 </span><span class="s4">&amp; </span><span class="s7">0x40</span><span class="s4">) === </span><span class="s7">0x40</span><span class="s4">;</span>
      <span class="s2">e</span><span class="s4">.</span><span class="s2">keyEncipherment </span><span class="s4">= (</span><span class="s2">b2 </span><span class="s4">&amp; </span><span class="s7">0x20</span><span class="s4">) === </span><span class="s7">0x20</span><span class="s4">;</span>
      <span class="s2">e</span><span class="s4">.</span><span class="s2">dataEncipherment </span><span class="s4">= (</span><span class="s2">b2 </span><span class="s4">&amp; </span><span class="s7">0x10</span><span class="s4">) === </span><span class="s7">0x10</span><span class="s4">;</span>
      <span class="s2">e</span><span class="s4">.</span><span class="s2">keyAgreement </span><span class="s4">= (</span><span class="s2">b2 </span><span class="s4">&amp; </span><span class="s7">0x08</span><span class="s4">) === </span><span class="s7">0x08</span><span class="s4">;</span>
      <span class="s2">e</span><span class="s4">.</span><span class="s2">keyCertSign </span><span class="s4">= (</span><span class="s2">b2 </span><span class="s4">&amp; </span><span class="s7">0x04</span><span class="s4">) === </span><span class="s7">0x04</span><span class="s4">;</span>
      <span class="s2">e</span><span class="s4">.</span><span class="s2">cRLSign </span><span class="s4">= (</span><span class="s2">b2 </span><span class="s4">&amp; </span><span class="s7">0x02</span><span class="s4">) === </span><span class="s7">0x02</span><span class="s4">;</span>
      <span class="s2">e</span><span class="s4">.</span><span class="s2">encipherOnly </span><span class="s4">= (</span><span class="s2">b2 </span><span class="s4">&amp; </span><span class="s7">0x01</span><span class="s4">) === </span><span class="s7">0x01</span><span class="s4">;</span>
      <span class="s2">e</span><span class="s4">.</span><span class="s2">decipherOnly </span><span class="s4">= (</span><span class="s2">b3 </span><span class="s4">&amp; </span><span class="s7">0x80</span><span class="s4">) === </span><span class="s7">0x80</span><span class="s4">;</span>
    <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">name </span><span class="s4">=== </span><span class="s5">'basicConstraints'</span><span class="s4">) {</span>
      <span class="s6">// handle basic constraints</span>
      <span class="s6">// get value as SEQUENCE</span>
      <span class="s3">var </span><span class="s2">ev </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">fromDer</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">value</span><span class="s4">);</span>
      <span class="s6">// get cA BOOLEAN flag (defaults to false)</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">ev</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">length </span><span class="s4">&gt; </span><span class="s7">0 </span><span class="s4">&amp;&amp; </span><span class="s2">ev</span><span class="s4">.</span><span class="s2">value</span><span class="s4">[</span><span class="s7">0</span><span class="s4">].</span><span class="s2">type </span><span class="s4">=== </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">BOOLEAN</span><span class="s4">) {</span>
        <span class="s2">e</span><span class="s4">.</span><span class="s2">cA </span><span class="s4">= (</span><span class="s2">ev</span><span class="s4">.</span><span class="s2">value</span><span class="s4">[</span><span class="s7">0</span><span class="s4">].</span><span class="s2">value</span><span class="s4">.</span><span class="s2">charCodeAt</span><span class="s4">(</span><span class="s7">0</span><span class="s4">) !== </span><span class="s7">0x00</span><span class="s4">);</span>
      <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
        <span class="s2">e</span><span class="s4">.</span><span class="s2">cA </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>
      <span class="s4">}</span>
      <span class="s6">// get path length constraint</span>
      <span class="s3">var </span><span class="s2">value </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">ev</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">length </span><span class="s4">&gt; </span><span class="s7">0 </span><span class="s4">&amp;&amp; </span><span class="s2">ev</span><span class="s4">.</span><span class="s2">value</span><span class="s4">[</span><span class="s7">0</span><span class="s4">].</span><span class="s2">type </span><span class="s4">=== </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">INTEGER</span><span class="s4">) {</span>
        <span class="s2">value </span><span class="s4">= </span><span class="s2">ev</span><span class="s4">.</span><span class="s2">value</span><span class="s4">[</span><span class="s7">0</span><span class="s4">].</span><span class="s2">value</span><span class="s4">;</span>
      <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">ev</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">length </span><span class="s4">&gt; </span><span class="s7">1</span><span class="s4">) {</span>
        <span class="s2">value </span><span class="s4">= </span><span class="s2">ev</span><span class="s4">.</span><span class="s2">value</span><span class="s4">[</span><span class="s7">1</span><span class="s4">].</span><span class="s2">value</span><span class="s4">;</span>
      <span class="s4">}</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">value </span><span class="s4">!== </span><span class="s3">null</span><span class="s4">) {</span>
        <span class="s2">e</span><span class="s4">.</span><span class="s2">pathLenConstraint </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">derToInteger</span><span class="s4">(</span><span class="s2">value</span><span class="s4">);</span>
      <span class="s4">}</span>
    <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">name </span><span class="s4">=== </span><span class="s5">'extKeyUsage'</span><span class="s4">) {</span>
      <span class="s6">// handle extKeyUsage</span>
      <span class="s6">// value is a SEQUENCE of OIDs</span>
      <span class="s3">var </span><span class="s2">ev </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">fromDer</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">value</span><span class="s4">);</span>
      <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">vi </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">vi </span><span class="s4">&lt; </span><span class="s2">ev</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">vi</span><span class="s4">) {</span>
        <span class="s3">var </span><span class="s2">oid </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">derToOid</span><span class="s4">(</span><span class="s2">ev</span><span class="s4">.</span><span class="s2">value</span><span class="s4">[</span><span class="s2">vi</span><span class="s4">].</span><span class="s2">value</span><span class="s4">);</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s2">oid </span><span class="s3">in </span><span class="s2">oids</span><span class="s4">) {</span>
          <span class="s2">e</span><span class="s4">[</span><span class="s2">oids</span><span class="s4">[</span><span class="s2">oid</span><span class="s4">]] = </span><span class="s3">true</span><span class="s4">;</span>
        <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
          <span class="s2">e</span><span class="s4">[</span><span class="s2">oid</span><span class="s4">] = </span><span class="s3">true</span><span class="s4">;</span>
        <span class="s4">}</span>
      <span class="s4">}</span>
    <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">name </span><span class="s4">=== </span><span class="s5">'nsCertType'</span><span class="s4">) {</span>
      <span class="s6">// handle nsCertType</span>
      <span class="s6">// get value as BIT STRING</span>
      <span class="s3">var </span><span class="s2">ev </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">fromDer</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">value</span><span class="s4">);</span>
      <span class="s3">var </span><span class="s2">b2 </span><span class="s4">= </span><span class="s7">0x00</span><span class="s4">;</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">ev</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">length </span><span class="s4">&gt; </span><span class="s7">1</span><span class="s4">) {</span>
        <span class="s6">// skip first byte, just indicates unused bits which</span>
        <span class="s6">// will be padded with 0s anyway</span>
        <span class="s6">// get bytes with flag bits</span>
        <span class="s2">b2 </span><span class="s4">= </span><span class="s2">ev</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">charCodeAt</span><span class="s4">(</span><span class="s7">1</span><span class="s4">);</span>
      <span class="s4">}</span>
      <span class="s6">// set flags</span>
      <span class="s2">e</span><span class="s4">.</span><span class="s2">client </span><span class="s4">= (</span><span class="s2">b2 </span><span class="s4">&amp; </span><span class="s7">0x80</span><span class="s4">) === </span><span class="s7">0x80</span><span class="s4">;</span>
      <span class="s2">e</span><span class="s4">.</span><span class="s2">server </span><span class="s4">= (</span><span class="s2">b2 </span><span class="s4">&amp; </span><span class="s7">0x40</span><span class="s4">) === </span><span class="s7">0x40</span><span class="s4">;</span>
      <span class="s2">e</span><span class="s4">.</span><span class="s2">email </span><span class="s4">= (</span><span class="s2">b2 </span><span class="s4">&amp; </span><span class="s7">0x20</span><span class="s4">) === </span><span class="s7">0x20</span><span class="s4">;</span>
      <span class="s2">e</span><span class="s4">.</span><span class="s2">objsign </span><span class="s4">= (</span><span class="s2">b2 </span><span class="s4">&amp; </span><span class="s7">0x10</span><span class="s4">) === </span><span class="s7">0x10</span><span class="s4">;</span>
      <span class="s2">e</span><span class="s4">.</span><span class="s2">reserved </span><span class="s4">= (</span><span class="s2">b2 </span><span class="s4">&amp; </span><span class="s7">0x08</span><span class="s4">) === </span><span class="s7">0x08</span><span class="s4">;</span>
      <span class="s2">e</span><span class="s4">.</span><span class="s2">sslCA </span><span class="s4">= (</span><span class="s2">b2 </span><span class="s4">&amp; </span><span class="s7">0x04</span><span class="s4">) === </span><span class="s7">0x04</span><span class="s4">;</span>
      <span class="s2">e</span><span class="s4">.</span><span class="s2">emailCA </span><span class="s4">= (</span><span class="s2">b2 </span><span class="s4">&amp; </span><span class="s7">0x02</span><span class="s4">) === </span><span class="s7">0x02</span><span class="s4">;</span>
      <span class="s2">e</span><span class="s4">.</span><span class="s2">objCA </span><span class="s4">= (</span><span class="s2">b2 </span><span class="s4">&amp; </span><span class="s7">0x01</span><span class="s4">) === </span><span class="s7">0x01</span><span class="s4">;</span>
    <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span>
      <span class="s2">e</span><span class="s4">.</span><span class="s2">name </span><span class="s4">=== </span><span class="s5">'subjectAltName' </span><span class="s4">||</span>
      <span class="s2">e</span><span class="s4">.</span><span class="s2">name </span><span class="s4">=== </span><span class="s5">'issuerAltName'</span><span class="s4">) {</span>
      <span class="s6">// handle subjectAltName/issuerAltName</span>
      <span class="s2">e</span><span class="s4">.</span><span class="s2">altNames </span><span class="s4">= [];</span>

      <span class="s6">// ev is a SYNTAX SEQUENCE</span>
      <span class="s3">var </span><span class="s2">gn</span><span class="s4">;</span>
      <span class="s3">var </span><span class="s2">ev </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">fromDer</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">value</span><span class="s4">);</span>
      <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">n </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">n </span><span class="s4">&lt; </span><span class="s2">ev</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">n</span><span class="s4">) {</span>
        <span class="s6">// get GeneralName</span>
        <span class="s2">gn </span><span class="s4">= </span><span class="s2">ev</span><span class="s4">.</span><span class="s2">value</span><span class="s4">[</span><span class="s2">n</span><span class="s4">];</span>

        <span class="s3">var </span><span class="s2">altName </span><span class="s4">= {</span>
          <span class="s2">type</span><span class="s4">: </span><span class="s2">gn</span><span class="s4">.</span><span class="s2">type</span><span class="s4">,</span>
          <span class="s2">value</span><span class="s4">: </span><span class="s2">gn</span><span class="s4">.</span><span class="s2">value</span>
        <span class="s4">};</span>
        <span class="s2">e</span><span class="s4">.</span><span class="s2">altNames</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">altName</span><span class="s4">);</span>

        <span class="s6">// Note: Support for types 1,2,6,7,8</span>
        <span class="s3">switch</span><span class="s4">(</span><span class="s2">gn</span><span class="s4">.</span><span class="s2">type</span><span class="s4">) {</span>
          <span class="s6">// rfc822Name</span>
          <span class="s3">case </span><span class="s7">1</span><span class="s4">:</span>
          <span class="s6">// dNSName</span>
          <span class="s3">case </span><span class="s7">2</span><span class="s4">:</span>
          <span class="s6">// uniformResourceIdentifier (URI)</span>
          <span class="s3">case </span><span class="s7">6</span><span class="s4">:</span>
            <span class="s3">break</span><span class="s4">;</span>
          <span class="s6">// IPAddress</span>
          <span class="s3">case </span><span class="s7">7</span><span class="s4">:</span>
            <span class="s6">// convert to IPv4/IPv6 string representation</span>
            <span class="s2">altName</span><span class="s4">.</span><span class="s2">ip </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">bytesToIP</span><span class="s4">(</span><span class="s2">gn</span><span class="s4">.</span><span class="s2">value</span><span class="s4">);</span>
            <span class="s3">break</span><span class="s4">;</span>
          <span class="s6">// registeredID</span>
          <span class="s3">case </span><span class="s7">8</span><span class="s4">:</span>
            <span class="s2">altName</span><span class="s4">.</span><span class="s2">oid </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">derToOid</span><span class="s4">(</span><span class="s2">gn</span><span class="s4">.</span><span class="s2">value</span><span class="s4">);</span>
            <span class="s3">break</span><span class="s4">;</span>
          <span class="s3">default</span><span class="s4">:</span>
            <span class="s6">// unsupported</span>
        <span class="s4">}</span>
      <span class="s4">}</span>
    <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">name </span><span class="s4">=== </span><span class="s5">'subjectKeyIdentifier'</span><span class="s4">) {</span>
      <span class="s6">// value is an OCTETSTRING w/the hash of the key-type specific</span>
      <span class="s6">// public key structure (eg: RSAPublicKey)</span>
      <span class="s3">var </span><span class="s2">ev </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">fromDer</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">value</span><span class="s4">);</span>
      <span class="s2">e</span><span class="s4">.</span><span class="s2">subjectKeyIdentifier </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">bytesToHex</span><span class="s4">(</span><span class="s2">ev</span><span class="s4">.</span><span class="s2">value</span><span class="s4">);</span>
    <span class="s4">}</span>
  <span class="s4">}</span>
  <span class="s3">return </span><span class="s2">e</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Converts a PKCS#10 certification request (CSR) from an ASN.1 object.</span>
 <span class="s0">*</span>
 <span class="s0">* Note: If the certification request is to be verified then compute hash</span>
 <span class="s0">* should be set to true. There is currently no implementation for converting</span>
 <span class="s0">* a certificate back to ASN.1 so the CertificationRequestInfo part of the</span>
 <span class="s0">* ASN.1 object needs to be scanned before the csr object is created.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">obj the asn1 representation of a PKCS#10 certification request (CSR).</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">computeHash true to compute the hash for verification.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the certification request (CSR).</span>
 <span class="s0">*/</span>
<span class="s2">pki</span><span class="s4">.</span><span class="s2">certificationRequestFromAsn1 </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">obj</span><span class="s4">, </span><span class="s2">computeHash</span><span class="s4">) {</span>
  <span class="s6">// validate certification request and capture data</span>
  <span class="s3">var </span><span class="s2">capture </span><span class="s4">= {};</span>
  <span class="s3">var </span><span class="s2">errors </span><span class="s4">= [];</span>
  <span class="s3">if</span><span class="s4">(!</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">validate</span><span class="s4">(</span><span class="s2">obj</span><span class="s4">, </span><span class="s2">certificationRequestValidator</span><span class="s4">, </span><span class="s2">capture</span><span class="s4">, </span><span class="s2">errors</span><span class="s4">)) {</span>
    <span class="s3">var </span><span class="s2">error </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Cannot read PKCS#10 certificate request. ' </span><span class="s4">+</span>
      <span class="s5">'ASN.1 object is not a PKCS#10 CertificationRequest.'</span><span class="s4">);</span>
    <span class="s2">error</span><span class="s4">.</span><span class="s2">errors </span><span class="s4">= </span><span class="s2">errors</span><span class="s4">;</span>
    <span class="s3">throw </span><span class="s2">error</span><span class="s4">;</span>
  <span class="s4">}</span>

  <span class="s6">// get oid</span>
  <span class="s3">var </span><span class="s2">oid </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">derToOid</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">publicKeyOid</span><span class="s4">);</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">oid </span><span class="s4">!== </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">oids</span><span class="s4">.</span><span class="s2">rsaEncryption</span><span class="s4">) {</span>
    <span class="s3">throw new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Cannot read public key. OID is not RSA.'</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s6">// create certification request</span>
  <span class="s3">var </span><span class="s2">csr </span><span class="s4">= </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">createCertificationRequest</span><span class="s4">();</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">version </span><span class="s4">= </span><span class="s2">capture</span><span class="s4">.</span><span class="s2">csrVersion </span><span class="s4">? </span><span class="s2">capture</span><span class="s4">.</span><span class="s2">csrVersion</span><span class="s4">.</span><span class="s2">charCodeAt</span><span class="s4">(</span><span class="s7">0</span><span class="s4">) : </span><span class="s7">0</span><span class="s4">;</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">signatureOid </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">derToOid</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">csrSignatureOid</span><span class="s4">);</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">signatureParameters </span><span class="s4">= </span><span class="s2">_readSignatureParameters</span><span class="s4">(</span>
    <span class="s2">csr</span><span class="s4">.</span><span class="s2">signatureOid</span><span class="s4">, </span><span class="s2">capture</span><span class="s4">.</span><span class="s2">csrSignatureParams</span><span class="s4">, </span><span class="s3">true</span><span class="s4">);</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">siginfo</span><span class="s4">.</span><span class="s2">algorithmOid </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">derToOid</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">csrSignatureOid</span><span class="s4">);</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">siginfo</span><span class="s4">.</span><span class="s2">parameters </span><span class="s4">= </span><span class="s2">_readSignatureParameters</span><span class="s4">(</span>
    <span class="s2">csr</span><span class="s4">.</span><span class="s2">siginfo</span><span class="s4">.</span><span class="s2">algorithmOid</span><span class="s4">, </span><span class="s2">capture</span><span class="s4">.</span><span class="s2">csrSignatureParams</span><span class="s4">, </span><span class="s3">false</span><span class="s4">);</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">signature </span><span class="s4">= </span><span class="s2">capture</span><span class="s4">.</span><span class="s2">csrSignature</span><span class="s4">;</span>

  <span class="s6">// keep CertificationRequestInfo to preserve signature when exporting</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">certificationRequestInfo </span><span class="s4">= </span><span class="s2">capture</span><span class="s4">.</span><span class="s2">certificationRequestInfo</span><span class="s4">;</span>

  <span class="s3">if</span><span class="s4">(</span><span class="s2">computeHash</span><span class="s4">) {</span>
    <span class="s6">// create digest for OID signature type</span>
    <span class="s2">csr</span><span class="s4">.</span><span class="s2">md </span><span class="s4">= </span><span class="s2">_createSignatureDigest</span><span class="s4">({</span>
      <span class="s2">signatureOid</span><span class="s4">: </span><span class="s2">csr</span><span class="s4">.</span><span class="s2">signatureOid</span><span class="s4">,</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s5">'certification request'</span>
    <span class="s4">});</span>

    <span class="s6">// produce DER formatted CertificationRequestInfo and digest it</span>
    <span class="s3">var </span><span class="s2">bytes </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">toDer</span><span class="s4">(</span><span class="s2">csr</span><span class="s4">.</span><span class="s2">certificationRequestInfo</span><span class="s4">);</span>
    <span class="s2">csr</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">update</span><span class="s4">(</span><span class="s2">bytes</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">());</span>
  <span class="s4">}</span>

  <span class="s6">// handle subject, build subject message digest</span>
  <span class="s3">var </span><span class="s2">smd </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">sha1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">();</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">getField </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">sn</span><span class="s4">) {</span>
    <span class="s3">return </span><span class="s2">_getAttribute</span><span class="s4">(</span><span class="s2">csr</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">, </span><span class="s2">sn</span><span class="s4">);</span>
  <span class="s4">};</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">addField </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">) {</span>
    <span class="s2">_fillMissingFields</span><span class="s4">([</span><span class="s2">attr</span><span class="s4">]);</span>
    <span class="s2">csr</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">attributes</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">);</span>
  <span class="s4">};</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">attributes </span><span class="s4">= </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">RDNAttributesAsArray</span><span class="s4">(</span>
    <span class="s2">capture</span><span class="s4">.</span><span class="s2">certificationRequestInfoSubject</span><span class="s4">, </span><span class="s2">smd</span><span class="s4">);</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">hash </span><span class="s4">= </span><span class="s2">smd</span><span class="s4">.</span><span class="s2">digest</span><span class="s4">().</span><span class="s2">toHex</span><span class="s4">();</span>

  <span class="s6">// convert RSA public key from ASN.1</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">publicKey </span><span class="s4">= </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">publicKeyFromAsn1</span><span class="s4">(</span><span class="s2">capture</span><span class="s4">.</span><span class="s2">subjectPublicKeyInfo</span><span class="s4">);</span>

  <span class="s6">// convert attributes from ASN.1</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">getAttribute </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">sn</span><span class="s4">) {</span>
    <span class="s3">return </span><span class="s2">_getAttribute</span><span class="s4">(</span><span class="s2">csr</span><span class="s4">, </span><span class="s2">sn</span><span class="s4">);</span>
  <span class="s4">};</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">addAttribute </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">) {</span>
    <span class="s2">_fillMissingFields</span><span class="s4">([</span><span class="s2">attr</span><span class="s4">]);</span>
    <span class="s2">csr</span><span class="s4">.</span><span class="s2">attributes</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">);</span>
  <span class="s4">};</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">attributes </span><span class="s4">= </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">CRIAttributesAsArray</span><span class="s4">(</span>
    <span class="s2">capture</span><span class="s4">.</span><span class="s2">certificationRequestInfoAttributes </span><span class="s4">|| []);</span>

  <span class="s3">return </span><span class="s2">csr</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Creates an empty certification request (a CSR or certificate signing</span>
 <span class="s0">* request). Once created, its public key and attributes can be set and then</span>
 <span class="s0">* it can be signed.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the empty certification request.</span>
 <span class="s0">*/</span>
<span class="s2">pki</span><span class="s4">.</span><span class="s2">createCertificationRequest </span><span class="s4">= </span><span class="s3">function</span><span class="s4">() {</span>
  <span class="s3">var </span><span class="s2">csr </span><span class="s4">= {};</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">version </span><span class="s4">= </span><span class="s7">0x00</span><span class="s4">;</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">signatureOid </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">signature </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">siginfo </span><span class="s4">= {};</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">siginfo</span><span class="s4">.</span><span class="s2">algorithmOid </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>

  <span class="s2">csr</span><span class="s4">.</span><span class="s2">subject </span><span class="s4">= {};</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">getField </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">sn</span><span class="s4">) {</span>
    <span class="s3">return </span><span class="s2">_getAttribute</span><span class="s4">(</span><span class="s2">csr</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">, </span><span class="s2">sn</span><span class="s4">);</span>
  <span class="s4">};</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">addField </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">) {</span>
    <span class="s2">_fillMissingFields</span><span class="s4">([</span><span class="s2">attr</span><span class="s4">]);</span>
    <span class="s2">csr</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">attributes</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">);</span>
  <span class="s4">};</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">attributes </span><span class="s4">= [];</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">hash </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>

  <span class="s2">csr</span><span class="s4">.</span><span class="s2">publicKey </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">attributes </span><span class="s4">= [];</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">getAttribute </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">sn</span><span class="s4">) {</span>
    <span class="s3">return </span><span class="s2">_getAttribute</span><span class="s4">(</span><span class="s2">csr</span><span class="s4">, </span><span class="s2">sn</span><span class="s4">);</span>
  <span class="s4">};</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">addAttribute </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">) {</span>
    <span class="s2">_fillMissingFields</span><span class="s4">([</span><span class="s2">attr</span><span class="s4">]);</span>
    <span class="s2">csr</span><span class="s4">.</span><span class="s2">attributes</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">);</span>
  <span class="s4">};</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">md </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>

  <span class="s0">/**</span>
   <span class="s0">* Sets the subject of this certification request.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">attrs the array of subject attributes to use.</span>
   <span class="s0">*/</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">setSubject </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">attrs</span><span class="s4">) {</span>
    <span class="s6">// set new attributes</span>
    <span class="s2">_fillMissingFields</span><span class="s4">(</span><span class="s2">attrs</span><span class="s4">);</span>
    <span class="s2">csr</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">attributes </span><span class="s4">= </span><span class="s2">attrs</span><span class="s4">;</span>
    <span class="s2">csr</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">hash </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Sets the attributes of this certification request.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">attrs the array of attributes to use.</span>
   <span class="s0">*/</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">setAttributes </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">attrs</span><span class="s4">) {</span>
    <span class="s6">// set new attributes</span>
    <span class="s2">_fillMissingFields</span><span class="s4">(</span><span class="s2">attrs</span><span class="s4">);</span>
    <span class="s2">csr</span><span class="s4">.</span><span class="s2">attributes </span><span class="s4">= </span><span class="s2">attrs</span><span class="s4">;</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Signs this certification request using the given private key.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">key the private key to sign with.</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">md the message digest object to use (defaults to forge.md.sha1).</span>
   <span class="s0">*/</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">sign </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">key</span><span class="s4">, </span><span class="s2">md</span><span class="s4">) {</span>
    <span class="s6">// TODO: get signature OID from private key</span>
    <span class="s2">csr</span><span class="s4">.</span><span class="s2">md </span><span class="s4">= </span><span class="s2">md </span><span class="s4">|| </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">sha1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">();</span>
    <span class="s3">var </span><span class="s2">algorithmOid </span><span class="s4">= </span><span class="s2">oids</span><span class="s4">[</span><span class="s2">csr</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">algorithm </span><span class="s4">+ </span><span class="s5">'WithRSAEncryption'</span><span class="s4">];</span>
    <span class="s3">if</span><span class="s4">(!</span><span class="s2">algorithmOid</span><span class="s4">) {</span>
      <span class="s3">var </span><span class="s2">error </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Could not compute certification request digest. ' </span><span class="s4">+</span>
        <span class="s5">'Unknown message digest algorithm OID.'</span><span class="s4">);</span>
      <span class="s2">error</span><span class="s4">.</span><span class="s2">algorithm </span><span class="s4">= </span><span class="s2">csr</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">algorithm</span><span class="s4">;</span>
      <span class="s3">throw </span><span class="s2">error</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s2">csr</span><span class="s4">.</span><span class="s2">signatureOid </span><span class="s4">= </span><span class="s2">csr</span><span class="s4">.</span><span class="s2">siginfo</span><span class="s4">.</span><span class="s2">algorithmOid </span><span class="s4">= </span><span class="s2">algorithmOid</span><span class="s4">;</span>

    <span class="s6">// get CertificationRequestInfo, convert to DER</span>
    <span class="s2">csr</span><span class="s4">.</span><span class="s2">certificationRequestInfo </span><span class="s4">= </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">getCertificationRequestInfo</span><span class="s4">(</span><span class="s2">csr</span><span class="s4">);</span>
    <span class="s3">var </span><span class="s2">bytes </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">toDer</span><span class="s4">(</span><span class="s2">csr</span><span class="s4">.</span><span class="s2">certificationRequestInfo</span><span class="s4">);</span>

    <span class="s6">// digest and sign</span>
    <span class="s2">csr</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">update</span><span class="s4">(</span><span class="s2">bytes</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">());</span>
    <span class="s2">csr</span><span class="s4">.</span><span class="s2">signature </span><span class="s4">= </span><span class="s2">key</span><span class="s4">.</span><span class="s2">sign</span><span class="s4">(</span><span class="s2">csr</span><span class="s4">.</span><span class="s2">md</span><span class="s4">);</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Attempts verify the signature on the passed certification request using</span>
   <span class="s0">* its public key.</span>
   <span class="s0">*</span>
   <span class="s0">* A CSR that has been exported to a file in PEM format can be verified using</span>
   <span class="s0">* OpenSSL using this command:</span>
   <span class="s0">*</span>
   <span class="s0">* openssl req -in &lt;the-csr-pem-file&gt; -verify -noout -text</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@return </span><span class="s0">true if verified, false if not.</span>
   <span class="s0">*/</span>
  <span class="s2">csr</span><span class="s4">.</span><span class="s2">verify </span><span class="s4">= </span><span class="s3">function</span><span class="s4">() {</span>
    <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>

    <span class="s3">var </span><span class="s2">md </span><span class="s4">= </span><span class="s2">csr</span><span class="s4">.</span><span class="s2">md</span><span class="s4">;</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">md </span><span class="s4">=== </span><span class="s3">null</span><span class="s4">) {</span>
      <span class="s2">md </span><span class="s4">= </span><span class="s2">_createSignatureDigest</span><span class="s4">({</span>
        <span class="s2">signatureOid</span><span class="s4">: </span><span class="s2">csr</span><span class="s4">.</span><span class="s2">signatureOid</span><span class="s4">,</span>
        <span class="s2">type</span><span class="s4">: </span><span class="s5">'certification request'</span>
      <span class="s4">});</span>

      <span class="s6">// produce DER formatted CertificationRequestInfo and digest it</span>
      <span class="s3">var </span><span class="s2">cri </span><span class="s4">= </span><span class="s2">csr</span><span class="s4">.</span><span class="s2">certificationRequestInfo </span><span class="s4">||</span>
        <span class="s2">pki</span><span class="s4">.</span><span class="s2">getCertificationRequestInfo</span><span class="s4">(</span><span class="s2">csr</span><span class="s4">);</span>
      <span class="s3">var </span><span class="s2">bytes </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">toDer</span><span class="s4">(</span><span class="s2">cri</span><span class="s4">);</span>
      <span class="s2">md</span><span class="s4">.</span><span class="s2">update</span><span class="s4">(</span><span class="s2">bytes</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">());</span>
    <span class="s4">}</span>

    <span class="s3">if</span><span class="s4">(</span><span class="s2">md </span><span class="s4">!== </span><span class="s3">null</span><span class="s4">) {</span>
      <span class="s2">rval </span><span class="s4">= </span><span class="s2">_verifySignature</span><span class="s4">({</span>
        <span class="s2">certificate</span><span class="s4">: </span><span class="s2">csr</span><span class="s4">, </span><span class="s2">md</span><span class="s4">: </span><span class="s2">md</span><span class="s4">, </span><span class="s2">signature</span><span class="s4">: </span><span class="s2">csr</span><span class="s4">.</span><span class="s2">signature</span>
      <span class="s4">});</span>
    <span class="s4">}</span>

    <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
  <span class="s4">};</span>

  <span class="s3">return </span><span class="s2">csr</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Converts an X.509 subject or issuer to an ASN.1 RDNSequence.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">obj the subject or issuer (distinguished name).</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the ASN.1 RDNSequence.</span>
 <span class="s0">*/</span>
<span class="s3">function </span><span class="s2">_dnToAsn1</span><span class="s4">(</span><span class="s2">obj</span><span class="s4">) {</span>
  <span class="s6">// create an empty RDNSequence</span>
  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span>
    <span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, []);</span>

  <span class="s6">// iterate over attributes</span>
  <span class="s3">var </span><span class="s2">attr</span><span class="s4">, </span><span class="s2">set</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">attrs </span><span class="s4">= </span><span class="s2">obj</span><span class="s4">.</span><span class="s2">attributes</span><span class="s4">;</span>
  <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">attrs</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
    <span class="s2">attr </span><span class="s4">= </span><span class="s2">attrs</span><span class="s4">[</span><span class="s2">i</span><span class="s4">];</span>
    <span class="s3">var </span><span class="s2">value </span><span class="s4">= </span><span class="s2">attr</span><span class="s4">.</span><span class="s2">value</span><span class="s4">;</span>

    <span class="s6">// reuse tag class for attribute value if available</span>
    <span class="s3">var </span><span class="s2">valueTagClass </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">PRINTABLESTRING</span><span class="s4">;</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s5">'valueTagClass' </span><span class="s3">in </span><span class="s2">attr</span><span class="s4">) {</span>
      <span class="s2">valueTagClass </span><span class="s4">= </span><span class="s2">attr</span><span class="s4">.</span><span class="s2">valueTagClass</span><span class="s4">;</span>

      <span class="s3">if</span><span class="s4">(</span><span class="s2">valueTagClass </span><span class="s4">=== </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">UTF8</span><span class="s4">) {</span>
        <span class="s2">value </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">encodeUtf8</span><span class="s4">(</span><span class="s2">value</span><span class="s4">);</span>
      <span class="s4">}</span>
      <span class="s6">// FIXME: handle more encodings</span>
    <span class="s4">}</span>

    <span class="s6">// create a RelativeDistinguishedName set</span>
    <span class="s6">// each value in the set is an AttributeTypeAndValue first</span>
    <span class="s6">// containing the type (an OID) and second the value</span>
    <span class="s2">set </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SET</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, [</span>
      <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, [</span>
        <span class="s6">// AttributeType</span>
        <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">OID</span><span class="s4">, </span><span class="s3">false</span><span class="s4">,</span>
          <span class="s2">asn1</span><span class="s4">.</span><span class="s2">oidToDer</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">.</span><span class="s2">type</span><span class="s4">).</span><span class="s2">getBytes</span><span class="s4">()),</span>
        <span class="s6">// AttributeValue</span>
        <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">valueTagClass</span><span class="s4">, </span><span class="s3">false</span><span class="s4">, </span><span class="s2">value</span><span class="s4">)</span>
      <span class="s4">])</span>
    <span class="s4">]);</span>
    <span class="s2">rval</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">set</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">}</span>

<span class="s0">/**</span>
 <span class="s0">* Gets all printable attributes (typically of an issuer or subject) in a</span>
 <span class="s0">* simplified JSON format for display.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">attrs the attributes.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the JSON for display.</span>
 <span class="s0">*/</span>
<span class="s3">function </span><span class="s2">_getAttributesAsJson</span><span class="s4">(</span><span class="s2">attrs</span><span class="s4">) {</span>
  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= {};</span>
  <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">attrs</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
    <span class="s3">var </span><span class="s2">attr </span><span class="s4">= </span><span class="s2">attrs</span><span class="s4">[</span><span class="s2">i</span><span class="s4">];</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">.</span><span class="s2">shortName </span><span class="s4">&amp;&amp; (</span>
      <span class="s2">attr</span><span class="s4">.</span><span class="s2">valueTagClass </span><span class="s4">=== </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">UTF8 </span><span class="s4">||</span>
      <span class="s2">attr</span><span class="s4">.</span><span class="s2">valueTagClass </span><span class="s4">=== </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">PRINTABLESTRING </span><span class="s4">||</span>
      <span class="s2">attr</span><span class="s4">.</span><span class="s2">valueTagClass </span><span class="s4">=== </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">IA5STRING</span><span class="s4">)) {</span>
      <span class="s3">var </span><span class="s2">value </span><span class="s4">= </span><span class="s2">attr</span><span class="s4">.</span><span class="s2">value</span><span class="s4">;</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">.</span><span class="s2">valueTagClass </span><span class="s4">=== </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">UTF8</span><span class="s4">) {</span>
        <span class="s2">value </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">encodeUtf8</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">.</span><span class="s2">value</span><span class="s4">);</span>
      <span class="s4">}</span>
      <span class="s3">if</span><span class="s4">(!(</span><span class="s2">attr</span><span class="s4">.</span><span class="s2">shortName </span><span class="s3">in </span><span class="s2">rval</span><span class="s4">)) {</span>
        <span class="s2">rval</span><span class="s4">[</span><span class="s2">attr</span><span class="s4">.</span><span class="s2">shortName</span><span class="s4">] = </span><span class="s2">value</span><span class="s4">;</span>
      <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">isArray</span><span class="s4">(</span><span class="s2">rval</span><span class="s4">[</span><span class="s2">attr</span><span class="s4">.</span><span class="s2">shortName</span><span class="s4">])) {</span>
        <span class="s2">rval</span><span class="s4">[</span><span class="s2">attr</span><span class="s4">.</span><span class="s2">shortName</span><span class="s4">].</span><span class="s2">push</span><span class="s4">(</span><span class="s2">value</span><span class="s4">);</span>
      <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
        <span class="s2">rval</span><span class="s4">[</span><span class="s2">attr</span><span class="s4">.</span><span class="s2">shortName</span><span class="s4">] = [</span><span class="s2">rval</span><span class="s4">[</span><span class="s2">attr</span><span class="s4">.</span><span class="s2">shortName</span><span class="s4">], </span><span class="s2">value</span><span class="s4">];</span>
      <span class="s4">}</span>
    <span class="s4">}</span>
  <span class="s4">}</span>
  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">}</span>

<span class="s0">/**</span>
 <span class="s0">* Fills in missing fields in attributes.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">attrs the attributes to fill missing fields in.</span>
 <span class="s0">*/</span>
<span class="s3">function </span><span class="s2">_fillMissingFields</span><span class="s4">(</span><span class="s2">attrs</span><span class="s4">) {</span>
  <span class="s3">var </span><span class="s2">attr</span><span class="s4">;</span>
  <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">attrs</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
    <span class="s2">attr </span><span class="s4">= </span><span class="s2">attrs</span><span class="s4">[</span><span class="s2">i</span><span class="s4">];</span>

    <span class="s6">// populate missing name</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s3">typeof </span><span class="s2">attr</span><span class="s4">.</span><span class="s2">name </span><span class="s4">=== </span><span class="s5">'undefined'</span><span class="s4">) {</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">.</span><span class="s2">type </span><span class="s4">&amp;&amp; </span><span class="s2">attr</span><span class="s4">.</span><span class="s2">type </span><span class="s3">in </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">oids</span><span class="s4">) {</span>
        <span class="s2">attr</span><span class="s4">.</span><span class="s2">name </span><span class="s4">= </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">oids</span><span class="s4">[</span><span class="s2">attr</span><span class="s4">.</span><span class="s2">type</span><span class="s4">];</span>
      <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">.</span><span class="s2">shortName </span><span class="s4">&amp;&amp; </span><span class="s2">attr</span><span class="s4">.</span><span class="s2">shortName </span><span class="s3">in </span><span class="s2">_shortNames</span><span class="s4">) {</span>
        <span class="s2">attr</span><span class="s4">.</span><span class="s2">name </span><span class="s4">= </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">oids</span><span class="s4">[</span><span class="s2">_shortNames</span><span class="s4">[</span><span class="s2">attr</span><span class="s4">.</span><span class="s2">shortName</span><span class="s4">]];</span>
      <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s6">// populate missing type (OID)</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s3">typeof </span><span class="s2">attr</span><span class="s4">.</span><span class="s2">type </span><span class="s4">=== </span><span class="s5">'undefined'</span><span class="s4">) {</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">.</span><span class="s2">name </span><span class="s4">&amp;&amp; </span><span class="s2">attr</span><span class="s4">.</span><span class="s2">name </span><span class="s3">in </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">oids</span><span class="s4">) {</span>
        <span class="s2">attr</span><span class="s4">.</span><span class="s2">type </span><span class="s4">= </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">oids</span><span class="s4">[</span><span class="s2">attr</span><span class="s4">.</span><span class="s2">name</span><span class="s4">];</span>
      <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
        <span class="s3">var </span><span class="s2">error </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Attribute type not specified.'</span><span class="s4">);</span>
        <span class="s2">error</span><span class="s4">.</span><span class="s2">attribute </span><span class="s4">= </span><span class="s2">attr</span><span class="s4">;</span>
        <span class="s3">throw </span><span class="s2">error</span><span class="s4">;</span>
      <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s6">// populate missing shortname</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s3">typeof </span><span class="s2">attr</span><span class="s4">.</span><span class="s2">shortName </span><span class="s4">=== </span><span class="s5">'undefined'</span><span class="s4">) {</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">.</span><span class="s2">name </span><span class="s4">&amp;&amp; </span><span class="s2">attr</span><span class="s4">.</span><span class="s2">name </span><span class="s3">in </span><span class="s2">_shortNames</span><span class="s4">) {</span>
        <span class="s2">attr</span><span class="s4">.</span><span class="s2">shortName </span><span class="s4">= </span><span class="s2">_shortNames</span><span class="s4">[</span><span class="s2">attr</span><span class="s4">.</span><span class="s2">name</span><span class="s4">];</span>
      <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s6">// convert extensions to value</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">.</span><span class="s2">type </span><span class="s4">=== </span><span class="s2">oids</span><span class="s4">.</span><span class="s2">extensionRequest</span><span class="s4">) {</span>
      <span class="s2">attr</span><span class="s4">.</span><span class="s2">valueConstructed </span><span class="s4">= </span><span class="s3">true</span><span class="s4">;</span>
      <span class="s2">attr</span><span class="s4">.</span><span class="s2">valueTagClass </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">;</span>
      <span class="s3">if</span><span class="s4">(!</span><span class="s2">attr</span><span class="s4">.</span><span class="s2">value </span><span class="s4">&amp;&amp; </span><span class="s2">attr</span><span class="s4">.</span><span class="s2">extensions</span><span class="s4">) {</span>
        <span class="s2">attr</span><span class="s4">.</span><span class="s2">value </span><span class="s4">= [];</span>
        <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">ei </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">ei </span><span class="s4">&lt; </span><span class="s2">attr</span><span class="s4">.</span><span class="s2">extensions</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">ei</span><span class="s4">) {</span>
          <span class="s2">attr</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateExtensionToAsn1</span><span class="s4">(</span>
            <span class="s2">_fillMissingExtensionFields</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">.</span><span class="s2">extensions</span><span class="s4">[</span><span class="s2">ei</span><span class="s4">])));</span>
        <span class="s4">}</span>
      <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s3">if</span><span class="s4">(</span><span class="s3">typeof </span><span class="s2">attr</span><span class="s4">.</span><span class="s2">value </span><span class="s4">=== </span><span class="s5">'undefined'</span><span class="s4">) {</span>
      <span class="s3">var </span><span class="s2">error </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Attribute value not specified.'</span><span class="s4">);</span>
      <span class="s2">error</span><span class="s4">.</span><span class="s2">attribute </span><span class="s4">= </span><span class="s2">attr</span><span class="s4">;</span>
      <span class="s3">throw </span><span class="s2">error</span><span class="s4">;</span>
    <span class="s4">}</span>
  <span class="s4">}</span>
<span class="s4">}</span>

<span class="s0">/**</span>
 <span class="s0">* Fills in missing fields in certificate extensions.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">e the extension.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">[options] the options to use.</span>
 <span class="s0">*          [cert] the certificate the extensions are for.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the extension.</span>
 <span class="s0">*/</span>
<span class="s3">function </span><span class="s2">_fillMissingExtensionFields</span><span class="s4">(</span><span class="s2">e</span><span class="s4">, </span><span class="s2">options</span><span class="s4">) {</span>
  <span class="s2">options </span><span class="s4">= </span><span class="s2">options </span><span class="s4">|| {};</span>

  <span class="s6">// populate missing name</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s3">typeof </span><span class="s2">e</span><span class="s4">.</span><span class="s2">name </span><span class="s4">=== </span><span class="s5">'undefined'</span><span class="s4">) {</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">id </span><span class="s4">&amp;&amp; </span><span class="s2">e</span><span class="s4">.</span><span class="s2">id </span><span class="s3">in </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">oids</span><span class="s4">) {</span>
      <span class="s2">e</span><span class="s4">.</span><span class="s2">name </span><span class="s4">= </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">oids</span><span class="s4">[</span><span class="s2">e</span><span class="s4">.</span><span class="s2">id</span><span class="s4">];</span>
    <span class="s4">}</span>
  <span class="s4">}</span>

  <span class="s6">// populate missing id</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s3">typeof </span><span class="s2">e</span><span class="s4">.</span><span class="s2">id </span><span class="s4">=== </span><span class="s5">'undefined'</span><span class="s4">) {</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">name </span><span class="s4">&amp;&amp; </span><span class="s2">e</span><span class="s4">.</span><span class="s2">name </span><span class="s3">in </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">oids</span><span class="s4">) {</span>
      <span class="s2">e</span><span class="s4">.</span><span class="s2">id </span><span class="s4">= </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">oids</span><span class="s4">[</span><span class="s2">e</span><span class="s4">.</span><span class="s2">name</span><span class="s4">];</span>
    <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
      <span class="s3">var </span><span class="s2">error </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Extension ID not specified.'</span><span class="s4">);</span>
      <span class="s2">error</span><span class="s4">.</span><span class="s2">extension </span><span class="s4">= </span><span class="s2">e</span><span class="s4">;</span>
      <span class="s3">throw </span><span class="s2">error</span><span class="s4">;</span>
    <span class="s4">}</span>
  <span class="s4">}</span>

  <span class="s3">if</span><span class="s4">(</span><span class="s3">typeof </span><span class="s2">e</span><span class="s4">.</span><span class="s2">value </span><span class="s4">!== </span><span class="s5">'undefined'</span><span class="s4">) {</span>
    <span class="s3">return </span><span class="s2">e</span><span class="s4">;</span>
  <span class="s4">}</span>

  <span class="s6">// handle missing value:</span>

  <span class="s6">// value is a BIT STRING</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">name </span><span class="s4">=== </span><span class="s5">'keyUsage'</span><span class="s4">) {</span>
    <span class="s6">// build flags</span>
    <span class="s3">var </span><span class="s2">unused </span><span class="s4">= </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s3">var </span><span class="s2">b2 </span><span class="s4">= </span><span class="s7">0x00</span><span class="s4">;</span>
    <span class="s3">var </span><span class="s2">b3 </span><span class="s4">= </span><span class="s7">0x00</span><span class="s4">;</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">digitalSignature</span><span class="s4">) {</span>
      <span class="s2">b2 </span><span class="s4">|= </span><span class="s7">0x80</span><span class="s4">;</span>
      <span class="s2">unused </span><span class="s4">= </span><span class="s7">7</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">nonRepudiation</span><span class="s4">) {</span>
      <span class="s2">b2 </span><span class="s4">|= </span><span class="s7">0x40</span><span class="s4">;</span>
      <span class="s2">unused </span><span class="s4">= </span><span class="s7">6</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">keyEncipherment</span><span class="s4">) {</span>
      <span class="s2">b2 </span><span class="s4">|= </span><span class="s7">0x20</span><span class="s4">;</span>
      <span class="s2">unused </span><span class="s4">= </span><span class="s7">5</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">dataEncipherment</span><span class="s4">) {</span>
      <span class="s2">b2 </span><span class="s4">|= </span><span class="s7">0x10</span><span class="s4">;</span>
      <span class="s2">unused </span><span class="s4">= </span><span class="s7">4</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">keyAgreement</span><span class="s4">) {</span>
      <span class="s2">b2 </span><span class="s4">|= </span><span class="s7">0x08</span><span class="s4">;</span>
      <span class="s2">unused </span><span class="s4">= </span><span class="s7">3</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">keyCertSign</span><span class="s4">) {</span>
      <span class="s2">b2 </span><span class="s4">|= </span><span class="s7">0x04</span><span class="s4">;</span>
      <span class="s2">unused </span><span class="s4">= </span><span class="s7">2</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">cRLSign</span><span class="s4">) {</span>
      <span class="s2">b2 </span><span class="s4">|= </span><span class="s7">0x02</span><span class="s4">;</span>
      <span class="s2">unused </span><span class="s4">= </span><span class="s7">1</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">encipherOnly</span><span class="s4">) {</span>
      <span class="s2">b2 </span><span class="s4">|= </span><span class="s7">0x01</span><span class="s4">;</span>
      <span class="s2">unused </span><span class="s4">= </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">decipherOnly</span><span class="s4">) {</span>
      <span class="s2">b3 </span><span class="s4">|= </span><span class="s7">0x80</span><span class="s4">;</span>
      <span class="s2">unused </span><span class="s4">= </span><span class="s7">7</span><span class="s4">;</span>
    <span class="s4">}</span>

    <span class="s6">// create bit string</span>
    <span class="s3">var </span><span class="s2">value </span><span class="s4">= </span><span class="s2">String</span><span class="s4">.</span><span class="s2">fromCharCode</span><span class="s4">(</span><span class="s2">unused</span><span class="s4">);</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">b3 </span><span class="s4">!== </span><span class="s7">0</span><span class="s4">) {</span>
      <span class="s2">value </span><span class="s4">+= </span><span class="s2">String</span><span class="s4">.</span><span class="s2">fromCharCode</span><span class="s4">(</span><span class="s2">b2</span><span class="s4">) + </span><span class="s2">String</span><span class="s4">.</span><span class="s2">fromCharCode</span><span class="s4">(</span><span class="s2">b3</span><span class="s4">);</span>
    <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">b2 </span><span class="s4">!== </span><span class="s7">0</span><span class="s4">) {</span>
      <span class="s2">value </span><span class="s4">+= </span><span class="s2">String</span><span class="s4">.</span><span class="s2">fromCharCode</span><span class="s4">(</span><span class="s2">b2</span><span class="s4">);</span>
    <span class="s4">}</span>
    <span class="s2">e</span><span class="s4">.</span><span class="s2">value </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span>
      <span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">BITSTRING</span><span class="s4">, </span><span class="s3">false</span><span class="s4">, </span><span class="s2">value</span><span class="s4">);</span>
  <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">name </span><span class="s4">=== </span><span class="s5">'basicConstraints'</span><span class="s4">) {</span>
    <span class="s6">// basicConstraints is a SEQUENCE</span>
    <span class="s2">e</span><span class="s4">.</span><span class="s2">value </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span>
      <span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, []);</span>
    <span class="s6">// cA BOOLEAN flag defaults to false</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">cA</span><span class="s4">) {</span>
      <span class="s2">e</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span>
        <span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">BOOLEAN</span><span class="s4">, </span><span class="s3">false</span><span class="s4">,</span>
        <span class="s2">String</span><span class="s4">.</span><span class="s2">fromCharCode</span><span class="s4">(</span><span class="s7">0xFF</span><span class="s4">)));</span>
    <span class="s4">}</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s5">'pathLenConstraint' </span><span class="s3">in </span><span class="s2">e</span><span class="s4">) {</span>
      <span class="s2">e</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span>
        <span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">INTEGER</span><span class="s4">, </span><span class="s3">false</span><span class="s4">,</span>
        <span class="s2">asn1</span><span class="s4">.</span><span class="s2">integerToDer</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">pathLenConstraint</span><span class="s4">).</span><span class="s2">getBytes</span><span class="s4">()));</span>
    <span class="s4">}</span>
  <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">name </span><span class="s4">=== </span><span class="s5">'extKeyUsage'</span><span class="s4">) {</span>
    <span class="s6">// extKeyUsage is a SEQUENCE of OIDs</span>
    <span class="s2">e</span><span class="s4">.</span><span class="s2">value </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span>
      <span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, []);</span>
    <span class="s3">var </span><span class="s2">seq </span><span class="s4">= </span><span class="s2">e</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">value</span><span class="s4">;</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">key </span><span class="s3">in </span><span class="s2">e</span><span class="s4">) {</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">[</span><span class="s2">key</span><span class="s4">] !== </span><span class="s3">true</span><span class="s4">) {</span>
        <span class="s3">continue</span><span class="s4">;</span>
      <span class="s4">}</span>
      <span class="s6">// key is name in OID map</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">key </span><span class="s3">in </span><span class="s2">oids</span><span class="s4">) {</span>
        <span class="s2">seq</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">OID</span><span class="s4">,</span>
          <span class="s3">false</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">oidToDer</span><span class="s4">(</span><span class="s2">oids</span><span class="s4">[</span><span class="s2">key</span><span class="s4">]).</span><span class="s2">getBytes</span><span class="s4">()));</span>
      <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">key</span><span class="s4">.</span><span class="s2">indexOf</span><span class="s4">(</span><span class="s5">'.'</span><span class="s4">) !== -</span><span class="s7">1</span><span class="s4">) {</span>
        <span class="s6">// assume key is an OID</span>
        <span class="s2">seq</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">OID</span><span class="s4">,</span>
          <span class="s3">false</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">oidToDer</span><span class="s4">(</span><span class="s2">key</span><span class="s4">).</span><span class="s2">getBytes</span><span class="s4">()));</span>
      <span class="s4">}</span>
    <span class="s4">}</span>
  <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">name </span><span class="s4">=== </span><span class="s5">'nsCertType'</span><span class="s4">) {</span>
    <span class="s6">// nsCertType is a BIT STRING</span>
    <span class="s6">// build flags</span>
    <span class="s3">var </span><span class="s2">unused </span><span class="s4">= </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s3">var </span><span class="s2">b2 </span><span class="s4">= </span><span class="s7">0x00</span><span class="s4">;</span>

    <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">client</span><span class="s4">) {</span>
      <span class="s2">b2 </span><span class="s4">|= </span><span class="s7">0x80</span><span class="s4">;</span>
      <span class="s2">unused </span><span class="s4">= </span><span class="s7">7</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">server</span><span class="s4">) {</span>
      <span class="s2">b2 </span><span class="s4">|= </span><span class="s7">0x40</span><span class="s4">;</span>
      <span class="s2">unused </span><span class="s4">= </span><span class="s7">6</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">email</span><span class="s4">) {</span>
      <span class="s2">b2 </span><span class="s4">|= </span><span class="s7">0x20</span><span class="s4">;</span>
      <span class="s2">unused </span><span class="s4">= </span><span class="s7">5</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">objsign</span><span class="s4">) {</span>
      <span class="s2">b2 </span><span class="s4">|= </span><span class="s7">0x10</span><span class="s4">;</span>
      <span class="s2">unused </span><span class="s4">= </span><span class="s7">4</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">reserved</span><span class="s4">) {</span>
      <span class="s2">b2 </span><span class="s4">|= </span><span class="s7">0x08</span><span class="s4">;</span>
      <span class="s2">unused </span><span class="s4">= </span><span class="s7">3</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">sslCA</span><span class="s4">) {</span>
      <span class="s2">b2 </span><span class="s4">|= </span><span class="s7">0x04</span><span class="s4">;</span>
      <span class="s2">unused </span><span class="s4">= </span><span class="s7">2</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">emailCA</span><span class="s4">) {</span>
      <span class="s2">b2 </span><span class="s4">|= </span><span class="s7">0x02</span><span class="s4">;</span>
      <span class="s2">unused </span><span class="s4">= </span><span class="s7">1</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">objCA</span><span class="s4">) {</span>
      <span class="s2">b2 </span><span class="s4">|= </span><span class="s7">0x01</span><span class="s4">;</span>
      <span class="s2">unused </span><span class="s4">= </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s4">}</span>

    <span class="s6">// create bit string</span>
    <span class="s3">var </span><span class="s2">value </span><span class="s4">= </span><span class="s2">String</span><span class="s4">.</span><span class="s2">fromCharCode</span><span class="s4">(</span><span class="s2">unused</span><span class="s4">);</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">b2 </span><span class="s4">!== </span><span class="s7">0</span><span class="s4">) {</span>
      <span class="s2">value </span><span class="s4">+= </span><span class="s2">String</span><span class="s4">.</span><span class="s2">fromCharCode</span><span class="s4">(</span><span class="s2">b2</span><span class="s4">);</span>
    <span class="s4">}</span>
    <span class="s2">e</span><span class="s4">.</span><span class="s2">value </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span>
      <span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">BITSTRING</span><span class="s4">, </span><span class="s3">false</span><span class="s4">, </span><span class="s2">value</span><span class="s4">);</span>
  <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">name </span><span class="s4">=== </span><span class="s5">'subjectAltName' </span><span class="s4">|| </span><span class="s2">e</span><span class="s4">.</span><span class="s2">name </span><span class="s4">=== </span><span class="s5">'issuerAltName'</span><span class="s4">) {</span>
    <span class="s6">// SYNTAX SEQUENCE</span>
    <span class="s2">e</span><span class="s4">.</span><span class="s2">value </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, []);</span>

    <span class="s3">var </span><span class="s2">altName</span><span class="s4">;</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">n </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">n </span><span class="s4">&lt; </span><span class="s2">e</span><span class="s4">.</span><span class="s2">altNames</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">n</span><span class="s4">) {</span>
      <span class="s2">altName </span><span class="s4">= </span><span class="s2">e</span><span class="s4">.</span><span class="s2">altNames</span><span class="s4">[</span><span class="s2">n</span><span class="s4">];</span>
      <span class="s3">var </span><span class="s2">value </span><span class="s4">= </span><span class="s2">altName</span><span class="s4">.</span><span class="s2">value</span><span class="s4">;</span>
      <span class="s6">// handle IP</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">altName</span><span class="s4">.</span><span class="s2">type </span><span class="s4">=== </span><span class="s7">7 </span><span class="s4">&amp;&amp; </span><span class="s2">altName</span><span class="s4">.</span><span class="s2">ip</span><span class="s4">) {</span>
        <span class="s2">value </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">bytesFromIP</span><span class="s4">(</span><span class="s2">altName</span><span class="s4">.</span><span class="s2">ip</span><span class="s4">);</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s2">value </span><span class="s4">=== </span><span class="s3">null</span><span class="s4">) {</span>
          <span class="s3">var </span><span class="s2">error </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Error</span><span class="s4">(</span>
            <span class="s5">'Extension &quot;ip&quot; value is not a valid IPv4 or IPv6 address.'</span><span class="s4">);</span>
          <span class="s2">error</span><span class="s4">.</span><span class="s2">extension </span><span class="s4">= </span><span class="s2">e</span><span class="s4">;</span>
          <span class="s3">throw </span><span class="s2">error</span><span class="s4">;</span>
        <span class="s4">}</span>
      <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">altName</span><span class="s4">.</span><span class="s2">type </span><span class="s4">=== </span><span class="s7">8</span><span class="s4">) {</span>
        <span class="s6">// handle OID</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s2">altName</span><span class="s4">.</span><span class="s2">oid</span><span class="s4">) {</span>
          <span class="s2">value </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">oidToDer</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">oidToDer</span><span class="s4">(</span><span class="s2">altName</span><span class="s4">.</span><span class="s2">oid</span><span class="s4">));</span>
        <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
          <span class="s6">// deprecated ... convert value to OID</span>
          <span class="s2">value </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">oidToDer</span><span class="s4">(</span><span class="s2">value</span><span class="s4">);</span>
        <span class="s4">}</span>
      <span class="s4">}</span>
      <span class="s2">e</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span>
        <span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">CONTEXT_SPECIFIC</span><span class="s4">, </span><span class="s2">altName</span><span class="s4">.</span><span class="s2">type</span><span class="s4">, </span><span class="s3">false</span><span class="s4">,</span>
        <span class="s2">value</span><span class="s4">));</span>
    <span class="s4">}</span>
  <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">name </span><span class="s4">=== </span><span class="s5">'nsComment' </span><span class="s4">&amp;&amp; </span><span class="s2">options</span><span class="s4">.</span><span class="s2">cert</span><span class="s4">) {</span>
    <span class="s6">// sanity check value is ASCII (req'd) and not too big</span>
    <span class="s3">if</span><span class="s4">(!(</span><span class="s8">/^[\x00-\x7F]*$/</span><span class="s4">.</span><span class="s2">test</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">comment</span><span class="s4">)) ||</span>
      <span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">comment</span><span class="s4">.</span><span class="s2">length </span><span class="s4">&lt; </span><span class="s7">1</span><span class="s4">) || (</span><span class="s2">e</span><span class="s4">.</span><span class="s2">comment</span><span class="s4">.</span><span class="s2">length </span><span class="s4">&gt; </span><span class="s7">128</span><span class="s4">)) {</span>
      <span class="s3">throw new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Invalid &quot;nsComment&quot; content.'</span><span class="s4">);</span>
    <span class="s4">}</span>
    <span class="s6">// IA5STRING opaque comment</span>
    <span class="s2">e</span><span class="s4">.</span><span class="s2">value </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span>
      <span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">IA5STRING</span><span class="s4">, </span><span class="s3">false</span><span class="s4">, </span><span class="s2">e</span><span class="s4">.</span><span class="s2">comment</span><span class="s4">);</span>
  <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">name </span><span class="s4">=== </span><span class="s5">'subjectKeyIdentifier' </span><span class="s4">&amp;&amp; </span><span class="s2">options</span><span class="s4">.</span><span class="s2">cert</span><span class="s4">) {</span>
    <span class="s3">var </span><span class="s2">ski </span><span class="s4">= </span><span class="s2">options</span><span class="s4">.</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">generateSubjectKeyIdentifier</span><span class="s4">();</span>
    <span class="s2">e</span><span class="s4">.</span><span class="s2">subjectKeyIdentifier </span><span class="s4">= </span><span class="s2">ski</span><span class="s4">.</span><span class="s2">toHex</span><span class="s4">();</span>
    <span class="s6">// OCTETSTRING w/digest</span>
    <span class="s2">e</span><span class="s4">.</span><span class="s2">value </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span>
      <span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">OCTETSTRING</span><span class="s4">, </span><span class="s3">false</span><span class="s4">, </span><span class="s2">ski</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">());</span>
  <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">name </span><span class="s4">=== </span><span class="s5">'authorityKeyIdentifier' </span><span class="s4">&amp;&amp; </span><span class="s2">options</span><span class="s4">.</span><span class="s2">cert</span><span class="s4">) {</span>
    <span class="s6">// SYNTAX SEQUENCE</span>
    <span class="s2">e</span><span class="s4">.</span><span class="s2">value </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, []);</span>
    <span class="s3">var </span><span class="s2">seq </span><span class="s4">= </span><span class="s2">e</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">value</span><span class="s4">;</span>

    <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">keyIdentifier</span><span class="s4">) {</span>
      <span class="s3">var </span><span class="s2">keyIdentifier </span><span class="s4">= (</span><span class="s2">e</span><span class="s4">.</span><span class="s2">keyIdentifier </span><span class="s4">=== </span><span class="s3">true </span><span class="s4">?</span>
        <span class="s2">options</span><span class="s4">.</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">generateSubjectKeyIdentifier</span><span class="s4">().</span><span class="s2">getBytes</span><span class="s4">() :</span>
        <span class="s2">e</span><span class="s4">.</span><span class="s2">keyIdentifier</span><span class="s4">);</span>
      <span class="s2">seq</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span>
        <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">CONTEXT_SPECIFIC</span><span class="s4">, </span><span class="s7">0</span><span class="s4">, </span><span class="s3">false</span><span class="s4">, </span><span class="s2">keyIdentifier</span><span class="s4">));</span>
    <span class="s4">}</span>

    <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">authorityCertIssuer</span><span class="s4">) {</span>
      <span class="s3">var </span><span class="s2">authorityCertIssuer </span><span class="s4">= [</span>
        <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">CONTEXT_SPECIFIC</span><span class="s4">, </span><span class="s7">4</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, [</span>
          <span class="s2">_dnToAsn1</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">authorityCertIssuer </span><span class="s4">=== </span><span class="s3">true </span><span class="s4">?</span>
            <span class="s2">options</span><span class="s4">.</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">issuer </span><span class="s4">: </span><span class="s2">e</span><span class="s4">.</span><span class="s2">authorityCertIssuer</span><span class="s4">)</span>
        <span class="s4">])</span>
      <span class="s4">];</span>
      <span class="s2">seq</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span>
        <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">CONTEXT_SPECIFIC</span><span class="s4">, </span><span class="s7">1</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, </span><span class="s2">authorityCertIssuer</span><span class="s4">));</span>
    <span class="s4">}</span>

    <span class="s3">if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">serialNumber</span><span class="s4">) {</span>
      <span class="s3">var </span><span class="s2">serialNumber </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">hexToBytes</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">serialNumber </span><span class="s4">=== </span><span class="s3">true </span><span class="s4">?</span>
        <span class="s2">options</span><span class="s4">.</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">serialNumber </span><span class="s4">: </span><span class="s2">e</span><span class="s4">.</span><span class="s2">serialNumber</span><span class="s4">);</span>
      <span class="s2">seq</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span>
        <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">CONTEXT_SPECIFIC</span><span class="s4">, </span><span class="s7">2</span><span class="s4">, </span><span class="s3">false</span><span class="s4">, </span><span class="s2">serialNumber</span><span class="s4">));</span>
    <span class="s4">}</span>
  <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">e</span><span class="s4">.</span><span class="s2">name </span><span class="s4">=== </span><span class="s5">'cRLDistributionPoints'</span><span class="s4">) {</span>
    <span class="s2">e</span><span class="s4">.</span><span class="s2">value </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, []);</span>
    <span class="s3">var </span><span class="s2">seq </span><span class="s4">= </span><span class="s2">e</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">value</span><span class="s4">;</span>

    <span class="s6">// Create sub SEQUENCE of DistributionPointName</span>
    <span class="s3">var </span><span class="s2">subSeq </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span>
      <span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, []);</span>

    <span class="s6">// Create fullName CHOICE</span>
    <span class="s3">var </span><span class="s2">fullNameGeneralNames </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span>
      <span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">CONTEXT_SPECIFIC</span><span class="s4">, </span><span class="s7">0</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, []);</span>
    <span class="s3">var </span><span class="s2">altName</span><span class="s4">;</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">n </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">n </span><span class="s4">&lt; </span><span class="s2">e</span><span class="s4">.</span><span class="s2">altNames</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">n</span><span class="s4">) {</span>
      <span class="s2">altName </span><span class="s4">= </span><span class="s2">e</span><span class="s4">.</span><span class="s2">altNames</span><span class="s4">[</span><span class="s2">n</span><span class="s4">];</span>
      <span class="s3">var </span><span class="s2">value </span><span class="s4">= </span><span class="s2">altName</span><span class="s4">.</span><span class="s2">value</span><span class="s4">;</span>
      <span class="s6">// handle IP</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">altName</span><span class="s4">.</span><span class="s2">type </span><span class="s4">=== </span><span class="s7">7 </span><span class="s4">&amp;&amp; </span><span class="s2">altName</span><span class="s4">.</span><span class="s2">ip</span><span class="s4">) {</span>
        <span class="s2">value </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">bytesFromIP</span><span class="s4">(</span><span class="s2">altName</span><span class="s4">.</span><span class="s2">ip</span><span class="s4">);</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s2">value </span><span class="s4">=== </span><span class="s3">null</span><span class="s4">) {</span>
          <span class="s3">var </span><span class="s2">error </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Error</span><span class="s4">(</span>
            <span class="s5">'Extension &quot;ip&quot; value is not a valid IPv4 or IPv6 address.'</span><span class="s4">);</span>
          <span class="s2">error</span><span class="s4">.</span><span class="s2">extension </span><span class="s4">= </span><span class="s2">e</span><span class="s4">;</span>
          <span class="s3">throw </span><span class="s2">error</span><span class="s4">;</span>
        <span class="s4">}</span>
      <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">altName</span><span class="s4">.</span><span class="s2">type </span><span class="s4">=== </span><span class="s7">8</span><span class="s4">) {</span>
        <span class="s6">// handle OID</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s2">altName</span><span class="s4">.</span><span class="s2">oid</span><span class="s4">) {</span>
          <span class="s2">value </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">oidToDer</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">oidToDer</span><span class="s4">(</span><span class="s2">altName</span><span class="s4">.</span><span class="s2">oid</span><span class="s4">));</span>
        <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
          <span class="s6">// deprecated ... convert value to OID</span>
          <span class="s2">value </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">oidToDer</span><span class="s4">(</span><span class="s2">value</span><span class="s4">);</span>
        <span class="s4">}</span>
      <span class="s4">}</span>
      <span class="s2">fullNameGeneralNames</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span>
        <span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">CONTEXT_SPECIFIC</span><span class="s4">, </span><span class="s2">altName</span><span class="s4">.</span><span class="s2">type</span><span class="s4">, </span><span class="s3">false</span><span class="s4">,</span>
        <span class="s2">value</span><span class="s4">));</span>
    <span class="s4">}</span>

    <span class="s6">// Add to the parent SEQUENCE</span>
    <span class="s2">subSeq</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span>
      <span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">CONTEXT_SPECIFIC</span><span class="s4">, </span><span class="s7">0</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, [</span><span class="s2">fullNameGeneralNames</span><span class="s4">]));</span>
    <span class="s2">seq</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">subSeq</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s6">// ensure value has been defined by now</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s3">typeof </span><span class="s2">e</span><span class="s4">.</span><span class="s2">value </span><span class="s4">=== </span><span class="s5">'undefined'</span><span class="s4">) {</span>
    <span class="s3">var </span><span class="s2">error </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Extension value not specified.'</span><span class="s4">);</span>
    <span class="s2">error</span><span class="s4">.</span><span class="s2">extension </span><span class="s4">= </span><span class="s2">e</span><span class="s4">;</span>
    <span class="s3">throw </span><span class="s2">error</span><span class="s4">;</span>
  <span class="s4">}</span>

  <span class="s3">return </span><span class="s2">e</span><span class="s4">;</span>
<span class="s4">}</span>

<span class="s0">/**</span>
 <span class="s0">* Convert signature parameters object to ASN.1</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">{String} oid Signature algorithm OID</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">params The signature parametrs object</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">ASN.1 object representing signature parameters</span>
 <span class="s0">*/</span>
<span class="s3">function </span><span class="s2">_signatureParametersToAsn1</span><span class="s4">(</span><span class="s2">oid</span><span class="s4">, </span><span class="s2">params</span><span class="s4">) {</span>
  <span class="s3">switch</span><span class="s4">(</span><span class="s2">oid</span><span class="s4">) {</span>
    <span class="s3">case </span><span class="s2">oids</span><span class="s4">[</span><span class="s5">'RSASSA-PSS'</span><span class="s4">]:</span>
      <span class="s3">var </span><span class="s2">parts </span><span class="s4">= [];</span>

      <span class="s3">if</span><span class="s4">(</span><span class="s2">params</span><span class="s4">.</span><span class="s2">hash</span><span class="s4">.</span><span class="s2">algorithmOid </span><span class="s4">!== </span><span class="s2">undefined</span><span class="s4">) {</span>
        <span class="s2">parts</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">CONTEXT_SPECIFIC</span><span class="s4">, </span><span class="s7">0</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, [</span>
          <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, [</span>
            <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">OID</span><span class="s4">, </span><span class="s3">false</span><span class="s4">,</span>
              <span class="s2">asn1</span><span class="s4">.</span><span class="s2">oidToDer</span><span class="s4">(</span><span class="s2">params</span><span class="s4">.</span><span class="s2">hash</span><span class="s4">.</span><span class="s2">algorithmOid</span><span class="s4">).</span><span class="s2">getBytes</span><span class="s4">()),</span>
            <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">NULL</span><span class="s4">, </span><span class="s3">false</span><span class="s4">, </span><span class="s5">''</span><span class="s4">)</span>
          <span class="s4">])</span>
        <span class="s4">]));</span>
      <span class="s4">}</span>

      <span class="s3">if</span><span class="s4">(</span><span class="s2">params</span><span class="s4">.</span><span class="s2">mgf</span><span class="s4">.</span><span class="s2">algorithmOid </span><span class="s4">!== </span><span class="s2">undefined</span><span class="s4">) {</span>
        <span class="s2">parts</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">CONTEXT_SPECIFIC</span><span class="s4">, </span><span class="s7">1</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, [</span>
          <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, [</span>
            <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">OID</span><span class="s4">, </span><span class="s3">false</span><span class="s4">,</span>
              <span class="s2">asn1</span><span class="s4">.</span><span class="s2">oidToDer</span><span class="s4">(</span><span class="s2">params</span><span class="s4">.</span><span class="s2">mgf</span><span class="s4">.</span><span class="s2">algorithmOid</span><span class="s4">).</span><span class="s2">getBytes</span><span class="s4">()),</span>
            <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, [</span>
              <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">OID</span><span class="s4">, </span><span class="s3">false</span><span class="s4">,</span>
                <span class="s2">asn1</span><span class="s4">.</span><span class="s2">oidToDer</span><span class="s4">(</span><span class="s2">params</span><span class="s4">.</span><span class="s2">mgf</span><span class="s4">.</span><span class="s2">hash</span><span class="s4">.</span><span class="s2">algorithmOid</span><span class="s4">).</span><span class="s2">getBytes</span><span class="s4">()),</span>
              <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">NULL</span><span class="s4">, </span><span class="s3">false</span><span class="s4">, </span><span class="s5">''</span><span class="s4">)</span>
            <span class="s4">])</span>
          <span class="s4">])</span>
        <span class="s4">]));</span>
      <span class="s4">}</span>

      <span class="s3">if</span><span class="s4">(</span><span class="s2">params</span><span class="s4">.</span><span class="s2">saltLength </span><span class="s4">!== </span><span class="s2">undefined</span><span class="s4">) {</span>
        <span class="s2">parts</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">CONTEXT_SPECIFIC</span><span class="s4">, </span><span class="s7">2</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, [</span>
          <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">INTEGER</span><span class="s4">, </span><span class="s3">false</span><span class="s4">,</span>
            <span class="s2">asn1</span><span class="s4">.</span><span class="s2">integerToDer</span><span class="s4">(</span><span class="s2">params</span><span class="s4">.</span><span class="s2">saltLength</span><span class="s4">).</span><span class="s2">getBytes</span><span class="s4">())</span>
        <span class="s4">]));</span>
      <span class="s4">}</span>

      <span class="s3">return </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, </span><span class="s2">parts</span><span class="s4">);</span>

    <span class="s3">default</span><span class="s4">:</span>
      <span class="s3">return </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">NULL</span><span class="s4">, </span><span class="s3">false</span><span class="s4">, </span><span class="s5">''</span><span class="s4">);</span>
  <span class="s4">}</span>
<span class="s4">}</span>

<span class="s0">/**</span>
 <span class="s0">* Converts a certification request's attributes to an ASN.1 set of</span>
 <span class="s0">* CRIAttributes.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">csr certification request.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the ASN.1 set of CRIAttributes.</span>
 <span class="s0">*/</span>
<span class="s3">function </span><span class="s2">_CRIAttributesToAsn1</span><span class="s4">(</span><span class="s2">csr</span><span class="s4">) {</span>
  <span class="s6">// create an empty context-specific container</span>
  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">CONTEXT_SPECIFIC</span><span class="s4">, </span><span class="s7">0</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, []);</span>

  <span class="s6">// no attributes, return empty container</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">csr</span><span class="s4">.</span><span class="s2">attributes</span><span class="s4">.</span><span class="s2">length </span><span class="s4">=== </span><span class="s7">0</span><span class="s4">) {</span>
    <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
  <span class="s4">}</span>

  <span class="s6">// each attribute has a sequence with a type and a set of values</span>
  <span class="s3">var </span><span class="s2">attrs </span><span class="s4">= </span><span class="s2">csr</span><span class="s4">.</span><span class="s2">attributes</span><span class="s4">;</span>
  <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">attrs</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
    <span class="s3">var </span><span class="s2">attr </span><span class="s4">= </span><span class="s2">attrs</span><span class="s4">[</span><span class="s2">i</span><span class="s4">];</span>
    <span class="s3">var </span><span class="s2">value </span><span class="s4">= </span><span class="s2">attr</span><span class="s4">.</span><span class="s2">value</span><span class="s4">;</span>

    <span class="s6">// reuse tag class for attribute value if available</span>
    <span class="s3">var </span><span class="s2">valueTagClass </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">UTF8</span><span class="s4">;</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s5">'valueTagClass' </span><span class="s3">in </span><span class="s2">attr</span><span class="s4">) {</span>
      <span class="s2">valueTagClass </span><span class="s4">= </span><span class="s2">attr</span><span class="s4">.</span><span class="s2">valueTagClass</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">valueTagClass </span><span class="s4">=== </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">UTF8</span><span class="s4">) {</span>
      <span class="s2">value </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">encodeUtf8</span><span class="s4">(</span><span class="s2">value</span><span class="s4">);</span>
    <span class="s4">}</span>
    <span class="s3">var </span><span class="s2">valueConstructed </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s5">'valueConstructed' </span><span class="s3">in </span><span class="s2">attr</span><span class="s4">) {</span>
      <span class="s2">valueConstructed </span><span class="s4">= </span><span class="s2">attr</span><span class="s4">.</span><span class="s2">valueConstructed</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s6">// FIXME: handle more encodings</span>

    <span class="s6">// create a RelativeDistinguishedName set</span>
    <span class="s6">// each value in the set is an AttributeTypeAndValue first</span>
    <span class="s6">// containing the type (an OID) and second the value</span>
    <span class="s3">var </span><span class="s2">seq </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, [</span>
      <span class="s6">// AttributeType</span>
      <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">OID</span><span class="s4">, </span><span class="s3">false</span><span class="s4">,</span>
        <span class="s2">asn1</span><span class="s4">.</span><span class="s2">oidToDer</span><span class="s4">(</span><span class="s2">attr</span><span class="s4">.</span><span class="s2">type</span><span class="s4">).</span><span class="s2">getBytes</span><span class="s4">()),</span>
      <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SET</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, [</span>
        <span class="s6">// AttributeValue</span>
        <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span>
          <span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">valueTagClass</span><span class="s4">, </span><span class="s2">valueConstructed</span><span class="s4">, </span><span class="s2">value</span><span class="s4">)</span>
      <span class="s4">])</span>
    <span class="s4">]);</span>
    <span class="s2">rval</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">seq</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">}</span>

<span class="s3">var </span><span class="s2">jan_1_1950 </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Date</span><span class="s4">(</span><span class="s5">'1950-01-01T00:00:00Z'</span><span class="s4">);</span>
<span class="s3">var </span><span class="s2">jan_1_2050 </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Date</span><span class="s4">(</span><span class="s5">'2050-01-01T00:00:00Z'</span><span class="s4">);</span>

<span class="s0">/**</span>
 <span class="s0">* Converts a Date object to ASN.1</span>
 <span class="s0">* Handles the different format before and after 1st January 2050</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">date date object.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the ASN.1 object representing the date.</span>
 <span class="s0">*/</span>
<span class="s3">function </span><span class="s2">_dateToAsn1</span><span class="s4">(</span><span class="s2">date</span><span class="s4">) {</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">date </span><span class="s4">&gt;= </span><span class="s2">jan_1_1950 </span><span class="s4">&amp;&amp; </span><span class="s2">date </span><span class="s4">&lt; </span><span class="s2">jan_1_2050</span><span class="s4">) {</span>
    <span class="s3">return </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span>
      <span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">UTCTIME</span><span class="s4">, </span><span class="s3">false</span><span class="s4">,</span>
      <span class="s2">asn1</span><span class="s4">.</span><span class="s2">dateToUtcTime</span><span class="s4">(</span><span class="s2">date</span><span class="s4">));</span>
  <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
    <span class="s3">return </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span>
      <span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">GENERALIZEDTIME</span><span class="s4">, </span><span class="s3">false</span><span class="s4">,</span>
      <span class="s2">asn1</span><span class="s4">.</span><span class="s2">dateToGeneralizedTime</span><span class="s4">(</span><span class="s2">date</span><span class="s4">));</span>
  <span class="s4">}</span>
<span class="s4">}</span>

<span class="s0">/**</span>
 <span class="s0">* Gets the ASN.1 TBSCertificate part of an X.509v3 certificate.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">cert the certificate.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the asn1 TBSCertificate.</span>
 <span class="s0">*/</span>
<span class="s2">pki</span><span class="s4">.</span><span class="s2">getTBSCertificate </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">) {</span>
  <span class="s6">// TBSCertificate</span>
  <span class="s3">var </span><span class="s2">notBefore </span><span class="s4">= </span><span class="s2">_dateToAsn1</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">validity</span><span class="s4">.</span><span class="s2">notBefore</span><span class="s4">);</span>
  <span class="s3">var </span><span class="s2">notAfter </span><span class="s4">= </span><span class="s2">_dateToAsn1</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">validity</span><span class="s4">.</span><span class="s2">notAfter</span><span class="s4">);</span>
  <span class="s3">var </span><span class="s2">tbs </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, [</span>
    <span class="s6">// version</span>
    <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">CONTEXT_SPECIFIC</span><span class="s4">, </span><span class="s7">0</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, [</span>
      <span class="s6">// integer</span>
      <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">INTEGER</span><span class="s4">, </span><span class="s3">false</span><span class="s4">,</span>
        <span class="s2">asn1</span><span class="s4">.</span><span class="s2">integerToDer</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">version</span><span class="s4">).</span><span class="s2">getBytes</span><span class="s4">())</span>
    <span class="s4">]),</span>
    <span class="s6">// serialNumber</span>
    <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">INTEGER</span><span class="s4">, </span><span class="s3">false</span><span class="s4">,</span>
      <span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">hexToBytes</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">serialNumber</span><span class="s4">)),</span>
    <span class="s6">// signature</span>
    <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, [</span>
      <span class="s6">// algorithm</span>
      <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">OID</span><span class="s4">, </span><span class="s3">false</span><span class="s4">,</span>
        <span class="s2">asn1</span><span class="s4">.</span><span class="s2">oidToDer</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">siginfo</span><span class="s4">.</span><span class="s2">algorithmOid</span><span class="s4">).</span><span class="s2">getBytes</span><span class="s4">()),</span>
      <span class="s6">// parameters</span>
      <span class="s2">_signatureParametersToAsn1</span><span class="s4">(</span>
        <span class="s2">cert</span><span class="s4">.</span><span class="s2">siginfo</span><span class="s4">.</span><span class="s2">algorithmOid</span><span class="s4">, </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">siginfo</span><span class="s4">.</span><span class="s2">parameters</span><span class="s4">)</span>
    <span class="s4">]),</span>
    <span class="s6">// issuer</span>
    <span class="s2">_dnToAsn1</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">issuer</span><span class="s4">),</span>
    <span class="s6">// validity</span>
    <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, [</span>
      <span class="s2">notBefore</span><span class="s4">,</span>
      <span class="s2">notAfter</span>
    <span class="s4">]),</span>
    <span class="s6">// subject</span>
    <span class="s2">_dnToAsn1</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">),</span>
    <span class="s6">// SubjectPublicKeyInfo</span>
    <span class="s2">pki</span><span class="s4">.</span><span class="s2">publicKeyToAsn1</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">publicKey</span><span class="s4">)</span>
  <span class="s4">]);</span>

  <span class="s3">if</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">issuer</span><span class="s4">.</span><span class="s2">uniqueId</span><span class="s4">) {</span>
    <span class="s6">// issuerUniqueID (optional)</span>
    <span class="s2">tbs</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span>
      <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">CONTEXT_SPECIFIC</span><span class="s4">, </span><span class="s7">1</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, [</span>
        <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">BITSTRING</span><span class="s4">, </span><span class="s3">false</span><span class="s4">,</span>
          <span class="s6">// TODO: support arbitrary bit length ids</span>
          <span class="s2">String</span><span class="s4">.</span><span class="s2">fromCharCode</span><span class="s4">(</span><span class="s7">0x00</span><span class="s4">) +</span>
          <span class="s2">cert</span><span class="s4">.</span><span class="s2">issuer</span><span class="s4">.</span><span class="s2">uniqueId</span>
        <span class="s4">)</span>
      <span class="s4">])</span>
    <span class="s4">);</span>
  <span class="s4">}</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">uniqueId</span><span class="s4">) {</span>
    <span class="s6">// subjectUniqueID (optional)</span>
    <span class="s2">tbs</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span>
      <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">CONTEXT_SPECIFIC</span><span class="s4">, </span><span class="s7">2</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, [</span>
        <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">BITSTRING</span><span class="s4">, </span><span class="s3">false</span><span class="s4">,</span>
          <span class="s6">// TODO: support arbitrary bit length ids</span>
          <span class="s2">String</span><span class="s4">.</span><span class="s2">fromCharCode</span><span class="s4">(</span><span class="s7">0x00</span><span class="s4">) +</span>
          <span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">uniqueId</span>
        <span class="s4">)</span>
      <span class="s4">])</span>
    <span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s3">if</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">extensions</span><span class="s4">.</span><span class="s2">length </span><span class="s4">&gt; </span><span class="s7">0</span><span class="s4">) {</span>
    <span class="s6">// extensions (optional)</span>
    <span class="s2">tbs</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateExtensionsToAsn1</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">extensions</span><span class="s4">));</span>
  <span class="s4">}</span>

  <span class="s3">return </span><span class="s2">tbs</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Gets the ASN.1 CertificationRequestInfo part of a</span>
 <span class="s0">* PKCS#10 CertificationRequest.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">csr the certification request.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the asn1 CertificationRequestInfo.</span>
 <span class="s0">*/</span>
<span class="s2">pki</span><span class="s4">.</span><span class="s2">getCertificationRequestInfo </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">csr</span><span class="s4">) {</span>
  <span class="s6">// CertificationRequestInfo</span>
  <span class="s3">var </span><span class="s2">cri </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, [</span>
    <span class="s6">// version</span>
    <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">INTEGER</span><span class="s4">, </span><span class="s3">false</span><span class="s4">,</span>
      <span class="s2">asn1</span><span class="s4">.</span><span class="s2">integerToDer</span><span class="s4">(</span><span class="s2">csr</span><span class="s4">.</span><span class="s2">version</span><span class="s4">).</span><span class="s2">getBytes</span><span class="s4">()),</span>
    <span class="s6">// subject</span>
    <span class="s2">_dnToAsn1</span><span class="s4">(</span><span class="s2">csr</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">),</span>
    <span class="s6">// SubjectPublicKeyInfo</span>
    <span class="s2">pki</span><span class="s4">.</span><span class="s2">publicKeyToAsn1</span><span class="s4">(</span><span class="s2">csr</span><span class="s4">.</span><span class="s2">publicKey</span><span class="s4">),</span>
    <span class="s6">// attributes</span>
    <span class="s2">_CRIAttributesToAsn1</span><span class="s4">(</span><span class="s2">csr</span><span class="s4">)</span>
  <span class="s4">]);</span>

  <span class="s3">return </span><span class="s2">cri</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Converts a DistinguishedName (subject or issuer) to an ASN.1 object.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">dn the DistinguishedName.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the asn1 representation of a DistinguishedName.</span>
 <span class="s0">*/</span>
<span class="s2">pki</span><span class="s4">.</span><span class="s2">distinguishedNameToAsn1 </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">dn</span><span class="s4">) {</span>
  <span class="s3">return </span><span class="s2">_dnToAsn1</span><span class="s4">(</span><span class="s2">dn</span><span class="s4">);</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Converts an X.509v3 RSA certificate to an ASN.1 object.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">cert the certificate.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the asn1 representation of an X.509v3 RSA certificate.</span>
 <span class="s0">*/</span>
<span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateToAsn1 </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">) {</span>
  <span class="s6">// prefer cached TBSCertificate over generating one</span>
  <span class="s3">var </span><span class="s2">tbsCertificate </span><span class="s4">= </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">tbsCertificate </span><span class="s4">|| </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">getTBSCertificate</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">);</span>

  <span class="s6">// Certificate</span>
  <span class="s3">return </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, [</span>
    <span class="s6">// TBSCertificate</span>
    <span class="s2">tbsCertificate</span><span class="s4">,</span>
    <span class="s6">// AlgorithmIdentifier (signature algorithm)</span>
    <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, [</span>
      <span class="s6">// algorithm</span>
      <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">OID</span><span class="s4">, </span><span class="s3">false</span><span class="s4">,</span>
        <span class="s2">asn1</span><span class="s4">.</span><span class="s2">oidToDer</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">signatureOid</span><span class="s4">).</span><span class="s2">getBytes</span><span class="s4">()),</span>
      <span class="s6">// parameters</span>
      <span class="s2">_signatureParametersToAsn1</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">signatureOid</span><span class="s4">, </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">signatureParameters</span><span class="s4">)</span>
    <span class="s4">]),</span>
    <span class="s6">// SignatureValue</span>
    <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">BITSTRING</span><span class="s4">, </span><span class="s3">false</span><span class="s4">,</span>
      <span class="s2">String</span><span class="s4">.</span><span class="s2">fromCharCode</span><span class="s4">(</span><span class="s7">0x00</span><span class="s4">) + </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">signature</span><span class="s4">)</span>
  <span class="s4">]);</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Converts X.509v3 certificate extensions to ASN.1.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">exts the extensions to convert.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the extensions in ASN.1 format.</span>
 <span class="s0">*/</span>
<span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateExtensionsToAsn1 </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">exts</span><span class="s4">) {</span>
  <span class="s6">// create top-level extension container</span>
  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">CONTEXT_SPECIFIC</span><span class="s4">, </span><span class="s7">3</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, []);</span>

  <span class="s6">// create extension sequence (stores a sequence for each extension)</span>
  <span class="s3">var </span><span class="s2">seq </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, []);</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">seq</span><span class="s4">);</span>

  <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">exts</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
    <span class="s2">seq</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateExtensionToAsn1</span><span class="s4">(</span><span class="s2">exts</span><span class="s4">[</span><span class="s2">i</span><span class="s4">]));</span>
  <span class="s4">}</span>

  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Converts a single certificate extension to ASN.1.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">ext the extension to convert.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the extension in ASN.1 format.</span>
 <span class="s0">*/</span>
<span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateExtensionToAsn1 </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">ext</span><span class="s4">) {</span>
  <span class="s6">// create a sequence for each extension</span>
  <span class="s3">var </span><span class="s2">extseq </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, []);</span>

  <span class="s6">// extnID (OID)</span>
  <span class="s2">extseq</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span>
    <span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">OID</span><span class="s4">, </span><span class="s3">false</span><span class="s4">,</span>
    <span class="s2">asn1</span><span class="s4">.</span><span class="s2">oidToDer</span><span class="s4">(</span><span class="s2">ext</span><span class="s4">.</span><span class="s2">id</span><span class="s4">).</span><span class="s2">getBytes</span><span class="s4">()));</span>

  <span class="s6">// critical defaults to false</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">ext</span><span class="s4">.</span><span class="s2">critical</span><span class="s4">) {</span>
    <span class="s6">// critical BOOLEAN DEFAULT FALSE</span>
    <span class="s2">extseq</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span>
      <span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">BOOLEAN</span><span class="s4">, </span><span class="s3">false</span><span class="s4">,</span>
      <span class="s2">String</span><span class="s4">.</span><span class="s2">fromCharCode</span><span class="s4">(</span><span class="s7">0xFF</span><span class="s4">)));</span>
  <span class="s4">}</span>

  <span class="s3">var </span><span class="s2">value </span><span class="s4">= </span><span class="s2">ext</span><span class="s4">.</span><span class="s2">value</span><span class="s4">;</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s3">typeof </span><span class="s2">ext</span><span class="s4">.</span><span class="s2">value </span><span class="s4">!== </span><span class="s5">'string'</span><span class="s4">) {</span>
    <span class="s6">// value is asn.1</span>
    <span class="s2">value </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">toDer</span><span class="s4">(</span><span class="s2">value</span><span class="s4">).</span><span class="s2">getBytes</span><span class="s4">();</span>
  <span class="s4">}</span>

  <span class="s6">// extnValue (OCTET STRING)</span>
  <span class="s2">extseq</span><span class="s4">.</span><span class="s2">value</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span>
    <span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">OCTETSTRING</span><span class="s4">, </span><span class="s3">false</span><span class="s4">, </span><span class="s2">value</span><span class="s4">));</span>

  <span class="s3">return </span><span class="s2">extseq</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Converts a PKCS#10 certification request to an ASN.1 object.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">csr the certification request.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the asn1 representation of a certification request.</span>
 <span class="s0">*/</span>
<span class="s2">pki</span><span class="s4">.</span><span class="s2">certificationRequestToAsn1 </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">csr</span><span class="s4">) {</span>
  <span class="s6">// prefer cached CertificationRequestInfo over generating one</span>
  <span class="s3">var </span><span class="s2">cri </span><span class="s4">= </span><span class="s2">csr</span><span class="s4">.</span><span class="s2">certificationRequestInfo </span><span class="s4">||</span>
    <span class="s2">pki</span><span class="s4">.</span><span class="s2">getCertificationRequestInfo</span><span class="s4">(</span><span class="s2">csr</span><span class="s4">);</span>

  <span class="s6">// Certificate</span>
  <span class="s3">return </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, [</span>
    <span class="s6">// CertificationRequestInfo</span>
    <span class="s2">cri</span><span class="s4">,</span>
    <span class="s6">// AlgorithmIdentifier (signature algorithm)</span>
    <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">SEQUENCE</span><span class="s4">, </span><span class="s3">true</span><span class="s4">, [</span>
      <span class="s6">// algorithm</span>
      <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">OID</span><span class="s4">, </span><span class="s3">false</span><span class="s4">,</span>
        <span class="s2">asn1</span><span class="s4">.</span><span class="s2">oidToDer</span><span class="s4">(</span><span class="s2">csr</span><span class="s4">.</span><span class="s2">signatureOid</span><span class="s4">).</span><span class="s2">getBytes</span><span class="s4">()),</span>
      <span class="s6">// parameters</span>
      <span class="s2">_signatureParametersToAsn1</span><span class="s4">(</span><span class="s2">csr</span><span class="s4">.</span><span class="s2">signatureOid</span><span class="s4">, </span><span class="s2">csr</span><span class="s4">.</span><span class="s2">signatureParameters</span><span class="s4">)</span>
    <span class="s4">]),</span>
    <span class="s6">// signature</span>
    <span class="s2">asn1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Class</span><span class="s4">.</span><span class="s2">UNIVERSAL</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">Type</span><span class="s4">.</span><span class="s2">BITSTRING</span><span class="s4">, </span><span class="s3">false</span><span class="s4">,</span>
      <span class="s2">String</span><span class="s4">.</span><span class="s2">fromCharCode</span><span class="s4">(</span><span class="s7">0x00</span><span class="s4">) + </span><span class="s2">csr</span><span class="s4">.</span><span class="s2">signature</span><span class="s4">)</span>
  <span class="s4">]);</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Creates a CA store.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">certs an optional array of certificate objects or PEM-formatted</span>
 <span class="s0">*          certificate strings to add to the CA store.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the CA store.</span>
 <span class="s0">*/</span>
<span class="s2">pki</span><span class="s4">.</span><span class="s2">createCaStore </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">certs</span><span class="s4">) {</span>
  <span class="s6">// create CA store</span>
  <span class="s3">var </span><span class="s2">caStore </span><span class="s4">= {</span>
    <span class="s6">// stored certificates</span>
    <span class="s2">certs</span><span class="s4">: {}</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Gets the certificate that issued the passed certificate or its</span>
   <span class="s0">* 'parent'.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">cert the certificate to get the parent for.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@return </span><span class="s0">the parent certificate or null if none was found.</span>
   <span class="s0">*/</span>
  <span class="s2">caStore</span><span class="s4">.</span><span class="s2">getIssuer </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">) {</span>
    <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s2">getBySubject</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">issuer</span><span class="s4">);</span>

    <span class="s6">// see if there are multiple matches</span>
    <span class="s6">/*if(forge.util.isArray(rval)) { 
      // TODO: resolve multiple matches by checking 
      // authorityKey/subjectKey/issuerUniqueID/other identifiers, etc. 
      // FIXME: or alternatively do authority key mapping 
      // if possible (X.509v1 certs can't work?) 
      throw new Error('Resolving multiple issuer matches not implemented yet.'); 
    }*/</span>

    <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Adds a trusted certificate to the store.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">cert the certificate to add as a trusted certificate (either a</span>
   <span class="s0">*          pki.certificate object or a PEM-formatted certificate).</span>
   <span class="s0">*/</span>
  <span class="s2">caStore</span><span class="s4">.</span><span class="s2">addCertificate </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">) {</span>
    <span class="s6">// convert from pem if necessary</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s3">typeof </span><span class="s2">cert </span><span class="s4">=== </span><span class="s5">'string'</span><span class="s4">) {</span>
      <span class="s2">cert </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateFromPem</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">);</span>
    <span class="s4">}</span>

    <span class="s2">ensureSubjectHasHash</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">);</span>

    <span class="s3">if</span><span class="s4">(!</span><span class="s2">caStore</span><span class="s4">.</span><span class="s2">hasCertificate</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">)) { </span><span class="s6">// avoid duplicate certificates in store</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">hash </span><span class="s3">in </span><span class="s2">caStore</span><span class="s4">.</span><span class="s2">certs</span><span class="s4">) {</span>
        <span class="s6">// subject hash already exists, append to array</span>
        <span class="s3">var </span><span class="s2">tmp </span><span class="s4">= </span><span class="s2">caStore</span><span class="s4">.</span><span class="s2">certs</span><span class="s4">[</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">hash</span><span class="s4">];</span>
        <span class="s3">if</span><span class="s4">(!</span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">isArray</span><span class="s4">(</span><span class="s2">tmp</span><span class="s4">)) {</span>
          <span class="s2">tmp </span><span class="s4">= [</span><span class="s2">tmp</span><span class="s4">];</span>
        <span class="s4">}</span>
        <span class="s2">tmp</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">);</span>
        <span class="s2">caStore</span><span class="s4">.</span><span class="s2">certs</span><span class="s4">[</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">hash</span><span class="s4">] = </span><span class="s2">tmp</span><span class="s4">;</span>
      <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
        <span class="s2">caStore</span><span class="s4">.</span><span class="s2">certs</span><span class="s4">[</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">hash</span><span class="s4">] = </span><span class="s2">cert</span><span class="s4">;</span>
      <span class="s4">}</span>
    <span class="s4">}</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Checks to see if the given certificate is in the store.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">cert the certificate to check (either a pki.certificate or a</span>
   <span class="s0">*          PEM-formatted certificate).</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@return </span><span class="s0">true if the certificate is in the store, false if not.</span>
   <span class="s0">*/</span>
  <span class="s2">caStore</span><span class="s4">.</span><span class="s2">hasCertificate </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">) {</span>
    <span class="s6">// convert from pem if necessary</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s3">typeof </span><span class="s2">cert </span><span class="s4">=== </span><span class="s5">'string'</span><span class="s4">) {</span>
      <span class="s2">cert </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateFromPem</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">);</span>
    <span class="s4">}</span>

    <span class="s3">var </span><span class="s2">match </span><span class="s4">= </span><span class="s2">getBySubject</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">);</span>
    <span class="s3">if</span><span class="s4">(!</span><span class="s2">match</span><span class="s4">) {</span>
      <span class="s3">return false</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s3">if</span><span class="s4">(!</span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">isArray</span><span class="s4">(</span><span class="s2">match</span><span class="s4">)) {</span>
      <span class="s2">match </span><span class="s4">= [</span><span class="s2">match</span><span class="s4">];</span>
    <span class="s4">}</span>
    <span class="s6">// compare DER-encoding of certificates</span>
    <span class="s3">var </span><span class="s2">der1 </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">toDer</span><span class="s4">(</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateToAsn1</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">)).</span><span class="s2">getBytes</span><span class="s4">();</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">match</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s3">var </span><span class="s2">der2 </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">toDer</span><span class="s4">(</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateToAsn1</span><span class="s4">(</span><span class="s2">match</span><span class="s4">[</span><span class="s2">i</span><span class="s4">])).</span><span class="s2">getBytes</span><span class="s4">();</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">der1 </span><span class="s4">=== </span><span class="s2">der2</span><span class="s4">) {</span>
        <span class="s3">return true</span><span class="s4">;</span>
      <span class="s4">}</span>
    <span class="s4">}</span>
    <span class="s3">return false</span><span class="s4">;</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Lists all of the certificates kept in the store.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@return </span><span class="s0">an array of all of the pki.certificate objects in the store.</span>
   <span class="s0">*/</span>
  <span class="s2">caStore</span><span class="s4">.</span><span class="s2">listAllCertificates </span><span class="s4">= </span><span class="s3">function</span><span class="s4">() {</span>
    <span class="s3">var </span><span class="s2">certList </span><span class="s4">= [];</span>

    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">hash </span><span class="s3">in </span><span class="s2">caStore</span><span class="s4">.</span><span class="s2">certs</span><span class="s4">) {</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">caStore</span><span class="s4">.</span><span class="s2">certs</span><span class="s4">.</span><span class="s2">hasOwnProperty</span><span class="s4">(</span><span class="s2">hash</span><span class="s4">)) {</span>
        <span class="s3">var </span><span class="s2">value </span><span class="s4">= </span><span class="s2">caStore</span><span class="s4">.</span><span class="s2">certs</span><span class="s4">[</span><span class="s2">hash</span><span class="s4">];</span>
        <span class="s3">if</span><span class="s4">(!</span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">isArray</span><span class="s4">(</span><span class="s2">value</span><span class="s4">)) {</span>
          <span class="s2">certList</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">value</span><span class="s4">);</span>
        <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
          <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">value</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
            <span class="s2">certList</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">value</span><span class="s4">[</span><span class="s2">i</span><span class="s4">]);</span>
          <span class="s4">}</span>
        <span class="s4">}</span>
      <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s3">return </span><span class="s2">certList</span><span class="s4">;</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Removes a certificate from the store.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">cert the certificate to remove (either a pki.certificate or a</span>
   <span class="s0">*          PEM-formatted certificate).</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@return </span><span class="s0">the certificate that was removed or null if the certificate</span>
   <span class="s0">*           wasn't in store.</span>
   <span class="s0">*/</span>
  <span class="s2">caStore</span><span class="s4">.</span><span class="s2">removeCertificate </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">) {</span>
    <span class="s3">var </span><span class="s2">result</span><span class="s4">;</span>

    <span class="s6">// convert from pem if necessary</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s3">typeof </span><span class="s2">cert </span><span class="s4">=== </span><span class="s5">'string'</span><span class="s4">) {</span>
      <span class="s2">cert </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateFromPem</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">);</span>
    <span class="s4">}</span>
    <span class="s2">ensureSubjectHasHash</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">);</span>
    <span class="s3">if</span><span class="s4">(!</span><span class="s2">caStore</span><span class="s4">.</span><span class="s2">hasCertificate</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">)) {</span>
      <span class="s3">return null</span><span class="s4">;</span>
    <span class="s4">}</span>

    <span class="s3">var </span><span class="s2">match </span><span class="s4">= </span><span class="s2">getBySubject</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">);</span>

    <span class="s3">if</span><span class="s4">(!</span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">isArray</span><span class="s4">(</span><span class="s2">match</span><span class="s4">)) {</span>
      <span class="s2">result </span><span class="s4">= </span><span class="s2">caStore</span><span class="s4">.</span><span class="s2">certs</span><span class="s4">[</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">hash</span><span class="s4">];</span>
      <span class="s3">delete </span><span class="s2">caStore</span><span class="s4">.</span><span class="s2">certs</span><span class="s4">[</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">hash</span><span class="s4">];</span>
      <span class="s3">return </span><span class="s2">result</span><span class="s4">;</span>
    <span class="s4">}</span>

    <span class="s6">// compare DER-encoding of certificates</span>
    <span class="s3">var </span><span class="s2">der1 </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">toDer</span><span class="s4">(</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateToAsn1</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">)).</span><span class="s2">getBytes</span><span class="s4">();</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">match</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s3">var </span><span class="s2">der2 </span><span class="s4">= </span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">toDer</span><span class="s4">(</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateToAsn1</span><span class="s4">(</span><span class="s2">match</span><span class="s4">[</span><span class="s2">i</span><span class="s4">])).</span><span class="s2">getBytes</span><span class="s4">();</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">der1 </span><span class="s4">=== </span><span class="s2">der2</span><span class="s4">) {</span>
        <span class="s2">result </span><span class="s4">= </span><span class="s2">match</span><span class="s4">[</span><span class="s2">i</span><span class="s4">];</span>
        <span class="s2">match</span><span class="s4">.</span><span class="s2">splice</span><span class="s4">(</span><span class="s2">i</span><span class="s4">, </span><span class="s7">1</span><span class="s4">);</span>
      <span class="s4">}</span>
    <span class="s4">}</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">match</span><span class="s4">.</span><span class="s2">length </span><span class="s4">=== </span><span class="s7">0</span><span class="s4">) {</span>
      <span class="s3">delete </span><span class="s2">caStore</span><span class="s4">.</span><span class="s2">certs</span><span class="s4">[</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">hash</span><span class="s4">];</span>
    <span class="s4">}</span>

    <span class="s3">return </span><span class="s2">result</span><span class="s4">;</span>
  <span class="s4">};</span>

  <span class="s3">function </span><span class="s2">getBySubject</span><span class="s4">(</span><span class="s2">subject</span><span class="s4">) {</span>
    <span class="s2">ensureSubjectHasHash</span><span class="s4">(</span><span class="s2">subject</span><span class="s4">);</span>
    <span class="s3">return </span><span class="s2">caStore</span><span class="s4">.</span><span class="s2">certs</span><span class="s4">[</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">hash</span><span class="s4">] || </span><span class="s3">null</span><span class="s4">;</span>
  <span class="s4">}</span>

  <span class="s3">function </span><span class="s2">ensureSubjectHasHash</span><span class="s4">(</span><span class="s2">subject</span><span class="s4">) {</span>
    <span class="s6">// produce subject hash if it doesn't exist</span>
    <span class="s3">if</span><span class="s4">(!</span><span class="s2">subject</span><span class="s4">.</span><span class="s2">hash</span><span class="s4">) {</span>
      <span class="s3">var </span><span class="s2">md </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">sha1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">();</span>
      <span class="s2">subject</span><span class="s4">.</span><span class="s2">attributes </span><span class="s4">= </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">RDNAttributesAsArray</span><span class="s4">(</span><span class="s2">_dnToAsn1</span><span class="s4">(</span><span class="s2">subject</span><span class="s4">), </span><span class="s2">md</span><span class="s4">);</span>
      <span class="s2">subject</span><span class="s4">.</span><span class="s2">hash </span><span class="s4">= </span><span class="s2">md</span><span class="s4">.</span><span class="s2">digest</span><span class="s4">().</span><span class="s2">toHex</span><span class="s4">();</span>
    <span class="s4">}</span>
  <span class="s4">}</span>

  <span class="s6">// auto-add passed in certs</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">certs</span><span class="s4">) {</span>
    <span class="s6">// parse PEM-formatted certificates as necessary</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">certs</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s3">var </span><span class="s2">cert </span><span class="s4">= </span><span class="s2">certs</span><span class="s4">[</span><span class="s2">i</span><span class="s4">];</span>
      <span class="s2">caStore</span><span class="s4">.</span><span class="s2">addCertificate</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">);</span>
    <span class="s4">}</span>
  <span class="s4">}</span>

  <span class="s3">return </span><span class="s2">caStore</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Certificate verification errors, based on TLS.</span>
 <span class="s0">*/</span>
<span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateError </span><span class="s4">= {</span>
  <span class="s2">bad_certificate</span><span class="s4">: </span><span class="s5">'forge.pki.BadCertificate'</span><span class="s4">,</span>
  <span class="s2">unsupported_certificate</span><span class="s4">: </span><span class="s5">'forge.pki.UnsupportedCertificate'</span><span class="s4">,</span>
  <span class="s2">certificate_revoked</span><span class="s4">: </span><span class="s5">'forge.pki.CertificateRevoked'</span><span class="s4">,</span>
  <span class="s2">certificate_expired</span><span class="s4">: </span><span class="s5">'forge.pki.CertificateExpired'</span><span class="s4">,</span>
  <span class="s2">certificate_unknown</span><span class="s4">: </span><span class="s5">'forge.pki.CertificateUnknown'</span><span class="s4">,</span>
  <span class="s2">unknown_ca</span><span class="s4">: </span><span class="s5">'forge.pki.UnknownCertificateAuthority'</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Verifies a certificate chain against the given Certificate Authority store</span>
 <span class="s0">* with an optional custom verify callback.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">caStore a certificate store to verify against.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">chain the certificate chain to verify, with the root or highest</span>
 <span class="s0">*          authority at the end (an array of certificates).</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">options a callback to be called for every certificate in the chain or</span>
 <span class="s0">*                  an object with:</span>
 <span class="s0">*                  verify a callback to be called for every certificate in the</span>
 <span class="s0">*                    chain</span>
 <span class="s0">*                  validityCheckDate the date against which the certificate</span>
 <span class="s0">*                    validity period should be checked. Pass null to not check</span>
 <span class="s0">*                    the validity period. By default, the current date is used.</span>
 <span class="s0">*</span>
 <span class="s0">* The verify callback has the following signature:</span>
 <span class="s0">*</span>
 <span class="s0">* verified - Set to true if certificate was verified, otherwise the</span>
 <span class="s0">*   pki.certificateError for why the certificate failed.</span>
 <span class="s0">* depth - The current index in the chain, where 0 is the end point's cert.</span>
 <span class="s0">* certs - The certificate chain, *NOTE* an empty chain indicates an anonymous</span>
 <span class="s0">*   end point.</span>
 <span class="s0">*</span>
 <span class="s0">* The function returns true on success and on failure either the appropriate</span>
 <span class="s0">* pki.certificateError or an object with 'error' set to the appropriate</span>
 <span class="s0">* pki.certificateError and 'message' set to a custom error message.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">true if successful, error thrown if not.</span>
 <span class="s0">*/</span>
<span class="s2">pki</span><span class="s4">.</span><span class="s2">verifyCertificateChain </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">caStore</span><span class="s4">, </span><span class="s2">chain</span><span class="s4">, </span><span class="s2">options</span><span class="s4">) {</span>
  <span class="s6">/* From: RFC3280 - Internet X.509 Public Key Infrastructure Certificate 
    Section 6: Certification Path Validation 
    See inline parentheticals related to this particular implementation. 
 
    The primary goal of path validation is to verify the binding between 
    a subject distinguished name or a subject alternative name and subject 
    public key, as represented in the end entity certificate, based on the 
    public key of the trust anchor. This requires obtaining a sequence of 
    certificates that support that binding. That sequence should be provided 
    in the passed 'chain'. The trust anchor should be in the given CA 
    store. The 'end entity' certificate is the certificate provided by the 
    end point (typically a server) and is the first in the chain. 
 
    To meet this goal, the path validation process verifies, among other 
    things, that a prospective certification path (a sequence of n 
    certificates or a 'chain') satisfies the following conditions: 
 
    (a) for all x in {1, ..., n-1}, the subject of certificate x is 
          the issuer of certificate x+1; 
 
    (b) certificate 1 is issued by the trust anchor; 
 
    (c) certificate n is the certificate to be validated; and 
 
    (d) for all x in {1, ..., n}, the certificate was valid at the 
          time in question. 
 
    Note that here 'n' is index 0 in the chain and 1 is the last certificate 
    in the chain and it must be signed by a certificate in the connection's 
    CA store. 
 
    The path validation process also determines the set of certificate 
    policies that are valid for this path, based on the certificate policies 
    extension, policy mapping extension, policy constraints extension, and 
    inhibit any-policy extension. 
 
    Note: Policy mapping extension not supported (Not Required). 
 
    Note: If the certificate has an unsupported critical extension, then it 
    must be rejected. 
 
    Note: A certificate is self-issued if the DNs that appear in the subject 
    and issuer fields are identical and are not empty. 
 
    The path validation algorithm assumes the following seven inputs are 
    provided to the path processing logic. What this specific implementation 
    will use is provided parenthetically: 
 
    (a) a prospective certification path of length n (the 'chain') 
    (b) the current date/time: ('now'). 
    (c) user-initial-policy-set: A set of certificate policy identifiers 
          naming the policies that are acceptable to the certificate user. 
          The user-initial-policy-set contains the special value any-policy 
          if the user is not concerned about certificate policy 
          (Not implemented. Any policy is accepted). 
    (d) trust anchor information, describing a CA that serves as a trust 
          anchor for the certification path. The trust anchor information 
          includes: 
 
      (1)  the trusted issuer name, 
      (2)  the trusted public key algorithm, 
      (3)  the trusted public key, and 
      (4)  optionally, the trusted public key parameters associated 
             with the public key. 
 
      (Trust anchors are provided via certificates in the CA store). 
 
      The trust anchor information may be provided to the path processing 
      procedure in the form of a self-signed certificate. The trusted anchor 
      information is trusted because it was delivered to the path processing 
      procedure by some trustworthy out-of-band procedure. If the trusted 
      public key algorithm requires parameters, then the parameters are 
      provided along with the trusted public key (No parameters used in this 
      implementation). 
 
    (e) initial-policy-mapping-inhibit, which indicates if policy mapping is 
          allowed in the certification path. 
          (Not implemented, no policy checking) 
 
    (f) initial-explicit-policy, which indicates if the path must be valid 
          for at least one of the certificate policies in the user-initial- 
          policy-set. 
          (Not implemented, no policy checking) 
 
    (g) initial-any-policy-inhibit, which indicates whether the 
          anyPolicy OID should be processed if it is included in a 
          certificate. 
          (Not implemented, so any policy is valid provided that it is 
          not marked as critical) */</span>

  <span class="s6">/* Basic Path Processing: 
 
    For each certificate in the 'chain', the following is checked: 
 
    1. The certificate validity period includes the current time. 
    2. The certificate was signed by its parent (where the parent is either 
       the next in the chain or from the CA store). Allow processing to 
       continue to the next step if no parent is found but the certificate is 
       in the CA store. 
    3. TODO: The certificate has not been revoked. 
    4. The certificate issuer name matches the parent's subject name. 
    5. TODO: If the certificate is self-issued and not the final certificate 
       in the chain, skip this step, otherwise verify that the subject name 
       is within one of the permitted subtrees of X.500 distinguished names 
       and that each of the alternative names in the subjectAltName extension 
       (critical or non-critical) is within one of the permitted subtrees for 
       that name type. 
    6. TODO: If the certificate is self-issued and not the final certificate 
       in the chain, skip this step, otherwise verify that the subject name 
       is not within one of the excluded subtrees for X.500 distinguished 
       names and none of the subjectAltName extension names are excluded for 
       that name type. 
    7. The other steps in the algorithm for basic path processing involve 
       handling the policy extension which is not presently supported in this 
       implementation. Instead, if a critical policy extension is found, the 
       certificate is rejected as not supported. 
    8. If the certificate is not the first or if its the only certificate in 
       the chain (having no parent from the CA store or is self-signed) and it 
       has a critical key usage extension, verify that the keyCertSign bit is 
       set. If the key usage extension exists, verify that the basic 
       constraints extension exists. If the basic constraints extension exists, 
       verify that the cA flag is set. If pathLenConstraint is set, ensure that 
       the number of certificates that precede in the chain (come earlier 
       in the chain as implemented below), excluding the very first in the 
       chain (typically the end-entity one), isn't greater than the 
       pathLenConstraint. This constraint limits the number of intermediate 
       CAs that may appear below a CA before only end-entity certificates 
       may be issued. */</span>

  <span class="s6">// if a verify callback is passed as the third parameter, package it within</span>
  <span class="s6">// the options object. This is to support a legacy function signature that</span>
  <span class="s6">// expected the verify callback as the third parameter.</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s3">typeof </span><span class="s2">options </span><span class="s4">=== </span><span class="s5">'function'</span><span class="s4">) {</span>
    <span class="s2">options </span><span class="s4">= {</span><span class="s2">verify</span><span class="s4">: </span><span class="s2">options</span><span class="s4">};</span>
  <span class="s4">}</span>
  <span class="s2">options </span><span class="s4">= </span><span class="s2">options </span><span class="s4">|| {};</span>

  <span class="s6">// copy cert chain references to another array to protect against changes</span>
  <span class="s6">// in verify callback</span>
  <span class="s2">chain </span><span class="s4">= </span><span class="s2">chain</span><span class="s4">.</span><span class="s2">slice</span><span class="s4">(</span><span class="s7">0</span><span class="s4">);</span>
  <span class="s3">var </span><span class="s2">certs </span><span class="s4">= </span><span class="s2">chain</span><span class="s4">.</span><span class="s2">slice</span><span class="s4">(</span><span class="s7">0</span><span class="s4">);</span>

  <span class="s3">var </span><span class="s2">validityCheckDate </span><span class="s4">= </span><span class="s2">options</span><span class="s4">.</span><span class="s2">validityCheckDate</span><span class="s4">;</span>
  <span class="s6">// if no validityCheckDate is specified, default to the current date. Make</span>
  <span class="s6">// sure to maintain the value null because it indicates that the validity</span>
  <span class="s6">// period should not be checked.</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s3">typeof </span><span class="s2">validityCheckDate </span><span class="s4">=== </span><span class="s5">'undefined'</span><span class="s4">) {</span>
    <span class="s2">validityCheckDate </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Date</span><span class="s4">();</span>
  <span class="s4">}</span>

  <span class="s6">// verify each cert in the chain using its parent, where the parent</span>
  <span class="s6">// is either the next in the chain or from the CA store</span>
  <span class="s3">var </span><span class="s2">first </span><span class="s4">= </span><span class="s3">true</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">error </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">depth </span><span class="s4">= </span><span class="s7">0</span><span class="s4">;</span>
  <span class="s3">do </span><span class="s4">{</span>
    <span class="s3">var </span><span class="s2">cert </span><span class="s4">= </span><span class="s2">chain</span><span class="s4">.</span><span class="s2">shift</span><span class="s4">();</span>
    <span class="s3">var </span><span class="s2">parent </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
    <span class="s3">var </span><span class="s2">selfSigned </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>

    <span class="s3">if</span><span class="s4">(</span><span class="s2">validityCheckDate</span><span class="s4">) {</span>
      <span class="s6">// 1. check valid time</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">validityCheckDate </span><span class="s4">&lt; </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">validity</span><span class="s4">.</span><span class="s2">notBefore </span><span class="s4">||</span>
         <span class="s2">validityCheckDate </span><span class="s4">&gt; </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">validity</span><span class="s4">.</span><span class="s2">notAfter</span><span class="s4">) {</span>
        <span class="s2">error </span><span class="s4">= {</span>
          <span class="s2">message</span><span class="s4">: </span><span class="s5">'Certificate is not valid yet or has expired.'</span><span class="s4">,</span>
          <span class="s2">error</span><span class="s4">: </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateError</span><span class="s4">.</span><span class="s2">certificate_expired</span><span class="s4">,</span>
          <span class="s2">notBefore</span><span class="s4">: </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">validity</span><span class="s4">.</span><span class="s2">notBefore</span><span class="s4">,</span>
          <span class="s2">notAfter</span><span class="s4">: </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">validity</span><span class="s4">.</span><span class="s2">notAfter</span><span class="s4">,</span>
          <span class="s6">// TODO: we might want to reconsider renaming 'now' to</span>
          <span class="s6">// 'validityCheckDate' should this API be changed in the future.</span>
          <span class="s2">now</span><span class="s4">: </span><span class="s2">validityCheckDate</span>
        <span class="s4">};</span>
      <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s6">// 2. verify with parent from chain or CA store</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">error </span><span class="s4">=== </span><span class="s3">null</span><span class="s4">) {</span>
      <span class="s2">parent </span><span class="s4">= </span><span class="s2">chain</span><span class="s4">[</span><span class="s7">0</span><span class="s4">] || </span><span class="s2">caStore</span><span class="s4">.</span><span class="s2">getIssuer</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">);</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">parent </span><span class="s4">=== </span><span class="s3">null</span><span class="s4">) {</span>
        <span class="s6">// check for self-signed cert</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">isIssuer</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">)) {</span>
          <span class="s2">selfSigned </span><span class="s4">= </span><span class="s3">true</span><span class="s4">;</span>
          <span class="s2">parent </span><span class="s4">= </span><span class="s2">cert</span><span class="s4">;</span>
        <span class="s4">}</span>
      <span class="s4">}</span>

      <span class="s3">if</span><span class="s4">(</span><span class="s2">parent</span><span class="s4">) {</span>
        <span class="s6">// FIXME: current CA store implementation might have multiple</span>
        <span class="s6">// certificates where the issuer can't be determined from the</span>
        <span class="s6">// certificate (happens rarely with, eg: old certificates) so normalize</span>
        <span class="s6">// by always putting parents into an array</span>
        <span class="s6">// TODO: there's may be an extreme degenerate case currently uncovered</span>
        <span class="s6">// where an old intermediate certificate seems to have a matching parent</span>
        <span class="s6">// but none of the parents actually verify ... but the intermediate</span>
        <span class="s6">// is in the CA and it should pass this check; needs investigation</span>
        <span class="s3">var </span><span class="s2">parents </span><span class="s4">= </span><span class="s2">parent</span><span class="s4">;</span>
        <span class="s3">if</span><span class="s4">(!</span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">isArray</span><span class="s4">(</span><span class="s2">parents</span><span class="s4">)) {</span>
          <span class="s2">parents </span><span class="s4">= [</span><span class="s2">parents</span><span class="s4">];</span>
        <span class="s4">}</span>

        <span class="s6">// try to verify with each possible parent (typically only one)</span>
        <span class="s3">var </span><span class="s2">verified </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>
        <span class="s3">while</span><span class="s4">(!</span><span class="s2">verified </span><span class="s4">&amp;&amp; </span><span class="s2">parents</span><span class="s4">.</span><span class="s2">length </span><span class="s4">&gt; </span><span class="s7">0</span><span class="s4">) {</span>
          <span class="s2">parent </span><span class="s4">= </span><span class="s2">parents</span><span class="s4">.</span><span class="s2">shift</span><span class="s4">();</span>
          <span class="s3">try </span><span class="s4">{</span>
            <span class="s2">verified </span><span class="s4">= </span><span class="s2">parent</span><span class="s4">.</span><span class="s2">verify</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">);</span>
          <span class="s4">} </span><span class="s3">catch</span><span class="s4">(</span><span class="s2">ex</span><span class="s4">) {</span>
            <span class="s6">// failure to verify, don't care why, try next one</span>
          <span class="s4">}</span>
        <span class="s4">}</span>

        <span class="s3">if</span><span class="s4">(!</span><span class="s2">verified</span><span class="s4">) {</span>
          <span class="s2">error </span><span class="s4">= {</span>
            <span class="s2">message</span><span class="s4">: </span><span class="s5">'Certificate signature is invalid.'</span><span class="s4">,</span>
            <span class="s2">error</span><span class="s4">: </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateError</span><span class="s4">.</span><span class="s2">bad_certificate</span>
          <span class="s4">};</span>
        <span class="s4">}</span>
      <span class="s4">}</span>

      <span class="s3">if</span><span class="s4">(</span><span class="s2">error </span><span class="s4">=== </span><span class="s3">null </span><span class="s4">&amp;&amp; (!</span><span class="s2">parent </span><span class="s4">|| </span><span class="s2">selfSigned</span><span class="s4">) &amp;&amp;</span>
        <span class="s4">!</span><span class="s2">caStore</span><span class="s4">.</span><span class="s2">hasCertificate</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">)) {</span>
        <span class="s6">// no parent issuer and certificate itself is not trusted</span>
        <span class="s2">error </span><span class="s4">= {</span>
          <span class="s2">message</span><span class="s4">: </span><span class="s5">'Certificate is not trusted.'</span><span class="s4">,</span>
          <span class="s2">error</span><span class="s4">: </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateError</span><span class="s4">.</span><span class="s2">unknown_ca</span>
        <span class="s4">};</span>
      <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s6">// TODO: 3. check revoked</span>

    <span class="s6">// 4. check for matching issuer/subject</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">error </span><span class="s4">=== </span><span class="s3">null </span><span class="s4">&amp;&amp; </span><span class="s2">parent </span><span class="s4">&amp;&amp; !</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">isIssuer</span><span class="s4">(</span><span class="s2">parent</span><span class="s4">)) {</span>
      <span class="s6">// parent is not issuer</span>
      <span class="s2">error </span><span class="s4">= {</span>
        <span class="s2">message</span><span class="s4">: </span><span class="s5">'Certificate issuer is invalid.'</span><span class="s4">,</span>
        <span class="s2">error</span><span class="s4">: </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateError</span><span class="s4">.</span><span class="s2">bad_certificate</span>
      <span class="s4">};</span>
    <span class="s4">}</span>

    <span class="s6">// 5. TODO: check names with permitted names tree</span>

    <span class="s6">// 6. TODO: check names against excluded names tree</span>

    <span class="s6">// 7. check for unsupported critical extensions</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">error </span><span class="s4">=== </span><span class="s3">null</span><span class="s4">) {</span>
      <span class="s6">// supported extensions</span>
      <span class="s3">var </span><span class="s2">se </span><span class="s4">= {</span>
        <span class="s2">keyUsage</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
        <span class="s2">basicConstraints</span><span class="s4">: </span><span class="s3">true</span>
      <span class="s4">};</span>
      <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">error </span><span class="s4">=== </span><span class="s3">null </span><span class="s4">&amp;&amp; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">extensions</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
        <span class="s3">var </span><span class="s2">ext </span><span class="s4">= </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">extensions</span><span class="s4">[</span><span class="s2">i</span><span class="s4">];</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s2">ext</span><span class="s4">.</span><span class="s2">critical </span><span class="s4">&amp;&amp; !(</span><span class="s2">ext</span><span class="s4">.</span><span class="s2">name </span><span class="s3">in </span><span class="s2">se</span><span class="s4">)) {</span>
          <span class="s2">error </span><span class="s4">= {</span>
            <span class="s2">message</span><span class="s4">:</span>
              <span class="s5">'Certificate has an unsupported critical extension.'</span><span class="s4">,</span>
            <span class="s2">error</span><span class="s4">: </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateError</span><span class="s4">.</span><span class="s2">unsupported_certificate</span>
          <span class="s4">};</span>
        <span class="s4">}</span>
      <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s6">// 8. check for CA if cert is not first or is the only certificate</span>
    <span class="s6">// remaining in chain with no parent or is self-signed</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">error </span><span class="s4">=== </span><span class="s3">null </span><span class="s4">&amp;&amp;</span>
      <span class="s4">(!</span><span class="s2">first </span><span class="s4">|| (</span><span class="s2">chain</span><span class="s4">.</span><span class="s2">length </span><span class="s4">=== </span><span class="s7">0 </span><span class="s4">&amp;&amp; (!</span><span class="s2">parent </span><span class="s4">|| </span><span class="s2">selfSigned</span><span class="s4">)))) {</span>
      <span class="s6">// first check keyUsage extension and then basic constraints</span>
      <span class="s3">var </span><span class="s2">bcExt </span><span class="s4">= </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">getExtension</span><span class="s4">(</span><span class="s5">'basicConstraints'</span><span class="s4">);</span>
      <span class="s3">var </span><span class="s2">keyUsageExt </span><span class="s4">= </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">getExtension</span><span class="s4">(</span><span class="s5">'keyUsage'</span><span class="s4">);</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">keyUsageExt </span><span class="s4">!== </span><span class="s3">null</span><span class="s4">) {</span>
        <span class="s6">// keyCertSign must be true and there must be a basic</span>
        <span class="s6">// constraints extension</span>
        <span class="s3">if</span><span class="s4">(!</span><span class="s2">keyUsageExt</span><span class="s4">.</span><span class="s2">keyCertSign </span><span class="s4">|| </span><span class="s2">bcExt </span><span class="s4">=== </span><span class="s3">null</span><span class="s4">) {</span>
          <span class="s6">// bad certificate</span>
          <span class="s2">error </span><span class="s4">= {</span>
            <span class="s2">message</span><span class="s4">:</span>
              <span class="s5">'Certificate keyUsage or basicConstraints conflict ' </span><span class="s4">+</span>
              <span class="s5">'or indicate that the certificate is not a CA. ' </span><span class="s4">+</span>
              <span class="s5">'If the certificate is the only one in the chain or ' </span><span class="s4">+</span>
              <span class="s5">'isn</span><span class="s3">\'</span><span class="s5">t the first then the certificate must be a ' </span><span class="s4">+</span>
              <span class="s5">'valid CA.'</span><span class="s4">,</span>
            <span class="s2">error</span><span class="s4">: </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateError</span><span class="s4">.</span><span class="s2">bad_certificate</span>
          <span class="s4">};</span>
        <span class="s4">}</span>
      <span class="s4">}</span>
      <span class="s6">// basic constraints cA flag must be set</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">error </span><span class="s4">=== </span><span class="s3">null </span><span class="s4">&amp;&amp; </span><span class="s2">bcExt </span><span class="s4">!== </span><span class="s3">null </span><span class="s4">&amp;&amp; !</span><span class="s2">bcExt</span><span class="s4">.</span><span class="s2">cA</span><span class="s4">) {</span>
        <span class="s6">// bad certificate</span>
        <span class="s2">error </span><span class="s4">= {</span>
          <span class="s2">message</span><span class="s4">:</span>
            <span class="s5">'Certificate basicConstraints indicates the certificate ' </span><span class="s4">+</span>
            <span class="s5">'is not a CA.'</span><span class="s4">,</span>
          <span class="s2">error</span><span class="s4">: </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateError</span><span class="s4">.</span><span class="s2">bad_certificate</span>
        <span class="s4">};</span>
      <span class="s4">}</span>
      <span class="s6">// if error is not null and keyUsage is available, then we know it</span>
      <span class="s6">// has keyCertSign and there is a basic constraints extension too,</span>
      <span class="s6">// which means we can check pathLenConstraint (if it exists)</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">error </span><span class="s4">=== </span><span class="s3">null </span><span class="s4">&amp;&amp; </span><span class="s2">keyUsageExt </span><span class="s4">!== </span><span class="s3">null </span><span class="s4">&amp;&amp;</span>
        <span class="s5">'pathLenConstraint' </span><span class="s3">in </span><span class="s2">bcExt</span><span class="s4">) {</span>
        <span class="s6">// pathLen is the maximum # of intermediate CA certs that can be</span>
        <span class="s6">// found between the current certificate and the end-entity (depth 0)</span>
        <span class="s6">// certificate; this number does not include the end-entity (depth 0,</span>
        <span class="s6">// last in the chain) even if it happens to be a CA certificate itself</span>
        <span class="s3">var </span><span class="s2">pathLen </span><span class="s4">= </span><span class="s2">depth </span><span class="s4">- </span><span class="s7">1</span><span class="s4">;</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s2">pathLen </span><span class="s4">&gt; </span><span class="s2">bcExt</span><span class="s4">.</span><span class="s2">pathLenConstraint</span><span class="s4">) {</span>
          <span class="s6">// pathLenConstraint violated, bad certificate</span>
          <span class="s2">error </span><span class="s4">= {</span>
            <span class="s2">message</span><span class="s4">:</span>
              <span class="s5">'Certificate basicConstraints pathLenConstraint violated.'</span><span class="s4">,</span>
            <span class="s2">error</span><span class="s4">: </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateError</span><span class="s4">.</span><span class="s2">bad_certificate</span>
          <span class="s4">};</span>
        <span class="s4">}</span>
      <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s6">// call application callback</span>
    <span class="s3">var </span><span class="s2">vfd </span><span class="s4">= (</span><span class="s2">error </span><span class="s4">=== </span><span class="s3">null</span><span class="s4">) ? </span><span class="s3">true </span><span class="s4">: </span><span class="s2">error</span><span class="s4">.</span><span class="s2">error</span><span class="s4">;</span>
    <span class="s3">var </span><span class="s2">ret </span><span class="s4">= </span><span class="s2">options</span><span class="s4">.</span><span class="s2">verify </span><span class="s4">? </span><span class="s2">options</span><span class="s4">.</span><span class="s2">verify</span><span class="s4">(</span><span class="s2">vfd</span><span class="s4">, </span><span class="s2">depth</span><span class="s4">, </span><span class="s2">certs</span><span class="s4">) : </span><span class="s2">vfd</span><span class="s4">;</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">ret </span><span class="s4">=== </span><span class="s3">true</span><span class="s4">) {</span>
      <span class="s6">// clear any set error</span>
      <span class="s2">error </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
    <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
      <span class="s6">// if passed basic tests, set default message and alert</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">vfd </span><span class="s4">=== </span><span class="s3">true</span><span class="s4">) {</span>
        <span class="s2">error </span><span class="s4">= {</span>
          <span class="s2">message</span><span class="s4">: </span><span class="s5">'The application rejected the certificate.'</span><span class="s4">,</span>
          <span class="s2">error</span><span class="s4">: </span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateError</span><span class="s4">.</span><span class="s2">bad_certificate</span>
        <span class="s4">};</span>
      <span class="s4">}</span>

      <span class="s6">// check for custom error info</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">ret </span><span class="s4">|| </span><span class="s2">ret </span><span class="s4">=== </span><span class="s7">0</span><span class="s4">) {</span>
        <span class="s6">// set custom message and error</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s3">typeof </span><span class="s2">ret </span><span class="s4">=== </span><span class="s5">'object' </span><span class="s4">&amp;&amp; !</span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">isArray</span><span class="s4">(</span><span class="s2">ret</span><span class="s4">)) {</span>
          <span class="s3">if</span><span class="s4">(</span><span class="s2">ret</span><span class="s4">.</span><span class="s2">message</span><span class="s4">) {</span>
            <span class="s2">error</span><span class="s4">.</span><span class="s2">message </span><span class="s4">= </span><span class="s2">ret</span><span class="s4">.</span><span class="s2">message</span><span class="s4">;</span>
          <span class="s4">}</span>
          <span class="s3">if</span><span class="s4">(</span><span class="s2">ret</span><span class="s4">.</span><span class="s2">error</span><span class="s4">) {</span>
            <span class="s2">error</span><span class="s4">.</span><span class="s2">error </span><span class="s4">= </span><span class="s2">ret</span><span class="s4">.</span><span class="s2">error</span><span class="s4">;</span>
          <span class="s4">}</span>
        <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s3">typeof </span><span class="s2">ret </span><span class="s4">=== </span><span class="s5">'string'</span><span class="s4">) {</span>
          <span class="s6">// set custom error</span>
          <span class="s2">error</span><span class="s4">.</span><span class="s2">error </span><span class="s4">= </span><span class="s2">ret</span><span class="s4">;</span>
        <span class="s4">}</span>
      <span class="s4">}</span>

      <span class="s6">// throw error</span>
      <span class="s3">throw </span><span class="s2">error</span><span class="s4">;</span>
    <span class="s4">}</span>

    <span class="s6">// no longer first cert in chain</span>
    <span class="s2">first </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>
    <span class="s4">++</span><span class="s2">depth</span><span class="s4">;</span>
  <span class="s4">} </span><span class="s3">while</span><span class="s4">(</span><span class="s2">chain</span><span class="s4">.</span><span class="s2">length </span><span class="s4">&gt; </span><span class="s7">0</span><span class="s4">);</span>

  <span class="s3">return true</span><span class="s4">;</span>
<span class="s4">};</span>
</pre>
</body>
</html>