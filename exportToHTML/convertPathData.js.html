<html>
<head>
<title>convertPathData.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #6aab73;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #cf8e6d;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
.s6 { color: #5f826b; font-style: italic;}
.s7 { color: #67a37c; font-style: italic;}
.s8 { color: #42c3d4;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
convertPathData.js</font>
</center></td></tr></table>
<pre><span class="s0">'use strict'</span><span class="s1">;</span>

<span class="s3">const </span><span class="s1">{ </span><span class="s2">collectStylesheet</span><span class="s1">, </span><span class="s2">computeStyle </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../lib/style.js'</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">pathElems </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./_collections.js'</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">path2js</span><span class="s1">, </span><span class="s2">js2path </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./_path.js'</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">applyTransforms </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'./_applyTransforms.js'</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ </span><span class="s2">cleanupOutData </span><span class="s1">} = </span><span class="s2">require</span><span class="s1">(</span><span class="s0">'../lib/svgo/tools'</span><span class="s1">);</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">name </span><span class="s1">= </span><span class="s0">'convertPathData'</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">type </span><span class="s1">= </span><span class="s0">'visitor'</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">active </span><span class="s1">= </span><span class="s3">true</span><span class="s1">;</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">description </span><span class="s1">=</span>
  <span class="s0">'optimizes path data: writes in shorter form, applies transformations'</span><span class="s1">;</span>

<span class="s2">exports</span><span class="s1">.</span><span class="s2">params </span><span class="s1">= {</span>
  <span class="s2">applyTransforms</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
  <span class="s2">applyTransformsStroked</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
  <span class="s2">makeArcs</span><span class="s1">: {</span>
    <span class="s2">threshold</span><span class="s1">: </span><span class="s4">2.5</span><span class="s1">, </span><span class="s5">// coefficient of rounding error</span>
    <span class="s2">tolerance</span><span class="s1">: </span><span class="s4">0.5</span><span class="s1">, </span><span class="s5">// percentage of radius</span>
  <span class="s1">},</span>
  <span class="s2">straightCurves</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
  <span class="s2">lineShorthands</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
  <span class="s2">curveSmoothShorthands</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
  <span class="s2">floatPrecision</span><span class="s1">: </span><span class="s4">3</span><span class="s1">,</span>
  <span class="s2">transformPrecision</span><span class="s1">: </span><span class="s4">5</span><span class="s1">,</span>
  <span class="s2">removeUseless</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
  <span class="s2">collapseRepeated</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
  <span class="s2">utilizeAbsolute</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
  <span class="s2">leadingZero</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
  <span class="s2">negativeExtraSpace</span><span class="s1">: </span><span class="s3">true</span><span class="s1">,</span>
  <span class="s2">noSpaceAfterFlags</span><span class="s1">: </span><span class="s3">false</span><span class="s1">, </span><span class="s5">// a20 60 45 0 1 30 20 → a20 60 45 0130 20</span>
  <span class="s2">forceAbsolutePath</span><span class="s1">: </span><span class="s3">false</span><span class="s1">,</span>
<span class="s1">};</span>

<span class="s3">let </span><span class="s2">roundData</span><span class="s1">;</span>
<span class="s3">let </span><span class="s2">precision</span><span class="s1">;</span>
<span class="s3">let </span><span class="s2">error</span><span class="s1">;</span>
<span class="s3">let </span><span class="s2">arcThreshold</span><span class="s1">;</span>
<span class="s3">let </span><span class="s2">arcTolerance</span><span class="s1">;</span>

<span class="s6">/**</span>
 <span class="s6">* Convert absolute Path to relative,</span>
 <span class="s6">* collapse repeated instructions,</span>
 <span class="s6">* detect and convert Lineto shorthands,</span>
 <span class="s6">* remove useless instructions like &quot;l0,0&quot;,</span>
 <span class="s6">* trim useless delimiters and leading zeros,</span>
 <span class="s6">* decrease accuracy of floating-point numbers.</span>
 <span class="s6">*</span>
 <span class="s6">* </span><span class="s7">@see </span><span class="s6">https://www.w3.org/TR/SVG11/paths.html#PathData</span>
 <span class="s6">*</span>
 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Object} item current iteration item</span>
 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Object} params plugin params</span>
 <span class="s6">* </span><span class="s7">@return </span><span class="s6">{Boolean} if false, item will be filtered out</span>
 <span class="s6">*</span>
 <span class="s6">* </span><span class="s7">@author </span><span class="s6">Kir Belevich</span>
 <span class="s6">*/</span>
<span class="s2">exports</span><span class="s1">.</span><span class="s2">fn </span><span class="s1">= (</span><span class="s2">root</span><span class="s1">, </span><span class="s2">params</span><span class="s1">) =&gt; {</span>
  <span class="s3">const </span><span class="s2">stylesheet </span><span class="s1">= </span><span class="s2">collectStylesheet</span><span class="s1">(</span><span class="s2">root</span><span class="s1">);</span>
  <span class="s3">return </span><span class="s1">{</span>
    <span class="s2">element</span><span class="s1">: {</span>
      <span class="s2">enter</span><span class="s1">: (</span><span class="s2">node</span><span class="s1">) =&gt; {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">pathElems</span><span class="s1">.</span><span class="s2">includes</span><span class="s1">(</span><span class="s2">node</span><span class="s1">.</span><span class="s2">name</span><span class="s1">) &amp;&amp; </span><span class="s2">node</span><span class="s1">.</span><span class="s2">attributes</span><span class="s1">.</span><span class="s2">d </span><span class="s1">!= </span><span class="s3">null</span><span class="s1">) {</span>
          <span class="s3">const </span><span class="s2">computedStyle </span><span class="s1">= </span><span class="s2">computeStyle</span><span class="s1">(</span><span class="s2">stylesheet</span><span class="s1">, </span><span class="s2">node</span><span class="s1">);</span>
          <span class="s2">precision </span><span class="s1">= </span><span class="s2">params</span><span class="s1">.</span><span class="s2">floatPrecision</span><span class="s1">;</span>
          <span class="s2">error </span><span class="s1">=</span>
            <span class="s2">precision </span><span class="s1">!== </span><span class="s3">false</span>
              <span class="s1">? +</span><span class="s2">Math</span><span class="s1">.</span><span class="s2">pow</span><span class="s1">(</span><span class="s4">0.1</span><span class="s1">, </span><span class="s2">precision</span><span class="s1">).</span><span class="s2">toFixed</span><span class="s1">(</span><span class="s2">precision</span><span class="s1">)</span>
              <span class="s1">: </span><span class="s4">1e-2</span><span class="s1">;</span>
          <span class="s2">roundData </span><span class="s1">= </span><span class="s2">precision </span><span class="s1">&gt; </span><span class="s4">0 </span><span class="s1">&amp;&amp; </span><span class="s2">precision </span><span class="s1">&lt; </span><span class="s4">20 </span><span class="s1">? </span><span class="s2">strongRound </span><span class="s1">: </span><span class="s2">round</span><span class="s1">;</span>
          <span class="s3">if </span><span class="s1">(</span><span class="s2">params</span><span class="s1">.</span><span class="s2">makeArcs</span><span class="s1">) {</span>
            <span class="s2">arcThreshold </span><span class="s1">= </span><span class="s2">params</span><span class="s1">.</span><span class="s2">makeArcs</span><span class="s1">.</span><span class="s2">threshold</span><span class="s1">;</span>
            <span class="s2">arcTolerance </span><span class="s1">= </span><span class="s2">params</span><span class="s1">.</span><span class="s2">makeArcs</span><span class="s1">.</span><span class="s2">tolerance</span><span class="s1">;</span>
          <span class="s1">}</span>
          <span class="s3">const </span><span class="s2">hasMarkerMid </span><span class="s1">= </span><span class="s2">computedStyle</span><span class="s1">[</span><span class="s0">'marker-mid'</span><span class="s1">] != </span><span class="s3">null</span><span class="s1">;</span>

          <span class="s3">const </span><span class="s2">maybeHasStroke </span><span class="s1">=</span>
            <span class="s2">computedStyle</span><span class="s1">.</span><span class="s2">stroke </span><span class="s1">&amp;&amp;</span>
            <span class="s1">(</span><span class="s2">computedStyle</span><span class="s1">.</span><span class="s2">stroke</span><span class="s1">.</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">'dynamic' </span><span class="s1">||</span>
              <span class="s2">computedStyle</span><span class="s1">.</span><span class="s2">stroke</span><span class="s1">.</span><span class="s2">value </span><span class="s1">!== </span><span class="s0">'none'</span><span class="s1">);</span>
          <span class="s3">const </span><span class="s2">maybeHasLinecap </span><span class="s1">=</span>
            <span class="s2">computedStyle</span><span class="s1">[</span><span class="s0">'stroke-linecap'</span><span class="s1">] &amp;&amp;</span>
            <span class="s1">(</span><span class="s2">computedStyle</span><span class="s1">[</span><span class="s0">'stroke-linecap'</span><span class="s1">].</span><span class="s2">type </span><span class="s1">=== </span><span class="s0">'dynamic' </span><span class="s1">||</span>
              <span class="s2">computedStyle</span><span class="s1">[</span><span class="s0">'stroke-linecap'</span><span class="s1">].</span><span class="s2">value </span><span class="s1">!== </span><span class="s0">'butt'</span><span class="s1">);</span>
          <span class="s3">const </span><span class="s2">maybeHasStrokeAndLinecap </span><span class="s1">= </span><span class="s2">maybeHasStroke </span><span class="s1">&amp;&amp; </span><span class="s2">maybeHasLinecap</span><span class="s1">;</span>

          <span class="s3">var </span><span class="s2">data </span><span class="s1">= </span><span class="s2">path2js</span><span class="s1">(</span><span class="s2">node</span><span class="s1">);</span>

          <span class="s5">// TODO: get rid of functions returns</span>
          <span class="s3">if </span><span class="s1">(</span><span class="s2">data</span><span class="s1">.</span><span class="s2">length</span><span class="s1">) {</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">params</span><span class="s1">.</span><span class="s2">applyTransforms</span><span class="s1">) {</span>
              <span class="s2">applyTransforms</span><span class="s1">(</span><span class="s2">node</span><span class="s1">, </span><span class="s2">data</span><span class="s1">, </span><span class="s2">params</span><span class="s1">);</span>
            <span class="s1">}</span>

            <span class="s2">convertToRelative</span><span class="s1">(</span><span class="s2">data</span><span class="s1">);</span>

            <span class="s2">data </span><span class="s1">= </span><span class="s2">filters</span><span class="s1">(</span><span class="s2">data</span><span class="s1">, </span><span class="s2">params</span><span class="s1">, {</span>
              <span class="s2">maybeHasStrokeAndLinecap</span><span class="s1">,</span>
              <span class="s2">hasMarkerMid</span><span class="s1">,</span>
            <span class="s1">});</span>

            <span class="s3">if </span><span class="s1">(</span><span class="s2">params</span><span class="s1">.</span><span class="s2">utilizeAbsolute</span><span class="s1">) {</span>
              <span class="s2">data </span><span class="s1">= </span><span class="s2">convertToMixed</span><span class="s1">(</span><span class="s2">data</span><span class="s1">, </span><span class="s2">params</span><span class="s1">);</span>
            <span class="s1">}</span>

            <span class="s2">js2path</span><span class="s1">(</span><span class="s2">node</span><span class="s1">, </span><span class="s2">data</span><span class="s1">, </span><span class="s2">params</span><span class="s1">);</span>
          <span class="s1">}</span>
        <span class="s1">}</span>
      <span class="s1">},</span>
    <span class="s1">},</span>
  <span class="s1">};</span>
<span class="s1">};</span>

<span class="s6">/**</span>
 <span class="s6">* Convert absolute path data coordinates to relative.</span>
 <span class="s6">*</span>
 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Array} path input path data</span>
 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Object} params plugin params</span>
 <span class="s6">* </span><span class="s7">@return </span><span class="s6">{Array} output path data</span>
 <span class="s6">*/</span>
<span class="s3">const </span><span class="s2">convertToRelative </span><span class="s1">= (</span><span class="s2">pathData</span><span class="s1">) =&gt; {</span>
  <span class="s3">let </span><span class="s2">start </span><span class="s1">= [</span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s1">];</span>
  <span class="s3">let </span><span class="s2">cursor </span><span class="s1">= [</span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s1">];</span>
  <span class="s3">let </span><span class="s2">prevCoords </span><span class="s1">= [</span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s1">];</span>

  <span class="s3">for </span><span class="s1">(</span><span class="s3">let </span><span class="s2">i </span><span class="s1">= </span><span class="s4">0</span><span class="s1">; </span><span class="s2">i </span><span class="s1">&lt; </span><span class="s2">pathData</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">i </span><span class="s1">+= </span><span class="s4">1</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s2">pathItem </span><span class="s1">= </span><span class="s2">pathData</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>
    <span class="s3">let </span><span class="s1">{ </span><span class="s2">command</span><span class="s1">, </span><span class="s2">args </span><span class="s1">} = </span><span class="s2">pathItem</span><span class="s1">;</span>

    <span class="s5">// moveto (x y)</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'m'</span><span class="s1">) {</span>
      <span class="s5">// update start and cursor</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
      <span class="s2">start</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] = </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
      <span class="s2">start</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] = </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'M'</span><span class="s1">) {</span>
      <span class="s5">// M → m</span>
      <span class="s5">// skip first moveto</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">i </span><span class="s1">!== </span><span class="s4">0</span><span class="s1">) {</span>
        <span class="s2">command </span><span class="s1">= </span><span class="s0">'m'</span><span class="s1">;</span>
      <span class="s1">}</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] -= </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] -= </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
      <span class="s5">// update start and cursor</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
      <span class="s2">start</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] = </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
      <span class="s2">start</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] = </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
    <span class="s1">}</span>

    <span class="s5">// lineto (x y)</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'l'</span><span class="s1">) {</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'L'</span><span class="s1">) {</span>
      <span class="s5">// L → l</span>
      <span class="s2">command </span><span class="s1">= </span><span class="s0">'l'</span><span class="s1">;</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] -= </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] -= </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
    <span class="s1">}</span>

    <span class="s5">// horizontal lineto (x)</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'h'</span><span class="s1">) {</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'H'</span><span class="s1">) {</span>
      <span class="s5">// H → h</span>
      <span class="s2">command </span><span class="s1">= </span><span class="s0">'h'</span><span class="s1">;</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] -= </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
    <span class="s1">}</span>

    <span class="s5">// vertical lineto (y)</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'v'</span><span class="s1">) {</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'V'</span><span class="s1">) {</span>
      <span class="s5">// V → v</span>
      <span class="s2">command </span><span class="s1">= </span><span class="s0">'v'</span><span class="s1">;</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] -= </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
    <span class="s1">}</span>

    <span class="s5">// curveto (x1 y1 x2 y2 x y)</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'c'</span><span class="s1">) {</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">4</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">5</span><span class="s1">];</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'C'</span><span class="s1">) {</span>
      <span class="s5">// C → c</span>
      <span class="s2">command </span><span class="s1">= </span><span class="s0">'c'</span><span class="s1">;</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] -= </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] -= </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s4">2</span><span class="s1">] -= </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s4">3</span><span class="s1">] -= </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s4">4</span><span class="s1">] -= </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s4">5</span><span class="s1">] -= </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">4</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">5</span><span class="s1">];</span>
    <span class="s1">}</span>

    <span class="s5">// smooth curveto (x2 y2 x y)</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'s'</span><span class="s1">) {</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">2</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">3</span><span class="s1">];</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'S'</span><span class="s1">) {</span>
      <span class="s5">// S → s</span>
      <span class="s2">command </span><span class="s1">= </span><span class="s0">'s'</span><span class="s1">;</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] -= </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] -= </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s4">2</span><span class="s1">] -= </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s4">3</span><span class="s1">] -= </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">2</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">3</span><span class="s1">];</span>
    <span class="s1">}</span>

    <span class="s5">// quadratic Bézier curveto (x1 y1 x y)</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'q'</span><span class="s1">) {</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">2</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">3</span><span class="s1">];</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'Q'</span><span class="s1">) {</span>
      <span class="s5">// Q → q</span>
      <span class="s2">command </span><span class="s1">= </span><span class="s0">'q'</span><span class="s1">;</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] -= </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] -= </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s4">2</span><span class="s1">] -= </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s4">3</span><span class="s1">] -= </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">2</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">3</span><span class="s1">];</span>
    <span class="s1">}</span>

    <span class="s5">// smooth quadratic Bézier curveto (x y)</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'t'</span><span class="s1">) {</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'T'</span><span class="s1">) {</span>
      <span class="s5">// T → t</span>
      <span class="s2">command </span><span class="s1">= </span><span class="s0">'t'</span><span class="s1">;</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] -= </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] -= </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
    <span class="s1">}</span>

    <span class="s5">// elliptical arc (rx ry x-axis-rotation large-arc-flag sweep-flag x y)</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'a'</span><span class="s1">) {</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">5</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">6</span><span class="s1">];</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'A'</span><span class="s1">) {</span>
      <span class="s5">// A → a</span>
      <span class="s2">command </span><span class="s1">= </span><span class="s0">'a'</span><span class="s1">;</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s4">5</span><span class="s1">] -= </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
      <span class="s2">args</span><span class="s1">[</span><span class="s4">6</span><span class="s1">] -= </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">5</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] += </span><span class="s2">args</span><span class="s1">[</span><span class="s4">6</span><span class="s1">];</span>
    <span class="s1">}</span>

    <span class="s5">// closepath</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'Z' </span><span class="s1">|| </span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'z'</span><span class="s1">) {</span>
      <span class="s5">// reset cursor</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] = </span><span class="s2">start</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
      <span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] = </span><span class="s2">start</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
    <span class="s1">}</span>

    <span class="s2">pathItem</span><span class="s1">.</span><span class="s2">command </span><span class="s1">= </span><span class="s2">command</span><span class="s1">;</span>
    <span class="s2">pathItem</span><span class="s1">.</span><span class="s2">args </span><span class="s1">= </span><span class="s2">args</span><span class="s1">;</span>
    <span class="s5">// store absolute coordinates for later use</span>
    <span class="s5">// base should preserve reference from other element</span>
    <span class="s2">pathItem</span><span class="s1">.</span><span class="s2">base </span><span class="s1">= </span><span class="s2">prevCoords</span><span class="s1">;</span>
    <span class="s2">pathItem</span><span class="s1">.</span><span class="s2">coords </span><span class="s1">= [</span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">0</span><span class="s1">], </span><span class="s2">cursor</span><span class="s1">[</span><span class="s4">1</span><span class="s1">]];</span>
    <span class="s2">prevCoords </span><span class="s1">= </span><span class="s2">pathItem</span><span class="s1">.</span><span class="s2">coords</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s2">pathData</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s6">/**</span>
 <span class="s6">* Main filters loop.</span>
 <span class="s6">*</span>
 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Array} path input path data</span>
 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Object} params plugin params</span>
 <span class="s6">* </span><span class="s7">@return </span><span class="s6">{Array} output path data</span>
 <span class="s6">*/</span>
<span class="s3">function </span><span class="s2">filters</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">params</span><span class="s1">, { </span><span class="s2">maybeHasStrokeAndLinecap</span><span class="s1">, </span><span class="s2">hasMarkerMid </span><span class="s1">}) {</span>
  <span class="s3">var </span><span class="s2">stringify </span><span class="s1">= </span><span class="s2">data2Path</span><span class="s1">.</span><span class="s2">bind</span><span class="s1">(</span><span class="s3">null</span><span class="s1">, </span><span class="s2">params</span><span class="s1">),</span>
    <span class="s2">relSubpoint </span><span class="s1">= [</span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s1">],</span>
    <span class="s2">pathBase </span><span class="s1">= [</span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s1">],</span>
    <span class="s2">prev </span><span class="s1">= {};</span>

  <span class="s2">path </span><span class="s1">= </span><span class="s2">path</span><span class="s1">.</span><span class="s2">filter</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">item</span><span class="s1">, </span><span class="s2">index</span><span class="s1">, </span><span class="s2">path</span><span class="s1">) {</span>
    <span class="s3">let </span><span class="s2">command </span><span class="s1">= </span><span class="s2">item</span><span class="s1">.</span><span class="s2">command</span><span class="s1">;</span>
    <span class="s3">let </span><span class="s2">data </span><span class="s1">= </span><span class="s2">item</span><span class="s1">.</span><span class="s2">args</span><span class="s1">;</span>
    <span class="s3">let </span><span class="s2">next </span><span class="s1">= </span><span class="s2">path</span><span class="s1">[</span><span class="s2">index </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">];</span>

    <span class="s3">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">!== </span><span class="s0">'Z' </span><span class="s1">&amp;&amp; </span><span class="s2">command </span><span class="s1">!== </span><span class="s0">'z'</span><span class="s1">) {</span>
      <span class="s3">var </span><span class="s2">sdata </span><span class="s1">= </span><span class="s2">data</span><span class="s1">,</span>
        <span class="s2">circle</span><span class="s1">;</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'s'</span><span class="s1">) {</span>
        <span class="s2">sdata </span><span class="s1">= [</span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s1">].</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">data</span><span class="s1">);</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'c' </span><span class="s1">|| </span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'s'</span><span class="s1">) {</span>
          <span class="s3">var </span><span class="s2">pdata </span><span class="s1">= </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">args</span><span class="s1">,</span>
            <span class="s2">n </span><span class="s1">= </span><span class="s2">pdata</span><span class="s1">.</span><span class="s2">length</span><span class="s1">;</span>

          <span class="s5">// (-x, -y) of the prev tangent point relative to the current point</span>
          <span class="s2">sdata</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] = </span><span class="s2">pdata</span><span class="s1">[</span><span class="s2">n </span><span class="s1">- </span><span class="s4">2</span><span class="s1">] - </span><span class="s2">pdata</span><span class="s1">[</span><span class="s2">n </span><span class="s1">- </span><span class="s4">4</span><span class="s1">];</span>
          <span class="s2">sdata</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] = </span><span class="s2">pdata</span><span class="s1">[</span><span class="s2">n </span><span class="s1">- </span><span class="s4">1</span><span class="s1">] - </span><span class="s2">pdata</span><span class="s1">[</span><span class="s2">n </span><span class="s1">- </span><span class="s4">3</span><span class="s1">];</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s5">// convert curves to arcs if possible</span>
      <span class="s3">if </span><span class="s1">(</span>
        <span class="s2">params</span><span class="s1">.</span><span class="s2">makeArcs </span><span class="s1">&amp;&amp;</span>
        <span class="s1">(</span><span class="s2">command </span><span class="s1">== </span><span class="s0">'c' </span><span class="s1">|| </span><span class="s2">command </span><span class="s1">== </span><span class="s0">'s'</span><span class="s1">) &amp;&amp;</span>
        <span class="s2">isConvex</span><span class="s1">(</span><span class="s2">sdata</span><span class="s1">) &amp;&amp;</span>
        <span class="s1">(</span><span class="s2">circle </span><span class="s1">= </span><span class="s2">findCircle</span><span class="s1">(</span><span class="s2">sdata</span><span class="s1">))</span>
      <span class="s1">) {</span>
        <span class="s3">var </span><span class="s2">r </span><span class="s1">= </span><span class="s2">roundData</span><span class="s1">([</span><span class="s2">circle</span><span class="s1">.</span><span class="s2">radius</span><span class="s1">])[</span><span class="s4">0</span><span class="s1">],</span>
          <span class="s2">angle </span><span class="s1">= </span><span class="s2">findArcAngle</span><span class="s1">(</span><span class="s2">sdata</span><span class="s1">, </span><span class="s2">circle</span><span class="s1">),</span>
          <span class="s2">sweep </span><span class="s1">= </span><span class="s2">sdata</span><span class="s1">[</span><span class="s4">5</span><span class="s1">] * </span><span class="s2">sdata</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] - </span><span class="s2">sdata</span><span class="s1">[</span><span class="s4">4</span><span class="s1">] * </span><span class="s2">sdata</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] &gt; </span><span class="s4">0 </span><span class="s1">? </span><span class="s4">1 </span><span class="s1">: </span><span class="s4">0</span><span class="s1">,</span>
          <span class="s2">arc </span><span class="s1">= {</span>
            <span class="s2">command</span><span class="s1">: </span><span class="s0">'a'</span><span class="s1">,</span>
            <span class="s2">args</span><span class="s1">: [</span><span class="s2">r</span><span class="s1">, </span><span class="s2">r</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s2">sweep</span><span class="s1">, </span><span class="s2">sdata</span><span class="s1">[</span><span class="s4">4</span><span class="s1">], </span><span class="s2">sdata</span><span class="s1">[</span><span class="s4">5</span><span class="s1">]],</span>
            <span class="s2">coords</span><span class="s1">: </span><span class="s2">item</span><span class="s1">.</span><span class="s2">coords</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(),</span>
            <span class="s2">base</span><span class="s1">: </span><span class="s2">item</span><span class="s1">.</span><span class="s2">base</span><span class="s1">,</span>
          <span class="s1">},</span>
          <span class="s2">output </span><span class="s1">= [</span><span class="s2">arc</span><span class="s1">],</span>
          <span class="s5">// relative coordinates to adjust the found circle</span>
          <span class="s2">relCenter </span><span class="s1">= [</span>
            <span class="s2">circle</span><span class="s1">.</span><span class="s2">center</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] - </span><span class="s2">sdata</span><span class="s1">[</span><span class="s4">4</span><span class="s1">],</span>
            <span class="s2">circle</span><span class="s1">.</span><span class="s2">center</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] - </span><span class="s2">sdata</span><span class="s1">[</span><span class="s4">5</span><span class="s1">],</span>
          <span class="s1">],</span>
          <span class="s2">relCircle </span><span class="s1">= { </span><span class="s2">center</span><span class="s1">: </span><span class="s2">relCenter</span><span class="s1">, </span><span class="s2">radius</span><span class="s1">: </span><span class="s2">circle</span><span class="s1">.</span><span class="s2">radius </span><span class="s1">},</span>
          <span class="s2">arcCurves </span><span class="s1">= [</span><span class="s2">item</span><span class="s1">],</span>
          <span class="s2">hasPrev </span><span class="s1">= </span><span class="s4">0</span><span class="s1">,</span>
          <span class="s2">suffix </span><span class="s1">= </span><span class="s0">''</span><span class="s1">,</span>
          <span class="s2">nextLonghand</span><span class="s1">;</span>

        <span class="s3">if </span><span class="s1">(</span>
          <span class="s1">(</span><span class="s2">prev</span><span class="s1">.</span><span class="s2">command </span><span class="s1">== </span><span class="s0">'c' </span><span class="s1">&amp;&amp;</span>
            <span class="s2">isConvex</span><span class="s1">(</span><span class="s2">prev</span><span class="s1">.</span><span class="s2">args</span><span class="s1">) &amp;&amp;</span>
            <span class="s2">isArcPrev</span><span class="s1">(</span><span class="s2">prev</span><span class="s1">.</span><span class="s2">args</span><span class="s1">, </span><span class="s2">circle</span><span class="s1">)) ||</span>
          <span class="s1">(</span><span class="s2">prev</span><span class="s1">.</span><span class="s2">command </span><span class="s1">== </span><span class="s0">'a' </span><span class="s1">&amp;&amp; </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">sdata </span><span class="s1">&amp;&amp; </span><span class="s2">isArcPrev</span><span class="s1">(</span><span class="s2">prev</span><span class="s1">.</span><span class="s2">sdata</span><span class="s1">, </span><span class="s2">circle</span><span class="s1">))</span>
        <span class="s1">) {</span>
          <span class="s2">arcCurves</span><span class="s1">.</span><span class="s2">unshift</span><span class="s1">(</span><span class="s2">prev</span><span class="s1">);</span>
          <span class="s2">arc</span><span class="s1">.</span><span class="s2">base </span><span class="s1">= </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">base</span><span class="s1">;</span>
          <span class="s2">arc</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">5</span><span class="s1">] = </span><span class="s2">arc</span><span class="s1">.</span><span class="s2">coords</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] - </span><span class="s2">arc</span><span class="s1">.</span><span class="s2">base</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
          <span class="s2">arc</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">6</span><span class="s1">] = </span><span class="s2">arc</span><span class="s1">.</span><span class="s2">coords</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] - </span><span class="s2">arc</span><span class="s1">.</span><span class="s2">base</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
          <span class="s3">var </span><span class="s2">prevData </span><span class="s1">= </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">command </span><span class="s1">== </span><span class="s0">'a' </span><span class="s1">? </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">sdata </span><span class="s1">: </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">args</span><span class="s1">;</span>
          <span class="s3">var </span><span class="s2">prevAngle </span><span class="s1">= </span><span class="s2">findArcAngle</span><span class="s1">(</span><span class="s2">prevData</span><span class="s1">, {</span>
            <span class="s2">center</span><span class="s1">: [</span>
              <span class="s2">prevData</span><span class="s1">[</span><span class="s4">4</span><span class="s1">] + </span><span class="s2">circle</span><span class="s1">.</span><span class="s2">center</span><span class="s1">[</span><span class="s4">0</span><span class="s1">],</span>
              <span class="s2">prevData</span><span class="s1">[</span><span class="s4">5</span><span class="s1">] + </span><span class="s2">circle</span><span class="s1">.</span><span class="s2">center</span><span class="s1">[</span><span class="s4">1</span><span class="s1">],</span>
            <span class="s1">],</span>
            <span class="s2">radius</span><span class="s1">: </span><span class="s2">circle</span><span class="s1">.</span><span class="s2">radius</span><span class="s1">,</span>
          <span class="s1">});</span>
          <span class="s2">angle </span><span class="s1">+= </span><span class="s2">prevAngle</span><span class="s1">;</span>
          <span class="s3">if </span><span class="s1">(</span><span class="s2">angle </span><span class="s1">&gt; </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">PI</span><span class="s1">) </span><span class="s2">arc</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">3</span><span class="s1">] = </span><span class="s4">1</span><span class="s1">;</span>
          <span class="s2">hasPrev </span><span class="s1">= </span><span class="s4">1</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s5">// check if next curves are fitting the arc</span>
        <span class="s3">for </span><span class="s1">(</span>
          <span class="s3">var </span><span class="s2">j </span><span class="s1">= </span><span class="s2">index</span><span class="s1">;</span>
          <span class="s1">(</span><span class="s2">next </span><span class="s1">= </span><span class="s2">path</span><span class="s1">[++</span><span class="s2">j</span><span class="s1">]) &amp;&amp; ~</span><span class="s0">'cs'</span><span class="s1">.</span><span class="s2">indexOf</span><span class="s1">(</span><span class="s2">next</span><span class="s1">.</span><span class="s2">command</span><span class="s1">);</span>

        <span class="s1">) {</span>
          <span class="s3">var </span><span class="s2">nextData </span><span class="s1">= </span><span class="s2">next</span><span class="s1">.</span><span class="s2">args</span><span class="s1">;</span>
          <span class="s3">if </span><span class="s1">(</span><span class="s2">next</span><span class="s1">.</span><span class="s2">command </span><span class="s1">== </span><span class="s0">'s'</span><span class="s1">) {</span>
            <span class="s2">nextLonghand </span><span class="s1">= </span><span class="s2">makeLonghand</span><span class="s1">(</span>
              <span class="s1">{ </span><span class="s2">command</span><span class="s1">: </span><span class="s0">'s'</span><span class="s1">, </span><span class="s2">args</span><span class="s1">: </span><span class="s2">next</span><span class="s1">.</span><span class="s2">args</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">() },</span>
              <span class="s2">path</span><span class="s1">[</span><span class="s2">j </span><span class="s1">- </span><span class="s4">1</span><span class="s1">].</span><span class="s2">args</span>
            <span class="s1">);</span>
            <span class="s2">nextData </span><span class="s1">= </span><span class="s2">nextLonghand</span><span class="s1">.</span><span class="s2">args</span><span class="s1">;</span>
            <span class="s2">nextLonghand</span><span class="s1">.</span><span class="s2">args </span><span class="s1">= </span><span class="s2">nextData</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s4">0</span><span class="s1">, </span><span class="s4">2</span><span class="s1">);</span>
            <span class="s2">suffix </span><span class="s1">= </span><span class="s2">stringify</span><span class="s1">([</span><span class="s2">nextLonghand</span><span class="s1">]);</span>
          <span class="s1">}</span>
          <span class="s3">if </span><span class="s1">(</span><span class="s2">isConvex</span><span class="s1">(</span><span class="s2">nextData</span><span class="s1">) &amp;&amp; </span><span class="s2">isArc</span><span class="s1">(</span><span class="s2">nextData</span><span class="s1">, </span><span class="s2">relCircle</span><span class="s1">)) {</span>
            <span class="s2">angle </span><span class="s1">+= </span><span class="s2">findArcAngle</span><span class="s1">(</span><span class="s2">nextData</span><span class="s1">, </span><span class="s2">relCircle</span><span class="s1">);</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">angle </span><span class="s1">- </span><span class="s4">2 </span><span class="s1">* </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">PI </span><span class="s1">&gt; </span><span class="s4">1e-3</span><span class="s1">) </span><span class="s3">break</span><span class="s1">; </span><span class="s5">// more than 360°</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s2">angle </span><span class="s1">&gt; </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">PI</span><span class="s1">) </span><span class="s2">arc</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">3</span><span class="s1">] = </span><span class="s4">1</span><span class="s1">;</span>
            <span class="s2">arcCurves</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">next</span><span class="s1">);</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s4">2 </span><span class="s1">* </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">PI </span><span class="s1">- </span><span class="s2">angle </span><span class="s1">&gt; </span><span class="s4">1e-3</span><span class="s1">) {</span>
              <span class="s5">// less than 360°</span>
              <span class="s2">arc</span><span class="s1">.</span><span class="s2">coords </span><span class="s1">= </span><span class="s2">next</span><span class="s1">.</span><span class="s2">coords</span><span class="s1">;</span>
              <span class="s2">arc</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">5</span><span class="s1">] = </span><span class="s2">arc</span><span class="s1">.</span><span class="s2">coords</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] - </span><span class="s2">arc</span><span class="s1">.</span><span class="s2">base</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
              <span class="s2">arc</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">6</span><span class="s1">] = </span><span class="s2">arc</span><span class="s1">.</span><span class="s2">coords</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] - </span><span class="s2">arc</span><span class="s1">.</span><span class="s2">base</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
            <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
              <span class="s5">// full circle, make a half-circle arc and add a second one</span>
              <span class="s2">arc</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">5</span><span class="s1">] = </span><span class="s4">2 </span><span class="s1">* (</span><span class="s2">relCircle</span><span class="s1">.</span><span class="s2">center</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] - </span><span class="s2">nextData</span><span class="s1">[</span><span class="s4">4</span><span class="s1">]);</span>
              <span class="s2">arc</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">6</span><span class="s1">] = </span><span class="s4">2 </span><span class="s1">* (</span><span class="s2">relCircle</span><span class="s1">.</span><span class="s2">center</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] - </span><span class="s2">nextData</span><span class="s1">[</span><span class="s4">5</span><span class="s1">]);</span>
              <span class="s2">arc</span><span class="s1">.</span><span class="s2">coords </span><span class="s1">= [</span>
                <span class="s2">arc</span><span class="s1">.</span><span class="s2">base</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] + </span><span class="s2">arc</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">5</span><span class="s1">],</span>
                <span class="s2">arc</span><span class="s1">.</span><span class="s2">base</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] + </span><span class="s2">arc</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">6</span><span class="s1">],</span>
              <span class="s1">];</span>
              <span class="s2">arc </span><span class="s1">= {</span>
                <span class="s2">command</span><span class="s1">: </span><span class="s0">'a'</span><span class="s1">,</span>
                <span class="s2">args</span><span class="s1">: [</span>
                  <span class="s2">r</span><span class="s1">,</span>
                  <span class="s2">r</span><span class="s1">,</span>
                  <span class="s4">0</span><span class="s1">,</span>
                  <span class="s4">0</span><span class="s1">,</span>
                  <span class="s2">sweep</span><span class="s1">,</span>
                  <span class="s2">next</span><span class="s1">.</span><span class="s2">coords</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] - </span><span class="s2">arc</span><span class="s1">.</span><span class="s2">coords</span><span class="s1">[</span><span class="s4">0</span><span class="s1">],</span>
                  <span class="s2">next</span><span class="s1">.</span><span class="s2">coords</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] - </span><span class="s2">arc</span><span class="s1">.</span><span class="s2">coords</span><span class="s1">[</span><span class="s4">1</span><span class="s1">],</span>
                <span class="s1">],</span>
                <span class="s2">coords</span><span class="s1">: </span><span class="s2">next</span><span class="s1">.</span><span class="s2">coords</span><span class="s1">,</span>
                <span class="s2">base</span><span class="s1">: </span><span class="s2">arc</span><span class="s1">.</span><span class="s2">coords</span><span class="s1">,</span>
              <span class="s1">};</span>
              <span class="s2">output</span><span class="s1">.</span><span class="s2">push</span><span class="s1">(</span><span class="s2">arc</span><span class="s1">);</span>
              <span class="s2">j</span><span class="s1">++;</span>
              <span class="s3">break</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s2">relCenter</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] -= </span><span class="s2">nextData</span><span class="s1">[</span><span class="s4">4</span><span class="s1">];</span>
            <span class="s2">relCenter</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] -= </span><span class="s2">nextData</span><span class="s1">[</span><span class="s4">5</span><span class="s1">];</span>
          <span class="s1">} </span><span class="s3">else break</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">((</span><span class="s2">stringify</span><span class="s1">(</span><span class="s2">output</span><span class="s1">) + </span><span class="s2">suffix</span><span class="s1">).</span><span class="s2">length </span><span class="s1">&lt; </span><span class="s2">stringify</span><span class="s1">(</span><span class="s2">arcCurves</span><span class="s1">).</span><span class="s2">length</span><span class="s1">) {</span>
          <span class="s3">if </span><span class="s1">(</span><span class="s2">path</span><span class="s1">[</span><span class="s2">j</span><span class="s1">] &amp;&amp; </span><span class="s2">path</span><span class="s1">[</span><span class="s2">j</span><span class="s1">].</span><span class="s2">command </span><span class="s1">== </span><span class="s0">'s'</span><span class="s1">) {</span>
            <span class="s2">makeLonghand</span><span class="s1">(</span><span class="s2">path</span><span class="s1">[</span><span class="s2">j</span><span class="s1">], </span><span class="s2">path</span><span class="s1">[</span><span class="s2">j </span><span class="s1">- </span><span class="s4">1</span><span class="s1">].</span><span class="s2">args</span><span class="s1">);</span>
          <span class="s1">}</span>
          <span class="s3">if </span><span class="s1">(</span><span class="s2">hasPrev</span><span class="s1">) {</span>
            <span class="s3">var </span><span class="s2">prevArc </span><span class="s1">= </span><span class="s2">output</span><span class="s1">.</span><span class="s2">shift</span><span class="s1">();</span>
            <span class="s2">roundData</span><span class="s1">(</span><span class="s2">prevArc</span><span class="s1">.</span><span class="s2">args</span><span class="s1">);</span>
            <span class="s2">relSubpoint</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] += </span><span class="s2">prevArc</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">5</span><span class="s1">] - </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s2">prev</span><span class="s1">.</span><span class="s2">args</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">2</span><span class="s1">];</span>
            <span class="s2">relSubpoint</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] += </span><span class="s2">prevArc</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">6</span><span class="s1">] - </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s2">prev</span><span class="s1">.</span><span class="s2">args</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">1</span><span class="s1">];</span>
            <span class="s2">prev</span><span class="s1">.</span><span class="s2">command </span><span class="s1">= </span><span class="s0">'a'</span><span class="s1">;</span>
            <span class="s2">prev</span><span class="s1">.</span><span class="s2">args </span><span class="s1">= </span><span class="s2">prevArc</span><span class="s1">.</span><span class="s2">args</span><span class="s1">;</span>
            <span class="s2">item</span><span class="s1">.</span><span class="s2">base </span><span class="s1">= </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">coords </span><span class="s1">= </span><span class="s2">prevArc</span><span class="s1">.</span><span class="s2">coords</span><span class="s1">;</span>
          <span class="s1">}</span>
          <span class="s2">arc </span><span class="s1">= </span><span class="s2">output</span><span class="s1">.</span><span class="s2">shift</span><span class="s1">();</span>
          <span class="s3">if </span><span class="s1">(</span><span class="s2">arcCurves</span><span class="s1">.</span><span class="s2">length </span><span class="s1">== </span><span class="s4">1</span><span class="s1">) {</span>
            <span class="s2">item</span><span class="s1">.</span><span class="s2">sdata </span><span class="s1">= </span><span class="s2">sdata</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(); </span><span class="s5">// preserve curve data for future checks</span>
          <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">arcCurves</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">1 </span><span class="s1">- </span><span class="s2">hasPrev </span><span class="s1">&gt; </span><span class="s4">0</span><span class="s1">) {</span>
            <span class="s5">// filter out consumed next items</span>
            <span class="s2">path</span><span class="s1">.</span><span class="s2">splice</span><span class="s1">.</span><span class="s2">apply</span><span class="s1">(</span>
              <span class="s2">path</span><span class="s1">,</span>
              <span class="s1">[</span><span class="s2">index </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">, </span><span class="s2">arcCurves</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">1 </span><span class="s1">- </span><span class="s2">hasPrev</span><span class="s1">].</span><span class="s2">concat</span><span class="s1">(</span><span class="s2">output</span><span class="s1">)</span>
            <span class="s1">);</span>
          <span class="s1">}</span>
          <span class="s3">if </span><span class="s1">(!</span><span class="s2">arc</span><span class="s1">) </span><span class="s3">return false</span><span class="s1">;</span>
          <span class="s2">command </span><span class="s1">= </span><span class="s0">'a'</span><span class="s1">;</span>
          <span class="s2">data </span><span class="s1">= </span><span class="s2">arc</span><span class="s1">.</span><span class="s2">args</span><span class="s1">;</span>
          <span class="s2">item</span><span class="s1">.</span><span class="s2">coords </span><span class="s1">= </span><span class="s2">arc</span><span class="s1">.</span><span class="s2">coords</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s5">// Rounding relative coordinates, taking in account accummulating error</span>
      <span class="s5">// to get closer to absolute coordinates. Sum of rounded value remains same:</span>
      <span class="s5">// l .25 3 .25 2 .25 3 .25 2 -&gt; l .3 3 .2 2 .3 3 .2 2</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">precision </span><span class="s1">!== </span><span class="s3">false</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span>
          <span class="s2">command </span><span class="s1">=== </span><span class="s0">'m' </span><span class="s1">||</span>
          <span class="s2">command </span><span class="s1">=== </span><span class="s0">'l' </span><span class="s1">||</span>
          <span class="s2">command </span><span class="s1">=== </span><span class="s0">'t' </span><span class="s1">||</span>
          <span class="s2">command </span><span class="s1">=== </span><span class="s0">'q' </span><span class="s1">||</span>
          <span class="s2">command </span><span class="s1">=== </span><span class="s0">'s' </span><span class="s1">||</span>
          <span class="s2">command </span><span class="s1">=== </span><span class="s0">'c'</span>
        <span class="s1">) {</span>
          <span class="s3">for </span><span class="s1">(</span><span class="s3">var </span><span class="s2">i </span><span class="s1">= </span><span class="s2">data</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">i</span><span class="s1">--; ) {</span>
            <span class="s2">data</span><span class="s1">[</span><span class="s2">i</span><span class="s1">] += </span><span class="s2">item</span><span class="s1">.</span><span class="s2">base</span><span class="s1">[</span><span class="s2">i </span><span class="s1">% </span><span class="s4">2</span><span class="s1">] - </span><span class="s2">relSubpoint</span><span class="s1">[</span><span class="s2">i </span><span class="s1">% </span><span class="s4">2</span><span class="s1">];</span>
          <span class="s1">}</span>
        <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">== </span><span class="s0">'h'</span><span class="s1">) {</span>
          <span class="s2">data</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] += </span><span class="s2">item</span><span class="s1">.</span><span class="s2">base</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] - </span><span class="s2">relSubpoint</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
        <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">== </span><span class="s0">'v'</span><span class="s1">) {</span>
          <span class="s2">data</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] += </span><span class="s2">item</span><span class="s1">.</span><span class="s2">base</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] - </span><span class="s2">relSubpoint</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
        <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">== </span><span class="s0">'a'</span><span class="s1">) {</span>
          <span class="s2">data</span><span class="s1">[</span><span class="s4">5</span><span class="s1">] += </span><span class="s2">item</span><span class="s1">.</span><span class="s2">base</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] - </span><span class="s2">relSubpoint</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
          <span class="s2">data</span><span class="s1">[</span><span class="s4">6</span><span class="s1">] += </span><span class="s2">item</span><span class="s1">.</span><span class="s2">base</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] - </span><span class="s2">relSubpoint</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
        <span class="s1">}</span>
        <span class="s2">roundData</span><span class="s1">(</span><span class="s2">data</span><span class="s1">);</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">== </span><span class="s0">'h'</span><span class="s1">) </span><span class="s2">relSubpoint</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] += </span><span class="s2">data</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
        <span class="s3">else if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">== </span><span class="s0">'v'</span><span class="s1">) </span><span class="s2">relSubpoint</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] += </span><span class="s2">data</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
        <span class="s3">else </span><span class="s1">{</span>
          <span class="s2">relSubpoint</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] += </span><span class="s2">data</span><span class="s1">[</span><span class="s2">data</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">2</span><span class="s1">];</span>
          <span class="s2">relSubpoint</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] += </span><span class="s2">data</span><span class="s1">[</span><span class="s2">data</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">1</span><span class="s1">];</span>
        <span class="s1">}</span>
        <span class="s2">roundData</span><span class="s1">(</span><span class="s2">relSubpoint</span><span class="s1">);</span>

        <span class="s3">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'M' </span><span class="s1">|| </span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'m'</span><span class="s1">) {</span>
          <span class="s2">pathBase</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] = </span><span class="s2">relSubpoint</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
          <span class="s2">pathBase</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] = </span><span class="s2">relSubpoint</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s5">// convert straight curves into lines segments</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">params</span><span class="s1">.</span><span class="s2">straightCurves</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span>
          <span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'c' </span><span class="s1">&amp;&amp; </span><span class="s2">isCurveStraightLine</span><span class="s1">(</span><span class="s2">data</span><span class="s1">)) ||</span>
          <span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'s' </span><span class="s1">&amp;&amp; </span><span class="s2">isCurveStraightLine</span><span class="s1">(</span><span class="s2">sdata</span><span class="s1">))</span>
        <span class="s1">) {</span>
          <span class="s3">if </span><span class="s1">(</span><span class="s2">next </span><span class="s1">&amp;&amp; </span><span class="s2">next</span><span class="s1">.</span><span class="s2">command </span><span class="s1">== </span><span class="s0">'s'</span><span class="s1">) </span><span class="s2">makeLonghand</span><span class="s1">(</span><span class="s2">next</span><span class="s1">, </span><span class="s2">data</span><span class="s1">); </span><span class="s5">// fix up next curve</span>
          <span class="s2">command </span><span class="s1">= </span><span class="s0">'l'</span><span class="s1">;</span>
          <span class="s2">data </span><span class="s1">= </span><span class="s2">data</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(-</span><span class="s4">2</span><span class="s1">);</span>
        <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'q' </span><span class="s1">&amp;&amp; </span><span class="s2">isCurveStraightLine</span><span class="s1">(</span><span class="s2">data</span><span class="s1">)) {</span>
          <span class="s3">if </span><span class="s1">(</span><span class="s2">next </span><span class="s1">&amp;&amp; </span><span class="s2">next</span><span class="s1">.</span><span class="s2">command </span><span class="s1">== </span><span class="s0">'t'</span><span class="s1">) </span><span class="s2">makeLonghand</span><span class="s1">(</span><span class="s2">next</span><span class="s1">, </span><span class="s2">data</span><span class="s1">); </span><span class="s5">// fix up next curve</span>
          <span class="s2">command </span><span class="s1">= </span><span class="s0">'l'</span><span class="s1">;</span>
          <span class="s2">data </span><span class="s1">= </span><span class="s2">data</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(-</span><span class="s4">2</span><span class="s1">);</span>
        <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span>
          <span class="s2">command </span><span class="s1">=== </span><span class="s0">'t' </span><span class="s1">&amp;&amp;</span>
          <span class="s2">prev</span><span class="s1">.</span><span class="s2">command </span><span class="s1">!== </span><span class="s0">'q' </span><span class="s1">&amp;&amp;</span>
          <span class="s2">prev</span><span class="s1">.</span><span class="s2">command </span><span class="s1">!== </span><span class="s0">'t'</span>
        <span class="s1">) {</span>
          <span class="s2">command </span><span class="s1">= </span><span class="s0">'l'</span><span class="s1">;</span>
          <span class="s2">data </span><span class="s1">= </span><span class="s2">data</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(-</span><span class="s4">2</span><span class="s1">);</span>
        <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'a' </span><span class="s1">&amp;&amp; (</span><span class="s2">data</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] === </span><span class="s4">0 </span><span class="s1">|| </span><span class="s2">data</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] === </span><span class="s4">0</span><span class="s1">)) {</span>
          <span class="s2">command </span><span class="s1">= </span><span class="s0">'l'</span><span class="s1">;</span>
          <span class="s2">data </span><span class="s1">= </span><span class="s2">data</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(-</span><span class="s4">2</span><span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s5">// horizontal and vertical line shorthands</span>
      <span class="s5">// l 50 0 → h 50</span>
      <span class="s5">// l 0 50 → v 50</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">params</span><span class="s1">.</span><span class="s2">lineShorthands </span><span class="s1">&amp;&amp; </span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'l'</span><span class="s1">) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">data</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] === </span><span class="s4">0</span><span class="s1">) {</span>
          <span class="s2">command </span><span class="s1">= </span><span class="s0">'h'</span><span class="s1">;</span>
          <span class="s2">data</span><span class="s1">.</span><span class="s2">pop</span><span class="s1">();</span>
        <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">data</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] === </span><span class="s4">0</span><span class="s1">) {</span>
          <span class="s2">command </span><span class="s1">= </span><span class="s0">'v'</span><span class="s1">;</span>
          <span class="s2">data</span><span class="s1">.</span><span class="s2">shift</span><span class="s1">();</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s5">// collapse repeated commands</span>
      <span class="s5">// h 20 h 30 -&gt; h 50</span>
      <span class="s3">if </span><span class="s1">(</span>
        <span class="s2">params</span><span class="s1">.</span><span class="s2">collapseRepeated </span><span class="s1">&amp;&amp;</span>
        <span class="s2">hasMarkerMid </span><span class="s1">=== </span><span class="s3">false </span><span class="s1">&amp;&amp;</span>
        <span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'m' </span><span class="s1">|| </span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'h' </span><span class="s1">|| </span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'v'</span><span class="s1">) &amp;&amp;</span>
        <span class="s2">prev</span><span class="s1">.</span><span class="s2">command </span><span class="s1">&amp;&amp;</span>
        <span class="s2">command </span><span class="s1">== </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">command</span><span class="s1">.</span><span class="s2">toLowerCase</span><span class="s1">() &amp;&amp;</span>
        <span class="s1">((</span><span class="s2">command </span><span class="s1">!= </span><span class="s0">'h' </span><span class="s1">&amp;&amp; </span><span class="s2">command </span><span class="s1">!= </span><span class="s0">'v'</span><span class="s1">) ||</span>
          <span class="s2">prev</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] &gt;= </span><span class="s4">0 </span><span class="s1">== </span><span class="s2">data</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] &gt;= </span><span class="s4">0</span><span class="s1">)</span>
      <span class="s1">) {</span>
        <span class="s2">prev</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] += </span><span class="s2">data</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">!= </span><span class="s0">'h' </span><span class="s1">&amp;&amp; </span><span class="s2">command </span><span class="s1">!= </span><span class="s0">'v'</span><span class="s1">) {</span>
          <span class="s2">prev</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] += </span><span class="s2">data</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
        <span class="s1">}</span>
        <span class="s2">prev</span><span class="s1">.</span><span class="s2">coords </span><span class="s1">= </span><span class="s2">item</span><span class="s1">.</span><span class="s2">coords</span><span class="s1">;</span>
        <span class="s2">path</span><span class="s1">[</span><span class="s2">index</span><span class="s1">] = </span><span class="s2">prev</span><span class="s1">;</span>
        <span class="s3">return false</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s5">// convert curves into smooth shorthands</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">params</span><span class="s1">.</span><span class="s2">curveSmoothShorthands </span><span class="s1">&amp;&amp; </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">command</span><span class="s1">) {</span>
        <span class="s5">// curveto</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'c'</span><span class="s1">) {</span>
          <span class="s5">// c + c → c + s</span>
          <span class="s3">if </span><span class="s1">(</span>
            <span class="s2">prev</span><span class="s1">.</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'c' </span><span class="s1">&amp;&amp;</span>
            <span class="s2">data</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] === -(</span><span class="s2">prev</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">2</span><span class="s1">] - </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">4</span><span class="s1">]) &amp;&amp;</span>
            <span class="s2">data</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] === -(</span><span class="s2">prev</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">3</span><span class="s1">] - </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">5</span><span class="s1">])</span>
          <span class="s1">) {</span>
            <span class="s2">command </span><span class="s1">= </span><span class="s0">'s'</span><span class="s1">;</span>
            <span class="s2">data </span><span class="s1">= </span><span class="s2">data</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s4">2</span><span class="s1">);</span>
          <span class="s1">}</span>

          <span class="s5">// s + c → s + s</span>
          <span class="s3">else if </span><span class="s1">(</span>
            <span class="s2">prev</span><span class="s1">.</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'s' </span><span class="s1">&amp;&amp;</span>
            <span class="s2">data</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] === -(</span><span class="s2">prev</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] - </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">2</span><span class="s1">]) &amp;&amp;</span>
            <span class="s2">data</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] === -(</span><span class="s2">prev</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] - </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">3</span><span class="s1">])</span>
          <span class="s1">) {</span>
            <span class="s2">command </span><span class="s1">= </span><span class="s0">'s'</span><span class="s1">;</span>
            <span class="s2">data </span><span class="s1">= </span><span class="s2">data</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s4">2</span><span class="s1">);</span>
          <span class="s1">}</span>

          <span class="s5">// [^cs] + c → [^cs] + s</span>
          <span class="s3">else if </span><span class="s1">(</span>
            <span class="s2">prev</span><span class="s1">.</span><span class="s2">command </span><span class="s1">!== </span><span class="s0">'c' </span><span class="s1">&amp;&amp;</span>
            <span class="s2">prev</span><span class="s1">.</span><span class="s2">command </span><span class="s1">!== </span><span class="s0">'s' </span><span class="s1">&amp;&amp;</span>
            <span class="s2">data</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] === </span><span class="s4">0 </span><span class="s1">&amp;&amp;</span>
            <span class="s2">data</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] === </span><span class="s4">0</span>
          <span class="s1">) {</span>
            <span class="s2">command </span><span class="s1">= </span><span class="s0">'s'</span><span class="s1">;</span>
            <span class="s2">data </span><span class="s1">= </span><span class="s2">data</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s4">2</span><span class="s1">);</span>
          <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s5">// quadratic Bézier curveto</span>
        <span class="s3">else if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'q'</span><span class="s1">) {</span>
          <span class="s5">// q + q → q + t</span>
          <span class="s3">if </span><span class="s1">(</span>
            <span class="s2">prev</span><span class="s1">.</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'q' </span><span class="s1">&amp;&amp;</span>
            <span class="s2">data</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] === </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">2</span><span class="s1">] - </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] &amp;&amp;</span>
            <span class="s2">data</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] === </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">3</span><span class="s1">] - </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">1</span><span class="s1">]</span>
          <span class="s1">) {</span>
            <span class="s2">command </span><span class="s1">= </span><span class="s0">'t'</span><span class="s1">;</span>
            <span class="s2">data </span><span class="s1">= </span><span class="s2">data</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s4">2</span><span class="s1">);</span>
          <span class="s1">}</span>

          <span class="s5">// t + q → t + t</span>
          <span class="s3">else if </span><span class="s1">(</span>
            <span class="s2">prev</span><span class="s1">.</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'t' </span><span class="s1">&amp;&amp;</span>
            <span class="s2">data</span><span class="s1">[</span><span class="s4">2</span><span class="s1">] === </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] &amp;&amp;</span>
            <span class="s2">data</span><span class="s1">[</span><span class="s4">3</span><span class="s1">] === </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s4">1</span><span class="s1">]</span>
          <span class="s1">) {</span>
            <span class="s2">command </span><span class="s1">= </span><span class="s0">'t'</span><span class="s1">;</span>
            <span class="s2">data </span><span class="s1">= </span><span class="s2">data</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">(</span><span class="s4">2</span><span class="s1">);</span>
          <span class="s1">}</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s5">// remove useless non-first path segments</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">params</span><span class="s1">.</span><span class="s2">removeUseless </span><span class="s1">&amp;&amp; !</span><span class="s2">maybeHasStrokeAndLinecap</span><span class="s1">) {</span>
        <span class="s5">// l 0,0 / h 0 / v 0 / q 0,0 0,0 / t 0,0 / c 0,0 0,0 0,0 / s 0,0 0,0</span>
        <span class="s3">if </span><span class="s1">(</span>
          <span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'l' </span><span class="s1">||</span>
            <span class="s2">command </span><span class="s1">=== </span><span class="s0">'h' </span><span class="s1">||</span>
            <span class="s2">command </span><span class="s1">=== </span><span class="s0">'v' </span><span class="s1">||</span>
            <span class="s2">command </span><span class="s1">=== </span><span class="s0">'q' </span><span class="s1">||</span>
            <span class="s2">command </span><span class="s1">=== </span><span class="s0">'t' </span><span class="s1">||</span>
            <span class="s2">command </span><span class="s1">=== </span><span class="s0">'c' </span><span class="s1">||</span>
            <span class="s2">command </span><span class="s1">=== </span><span class="s0">'s'</span><span class="s1">) &amp;&amp;</span>
          <span class="s2">data</span><span class="s1">.</span><span class="s2">every</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">i</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s2">i </span><span class="s1">=== </span><span class="s4">0</span><span class="s1">;</span>
          <span class="s1">})</span>
        <span class="s1">) {</span>
          <span class="s2">path</span><span class="s1">[</span><span class="s2">index</span><span class="s1">] = </span><span class="s2">prev</span><span class="s1">;</span>
          <span class="s3">return false</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s5">// a 25,25 -30 0,1 0,0</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'a' </span><span class="s1">&amp;&amp; </span><span class="s2">data</span><span class="s1">[</span><span class="s4">5</span><span class="s1">] === </span><span class="s4">0 </span><span class="s1">&amp;&amp; </span><span class="s2">data</span><span class="s1">[</span><span class="s4">6</span><span class="s1">] === </span><span class="s4">0</span><span class="s1">) {</span>
          <span class="s2">path</span><span class="s1">[</span><span class="s2">index</span><span class="s1">] = </span><span class="s2">prev</span><span class="s1">;</span>
          <span class="s3">return false</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s2">item</span><span class="s1">.</span><span class="s2">command </span><span class="s1">= </span><span class="s2">command</span><span class="s1">;</span>
      <span class="s2">item</span><span class="s1">.</span><span class="s2">args </span><span class="s1">= </span><span class="s2">data</span><span class="s1">;</span>

      <span class="s2">prev </span><span class="s1">= </span><span class="s2">item</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s5">// z resets coordinates</span>
      <span class="s2">relSubpoint</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] = </span><span class="s2">pathBase</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
      <span class="s2">relSubpoint</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] = </span><span class="s2">pathBase</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s2">prev</span><span class="s1">.</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'Z' </span><span class="s1">|| </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'z'</span><span class="s1">) </span><span class="s3">return false</span><span class="s1">;</span>
      <span class="s2">prev </span><span class="s1">= </span><span class="s2">item</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">return true</span><span class="s1">;</span>
  <span class="s1">});</span>

  <span class="s3">return </span><span class="s2">path</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s6">/**</span>
 <span class="s6">* Writes data in shortest form using absolute or relative coordinates.</span>
 <span class="s6">*</span>
 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Array} data input path data</span>
 <span class="s6">* </span><span class="s7">@return </span><span class="s6">{Boolean} output</span>
 <span class="s6">*/</span>
<span class="s3">function </span><span class="s2">convertToMixed</span><span class="s1">(</span><span class="s2">path</span><span class="s1">, </span><span class="s2">params</span><span class="s1">) {</span>
  <span class="s3">var </span><span class="s2">prev </span><span class="s1">= </span><span class="s2">path</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>

  <span class="s2">path </span><span class="s1">= </span><span class="s2">path</span><span class="s1">.</span><span class="s2">filter</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">item</span><span class="s1">, </span><span class="s2">index</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">index </span><span class="s1">== </span><span class="s4">0</span><span class="s1">) </span><span class="s3">return true</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'Z' </span><span class="s1">|| </span><span class="s2">item</span><span class="s1">.</span><span class="s2">command </span><span class="s1">=== </span><span class="s0">'z'</span><span class="s1">) {</span>
      <span class="s2">prev </span><span class="s1">= </span><span class="s2">item</span><span class="s1">;</span>
      <span class="s3">return true</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">var </span><span class="s2">command </span><span class="s1">= </span><span class="s2">item</span><span class="s1">.</span><span class="s2">command</span><span class="s1">,</span>
      <span class="s2">data </span><span class="s1">= </span><span class="s2">item</span><span class="s1">.</span><span class="s2">args</span><span class="s1">,</span>
      <span class="s2">adata </span><span class="s1">= </span><span class="s2">data</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">();</span>

    <span class="s3">if </span><span class="s1">(</span>
      <span class="s2">command </span><span class="s1">=== </span><span class="s0">'m' </span><span class="s1">||</span>
      <span class="s2">command </span><span class="s1">=== </span><span class="s0">'l' </span><span class="s1">||</span>
      <span class="s2">command </span><span class="s1">=== </span><span class="s0">'t' </span><span class="s1">||</span>
      <span class="s2">command </span><span class="s1">=== </span><span class="s0">'q' </span><span class="s1">||</span>
      <span class="s2">command </span><span class="s1">=== </span><span class="s0">'s' </span><span class="s1">||</span>
      <span class="s2">command </span><span class="s1">=== </span><span class="s0">'c'</span>
    <span class="s1">) {</span>
      <span class="s3">for </span><span class="s1">(</span><span class="s3">var </span><span class="s2">i </span><span class="s1">= </span><span class="s2">adata</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">i</span><span class="s1">--; ) {</span>
        <span class="s2">adata</span><span class="s1">[</span><span class="s2">i</span><span class="s1">] += </span><span class="s2">item</span><span class="s1">.</span><span class="s2">base</span><span class="s1">[</span><span class="s2">i </span><span class="s1">% </span><span class="s4">2</span><span class="s1">];</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">== </span><span class="s0">'h'</span><span class="s1">) {</span>
      <span class="s2">adata</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] += </span><span class="s2">item</span><span class="s1">.</span><span class="s2">base</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">== </span><span class="s0">'v'</span><span class="s1">) {</span>
      <span class="s2">adata</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] += </span><span class="s2">item</span><span class="s1">.</span><span class="s2">base</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s2">command </span><span class="s1">== </span><span class="s0">'a'</span><span class="s1">) {</span>
      <span class="s2">adata</span><span class="s1">[</span><span class="s4">5</span><span class="s1">] += </span><span class="s2">item</span><span class="s1">.</span><span class="s2">base</span><span class="s1">[</span><span class="s4">0</span><span class="s1">];</span>
      <span class="s2">adata</span><span class="s1">[</span><span class="s4">6</span><span class="s1">] += </span><span class="s2">item</span><span class="s1">.</span><span class="s2">base</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>
    <span class="s1">}</span>

    <span class="s2">roundData</span><span class="s1">(</span><span class="s2">adata</span><span class="s1">);</span>

    <span class="s3">var </span><span class="s2">absoluteDataStr </span><span class="s1">= </span><span class="s2">cleanupOutData</span><span class="s1">(</span><span class="s2">adata</span><span class="s1">, </span><span class="s2">params</span><span class="s1">),</span>
      <span class="s2">relativeDataStr </span><span class="s1">= </span><span class="s2">cleanupOutData</span><span class="s1">(</span><span class="s2">data</span><span class="s1">, </span><span class="s2">params</span><span class="s1">);</span>

    <span class="s5">// Convert to absolute coordinates if it's shorter or forceAbsolutePath is true.</span>
    <span class="s5">// v-20 -&gt; V0</span>
    <span class="s5">// Don't convert if it fits following previous command.</span>
    <span class="s5">// l20 30-10-50 instead of l20 30L20 30</span>
    <span class="s3">if </span><span class="s1">(</span>
      <span class="s2">params</span><span class="s1">.</span><span class="s2">forceAbsolutePath </span><span class="s1">||</span>
      <span class="s1">(</span><span class="s2">absoluteDataStr</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&lt; </span><span class="s2">relativeDataStr</span><span class="s1">.</span><span class="s2">length </span><span class="s1">&amp;&amp;</span>
        <span class="s1">!(</span>
          <span class="s2">params</span><span class="s1">.</span><span class="s2">negativeExtraSpace </span><span class="s1">&amp;&amp;</span>
          <span class="s2">command </span><span class="s1">== </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">command </span><span class="s1">&amp;&amp;</span>
          <span class="s2">prev</span><span class="s1">.</span><span class="s2">command</span><span class="s1">.</span><span class="s2">charCodeAt</span><span class="s1">(</span><span class="s4">0</span><span class="s1">) &gt; </span><span class="s4">96 </span><span class="s1">&amp;&amp;</span>
          <span class="s2">absoluteDataStr</span><span class="s1">.</span><span class="s2">length </span><span class="s1">== </span><span class="s2">relativeDataStr</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">1 </span><span class="s1">&amp;&amp;</span>
          <span class="s1">(</span><span class="s2">data</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] &lt; </span><span class="s4">0 </span><span class="s1">||</span>
            <span class="s1">(</span><span class="s8">/^0\./</span><span class="s1">.</span><span class="s2">test</span><span class="s1">(</span><span class="s2">data</span><span class="s1">[</span><span class="s4">0</span><span class="s1">]) &amp;&amp; </span><span class="s2">prev</span><span class="s1">.</span><span class="s2">args</span><span class="s1">[</span><span class="s2">prev</span><span class="s1">.</span><span class="s2">args</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">1</span><span class="s1">] % </span><span class="s4">1</span><span class="s1">))</span>
        <span class="s1">))</span>
    <span class="s1">) {</span>
      <span class="s2">item</span><span class="s1">.</span><span class="s2">command </span><span class="s1">= </span><span class="s2">command</span><span class="s1">.</span><span class="s2">toUpperCase</span><span class="s1">();</span>
      <span class="s2">item</span><span class="s1">.</span><span class="s2">args </span><span class="s1">= </span><span class="s2">adata</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">prev </span><span class="s1">= </span><span class="s2">item</span><span class="s1">;</span>

    <span class="s3">return true</span><span class="s1">;</span>
  <span class="s1">});</span>

  <span class="s3">return </span><span class="s2">path</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s6">/**</span>
 <span class="s6">* Checks if curve is convex. Control points of such a curve must form</span>
 <span class="s6">* a convex quadrilateral with diagonals crosspoint inside of it.</span>
 <span class="s6">*</span>
 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Array} data input path data</span>
 <span class="s6">* </span><span class="s7">@return </span><span class="s6">{Boolean} output</span>
 <span class="s6">*/</span>
<span class="s3">function </span><span class="s2">isConvex</span><span class="s1">(</span><span class="s2">data</span><span class="s1">) {</span>
  <span class="s3">var </span><span class="s2">center </span><span class="s1">= </span><span class="s2">getIntersection</span><span class="s1">([</span>
    <span class="s4">0</span><span class="s1">,</span>
    <span class="s4">0</span><span class="s1">,</span>
    <span class="s2">data</span><span class="s1">[</span><span class="s4">2</span><span class="s1">],</span>
    <span class="s2">data</span><span class="s1">[</span><span class="s4">3</span><span class="s1">],</span>
    <span class="s2">data</span><span class="s1">[</span><span class="s4">0</span><span class="s1">],</span>
    <span class="s2">data</span><span class="s1">[</span><span class="s4">1</span><span class="s1">],</span>
    <span class="s2">data</span><span class="s1">[</span><span class="s4">4</span><span class="s1">],</span>
    <span class="s2">data</span><span class="s1">[</span><span class="s4">5</span><span class="s1">],</span>
  <span class="s1">]);</span>

  <span class="s3">return </span><span class="s1">(</span>
    <span class="s2">center </span><span class="s1">&amp;&amp;</span>
    <span class="s2">data</span><span class="s1">[</span><span class="s4">2</span><span class="s1">] &lt; </span><span class="s2">center</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] == </span><span class="s2">center</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] &lt; </span><span class="s4">0 </span><span class="s1">&amp;&amp;</span>
    <span class="s2">data</span><span class="s1">[</span><span class="s4">3</span><span class="s1">] &lt; </span><span class="s2">center</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] == </span><span class="s2">center</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] &lt; </span><span class="s4">0 </span><span class="s1">&amp;&amp;</span>
    <span class="s2">data</span><span class="s1">[</span><span class="s4">4</span><span class="s1">] &lt; </span><span class="s2">center</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] == </span><span class="s2">center</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] &lt; </span><span class="s2">data</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] &amp;&amp;</span>
    <span class="s2">data</span><span class="s1">[</span><span class="s4">5</span><span class="s1">] &lt; </span><span class="s2">center</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] == </span><span class="s2">center</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] &lt; </span><span class="s2">data</span><span class="s1">[</span><span class="s4">1</span><span class="s1">]</span>
  <span class="s1">);</span>
<span class="s1">}</span>

<span class="s6">/**</span>
 <span class="s6">* Computes lines equations by two points and returns their intersection point.</span>
 <span class="s6">*</span>
 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Array} coords 8 numbers for 4 pairs of coordinates (x,y)</span>
 <span class="s6">* </span><span class="s7">@return </span><span class="s6">{Array|undefined} output coordinate of lines' crosspoint</span>
 <span class="s6">*/</span>
<span class="s3">function </span><span class="s2">getIntersection</span><span class="s1">(</span><span class="s2">coords</span><span class="s1">) {</span>
  <span class="s5">// Prev line equation parameters.</span>
  <span class="s3">var </span><span class="s2">a1 </span><span class="s1">= </span><span class="s2">coords</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] - </span><span class="s2">coords</span><span class="s1">[</span><span class="s4">3</span><span class="s1">], </span><span class="s5">// y1 - y2</span>
    <span class="s2">b1 </span><span class="s1">= </span><span class="s2">coords</span><span class="s1">[</span><span class="s4">2</span><span class="s1">] - </span><span class="s2">coords</span><span class="s1">[</span><span class="s4">0</span><span class="s1">], </span><span class="s5">// x2 - x1</span>
    <span class="s2">c1 </span><span class="s1">= </span><span class="s2">coords</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] * </span><span class="s2">coords</span><span class="s1">[</span><span class="s4">3</span><span class="s1">] - </span><span class="s2">coords</span><span class="s1">[</span><span class="s4">2</span><span class="s1">] * </span><span class="s2">coords</span><span class="s1">[</span><span class="s4">1</span><span class="s1">], </span><span class="s5">// x1 * y2 - x2 * y1</span>
    <span class="s5">// Next line equation parameters</span>
    <span class="s2">a2 </span><span class="s1">= </span><span class="s2">coords</span><span class="s1">[</span><span class="s4">5</span><span class="s1">] - </span><span class="s2">coords</span><span class="s1">[</span><span class="s4">7</span><span class="s1">], </span><span class="s5">// y1 - y2</span>
    <span class="s2">b2 </span><span class="s1">= </span><span class="s2">coords</span><span class="s1">[</span><span class="s4">6</span><span class="s1">] - </span><span class="s2">coords</span><span class="s1">[</span><span class="s4">4</span><span class="s1">], </span><span class="s5">// x2 - x1</span>
    <span class="s2">c2 </span><span class="s1">= </span><span class="s2">coords</span><span class="s1">[</span><span class="s4">4</span><span class="s1">] * </span><span class="s2">coords</span><span class="s1">[</span><span class="s4">7</span><span class="s1">] - </span><span class="s2">coords</span><span class="s1">[</span><span class="s4">5</span><span class="s1">] * </span><span class="s2">coords</span><span class="s1">[</span><span class="s4">6</span><span class="s1">], </span><span class="s5">// x1 * y2 - x2 * y1</span>
    <span class="s2">denom </span><span class="s1">= </span><span class="s2">a1 </span><span class="s1">* </span><span class="s2">b2 </span><span class="s1">- </span><span class="s2">a2 </span><span class="s1">* </span><span class="s2">b1</span><span class="s1">;</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s2">denom</span><span class="s1">) </span><span class="s3">return</span><span class="s1">; </span><span class="s5">// parallel lines havn't an intersection</span>

  <span class="s3">var </span><span class="s2">cross </span><span class="s1">= [(</span><span class="s2">b1 </span><span class="s1">* </span><span class="s2">c2 </span><span class="s1">- </span><span class="s2">b2 </span><span class="s1">* </span><span class="s2">c1</span><span class="s1">) / </span><span class="s2">denom</span><span class="s1">, (</span><span class="s2">a1 </span><span class="s1">* </span><span class="s2">c2 </span><span class="s1">- </span><span class="s2">a2 </span><span class="s1">* </span><span class="s2">c1</span><span class="s1">) / -</span><span class="s2">denom</span><span class="s1">];</span>
  <span class="s3">if </span><span class="s1">(</span>
    <span class="s1">!</span><span class="s2">isNaN</span><span class="s1">(</span><span class="s2">cross</span><span class="s1">[</span><span class="s4">0</span><span class="s1">]) &amp;&amp;</span>
    <span class="s1">!</span><span class="s2">isNaN</span><span class="s1">(</span><span class="s2">cross</span><span class="s1">[</span><span class="s4">1</span><span class="s1">]) &amp;&amp;</span>
    <span class="s2">isFinite</span><span class="s1">(</span><span class="s2">cross</span><span class="s1">[</span><span class="s4">0</span><span class="s1">]) &amp;&amp;</span>
    <span class="s2">isFinite</span><span class="s1">(</span><span class="s2">cross</span><span class="s1">[</span><span class="s4">1</span><span class="s1">])</span>
  <span class="s1">) {</span>
    <span class="s3">return </span><span class="s2">cross</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s6">/**</span>
 <span class="s6">* Decrease accuracy of floating-point numbers</span>
 <span class="s6">* in path data keeping a specified number of decimals.</span>
 <span class="s6">* Smart rounds values like 2.3491 to 2.35 instead of 2.349.</span>
 <span class="s6">* Doesn't apply &quot;smartness&quot; if the number precision fits already.</span>
 <span class="s6">*</span>
 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Array} data input data array</span>
 <span class="s6">* </span><span class="s7">@return </span><span class="s6">{Array} output data array</span>
 <span class="s6">*/</span>
<span class="s3">function </span><span class="s2">strongRound</span><span class="s1">(</span><span class="s2">data</span><span class="s1">) {</span>
  <span class="s3">for </span><span class="s1">(</span><span class="s3">var </span><span class="s2">i </span><span class="s1">= </span><span class="s2">data</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">i</span><span class="s1">-- &gt; </span><span class="s4">0</span><span class="s1">; ) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">data</span><span class="s1">[</span><span class="s2">i</span><span class="s1">].</span><span class="s2">toFixed</span><span class="s1">(</span><span class="s2">precision</span><span class="s1">) != </span><span class="s2">data</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]) {</span>
      <span class="s3">var </span><span class="s2">rounded </span><span class="s1">= +</span><span class="s2">data</span><span class="s1">[</span><span class="s2">i</span><span class="s1">].</span><span class="s2">toFixed</span><span class="s1">(</span><span class="s2">precision </span><span class="s1">- </span><span class="s4">1</span><span class="s1">);</span>
      <span class="s2">data</span><span class="s1">[</span><span class="s2">i</span><span class="s1">] =</span>
        <span class="s1">+</span><span class="s2">Math</span><span class="s1">.</span><span class="s2">abs</span><span class="s1">(</span><span class="s2">rounded </span><span class="s1">- </span><span class="s2">data</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]).</span><span class="s2">toFixed</span><span class="s1">(</span><span class="s2">precision </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">) &gt;= </span><span class="s2">error</span>
          <span class="s1">? +</span><span class="s2">data</span><span class="s1">[</span><span class="s2">i</span><span class="s1">].</span><span class="s2">toFixed</span><span class="s1">(</span><span class="s2">precision</span><span class="s1">)</span>
          <span class="s1">: </span><span class="s2">rounded</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
  <span class="s3">return </span><span class="s2">data</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s6">/**</span>
 <span class="s6">* Simple rounding function if precision is 0.</span>
 <span class="s6">*</span>
 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Array} data input data array</span>
 <span class="s6">* </span><span class="s7">@return </span><span class="s6">{Array} output data array</span>
 <span class="s6">*/</span>
<span class="s3">function </span><span class="s2">round</span><span class="s1">(</span><span class="s2">data</span><span class="s1">) {</span>
  <span class="s3">for </span><span class="s1">(</span><span class="s3">var </span><span class="s2">i </span><span class="s1">= </span><span class="s2">data</span><span class="s1">.</span><span class="s2">length</span><span class="s1">; </span><span class="s2">i</span><span class="s1">-- &gt; </span><span class="s4">0</span><span class="s1">; ) {</span>
    <span class="s2">data</span><span class="s1">[</span><span class="s2">i</span><span class="s1">] = </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">round</span><span class="s1">(</span><span class="s2">data</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]);</span>
  <span class="s1">}</span>
  <span class="s3">return </span><span class="s2">data</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s6">/**</span>
 <span class="s6">* Checks if a curve is a straight line by measuring distance</span>
 <span class="s6">* from middle points to the line formed by end points.</span>
 <span class="s6">*</span>
 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Array} xs array of curve points x-coordinates</span>
 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Array} ys array of curve points y-coordinates</span>
 <span class="s6">* </span><span class="s7">@return </span><span class="s6">{Boolean}</span>
 <span class="s6">*/</span>

<span class="s3">function </span><span class="s2">isCurveStraightLine</span><span class="s1">(</span><span class="s2">data</span><span class="s1">) {</span>
  <span class="s5">// Get line equation a·x + b·y + c = 0 coefficients a, b (c = 0) by start and end points.</span>
  <span class="s3">var </span><span class="s2">i </span><span class="s1">= </span><span class="s2">data</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">2</span><span class="s1">,</span>
    <span class="s2">a </span><span class="s1">= -</span><span class="s2">data</span><span class="s1">[</span><span class="s2">i </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">], </span><span class="s5">// y1 − y2 (y1 = 0)</span>
    <span class="s2">b </span><span class="s1">= </span><span class="s2">data</span><span class="s1">[</span><span class="s2">i</span><span class="s1">], </span><span class="s5">// x2 − x1 (x1 = 0)</span>
    <span class="s2">d </span><span class="s1">= </span><span class="s4">1 </span><span class="s1">/ (</span><span class="s2">a </span><span class="s1">* </span><span class="s2">a </span><span class="s1">+ </span><span class="s2">b </span><span class="s1">* </span><span class="s2">b</span><span class="s1">); </span><span class="s5">// same part for all points</span>

  <span class="s3">if </span><span class="s1">(</span><span class="s2">i </span><span class="s1">&lt;= </span><span class="s4">1 </span><span class="s1">|| !</span><span class="s2">isFinite</span><span class="s1">(</span><span class="s2">d</span><span class="s1">)) </span><span class="s3">return false</span><span class="s1">; </span><span class="s5">// curve that ends at start point isn't the case</span>

  <span class="s5">// Distance from point (x0, y0) to the line is sqrt((c − a·x0 − b·y0)² / (a² + b²))</span>
  <span class="s3">while </span><span class="s1">((</span><span class="s2">i </span><span class="s1">-= </span><span class="s4">2</span><span class="s1">) &gt;= </span><span class="s4">0</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">Math</span><span class="s1">.</span><span class="s2">sqrt</span><span class="s1">(</span><span class="s2">Math</span><span class="s1">.</span><span class="s2">pow</span><span class="s1">(</span><span class="s2">a </span><span class="s1">* </span><span class="s2">data</span><span class="s1">[</span><span class="s2">i</span><span class="s1">] + </span><span class="s2">b </span><span class="s1">* </span><span class="s2">data</span><span class="s1">[</span><span class="s2">i </span><span class="s1">+ </span><span class="s4">1</span><span class="s1">], </span><span class="s4">2</span><span class="s1">) * </span><span class="s2">d</span><span class="s1">) &gt; </span><span class="s2">error</span><span class="s1">)</span>
      <span class="s3">return false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">return true</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s6">/**</span>
 <span class="s6">* Converts next curve from shorthand to full form using the current curve data.</span>
 <span class="s6">*</span>
 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Object} item curve to convert</span>
 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Array} data current curve data</span>
 <span class="s6">*/</span>

<span class="s3">function </span><span class="s2">makeLonghand</span><span class="s1">(</span><span class="s2">item</span><span class="s1">, </span><span class="s2">data</span><span class="s1">) {</span>
  <span class="s3">switch </span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">command</span><span class="s1">) {</span>
    <span class="s3">case </span><span class="s0">'s'</span><span class="s1">:</span>
      <span class="s2">item</span><span class="s1">.</span><span class="s2">command </span><span class="s1">= </span><span class="s0">'c'</span><span class="s1">;</span>
      <span class="s3">break</span><span class="s1">;</span>
    <span class="s3">case </span><span class="s0">'t'</span><span class="s1">:</span>
      <span class="s2">item</span><span class="s1">.</span><span class="s2">command </span><span class="s1">= </span><span class="s0">'q'</span><span class="s1">;</span>
      <span class="s3">break</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s2">item</span><span class="s1">.</span><span class="s2">args</span><span class="s1">.</span><span class="s2">unshift</span><span class="s1">(</span>
    <span class="s2">data</span><span class="s1">[</span><span class="s2">data</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">2</span><span class="s1">] - </span><span class="s2">data</span><span class="s1">[</span><span class="s2">data</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">4</span><span class="s1">],</span>
    <span class="s2">data</span><span class="s1">[</span><span class="s2">data</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">1</span><span class="s1">] - </span><span class="s2">data</span><span class="s1">[</span><span class="s2">data</span><span class="s1">.</span><span class="s2">length </span><span class="s1">- </span><span class="s4">3</span><span class="s1">]</span>
  <span class="s1">);</span>
  <span class="s3">return </span><span class="s2">item</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s6">/**</span>
 <span class="s6">* Returns distance between two points</span>
 <span class="s6">*</span>
 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Array} point1 first point coordinates</span>
 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Array} point2 second point coordinates</span>
 <span class="s6">* </span><span class="s7">@return </span><span class="s6">{Number} distance</span>
 <span class="s6">*/</span>

<span class="s3">function </span><span class="s2">getDistance</span><span class="s1">(</span><span class="s2">point1</span><span class="s1">, </span><span class="s2">point2</span><span class="s1">) {</span>
  <span class="s3">return </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">hypot</span><span class="s1">(</span><span class="s2">point1</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] - </span><span class="s2">point2</span><span class="s1">[</span><span class="s4">0</span><span class="s1">], </span><span class="s2">point1</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] - </span><span class="s2">point2</span><span class="s1">[</span><span class="s4">1</span><span class="s1">]);</span>
<span class="s1">}</span>

<span class="s6">/**</span>
 <span class="s6">* Returns coordinates of the curve point corresponding to the certain t</span>
 <span class="s6">* a·(1 - t)³·p1 + b·(1 - t)²·t·p2 + c·(1 - t)·t²·p3 + d·t³·p4,</span>
 <span class="s6">* where pN are control points and p1 is zero due to relative coordinates.</span>
 <span class="s6">*</span>
 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Array} curve array of curve points coordinates</span>
 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Number} t parametric position from 0 to 1</span>
 <span class="s6">* </span><span class="s7">@return </span><span class="s6">{Array} Point coordinates</span>
 <span class="s6">*/</span>

<span class="s3">function </span><span class="s2">getCubicBezierPoint</span><span class="s1">(</span><span class="s2">curve</span><span class="s1">, </span><span class="s2">t</span><span class="s1">) {</span>
  <span class="s3">var </span><span class="s2">sqrT </span><span class="s1">= </span><span class="s2">t </span><span class="s1">* </span><span class="s2">t</span><span class="s1">,</span>
    <span class="s2">cubT </span><span class="s1">= </span><span class="s2">sqrT </span><span class="s1">* </span><span class="s2">t</span><span class="s1">,</span>
    <span class="s2">mt </span><span class="s1">= </span><span class="s4">1 </span><span class="s1">- </span><span class="s2">t</span><span class="s1">,</span>
    <span class="s2">sqrMt </span><span class="s1">= </span><span class="s2">mt </span><span class="s1">* </span><span class="s2">mt</span><span class="s1">;</span>

  <span class="s3">return </span><span class="s1">[</span>
    <span class="s4">3 </span><span class="s1">* </span><span class="s2">sqrMt </span><span class="s1">* </span><span class="s2">t </span><span class="s1">* </span><span class="s2">curve</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] + </span><span class="s4">3 </span><span class="s1">* </span><span class="s2">mt </span><span class="s1">* </span><span class="s2">sqrT </span><span class="s1">* </span><span class="s2">curve</span><span class="s1">[</span><span class="s4">2</span><span class="s1">] + </span><span class="s2">cubT </span><span class="s1">* </span><span class="s2">curve</span><span class="s1">[</span><span class="s4">4</span><span class="s1">],</span>
    <span class="s4">3 </span><span class="s1">* </span><span class="s2">sqrMt </span><span class="s1">* </span><span class="s2">t </span><span class="s1">* </span><span class="s2">curve</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] + </span><span class="s4">3 </span><span class="s1">* </span><span class="s2">mt </span><span class="s1">* </span><span class="s2">sqrT </span><span class="s1">* </span><span class="s2">curve</span><span class="s1">[</span><span class="s4">3</span><span class="s1">] + </span><span class="s2">cubT </span><span class="s1">* </span><span class="s2">curve</span><span class="s1">[</span><span class="s4">5</span><span class="s1">],</span>
  <span class="s1">];</span>
<span class="s1">}</span>

<span class="s6">/**</span>
 <span class="s6">* Finds circle by 3 points of the curve and checks if the curve fits the found circle.</span>
 <span class="s6">*</span>
 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Array} curve</span>
 <span class="s6">* </span><span class="s7">@return </span><span class="s6">{Object|undefined} circle</span>
 <span class="s6">*/</span>

<span class="s3">function </span><span class="s2">findCircle</span><span class="s1">(</span><span class="s2">curve</span><span class="s1">) {</span>
  <span class="s3">var </span><span class="s2">midPoint </span><span class="s1">= </span><span class="s2">getCubicBezierPoint</span><span class="s1">(</span><span class="s2">curve</span><span class="s1">, </span><span class="s4">1 </span><span class="s1">/ </span><span class="s4">2</span><span class="s1">),</span>
    <span class="s2">m1 </span><span class="s1">= [</span><span class="s2">midPoint</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] / </span><span class="s4">2</span><span class="s1">, </span><span class="s2">midPoint</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] / </span><span class="s4">2</span><span class="s1">],</span>
    <span class="s2">m2 </span><span class="s1">= [(</span><span class="s2">midPoint</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] + </span><span class="s2">curve</span><span class="s1">[</span><span class="s4">4</span><span class="s1">]) / </span><span class="s4">2</span><span class="s1">, (</span><span class="s2">midPoint</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] + </span><span class="s2">curve</span><span class="s1">[</span><span class="s4">5</span><span class="s1">]) / </span><span class="s4">2</span><span class="s1">],</span>
    <span class="s2">center </span><span class="s1">= </span><span class="s2">getIntersection</span><span class="s1">([</span>
      <span class="s2">m1</span><span class="s1">[</span><span class="s4">0</span><span class="s1">],</span>
      <span class="s2">m1</span><span class="s1">[</span><span class="s4">1</span><span class="s1">],</span>
      <span class="s2">m1</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] + </span><span class="s2">m1</span><span class="s1">[</span><span class="s4">1</span><span class="s1">],</span>
      <span class="s2">m1</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] - </span><span class="s2">m1</span><span class="s1">[</span><span class="s4">0</span><span class="s1">],</span>
      <span class="s2">m2</span><span class="s1">[</span><span class="s4">0</span><span class="s1">],</span>
      <span class="s2">m2</span><span class="s1">[</span><span class="s4">1</span><span class="s1">],</span>
      <span class="s2">m2</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] + (</span><span class="s2">m2</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] - </span><span class="s2">midPoint</span><span class="s1">[</span><span class="s4">1</span><span class="s1">]),</span>
      <span class="s2">m2</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] - (</span><span class="s2">m2</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] - </span><span class="s2">midPoint</span><span class="s1">[</span><span class="s4">0</span><span class="s1">]),</span>
    <span class="s1">]),</span>
    <span class="s2">radius </span><span class="s1">= </span><span class="s2">center </span><span class="s1">&amp;&amp; </span><span class="s2">getDistance</span><span class="s1">([</span><span class="s4">0</span><span class="s1">, </span><span class="s4">0</span><span class="s1">], </span><span class="s2">center</span><span class="s1">),</span>
    <span class="s2">tolerance </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">min</span><span class="s1">(</span><span class="s2">arcThreshold </span><span class="s1">* </span><span class="s2">error</span><span class="s1">, (</span><span class="s2">arcTolerance </span><span class="s1">* </span><span class="s2">radius</span><span class="s1">) / </span><span class="s4">100</span><span class="s1">);</span>

  <span class="s3">if </span><span class="s1">(</span>
    <span class="s2">center </span><span class="s1">&amp;&amp;</span>
    <span class="s2">radius </span><span class="s1">&lt; </span><span class="s4">1e15 </span><span class="s1">&amp;&amp;</span>
    <span class="s1">[</span><span class="s4">1 </span><span class="s1">/ </span><span class="s4">4</span><span class="s1">, </span><span class="s4">3 </span><span class="s1">/ </span><span class="s4">4</span><span class="s1">].</span><span class="s2">every</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">point</span><span class="s1">) {</span>
      <span class="s3">return </span><span class="s1">(</span>
        <span class="s2">Math</span><span class="s1">.</span><span class="s2">abs</span><span class="s1">(</span>
          <span class="s2">getDistance</span><span class="s1">(</span><span class="s2">getCubicBezierPoint</span><span class="s1">(</span><span class="s2">curve</span><span class="s1">, </span><span class="s2">point</span><span class="s1">), </span><span class="s2">center</span><span class="s1">) - </span><span class="s2">radius</span>
        <span class="s1">) &lt;= </span><span class="s2">tolerance</span>
      <span class="s1">);</span>
    <span class="s1">})</span>
  <span class="s1">)</span>
    <span class="s3">return </span><span class="s1">{ </span><span class="s2">center</span><span class="s1">: </span><span class="s2">center</span><span class="s1">, </span><span class="s2">radius</span><span class="s1">: </span><span class="s2">radius </span><span class="s1">};</span>
<span class="s1">}</span>

<span class="s6">/**</span>
 <span class="s6">* Checks if a curve fits the given circle.</span>
 <span class="s6">*</span>
 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Object} circle</span>
 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Array} curve</span>
 <span class="s6">* </span><span class="s7">@return </span><span class="s6">{Boolean}</span>
 <span class="s6">*/</span>

<span class="s3">function </span><span class="s2">isArc</span><span class="s1">(</span><span class="s2">curve</span><span class="s1">, </span><span class="s2">circle</span><span class="s1">) {</span>
  <span class="s3">var </span><span class="s2">tolerance </span><span class="s1">= </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">min</span><span class="s1">(</span>
    <span class="s2">arcThreshold </span><span class="s1">* </span><span class="s2">error</span><span class="s1">,</span>
    <span class="s1">(</span><span class="s2">arcTolerance </span><span class="s1">* </span><span class="s2">circle</span><span class="s1">.</span><span class="s2">radius</span><span class="s1">) / </span><span class="s4">100</span>
  <span class="s1">);</span>

  <span class="s3">return </span><span class="s1">[</span><span class="s4">0</span><span class="s1">, </span><span class="s4">1 </span><span class="s1">/ </span><span class="s4">4</span><span class="s1">, </span><span class="s4">1 </span><span class="s1">/ </span><span class="s4">2</span><span class="s1">, </span><span class="s4">3 </span><span class="s1">/ </span><span class="s4">4</span><span class="s1">, </span><span class="s4">1</span><span class="s1">].</span><span class="s2">every</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">point</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s1">(</span>
      <span class="s2">Math</span><span class="s1">.</span><span class="s2">abs</span><span class="s1">(</span>
        <span class="s2">getDistance</span><span class="s1">(</span><span class="s2">getCubicBezierPoint</span><span class="s1">(</span><span class="s2">curve</span><span class="s1">, </span><span class="s2">point</span><span class="s1">), </span><span class="s2">circle</span><span class="s1">.</span><span class="s2">center</span><span class="s1">) -</span>
          <span class="s2">circle</span><span class="s1">.</span><span class="s2">radius</span>
      <span class="s1">) &lt;= </span><span class="s2">tolerance</span>
    <span class="s1">);</span>
  <span class="s1">});</span>
<span class="s1">}</span>

<span class="s6">/**</span>
 <span class="s6">* Checks if a previous curve fits the given circle.</span>
 <span class="s6">*</span>
 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Object} circle</span>
 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Array} curve</span>
 <span class="s6">* </span><span class="s7">@return </span><span class="s6">{Boolean}</span>
 <span class="s6">*/</span>

<span class="s3">function </span><span class="s2">isArcPrev</span><span class="s1">(</span><span class="s2">curve</span><span class="s1">, </span><span class="s2">circle</span><span class="s1">) {</span>
  <span class="s3">return </span><span class="s2">isArc</span><span class="s1">(</span><span class="s2">curve</span><span class="s1">, {</span>
    <span class="s2">center</span><span class="s1">: [</span><span class="s2">circle</span><span class="s1">.</span><span class="s2">center</span><span class="s1">[</span><span class="s4">0</span><span class="s1">] + </span><span class="s2">curve</span><span class="s1">[</span><span class="s4">4</span><span class="s1">], </span><span class="s2">circle</span><span class="s1">.</span><span class="s2">center</span><span class="s1">[</span><span class="s4">1</span><span class="s1">] + </span><span class="s2">curve</span><span class="s1">[</span><span class="s4">5</span><span class="s1">]],</span>
    <span class="s2">radius</span><span class="s1">: </span><span class="s2">circle</span><span class="s1">.</span><span class="s2">radius</span><span class="s1">,</span>
  <span class="s1">});</span>
<span class="s1">}</span>

<span class="s6">/**</span>
 <span class="s6">* Finds angle of a curve fitting the given arc.</span>

 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Array} curve</span>
 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Object} relCircle</span>
 <span class="s6">* </span><span class="s7">@return </span><span class="s6">{Number} angle</span>
 <span class="s6">*/</span>

<span class="s3">function </span><span class="s2">findArcAngle</span><span class="s1">(</span><span class="s2">curve</span><span class="s1">, </span><span class="s2">relCircle</span><span class="s1">) {</span>
  <span class="s3">var </span><span class="s2">x1 </span><span class="s1">= -</span><span class="s2">relCircle</span><span class="s1">.</span><span class="s2">center</span><span class="s1">[</span><span class="s4">0</span><span class="s1">],</span>
    <span class="s2">y1 </span><span class="s1">= -</span><span class="s2">relCircle</span><span class="s1">.</span><span class="s2">center</span><span class="s1">[</span><span class="s4">1</span><span class="s1">],</span>
    <span class="s2">x2 </span><span class="s1">= </span><span class="s2">curve</span><span class="s1">[</span><span class="s4">4</span><span class="s1">] - </span><span class="s2">relCircle</span><span class="s1">.</span><span class="s2">center</span><span class="s1">[</span><span class="s4">0</span><span class="s1">],</span>
    <span class="s2">y2 </span><span class="s1">= </span><span class="s2">curve</span><span class="s1">[</span><span class="s4">5</span><span class="s1">] - </span><span class="s2">relCircle</span><span class="s1">.</span><span class="s2">center</span><span class="s1">[</span><span class="s4">1</span><span class="s1">];</span>

  <span class="s3">return </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">acos</span><span class="s1">(</span>
    <span class="s1">(</span><span class="s2">x1 </span><span class="s1">* </span><span class="s2">x2 </span><span class="s1">+ </span><span class="s2">y1 </span><span class="s1">* </span><span class="s2">y2</span><span class="s1">) / </span><span class="s2">Math</span><span class="s1">.</span><span class="s2">sqrt</span><span class="s1">((</span><span class="s2">x1 </span><span class="s1">* </span><span class="s2">x1 </span><span class="s1">+ </span><span class="s2">y1 </span><span class="s1">* </span><span class="s2">y1</span><span class="s1">) * (</span><span class="s2">x2 </span><span class="s1">* </span><span class="s2">x2 </span><span class="s1">+ </span><span class="s2">y2 </span><span class="s1">* </span><span class="s2">y2</span><span class="s1">))</span>
  <span class="s1">);</span>
<span class="s1">}</span>

<span class="s6">/**</span>
 <span class="s6">* Converts given path data to string.</span>
 <span class="s6">*</span>
 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Object} params</span>
 <span class="s6">* </span><span class="s7">@param </span><span class="s6">{Array} pathData</span>
 <span class="s6">* </span><span class="s7">@return </span><span class="s6">{String}</span>
 <span class="s6">*/</span>

<span class="s3">function </span><span class="s2">data2Path</span><span class="s1">(</span><span class="s2">params</span><span class="s1">, </span><span class="s2">pathData</span><span class="s1">) {</span>
  <span class="s3">return </span><span class="s2">pathData</span><span class="s1">.</span><span class="s2">reduce</span><span class="s1">(</span><span class="s3">function </span><span class="s1">(</span><span class="s2">pathString</span><span class="s1">, </span><span class="s2">item</span><span class="s1">) {</span>
    <span class="s3">var </span><span class="s2">strData </span><span class="s1">= </span><span class="s0">''</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">args</span><span class="s1">) {</span>
      <span class="s2">strData </span><span class="s1">= </span><span class="s2">cleanupOutData</span><span class="s1">(</span><span class="s2">roundData</span><span class="s1">(</span><span class="s2">item</span><span class="s1">.</span><span class="s2">args</span><span class="s1">.</span><span class="s2">slice</span><span class="s1">()), </span><span class="s2">params</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s3">return </span><span class="s2">pathString </span><span class="s1">+ </span><span class="s2">item</span><span class="s1">.</span><span class="s2">command </span><span class="s1">+ </span><span class="s2">strData</span><span class="s1">;</span>
  <span class="s1">}, </span><span class="s0">''</span><span class="s1">);</span>
<span class="s1">}</span>
</pre>
</body>
</html>