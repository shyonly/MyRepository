<html>
<head>
<title>sha256.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #67a37c; font-style: italic;}
.s2 { color: #bcbec4;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #7a7e85;}
.s7 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
sha256.js</font>
</center></td></tr></table>
<pre><span class="s0">/**</span>
 <span class="s0">* Secure Hash Algorithm with 256-bit digest (SHA-256) implementation.</span>
 <span class="s0">*</span>
 <span class="s0">* See FIPS 180-2 for details.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@author </span><span class="s0">Dave Longley</span>
 <span class="s0">*</span>
 <span class="s0">* Copyright (c) 2010-2015 Digital Bazaar, Inc.</span>
 <span class="s0">*/</span>
<span class="s3">var </span><span class="s2">forge </span><span class="s4">= </span><span class="s2">require</span><span class="s4">(</span><span class="s5">'./forge'</span><span class="s4">);</span>
<span class="s2">require</span><span class="s4">(</span><span class="s5">'./md'</span><span class="s4">);</span>
<span class="s2">require</span><span class="s4">(</span><span class="s5">'./util'</span><span class="s4">);</span>

<span class="s3">var </span><span class="s2">sha256 </span><span class="s4">= </span><span class="s2">module</span><span class="s4">.</span><span class="s2">exports </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">sha256 </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">sha256 </span><span class="s4">|| {};</span>
<span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">sha256 </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">algorithms</span><span class="s4">.</span><span class="s2">sha256 </span><span class="s4">= </span><span class="s2">sha256</span><span class="s4">;</span>

<span class="s0">/**</span>
 <span class="s0">* Creates a SHA-256 message digest object.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">a message digest object.</span>
 <span class="s0">*/</span>
<span class="s2">sha256</span><span class="s4">.</span><span class="s2">create </span><span class="s4">= </span><span class="s3">function</span><span class="s4">() {</span>
  <span class="s6">// do initialization as necessary</span>
  <span class="s3">if</span><span class="s4">(!</span><span class="s2">_initialized</span><span class="s4">) {</span>
    <span class="s2">_init</span><span class="s4">();</span>
  <span class="s4">}</span>

  <span class="s6">// SHA-256 state contains eight 32-bit integers</span>
  <span class="s3">var </span><span class="s2">_state </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>

  <span class="s6">// input buffer</span>
  <span class="s3">var </span><span class="s2">_input </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>

  <span class="s6">// used for word storage</span>
  <span class="s3">var </span><span class="s2">_w </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Array</span><span class="s4">(</span><span class="s7">64</span><span class="s4">);</span>

  <span class="s6">// message digest object</span>
  <span class="s3">var </span><span class="s2">md </span><span class="s4">= {</span>
    <span class="s2">algorithm</span><span class="s4">: </span><span class="s5">'sha256'</span><span class="s4">,</span>
    <span class="s2">blockLength</span><span class="s4">: </span><span class="s7">64</span><span class="s4">,</span>
    <span class="s2">digestLength</span><span class="s4">: </span><span class="s7">32</span><span class="s4">,</span>
    <span class="s6">// 56-bit length of message so far (does not including padding)</span>
    <span class="s2">messageLength</span><span class="s4">: </span><span class="s7">0</span><span class="s4">,</span>
    <span class="s6">// true message length</span>
    <span class="s2">fullMessageLength</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
    <span class="s6">// size of message length in bytes</span>
    <span class="s2">messageLengthSize</span><span class="s4">: </span><span class="s7">8</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Starts the digest.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@return </span><span class="s0">this digest object.</span>
   <span class="s0">*/</span>
  <span class="s2">md</span><span class="s4">.</span><span class="s2">start </span><span class="s4">= </span><span class="s3">function</span><span class="s4">() {</span>
    <span class="s6">// up to 56-bit message length for convenience</span>
    <span class="s2">md</span><span class="s4">.</span><span class="s2">messageLength </span><span class="s4">= </span><span class="s7">0</span><span class="s4">;</span>

    <span class="s6">// full message length (set md.messageLength64 for backwards-compatibility)</span>
    <span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength </span><span class="s4">= </span><span class="s2">md</span><span class="s4">.</span><span class="s2">messageLength64 </span><span class="s4">= [];</span>
    <span class="s3">var </span><span class="s2">int32s </span><span class="s4">= </span><span class="s2">md</span><span class="s4">.</span><span class="s2">messageLengthSize </span><span class="s4">/ </span><span class="s7">4</span><span class="s4">;</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">int32s</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s7">0</span><span class="s4">);</span>
    <span class="s4">}</span>
    <span class="s2">_input </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
    <span class="s2">_state </span><span class="s4">= {</span>
      <span class="s2">h0</span><span class="s4">: </span><span class="s7">0x6A09E667</span><span class="s4">,</span>
      <span class="s2">h1</span><span class="s4">: </span><span class="s7">0xBB67AE85</span><span class="s4">,</span>
      <span class="s2">h2</span><span class="s4">: </span><span class="s7">0x3C6EF372</span><span class="s4">,</span>
      <span class="s2">h3</span><span class="s4">: </span><span class="s7">0xA54FF53A</span><span class="s4">,</span>
      <span class="s2">h4</span><span class="s4">: </span><span class="s7">0x510E527F</span><span class="s4">,</span>
      <span class="s2">h5</span><span class="s4">: </span><span class="s7">0x9B05688C</span><span class="s4">,</span>
      <span class="s2">h6</span><span class="s4">: </span><span class="s7">0x1F83D9AB</span><span class="s4">,</span>
      <span class="s2">h7</span><span class="s4">: </span><span class="s7">0x5BE0CD19</span>
    <span class="s4">};</span>
    <span class="s3">return </span><span class="s2">md</span><span class="s4">;</span>
  <span class="s4">};</span>
  <span class="s6">// start digest automatically for first time</span>
  <span class="s2">md</span><span class="s4">.</span><span class="s2">start</span><span class="s4">();</span>

  <span class="s0">/**</span>
   <span class="s0">* Updates the digest with the given message input. The given input can</span>
   <span class="s0">* treated as raw input (no encoding will be applied) or an encoding of</span>
   <span class="s0">* 'utf8' maybe given to encode the input using UTF-8.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">msg the message input to update with.</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">encoding the encoding to use (default: 'raw', other: 'utf8').</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@return </span><span class="s0">this digest object.</span>
   <span class="s0">*/</span>
  <span class="s2">md</span><span class="s4">.</span><span class="s2">update </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">, </span><span class="s2">encoding</span><span class="s4">) {</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">encoding </span><span class="s4">=== </span><span class="s5">'utf8'</span><span class="s4">) {</span>
      <span class="s2">msg </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">encodeUtf8</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">);</span>
    <span class="s4">}</span>

    <span class="s6">// update message length</span>
    <span class="s3">var </span><span class="s2">len </span><span class="s4">= </span><span class="s2">msg</span><span class="s4">.</span><span class="s2">length</span><span class="s4">;</span>
    <span class="s2">md</span><span class="s4">.</span><span class="s2">messageLength </span><span class="s4">+= </span><span class="s2">len</span><span class="s4">;</span>
    <span class="s2">len </span><span class="s4">= [(</span><span class="s2">len </span><span class="s4">/ </span><span class="s7">0x100000000</span><span class="s4">) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">, </span><span class="s2">len </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">];</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">.</span><span class="s2">length </span><span class="s4">- </span><span class="s7">1</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&gt;= </span><span class="s7">0</span><span class="s4">; --</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">[</span><span class="s2">i</span><span class="s4">] += </span><span class="s2">len</span><span class="s4">[</span><span class="s7">1</span><span class="s4">];</span>
      <span class="s2">len</span><span class="s4">[</span><span class="s7">1</span><span class="s4">] = </span><span class="s2">len</span><span class="s4">[</span><span class="s7">0</span><span class="s4">] + ((</span><span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">[</span><span class="s2">i</span><span class="s4">] / </span><span class="s7">0x100000000</span><span class="s4">) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">);</span>
      <span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">[</span><span class="s2">i</span><span class="s4">] = </span><span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">[</span><span class="s2">i</span><span class="s4">] &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
      <span class="s2">len</span><span class="s4">[</span><span class="s7">0</span><span class="s4">] = ((</span><span class="s2">len</span><span class="s4">[</span><span class="s7">1</span><span class="s4">] / </span><span class="s7">0x100000000</span><span class="s4">) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">);</span>
    <span class="s4">}</span>

    <span class="s6">// add bytes to input buffer</span>
    <span class="s2">_input</span><span class="s4">.</span><span class="s2">putBytes</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">);</span>

    <span class="s6">// process bytes</span>
    <span class="s2">_update</span><span class="s4">(</span><span class="s2">_state</span><span class="s4">, </span><span class="s2">_w</span><span class="s4">, </span><span class="s2">_input</span><span class="s4">);</span>

    <span class="s6">// compact input buffer every 2K or if empty</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">_input</span><span class="s4">.</span><span class="s2">read </span><span class="s4">&gt; </span><span class="s7">2048 </span><span class="s4">|| </span><span class="s2">_input</span><span class="s4">.</span><span class="s2">length</span><span class="s4">() === </span><span class="s7">0</span><span class="s4">) {</span>
      <span class="s2">_input</span><span class="s4">.</span><span class="s2">compact</span><span class="s4">();</span>
    <span class="s4">}</span>

    <span class="s3">return </span><span class="s2">md</span><span class="s4">;</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Produces the digest.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@return </span><span class="s0">a byte buffer containing the digest value.</span>
   <span class="s0">*/</span>
  <span class="s2">md</span><span class="s4">.</span><span class="s2">digest </span><span class="s4">= </span><span class="s3">function</span><span class="s4">() {</span>
    <span class="s6">/* Note: Here we copy the remaining bytes in the input buffer and 
    add the appropriate SHA-256 padding. Then we do the final update 
    on a copy of the state so that if the user wants to get 
    intermediate digests they can do so. */</span>

    <span class="s6">/* Determine the number of bytes that must be added to the message 
    to ensure its length is congruent to 448 mod 512. In other words, 
    the data to be digested must be a multiple of 512 bits (or 128 bytes). 
    This data includes the message, some padding, and the length of the 
    message. Since the length of the message will be encoded as 8 bytes (64 
    bits), that means that the last segment of the data must have 56 bytes 
    (448 bits) of message and padding. Therefore, the length of the message 
    plus the padding must be congruent to 448 mod 512 because 
    512 - 128 = 448. 
 
    In order to fill up the message length it must be filled with 
    padding that begins with 1 bit followed by all 0 bits. Padding 
    must *always* be present, so if the message length is already 
    congruent to 448 mod 512, then 512 padding bits must be added. */</span>

    <span class="s3">var </span><span class="s2">finalBlock </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
    <span class="s2">finalBlock</span><span class="s4">.</span><span class="s2">putBytes</span><span class="s4">(</span><span class="s2">_input</span><span class="s4">.</span><span class="s2">bytes</span><span class="s4">());</span>

    <span class="s6">// compute remaining size to be digested (include message length size)</span>
    <span class="s3">var </span><span class="s2">remaining </span><span class="s4">= (</span>
      <span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">[</span><span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">.</span><span class="s2">length </span><span class="s4">- </span><span class="s7">1</span><span class="s4">] +</span>
      <span class="s2">md</span><span class="s4">.</span><span class="s2">messageLengthSize</span><span class="s4">);</span>

    <span class="s6">// add padding for overflow blockSize - overflow</span>
    <span class="s6">// _padding starts with 1 byte with first bit is set (byte value 128), then</span>
    <span class="s6">// there may be up to (blockSize - 1) other pad bytes</span>
    <span class="s3">var </span><span class="s2">overflow </span><span class="s4">= </span><span class="s2">remaining </span><span class="s4">&amp; (</span><span class="s2">md</span><span class="s4">.</span><span class="s2">blockLength </span><span class="s4">- </span><span class="s7">1</span><span class="s4">);</span>
    <span class="s2">finalBlock</span><span class="s4">.</span><span class="s2">putBytes</span><span class="s4">(</span><span class="s2">_padding</span><span class="s4">.</span><span class="s2">substr</span><span class="s4">(</span><span class="s7">0</span><span class="s4">, </span><span class="s2">md</span><span class="s4">.</span><span class="s2">blockLength </span><span class="s4">- </span><span class="s2">overflow</span><span class="s4">));</span>

    <span class="s6">// serialize message length in bits in big-endian order; since length</span>
    <span class="s6">// is stored in bytes we multiply by 8 and add carry from next int</span>
    <span class="s3">var </span><span class="s2">next</span><span class="s4">, </span><span class="s2">carry</span><span class="s4">;</span>
    <span class="s3">var </span><span class="s2">bits </span><span class="s4">= </span><span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">[</span><span class="s7">0</span><span class="s4">] * </span><span class="s7">8</span><span class="s4">;</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">.</span><span class="s2">length </span><span class="s4">- </span><span class="s7">1</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s2">next </span><span class="s4">= </span><span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">[</span><span class="s2">i </span><span class="s4">+ </span><span class="s7">1</span><span class="s4">] * </span><span class="s7">8</span><span class="s4">;</span>
      <span class="s2">carry </span><span class="s4">= (</span><span class="s2">next </span><span class="s4">/ </span><span class="s7">0x100000000</span><span class="s4">) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
      <span class="s2">bits </span><span class="s4">+= </span><span class="s2">carry</span><span class="s4">;</span>
      <span class="s2">finalBlock</span><span class="s4">.</span><span class="s2">putInt32</span><span class="s4">(</span><span class="s2">bits </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">);</span>
      <span class="s2">bits </span><span class="s4">= </span><span class="s2">next </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s2">finalBlock</span><span class="s4">.</span><span class="s2">putInt32</span><span class="s4">(</span><span class="s2">bits</span><span class="s4">);</span>

    <span class="s3">var </span><span class="s2">s2 </span><span class="s4">= {</span>
      <span class="s2">h0</span><span class="s4">: </span><span class="s2">_state</span><span class="s4">.</span><span class="s2">h0</span><span class="s4">,</span>
      <span class="s2">h1</span><span class="s4">: </span><span class="s2">_state</span><span class="s4">.</span><span class="s2">h1</span><span class="s4">,</span>
      <span class="s2">h2</span><span class="s4">: </span><span class="s2">_state</span><span class="s4">.</span><span class="s2">h2</span><span class="s4">,</span>
      <span class="s2">h3</span><span class="s4">: </span><span class="s2">_state</span><span class="s4">.</span><span class="s2">h3</span><span class="s4">,</span>
      <span class="s2">h4</span><span class="s4">: </span><span class="s2">_state</span><span class="s4">.</span><span class="s2">h4</span><span class="s4">,</span>
      <span class="s2">h5</span><span class="s4">: </span><span class="s2">_state</span><span class="s4">.</span><span class="s2">h5</span><span class="s4">,</span>
      <span class="s2">h6</span><span class="s4">: </span><span class="s2">_state</span><span class="s4">.</span><span class="s2">h6</span><span class="s4">,</span>
      <span class="s2">h7</span><span class="s4">: </span><span class="s2">_state</span><span class="s4">.</span><span class="s2">h7</span>
    <span class="s4">};</span>
    <span class="s2">_update</span><span class="s4">(</span><span class="s2">s2</span><span class="s4">, </span><span class="s2">_w</span><span class="s4">, </span><span class="s2">finalBlock</span><span class="s4">);</span>
    <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
    <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt32</span><span class="s4">(</span><span class="s2">s2</span><span class="s4">.</span><span class="s2">h0</span><span class="s4">);</span>
    <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt32</span><span class="s4">(</span><span class="s2">s2</span><span class="s4">.</span><span class="s2">h1</span><span class="s4">);</span>
    <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt32</span><span class="s4">(</span><span class="s2">s2</span><span class="s4">.</span><span class="s2">h2</span><span class="s4">);</span>
    <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt32</span><span class="s4">(</span><span class="s2">s2</span><span class="s4">.</span><span class="s2">h3</span><span class="s4">);</span>
    <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt32</span><span class="s4">(</span><span class="s2">s2</span><span class="s4">.</span><span class="s2">h4</span><span class="s4">);</span>
    <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt32</span><span class="s4">(</span><span class="s2">s2</span><span class="s4">.</span><span class="s2">h5</span><span class="s4">);</span>
    <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt32</span><span class="s4">(</span><span class="s2">s2</span><span class="s4">.</span><span class="s2">h6</span><span class="s4">);</span>
    <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt32</span><span class="s4">(</span><span class="s2">s2</span><span class="s4">.</span><span class="s2">h7</span><span class="s4">);</span>
    <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
  <span class="s4">};</span>

  <span class="s3">return </span><span class="s2">md</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s6">// sha-256 padding bytes not initialized yet</span>
<span class="s3">var </span><span class="s2">_padding </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">_initialized </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>

<span class="s6">// table of constants</span>
<span class="s3">var </span><span class="s2">_k </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>

<span class="s0">/**</span>
 <span class="s0">* Initializes the constant tables.</span>
 <span class="s0">*/</span>
<span class="s3">function </span><span class="s2">_init</span><span class="s4">() {</span>
  <span class="s6">// create padding</span>
  <span class="s2">_padding </span><span class="s4">= </span><span class="s2">String</span><span class="s4">.</span><span class="s2">fromCharCode</span><span class="s4">(</span><span class="s7">128</span><span class="s4">);</span>
  <span class="s2">_padding </span><span class="s4">+= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">fillString</span><span class="s4">(</span><span class="s2">String</span><span class="s4">.</span><span class="s2">fromCharCode</span><span class="s4">(</span><span class="s7">0x00</span><span class="s4">), </span><span class="s7">64</span><span class="s4">);</span>

  <span class="s6">// create K table for SHA-256</span>
  <span class="s2">_k </span><span class="s4">= [</span>
    <span class="s7">0x428a2f98</span><span class="s4">, </span><span class="s7">0x71374491</span><span class="s4">, </span><span class="s7">0xb5c0fbcf</span><span class="s4">, </span><span class="s7">0xe9b5dba5</span><span class="s4">,</span>
    <span class="s7">0x3956c25b</span><span class="s4">, </span><span class="s7">0x59f111f1</span><span class="s4">, </span><span class="s7">0x923f82a4</span><span class="s4">, </span><span class="s7">0xab1c5ed5</span><span class="s4">,</span>
    <span class="s7">0xd807aa98</span><span class="s4">, </span><span class="s7">0x12835b01</span><span class="s4">, </span><span class="s7">0x243185be</span><span class="s4">, </span><span class="s7">0x550c7dc3</span><span class="s4">,</span>
    <span class="s7">0x72be5d74</span><span class="s4">, </span><span class="s7">0x80deb1fe</span><span class="s4">, </span><span class="s7">0x9bdc06a7</span><span class="s4">, </span><span class="s7">0xc19bf174</span><span class="s4">,</span>
    <span class="s7">0xe49b69c1</span><span class="s4">, </span><span class="s7">0xefbe4786</span><span class="s4">, </span><span class="s7">0x0fc19dc6</span><span class="s4">, </span><span class="s7">0x240ca1cc</span><span class="s4">,</span>
    <span class="s7">0x2de92c6f</span><span class="s4">, </span><span class="s7">0x4a7484aa</span><span class="s4">, </span><span class="s7">0x5cb0a9dc</span><span class="s4">, </span><span class="s7">0x76f988da</span><span class="s4">,</span>
    <span class="s7">0x983e5152</span><span class="s4">, </span><span class="s7">0xa831c66d</span><span class="s4">, </span><span class="s7">0xb00327c8</span><span class="s4">, </span><span class="s7">0xbf597fc7</span><span class="s4">,</span>
    <span class="s7">0xc6e00bf3</span><span class="s4">, </span><span class="s7">0xd5a79147</span><span class="s4">, </span><span class="s7">0x06ca6351</span><span class="s4">, </span><span class="s7">0x14292967</span><span class="s4">,</span>
    <span class="s7">0x27b70a85</span><span class="s4">, </span><span class="s7">0x2e1b2138</span><span class="s4">, </span><span class="s7">0x4d2c6dfc</span><span class="s4">, </span><span class="s7">0x53380d13</span><span class="s4">,</span>
    <span class="s7">0x650a7354</span><span class="s4">, </span><span class="s7">0x766a0abb</span><span class="s4">, </span><span class="s7">0x81c2c92e</span><span class="s4">, </span><span class="s7">0x92722c85</span><span class="s4">,</span>
    <span class="s7">0xa2bfe8a1</span><span class="s4">, </span><span class="s7">0xa81a664b</span><span class="s4">, </span><span class="s7">0xc24b8b70</span><span class="s4">, </span><span class="s7">0xc76c51a3</span><span class="s4">,</span>
    <span class="s7">0xd192e819</span><span class="s4">, </span><span class="s7">0xd6990624</span><span class="s4">, </span><span class="s7">0xf40e3585</span><span class="s4">, </span><span class="s7">0x106aa070</span><span class="s4">,</span>
    <span class="s7">0x19a4c116</span><span class="s4">, </span><span class="s7">0x1e376c08</span><span class="s4">, </span><span class="s7">0x2748774c</span><span class="s4">, </span><span class="s7">0x34b0bcb5</span><span class="s4">,</span>
    <span class="s7">0x391c0cb3</span><span class="s4">, </span><span class="s7">0x4ed8aa4a</span><span class="s4">, </span><span class="s7">0x5b9cca4f</span><span class="s4">, </span><span class="s7">0x682e6ff3</span><span class="s4">,</span>
    <span class="s7">0x748f82ee</span><span class="s4">, </span><span class="s7">0x78a5636f</span><span class="s4">, </span><span class="s7">0x84c87814</span><span class="s4">, </span><span class="s7">0x8cc70208</span><span class="s4">,</span>
    <span class="s7">0x90befffa</span><span class="s4">, </span><span class="s7">0xa4506ceb</span><span class="s4">, </span><span class="s7">0xbef9a3f7</span><span class="s4">, </span><span class="s7">0xc67178f2</span><span class="s4">];</span>

  <span class="s6">// now initialized</span>
  <span class="s2">_initialized </span><span class="s4">= </span><span class="s3">true</span><span class="s4">;</span>
<span class="s4">}</span>

<span class="s0">/**</span>
 <span class="s0">* Updates a SHA-256 state with the given byte buffer.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">s the SHA-256 state to update.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">w the array to use to store words.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">bytes the byte buffer to update with.</span>
 <span class="s0">*/</span>
<span class="s3">function </span><span class="s2">_update</span><span class="s4">(</span><span class="s2">s</span><span class="s4">, </span><span class="s2">w</span><span class="s4">, </span><span class="s2">bytes</span><span class="s4">) {</span>
  <span class="s6">// consume 512 bit (64 byte) chunks</span>
  <span class="s3">var </span><span class="s2">t1</span><span class="s4">, </span><span class="s2">t2</span><span class="s4">, </span><span class="s2">s0</span><span class="s4">, </span><span class="s2">s1</span><span class="s4">, </span><span class="s2">ch</span><span class="s4">, </span><span class="s2">maj</span><span class="s4">, </span><span class="s2">i</span><span class="s4">, </span><span class="s2">a</span><span class="s4">, </span><span class="s2">b</span><span class="s4">, </span><span class="s2">c</span><span class="s4">, </span><span class="s2">d</span><span class="s4">, </span><span class="s2">e</span><span class="s4">, </span><span class="s2">f</span><span class="s4">, </span><span class="s2">g</span><span class="s4">, </span><span class="s2">h</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">len </span><span class="s4">= </span><span class="s2">bytes</span><span class="s4">.</span><span class="s2">length</span><span class="s4">();</span>
  <span class="s3">while</span><span class="s4">(</span><span class="s2">len </span><span class="s4">&gt;= </span><span class="s7">64</span><span class="s4">) {</span>
    <span class="s6">// the w array will be populated with sixteen 32-bit big-endian words</span>
    <span class="s6">// and then extended into 64 32-bit words according to SHA-256</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s7">16</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s2">w</span><span class="s4">[</span><span class="s2">i</span><span class="s4">] = </span><span class="s2">bytes</span><span class="s4">.</span><span class="s2">getInt32</span><span class="s4">();</span>
    <span class="s4">}</span>
    <span class="s3">for</span><span class="s4">(; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s7">64</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s6">// XOR word 2 words ago rot right 17, rot right 19, shft right 10</span>
      <span class="s2">t1 </span><span class="s4">= </span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">2</span><span class="s4">];</span>
      <span class="s2">t1 </span><span class="s4">=</span>
        <span class="s4">((</span><span class="s2">t1 </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">17</span><span class="s4">) | (</span><span class="s2">t1 </span><span class="s4">&lt;&lt; </span><span class="s7">15</span><span class="s4">)) ^</span>
        <span class="s4">((</span><span class="s2">t1 </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">19</span><span class="s4">) | (</span><span class="s2">t1 </span><span class="s4">&lt;&lt; </span><span class="s7">13</span><span class="s4">)) ^</span>
        <span class="s4">(</span><span class="s2">t1 </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">10</span><span class="s4">);</span>
      <span class="s6">// XOR word 15 words ago rot right 7, rot right 18, shft right 3</span>
      <span class="s2">t2 </span><span class="s4">= </span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">15</span><span class="s4">];</span>
      <span class="s2">t2 </span><span class="s4">=</span>
        <span class="s4">((</span><span class="s2">t2 </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">7</span><span class="s4">) | (</span><span class="s2">t2 </span><span class="s4">&lt;&lt; </span><span class="s7">25</span><span class="s4">)) ^</span>
        <span class="s4">((</span><span class="s2">t2 </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">18</span><span class="s4">) | (</span><span class="s2">t2 </span><span class="s4">&lt;&lt; </span><span class="s7">14</span><span class="s4">)) ^</span>
        <span class="s4">(</span><span class="s2">t2 </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">3</span><span class="s4">);</span>
      <span class="s6">// sum(t1, word 7 ago, t2, word 16 ago) modulo 2^32</span>
      <span class="s2">w</span><span class="s4">[</span><span class="s2">i</span><span class="s4">] = (</span><span class="s2">t1 </span><span class="s4">+ </span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">7</span><span class="s4">] + </span><span class="s2">t2 </span><span class="s4">+ </span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">16</span><span class="s4">]) | </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s4">}</span>

    <span class="s6">// initialize hash value for this chunk</span>
    <span class="s2">a </span><span class="s4">= </span><span class="s2">s</span><span class="s4">.</span><span class="s2">h0</span><span class="s4">;</span>
    <span class="s2">b </span><span class="s4">= </span><span class="s2">s</span><span class="s4">.</span><span class="s2">h1</span><span class="s4">;</span>
    <span class="s2">c </span><span class="s4">= </span><span class="s2">s</span><span class="s4">.</span><span class="s2">h2</span><span class="s4">;</span>
    <span class="s2">d </span><span class="s4">= </span><span class="s2">s</span><span class="s4">.</span><span class="s2">h3</span><span class="s4">;</span>
    <span class="s2">e </span><span class="s4">= </span><span class="s2">s</span><span class="s4">.</span><span class="s2">h4</span><span class="s4">;</span>
    <span class="s2">f </span><span class="s4">= </span><span class="s2">s</span><span class="s4">.</span><span class="s2">h5</span><span class="s4">;</span>
    <span class="s2">g </span><span class="s4">= </span><span class="s2">s</span><span class="s4">.</span><span class="s2">h6</span><span class="s4">;</span>
    <span class="s2">h </span><span class="s4">= </span><span class="s2">s</span><span class="s4">.</span><span class="s2">h7</span><span class="s4">;</span>

    <span class="s6">// round function</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s7">64</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s6">// Sum1(e)</span>
      <span class="s2">s1 </span><span class="s4">=</span>
        <span class="s4">((</span><span class="s2">e </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">6</span><span class="s4">) | (</span><span class="s2">e </span><span class="s4">&lt;&lt; </span><span class="s7">26</span><span class="s4">)) ^</span>
        <span class="s4">((</span><span class="s2">e </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">11</span><span class="s4">) | (</span><span class="s2">e </span><span class="s4">&lt;&lt; </span><span class="s7">21</span><span class="s4">)) ^</span>
        <span class="s4">((</span><span class="s2">e </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">25</span><span class="s4">) | (</span><span class="s2">e </span><span class="s4">&lt;&lt; </span><span class="s7">7</span><span class="s4">));</span>
      <span class="s6">// Ch(e, f, g) (optimized the same way as SHA-1)</span>
      <span class="s2">ch </span><span class="s4">= </span><span class="s2">g </span><span class="s4">^ (</span><span class="s2">e </span><span class="s4">&amp; (</span><span class="s2">f </span><span class="s4">^ </span><span class="s2">g</span><span class="s4">));</span>
      <span class="s6">// Sum0(a)</span>
      <span class="s2">s0 </span><span class="s4">=</span>
        <span class="s4">((</span><span class="s2">a </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">2</span><span class="s4">) | (</span><span class="s2">a </span><span class="s4">&lt;&lt; </span><span class="s7">30</span><span class="s4">)) ^</span>
        <span class="s4">((</span><span class="s2">a </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">13</span><span class="s4">) | (</span><span class="s2">a </span><span class="s4">&lt;&lt; </span><span class="s7">19</span><span class="s4">)) ^</span>
        <span class="s4">((</span><span class="s2">a </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">22</span><span class="s4">) | (</span><span class="s2">a </span><span class="s4">&lt;&lt; </span><span class="s7">10</span><span class="s4">));</span>
      <span class="s6">// Maj(a, b, c) (optimized the same way as SHA-1)</span>
      <span class="s2">maj </span><span class="s4">= (</span><span class="s2">a </span><span class="s4">&amp; </span><span class="s2">b</span><span class="s4">) | (</span><span class="s2">c </span><span class="s4">&amp; (</span><span class="s2">a </span><span class="s4">^ </span><span class="s2">b</span><span class="s4">));</span>

      <span class="s6">// main algorithm</span>
      <span class="s2">t1 </span><span class="s4">= </span><span class="s2">h </span><span class="s4">+ </span><span class="s2">s1 </span><span class="s4">+ </span><span class="s2">ch </span><span class="s4">+ </span><span class="s2">_k</span><span class="s4">[</span><span class="s2">i</span><span class="s4">] + </span><span class="s2">w</span><span class="s4">[</span><span class="s2">i</span><span class="s4">];</span>
      <span class="s2">t2 </span><span class="s4">= </span><span class="s2">s0 </span><span class="s4">+ </span><span class="s2">maj</span><span class="s4">;</span>
      <span class="s2">h </span><span class="s4">= </span><span class="s2">g</span><span class="s4">;</span>
      <span class="s2">g </span><span class="s4">= </span><span class="s2">f</span><span class="s4">;</span>
      <span class="s2">f </span><span class="s4">= </span><span class="s2">e</span><span class="s4">;</span>
      <span class="s6">// `&gt;&gt;&gt; 0` necessary to avoid iOS/Safari 10 optimization bug</span>
      <span class="s6">// can't truncate with `| 0`</span>
      <span class="s2">e </span><span class="s4">= (</span><span class="s2">d </span><span class="s4">+ </span><span class="s2">t1</span><span class="s4">) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
      <span class="s2">d </span><span class="s4">= </span><span class="s2">c</span><span class="s4">;</span>
      <span class="s2">c </span><span class="s4">= </span><span class="s2">b</span><span class="s4">;</span>
      <span class="s2">b </span><span class="s4">= </span><span class="s2">a</span><span class="s4">;</span>
      <span class="s6">// `&gt;&gt;&gt; 0` necessary to avoid iOS/Safari 10 optimization bug</span>
      <span class="s6">// can't truncate with `| 0`</span>
      <span class="s2">a </span><span class="s4">= (</span><span class="s2">t1 </span><span class="s4">+ </span><span class="s2">t2</span><span class="s4">) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s4">}</span>

    <span class="s6">// update hash state</span>
    <span class="s2">s</span><span class="s4">.</span><span class="s2">h0 </span><span class="s4">= (</span><span class="s2">s</span><span class="s4">.</span><span class="s2">h0 </span><span class="s4">+ </span><span class="s2">a</span><span class="s4">) | </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s2">s</span><span class="s4">.</span><span class="s2">h1 </span><span class="s4">= (</span><span class="s2">s</span><span class="s4">.</span><span class="s2">h1 </span><span class="s4">+ </span><span class="s2">b</span><span class="s4">) | </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s2">s</span><span class="s4">.</span><span class="s2">h2 </span><span class="s4">= (</span><span class="s2">s</span><span class="s4">.</span><span class="s2">h2 </span><span class="s4">+ </span><span class="s2">c</span><span class="s4">) | </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s2">s</span><span class="s4">.</span><span class="s2">h3 </span><span class="s4">= (</span><span class="s2">s</span><span class="s4">.</span><span class="s2">h3 </span><span class="s4">+ </span><span class="s2">d</span><span class="s4">) | </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s2">s</span><span class="s4">.</span><span class="s2">h4 </span><span class="s4">= (</span><span class="s2">s</span><span class="s4">.</span><span class="s2">h4 </span><span class="s4">+ </span><span class="s2">e</span><span class="s4">) | </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s2">s</span><span class="s4">.</span><span class="s2">h5 </span><span class="s4">= (</span><span class="s2">s</span><span class="s4">.</span><span class="s2">h5 </span><span class="s4">+ </span><span class="s2">f</span><span class="s4">) | </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s2">s</span><span class="s4">.</span><span class="s2">h6 </span><span class="s4">= (</span><span class="s2">s</span><span class="s4">.</span><span class="s2">h6 </span><span class="s4">+ </span><span class="s2">g</span><span class="s4">) | </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s2">s</span><span class="s4">.</span><span class="s2">h7 </span><span class="s4">= (</span><span class="s2">s</span><span class="s4">.</span><span class="s2">h7 </span><span class="s4">+ </span><span class="s2">h</span><span class="s4">) | </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s2">len </span><span class="s4">-= </span><span class="s7">64</span><span class="s4">;</span>
  <span class="s4">}</span>
<span class="s4">}</span>
</pre>
</body>
</html>