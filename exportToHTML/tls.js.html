<html>
<head>
<title>tls.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #67a37c; font-style: italic;}
.s2 { color: #bcbec4;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #7a7e85;}
.s7 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
tls.js</font>
</center></td></tr></table>
<pre><span class="s0">/**</span>
 <span class="s0">* A Javascript implementation of Transport Layer Security (TLS).</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@author </span><span class="s0">Dave Longley</span>
 <span class="s0">*</span>
 <span class="s0">* Copyright (c) 2009-2014 Digital Bazaar, Inc.</span>
 <span class="s0">*</span>
 <span class="s0">* The TLS Handshake Protocol involves the following steps:</span>
 <span class="s0">*</span>
 <span class="s0">* - Exchange hello messages to agree on algorithms, exchange random values,</span>
 <span class="s0">* and check for session resumption.</span>
 <span class="s0">*</span>
 <span class="s0">* - Exchange the necessary cryptographic parameters to allow the client and</span>
 <span class="s0">* server to agree on a premaster secret.</span>
 <span class="s0">*</span>
 <span class="s0">* - Exchange certificates and cryptographic information to allow the client</span>
 <span class="s0">* and server to authenticate themselves.</span>
 <span class="s0">*</span>
 <span class="s0">* - Generate a master secret from the premaster secret and exchanged random</span>
 <span class="s0">* values.</span>
 <span class="s0">*</span>
 <span class="s0">* - Provide security parameters to the record layer.</span>
 <span class="s0">*</span>
 <span class="s0">* - Allow the client and server to verify that their peer has calculated the</span>
 <span class="s0">* same security parameters and that the handshake occurred without tampering</span>
 <span class="s0">* by an attacker.</span>
 <span class="s0">*</span>
 <span class="s0">* Up to 4 different messages may be sent during a key exchange. The server</span>
 <span class="s0">* certificate, the server key exchange, the client certificate, and the</span>
 <span class="s0">* client key exchange.</span>
 <span class="s0">*</span>
 <span class="s0">* A typical handshake (from the client's perspective).</span>
 <span class="s0">*</span>
 <span class="s0">* 1. Client sends ClientHello.</span>
 <span class="s0">* 2. Client receives ServerHello.</span>
 <span class="s0">* 3. Client receives optional Certificate.</span>
 <span class="s0">* 4. Client receives optional ServerKeyExchange.</span>
 <span class="s0">* 5. Client receives ServerHelloDone.</span>
 <span class="s0">* 6. Client sends optional Certificate.</span>
 <span class="s0">* 7. Client sends ClientKeyExchange.</span>
 <span class="s0">* 8. Client sends optional CertificateVerify.</span>
 <span class="s0">* 9. Client sends ChangeCipherSpec.</span>
 <span class="s0">* 10. Client sends Finished.</span>
 <span class="s0">* 11. Client receives ChangeCipherSpec.</span>
 <span class="s0">* 12. Client receives Finished.</span>
 <span class="s0">* 13. Client sends/receives application data.</span>
 <span class="s0">*</span>
 <span class="s0">* To reuse an existing session:</span>
 <span class="s0">*</span>
 <span class="s0">* 1. Client sends ClientHello with session ID for reuse.</span>
 <span class="s0">* 2. Client receives ServerHello with same session ID if reusing.</span>
 <span class="s0">* 3. Client receives ChangeCipherSpec message if reusing.</span>
 <span class="s0">* 4. Client receives Finished.</span>
 <span class="s0">* 5. Client sends ChangeCipherSpec.</span>
 <span class="s0">* 6. Client sends Finished.</span>
 <span class="s0">*</span>
 <span class="s0">* Note: Client ignores HelloRequest if in the middle of a handshake.</span>
 <span class="s0">*</span>
 <span class="s0">* Record Layer:</span>
 <span class="s0">*</span>
 <span class="s0">* The record layer fragments information blocks into TLSPlaintext records</span>
 <span class="s0">* carrying data in chunks of 2^14 bytes or less. Client message boundaries are</span>
 <span class="s0">* not preserved in the record layer (i.e., multiple client messages of the</span>
 <span class="s0">* same ContentType MAY be coalesced into a single TLSPlaintext record, or a</span>
 <span class="s0">* single message MAY be fragmented across several records).</span>
 <span class="s0">*</span>
 <span class="s0">* struct {</span>
 <span class="s0">*   uint8 major;</span>
 <span class="s0">*   uint8 minor;</span>
 <span class="s0">* } ProtocolVersion;</span>
 <span class="s0">*</span>
 <span class="s0">* struct {</span>
 <span class="s0">*   ContentType type;</span>
 <span class="s0">*   ProtocolVersion version;</span>
 <span class="s0">*   uint16 length;</span>
 <span class="s0">*   opaque fragment[TLSPlaintext.length];</span>
 <span class="s0">* } TLSPlaintext;</span>
 <span class="s0">*</span>
 <span class="s0">* type:</span>
 <span class="s0">*   The higher-level protocol used to process the enclosed fragment.</span>
 <span class="s0">*</span>
 <span class="s0">* version:</span>
 <span class="s0">*   The version of the protocol being employed. TLS Version 1.2 uses version</span>
 <span class="s0">*   {3, 3}. TLS Version 1.0 uses version {3, 1}. Note that a client that</span>
 <span class="s0">*   supports multiple versions of TLS may not know what version will be</span>
 <span class="s0">*   employed before it receives the ServerHello.</span>
 <span class="s0">*</span>
 <span class="s0">* length:</span>
 <span class="s0">*   The length (in bytes) of the following TLSPlaintext.fragment. The length</span>
 <span class="s0">*   MUST NOT exceed 2^14 = 16384 bytes.</span>
 <span class="s0">*</span>
 <span class="s0">* fragment:</span>
 <span class="s0">*   The application data. This data is transparent and treated as an</span>
 <span class="s0">*   independent block to be dealt with by the higher-level protocol specified</span>
 <span class="s0">*   by the type field.</span>
 <span class="s0">*</span>
 <span class="s0">* Implementations MUST NOT send zero-length fragments of Handshake, Alert, or</span>
 <span class="s0">* ChangeCipherSpec content types. Zero-length fragments of Application data</span>
 <span class="s0">* MAY be sent as they are potentially useful as a traffic analysis</span>
 <span class="s0">* countermeasure.</span>
 <span class="s0">*</span>
 <span class="s0">* Note: Data of different TLS record layer content types MAY be interleaved.</span>
 <span class="s0">* Application data is generally of lower precedence for transmission than</span>
 <span class="s0">* other content types. However, records MUST be delivered to the network in</span>
 <span class="s0">* the same order as they are protected by the record layer. Recipients MUST</span>
 <span class="s0">* receive and process interleaved application layer traffic during handshakes</span>
 <span class="s0">* subsequent to the first one on a connection.</span>
 <span class="s0">*</span>
 <span class="s0">* struct {</span>
 <span class="s0">*   ContentType type;       // same as TLSPlaintext.type</span>
 <span class="s0">*   ProtocolVersion version;// same as TLSPlaintext.version</span>
 <span class="s0">*   uint16 length;</span>
 <span class="s0">*   opaque fragment[TLSCompressed.length];</span>
 <span class="s0">* } TLSCompressed;</span>
 <span class="s0">*</span>
 <span class="s0">* length:</span>
 <span class="s0">*   The length (in bytes) of the following TLSCompressed.fragment.</span>
 <span class="s0">*   The length MUST NOT exceed 2^14 + 1024.</span>
 <span class="s0">*</span>
 <span class="s0">* fragment:</span>
 <span class="s0">*   The compressed form of TLSPlaintext.fragment.</span>
 <span class="s0">*</span>
 <span class="s0">* Note: A CompressionMethod.null operation is an identity operation; no fields</span>
 <span class="s0">* are altered. In this implementation, since no compression is supported,</span>
 <span class="s0">* uncompressed records are always the same as compressed records.</span>
 <span class="s0">*</span>
 <span class="s0">* Encryption Information:</span>
 <span class="s0">*</span>
 <span class="s0">* The encryption and MAC functions translate a TLSCompressed structure into a</span>
 <span class="s0">* TLSCiphertext. The decryption functions reverse the process. The MAC of the</span>
 <span class="s0">* record also includes a sequence number so that missing, extra, or repeated</span>
 <span class="s0">* messages are detectable.</span>
 <span class="s0">*</span>
 <span class="s0">* struct {</span>
 <span class="s0">*   ContentType type;</span>
 <span class="s0">*   ProtocolVersion version;</span>
 <span class="s0">*   uint16 length;</span>
 <span class="s0">*   select (SecurityParameters.cipher_type) {</span>
 <span class="s0">*     case stream: GenericStreamCipher;</span>
 <span class="s0">*     case block:  GenericBlockCipher;</span>
 <span class="s0">*     case aead:   GenericAEADCipher;</span>
 <span class="s0">*   } fragment;</span>
 <span class="s0">* } TLSCiphertext;</span>
 <span class="s0">*</span>
 <span class="s0">* type:</span>
 <span class="s0">*   The type field is identical to TLSCompressed.type.</span>
 <span class="s0">*</span>
 <span class="s0">* version:</span>
 <span class="s0">*   The version field is identical to TLSCompressed.version.</span>
 <span class="s0">*</span>
 <span class="s0">* length:</span>
 <span class="s0">*   The length (in bytes) of the following TLSCiphertext.fragment.</span>
 <span class="s0">*   The length MUST NOT exceed 2^14 + 2048.</span>
 <span class="s0">*</span>
 <span class="s0">* fragment:</span>
 <span class="s0">*   The encrypted form of TLSCompressed.fragment, with the MAC.</span>
 <span class="s0">*</span>
 <span class="s0">* Note: Only CBC Block Ciphers are supported by this implementation.</span>
 <span class="s0">*</span>
 <span class="s0">* The TLSCompressed.fragment structures are converted to/from block</span>
 <span class="s0">* TLSCiphertext.fragment structures.</span>
 <span class="s0">*</span>
 <span class="s0">* struct {</span>
 <span class="s0">*   opaque IV[SecurityParameters.record_iv_length];</span>
 <span class="s0">*   block-ciphered struct {</span>
 <span class="s0">*     opaque content[TLSCompressed.length];</span>
 <span class="s0">*     opaque MAC[SecurityParameters.mac_length];</span>
 <span class="s0">*     uint8 padding[GenericBlockCipher.padding_length];</span>
 <span class="s0">*     uint8 padding_length;</span>
 <span class="s0">*   };</span>
 <span class="s0">* } GenericBlockCipher;</span>
 <span class="s0">*</span>
 <span class="s0">* The MAC is generated as described in Section 6.2.3.1.</span>
 <span class="s0">*</span>
 <span class="s0">* IV:</span>
 <span class="s0">*   The Initialization Vector (IV) SHOULD be chosen at random, and MUST be</span>
 <span class="s0">*   unpredictable. Note that in versions of TLS prior to 1.1, there was no</span>
 <span class="s0">*   IV field, and the last ciphertext block of the previous record (the &quot;CBC</span>
 <span class="s0">*   residue&quot;) was used as the IV. This was changed to prevent the attacks</span>
 <span class="s0">*   described in [CBCATT]. For block ciphers, the IV length is of length</span>
 <span class="s0">*   SecurityParameters.record_iv_length, which is equal to the</span>
 <span class="s0">*   SecurityParameters.block_size.</span>
 <span class="s0">*</span>
 <span class="s0">* padding:</span>
 <span class="s0">*   Padding that is added to force the length of the plaintext to be an</span>
 <span class="s0">*   integral multiple of the block cipher's block length. The padding MAY be</span>
 <span class="s0">*   any length up to 255 bytes, as long as it results in the</span>
 <span class="s0">*   TLSCiphertext.length being an integral multiple of the block length.</span>
 <span class="s0">*   Lengths longer than necessary might be desirable to frustrate attacks on</span>
 <span class="s0">*   a protocol that are based on analysis of the lengths of exchanged</span>
 <span class="s0">*   messages. Each uint8 in the padding data vector MUST be filled with the</span>
 <span class="s0">*   padding length value. The receiver MUST check this padding and MUST use</span>
 <span class="s0">*   the bad_record_mac alert to indicate padding errors.</span>
 <span class="s0">*</span>
 <span class="s0">* padding_length:</span>
 <span class="s0">*   The padding length MUST be such that the total size of the</span>
 <span class="s0">*   GenericBlockCipher structure is a multiple of the cipher's block length.</span>
 <span class="s0">*   Legal values range from zero to 255, inclusive. This length specifies the</span>
 <span class="s0">*   length of the padding field exclusive of the padding_length field itself.</span>
 <span class="s0">*</span>
 <span class="s0">* The encrypted data length (TLSCiphertext.length) is one more than the sum of</span>
 <span class="s0">* SecurityParameters.block_length, TLSCompressed.length,</span>
 <span class="s0">* SecurityParameters.mac_length, and padding_length.</span>
 <span class="s0">*</span>
 <span class="s0">* Example: If the block length is 8 bytes, the content length</span>
 <span class="s0">* (TLSCompressed.length) is 61 bytes, and the MAC length is 20 bytes, then the</span>
 <span class="s0">* length before padding is 82 bytes (this does not include the IV. Thus, the</span>
 <span class="s0">* padding length modulo 8 must be equal to 6 in order to make the total length</span>
 <span class="s0">* an even multiple of 8 bytes (the block length). The padding length can be</span>
 <span class="s0">* 6, 14, 22, and so on, through 254. If the padding length were the minimum</span>
 <span class="s0">* necessary, 6, the padding would be 6 bytes, each containing the value 6.</span>
 <span class="s0">* Thus, the last 8 octets of the GenericBlockCipher before block encryption</span>
 <span class="s0">* would be xx 06 06 06 06 06 06 06, where xx is the last octet of the MAC.</span>
 <span class="s0">*</span>
 <span class="s0">* Note: With block ciphers in CBC mode (Cipher Block Chaining), it is critical</span>
 <span class="s0">* that the entire plaintext of the record be known before any ciphertext is</span>
 <span class="s0">* transmitted. Otherwise, it is possible for the attacker to mount the attack</span>
 <span class="s0">* described in [CBCATT].</span>
 <span class="s0">*</span>
 <span class="s0">* Implementation note: Canvel et al. [CBCTIME] have demonstrated a timing</span>
 <span class="s0">* attack on CBC padding based on the time required to compute the MAC. In</span>
 <span class="s0">* order to defend against this attack, implementations MUST ensure that</span>
 <span class="s0">* record processing time is essentially the same whether or not the padding</span>
 <span class="s0">* is correct. In general, the best way to do this is to compute the MAC even</span>
 <span class="s0">* if the padding is incorrect, and only then reject the packet. For instance,</span>
 <span class="s0">* if the pad appears to be incorrect, the implementation might assume a</span>
 <span class="s0">* zero-length pad and then compute the MAC. This leaves a small timing</span>
 <span class="s0">* channel, since MAC performance depends, to some extent, on the size of the</span>
 <span class="s0">* data fragment, but it is not believed to be large enough to be exploitable,</span>
 <span class="s0">* due to the large block size of existing MACs and the small size of the</span>
 <span class="s0">* timing signal.</span>
 <span class="s0">*/</span>
<span class="s3">var </span><span class="s2">forge </span><span class="s4">= </span><span class="s2">require</span><span class="s4">(</span><span class="s5">'./forge'</span><span class="s4">);</span>
<span class="s2">require</span><span class="s4">(</span><span class="s5">'./asn1'</span><span class="s4">);</span>
<span class="s2">require</span><span class="s4">(</span><span class="s5">'./hmac'</span><span class="s4">);</span>
<span class="s2">require</span><span class="s4">(</span><span class="s5">'./md5'</span><span class="s4">);</span>
<span class="s2">require</span><span class="s4">(</span><span class="s5">'./pem'</span><span class="s4">);</span>
<span class="s2">require</span><span class="s4">(</span><span class="s5">'./pki'</span><span class="s4">);</span>
<span class="s2">require</span><span class="s4">(</span><span class="s5">'./random'</span><span class="s4">);</span>
<span class="s2">require</span><span class="s4">(</span><span class="s5">'./sha1'</span><span class="s4">);</span>
<span class="s2">require</span><span class="s4">(</span><span class="s5">'./util'</span><span class="s4">);</span>

<span class="s0">/**</span>
 <span class="s0">* Generates pseudo random bytes by mixing the result of two hash functions,</span>
 <span class="s0">* MD5 and SHA-1.</span>
 <span class="s0">*</span>
 <span class="s0">* prf_TLS1(secret, label, seed) =</span>
 <span class="s0">*   P_MD5(S1, label + seed) XOR P_SHA-1(S2, label + seed);</span>
 <span class="s0">*</span>
 <span class="s0">* Each P_hash function functions as follows:</span>
 <span class="s0">*</span>
 <span class="s0">* P_hash(secret, seed) = HMAC_hash(secret, A(1) + seed) +</span>
 <span class="s0">*                        HMAC_hash(secret, A(2) + seed) +</span>
 <span class="s0">*                        HMAC_hash(secret, A(3) + seed) + ...</span>
 <span class="s0">* A() is defined as:</span>
 <span class="s0">*   A(0) = seed</span>
 <span class="s0">*   A(i) = HMAC_hash(secret, A(i-1))</span>
 <span class="s0">*</span>
 <span class="s0">* The '+' operator denotes concatenation.</span>
 <span class="s0">*</span>
 <span class="s0">* As many iterations A(N) as are needed are performed to generate enough</span>
 <span class="s0">* pseudo random byte output. If an iteration creates more data than is</span>
 <span class="s0">* necessary, then it is truncated.</span>
 <span class="s0">*</span>
 <span class="s0">* Therefore:</span>
 <span class="s0">* A(1) = HMAC_hash(secret, A(0))</span>
 <span class="s0">*      = HMAC_hash(secret, seed)</span>
 <span class="s0">* A(2) = HMAC_hash(secret, A(1))</span>
 <span class="s0">*      = HMAC_hash(secret, HMAC_hash(secret, seed))</span>
 <span class="s0">*</span>
 <span class="s0">* Therefore:</span>
 <span class="s0">* P_hash(secret, seed) =</span>
 <span class="s0">*   HMAC_hash(secret, HMAC_hash(secret, A(0)) + seed) +</span>
 <span class="s0">*   HMAC_hash(secret, HMAC_hash(secret, A(1)) + seed) +</span>
 <span class="s0">*   ...</span>
 <span class="s0">*</span>
 <span class="s0">* Therefore:</span>
 <span class="s0">* P_hash(secret, seed) =</span>
 <span class="s0">*   HMAC_hash(secret, HMAC_hash(secret, seed) + seed) +</span>
 <span class="s0">*   HMAC_hash(secret, HMAC_hash(secret, HMAC_hash(secret, seed)) + seed) +</span>
 <span class="s0">*   ...</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">secret the secret to use.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">label the label to use.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">seed the seed value to use.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">length the number of bytes to generate.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the pseudo random bytes in a byte buffer.</span>
 <span class="s0">*/</span>
<span class="s3">var </span><span class="s2">prf_TLS1 </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">secret</span><span class="s4">, </span><span class="s2">label</span><span class="s4">, </span><span class="s2">seed</span><span class="s4">, </span><span class="s2">length</span><span class="s4">) {</span>
  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>

  <span class="s6">/* For TLS 1.0, the secret is split in half, into two secrets of equal 
    length. If the secret has an odd length then the last byte of the first 
    half will be the same as the first byte of the second. The length of the 
    two secrets is half of the secret rounded up. */</span>
  <span class="s3">var </span><span class="s2">idx </span><span class="s4">= (</span><span class="s2">secret</span><span class="s4">.</span><span class="s2">length </span><span class="s4">&gt;&gt; </span><span class="s7">1</span><span class="s4">);</span>
  <span class="s3">var </span><span class="s2">slen </span><span class="s4">= </span><span class="s2">idx </span><span class="s4">+ (</span><span class="s2">secret</span><span class="s4">.</span><span class="s2">length </span><span class="s4">&amp; </span><span class="s7">1</span><span class="s4">);</span>
  <span class="s3">var </span><span class="s2">s1 </span><span class="s4">= </span><span class="s2">secret</span><span class="s4">.</span><span class="s2">substr</span><span class="s4">(</span><span class="s7">0</span><span class="s4">, </span><span class="s2">slen</span><span class="s4">);</span>
  <span class="s3">var </span><span class="s2">s2 </span><span class="s4">= </span><span class="s2">secret</span><span class="s4">.</span><span class="s2">substr</span><span class="s4">(</span><span class="s2">idx</span><span class="s4">, </span><span class="s2">slen</span><span class="s4">);</span>
  <span class="s3">var </span><span class="s2">ai </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
  <span class="s3">var </span><span class="s2">hmac </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">hmac</span><span class="s4">.</span><span class="s2">create</span><span class="s4">();</span>
  <span class="s2">seed </span><span class="s4">= </span><span class="s2">label </span><span class="s4">+ </span><span class="s2">seed</span><span class="s4">;</span>

  <span class="s6">// determine the number of iterations that must be performed to generate</span>
  <span class="s6">// enough output bytes, md5 creates 16 byte hashes, sha1 creates 20</span>
  <span class="s3">var </span><span class="s2">md5itr </span><span class="s4">= </span><span class="s2">Math</span><span class="s4">.</span><span class="s2">ceil</span><span class="s4">(</span><span class="s2">length </span><span class="s4">/ </span><span class="s7">16</span><span class="s4">);</span>
  <span class="s3">var </span><span class="s2">sha1itr </span><span class="s4">= </span><span class="s2">Math</span><span class="s4">.</span><span class="s2">ceil</span><span class="s4">(</span><span class="s2">length </span><span class="s4">/ </span><span class="s7">20</span><span class="s4">);</span>

  <span class="s6">// do md5 iterations</span>
  <span class="s2">hmac</span><span class="s4">.</span><span class="s2">start</span><span class="s4">(</span><span class="s5">'MD5'</span><span class="s4">, </span><span class="s2">s1</span><span class="s4">);</span>
  <span class="s3">var </span><span class="s2">md5bytes </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
  <span class="s2">ai</span><span class="s4">.</span><span class="s2">putBytes</span><span class="s4">(</span><span class="s2">seed</span><span class="s4">);</span>
  <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">md5itr</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
    <span class="s6">// HMAC_hash(secret, A(i-1))</span>
    <span class="s2">hmac</span><span class="s4">.</span><span class="s2">start</span><span class="s4">(</span><span class="s3">null</span><span class="s4">, </span><span class="s3">null</span><span class="s4">);</span>
    <span class="s2">hmac</span><span class="s4">.</span><span class="s2">update</span><span class="s4">(</span><span class="s2">ai</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">());</span>
    <span class="s2">ai</span><span class="s4">.</span><span class="s2">putBuffer</span><span class="s4">(</span><span class="s2">hmac</span><span class="s4">.</span><span class="s2">digest</span><span class="s4">());</span>

    <span class="s6">// HMAC_hash(secret, A(i) + seed)</span>
    <span class="s2">hmac</span><span class="s4">.</span><span class="s2">start</span><span class="s4">(</span><span class="s3">null</span><span class="s4">, </span><span class="s3">null</span><span class="s4">);</span>
    <span class="s2">hmac</span><span class="s4">.</span><span class="s2">update</span><span class="s4">(</span><span class="s2">ai</span><span class="s4">.</span><span class="s2">bytes</span><span class="s4">() + </span><span class="s2">seed</span><span class="s4">);</span>
    <span class="s2">md5bytes</span><span class="s4">.</span><span class="s2">putBuffer</span><span class="s4">(</span><span class="s2">hmac</span><span class="s4">.</span><span class="s2">digest</span><span class="s4">());</span>
  <span class="s4">}</span>

  <span class="s6">// do sha1 iterations</span>
  <span class="s2">hmac</span><span class="s4">.</span><span class="s2">start</span><span class="s4">(</span><span class="s5">'SHA1'</span><span class="s4">, </span><span class="s2">s2</span><span class="s4">);</span>
  <span class="s3">var </span><span class="s2">sha1bytes </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
  <span class="s2">ai</span><span class="s4">.</span><span class="s2">clear</span><span class="s4">();</span>
  <span class="s2">ai</span><span class="s4">.</span><span class="s2">putBytes</span><span class="s4">(</span><span class="s2">seed</span><span class="s4">);</span>
  <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">sha1itr</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
    <span class="s6">// HMAC_hash(secret, A(i-1))</span>
    <span class="s2">hmac</span><span class="s4">.</span><span class="s2">start</span><span class="s4">(</span><span class="s3">null</span><span class="s4">, </span><span class="s3">null</span><span class="s4">);</span>
    <span class="s2">hmac</span><span class="s4">.</span><span class="s2">update</span><span class="s4">(</span><span class="s2">ai</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">());</span>
    <span class="s2">ai</span><span class="s4">.</span><span class="s2">putBuffer</span><span class="s4">(</span><span class="s2">hmac</span><span class="s4">.</span><span class="s2">digest</span><span class="s4">());</span>

    <span class="s6">// HMAC_hash(secret, A(i) + seed)</span>
    <span class="s2">hmac</span><span class="s4">.</span><span class="s2">start</span><span class="s4">(</span><span class="s3">null</span><span class="s4">, </span><span class="s3">null</span><span class="s4">);</span>
    <span class="s2">hmac</span><span class="s4">.</span><span class="s2">update</span><span class="s4">(</span><span class="s2">ai</span><span class="s4">.</span><span class="s2">bytes</span><span class="s4">() + </span><span class="s2">seed</span><span class="s4">);</span>
    <span class="s2">sha1bytes</span><span class="s4">.</span><span class="s2">putBuffer</span><span class="s4">(</span><span class="s2">hmac</span><span class="s4">.</span><span class="s2">digest</span><span class="s4">());</span>
  <span class="s4">}</span>

  <span class="s6">// XOR the md5 bytes with the sha1 bytes</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putBytes</span><span class="s4">(</span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">xorBytes</span><span class="s4">(</span>
    <span class="s2">md5bytes</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">(), </span><span class="s2">sha1bytes</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">(), </span><span class="s2">length</span><span class="s4">));</span>

  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Generates pseudo random bytes using a SHA256 algorithm. For TLS 1.2.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">secret the secret to use.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">label the label to use.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">seed the seed value to use.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">length the number of bytes to generate.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the pseudo random bytes in a byte buffer.</span>
 <span class="s0">*/</span>
<span class="s3">var </span><span class="s2">prf_sha256 </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">secret</span><span class="s4">, </span><span class="s2">label</span><span class="s4">, </span><span class="s2">seed</span><span class="s4">, </span><span class="s2">length</span><span class="s4">) {</span>
   <span class="s6">// FIXME: implement me for TLS 1.2</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Gets a MAC for a record using the SHA-1 hash algorithm.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">key the mac key.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">state the sequence number (array of two 32-bit integers).</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">record the record.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the sha-1 hash (20 bytes) for the given record.</span>
 <span class="s0">*/</span>
<span class="s3">var </span><span class="s2">hmac_sha1 </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">key</span><span class="s4">, </span><span class="s2">seqNum</span><span class="s4">, </span><span class="s2">record</span><span class="s4">) {</span>
  <span class="s6">/* MAC is computed like so: 
  HMAC_hash( 
    key, seqNum + 
      TLSCompressed.type + 
      TLSCompressed.version + 
      TLSCompressed.length + 
      TLSCompressed.fragment) 
  */</span>
  <span class="s3">var </span><span class="s2">hmac </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">hmac</span><span class="s4">.</span><span class="s2">create</span><span class="s4">();</span>
  <span class="s2">hmac</span><span class="s4">.</span><span class="s2">start</span><span class="s4">(</span><span class="s5">'SHA1'</span><span class="s4">, </span><span class="s2">key</span><span class="s4">);</span>
  <span class="s3">var </span><span class="s2">b </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
  <span class="s2">b</span><span class="s4">.</span><span class="s2">putInt32</span><span class="s4">(</span><span class="s2">seqNum</span><span class="s4">[</span><span class="s7">0</span><span class="s4">]);</span>
  <span class="s2">b</span><span class="s4">.</span><span class="s2">putInt32</span><span class="s4">(</span><span class="s2">seqNum</span><span class="s4">[</span><span class="s7">1</span><span class="s4">]);</span>
  <span class="s2">b</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">record</span><span class="s4">.</span><span class="s2">type</span><span class="s4">);</span>
  <span class="s2">b</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">record</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">major</span><span class="s4">);</span>
  <span class="s2">b</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">record</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">minor</span><span class="s4">);</span>
  <span class="s2">b</span><span class="s4">.</span><span class="s2">putInt16</span><span class="s4">(</span><span class="s2">record</span><span class="s4">.</span><span class="s2">length</span><span class="s4">);</span>
  <span class="s2">b</span><span class="s4">.</span><span class="s2">putBytes</span><span class="s4">(</span><span class="s2">record</span><span class="s4">.</span><span class="s2">fragment</span><span class="s4">.</span><span class="s2">bytes</span><span class="s4">());</span>
  <span class="s2">hmac</span><span class="s4">.</span><span class="s2">update</span><span class="s4">(</span><span class="s2">b</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">());</span>
  <span class="s3">return </span><span class="s2">hmac</span><span class="s4">.</span><span class="s2">digest</span><span class="s4">().</span><span class="s2">getBytes</span><span class="s4">();</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Compresses the TLSPlaintext record into a TLSCompressed record using the</span>
 <span class="s0">* deflate algorithm.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the TLS connection.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">record the TLSPlaintext record to compress.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">s the ConnectionState to use.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">true on success, false on failure.</span>
 <span class="s0">*/</span>
<span class="s3">var </span><span class="s2">deflate </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">, </span><span class="s2">s</span><span class="s4">) {</span>
  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>

  <span class="s3">try </span><span class="s4">{</span>
    <span class="s3">var </span><span class="s2">bytes </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">deflate</span><span class="s4">(</span><span class="s2">record</span><span class="s4">.</span><span class="s2">fragment</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">());</span>
    <span class="s2">record</span><span class="s4">.</span><span class="s2">fragment </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">(</span><span class="s2">bytes</span><span class="s4">);</span>
    <span class="s2">record</span><span class="s4">.</span><span class="s2">length </span><span class="s4">= </span><span class="s2">bytes</span><span class="s4">.</span><span class="s2">length</span><span class="s4">;</span>
    <span class="s2">rval </span><span class="s4">= </span><span class="s3">true</span><span class="s4">;</span>
  <span class="s4">} </span><span class="s3">catch</span><span class="s4">(</span><span class="s2">ex</span><span class="s4">) {</span>
    <span class="s6">// deflate error, fail out</span>
  <span class="s4">}</span>

  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Decompresses the TLSCompressed record into a TLSPlaintext record using the</span>
 <span class="s0">* deflate algorithm.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the TLS connection.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">record the TLSCompressed record to decompress.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">s the ConnectionState to use.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">true on success, false on failure.</span>
 <span class="s0">*/</span>
<span class="s3">var </span><span class="s2">inflate </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">, </span><span class="s2">s</span><span class="s4">) {</span>
  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>

  <span class="s3">try </span><span class="s4">{</span>
    <span class="s3">var </span><span class="s2">bytes </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">inflate</span><span class="s4">(</span><span class="s2">record</span><span class="s4">.</span><span class="s2">fragment</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">());</span>
    <span class="s2">record</span><span class="s4">.</span><span class="s2">fragment </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">(</span><span class="s2">bytes</span><span class="s4">);</span>
    <span class="s2">record</span><span class="s4">.</span><span class="s2">length </span><span class="s4">= </span><span class="s2">bytes</span><span class="s4">.</span><span class="s2">length</span><span class="s4">;</span>
    <span class="s2">rval </span><span class="s4">= </span><span class="s3">true</span><span class="s4">;</span>
  <span class="s4">} </span><span class="s3">catch</span><span class="s4">(</span><span class="s2">ex</span><span class="s4">) {</span>
    <span class="s6">// inflate error, fail out</span>
  <span class="s4">}</span>

  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Reads a TLS variable-length vector from a byte buffer.</span>
 <span class="s0">*</span>
 <span class="s0">* Variable-length vectors are defined by specifying a subrange of legal</span>
 <span class="s0">* lengths, inclusively, using the notation &lt;floor..ceiling&gt;. When these are</span>
 <span class="s0">* encoded, the actual length precedes the vector's contents in the byte</span>
 <span class="s0">* stream. The length will be in the form of a number consuming as many bytes</span>
 <span class="s0">* as required to hold the vector's specified maximum (ceiling) length. A</span>
 <span class="s0">* variable-length vector with an actual length field of zero is referred to</span>
 <span class="s0">* as an empty vector.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">b the byte buffer.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">lenBytes the number of bytes required to store the length.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the resulting byte buffer.</span>
 <span class="s0">*/</span>
<span class="s3">var </span><span class="s2">readVector </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">b</span><span class="s4">, </span><span class="s2">lenBytes</span><span class="s4">) {</span>
  <span class="s3">var </span><span class="s2">len </span><span class="s4">= </span><span class="s7">0</span><span class="s4">;</span>
  <span class="s3">switch</span><span class="s4">(</span><span class="s2">lenBytes</span><span class="s4">) {</span>
  <span class="s3">case </span><span class="s7">1</span><span class="s4">:</span>
    <span class="s2">len </span><span class="s4">= </span><span class="s2">b</span><span class="s4">.</span><span class="s2">getByte</span><span class="s4">();</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s7">2</span><span class="s4">:</span>
    <span class="s2">len </span><span class="s4">= </span><span class="s2">b</span><span class="s4">.</span><span class="s2">getInt16</span><span class="s4">();</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s7">3</span><span class="s4">:</span>
    <span class="s2">len </span><span class="s4">= </span><span class="s2">b</span><span class="s4">.</span><span class="s2">getInt24</span><span class="s4">();</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s7">4</span><span class="s4">:</span>
    <span class="s2">len </span><span class="s4">= </span><span class="s2">b</span><span class="s4">.</span><span class="s2">getInt32</span><span class="s4">();</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s4">}</span>

  <span class="s6">// read vector bytes into a new buffer</span>
  <span class="s3">return </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">(</span><span class="s2">b</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">(</span><span class="s2">len</span><span class="s4">));</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Writes a TLS variable-length vector to a byte buffer.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">b the byte buffer.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">lenBytes the number of bytes required to store the length.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">v the byte buffer vector.</span>
 <span class="s0">*/</span>
<span class="s3">var </span><span class="s2">writeVector </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">b</span><span class="s4">, </span><span class="s2">lenBytes</span><span class="s4">, </span><span class="s2">v</span><span class="s4">) {</span>
  <span class="s6">// encode length at the start of the vector, where the number of bytes for</span>
  <span class="s6">// the length is the maximum number of bytes it would take to encode the</span>
  <span class="s6">// vector's ceiling</span>
  <span class="s2">b</span><span class="s4">.</span><span class="s2">putInt</span><span class="s4">(</span><span class="s2">v</span><span class="s4">.</span><span class="s2">length</span><span class="s4">(), </span><span class="s2">lenBytes </span><span class="s4">&lt;&lt; </span><span class="s7">3</span><span class="s4">);</span>
  <span class="s2">b</span><span class="s4">.</span><span class="s2">putBuffer</span><span class="s4">(</span><span class="s2">v</span><span class="s4">);</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* The tls implementation.</span>
 <span class="s0">*/</span>
<span class="s3">var </span><span class="s2">tls </span><span class="s4">= {};</span>

<span class="s0">/**</span>
 <span class="s0">* Version: TLS 1.2 = 3.3, TLS 1.1 = 3.2, TLS 1.0 = 3.1. Both TLS 1.1 and</span>
 <span class="s0">* TLS 1.2 were still too new (ie: openSSL didn't implement them) at the time</span>
 <span class="s0">* of this implementation so TLS 1.0 was implemented instead.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">Versions </span><span class="s4">= {</span>
  <span class="s2">TLS_1_0</span><span class="s4">: {</span><span class="s2">major</span><span class="s4">: </span><span class="s7">3</span><span class="s4">, </span><span class="s2">minor</span><span class="s4">: </span><span class="s7">1</span><span class="s4">},</span>
  <span class="s2">TLS_1_1</span><span class="s4">: {</span><span class="s2">major</span><span class="s4">: </span><span class="s7">3</span><span class="s4">, </span><span class="s2">minor</span><span class="s4">: </span><span class="s7">2</span><span class="s4">},</span>
  <span class="s2">TLS_1_2</span><span class="s4">: {</span><span class="s2">major</span><span class="s4">: </span><span class="s7">3</span><span class="s4">, </span><span class="s2">minor</span><span class="s4">: </span><span class="s7">3</span><span class="s4">}</span>
<span class="s4">};</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">SupportedVersions </span><span class="s4">= [</span>
  <span class="s2">tls</span><span class="s4">.</span><span class="s2">Versions</span><span class="s4">.</span><span class="s2">TLS_1_1</span><span class="s4">,</span>
  <span class="s2">tls</span><span class="s4">.</span><span class="s2">Versions</span><span class="s4">.</span><span class="s2">TLS_1_0</span>
<span class="s4">];</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">Version </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">SupportedVersions</span><span class="s4">[</span><span class="s7">0</span><span class="s4">];</span>

<span class="s0">/**</span>
 <span class="s0">* Maximum fragment size. True maximum is 16384, but we fragment before that</span>
 <span class="s0">* to allow for unusual small increases during compression.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">MaxFragment </span><span class="s4">= </span><span class="s7">16384 </span><span class="s4">- </span><span class="s7">1024</span><span class="s4">;</span>

<span class="s0">/**</span>
 <span class="s0">* Whether this entity is considered the &quot;client&quot; or &quot;server&quot;.</span>
 <span class="s0">* enum { server, client } ConnectionEnd;</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">ConnectionEnd </span><span class="s4">= {</span>
  <span class="s2">server</span><span class="s4">: </span><span class="s7">0</span><span class="s4">,</span>
  <span class="s2">client</span><span class="s4">: </span><span class="s7">1</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Pseudo-random function algorithm used to generate keys from the master</span>
 <span class="s0">* secret.</span>
 <span class="s0">* enum { tls_prf_sha256 } PRFAlgorithm;</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">PRFAlgorithm </span><span class="s4">= {</span>
  <span class="s2">tls_prf_sha256</span><span class="s4">: </span><span class="s7">0</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Bulk encryption algorithms.</span>
 <span class="s0">* enum { null, rc4, des3, aes } BulkCipherAlgorithm;</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">BulkCipherAlgorithm </span><span class="s4">= {</span>
  <span class="s2">none</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
  <span class="s2">rc4</span><span class="s4">: </span><span class="s7">0</span><span class="s4">,</span>
  <span class="s2">des3</span><span class="s4">: </span><span class="s7">1</span><span class="s4">,</span>
  <span class="s2">aes</span><span class="s4">: </span><span class="s7">2</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Cipher types.</span>
 <span class="s0">* enum { stream, block, aead } CipherType;</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">CipherType </span><span class="s4">= {</span>
  <span class="s2">stream</span><span class="s4">: </span><span class="s7">0</span><span class="s4">,</span>
  <span class="s2">block</span><span class="s4">: </span><span class="s7">1</span><span class="s4">,</span>
  <span class="s2">aead</span><span class="s4">: </span><span class="s7">2</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* MAC (Message Authentication Code) algorithms.</span>
 <span class="s0">* enum { null, hmac_md5, hmac_sha1, hmac_sha256,</span>
 <span class="s0">*   hmac_sha384, hmac_sha512} MACAlgorithm;</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">MACAlgorithm </span><span class="s4">= {</span>
  <span class="s2">none</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
  <span class="s2">hmac_md5</span><span class="s4">: </span><span class="s7">0</span><span class="s4">,</span>
  <span class="s2">hmac_sha1</span><span class="s4">: </span><span class="s7">1</span><span class="s4">,</span>
  <span class="s2">hmac_sha256</span><span class="s4">: </span><span class="s7">2</span><span class="s4">,</span>
  <span class="s2">hmac_sha384</span><span class="s4">: </span><span class="s7">3</span><span class="s4">,</span>
  <span class="s2">hmac_sha512</span><span class="s4">: </span><span class="s7">4</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Compression algorithms.</span>
 <span class="s0">* enum { null(0), deflate(1), (255) } CompressionMethod;</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">CompressionMethod </span><span class="s4">= {</span>
  <span class="s2">none</span><span class="s4">: </span><span class="s7">0</span><span class="s4">,</span>
  <span class="s2">deflate</span><span class="s4">: </span><span class="s7">1</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* TLS record content types.</span>
 <span class="s0">* enum {</span>
 <span class="s0">*   change_cipher_spec(20), alert(21), handshake(22),</span>
 <span class="s0">*   application_data(23), (255)</span>
 <span class="s0">* } ContentType;</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">ContentType </span><span class="s4">= {</span>
  <span class="s2">change_cipher_spec</span><span class="s4">: </span><span class="s7">20</span><span class="s4">,</span>
  <span class="s2">alert</span><span class="s4">: </span><span class="s7">21</span><span class="s4">,</span>
  <span class="s2">handshake</span><span class="s4">: </span><span class="s7">22</span><span class="s4">,</span>
  <span class="s2">application_data</span><span class="s4">: </span><span class="s7">23</span><span class="s4">,</span>
  <span class="s2">heartbeat</span><span class="s4">: </span><span class="s7">24</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* TLS handshake types.</span>
 <span class="s0">* enum {</span>
 <span class="s0">*   hello_request(0), client_hello(1), server_hello(2),</span>
 <span class="s0">*   certificate(11), server_key_exchange (12),</span>
 <span class="s0">*   certificate_request(13), server_hello_done(14),</span>
 <span class="s0">*   certificate_verify(15), client_key_exchange(16),</span>
 <span class="s0">*   finished(20), (255)</span>
 <span class="s0">* } HandshakeType;</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">HandshakeType </span><span class="s4">= {</span>
  <span class="s2">hello_request</span><span class="s4">: </span><span class="s7">0</span><span class="s4">,</span>
  <span class="s2">client_hello</span><span class="s4">: </span><span class="s7">1</span><span class="s4">,</span>
  <span class="s2">server_hello</span><span class="s4">: </span><span class="s7">2</span><span class="s4">,</span>
  <span class="s2">certificate</span><span class="s4">: </span><span class="s7">11</span><span class="s4">,</span>
  <span class="s2">server_key_exchange</span><span class="s4">: </span><span class="s7">12</span><span class="s4">,</span>
  <span class="s2">certificate_request</span><span class="s4">: </span><span class="s7">13</span><span class="s4">,</span>
  <span class="s2">server_hello_done</span><span class="s4">: </span><span class="s7">14</span><span class="s4">,</span>
  <span class="s2">certificate_verify</span><span class="s4">: </span><span class="s7">15</span><span class="s4">,</span>
  <span class="s2">client_key_exchange</span><span class="s4">: </span><span class="s7">16</span><span class="s4">,</span>
  <span class="s2">finished</span><span class="s4">: </span><span class="s7">20</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* TLS Alert Protocol.</span>
 <span class="s0">*</span>
 <span class="s0">* enum { warning(1), fatal(2), (255) } AlertLevel;</span>
 <span class="s0">*</span>
 <span class="s0">* enum {</span>
 <span class="s0">*   close_notify(0),</span>
 <span class="s0">*   unexpected_message(10),</span>
 <span class="s0">*   bad_record_mac(20),</span>
 <span class="s0">*   decryption_failed(21),</span>
 <span class="s0">*   record_overflow(22),</span>
 <span class="s0">*   decompression_failure(30),</span>
 <span class="s0">*   handshake_failure(40),</span>
 <span class="s0">*   bad_certificate(42),</span>
 <span class="s0">*   unsupported_certificate(43),</span>
 <span class="s0">*   certificate_revoked(44),</span>
 <span class="s0">*   certificate_expired(45),</span>
 <span class="s0">*   certificate_unknown(46),</span>
 <span class="s0">*   illegal_parameter(47),</span>
 <span class="s0">*   unknown_ca(48),</span>
 <span class="s0">*   access_denied(49),</span>
 <span class="s0">*   decode_error(50),</span>
 <span class="s0">*   decrypt_error(51),</span>
 <span class="s0">*   export_restriction(60),</span>
 <span class="s0">*   protocol_version(70),</span>
 <span class="s0">*   insufficient_security(71),</span>
 <span class="s0">*   internal_error(80),</span>
 <span class="s0">*   user_canceled(90),</span>
 <span class="s0">*   no_renegotiation(100),</span>
 <span class="s0">*   (255)</span>
 <span class="s0">* } AlertDescription;</span>
 <span class="s0">*</span>
 <span class="s0">* struct {</span>
 <span class="s0">*   AlertLevel level;</span>
 <span class="s0">*   AlertDescription description;</span>
 <span class="s0">* } Alert;</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert </span><span class="s4">= {};</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level </span><span class="s4">= {</span>
  <span class="s2">warning</span><span class="s4">: </span><span class="s7">1</span><span class="s4">,</span>
  <span class="s2">fatal</span><span class="s4">: </span><span class="s7">2</span>
<span class="s4">};</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description </span><span class="s4">= {</span>
  <span class="s2">close_notify</span><span class="s4">: </span><span class="s7">0</span><span class="s4">,</span>
  <span class="s2">unexpected_message</span><span class="s4">: </span><span class="s7">10</span><span class="s4">,</span>
  <span class="s2">bad_record_mac</span><span class="s4">: </span><span class="s7">20</span><span class="s4">,</span>
  <span class="s2">decryption_failed</span><span class="s4">: </span><span class="s7">21</span><span class="s4">,</span>
  <span class="s2">record_overflow</span><span class="s4">: </span><span class="s7">22</span><span class="s4">,</span>
  <span class="s2">decompression_failure</span><span class="s4">: </span><span class="s7">30</span><span class="s4">,</span>
  <span class="s2">handshake_failure</span><span class="s4">: </span><span class="s7">40</span><span class="s4">,</span>
  <span class="s2">bad_certificate</span><span class="s4">: </span><span class="s7">42</span><span class="s4">,</span>
  <span class="s2">unsupported_certificate</span><span class="s4">: </span><span class="s7">43</span><span class="s4">,</span>
  <span class="s2">certificate_revoked</span><span class="s4">: </span><span class="s7">44</span><span class="s4">,</span>
  <span class="s2">certificate_expired</span><span class="s4">: </span><span class="s7">45</span><span class="s4">,</span>
  <span class="s2">certificate_unknown</span><span class="s4">: </span><span class="s7">46</span><span class="s4">,</span>
  <span class="s2">illegal_parameter</span><span class="s4">: </span><span class="s7">47</span><span class="s4">,</span>
  <span class="s2">unknown_ca</span><span class="s4">: </span><span class="s7">48</span><span class="s4">,</span>
  <span class="s2">access_denied</span><span class="s4">: </span><span class="s7">49</span><span class="s4">,</span>
  <span class="s2">decode_error</span><span class="s4">: </span><span class="s7">50</span><span class="s4">,</span>
  <span class="s2">decrypt_error</span><span class="s4">: </span><span class="s7">51</span><span class="s4">,</span>
  <span class="s2">export_restriction</span><span class="s4">: </span><span class="s7">60</span><span class="s4">,</span>
  <span class="s2">protocol_version</span><span class="s4">: </span><span class="s7">70</span><span class="s4">,</span>
  <span class="s2">insufficient_security</span><span class="s4">: </span><span class="s7">71</span><span class="s4">,</span>
  <span class="s2">internal_error</span><span class="s4">: </span><span class="s7">80</span><span class="s4">,</span>
  <span class="s2">user_canceled</span><span class="s4">: </span><span class="s7">90</span><span class="s4">,</span>
  <span class="s2">no_renegotiation</span><span class="s4">: </span><span class="s7">100</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* TLS Heartbeat Message types.</span>
 <span class="s0">* enum {</span>
 <span class="s0">*   heartbeat_request(1),</span>
 <span class="s0">*   heartbeat_response(2),</span>
 <span class="s0">*   (255)</span>
 <span class="s0">* } HeartbeatMessageType;</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">HeartbeatMessageType </span><span class="s4">= {</span>
  <span class="s2">heartbeat_request</span><span class="s4">: </span><span class="s7">1</span><span class="s4">,</span>
  <span class="s2">heartbeat_response</span><span class="s4">: </span><span class="s7">2</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Supported cipher suites.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">CipherSuites </span><span class="s4">= {};</span>

<span class="s0">/**</span>
 <span class="s0">* Gets a supported cipher suite from its 2 byte ID.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">twoBytes two bytes in a string.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the matching supported cipher suite or null.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">getCipherSuite </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">twoBytes</span><span class="s4">) {</span>
  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
  <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">key </span><span class="s3">in </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">CipherSuites</span><span class="s4">) {</span>
    <span class="s3">var </span><span class="s2">cs </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">CipherSuites</span><span class="s4">[</span><span class="s2">key</span><span class="s4">];</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">cs</span><span class="s4">.</span><span class="s2">id</span><span class="s4">[</span><span class="s7">0</span><span class="s4">] === </span><span class="s2">twoBytes</span><span class="s4">.</span><span class="s2">charCodeAt</span><span class="s4">(</span><span class="s7">0</span><span class="s4">) &amp;&amp;</span>
      <span class="s2">cs</span><span class="s4">.</span><span class="s2">id</span><span class="s4">[</span><span class="s7">1</span><span class="s4">] === </span><span class="s2">twoBytes</span><span class="s4">.</span><span class="s2">charCodeAt</span><span class="s4">(</span><span class="s7">1</span><span class="s4">)) {</span>
      <span class="s2">rval </span><span class="s4">= </span><span class="s2">cs</span><span class="s4">;</span>
      <span class="s3">break</span><span class="s4">;</span>
    <span class="s4">}</span>
  <span class="s4">}</span>
  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Called when an unexpected record is encountered.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">record the record.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">handleUnexpected </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">) {</span>
  <span class="s6">// if connection is client and closed, ignore unexpected messages</span>
  <span class="s3">var </span><span class="s2">ignore </span><span class="s4">= (!</span><span class="s2">c</span><span class="s4">.</span><span class="s2">open </span><span class="s4">&amp;&amp; </span><span class="s2">c</span><span class="s4">.</span><span class="s2">entity </span><span class="s4">=== </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ConnectionEnd</span><span class="s4">.</span><span class="s2">client</span><span class="s4">);</span>
  <span class="s3">if</span><span class="s4">(!</span><span class="s2">ignore</span><span class="s4">) {</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
      <span class="s2">message</span><span class="s4">: </span><span class="s5">'Unexpected message. Received TLS record out of order.'</span><span class="s4">,</span>
      <span class="s2">send</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">alert</span><span class="s4">: {</span>
        <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
        <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">unexpected_message</span>
      <span class="s4">}</span>
    <span class="s4">});</span>
  <span class="s4">}</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Called when a client receives a HelloRequest record.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">record the record.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">length the length of the handshake message.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">handleHelloRequest </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">, </span><span class="s2">length</span><span class="s4">) {</span>
  <span class="s6">// ignore renegotiation requests from the server during a handshake, but</span>
  <span class="s6">// if handshaking, send a warning alert that renegotation is denied</span>
  <span class="s3">if</span><span class="s4">(!</span><span class="s2">c</span><span class="s4">.</span><span class="s2">handshaking </span><span class="s4">&amp;&amp; </span><span class="s2">c</span><span class="s4">.</span><span class="s2">handshakes </span><span class="s4">&gt; </span><span class="s7">0</span><span class="s4">) {</span>
    <span class="s6">// send alert warning</span>
    <span class="s2">tls</span><span class="s4">.</span><span class="s2">queue</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createAlert</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
       <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">warning</span><span class="s4">,</span>
       <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">no_renegotiation</span>
    <span class="s4">}));</span>
    <span class="s2">tls</span><span class="s4">.</span><span class="s2">flush</span><span class="s4">(</span><span class="s2">c</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s6">// continue</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">process</span><span class="s4">();</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Parses a hello message from a ClientHello or ServerHello record.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">record the record to parse.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the parsed message.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">parseHelloMessage </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">, </span><span class="s2">length</span><span class="s4">) {</span>
  <span class="s3">var </span><span class="s2">msg </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>

  <span class="s3">var </span><span class="s2">client </span><span class="s4">= (</span><span class="s2">c</span><span class="s4">.</span><span class="s2">entity </span><span class="s4">=== </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ConnectionEnd</span><span class="s4">.</span><span class="s2">client</span><span class="s4">);</span>

  <span class="s6">// minimum of 38 bytes in message</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">length </span><span class="s4">&lt; </span><span class="s7">38</span><span class="s4">) {</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
      <span class="s2">message</span><span class="s4">: </span><span class="s2">client </span><span class="s4">?</span>
        <span class="s5">'Invalid ServerHello message. Message too short.' </span><span class="s4">:</span>
        <span class="s5">'Invalid ClientHello message. Message too short.'</span><span class="s4">,</span>
      <span class="s2">send</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">alert</span><span class="s4">: {</span>
        <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
        <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">illegal_parameter</span>
      <span class="s4">}</span>
    <span class="s4">});</span>
  <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
    <span class="s6">// use 'remaining' to calculate # of remaining bytes in the message</span>
    <span class="s3">var </span><span class="s2">b </span><span class="s4">= </span><span class="s2">record</span><span class="s4">.</span><span class="s2">fragment</span><span class="s4">;</span>
    <span class="s3">var </span><span class="s2">remaining </span><span class="s4">= </span><span class="s2">b</span><span class="s4">.</span><span class="s2">length</span><span class="s4">();</span>
    <span class="s2">msg </span><span class="s4">= {</span>
      <span class="s2">version</span><span class="s4">: {</span>
        <span class="s2">major</span><span class="s4">: </span><span class="s2">b</span><span class="s4">.</span><span class="s2">getByte</span><span class="s4">(),</span>
        <span class="s2">minor</span><span class="s4">: </span><span class="s2">b</span><span class="s4">.</span><span class="s2">getByte</span><span class="s4">()</span>
      <span class="s4">},</span>
      <span class="s2">random</span><span class="s4">: </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">(</span><span class="s2">b</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">(</span><span class="s7">32</span><span class="s4">)),</span>
      <span class="s2">session_id</span><span class="s4">: </span><span class="s2">readVector</span><span class="s4">(</span><span class="s2">b</span><span class="s4">, </span><span class="s7">1</span><span class="s4">),</span>
      <span class="s2">extensions</span><span class="s4">: []</span>
    <span class="s4">};</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">client</span><span class="s4">) {</span>
      <span class="s2">msg</span><span class="s4">.</span><span class="s2">cipher_suite </span><span class="s4">= </span><span class="s2">b</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">(</span><span class="s7">2</span><span class="s4">);</span>
      <span class="s2">msg</span><span class="s4">.</span><span class="s2">compression_method </span><span class="s4">= </span><span class="s2">b</span><span class="s4">.</span><span class="s2">getByte</span><span class="s4">();</span>
    <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
      <span class="s2">msg</span><span class="s4">.</span><span class="s2">cipher_suites </span><span class="s4">= </span><span class="s2">readVector</span><span class="s4">(</span><span class="s2">b</span><span class="s4">, </span><span class="s7">2</span><span class="s4">);</span>
      <span class="s2">msg</span><span class="s4">.</span><span class="s2">compression_methods </span><span class="s4">= </span><span class="s2">readVector</span><span class="s4">(</span><span class="s2">b</span><span class="s4">, </span><span class="s7">1</span><span class="s4">);</span>
    <span class="s4">}</span>

    <span class="s6">// read extensions if there are any bytes left in the message</span>
    <span class="s2">remaining </span><span class="s4">= </span><span class="s2">length </span><span class="s4">- (</span><span class="s2">remaining </span><span class="s4">- </span><span class="s2">b</span><span class="s4">.</span><span class="s2">length</span><span class="s4">());</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">remaining </span><span class="s4">&gt; </span><span class="s7">0</span><span class="s4">) {</span>
      <span class="s6">// parse extensions</span>
      <span class="s3">var </span><span class="s2">exts </span><span class="s4">= </span><span class="s2">readVector</span><span class="s4">(</span><span class="s2">b</span><span class="s4">, </span><span class="s7">2</span><span class="s4">);</span>
      <span class="s3">while</span><span class="s4">(</span><span class="s2">exts</span><span class="s4">.</span><span class="s2">length</span><span class="s4">() &gt; </span><span class="s7">0</span><span class="s4">) {</span>
        <span class="s2">msg</span><span class="s4">.</span><span class="s2">extensions</span><span class="s4">.</span><span class="s2">push</span><span class="s4">({</span>
          <span class="s2">type</span><span class="s4">: [</span><span class="s2">exts</span><span class="s4">.</span><span class="s2">getByte</span><span class="s4">(), </span><span class="s2">exts</span><span class="s4">.</span><span class="s2">getByte</span><span class="s4">()],</span>
          <span class="s2">data</span><span class="s4">: </span><span class="s2">readVector</span><span class="s4">(</span><span class="s2">exts</span><span class="s4">, </span><span class="s7">2</span><span class="s4">)</span>
        <span class="s4">});</span>
      <span class="s4">}</span>

      <span class="s6">// TODO: make extension support modular</span>
      <span class="s3">if</span><span class="s4">(!</span><span class="s2">client</span><span class="s4">) {</span>
        <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">msg</span><span class="s4">.</span><span class="s2">extensions</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
          <span class="s3">var </span><span class="s2">ext </span><span class="s4">= </span><span class="s2">msg</span><span class="s4">.</span><span class="s2">extensions</span><span class="s4">[</span><span class="s2">i</span><span class="s4">];</span>

          <span class="s6">// support SNI extension</span>
          <span class="s3">if</span><span class="s4">(</span><span class="s2">ext</span><span class="s4">.</span><span class="s2">type</span><span class="s4">[</span><span class="s7">0</span><span class="s4">] === </span><span class="s7">0x00 </span><span class="s4">&amp;&amp; </span><span class="s2">ext</span><span class="s4">.</span><span class="s2">type</span><span class="s4">[</span><span class="s7">1</span><span class="s4">] === </span><span class="s7">0x00</span><span class="s4">) {</span>
            <span class="s6">// get server name list</span>
            <span class="s3">var </span><span class="s2">snl </span><span class="s4">= </span><span class="s2">readVector</span><span class="s4">(</span><span class="s2">ext</span><span class="s4">.</span><span class="s2">data</span><span class="s4">, </span><span class="s7">2</span><span class="s4">);</span>
            <span class="s3">while</span><span class="s4">(</span><span class="s2">snl</span><span class="s4">.</span><span class="s2">length</span><span class="s4">() &gt; </span><span class="s7">0</span><span class="s4">) {</span>
              <span class="s6">// read server name type</span>
              <span class="s3">var </span><span class="s2">snType </span><span class="s4">= </span><span class="s2">snl</span><span class="s4">.</span><span class="s2">getByte</span><span class="s4">();</span>

              <span class="s6">// only HostName type (0x00) is known, break out if</span>
              <span class="s6">// another type is detected</span>
              <span class="s3">if</span><span class="s4">(</span><span class="s2">snType </span><span class="s4">!== </span><span class="s7">0x00</span><span class="s4">) {</span>
                <span class="s3">break</span><span class="s4">;</span>
              <span class="s4">}</span>

              <span class="s6">// add host name to server name list</span>
              <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">extensions</span><span class="s4">.</span><span class="s2">server_name</span><span class="s4">.</span><span class="s2">serverNameList</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span>
                <span class="s2">readVector</span><span class="s4">(</span><span class="s2">snl</span><span class="s4">, </span><span class="s7">2</span><span class="s4">).</span><span class="s2">getBytes</span><span class="s4">());</span>
            <span class="s4">}</span>
          <span class="s4">}</span>
        <span class="s4">}</span>
      <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s6">// version already set, do not allow version change</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">version</span><span class="s4">) {</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">major </span><span class="s4">!== </span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">major </span><span class="s4">||</span>
        <span class="s2">msg</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">minor </span><span class="s4">!== </span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">minor</span><span class="s4">) {</span>
        <span class="s3">return </span><span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
          <span class="s2">message</span><span class="s4">: </span><span class="s5">'TLS version change is disallowed during renegotiation.'</span><span class="s4">,</span>
          <span class="s2">send</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
          <span class="s2">alert</span><span class="s4">: {</span>
            <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
            <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">protocol_version</span>
          <span class="s4">}</span>
        <span class="s4">});</span>
      <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s6">// get the chosen (ServerHello) cipher suite</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">client</span><span class="s4">) {</span>
      <span class="s6">// FIXME: should be checking configured acceptable cipher suites</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">cipherSuite </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">getCipherSuite</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">.</span><span class="s2">cipher_suite</span><span class="s4">);</span>
    <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
      <span class="s6">// get a supported preferred (ClientHello) cipher suite</span>
      <span class="s6">// choose the first supported cipher suite</span>
      <span class="s3">var </span><span class="s2">tmp </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">.</span><span class="s2">cipher_suites</span><span class="s4">.</span><span class="s2">bytes</span><span class="s4">());</span>
      <span class="s3">while</span><span class="s4">(</span><span class="s2">tmp</span><span class="s4">.</span><span class="s2">length</span><span class="s4">() &gt; </span><span class="s7">0</span><span class="s4">) {</span>
        <span class="s6">// FIXME: should be checking configured acceptable suites</span>
        <span class="s6">// cipher suites take up 2 bytes</span>
        <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">cipherSuite </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">getCipherSuite</span><span class="s4">(</span><span class="s2">tmp</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">(</span><span class="s7">2</span><span class="s4">));</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">cipherSuite </span><span class="s4">!== </span><span class="s3">null</span><span class="s4">) {</span>
          <span class="s3">break</span><span class="s4">;</span>
        <span class="s4">}</span>
      <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s6">// cipher suite not supported</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">cipherSuite </span><span class="s4">=== </span><span class="s3">null</span><span class="s4">) {</span>
      <span class="s3">return </span><span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
        <span class="s2">message</span><span class="s4">: </span><span class="s5">'No cipher suites in common.'</span><span class="s4">,</span>
        <span class="s2">send</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
        <span class="s2">alert</span><span class="s4">: {</span>
          <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
          <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">handshake_failure</span>
        <span class="s4">},</span>
        <span class="s2">cipherSuite</span><span class="s4">: </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">bytesToHex</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">.</span><span class="s2">cipher_suite</span><span class="s4">)</span>
      <span class="s4">});</span>
    <span class="s4">}</span>

    <span class="s6">// TODO: handle compression methods</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">client</span><span class="s4">) {</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">compressionMethod </span><span class="s4">= </span><span class="s2">msg</span><span class="s4">.</span><span class="s2">compression_method</span><span class="s4">;</span>
    <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
      <span class="s6">// no compression</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">compressionMethod </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">CompressionMethod</span><span class="s4">.</span><span class="s2">none</span><span class="s4">;</span>
    <span class="s4">}</span>
  <span class="s4">}</span>

  <span class="s3">return </span><span class="s2">msg</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Creates security parameters for the given connection based on the given</span>
 <span class="s0">* hello message.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the TLS connection.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">msg the hello message.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">createSecurityParameters </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">msg</span><span class="s4">) {</span>
  <span class="s6">/* Note: security params are from TLS 1.2, some values like prf_algorithm 
  are ignored for TLS 1.0/1.1 and the builtin as specified in the spec is 
  used. */</span>

  <span class="s6">// TODO: handle other options from server when more supported</span>

  <span class="s6">// get client and server randoms</span>
  <span class="s3">var </span><span class="s2">client </span><span class="s4">= (</span><span class="s2">c</span><span class="s4">.</span><span class="s2">entity </span><span class="s4">=== </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ConnectionEnd</span><span class="s4">.</span><span class="s2">client</span><span class="s4">);</span>
  <span class="s3">var </span><span class="s2">msgRandom </span><span class="s4">= </span><span class="s2">msg</span><span class="s4">.</span><span class="s2">random</span><span class="s4">.</span><span class="s2">bytes</span><span class="s4">();</span>
  <span class="s3">var </span><span class="s2">cRandom </span><span class="s4">= </span><span class="s2">client </span><span class="s4">? </span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">sp</span><span class="s4">.</span><span class="s2">client_random </span><span class="s4">: </span><span class="s2">msgRandom</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">sRandom </span><span class="s4">= </span><span class="s2">client </span><span class="s4">? </span><span class="s2">msgRandom </span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createRandom</span><span class="s4">().</span><span class="s2">getBytes</span><span class="s4">();</span>

  <span class="s6">// create new security parameters</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">sp </span><span class="s4">= {</span>
    <span class="s2">entity</span><span class="s4">: </span><span class="s2">c</span><span class="s4">.</span><span class="s2">entity</span><span class="s4">,</span>
    <span class="s2">prf_algorithm</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">PRFAlgorithm</span><span class="s4">.</span><span class="s2">tls_prf_sha256</span><span class="s4">,</span>
    <span class="s2">bulk_cipher_algorithm</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
    <span class="s2">cipher_type</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
    <span class="s2">enc_key_length</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
    <span class="s2">block_length</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
    <span class="s2">fixed_iv_length</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
    <span class="s2">record_iv_length</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
    <span class="s2">mac_algorithm</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
    <span class="s2">mac_length</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
    <span class="s2">mac_key_length</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
    <span class="s2">compression_algorithm</span><span class="s4">: </span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">compressionMethod</span><span class="s4">,</span>
    <span class="s2">pre_master_secret</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
    <span class="s2">master_secret</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
    <span class="s2">client_random</span><span class="s4">: </span><span class="s2">cRandom</span><span class="s4">,</span>
    <span class="s2">server_random</span><span class="s4">: </span><span class="s2">sRandom</span>
  <span class="s4">};</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Called when a client receives a ServerHello record.</span>
 <span class="s0">*</span>
 <span class="s0">* When a ServerHello message will be sent:</span>
 <span class="s0">*   The server will send this message in response to a client hello message</span>
 <span class="s0">*   when it was able to find an acceptable set of algorithms. If it cannot</span>
 <span class="s0">*   find such a match, it will respond with a handshake failure alert.</span>
 <span class="s0">*</span>
 <span class="s0">* uint24 length;</span>
 <span class="s0">* struct {</span>
 <span class="s0">*   ProtocolVersion server_version;</span>
 <span class="s0">*   Random random;</span>
 <span class="s0">*   SessionID session_id;</span>
 <span class="s0">*   CipherSuite cipher_suite;</span>
 <span class="s0">*   CompressionMethod compression_method;</span>
 <span class="s0">*   select(extensions_present) {</span>
 <span class="s0">*     case false:</span>
 <span class="s0">*       struct {};</span>
 <span class="s0">*     case true:</span>
 <span class="s0">*       Extension extensions&lt;0..2^16-1&gt;;</span>
 <span class="s0">*   };</span>
 <span class="s0">* } ServerHello;</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">record the record.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">length the length of the handshake message.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">handleServerHello </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">, </span><span class="s2">length</span><span class="s4">) {</span>
  <span class="s3">var </span><span class="s2">msg </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">parseHelloMessage</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">, </span><span class="s2">length</span><span class="s4">);</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">fail</span><span class="s4">) {</span>
    <span class="s3">return</span><span class="s4">;</span>
  <span class="s4">}</span>

  <span class="s6">// ensure server version is compatible</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">minor </span><span class="s4">&lt;= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">minor</span><span class="s4">) {</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">minor </span><span class="s4">= </span><span class="s2">msg</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">minor</span><span class="s4">;</span>
  <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
    <span class="s3">return </span><span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
      <span class="s2">message</span><span class="s4">: </span><span class="s5">'Incompatible TLS version.'</span><span class="s4">,</span>
      <span class="s2">send</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">alert</span><span class="s4">: {</span>
        <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
        <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">protocol_version</span>
      <span class="s4">}</span>
    <span class="s4">});</span>
  <span class="s4">}</span>

  <span class="s6">// indicate session version has been set</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">version </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">version</span><span class="s4">;</span>

  <span class="s6">// get the session ID from the message</span>
  <span class="s3">var </span><span class="s2">sessionId </span><span class="s4">= </span><span class="s2">msg</span><span class="s4">.</span><span class="s2">session_id</span><span class="s4">.</span><span class="s2">bytes</span><span class="s4">();</span>

  <span class="s6">// if the session ID is not blank and matches the cached one, resume</span>
  <span class="s6">// the session</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">sessionId</span><span class="s4">.</span><span class="s2">length </span><span class="s4">&gt; </span><span class="s7">0 </span><span class="s4">&amp;&amp; </span><span class="s2">sessionId </span><span class="s4">=== </span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">id</span><span class="s4">) {</span>
    <span class="s6">// resuming session, expect a ChangeCipherSpec next</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">expect </span><span class="s4">= </span><span class="s2">SCC</span><span class="s4">;</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">resuming </span><span class="s4">= </span><span class="s3">true</span><span class="s4">;</span>

    <span class="s6">// get new server random</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">sp</span><span class="s4">.</span><span class="s2">server_random </span><span class="s4">= </span><span class="s2">msg</span><span class="s4">.</span><span class="s2">random</span><span class="s4">.</span><span class="s2">bytes</span><span class="s4">();</span>
  <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
    <span class="s6">// not resuming, expect a server Certificate message next</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">expect </span><span class="s4">= </span><span class="s2">SCE</span><span class="s4">;</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">resuming </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>

    <span class="s6">// create new security parameters</span>
    <span class="s2">tls</span><span class="s4">.</span><span class="s2">createSecurityParameters</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">msg</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s6">// set new session ID</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">id </span><span class="s4">= </span><span class="s2">sessionId</span><span class="s4">;</span>

  <span class="s6">// continue</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">process</span><span class="s4">();</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Called when a server receives a ClientHello record.</span>
 <span class="s0">*</span>
 <span class="s0">* When a ClientHello message will be sent:</span>
 <span class="s0">*   When a client first connects to a server it is required to send the</span>
 <span class="s0">*   client hello as its first message. The client can also send a client</span>
 <span class="s0">*   hello in response to a hello request or on its own initiative in order</span>
 <span class="s0">*   to renegotiate the security parameters in an existing connection.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">record the record.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">length the length of the handshake message.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">handleClientHello </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">, </span><span class="s2">length</span><span class="s4">) {</span>
  <span class="s3">var </span><span class="s2">msg </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">parseHelloMessage</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">, </span><span class="s2">length</span><span class="s4">);</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">fail</span><span class="s4">) {</span>
    <span class="s3">return</span><span class="s4">;</span>
  <span class="s4">}</span>

  <span class="s6">// get the session ID from the message</span>
  <span class="s3">var </span><span class="s2">sessionId </span><span class="s4">= </span><span class="s2">msg</span><span class="s4">.</span><span class="s2">session_id</span><span class="s4">.</span><span class="s2">bytes</span><span class="s4">();</span>

  <span class="s6">// see if the given session ID is in the cache</span>
  <span class="s3">var </span><span class="s2">session </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">sessionCache</span><span class="s4">) {</span>
    <span class="s2">session </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">sessionCache</span><span class="s4">.</span><span class="s2">getSession</span><span class="s4">(</span><span class="s2">sessionId</span><span class="s4">);</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">session </span><span class="s4">=== </span><span class="s3">null</span><span class="s4">) {</span>
      <span class="s6">// session ID not found</span>
      <span class="s2">sessionId </span><span class="s4">= </span><span class="s5">''</span><span class="s4">;</span>
    <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">session</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">major </span><span class="s4">!== </span><span class="s2">msg</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">major </span><span class="s4">||</span>
      <span class="s2">session</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">minor </span><span class="s4">&gt; </span><span class="s2">msg</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">minor</span><span class="s4">) {</span>
      <span class="s6">// if session version is incompatible with client version, do not resume</span>
      <span class="s2">session </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
      <span class="s2">sessionId </span><span class="s4">= </span><span class="s5">''</span><span class="s4">;</span>
    <span class="s4">}</span>
  <span class="s4">}</span>

  <span class="s6">// no session found to resume, generate a new session ID</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">sessionId</span><span class="s4">.</span><span class="s2">length </span><span class="s4">=== </span><span class="s7">0</span><span class="s4">) {</span>
    <span class="s2">sessionId </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">random</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">(</span><span class="s7">32</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s6">// update session</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">id </span><span class="s4">= </span><span class="s2">sessionId</span><span class="s4">;</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">clientHelloVersion </span><span class="s4">= </span><span class="s2">msg</span><span class="s4">.</span><span class="s2">version</span><span class="s4">;</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">sp </span><span class="s4">= {};</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">session</span><span class="s4">) {</span>
    <span class="s6">// use version and security parameters from resumed session</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">version </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">version </span><span class="s4">= </span><span class="s2">session</span><span class="s4">.</span><span class="s2">version</span><span class="s4">;</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">sp </span><span class="s4">= </span><span class="s2">session</span><span class="s4">.</span><span class="s2">sp</span><span class="s4">;</span>
  <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
    <span class="s6">// use highest compatible minor version</span>
    <span class="s3">var </span><span class="s2">version</span><span class="s4">;</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">1</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">SupportedVersions</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s2">version </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">SupportedVersions</span><span class="s4">[</span><span class="s2">i</span><span class="s4">];</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">version</span><span class="s4">.</span><span class="s2">minor </span><span class="s4">&lt;= </span><span class="s2">msg</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">minor</span><span class="s4">) {</span>
        <span class="s3">break</span><span class="s4">;</span>
      <span class="s4">}</span>
    <span class="s4">}</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">version </span><span class="s4">= {</span><span class="s2">major</span><span class="s4">: </span><span class="s2">version</span><span class="s4">.</span><span class="s2">major</span><span class="s4">, </span><span class="s2">minor</span><span class="s4">: </span><span class="s2">version</span><span class="s4">.</span><span class="s2">minor</span><span class="s4">};</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">version </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">version</span><span class="s4">;</span>
  <span class="s4">}</span>

  <span class="s6">// if a session is set, resume it</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">session </span><span class="s4">!== </span><span class="s3">null</span><span class="s4">) {</span>
    <span class="s6">// resuming session, expect a ChangeCipherSpec next</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">expect </span><span class="s4">= </span><span class="s2">CCC</span><span class="s4">;</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">resuming </span><span class="s4">= </span><span class="s3">true</span><span class="s4">;</span>

    <span class="s6">// get new client random</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">sp</span><span class="s4">.</span><span class="s2">client_random </span><span class="s4">= </span><span class="s2">msg</span><span class="s4">.</span><span class="s2">random</span><span class="s4">.</span><span class="s2">bytes</span><span class="s4">();</span>
  <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
    <span class="s6">// not resuming, expect a Certificate or ClientKeyExchange</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">expect </span><span class="s4">= (</span><span class="s2">c</span><span class="s4">.</span><span class="s2">verifyClient </span><span class="s4">!== </span><span class="s3">false</span><span class="s4">) ? </span><span class="s2">CCE </span><span class="s4">: </span><span class="s2">CKE</span><span class="s4">;</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">resuming </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>

    <span class="s6">// create new security parameters</span>
    <span class="s2">tls</span><span class="s4">.</span><span class="s2">createSecurityParameters</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">msg</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s6">// connection now open</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">open </span><span class="s4">= </span><span class="s3">true</span><span class="s4">;</span>

  <span class="s6">// queue server hello</span>
  <span class="s2">tls</span><span class="s4">.</span><span class="s2">queue</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createRecord</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
    <span class="s2">type</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ContentType</span><span class="s4">.</span><span class="s2">handshake</span><span class="s4">,</span>
    <span class="s2">data</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createServerHello</span><span class="s4">(</span><span class="s2">c</span><span class="s4">)</span>
  <span class="s4">}));</span>

  <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">resuming</span><span class="s4">) {</span>
    <span class="s6">// queue change cipher spec message</span>
    <span class="s2">tls</span><span class="s4">.</span><span class="s2">queue</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createRecord</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ContentType</span><span class="s4">.</span><span class="s2">change_cipher_spec</span><span class="s4">,</span>
      <span class="s2">data</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createChangeCipherSpec</span><span class="s4">()</span>
    <span class="s4">}));</span>

    <span class="s6">// create pending state</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">state</span><span class="s4">.</span><span class="s2">pending </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createConnectionState</span><span class="s4">(</span><span class="s2">c</span><span class="s4">);</span>

    <span class="s6">// change current write state to pending write state</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">state</span><span class="s4">.</span><span class="s2">current</span><span class="s4">.</span><span class="s2">write </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">state</span><span class="s4">.</span><span class="s2">pending</span><span class="s4">.</span><span class="s2">write</span><span class="s4">;</span>

    <span class="s6">// queue finished</span>
    <span class="s2">tls</span><span class="s4">.</span><span class="s2">queue</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createRecord</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ContentType</span><span class="s4">.</span><span class="s2">handshake</span><span class="s4">,</span>
      <span class="s2">data</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createFinished</span><span class="s4">(</span><span class="s2">c</span><span class="s4">)</span>
    <span class="s4">}));</span>
  <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
    <span class="s6">// queue server certificate</span>
    <span class="s2">tls</span><span class="s4">.</span><span class="s2">queue</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createRecord</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ContentType</span><span class="s4">.</span><span class="s2">handshake</span><span class="s4">,</span>
      <span class="s2">data</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createCertificate</span><span class="s4">(</span><span class="s2">c</span><span class="s4">)</span>
    <span class="s4">}));</span>

    <span class="s3">if</span><span class="s4">(!</span><span class="s2">c</span><span class="s4">.</span><span class="s2">fail</span><span class="s4">) {</span>
      <span class="s6">// queue server key exchange</span>
      <span class="s2">tls</span><span class="s4">.</span><span class="s2">queue</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createRecord</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
        <span class="s2">type</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ContentType</span><span class="s4">.</span><span class="s2">handshake</span><span class="s4">,</span>
        <span class="s2">data</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createServerKeyExchange</span><span class="s4">(</span><span class="s2">c</span><span class="s4">)</span>
      <span class="s4">}));</span>

      <span class="s6">// request client certificate if set</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">verifyClient </span><span class="s4">!== </span><span class="s3">false</span><span class="s4">) {</span>
        <span class="s6">// queue certificate request</span>
        <span class="s2">tls</span><span class="s4">.</span><span class="s2">queue</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createRecord</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
          <span class="s2">type</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ContentType</span><span class="s4">.</span><span class="s2">handshake</span><span class="s4">,</span>
          <span class="s2">data</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createCertificateRequest</span><span class="s4">(</span><span class="s2">c</span><span class="s4">)</span>
        <span class="s4">}));</span>
      <span class="s4">}</span>

      <span class="s6">// queue server hello done</span>
      <span class="s2">tls</span><span class="s4">.</span><span class="s2">queue</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createRecord</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
        <span class="s2">type</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ContentType</span><span class="s4">.</span><span class="s2">handshake</span><span class="s4">,</span>
        <span class="s2">data</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createServerHelloDone</span><span class="s4">(</span><span class="s2">c</span><span class="s4">)</span>
      <span class="s4">}));</span>
    <span class="s4">}</span>
  <span class="s4">}</span>

  <span class="s6">// send records</span>
  <span class="s2">tls</span><span class="s4">.</span><span class="s2">flush</span><span class="s4">(</span><span class="s2">c</span><span class="s4">);</span>

  <span class="s6">// continue</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">process</span><span class="s4">();</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Called when a client receives a Certificate record.</span>
 <span class="s0">*</span>
 <span class="s0">* When this message will be sent:</span>
 <span class="s0">*   The server must send a certificate whenever the agreed-upon key exchange</span>
 <span class="s0">*   method is not an anonymous one. This message will always immediately</span>
 <span class="s0">*   follow the server hello message.</span>
 <span class="s0">*</span>
 <span class="s0">* Meaning of this message:</span>
 <span class="s0">*   The certificate type must be appropriate for the selected cipher suite's</span>
 <span class="s0">*   key exchange algorithm, and is generally an X.509v3 certificate. It must</span>
 <span class="s0">*   contain a key which matches the key exchange method, as follows. Unless</span>
 <span class="s0">*   otherwise specified, the signing algorithm for the certificate must be</span>
 <span class="s0">*   the same as the algorithm for the certificate key. Unless otherwise</span>
 <span class="s0">*   specified, the public key may be of any length.</span>
 <span class="s0">*</span>
 <span class="s0">* opaque ASN.1Cert&lt;1..2^24-1&gt;;</span>
 <span class="s0">* struct {</span>
 <span class="s0">*   ASN.1Cert certificate_list&lt;1..2^24-1&gt;;</span>
 <span class="s0">* } Certificate;</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">record the record.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">length the length of the handshake message.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">handleCertificate </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">, </span><span class="s2">length</span><span class="s4">) {</span>
  <span class="s6">// minimum of 3 bytes in message</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">length </span><span class="s4">&lt; </span><span class="s7">3</span><span class="s4">) {</span>
    <span class="s3">return </span><span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
      <span class="s2">message</span><span class="s4">: </span><span class="s5">'Invalid Certificate message. Message too short.'</span><span class="s4">,</span>
      <span class="s2">send</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">alert</span><span class="s4">: {</span>
        <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
        <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">illegal_parameter</span>
      <span class="s4">}</span>
    <span class="s4">});</span>
  <span class="s4">}</span>

  <span class="s3">var </span><span class="s2">b </span><span class="s4">= </span><span class="s2">record</span><span class="s4">.</span><span class="s2">fragment</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">msg </span><span class="s4">= {</span>
    <span class="s2">certificate_list</span><span class="s4">: </span><span class="s2">readVector</span><span class="s4">(</span><span class="s2">b</span><span class="s4">, </span><span class="s7">3</span><span class="s4">)</span>
  <span class="s4">};</span>

  <span class="s6">/* The sender's certificate will be first in the list (chain), each 
    subsequent one that follows will certify the previous one, but root 
    certificates (self-signed) that specify the certificate authority may 
    be omitted under the assumption that clients must already possess it. */</span>
  <span class="s3">var </span><span class="s2">cert</span><span class="s4">, </span><span class="s2">asn1</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">certs </span><span class="s4">= [];</span>
  <span class="s3">try </span><span class="s4">{</span>
    <span class="s3">while</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">.</span><span class="s2">certificate_list</span><span class="s4">.</span><span class="s2">length</span><span class="s4">() &gt; </span><span class="s7">0</span><span class="s4">) {</span>
      <span class="s6">// each entry in msg.certificate_list is a vector with 3 len bytes</span>
      <span class="s2">cert </span><span class="s4">= </span><span class="s2">readVector</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">.</span><span class="s2">certificate_list</span><span class="s4">, </span><span class="s7">3</span><span class="s4">);</span>
      <span class="s2">asn1 </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">fromDer</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">);</span>
      <span class="s2">cert </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateFromAsn1</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">, </span><span class="s3">true</span><span class="s4">);</span>
      <span class="s2">certs</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">);</span>
    <span class="s4">}</span>
  <span class="s4">} </span><span class="s3">catch</span><span class="s4">(</span><span class="s2">ex</span><span class="s4">) {</span>
    <span class="s3">return </span><span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
      <span class="s2">message</span><span class="s4">: </span><span class="s5">'Could not parse certificate list.'</span><span class="s4">,</span>
      <span class="s2">cause</span><span class="s4">: </span><span class="s2">ex</span><span class="s4">,</span>
      <span class="s2">send</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">alert</span><span class="s4">: {</span>
        <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
        <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">bad_certificate</span>
      <span class="s4">}</span>
    <span class="s4">});</span>
  <span class="s4">}</span>

  <span class="s6">// ensure at least 1 certificate was provided if in client-mode</span>
  <span class="s6">// or if verifyClient was set to true to require a certificate</span>
  <span class="s6">// (as opposed to 'optional')</span>
  <span class="s3">var </span><span class="s2">client </span><span class="s4">= (</span><span class="s2">c</span><span class="s4">.</span><span class="s2">entity </span><span class="s4">=== </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ConnectionEnd</span><span class="s4">.</span><span class="s2">client</span><span class="s4">);</span>
  <span class="s3">if</span><span class="s4">((</span><span class="s2">client </span><span class="s4">|| </span><span class="s2">c</span><span class="s4">.</span><span class="s2">verifyClient </span><span class="s4">=== </span><span class="s3">true</span><span class="s4">) &amp;&amp; </span><span class="s2">certs</span><span class="s4">.</span><span class="s2">length </span><span class="s4">=== </span><span class="s7">0</span><span class="s4">) {</span>
    <span class="s6">// error, no certificate</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
      <span class="s2">message</span><span class="s4">: </span><span class="s2">client </span><span class="s4">?</span>
        <span class="s5">'No server certificate provided.' </span><span class="s4">:</span>
        <span class="s5">'No client certificate provided.'</span><span class="s4">,</span>
      <span class="s2">send</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">alert</span><span class="s4">: {</span>
        <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
        <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">illegal_parameter</span>
      <span class="s4">}</span>
    <span class="s4">});</span>
  <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">certs</span><span class="s4">.</span><span class="s2">length </span><span class="s4">=== </span><span class="s7">0</span><span class="s4">) {</span>
    <span class="s6">// no certs to verify</span>
    <span class="s6">// expect a ServerKeyExchange or ClientKeyExchange message next</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">expect </span><span class="s4">= </span><span class="s2">client </span><span class="s4">? </span><span class="s2">SKE </span><span class="s4">: </span><span class="s2">CKE</span><span class="s4">;</span>
  <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
    <span class="s6">// save certificate in session</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">client</span><span class="s4">) {</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">serverCertificate </span><span class="s4">= </span><span class="s2">certs</span><span class="s4">[</span><span class="s7">0</span><span class="s4">];</span>
    <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">clientCertificate </span><span class="s4">= </span><span class="s2">certs</span><span class="s4">[</span><span class="s7">0</span><span class="s4">];</span>
    <span class="s4">}</span>

    <span class="s3">if</span><span class="s4">(</span><span class="s2">tls</span><span class="s4">.</span><span class="s2">verifyCertificateChain</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">certs</span><span class="s4">)) {</span>
      <span class="s6">// expect a ServerKeyExchange or ClientKeyExchange message next</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">expect </span><span class="s4">= </span><span class="s2">client </span><span class="s4">? </span><span class="s2">SKE </span><span class="s4">: </span><span class="s2">CKE</span><span class="s4">;</span>
    <span class="s4">}</span>
  <span class="s4">}</span>

  <span class="s6">// continue</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">process</span><span class="s4">();</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Called when a client receives a ServerKeyExchange record.</span>
 <span class="s0">*</span>
 <span class="s0">* When this message will be sent:</span>
 <span class="s0">*   This message will be sent immediately after the server certificate</span>
 <span class="s0">*   message (or the server hello message, if this is an anonymous</span>
 <span class="s0">*   negotiation).</span>
 <span class="s0">*</span>
 <span class="s0">*   The server key exchange message is sent by the server only when the</span>
 <span class="s0">*   server certificate message (if sent) does not contain enough data to</span>
 <span class="s0">*   allow the client to exchange a premaster secret.</span>
 <span class="s0">*</span>
 <span class="s0">* Meaning of this message:</span>
 <span class="s0">*   This message conveys cryptographic information to allow the client to</span>
 <span class="s0">*   communicate the premaster secret: either an RSA public key to encrypt</span>
 <span class="s0">*   the premaster secret with, or a Diffie-Hellman public key with which the</span>
 <span class="s0">*   client can complete a key exchange (with the result being the premaster</span>
 <span class="s0">*   secret.)</span>
 <span class="s0">*</span>
 <span class="s0">* enum {</span>
 <span class="s0">*   dhe_dss, dhe_rsa, dh_anon, rsa, dh_dss, dh_rsa</span>
 <span class="s0">* } KeyExchangeAlgorithm;</span>
 <span class="s0">*</span>
 <span class="s0">* struct {</span>
 <span class="s0">*   opaque dh_p&lt;1..2^16-1&gt;;</span>
 <span class="s0">*   opaque dh_g&lt;1..2^16-1&gt;;</span>
 <span class="s0">*   opaque dh_Ys&lt;1..2^16-1&gt;;</span>
 <span class="s0">* } ServerDHParams;</span>
 <span class="s0">*</span>
 <span class="s0">* struct {</span>
 <span class="s0">*   select(KeyExchangeAlgorithm) {</span>
 <span class="s0">*     case dh_anon:</span>
 <span class="s0">*       ServerDHParams params;</span>
 <span class="s0">*     case dhe_dss:</span>
 <span class="s0">*     case dhe_rsa:</span>
 <span class="s0">*       ServerDHParams params;</span>
 <span class="s0">*       digitally-signed struct {</span>
 <span class="s0">*         opaque client_random[32];</span>
 <span class="s0">*         opaque server_random[32];</span>
 <span class="s0">*         ServerDHParams params;</span>
 <span class="s0">*       } signed_params;</span>
 <span class="s0">*     case rsa:</span>
 <span class="s0">*     case dh_dss:</span>
 <span class="s0">*     case dh_rsa:</span>
 <span class="s0">*       struct {};</span>
 <span class="s0">*   };</span>
 <span class="s0">* } ServerKeyExchange;</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">record the record.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">length the length of the handshake message.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">handleServerKeyExchange </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">, </span><span class="s2">length</span><span class="s4">) {</span>
  <span class="s6">// this implementation only supports RSA, no Diffie-Hellman support</span>
  <span class="s6">// so any length &gt; 0 is invalid</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">length </span><span class="s4">&gt; </span><span class="s7">0</span><span class="s4">) {</span>
    <span class="s3">return </span><span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
      <span class="s2">message</span><span class="s4">: </span><span class="s5">'Invalid key parameters. Only RSA is supported.'</span><span class="s4">,</span>
      <span class="s2">send</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">alert</span><span class="s4">: {</span>
        <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
        <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">unsupported_certificate</span>
      <span class="s4">}</span>
    <span class="s4">});</span>
  <span class="s4">}</span>

  <span class="s6">// expect an optional CertificateRequest message next</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">expect </span><span class="s4">= </span><span class="s2">SCR</span><span class="s4">;</span>

  <span class="s6">// continue</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">process</span><span class="s4">();</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Called when a client receives a ClientKeyExchange record.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">record the record.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">length the length of the handshake message.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">handleClientKeyExchange </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">, </span><span class="s2">length</span><span class="s4">) {</span>
  <span class="s6">// this implementation only supports RSA, no Diffie-Hellman support</span>
  <span class="s6">// so any length &lt; 48 is invalid</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">length </span><span class="s4">&lt; </span><span class="s7">48</span><span class="s4">) {</span>
    <span class="s3">return </span><span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
      <span class="s2">message</span><span class="s4">: </span><span class="s5">'Invalid key parameters. Only RSA is supported.'</span><span class="s4">,</span>
      <span class="s2">send</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">alert</span><span class="s4">: {</span>
        <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
        <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">unsupported_certificate</span>
      <span class="s4">}</span>
    <span class="s4">});</span>
  <span class="s4">}</span>

  <span class="s3">var </span><span class="s2">b </span><span class="s4">= </span><span class="s2">record</span><span class="s4">.</span><span class="s2">fragment</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">msg </span><span class="s4">= {</span>
    <span class="s2">enc_pre_master_secret</span><span class="s4">: </span><span class="s2">readVector</span><span class="s4">(</span><span class="s2">b</span><span class="s4">, </span><span class="s7">2</span><span class="s4">).</span><span class="s2">getBytes</span><span class="s4">()</span>
  <span class="s4">};</span>

  <span class="s6">// do rsa decryption</span>
  <span class="s3">var </span><span class="s2">privateKey </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">getPrivateKey</span><span class="s4">) {</span>
    <span class="s3">try </span><span class="s4">{</span>
      <span class="s2">privateKey </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">getPrivateKey</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">serverCertificate</span><span class="s4">);</span>
      <span class="s2">privateKey </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">privateKeyFromPem</span><span class="s4">(</span><span class="s2">privateKey</span><span class="s4">);</span>
    <span class="s4">} </span><span class="s3">catch</span><span class="s4">(</span><span class="s2">ex</span><span class="s4">) {</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
        <span class="s2">message</span><span class="s4">: </span><span class="s5">'Could not get private key.'</span><span class="s4">,</span>
        <span class="s2">cause</span><span class="s4">: </span><span class="s2">ex</span><span class="s4">,</span>
        <span class="s2">send</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
        <span class="s2">alert</span><span class="s4">: {</span>
          <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
          <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">internal_error</span>
        <span class="s4">}</span>
      <span class="s4">});</span>
    <span class="s4">}</span>
  <span class="s4">}</span>

  <span class="s3">if</span><span class="s4">(</span><span class="s2">privateKey </span><span class="s4">=== </span><span class="s3">null</span><span class="s4">) {</span>
    <span class="s3">return </span><span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
      <span class="s2">message</span><span class="s4">: </span><span class="s5">'No private key set.'</span><span class="s4">,</span>
      <span class="s2">send</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">alert</span><span class="s4">: {</span>
        <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
        <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">internal_error</span>
      <span class="s4">}</span>
    <span class="s4">});</span>
  <span class="s4">}</span>

  <span class="s3">try </span><span class="s4">{</span>
    <span class="s6">// decrypt 48-byte pre-master secret</span>
    <span class="s3">var </span><span class="s2">sp </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">sp</span><span class="s4">;</span>
    <span class="s2">sp</span><span class="s4">.</span><span class="s2">pre_master_secret </span><span class="s4">= </span><span class="s2">privateKey</span><span class="s4">.</span><span class="s2">decrypt</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">.</span><span class="s2">enc_pre_master_secret</span><span class="s4">);</span>

    <span class="s6">// ensure client hello version matches first 2 bytes</span>
    <span class="s3">var </span><span class="s2">version </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">clientHelloVersion</span><span class="s4">;</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">version</span><span class="s4">.</span><span class="s2">major </span><span class="s4">!== </span><span class="s2">sp</span><span class="s4">.</span><span class="s2">pre_master_secret</span><span class="s4">.</span><span class="s2">charCodeAt</span><span class="s4">(</span><span class="s7">0</span><span class="s4">) ||</span>
      <span class="s2">version</span><span class="s4">.</span><span class="s2">minor </span><span class="s4">!== </span><span class="s2">sp</span><span class="s4">.</span><span class="s2">pre_master_secret</span><span class="s4">.</span><span class="s2">charCodeAt</span><span class="s4">(</span><span class="s7">1</span><span class="s4">)) {</span>
      <span class="s6">// error, do not send alert (see BLEI attack below)</span>
      <span class="s3">throw new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'TLS version rollback attack detected.'</span><span class="s4">);</span>
    <span class="s4">}</span>
  <span class="s4">} </span><span class="s3">catch</span><span class="s4">(</span><span class="s2">ex</span><span class="s4">) {</span>
    <span class="s6">/* Note: Daniel Bleichenbacher [BLEI] can be used to attack a 
      TLS server which is using PKCS#1 encoded RSA, so instead of 
      failing here, we generate 48 random bytes and use that as 
      the pre-master secret. */</span>
    <span class="s2">sp</span><span class="s4">.</span><span class="s2">pre_master_secret </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">random</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">(</span><span class="s7">48</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s6">// expect a CertificateVerify message if a Certificate was received that</span>
  <span class="s6">// does not have fixed Diffie-Hellman params, otherwise expect</span>
  <span class="s6">// ChangeCipherSpec</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">expect </span><span class="s4">= </span><span class="s2">CCC</span><span class="s4">;</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">clientCertificate </span><span class="s4">!== </span><span class="s3">null</span><span class="s4">) {</span>
    <span class="s6">// only RSA support, so expect CertificateVerify</span>
    <span class="s6">// TODO: support Diffie-Hellman</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">expect </span><span class="s4">= </span><span class="s2">CCV</span><span class="s4">;</span>
  <span class="s4">}</span>

  <span class="s6">// continue</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">process</span><span class="s4">();</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Called when a client receives a CertificateRequest record.</span>
 <span class="s0">*</span>
 <span class="s0">* When this message will be sent:</span>
 <span class="s0">*   A non-anonymous server can optionally request a certificate from the</span>
 <span class="s0">*   client, if appropriate for the selected cipher suite. This message, if</span>
 <span class="s0">*   sent, will immediately follow the Server Key Exchange message (if it is</span>
 <span class="s0">*   sent; otherwise, the Server Certificate message).</span>
 <span class="s0">*</span>
 <span class="s0">* enum {</span>
 <span class="s0">*   rsa_sign(1), dss_sign(2), rsa_fixed_dh(3), dss_fixed_dh(4),</span>
 <span class="s0">*   rsa_ephemeral_dh_RESERVED(5), dss_ephemeral_dh_RESERVED(6),</span>
 <span class="s0">*   fortezza_dms_RESERVED(20), (255)</span>
 <span class="s0">* } ClientCertificateType;</span>
 <span class="s0">*</span>
 <span class="s0">* opaque DistinguishedName&lt;1..2^16-1&gt;;</span>
 <span class="s0">*</span>
 <span class="s0">* struct {</span>
 <span class="s0">*   ClientCertificateType certificate_types&lt;1..2^8-1&gt;;</span>
 <span class="s0">*   SignatureAndHashAlgorithm supported_signature_algorithms&lt;2^16-1&gt;;</span>
 <span class="s0">*   DistinguishedName certificate_authorities&lt;0..2^16-1&gt;;</span>
 <span class="s0">* } CertificateRequest;</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">record the record.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">length the length of the handshake message.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">handleCertificateRequest </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">, </span><span class="s2">length</span><span class="s4">) {</span>
  <span class="s6">// minimum of 3 bytes in message</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">length </span><span class="s4">&lt; </span><span class="s7">3</span><span class="s4">) {</span>
    <span class="s3">return </span><span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
      <span class="s2">message</span><span class="s4">: </span><span class="s5">'Invalid CertificateRequest. Message too short.'</span><span class="s4">,</span>
      <span class="s2">send</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">alert</span><span class="s4">: {</span>
        <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
        <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">illegal_parameter</span>
      <span class="s4">}</span>
    <span class="s4">});</span>
  <span class="s4">}</span>

  <span class="s6">// TODO: TLS 1.2+ has different format including</span>
  <span class="s6">// SignatureAndHashAlgorithm after cert types</span>
  <span class="s3">var </span><span class="s2">b </span><span class="s4">= </span><span class="s2">record</span><span class="s4">.</span><span class="s2">fragment</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">msg </span><span class="s4">= {</span>
    <span class="s2">certificate_types</span><span class="s4">: </span><span class="s2">readVector</span><span class="s4">(</span><span class="s2">b</span><span class="s4">, </span><span class="s7">1</span><span class="s4">),</span>
    <span class="s2">certificate_authorities</span><span class="s4">: </span><span class="s2">readVector</span><span class="s4">(</span><span class="s2">b</span><span class="s4">, </span><span class="s7">2</span><span class="s4">)</span>
  <span class="s4">};</span>

  <span class="s6">// save certificate request in session</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">certificateRequest </span><span class="s4">= </span><span class="s2">msg</span><span class="s4">;</span>

  <span class="s6">// expect a ServerHelloDone message next</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">expect </span><span class="s4">= </span><span class="s2">SHD</span><span class="s4">;</span>

  <span class="s6">// continue</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">process</span><span class="s4">();</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Called when a server receives a CertificateVerify record.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">record the record.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">length the length of the handshake message.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">handleCertificateVerify </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">, </span><span class="s2">length</span><span class="s4">) {</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">length </span><span class="s4">&lt; </span><span class="s7">2</span><span class="s4">) {</span>
    <span class="s3">return </span><span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
      <span class="s2">message</span><span class="s4">: </span><span class="s5">'Invalid CertificateVerify. Message too short.'</span><span class="s4">,</span>
      <span class="s2">send</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">alert</span><span class="s4">: {</span>
        <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
        <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">illegal_parameter</span>
      <span class="s4">}</span>
    <span class="s4">});</span>
  <span class="s4">}</span>

  <span class="s6">// rewind to get full bytes for message so it can be manually</span>
  <span class="s6">// digested below (special case for CertificateVerify messages because</span>
  <span class="s6">// they must be digested *after* handling as opposed to all others)</span>
  <span class="s3">var </span><span class="s2">b </span><span class="s4">= </span><span class="s2">record</span><span class="s4">.</span><span class="s2">fragment</span><span class="s4">;</span>
  <span class="s2">b</span><span class="s4">.</span><span class="s2">read </span><span class="s4">-= </span><span class="s7">4</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">msgBytes </span><span class="s4">= </span><span class="s2">b</span><span class="s4">.</span><span class="s2">bytes</span><span class="s4">();</span>
  <span class="s2">b</span><span class="s4">.</span><span class="s2">read </span><span class="s4">+= </span><span class="s7">4</span><span class="s4">;</span>

  <span class="s3">var </span><span class="s2">msg </span><span class="s4">= {</span>
    <span class="s2">signature</span><span class="s4">: </span><span class="s2">readVector</span><span class="s4">(</span><span class="s2">b</span><span class="s4">, </span><span class="s7">2</span><span class="s4">).</span><span class="s2">getBytes</span><span class="s4">()</span>
  <span class="s4">};</span>

  <span class="s6">// TODO: add support for DSA</span>

  <span class="s6">// generate data to verify</span>
  <span class="s3">var </span><span class="s2">verify </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
  <span class="s2">verify</span><span class="s4">.</span><span class="s2">putBuffer</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">md5</span><span class="s4">.</span><span class="s2">digest</span><span class="s4">());</span>
  <span class="s2">verify</span><span class="s4">.</span><span class="s2">putBuffer</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">sha1</span><span class="s4">.</span><span class="s2">digest</span><span class="s4">());</span>
  <span class="s2">verify </span><span class="s4">= </span><span class="s2">verify</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">();</span>

  <span class="s3">try </span><span class="s4">{</span>
    <span class="s3">var </span><span class="s2">cert </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">clientCertificate</span><span class="s4">;</span>
    <span class="s6">/*b = forge.pki.rsa.decrypt( 
      msg.signature, cert.publicKey, true, verify.length); 
    if(b !== verify) {*/</span>
    <span class="s3">if</span><span class="s4">(!</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">publicKey</span><span class="s4">.</span><span class="s2">verify</span><span class="s4">(</span><span class="s2">verify</span><span class="s4">, </span><span class="s2">msg</span><span class="s4">.</span><span class="s2">signature</span><span class="s4">, </span><span class="s5">'NONE'</span><span class="s4">)) {</span>
      <span class="s3">throw new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'CertificateVerify signature does not match.'</span><span class="s4">);</span>
    <span class="s4">}</span>

    <span class="s6">// digest message now that it has been handled</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">md5</span><span class="s4">.</span><span class="s2">update</span><span class="s4">(</span><span class="s2">msgBytes</span><span class="s4">);</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">sha1</span><span class="s4">.</span><span class="s2">update</span><span class="s4">(</span><span class="s2">msgBytes</span><span class="s4">);</span>
  <span class="s4">} </span><span class="s3">catch</span><span class="s4">(</span><span class="s2">ex</span><span class="s4">) {</span>
    <span class="s3">return </span><span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
      <span class="s2">message</span><span class="s4">: </span><span class="s5">'Bad signature in CertificateVerify.'</span><span class="s4">,</span>
      <span class="s2">send</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">alert</span><span class="s4">: {</span>
        <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
        <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">handshake_failure</span>
      <span class="s4">}</span>
    <span class="s4">});</span>
  <span class="s4">}</span>

  <span class="s6">// expect ChangeCipherSpec</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">expect </span><span class="s4">= </span><span class="s2">CCC</span><span class="s4">;</span>

  <span class="s6">// continue</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">process</span><span class="s4">();</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Called when a client receives a ServerHelloDone record.</span>
 <span class="s0">*</span>
 <span class="s0">* When this message will be sent:</span>
 <span class="s0">*   The server hello done message is sent by the server to indicate the end</span>
 <span class="s0">*   of the server hello and associated messages. After sending this message</span>
 <span class="s0">*   the server will wait for a client response.</span>
 <span class="s0">*</span>
 <span class="s0">* Meaning of this message:</span>
 <span class="s0">*   This message means that the server is done sending messages to support</span>
 <span class="s0">*   the key exchange, and the client can proceed with its phase of the key</span>
 <span class="s0">*   exchange.</span>
 <span class="s0">*</span>
 <span class="s0">*   Upon receipt of the server hello done message the client should verify</span>
 <span class="s0">*   that the server provided a valid certificate if required and check that</span>
 <span class="s0">*   the server hello parameters are acceptable.</span>
 <span class="s0">*</span>
 <span class="s0">* struct {} ServerHelloDone;</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">record the record.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">length the length of the handshake message.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">handleServerHelloDone </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">, </span><span class="s2">length</span><span class="s4">) {</span>
  <span class="s6">// len must be 0 bytes</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">length </span><span class="s4">&gt; </span><span class="s7">0</span><span class="s4">) {</span>
    <span class="s3">return </span><span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
      <span class="s2">message</span><span class="s4">: </span><span class="s5">'Invalid ServerHelloDone message. Invalid length.'</span><span class="s4">,</span>
      <span class="s2">send</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">alert</span><span class="s4">: {</span>
        <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
        <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">record_overflow</span>
      <span class="s4">}</span>
    <span class="s4">});</span>
  <span class="s4">}</span>

  <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">serverCertificate </span><span class="s4">=== </span><span class="s3">null</span><span class="s4">) {</span>
    <span class="s6">// no server certificate was provided</span>
    <span class="s3">var </span><span class="s2">error </span><span class="s4">= {</span>
      <span class="s2">message</span><span class="s4">: </span><span class="s5">'No server certificate provided. Not enough security.'</span><span class="s4">,</span>
      <span class="s2">send</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">alert</span><span class="s4">: {</span>
        <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
        <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">insufficient_security</span>
      <span class="s4">}</span>
    <span class="s4">};</span>

    <span class="s6">// call application callback</span>
    <span class="s3">var </span><span class="s2">depth </span><span class="s4">= </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s3">var </span><span class="s2">ret </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">verify</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">error</span><span class="s4">.</span><span class="s2">alert</span><span class="s4">.</span><span class="s2">description</span><span class="s4">, </span><span class="s2">depth</span><span class="s4">, []);</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">ret </span><span class="s4">!== </span><span class="s3">true</span><span class="s4">) {</span>
      <span class="s6">// check for custom alert info</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">ret </span><span class="s4">|| </span><span class="s2">ret </span><span class="s4">=== </span><span class="s7">0</span><span class="s4">) {</span>
        <span class="s6">// set custom message and alert description</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s3">typeof </span><span class="s2">ret </span><span class="s4">=== </span><span class="s5">'object' </span><span class="s4">&amp;&amp; !</span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">isArray</span><span class="s4">(</span><span class="s2">ret</span><span class="s4">)) {</span>
          <span class="s3">if</span><span class="s4">(</span><span class="s2">ret</span><span class="s4">.</span><span class="s2">message</span><span class="s4">) {</span>
            <span class="s2">error</span><span class="s4">.</span><span class="s2">message </span><span class="s4">= </span><span class="s2">ret</span><span class="s4">.</span><span class="s2">message</span><span class="s4">;</span>
          <span class="s4">}</span>
          <span class="s3">if</span><span class="s4">(</span><span class="s2">ret</span><span class="s4">.</span><span class="s2">alert</span><span class="s4">) {</span>
            <span class="s2">error</span><span class="s4">.</span><span class="s2">alert</span><span class="s4">.</span><span class="s2">description </span><span class="s4">= </span><span class="s2">ret</span><span class="s4">.</span><span class="s2">alert</span><span class="s4">;</span>
          <span class="s4">}</span>
        <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s3">typeof </span><span class="s2">ret </span><span class="s4">=== </span><span class="s5">'number'</span><span class="s4">) {</span>
          <span class="s6">// set custom alert description</span>
          <span class="s2">error</span><span class="s4">.</span><span class="s2">alert</span><span class="s4">.</span><span class="s2">description </span><span class="s4">= </span><span class="s2">ret</span><span class="s4">;</span>
        <span class="s4">}</span>
      <span class="s4">}</span>

      <span class="s6">// send error</span>
      <span class="s3">return </span><span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">error</span><span class="s4">);</span>
    <span class="s4">}</span>
  <span class="s4">}</span>

  <span class="s6">// create client certificate message if requested</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">certificateRequest </span><span class="s4">!== </span><span class="s3">null</span><span class="s4">) {</span>
    <span class="s2">record </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createRecord</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ContentType</span><span class="s4">.</span><span class="s2">handshake</span><span class="s4">,</span>
      <span class="s2">data</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createCertificate</span><span class="s4">(</span><span class="s2">c</span><span class="s4">)</span>
    <span class="s4">});</span>
    <span class="s2">tls</span><span class="s4">.</span><span class="s2">queue</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s6">// create client key exchange message</span>
  <span class="s2">record </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createRecord</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
     <span class="s2">type</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ContentType</span><span class="s4">.</span><span class="s2">handshake</span><span class="s4">,</span>
     <span class="s2">data</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createClientKeyExchange</span><span class="s4">(</span><span class="s2">c</span><span class="s4">)</span>
  <span class="s4">});</span>
  <span class="s2">tls</span><span class="s4">.</span><span class="s2">queue</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">);</span>

  <span class="s6">// expect no messages until the following callback has been called</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">expect </span><span class="s4">= </span><span class="s2">SER</span><span class="s4">;</span>

  <span class="s6">// create callback to handle client signature (for client-certs)</span>
  <span class="s3">var </span><span class="s2">callback </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">signature</span><span class="s4">) {</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">certificateRequest </span><span class="s4">!== </span><span class="s3">null </span><span class="s4">&amp;&amp;</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">clientCertificate </span><span class="s4">!== </span><span class="s3">null</span><span class="s4">) {</span>
      <span class="s6">// create certificate verify message</span>
      <span class="s2">tls</span><span class="s4">.</span><span class="s2">queue</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createRecord</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
        <span class="s2">type</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ContentType</span><span class="s4">.</span><span class="s2">handshake</span><span class="s4">,</span>
        <span class="s2">data</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createCertificateVerify</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">signature</span><span class="s4">)</span>
      <span class="s4">}));</span>
    <span class="s4">}</span>

    <span class="s6">// create change cipher spec message</span>
    <span class="s2">tls</span><span class="s4">.</span><span class="s2">queue</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createRecord</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ContentType</span><span class="s4">.</span><span class="s2">change_cipher_spec</span><span class="s4">,</span>
      <span class="s2">data</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createChangeCipherSpec</span><span class="s4">()</span>
    <span class="s4">}));</span>

    <span class="s6">// create pending state</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">state</span><span class="s4">.</span><span class="s2">pending </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createConnectionState</span><span class="s4">(</span><span class="s2">c</span><span class="s4">);</span>

    <span class="s6">// change current write state to pending write state</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">state</span><span class="s4">.</span><span class="s2">current</span><span class="s4">.</span><span class="s2">write </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">state</span><span class="s4">.</span><span class="s2">pending</span><span class="s4">.</span><span class="s2">write</span><span class="s4">;</span>

    <span class="s6">// create finished message</span>
    <span class="s2">tls</span><span class="s4">.</span><span class="s2">queue</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createRecord</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ContentType</span><span class="s4">.</span><span class="s2">handshake</span><span class="s4">,</span>
      <span class="s2">data</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createFinished</span><span class="s4">(</span><span class="s2">c</span><span class="s4">)</span>
    <span class="s4">}));</span>

    <span class="s6">// expect a server ChangeCipherSpec message next</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">expect </span><span class="s4">= </span><span class="s2">SCC</span><span class="s4">;</span>

    <span class="s6">// send records</span>
    <span class="s2">tls</span><span class="s4">.</span><span class="s2">flush</span><span class="s4">(</span><span class="s2">c</span><span class="s4">);</span>

    <span class="s6">// continue</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">process</span><span class="s4">();</span>
  <span class="s4">};</span>

  <span class="s6">// if there is no certificate request or no client certificate, do</span>
  <span class="s6">// callback immediately</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">certificateRequest </span><span class="s4">=== </span><span class="s3">null </span><span class="s4">||</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">clientCertificate </span><span class="s4">=== </span><span class="s3">null</span><span class="s4">) {</span>
    <span class="s3">return </span><span class="s2">callback</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s3">null</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s6">// otherwise get the client signature</span>
  <span class="s2">tls</span><span class="s4">.</span><span class="s2">getClientSignature</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">callback</span><span class="s4">);</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Called when a ChangeCipherSpec record is received.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">record the record.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">handleChangeCipherSpec </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">) {</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">record</span><span class="s4">.</span><span class="s2">fragment</span><span class="s4">.</span><span class="s2">getByte</span><span class="s4">() !== </span><span class="s7">0x01</span><span class="s4">) {</span>
    <span class="s3">return </span><span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
      <span class="s2">message</span><span class="s4">: </span><span class="s5">'Invalid ChangeCipherSpec message received.'</span><span class="s4">,</span>
      <span class="s2">send</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">alert</span><span class="s4">: {</span>
        <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
        <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">illegal_parameter</span>
      <span class="s4">}</span>
    <span class="s4">});</span>
  <span class="s4">}</span>

  <span class="s6">// create pending state if:</span>
  <span class="s6">// 1. Resuming session in client mode OR</span>
  <span class="s6">// 2. NOT resuming session in server mode</span>
  <span class="s3">var </span><span class="s2">client </span><span class="s4">= (</span><span class="s2">c</span><span class="s4">.</span><span class="s2">entity </span><span class="s4">=== </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ConnectionEnd</span><span class="s4">.</span><span class="s2">client</span><span class="s4">);</span>
  <span class="s3">if</span><span class="s4">((</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">resuming </span><span class="s4">&amp;&amp; </span><span class="s2">client</span><span class="s4">) || (!</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">resuming </span><span class="s4">&amp;&amp; !</span><span class="s2">client</span><span class="s4">)) {</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">state</span><span class="s4">.</span><span class="s2">pending </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createConnectionState</span><span class="s4">(</span><span class="s2">c</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s6">// change current read state to pending read state</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">state</span><span class="s4">.</span><span class="s2">current</span><span class="s4">.</span><span class="s2">read </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">state</span><span class="s4">.</span><span class="s2">pending</span><span class="s4">.</span><span class="s2">read</span><span class="s4">;</span>

  <span class="s6">// clear pending state if:</span>
  <span class="s6">// 1. NOT resuming session in client mode OR</span>
  <span class="s6">// 2. resuming a session in server mode</span>
  <span class="s3">if</span><span class="s4">((!</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">resuming </span><span class="s4">&amp;&amp; </span><span class="s2">client</span><span class="s4">) || (</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">resuming </span><span class="s4">&amp;&amp; !</span><span class="s2">client</span><span class="s4">)) {</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">state</span><span class="s4">.</span><span class="s2">pending </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
  <span class="s4">}</span>

  <span class="s6">// expect a Finished record next</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">expect </span><span class="s4">= </span><span class="s2">client </span><span class="s4">? </span><span class="s2">SFI </span><span class="s4">: </span><span class="s2">CFI</span><span class="s4">;</span>

  <span class="s6">// continue</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">process</span><span class="s4">();</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Called when a Finished record is received.</span>
 <span class="s0">*</span>
 <span class="s0">* When this message will be sent:</span>
 <span class="s0">*   A finished message is always sent immediately after a change</span>
 <span class="s0">*   cipher spec message to verify that the key exchange and</span>
 <span class="s0">*   authentication processes were successful. It is essential that a</span>
 <span class="s0">*   change cipher spec message be received between the other</span>
 <span class="s0">*   handshake messages and the Finished message.</span>
 <span class="s0">*</span>
 <span class="s0">* Meaning of this message:</span>
 <span class="s0">*   The finished message is the first protected with the just-</span>
 <span class="s0">*   negotiated algorithms, keys, and secrets. Recipients of finished</span>
 <span class="s0">*   messages must verify that the contents are correct.  Once a side</span>
 <span class="s0">*   has sent its Finished message and received and validated the</span>
 <span class="s0">*   Finished message from its peer, it may begin to send and receive</span>
 <span class="s0">*   application data over the connection.</span>
 <span class="s0">*</span>
 <span class="s0">* struct {</span>
 <span class="s0">*   opaque verify_data[verify_data_length];</span>
 <span class="s0">* } Finished;</span>
 <span class="s0">*</span>
 <span class="s0">* verify_data</span>
 <span class="s0">*   PRF(master_secret, finished_label, Hash(handshake_messages))</span>
 <span class="s0">*     [0..verify_data_length-1];</span>
 <span class="s0">*</span>
 <span class="s0">* finished_label</span>
 <span class="s0">*   For Finished messages sent by the client, the string</span>
 <span class="s0">*   &quot;client finished&quot;. For Finished messages sent by the server, the</span>
 <span class="s0">*   string &quot;server finished&quot;.</span>
 <span class="s0">*</span>
 <span class="s0">* verify_data_length depends on the cipher suite. If it is not specified</span>
 <span class="s0">* by the cipher suite, then it is 12. Versions of TLS &lt; 1.2 always used</span>
 <span class="s0">* 12 bytes.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">record the record.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">length the length of the handshake message.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">handleFinished </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">, </span><span class="s2">length</span><span class="s4">) {</span>
  <span class="s6">// rewind to get full bytes for message so it can be manually</span>
  <span class="s6">// digested below (special case for Finished messages because they</span>
  <span class="s6">// must be digested *after* handling as opposed to all others)</span>
  <span class="s3">var </span><span class="s2">b </span><span class="s4">= </span><span class="s2">record</span><span class="s4">.</span><span class="s2">fragment</span><span class="s4">;</span>
  <span class="s2">b</span><span class="s4">.</span><span class="s2">read </span><span class="s4">-= </span><span class="s7">4</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">msgBytes </span><span class="s4">= </span><span class="s2">b</span><span class="s4">.</span><span class="s2">bytes</span><span class="s4">();</span>
  <span class="s2">b</span><span class="s4">.</span><span class="s2">read </span><span class="s4">+= </span><span class="s7">4</span><span class="s4">;</span>

  <span class="s6">// message contains only verify_data</span>
  <span class="s3">var </span><span class="s2">vd </span><span class="s4">= </span><span class="s2">record</span><span class="s4">.</span><span class="s2">fragment</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">();</span>

  <span class="s6">// ensure verify data is correct</span>
  <span class="s2">b </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
  <span class="s2">b</span><span class="s4">.</span><span class="s2">putBuffer</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">md5</span><span class="s4">.</span><span class="s2">digest</span><span class="s4">());</span>
  <span class="s2">b</span><span class="s4">.</span><span class="s2">putBuffer</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">sha1</span><span class="s4">.</span><span class="s2">digest</span><span class="s4">());</span>

  <span class="s6">// set label based on entity type</span>
  <span class="s3">var </span><span class="s2">client </span><span class="s4">= (</span><span class="s2">c</span><span class="s4">.</span><span class="s2">entity </span><span class="s4">=== </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ConnectionEnd</span><span class="s4">.</span><span class="s2">client</span><span class="s4">);</span>
  <span class="s3">var </span><span class="s2">label </span><span class="s4">= </span><span class="s2">client </span><span class="s4">? </span><span class="s5">'server finished' </span><span class="s4">: </span><span class="s5">'client finished'</span><span class="s4">;</span>

  <span class="s6">// TODO: determine prf function and verify length for TLS 1.2</span>
  <span class="s3">var </span><span class="s2">sp </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">sp</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">vdl </span><span class="s4">= </span><span class="s7">12</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">prf </span><span class="s4">= </span><span class="s2">prf_TLS1</span><span class="s4">;</span>
  <span class="s2">b </span><span class="s4">= </span><span class="s2">prf</span><span class="s4">(</span><span class="s2">sp</span><span class="s4">.</span><span class="s2">master_secret</span><span class="s4">, </span><span class="s2">label</span><span class="s4">, </span><span class="s2">b</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">(), </span><span class="s2">vdl</span><span class="s4">);</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">b</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">() !== </span><span class="s2">vd</span><span class="s4">) {</span>
    <span class="s3">return </span><span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
      <span class="s2">message</span><span class="s4">: </span><span class="s5">'Invalid verify_data in Finished message.'</span><span class="s4">,</span>
      <span class="s2">send</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
      <span class="s2">alert</span><span class="s4">: {</span>
        <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
        <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">decrypt_error</span>
      <span class="s4">}</span>
    <span class="s4">});</span>
  <span class="s4">}</span>

  <span class="s6">// digest finished message now that it has been handled</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">md5</span><span class="s4">.</span><span class="s2">update</span><span class="s4">(</span><span class="s2">msgBytes</span><span class="s4">);</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">sha1</span><span class="s4">.</span><span class="s2">update</span><span class="s4">(</span><span class="s2">msgBytes</span><span class="s4">);</span>

  <span class="s6">// resuming session as client or NOT resuming session as server</span>
  <span class="s3">if</span><span class="s4">((</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">resuming </span><span class="s4">&amp;&amp; </span><span class="s2">client</span><span class="s4">) || (!</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">resuming </span><span class="s4">&amp;&amp; !</span><span class="s2">client</span><span class="s4">)) {</span>
    <span class="s6">// create change cipher spec message</span>
    <span class="s2">tls</span><span class="s4">.</span><span class="s2">queue</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createRecord</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ContentType</span><span class="s4">.</span><span class="s2">change_cipher_spec</span><span class="s4">,</span>
      <span class="s2">data</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createChangeCipherSpec</span><span class="s4">()</span>
    <span class="s4">}));</span>

    <span class="s6">// change current write state to pending write state, clear pending</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">state</span><span class="s4">.</span><span class="s2">current</span><span class="s4">.</span><span class="s2">write </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">state</span><span class="s4">.</span><span class="s2">pending</span><span class="s4">.</span><span class="s2">write</span><span class="s4">;</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">state</span><span class="s4">.</span><span class="s2">pending </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>

    <span class="s6">// create finished message</span>
    <span class="s2">tls</span><span class="s4">.</span><span class="s2">queue</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createRecord</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ContentType</span><span class="s4">.</span><span class="s2">handshake</span><span class="s4">,</span>
      <span class="s2">data</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createFinished</span><span class="s4">(</span><span class="s2">c</span><span class="s4">)</span>
    <span class="s4">}));</span>
  <span class="s4">}</span>

  <span class="s6">// expect application data next</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">expect </span><span class="s4">= </span><span class="s2">client </span><span class="s4">? </span><span class="s2">SAD </span><span class="s4">: </span><span class="s2">CAD</span><span class="s4">;</span>

  <span class="s6">// handshake complete</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">handshaking </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>
  <span class="s4">++</span><span class="s2">c</span><span class="s4">.</span><span class="s2">handshakes</span><span class="s4">;</span>

  <span class="s6">// save access to peer certificate</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">peerCertificate </span><span class="s4">= </span><span class="s2">client </span><span class="s4">?</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">serverCertificate </span><span class="s4">: </span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">clientCertificate</span><span class="s4">;</span>

  <span class="s6">// send records</span>
  <span class="s2">tls</span><span class="s4">.</span><span class="s2">flush</span><span class="s4">(</span><span class="s2">c</span><span class="s4">);</span>

  <span class="s6">// now connected</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">isConnected </span><span class="s4">= </span><span class="s3">true</span><span class="s4">;</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">connected</span><span class="s4">(</span><span class="s2">c</span><span class="s4">);</span>

  <span class="s6">// continue</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">process</span><span class="s4">();</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Called when an Alert record is received.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">record the record.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">handleAlert </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">) {</span>
  <span class="s6">// read alert</span>
  <span class="s3">var </span><span class="s2">b </span><span class="s4">= </span><span class="s2">record</span><span class="s4">.</span><span class="s2">fragment</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">alert </span><span class="s4">= {</span>
    <span class="s2">level</span><span class="s4">: </span><span class="s2">b</span><span class="s4">.</span><span class="s2">getByte</span><span class="s4">(),</span>
    <span class="s2">description</span><span class="s4">: </span><span class="s2">b</span><span class="s4">.</span><span class="s2">getByte</span><span class="s4">()</span>
  <span class="s4">};</span>

  <span class="s6">// TODO: consider using a table?</span>
  <span class="s6">// get appropriate message</span>
  <span class="s3">var </span><span class="s2">msg</span><span class="s4">;</span>
  <span class="s3">switch</span><span class="s4">(</span><span class="s2">alert</span><span class="s4">.</span><span class="s2">description</span><span class="s4">) {</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">close_notify</span><span class="s4">:</span>
    <span class="s2">msg </span><span class="s4">= </span><span class="s5">'Connection closed.'</span><span class="s4">;</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">unexpected_message</span><span class="s4">:</span>
    <span class="s2">msg </span><span class="s4">= </span><span class="s5">'Unexpected message.'</span><span class="s4">;</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">bad_record_mac</span><span class="s4">:</span>
    <span class="s2">msg </span><span class="s4">= </span><span class="s5">'Bad record MAC.'</span><span class="s4">;</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">decryption_failed</span><span class="s4">:</span>
    <span class="s2">msg </span><span class="s4">= </span><span class="s5">'Decryption failed.'</span><span class="s4">;</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">record_overflow</span><span class="s4">:</span>
    <span class="s2">msg </span><span class="s4">= </span><span class="s5">'Record overflow.'</span><span class="s4">;</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">decompression_failure</span><span class="s4">:</span>
    <span class="s2">msg </span><span class="s4">= </span><span class="s5">'Decompression failed.'</span><span class="s4">;</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">handshake_failure</span><span class="s4">:</span>
    <span class="s2">msg </span><span class="s4">= </span><span class="s5">'Handshake failure.'</span><span class="s4">;</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">bad_certificate</span><span class="s4">:</span>
    <span class="s2">msg </span><span class="s4">= </span><span class="s5">'Bad certificate.'</span><span class="s4">;</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">unsupported_certificate</span><span class="s4">:</span>
    <span class="s2">msg </span><span class="s4">= </span><span class="s5">'Unsupported certificate.'</span><span class="s4">;</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">certificate_revoked</span><span class="s4">:</span>
    <span class="s2">msg </span><span class="s4">= </span><span class="s5">'Certificate revoked.'</span><span class="s4">;</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">certificate_expired</span><span class="s4">:</span>
    <span class="s2">msg </span><span class="s4">= </span><span class="s5">'Certificate expired.'</span><span class="s4">;</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">certificate_unknown</span><span class="s4">:</span>
    <span class="s2">msg </span><span class="s4">= </span><span class="s5">'Certificate unknown.'</span><span class="s4">;</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">illegal_parameter</span><span class="s4">:</span>
    <span class="s2">msg </span><span class="s4">= </span><span class="s5">'Illegal parameter.'</span><span class="s4">;</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">unknown_ca</span><span class="s4">:</span>
    <span class="s2">msg </span><span class="s4">= </span><span class="s5">'Unknown certificate authority.'</span><span class="s4">;</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">access_denied</span><span class="s4">:</span>
    <span class="s2">msg </span><span class="s4">= </span><span class="s5">'Access denied.'</span><span class="s4">;</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">decode_error</span><span class="s4">:</span>
    <span class="s2">msg </span><span class="s4">= </span><span class="s5">'Decode error.'</span><span class="s4">;</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">decrypt_error</span><span class="s4">:</span>
    <span class="s2">msg </span><span class="s4">= </span><span class="s5">'Decrypt error.'</span><span class="s4">;</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">export_restriction</span><span class="s4">:</span>
    <span class="s2">msg </span><span class="s4">= </span><span class="s5">'Export restriction.'</span><span class="s4">;</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">protocol_version</span><span class="s4">:</span>
    <span class="s2">msg </span><span class="s4">= </span><span class="s5">'Unsupported protocol version.'</span><span class="s4">;</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">insufficient_security</span><span class="s4">:</span>
    <span class="s2">msg </span><span class="s4">= </span><span class="s5">'Insufficient security.'</span><span class="s4">;</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">internal_error</span><span class="s4">:</span>
    <span class="s2">msg </span><span class="s4">= </span><span class="s5">'Internal error.'</span><span class="s4">;</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">user_canceled</span><span class="s4">:</span>
    <span class="s2">msg </span><span class="s4">= </span><span class="s5">'User canceled.'</span><span class="s4">;</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">no_renegotiation</span><span class="s4">:</span>
    <span class="s2">msg </span><span class="s4">= </span><span class="s5">'Renegotiation not supported.'</span><span class="s4">;</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s3">default</span><span class="s4">:</span>
    <span class="s2">msg </span><span class="s4">= </span><span class="s5">'Unknown error.'</span><span class="s4">;</span>
    <span class="s3">break</span><span class="s4">;</span>
  <span class="s4">}</span>

  <span class="s6">// close connection on close_notify, not an error</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">alert</span><span class="s4">.</span><span class="s2">description </span><span class="s4">=== </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">close_notify</span><span class="s4">) {</span>
    <span class="s3">return </span><span class="s2">c</span><span class="s4">.</span><span class="s2">close</span><span class="s4">();</span>
  <span class="s4">}</span>

  <span class="s6">// call error handler</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
    <span class="s2">message</span><span class="s4">: </span><span class="s2">msg</span><span class="s4">,</span>
    <span class="s2">send</span><span class="s4">: </span><span class="s3">false</span><span class="s4">,</span>
    <span class="s6">// origin is the opposite end</span>
    <span class="s2">origin</span><span class="s4">: (</span><span class="s2">c</span><span class="s4">.</span><span class="s2">entity </span><span class="s4">=== </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ConnectionEnd</span><span class="s4">.</span><span class="s2">client</span><span class="s4">) ? </span><span class="s5">'server' </span><span class="s4">: </span><span class="s5">'client'</span><span class="s4">,</span>
    <span class="s2">alert</span><span class="s4">: </span><span class="s2">alert</span>
  <span class="s4">});</span>

  <span class="s6">// continue</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">process</span><span class="s4">();</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Called when a Handshake record is received.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">record the record.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">handleHandshake </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">) {</span>
  <span class="s6">// get the handshake type and message length</span>
  <span class="s3">var </span><span class="s2">b </span><span class="s4">= </span><span class="s2">record</span><span class="s4">.</span><span class="s2">fragment</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">type </span><span class="s4">= </span><span class="s2">b</span><span class="s4">.</span><span class="s2">getByte</span><span class="s4">();</span>
  <span class="s3">var </span><span class="s2">length </span><span class="s4">= </span><span class="s2">b</span><span class="s4">.</span><span class="s2">getInt24</span><span class="s4">();</span>

  <span class="s6">// see if the record fragment doesn't yet contain the full message</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">length </span><span class="s4">&gt; </span><span class="s2">b</span><span class="s4">.</span><span class="s2">length</span><span class="s4">()) {</span>
    <span class="s6">// cache the record, clear its fragment, and reset the buffer read</span>
    <span class="s6">// pointer before the type and length were read</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">fragmented </span><span class="s4">= </span><span class="s2">record</span><span class="s4">;</span>
    <span class="s2">record</span><span class="s4">.</span><span class="s2">fragment </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
    <span class="s2">b</span><span class="s4">.</span><span class="s2">read </span><span class="s4">-= </span><span class="s7">4</span><span class="s4">;</span>

    <span class="s6">// continue</span>
    <span class="s3">return </span><span class="s2">c</span><span class="s4">.</span><span class="s2">process</span><span class="s4">();</span>
  <span class="s4">}</span>

  <span class="s6">// full message now available, clear cache, reset read pointer to</span>
  <span class="s6">// before type and length</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">fragmented </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
  <span class="s2">b</span><span class="s4">.</span><span class="s2">read </span><span class="s4">-= </span><span class="s7">4</span><span class="s4">;</span>

  <span class="s6">// save the handshake bytes for digestion after handler is found</span>
  <span class="s6">// (include type and length of handshake msg)</span>
  <span class="s3">var </span><span class="s2">bytes </span><span class="s4">= </span><span class="s2">b</span><span class="s4">.</span><span class="s2">bytes</span><span class="s4">(</span><span class="s2">length </span><span class="s4">+ </span><span class="s7">4</span><span class="s4">);</span>

  <span class="s6">// restore read pointer</span>
  <span class="s2">b</span><span class="s4">.</span><span class="s2">read </span><span class="s4">+= </span><span class="s7">4</span><span class="s4">;</span>

  <span class="s6">// handle expected message</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">type </span><span class="s3">in </span><span class="s2">hsTable</span><span class="s4">[</span><span class="s2">c</span><span class="s4">.</span><span class="s2">entity</span><span class="s4">][</span><span class="s2">c</span><span class="s4">.</span><span class="s2">expect</span><span class="s4">]) {</span>
    <span class="s6">// initialize server session</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">entity </span><span class="s4">=== </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ConnectionEnd</span><span class="s4">.</span><span class="s2">server </span><span class="s4">&amp;&amp; !</span><span class="s2">c</span><span class="s4">.</span><span class="s2">open </span><span class="s4">&amp;&amp; !</span><span class="s2">c</span><span class="s4">.</span><span class="s2">fail</span><span class="s4">) {</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">handshaking </span><span class="s4">= </span><span class="s3">true</span><span class="s4">;</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">session </span><span class="s4">= {</span>
        <span class="s2">version</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
        <span class="s2">extensions</span><span class="s4">: {</span>
          <span class="s2">server_name</span><span class="s4">: {</span>
            <span class="s2">serverNameList</span><span class="s4">: []</span>
          <span class="s4">}</span>
        <span class="s4">},</span>
        <span class="s2">cipherSuite</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
        <span class="s2">compressionMethod</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
        <span class="s2">serverCertificate</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
        <span class="s2">clientCertificate</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
        <span class="s2">md5</span><span class="s4">: </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">md5</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(),</span>
        <span class="s2">sha1</span><span class="s4">: </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">sha1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">()</span>
      <span class="s4">};</span>
    <span class="s4">}</span>

    <span class="s6">/* Update handshake messages digest. Finished and CertificateVerify 
      messages are not digested here. They can't be digested as part of 
      the verify_data that they contain. These messages are manually 
      digested in their handlers. HelloRequest messages are simply never 
      included in the handshake message digest according to spec. */</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">type </span><span class="s4">!== </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">HandshakeType</span><span class="s4">.</span><span class="s2">hello_request </span><span class="s4">&amp;&amp;</span>
      <span class="s2">type </span><span class="s4">!== </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">HandshakeType</span><span class="s4">.</span><span class="s2">certificate_verify </span><span class="s4">&amp;&amp;</span>
      <span class="s2">type </span><span class="s4">!== </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">HandshakeType</span><span class="s4">.</span><span class="s2">finished</span><span class="s4">) {</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">md5</span><span class="s4">.</span><span class="s2">update</span><span class="s4">(</span><span class="s2">bytes</span><span class="s4">);</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">sha1</span><span class="s4">.</span><span class="s2">update</span><span class="s4">(</span><span class="s2">bytes</span><span class="s4">);</span>
    <span class="s4">}</span>

    <span class="s6">// handle specific handshake type record</span>
    <span class="s2">hsTable</span><span class="s4">[</span><span class="s2">c</span><span class="s4">.</span><span class="s2">entity</span><span class="s4">][</span><span class="s2">c</span><span class="s4">.</span><span class="s2">expect</span><span class="s4">][</span><span class="s2">type</span><span class="s4">](</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">, </span><span class="s2">length</span><span class="s4">);</span>
  <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
    <span class="s6">// unexpected record</span>
    <span class="s2">tls</span><span class="s4">.</span><span class="s2">handleUnexpected</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">);</span>
  <span class="s4">}</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Called when an ApplicationData record is received.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">record the record.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">handleApplicationData </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">) {</span>
  <span class="s6">// buffer data, notify that its ready</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">data</span><span class="s4">.</span><span class="s2">putBuffer</span><span class="s4">(</span><span class="s2">record</span><span class="s4">.</span><span class="s2">fragment</span><span class="s4">);</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">dataReady</span><span class="s4">(</span><span class="s2">c</span><span class="s4">);</span>

  <span class="s6">// continue</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">process</span><span class="s4">();</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Called when a Heartbeat record is received.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">record the record.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">handleHeartbeat </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">) {</span>
  <span class="s6">// get the heartbeat type and payload</span>
  <span class="s3">var </span><span class="s2">b </span><span class="s4">= </span><span class="s2">record</span><span class="s4">.</span><span class="s2">fragment</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">type </span><span class="s4">= </span><span class="s2">b</span><span class="s4">.</span><span class="s2">getByte</span><span class="s4">();</span>
  <span class="s3">var </span><span class="s2">length </span><span class="s4">= </span><span class="s2">b</span><span class="s4">.</span><span class="s2">getInt16</span><span class="s4">();</span>
  <span class="s3">var </span><span class="s2">payload </span><span class="s4">= </span><span class="s2">b</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">(</span><span class="s2">length</span><span class="s4">);</span>

  <span class="s3">if</span><span class="s4">(</span><span class="s2">type </span><span class="s4">=== </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">HeartbeatMessageType</span><span class="s4">.</span><span class="s2">heartbeat_request</span><span class="s4">) {</span>
    <span class="s6">// discard request during handshake or if length is too large</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">handshaking </span><span class="s4">|| </span><span class="s2">length </span><span class="s4">&gt; </span><span class="s2">payload</span><span class="s4">.</span><span class="s2">length</span><span class="s4">) {</span>
      <span class="s6">// continue</span>
      <span class="s3">return </span><span class="s2">c</span><span class="s4">.</span><span class="s2">process</span><span class="s4">();</span>
    <span class="s4">}</span>
    <span class="s6">// retransmit payload</span>
    <span class="s2">tls</span><span class="s4">.</span><span class="s2">queue</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createRecord</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ContentType</span><span class="s4">.</span><span class="s2">heartbeat</span><span class="s4">,</span>
      <span class="s2">data</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createHeartbeat</span><span class="s4">(</span>
        <span class="s2">tls</span><span class="s4">.</span><span class="s2">HeartbeatMessageType</span><span class="s4">.</span><span class="s2">heartbeat_response</span><span class="s4">, </span><span class="s2">payload</span><span class="s4">)</span>
    <span class="s4">}));</span>
    <span class="s2">tls</span><span class="s4">.</span><span class="s2">flush</span><span class="s4">(</span><span class="s2">c</span><span class="s4">);</span>
  <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">type </span><span class="s4">=== </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">HeartbeatMessageType</span><span class="s4">.</span><span class="s2">heartbeat_response</span><span class="s4">) {</span>
    <span class="s6">// check payload against expected payload, discard heartbeat if no match</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">payload </span><span class="s4">!== </span><span class="s2">c</span><span class="s4">.</span><span class="s2">expectedHeartbeatPayload</span><span class="s4">) {</span>
      <span class="s6">// continue</span>
      <span class="s3">return </span><span class="s2">c</span><span class="s4">.</span><span class="s2">process</span><span class="s4">();</span>
    <span class="s4">}</span>

    <span class="s6">// notify that a valid heartbeat was received</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">heartbeatReceived</span><span class="s4">) {</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">heartbeatReceived</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">(</span><span class="s2">payload</span><span class="s4">));</span>
    <span class="s4">}</span>
  <span class="s4">}</span>

  <span class="s6">// continue</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">process</span><span class="s4">();</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* The transistional state tables for receiving TLS records. It maps the</span>
 <span class="s0">* current TLS engine state and a received record to a function to handle the</span>
 <span class="s0">* record and update the state.</span>
 <span class="s0">*</span>
 <span class="s0">* For instance, if the current state is SHE, then the TLS engine is expecting</span>
 <span class="s0">* a ServerHello record. Once a record is received, the handler function is</span>
 <span class="s0">* looked up using the state SHE and the record's content type.</span>
 <span class="s0">*</span>
 <span class="s0">* The resulting function will either be an error handler or a record handler.</span>
 <span class="s0">* The function will take whatever action is appropriate and update the state</span>
 <span class="s0">* for the next record.</span>
 <span class="s0">*</span>
 <span class="s0">* The states are all based on possible server record types. Note that the</span>
 <span class="s0">* client will never specifically expect to receive a HelloRequest or an alert</span>
 <span class="s0">* from the server so there is no state that reflects this. These messages may</span>
 <span class="s0">* occur at any time.</span>
 <span class="s0">*</span>
 <span class="s0">* There are two tables for mapping states because there is a second tier of</span>
 <span class="s0">* types for handshake messages. Once a record with a content type of handshake</span>
 <span class="s0">* is received, the handshake record handler will look up the handshake type in</span>
 <span class="s0">* the secondary map to get its appropriate handler.</span>
 <span class="s0">*</span>
 <span class="s0">* Valid message orders are as follows:</span>
 <span class="s0">*</span>
 <span class="s0">* =======================FULL HANDSHAKE======================</span>
 <span class="s0">* Client                                               Server</span>
 <span class="s0">*</span>
 <span class="s0">* ClientHello                  --------&gt;</span>
 <span class="s0">*                                                 ServerHello</span>
 <span class="s0">*                                                Certificate*</span>
 <span class="s0">*                                          ServerKeyExchange*</span>
 <span class="s0">*                                         CertificateRequest*</span>
 <span class="s0">*                              &lt;--------      ServerHelloDone</span>
 <span class="s0">* Certificate*</span>
 <span class="s0">* ClientKeyExchange</span>
 <span class="s0">* CertificateVerify*</span>
 <span class="s0">* [ChangeCipherSpec]</span>
 <span class="s0">* Finished                     --------&gt;</span>
 <span class="s0">*                                          [ChangeCipherSpec]</span>
 <span class="s0">*                              &lt;--------             Finished</span>
 <span class="s0">* Application Data             &lt;-------&gt;     Application Data</span>
 <span class="s0">*</span>
 <span class="s0">* =====================SESSION RESUMPTION=====================</span>
 <span class="s0">* Client                                                Server</span>
 <span class="s0">*</span>
 <span class="s0">* ClientHello                   --------&gt;</span>
 <span class="s0">*                                                  ServerHello</span>
 <span class="s0">*                                           [ChangeCipherSpec]</span>
 <span class="s0">*                               &lt;--------             Finished</span>
 <span class="s0">* [ChangeCipherSpec]</span>
 <span class="s0">* Finished                      --------&gt;</span>
 <span class="s0">* Application Data              &lt;-------&gt;     Application Data</span>
 <span class="s0">*/</span>
<span class="s6">// client expect states (indicate which records are expected to be received)</span>
<span class="s3">var </span><span class="s2">SHE </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s6">// rcv server hello</span>
<span class="s3">var </span><span class="s2">SCE </span><span class="s4">= </span><span class="s7">1</span><span class="s4">; </span><span class="s6">// rcv server certificate</span>
<span class="s3">var </span><span class="s2">SKE </span><span class="s4">= </span><span class="s7">2</span><span class="s4">; </span><span class="s6">// rcv server key exchange</span>
<span class="s3">var </span><span class="s2">SCR </span><span class="s4">= </span><span class="s7">3</span><span class="s4">; </span><span class="s6">// rcv certificate request</span>
<span class="s3">var </span><span class="s2">SHD </span><span class="s4">= </span><span class="s7">4</span><span class="s4">; </span><span class="s6">// rcv server hello done</span>
<span class="s3">var </span><span class="s2">SCC </span><span class="s4">= </span><span class="s7">5</span><span class="s4">; </span><span class="s6">// rcv change cipher spec</span>
<span class="s3">var </span><span class="s2">SFI </span><span class="s4">= </span><span class="s7">6</span><span class="s4">; </span><span class="s6">// rcv finished</span>
<span class="s3">var </span><span class="s2">SAD </span><span class="s4">= </span><span class="s7">7</span><span class="s4">; </span><span class="s6">// rcv application data</span>
<span class="s3">var </span><span class="s2">SER </span><span class="s4">= </span><span class="s7">8</span><span class="s4">; </span><span class="s6">// not expecting any messages at this point</span>

<span class="s6">// server expect states</span>
<span class="s3">var </span><span class="s2">CHE </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s6">// rcv client hello</span>
<span class="s3">var </span><span class="s2">CCE </span><span class="s4">= </span><span class="s7">1</span><span class="s4">; </span><span class="s6">// rcv client certificate</span>
<span class="s3">var </span><span class="s2">CKE </span><span class="s4">= </span><span class="s7">2</span><span class="s4">; </span><span class="s6">// rcv client key exchange</span>
<span class="s3">var </span><span class="s2">CCV </span><span class="s4">= </span><span class="s7">3</span><span class="s4">; </span><span class="s6">// rcv certificate verify</span>
<span class="s3">var </span><span class="s2">CCC </span><span class="s4">= </span><span class="s7">4</span><span class="s4">; </span><span class="s6">// rcv change cipher spec</span>
<span class="s3">var </span><span class="s2">CFI </span><span class="s4">= </span><span class="s7">5</span><span class="s4">; </span><span class="s6">// rcv finished</span>
<span class="s3">var </span><span class="s2">CAD </span><span class="s4">= </span><span class="s7">6</span><span class="s4">; </span><span class="s6">// rcv application data</span>
<span class="s3">var </span><span class="s2">CER </span><span class="s4">= </span><span class="s7">7</span><span class="s4">; </span><span class="s6">// not expecting any messages at this point</span>

<span class="s6">// map client current expect state and content type to function</span>
<span class="s3">var </span><span class="s2">__ </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">handleUnexpected</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">R0 </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">handleChangeCipherSpec</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">R1 </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">handleAlert</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">R2 </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">handleHandshake</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">R3 </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">handleApplicationData</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">R4 </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">handleHeartbeat</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">ctTable </span><span class="s4">= [];</span>
<span class="s2">ctTable</span><span class="s4">[</span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ConnectionEnd</span><span class="s4">.</span><span class="s2">client</span><span class="s4">] = [</span>
<span class="s6">//      CC,AL,HS,AD,HB</span>
<span class="s6">/*SHE*/</span><span class="s4">[</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R1</span><span class="s4">,</span><span class="s2">R2</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R4</span><span class="s4">],</span>
<span class="s6">/*SCE*/</span><span class="s4">[</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R1</span><span class="s4">,</span><span class="s2">R2</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R4</span><span class="s4">],</span>
<span class="s6">/*SKE*/</span><span class="s4">[</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R1</span><span class="s4">,</span><span class="s2">R2</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R4</span><span class="s4">],</span>
<span class="s6">/*SCR*/</span><span class="s4">[</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R1</span><span class="s4">,</span><span class="s2">R2</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R4</span><span class="s4">],</span>
<span class="s6">/*SHD*/</span><span class="s4">[</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R1</span><span class="s4">,</span><span class="s2">R2</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R4</span><span class="s4">],</span>
<span class="s6">/*SCC*/</span><span class="s4">[</span><span class="s2">R0</span><span class="s4">,</span><span class="s2">R1</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R4</span><span class="s4">],</span>
<span class="s6">/*SFI*/</span><span class="s4">[</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R1</span><span class="s4">,</span><span class="s2">R2</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R4</span><span class="s4">],</span>
<span class="s6">/*SAD*/</span><span class="s4">[</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R1</span><span class="s4">,</span><span class="s2">R2</span><span class="s4">,</span><span class="s2">R3</span><span class="s4">,</span><span class="s2">R4</span><span class="s4">],</span>
<span class="s6">/*SER*/</span><span class="s4">[</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R1</span><span class="s4">,</span><span class="s2">R2</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R4</span><span class="s4">]</span>
<span class="s4">];</span>

<span class="s6">// map server current expect state and content type to function</span>
<span class="s2">ctTable</span><span class="s4">[</span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ConnectionEnd</span><span class="s4">.</span><span class="s2">server</span><span class="s4">] = [</span>
<span class="s6">//      CC,AL,HS,AD</span>
<span class="s6">/*CHE*/</span><span class="s4">[</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R1</span><span class="s4">,</span><span class="s2">R2</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R4</span><span class="s4">],</span>
<span class="s6">/*CCE*/</span><span class="s4">[</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R1</span><span class="s4">,</span><span class="s2">R2</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R4</span><span class="s4">],</span>
<span class="s6">/*CKE*/</span><span class="s4">[</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R1</span><span class="s4">,</span><span class="s2">R2</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R4</span><span class="s4">],</span>
<span class="s6">/*CCV*/</span><span class="s4">[</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R1</span><span class="s4">,</span><span class="s2">R2</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R4</span><span class="s4">],</span>
<span class="s6">/*CCC*/</span><span class="s4">[</span><span class="s2">R0</span><span class="s4">,</span><span class="s2">R1</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R4</span><span class="s4">],</span>
<span class="s6">/*CFI*/</span><span class="s4">[</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R1</span><span class="s4">,</span><span class="s2">R2</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R4</span><span class="s4">],</span>
<span class="s6">/*CAD*/</span><span class="s4">[</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R1</span><span class="s4">,</span><span class="s2">R2</span><span class="s4">,</span><span class="s2">R3</span><span class="s4">,</span><span class="s2">R4</span><span class="s4">],</span>
<span class="s6">/*CER*/</span><span class="s4">[</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R1</span><span class="s4">,</span><span class="s2">R2</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">R4</span><span class="s4">]</span>
<span class="s4">];</span>

<span class="s6">// map client current expect state and handshake type to function</span>
<span class="s3">var </span><span class="s2">H0 </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">handleHelloRequest</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">H1 </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">handleServerHello</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">H2 </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">handleCertificate</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">H3 </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">handleServerKeyExchange</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">H4 </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">handleCertificateRequest</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">H5 </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">handleServerHelloDone</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">H6 </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">handleFinished</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">hsTable </span><span class="s4">= [];</span>
<span class="s2">hsTable</span><span class="s4">[</span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ConnectionEnd</span><span class="s4">.</span><span class="s2">client</span><span class="s4">] = [</span>
<span class="s6">//      HR,01,SH,03,04,05,06,07,08,09,10,SC,SK,CR,HD,15,CK,17,18,19,FI</span>
<span class="s6">/*SHE*/</span><span class="s4">[</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">H1</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">],</span>
<span class="s6">/*SCE*/</span><span class="s4">[</span><span class="s2">H0</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">H2</span><span class="s4">,</span><span class="s2">H3</span><span class="s4">,</span><span class="s2">H4</span><span class="s4">,</span><span class="s2">H5</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">],</span>
<span class="s6">/*SKE*/</span><span class="s4">[</span><span class="s2">H0</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">H3</span><span class="s4">,</span><span class="s2">H4</span><span class="s4">,</span><span class="s2">H5</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">],</span>
<span class="s6">/*SCR*/</span><span class="s4">[</span><span class="s2">H0</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">H4</span><span class="s4">,</span><span class="s2">H5</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">],</span>
<span class="s6">/*SHD*/</span><span class="s4">[</span><span class="s2">H0</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">H5</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">],</span>
<span class="s6">/*SCC*/</span><span class="s4">[</span><span class="s2">H0</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">],</span>
<span class="s6">/*SFI*/</span><span class="s4">[</span><span class="s2">H0</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">H6</span><span class="s4">],</span>
<span class="s6">/*SAD*/</span><span class="s4">[</span><span class="s2">H0</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">],</span>
<span class="s6">/*SER*/</span><span class="s4">[</span><span class="s2">H0</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">]</span>
<span class="s4">];</span>

<span class="s6">// map server current expect state and handshake type to function</span>
<span class="s6">// Note: CAD[CH] does not map to FB because renegotation is prohibited</span>
<span class="s3">var </span><span class="s2">H7 </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">handleClientHello</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">H8 </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">handleClientKeyExchange</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">H9 </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">handleCertificateVerify</span><span class="s4">;</span>
<span class="s2">hsTable</span><span class="s4">[</span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ConnectionEnd</span><span class="s4">.</span><span class="s2">server</span><span class="s4">] = [</span>
<span class="s6">//      01,CH,02,03,04,05,06,07,08,09,10,CC,12,13,14,CV,CK,17,18,19,FI</span>
<span class="s6">/*CHE*/</span><span class="s4">[</span><span class="s2">__</span><span class="s4">,</span><span class="s2">H7</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">],</span>
<span class="s6">/*CCE*/</span><span class="s4">[</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">H2</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">],</span>
<span class="s6">/*CKE*/</span><span class="s4">[</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">H8</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">],</span>
<span class="s6">/*CCV*/</span><span class="s4">[</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">H9</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">],</span>
<span class="s6">/*CCC*/</span><span class="s4">[</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">],</span>
<span class="s6">/*CFI*/</span><span class="s4">[</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">H6</span><span class="s4">],</span>
<span class="s6">/*CAD*/</span><span class="s4">[</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">],</span>
<span class="s6">/*CER*/</span><span class="s4">[</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">,</span><span class="s2">__</span><span class="s4">]</span>
<span class="s4">];</span>

<span class="s0">/**</span>
 <span class="s0">* Generates the master_secret and keys using the given security parameters.</span>
 <span class="s0">*</span>
 <span class="s0">* The security parameters for a TLS connection state are defined as such:</span>
 <span class="s0">*</span>
 <span class="s0">* struct {</span>
 <span class="s0">*   ConnectionEnd          entity;</span>
 <span class="s0">*   PRFAlgorithm           prf_algorithm;</span>
 <span class="s0">*   BulkCipherAlgorithm    bulk_cipher_algorithm;</span>
 <span class="s0">*   CipherType             cipher_type;</span>
 <span class="s0">*   uint8                  enc_key_length;</span>
 <span class="s0">*   uint8                  block_length;</span>
 <span class="s0">*   uint8                  fixed_iv_length;</span>
 <span class="s0">*   uint8                  record_iv_length;</span>
 <span class="s0">*   MACAlgorithm           mac_algorithm;</span>
 <span class="s0">*   uint8                  mac_length;</span>
 <span class="s0">*   uint8                  mac_key_length;</span>
 <span class="s0">*   CompressionMethod      compression_algorithm;</span>
 <span class="s0">*   opaque                 master_secret[48];</span>
 <span class="s0">*   opaque                 client_random[32];</span>
 <span class="s0">*   opaque                 server_random[32];</span>
 <span class="s0">* } SecurityParameters;</span>
 <span class="s0">*</span>
 <span class="s0">* Note that this definition is from TLS 1.2. In TLS 1.0 some of these</span>
 <span class="s0">* parameters are ignored because, for instance, the PRFAlgorithm is a</span>
 <span class="s0">* builtin-fixed algorithm combining iterations of MD5 and SHA-1 in TLS 1.0.</span>
 <span class="s0">*</span>
 <span class="s0">* The Record Protocol requires an algorithm to generate keys required by the</span>
 <span class="s0">* current connection state.</span>
 <span class="s0">*</span>
 <span class="s0">* The master secret is expanded into a sequence of secure bytes, which is then</span>
 <span class="s0">* split to a client write MAC key, a server write MAC key, a client write</span>
 <span class="s0">* encryption key, and a server write encryption key. In TLS 1.0 a client write</span>
 <span class="s0">* IV and server write IV are also generated. Each of these is generated from</span>
 <span class="s0">* the byte sequence in that order. Unused values are empty. In TLS 1.2, some</span>
 <span class="s0">* AEAD ciphers may additionally require a client write IV and a server write</span>
 <span class="s0">* IV (see Section 6.2.3.3).</span>
 <span class="s0">*</span>
 <span class="s0">* When keys, MAC keys, and IVs are generated, the master secret is used as an</span>
 <span class="s0">* entropy source.</span>
 <span class="s0">*</span>
 <span class="s0">* To generate the key material, compute:</span>
 <span class="s0">*</span>
 <span class="s0">* master_secret = PRF(pre_master_secret, &quot;master secret&quot;,</span>
 <span class="s0">*                     ClientHello.random + ServerHello.random)</span>
 <span class="s0">*</span>
 <span class="s0">* key_block = PRF(SecurityParameters.master_secret,</span>
 <span class="s0">*                 &quot;key expansion&quot;,</span>
 <span class="s0">*                 SecurityParameters.server_random +</span>
 <span class="s0">*                 SecurityParameters.client_random);</span>
 <span class="s0">*</span>
 <span class="s0">* until enough output has been generated. Then, the key_block is</span>
 <span class="s0">* partitioned as follows:</span>
 <span class="s0">*</span>
 <span class="s0">* client_write_MAC_key[SecurityParameters.mac_key_length]</span>
 <span class="s0">* server_write_MAC_key[SecurityParameters.mac_key_length]</span>
 <span class="s0">* client_write_key[SecurityParameters.enc_key_length]</span>
 <span class="s0">* server_write_key[SecurityParameters.enc_key_length]</span>
 <span class="s0">* client_write_IV[SecurityParameters.fixed_iv_length]</span>
 <span class="s0">* server_write_IV[SecurityParameters.fixed_iv_length]</span>
 <span class="s0">*</span>
 <span class="s0">* In TLS 1.2, the client_write_IV and server_write_IV are only generated for</span>
 <span class="s0">* implicit nonce techniques as described in Section 3.2.1 of [AEAD]. This</span>
 <span class="s0">* implementation uses TLS 1.0 so IVs are generated.</span>
 <span class="s0">*</span>
 <span class="s0">* Implementation note: The currently defined cipher suite which requires the</span>
 <span class="s0">* most material is AES_256_CBC_SHA256. It requires 2 x 32 byte keys and 2 x 32</span>
 <span class="s0">* byte MAC keys, for a total 128 bytes of key material. In TLS 1.0 it also</span>
 <span class="s0">* requires 2 x 16 byte IVs, so it actually takes 160 bytes of key material.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">sp the security parameters to use.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the security keys.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">generateKeys </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">sp</span><span class="s4">) {</span>
  <span class="s6">// TLS_RSA_WITH_AES_128_CBC_SHA (required to be compliant with TLS 1.2) &amp;</span>
  <span class="s6">// TLS_RSA_WITH_AES_256_CBC_SHA are the only cipher suites implemented</span>
  <span class="s6">// at present</span>

  <span class="s6">// TLS_DHE_DSS_WITH_3DES_EDE_CBC_SHA is required to be compliant with</span>
  <span class="s6">// TLS 1.0 but we don't care right now because AES is better and we have</span>
  <span class="s6">// an implementation for it</span>

  <span class="s6">// TODO: TLS 1.2 implementation</span>
  <span class="s6">/* 
  // determine the PRF 
  var prf; 
  switch(sp.prf_algorithm) { 
  case tls.PRFAlgorithm.tls_prf_sha256: 
    prf = prf_sha256; 
    break; 
  default: 
    // should never happen 
    throw new Error('Invalid PRF'); 
  } 
  */</span>

  <span class="s6">// TLS 1.0/1.1 implementation</span>
  <span class="s3">var </span><span class="s2">prf </span><span class="s4">= </span><span class="s2">prf_TLS1</span><span class="s4">;</span>

  <span class="s6">// concatenate server and client random</span>
  <span class="s3">var </span><span class="s2">random </span><span class="s4">= </span><span class="s2">sp</span><span class="s4">.</span><span class="s2">client_random </span><span class="s4">+ </span><span class="s2">sp</span><span class="s4">.</span><span class="s2">server_random</span><span class="s4">;</span>

  <span class="s6">// only create master secret if session is new</span>
  <span class="s3">if</span><span class="s4">(!</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">resuming</span><span class="s4">) {</span>
    <span class="s6">// create master secret, clean up pre-master secret</span>
    <span class="s2">sp</span><span class="s4">.</span><span class="s2">master_secret </span><span class="s4">= </span><span class="s2">prf</span><span class="s4">(</span>
      <span class="s2">sp</span><span class="s4">.</span><span class="s2">pre_master_secret</span><span class="s4">, </span><span class="s5">'master secret'</span><span class="s4">, </span><span class="s2">random</span><span class="s4">, </span><span class="s7">48</span><span class="s4">).</span><span class="s2">bytes</span><span class="s4">();</span>
    <span class="s2">sp</span><span class="s4">.</span><span class="s2">pre_master_secret </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
  <span class="s4">}</span>

  <span class="s6">// generate the amount of key material needed</span>
  <span class="s2">random </span><span class="s4">= </span><span class="s2">sp</span><span class="s4">.</span><span class="s2">server_random </span><span class="s4">+ </span><span class="s2">sp</span><span class="s4">.</span><span class="s2">client_random</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">length </span><span class="s4">= </span><span class="s7">2 </span><span class="s4">* </span><span class="s2">sp</span><span class="s4">.</span><span class="s2">mac_key_length </span><span class="s4">+ </span><span class="s7">2 </span><span class="s4">* </span><span class="s2">sp</span><span class="s4">.</span><span class="s2">enc_key_length</span><span class="s4">;</span>

  <span class="s6">// include IV for TLS/1.0</span>
  <span class="s3">var </span><span class="s2">tls10 </span><span class="s4">= (</span><span class="s2">c</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">major </span><span class="s4">=== </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Versions</span><span class="s4">.</span><span class="s2">TLS_1_0</span><span class="s4">.</span><span class="s2">major </span><span class="s4">&amp;&amp;</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">minor </span><span class="s4">=== </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Versions</span><span class="s4">.</span><span class="s2">TLS_1_0</span><span class="s4">.</span><span class="s2">minor</span><span class="s4">);</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">tls10</span><span class="s4">) {</span>
    <span class="s2">length </span><span class="s4">+= </span><span class="s7">2 </span><span class="s4">* </span><span class="s2">sp</span><span class="s4">.</span><span class="s2">fixed_iv_length</span><span class="s4">;</span>
  <span class="s4">}</span>
  <span class="s3">var </span><span class="s2">km </span><span class="s4">= </span><span class="s2">prf</span><span class="s4">(</span><span class="s2">sp</span><span class="s4">.</span><span class="s2">master_secret</span><span class="s4">, </span><span class="s5">'key expansion'</span><span class="s4">, </span><span class="s2">random</span><span class="s4">, </span><span class="s2">length</span><span class="s4">);</span>

  <span class="s6">// split the key material into the MAC and encryption keys</span>
  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= {</span>
    <span class="s2">client_write_MAC_key</span><span class="s4">: </span><span class="s2">km</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">(</span><span class="s2">sp</span><span class="s4">.</span><span class="s2">mac_key_length</span><span class="s4">),</span>
    <span class="s2">server_write_MAC_key</span><span class="s4">: </span><span class="s2">km</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">(</span><span class="s2">sp</span><span class="s4">.</span><span class="s2">mac_key_length</span><span class="s4">),</span>
    <span class="s2">client_write_key</span><span class="s4">: </span><span class="s2">km</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">(</span><span class="s2">sp</span><span class="s4">.</span><span class="s2">enc_key_length</span><span class="s4">),</span>
    <span class="s2">server_write_key</span><span class="s4">: </span><span class="s2">km</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">(</span><span class="s2">sp</span><span class="s4">.</span><span class="s2">enc_key_length</span><span class="s4">)</span>
  <span class="s4">};</span>

  <span class="s6">// include TLS 1.0 IVs</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">tls10</span><span class="s4">) {</span>
    <span class="s2">rval</span><span class="s4">.</span><span class="s2">client_write_IV </span><span class="s4">= </span><span class="s2">km</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">(</span><span class="s2">sp</span><span class="s4">.</span><span class="s2">fixed_iv_length</span><span class="s4">);</span>
    <span class="s2">rval</span><span class="s4">.</span><span class="s2">server_write_IV </span><span class="s4">= </span><span class="s2">km</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">(</span><span class="s2">sp</span><span class="s4">.</span><span class="s2">fixed_iv_length</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Creates a new initialized TLS connection state. A connection state has</span>
 <span class="s0">* a read mode and a write mode.</span>
 <span class="s0">*</span>
 <span class="s0">* compression state:</span>
 <span class="s0">*   The current state of the compression algorithm.</span>
 <span class="s0">*</span>
 <span class="s0">* cipher state:</span>
 <span class="s0">*   The current state of the encryption algorithm. This will consist of the</span>
 <span class="s0">*   scheduled key for that connection. For stream ciphers, this will also</span>
 <span class="s0">*   contain whatever state information is necessary to allow the stream to</span>
 <span class="s0">*   continue to encrypt or decrypt data.</span>
 <span class="s0">*</span>
 <span class="s0">* MAC key:</span>
 <span class="s0">*   The MAC key for the connection.</span>
 <span class="s0">*</span>
 <span class="s0">* sequence number:</span>
 <span class="s0">*   Each connection state contains a sequence number, which is maintained</span>
 <span class="s0">*   separately for read and write states. The sequence number MUST be set to</span>
 <span class="s0">*   zero whenever a connection state is made the active state. Sequence</span>
 <span class="s0">*   numbers are of type uint64 and may not exceed 2^64-1. Sequence numbers do</span>
 <span class="s0">*   not wrap. If a TLS implementation would need to wrap a sequence number,</span>
 <span class="s0">*   it must renegotiate instead. A sequence number is incremented after each</span>
 <span class="s0">*   record: specifically, the first record transmitted under a particular</span>
 <span class="s0">*   connection state MUST use sequence number 0.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the new initialized TLS connection state.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">createConnectionState </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">) {</span>
  <span class="s3">var </span><span class="s2">client </span><span class="s4">= (</span><span class="s2">c</span><span class="s4">.</span><span class="s2">entity </span><span class="s4">=== </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ConnectionEnd</span><span class="s4">.</span><span class="s2">client</span><span class="s4">);</span>

  <span class="s3">var </span><span class="s2">createMode </span><span class="s4">= </span><span class="s3">function</span><span class="s4">() {</span>
    <span class="s3">var </span><span class="s2">mode </span><span class="s4">= {</span>
      <span class="s6">// two 32-bit numbers, first is most significant</span>
      <span class="s2">sequenceNumber</span><span class="s4">: [</span><span class="s7">0</span><span class="s4">, </span><span class="s7">0</span><span class="s4">],</span>
      <span class="s2">macKey</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
      <span class="s2">macLength</span><span class="s4">: </span><span class="s7">0</span><span class="s4">,</span>
      <span class="s2">macFunction</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
      <span class="s2">cipherState</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
      <span class="s2">cipherFunction</span><span class="s4">: </span><span class="s3">function</span><span class="s4">(</span><span class="s2">record</span><span class="s4">) {</span><span class="s3">return true</span><span class="s4">;},</span>
      <span class="s2">compressionState</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
      <span class="s2">compressFunction</span><span class="s4">: </span><span class="s3">function</span><span class="s4">(</span><span class="s2">record</span><span class="s4">) {</span><span class="s3">return true</span><span class="s4">;},</span>
      <span class="s2">updateSequenceNumber</span><span class="s4">: </span><span class="s3">function</span><span class="s4">() {</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s2">mode</span><span class="s4">.</span><span class="s2">sequenceNumber</span><span class="s4">[</span><span class="s7">1</span><span class="s4">] === </span><span class="s7">0xFFFFFFFF</span><span class="s4">) {</span>
          <span class="s2">mode</span><span class="s4">.</span><span class="s2">sequenceNumber</span><span class="s4">[</span><span class="s7">1</span><span class="s4">] = </span><span class="s7">0</span><span class="s4">;</span>
          <span class="s4">++</span><span class="s2">mode</span><span class="s4">.</span><span class="s2">sequenceNumber</span><span class="s4">[</span><span class="s7">0</span><span class="s4">];</span>
        <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
          <span class="s4">++</span><span class="s2">mode</span><span class="s4">.</span><span class="s2">sequenceNumber</span><span class="s4">[</span><span class="s7">1</span><span class="s4">];</span>
        <span class="s4">}</span>
      <span class="s4">}</span>
    <span class="s4">};</span>
    <span class="s3">return </span><span class="s2">mode</span><span class="s4">;</span>
  <span class="s4">};</span>
  <span class="s3">var </span><span class="s2">state </span><span class="s4">= {</span>
    <span class="s2">read</span><span class="s4">: </span><span class="s2">createMode</span><span class="s4">(),</span>
    <span class="s2">write</span><span class="s4">: </span><span class="s2">createMode</span><span class="s4">()</span>
  <span class="s4">};</span>

  <span class="s6">// update function in read mode will decrypt then decompress a record</span>
  <span class="s2">state</span><span class="s4">.</span><span class="s2">read</span><span class="s4">.</span><span class="s2">update </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">) {</span>
    <span class="s3">if</span><span class="s4">(!</span><span class="s2">state</span><span class="s4">.</span><span class="s2">read</span><span class="s4">.</span><span class="s2">cipherFunction</span><span class="s4">(</span><span class="s2">record</span><span class="s4">, </span><span class="s2">state</span><span class="s4">.</span><span class="s2">read</span><span class="s4">)) {</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
        <span class="s2">message</span><span class="s4">: </span><span class="s5">'Could not decrypt record or bad MAC.'</span><span class="s4">,</span>
        <span class="s2">send</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
        <span class="s2">alert</span><span class="s4">: {</span>
          <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
          <span class="s6">// doesn't matter if decryption failed or MAC was</span>
          <span class="s6">// invalid, return the same error so as not to reveal</span>
          <span class="s6">// which one occurred</span>
          <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">bad_record_mac</span>
        <span class="s4">}</span>
      <span class="s4">});</span>
    <span class="s4">} </span><span class="s3">else if</span><span class="s4">(!</span><span class="s2">state</span><span class="s4">.</span><span class="s2">read</span><span class="s4">.</span><span class="s2">compressFunction</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">, </span><span class="s2">state</span><span class="s4">.</span><span class="s2">read</span><span class="s4">)) {</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
        <span class="s2">message</span><span class="s4">: </span><span class="s5">'Could not decompress record.'</span><span class="s4">,</span>
        <span class="s2">send</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
        <span class="s2">alert</span><span class="s4">: {</span>
          <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
          <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">decompression_failure</span>
        <span class="s4">}</span>
      <span class="s4">});</span>
    <span class="s4">}</span>
    <span class="s3">return </span><span class="s4">!</span><span class="s2">c</span><span class="s4">.</span><span class="s2">fail</span><span class="s4">;</span>
  <span class="s4">};</span>

  <span class="s6">// update function in write mode will compress then encrypt a record</span>
  <span class="s2">state</span><span class="s4">.</span><span class="s2">write</span><span class="s4">.</span><span class="s2">update </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">) {</span>
    <span class="s3">if</span><span class="s4">(!</span><span class="s2">state</span><span class="s4">.</span><span class="s2">write</span><span class="s4">.</span><span class="s2">compressFunction</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">, </span><span class="s2">state</span><span class="s4">.</span><span class="s2">write</span><span class="s4">)) {</span>
      <span class="s6">// error, but do not send alert since it would require</span>
      <span class="s6">// compression as well</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
        <span class="s2">message</span><span class="s4">: </span><span class="s5">'Could not compress record.'</span><span class="s4">,</span>
        <span class="s2">send</span><span class="s4">: </span><span class="s3">false</span><span class="s4">,</span>
        <span class="s2">alert</span><span class="s4">: {</span>
          <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
          <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">internal_error</span>
        <span class="s4">}</span>
      <span class="s4">});</span>
    <span class="s4">} </span><span class="s3">else if</span><span class="s4">(!</span><span class="s2">state</span><span class="s4">.</span><span class="s2">write</span><span class="s4">.</span><span class="s2">cipherFunction</span><span class="s4">(</span><span class="s2">record</span><span class="s4">, </span><span class="s2">state</span><span class="s4">.</span><span class="s2">write</span><span class="s4">)) {</span>
      <span class="s6">// error, but do not send alert since it would require</span>
      <span class="s6">// encryption as well</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
        <span class="s2">message</span><span class="s4">: </span><span class="s5">'Could not encrypt record.'</span><span class="s4">,</span>
        <span class="s2">send</span><span class="s4">: </span><span class="s3">false</span><span class="s4">,</span>
        <span class="s2">alert</span><span class="s4">: {</span>
          <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
          <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">internal_error</span>
        <span class="s4">}</span>
      <span class="s4">});</span>
    <span class="s4">}</span>
    <span class="s3">return </span><span class="s4">!</span><span class="s2">c</span><span class="s4">.</span><span class="s2">fail</span><span class="s4">;</span>
  <span class="s4">};</span>

  <span class="s6">// handle security parameters</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">) {</span>
    <span class="s3">var </span><span class="s2">sp </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">sp</span><span class="s4">;</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">cipherSuite</span><span class="s4">.</span><span class="s2">initSecurityParameters</span><span class="s4">(</span><span class="s2">sp</span><span class="s4">);</span>

    <span class="s6">// generate keys</span>
    <span class="s2">sp</span><span class="s4">.</span><span class="s2">keys </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">generateKeys</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">sp</span><span class="s4">);</span>
    <span class="s2">state</span><span class="s4">.</span><span class="s2">read</span><span class="s4">.</span><span class="s2">macKey </span><span class="s4">= </span><span class="s2">client </span><span class="s4">?</span>
      <span class="s2">sp</span><span class="s4">.</span><span class="s2">keys</span><span class="s4">.</span><span class="s2">server_write_MAC_key </span><span class="s4">: </span><span class="s2">sp</span><span class="s4">.</span><span class="s2">keys</span><span class="s4">.</span><span class="s2">client_write_MAC_key</span><span class="s4">;</span>
    <span class="s2">state</span><span class="s4">.</span><span class="s2">write</span><span class="s4">.</span><span class="s2">macKey </span><span class="s4">= </span><span class="s2">client </span><span class="s4">?</span>
      <span class="s2">sp</span><span class="s4">.</span><span class="s2">keys</span><span class="s4">.</span><span class="s2">client_write_MAC_key </span><span class="s4">: </span><span class="s2">sp</span><span class="s4">.</span><span class="s2">keys</span><span class="s4">.</span><span class="s2">server_write_MAC_key</span><span class="s4">;</span>

    <span class="s6">// cipher suite setup</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">cipherSuite</span><span class="s4">.</span><span class="s2">initConnectionState</span><span class="s4">(</span><span class="s2">state</span><span class="s4">, </span><span class="s2">c</span><span class="s4">, </span><span class="s2">sp</span><span class="s4">);</span>

    <span class="s6">// compression setup</span>
    <span class="s3">switch</span><span class="s4">(</span><span class="s2">sp</span><span class="s4">.</span><span class="s2">compression_algorithm</span><span class="s4">) {</span>
    <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">CompressionMethod</span><span class="s4">.</span><span class="s2">none</span><span class="s4">:</span>
      <span class="s3">break</span><span class="s4">;</span>
    <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">CompressionMethod</span><span class="s4">.</span><span class="s2">deflate</span><span class="s4">:</span>
      <span class="s2">state</span><span class="s4">.</span><span class="s2">read</span><span class="s4">.</span><span class="s2">compressFunction </span><span class="s4">= </span><span class="s2">inflate</span><span class="s4">;</span>
      <span class="s2">state</span><span class="s4">.</span><span class="s2">write</span><span class="s4">.</span><span class="s2">compressFunction </span><span class="s4">= </span><span class="s2">deflate</span><span class="s4">;</span>
      <span class="s3">break</span><span class="s4">;</span>
    <span class="s3">default</span><span class="s4">:</span>
      <span class="s3">throw new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Unsupported compression algorithm.'</span><span class="s4">);</span>
    <span class="s4">}</span>
  <span class="s4">}</span>

  <span class="s3">return </span><span class="s2">state</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Creates a Random structure.</span>
 <span class="s0">*</span>
 <span class="s0">* struct {</span>
 <span class="s0">*   uint32 gmt_unix_time;</span>
 <span class="s0">*   opaque random_bytes[28];</span>
 <span class="s0">* } Random;</span>
 <span class="s0">*</span>
 <span class="s0">* gmt_unix_time:</span>
 <span class="s0">*   The current time and date in standard UNIX 32-bit format (seconds since</span>
 <span class="s0">*   the midnight starting Jan 1, 1970, UTC, ignoring leap seconds) according</span>
 <span class="s0">*   to the sender's internal clock. Clocks are not required to be set</span>
 <span class="s0">*   correctly by the basic TLS protocol; higher-level or application</span>
 <span class="s0">*   protocols may define additional requirements. Note that, for historical</span>
 <span class="s0">*   reasons, the data element is named using GMT, the predecessor of the</span>
 <span class="s0">*   current worldwide time base, UTC.</span>
 <span class="s0">* random_bytes:</span>
 <span class="s0">*   28 bytes generated by a secure random number generator.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the Random structure as a byte array.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">createRandom </span><span class="s4">= </span><span class="s3">function</span><span class="s4">() {</span>
  <span class="s6">// get UTC milliseconds</span>
  <span class="s3">var </span><span class="s2">d </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Date</span><span class="s4">();</span>
  <span class="s3">var </span><span class="s2">utc </span><span class="s4">= +</span><span class="s2">d </span><span class="s4">+ </span><span class="s2">d</span><span class="s4">.</span><span class="s2">getTimezoneOffset</span><span class="s4">() * </span><span class="s7">60000</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt32</span><span class="s4">(</span><span class="s2">utc</span><span class="s4">);</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putBytes</span><span class="s4">(</span><span class="s2">forge</span><span class="s4">.</span><span class="s2">random</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">(</span><span class="s7">28</span><span class="s4">));</span>
  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Creates a TLS record with the given type and data.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">options:</span>
 <span class="s0">*   type: the record type.</span>
 <span class="s0">*   data: the plain text data in a byte buffer.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the created record.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">createRecord </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">options</span><span class="s4">) {</span>
  <span class="s3">if</span><span class="s4">(!</span><span class="s2">options</span><span class="s4">.</span><span class="s2">data</span><span class="s4">) {</span>
    <span class="s3">return null</span><span class="s4">;</span>
  <span class="s4">}</span>
  <span class="s3">var </span><span class="s2">record </span><span class="s4">= {</span>
    <span class="s2">type</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">type</span><span class="s4">,</span>
    <span class="s2">version</span><span class="s4">: {</span>
      <span class="s2">major</span><span class="s4">: </span><span class="s2">c</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">major</span><span class="s4">,</span>
      <span class="s2">minor</span><span class="s4">: </span><span class="s2">c</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">minor</span>
    <span class="s4">},</span>
    <span class="s2">length</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">data</span><span class="s4">.</span><span class="s2">length</span><span class="s4">(),</span>
    <span class="s2">fragment</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">data</span>
  <span class="s4">};</span>
  <span class="s3">return </span><span class="s2">record</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Creates a TLS alert record.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">alert:</span>
 <span class="s0">*   level: the TLS alert level.</span>
 <span class="s0">*   description: the TLS alert description.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the created alert record.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">createAlert </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">alert</span><span class="s4">) {</span>
  <span class="s3">var </span><span class="s2">b </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
  <span class="s2">b</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">alert</span><span class="s4">.</span><span class="s2">level</span><span class="s4">);</span>
  <span class="s2">b</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">alert</span><span class="s4">.</span><span class="s2">description</span><span class="s4">);</span>
  <span class="s3">return </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createRecord</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
    <span class="s2">type</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ContentType</span><span class="s4">.</span><span class="s2">alert</span><span class="s4">,</span>
    <span class="s2">data</span><span class="s4">: </span><span class="s2">b</span>
  <span class="s4">});</span>
<span class="s4">};</span>

<span class="s6">/* The structure of a TLS handshake message. 
 * 
 * struct { 
 *    HandshakeType msg_type;    // handshake type 
 *    uint24 length;             // bytes in message 
 *    select(HandshakeType) { 
 *       case hello_request:       HelloRequest; 
 *       case client_hello:        ClientHello; 
 *       case server_hello:        ServerHello; 
 *       case certificate:         Certificate; 
 *       case server_key_exchange: ServerKeyExchange; 
 *       case certificate_request: CertificateRequest; 
 *       case server_hello_done:   ServerHelloDone; 
 *       case certificate_verify:  CertificateVerify; 
 *       case client_key_exchange: ClientKeyExchange; 
 *       case finished:            Finished; 
 *    } body; 
 * } Handshake; 
 */</span>

<span class="s0">/**</span>
 <span class="s0">* Creates a ClientHello message.</span>
 <span class="s0">*</span>
 <span class="s0">* opaque SessionID&lt;0..32&gt;;</span>
 <span class="s0">* enum { null(0), deflate(1), (255) } CompressionMethod;</span>
 <span class="s0">* uint8 CipherSuite[2];</span>
 <span class="s0">*</span>
 <span class="s0">* struct {</span>
 <span class="s0">*   ProtocolVersion client_version;</span>
 <span class="s0">*   Random random;</span>
 <span class="s0">*   SessionID session_id;</span>
 <span class="s0">*   CipherSuite cipher_suites&lt;2..2^16-2&gt;;</span>
 <span class="s0">*   CompressionMethod compression_methods&lt;1..2^8-1&gt;;</span>
 <span class="s0">*   select(extensions_present) {</span>
 <span class="s0">*     case false:</span>
 <span class="s0">*       struct {};</span>
 <span class="s0">*     case true:</span>
 <span class="s0">*       Extension extensions&lt;0..2^16-1&gt;;</span>
 <span class="s0">*   };</span>
 <span class="s0">* } ClientHello;</span>
 <span class="s0">*</span>
 <span class="s0">* The extension format for extended client hellos and server hellos is:</span>
 <span class="s0">*</span>
 <span class="s0">* struct {</span>
 <span class="s0">*   ExtensionType extension_type;</span>
 <span class="s0">*   opaque extension_data&lt;0..2^16-1&gt;;</span>
 <span class="s0">* } Extension;</span>
 <span class="s0">*</span>
 <span class="s0">* Here:</span>
 <span class="s0">*</span>
 <span class="s0">* - &quot;extension_type&quot; identifies the particular extension type.</span>
 <span class="s0">* - &quot;extension_data&quot; contains information specific to the particular</span>
 <span class="s0">* extension type.</span>
 <span class="s0">*</span>
 <span class="s0">* The extension types defined in this document are:</span>
 <span class="s0">*</span>
 <span class="s0">* enum {</span>
 <span class="s0">*   server_name(0), max_fragment_length(1),</span>
 <span class="s0">*   client_certificate_url(2), trusted_ca_keys(3),</span>
 <span class="s0">*   truncated_hmac(4), status_request(5), (65535)</span>
 <span class="s0">* } ExtensionType;</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the ClientHello byte buffer.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">createClientHello </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">) {</span>
  <span class="s6">// save hello version</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">clientHelloVersion </span><span class="s4">= {</span>
    <span class="s2">major</span><span class="s4">: </span><span class="s2">c</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">major</span><span class="s4">,</span>
    <span class="s2">minor</span><span class="s4">: </span><span class="s2">c</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">minor</span>
  <span class="s4">};</span>

  <span class="s6">// create supported cipher suites</span>
  <span class="s3">var </span><span class="s2">cipherSuites </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
  <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">c</span><span class="s4">.</span><span class="s2">cipherSuites</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
    <span class="s3">var </span><span class="s2">cs </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">cipherSuites</span><span class="s4">[</span><span class="s2">i</span><span class="s4">];</span>
    <span class="s2">cipherSuites</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">cs</span><span class="s4">.</span><span class="s2">id</span><span class="s4">[</span><span class="s7">0</span><span class="s4">]);</span>
    <span class="s2">cipherSuites</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">cs</span><span class="s4">.</span><span class="s2">id</span><span class="s4">[</span><span class="s7">1</span><span class="s4">]);</span>
  <span class="s4">}</span>
  <span class="s3">var </span><span class="s2">cSuites </span><span class="s4">= </span><span class="s2">cipherSuites</span><span class="s4">.</span><span class="s2">length</span><span class="s4">();</span>

  <span class="s6">// create supported compression methods, null always supported, but</span>
  <span class="s6">// also support deflate if connection has inflate and deflate methods</span>
  <span class="s3">var </span><span class="s2">compressionMethods </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
  <span class="s2">compressionMethods</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">tls</span><span class="s4">.</span><span class="s2">CompressionMethod</span><span class="s4">.</span><span class="s2">none</span><span class="s4">);</span>
  <span class="s6">// FIXME: deflate support disabled until issues with raw deflate data</span>
  <span class="s6">// without zlib headers are resolved</span>
  <span class="s6">/* 
  if(c.inflate !== null &amp;&amp; c.deflate !== null) { 
    compressionMethods.putByte(tls.CompressionMethod.deflate); 
  } 
  */</span>
  <span class="s3">var </span><span class="s2">cMethods </span><span class="s4">= </span><span class="s2">compressionMethods</span><span class="s4">.</span><span class="s2">length</span><span class="s4">();</span>

  <span class="s6">// create TLS SNI (server name indication) extension if virtual host</span>
  <span class="s6">// has been specified, see RFC 3546</span>
  <span class="s3">var </span><span class="s2">extensions </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">virtualHost</span><span class="s4">) {</span>
    <span class="s6">// create extension struct</span>
    <span class="s3">var </span><span class="s2">ext </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
    <span class="s2">ext</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s7">0x00</span><span class="s4">); </span><span class="s6">// type server_name (ExtensionType is 2 bytes)</span>
    <span class="s2">ext</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s7">0x00</span><span class="s4">);</span>

    <span class="s6">/* In order to provide the server name, clients MAY include an 
     * extension of type &quot;server_name&quot; in the (extended) client hello. 
     * The &quot;extension_data&quot; field of this extension SHALL contain 
     * &quot;ServerNameList&quot; where: 
     * 
     * struct { 
     *   NameType name_type; 
     *   select(name_type) { 
     *     case host_name: HostName; 
     *   } name; 
     * } ServerName; 
     * 
     * enum { 
     *   host_name(0), (255) 
     * } NameType; 
     * 
     * opaque HostName&lt;1..2^16-1&gt;; 
     * 
     * struct { 
     *   ServerName server_name_list&lt;1..2^16-1&gt; 
     * } ServerNameList; 
     */</span>
    <span class="s3">var </span><span class="s2">serverName </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
    <span class="s2">serverName</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s7">0x00</span><span class="s4">); </span><span class="s6">// type host_name</span>
    <span class="s2">writeVector</span><span class="s4">(</span><span class="s2">serverName</span><span class="s4">, </span><span class="s7">2</span><span class="s4">, </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">virtualHost</span><span class="s4">));</span>

    <span class="s6">// ServerNameList is in extension_data</span>
    <span class="s3">var </span><span class="s2">snList </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
    <span class="s2">writeVector</span><span class="s4">(</span><span class="s2">snList</span><span class="s4">, </span><span class="s7">2</span><span class="s4">, </span><span class="s2">serverName</span><span class="s4">);</span>
    <span class="s2">writeVector</span><span class="s4">(</span><span class="s2">ext</span><span class="s4">, </span><span class="s7">2</span><span class="s4">, </span><span class="s2">snList</span><span class="s4">);</span>
    <span class="s2">extensions</span><span class="s4">.</span><span class="s2">putBuffer</span><span class="s4">(</span><span class="s2">ext</span><span class="s4">);</span>
  <span class="s4">}</span>
  <span class="s3">var </span><span class="s2">extLength </span><span class="s4">= </span><span class="s2">extensions</span><span class="s4">.</span><span class="s2">length</span><span class="s4">();</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">extLength </span><span class="s4">&gt; </span><span class="s7">0</span><span class="s4">) {</span>
    <span class="s6">// add extension vector length</span>
    <span class="s2">extLength </span><span class="s4">+= </span><span class="s7">2</span><span class="s4">;</span>
  <span class="s4">}</span>

  <span class="s6">// determine length of the handshake message</span>
  <span class="s6">// cipher suites and compression methods size will need to be</span>
  <span class="s6">// updated if more get added to the list</span>
  <span class="s3">var </span><span class="s2">sessionId </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">id</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">length </span><span class="s4">=</span>
    <span class="s2">sessionId</span><span class="s4">.</span><span class="s2">length </span><span class="s4">+ </span><span class="s7">1 </span><span class="s4">+ </span><span class="s6">// session ID vector</span>
    <span class="s7">2 </span><span class="s4">+                    </span><span class="s6">// version (major + minor)</span>
    <span class="s7">4 </span><span class="s4">+ </span><span class="s7">28 </span><span class="s4">+               </span><span class="s6">// random time and random bytes</span>
    <span class="s7">2 </span><span class="s4">+ </span><span class="s2">cSuites </span><span class="s4">+          </span><span class="s6">// cipher suites vector</span>
    <span class="s7">1 </span><span class="s4">+ </span><span class="s2">cMethods </span><span class="s4">+         </span><span class="s6">// compression methods vector</span>
    <span class="s2">extLength</span><span class="s4">;             </span><span class="s6">// extensions vector</span>

  <span class="s6">// build record fragment</span>
  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">tls</span><span class="s4">.</span><span class="s2">HandshakeType</span><span class="s4">.</span><span class="s2">client_hello</span><span class="s4">);</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt24</span><span class="s4">(</span><span class="s2">length</span><span class="s4">);                     </span><span class="s6">// handshake length</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">major</span><span class="s4">);             </span><span class="s6">// major version</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">minor</span><span class="s4">);             </span><span class="s6">// minor version</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putBytes</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">sp</span><span class="s4">.</span><span class="s2">client_random</span><span class="s4">); </span><span class="s6">// random time + bytes</span>
  <span class="s2">writeVector</span><span class="s4">(</span><span class="s2">rval</span><span class="s4">, </span><span class="s7">1</span><span class="s4">, </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">(</span><span class="s2">sessionId</span><span class="s4">));</span>
  <span class="s2">writeVector</span><span class="s4">(</span><span class="s2">rval</span><span class="s4">, </span><span class="s7">2</span><span class="s4">, </span><span class="s2">cipherSuites</span><span class="s4">);</span>
  <span class="s2">writeVector</span><span class="s4">(</span><span class="s2">rval</span><span class="s4">, </span><span class="s7">1</span><span class="s4">, </span><span class="s2">compressionMethods</span><span class="s4">);</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">extLength </span><span class="s4">&gt; </span><span class="s7">0</span><span class="s4">) {</span>
    <span class="s2">writeVector</span><span class="s4">(</span><span class="s2">rval</span><span class="s4">, </span><span class="s7">2</span><span class="s4">, </span><span class="s2">extensions</span><span class="s4">);</span>
  <span class="s4">}</span>
  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Creates a ServerHello message.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the ServerHello byte buffer.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">createServerHello </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">) {</span>
  <span class="s6">// determine length of the handshake message</span>
  <span class="s3">var </span><span class="s2">sessionId </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">id</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">length </span><span class="s4">=</span>
    <span class="s2">sessionId</span><span class="s4">.</span><span class="s2">length </span><span class="s4">+ </span><span class="s7">1 </span><span class="s4">+ </span><span class="s6">// session ID vector</span>
    <span class="s7">2 </span><span class="s4">+                    </span><span class="s6">// version (major + minor)</span>
    <span class="s7">4 </span><span class="s4">+ </span><span class="s7">28 </span><span class="s4">+               </span><span class="s6">// random time and random bytes</span>
    <span class="s7">2 </span><span class="s4">+                    </span><span class="s6">// chosen cipher suite</span>
    <span class="s7">1</span><span class="s4">;                     </span><span class="s6">// chosen compression method</span>

  <span class="s6">// build record fragment</span>
  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">tls</span><span class="s4">.</span><span class="s2">HandshakeType</span><span class="s4">.</span><span class="s2">server_hello</span><span class="s4">);</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt24</span><span class="s4">(</span><span class="s2">length</span><span class="s4">);                     </span><span class="s6">// handshake length</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">major</span><span class="s4">);             </span><span class="s6">// major version</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">minor</span><span class="s4">);             </span><span class="s6">// minor version</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putBytes</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">sp</span><span class="s4">.</span><span class="s2">server_random</span><span class="s4">); </span><span class="s6">// random time + bytes</span>
  <span class="s2">writeVector</span><span class="s4">(</span><span class="s2">rval</span><span class="s4">, </span><span class="s7">1</span><span class="s4">, </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">(</span><span class="s2">sessionId</span><span class="s4">));</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">cipherSuite</span><span class="s4">.</span><span class="s2">id</span><span class="s4">[</span><span class="s7">0</span><span class="s4">]);</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">cipherSuite</span><span class="s4">.</span><span class="s2">id</span><span class="s4">[</span><span class="s7">1</span><span class="s4">]);</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">compressionMethod</span><span class="s4">);</span>
  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Creates a Certificate message.</span>
 <span class="s0">*</span>
 <span class="s0">* When this message will be sent:</span>
 <span class="s0">*   This is the first message the client can send after receiving a server</span>
 <span class="s0">*   hello done message and the first message the server can send after</span>
 <span class="s0">*   sending a ServerHello. This client message is only sent if the server</span>
 <span class="s0">*   requests a certificate. If no suitable certificate is available, the</span>
 <span class="s0">*   client should send a certificate message containing no certificates. If</span>
 <span class="s0">*   client authentication is required by the server for the handshake to</span>
 <span class="s0">*   continue, it may respond with a fatal handshake failure alert.</span>
 <span class="s0">*</span>
 <span class="s0">* opaque ASN.1Cert&lt;1..2^24-1&gt;;</span>
 <span class="s0">*</span>
 <span class="s0">* struct {</span>
 <span class="s0">*   ASN.1Cert certificate_list&lt;0..2^24-1&gt;;</span>
 <span class="s0">* } Certificate;</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the Certificate byte buffer.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">createCertificate </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">) {</span>
  <span class="s6">// TODO: check certificate request to ensure types are supported</span>

  <span class="s6">// get a certificate (a certificate as a PEM string)</span>
  <span class="s3">var </span><span class="s2">client </span><span class="s4">= (</span><span class="s2">c</span><span class="s4">.</span><span class="s2">entity </span><span class="s4">=== </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ConnectionEnd</span><span class="s4">.</span><span class="s2">client</span><span class="s4">);</span>
  <span class="s3">var </span><span class="s2">cert </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">getCertificate</span><span class="s4">) {</span>
    <span class="s3">var </span><span class="s2">hint</span><span class="s4">;</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">client</span><span class="s4">) {</span>
      <span class="s2">hint </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">certificateRequest</span><span class="s4">;</span>
    <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
      <span class="s2">hint </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">extensions</span><span class="s4">.</span><span class="s2">server_name</span><span class="s4">.</span><span class="s2">serverNameList</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s2">cert </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">getCertificate</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">hint</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s6">// buffer to hold certificate list</span>
  <span class="s3">var </span><span class="s2">certList </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">cert </span><span class="s4">!== </span><span class="s3">null</span><span class="s4">) {</span>
    <span class="s3">try </span><span class="s4">{</span>
      <span class="s6">// normalize cert to a chain of certificates</span>
      <span class="s3">if</span><span class="s4">(!</span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">isArray</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">)) {</span>
        <span class="s2">cert </span><span class="s4">= [</span><span class="s2">cert</span><span class="s4">];</span>
      <span class="s4">}</span>
      <span class="s3">var </span><span class="s2">asn1 </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
      <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">cert</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
        <span class="s3">var </span><span class="s2">msg </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pem</span><span class="s4">.</span><span class="s2">decode</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">[</span><span class="s2">i</span><span class="s4">])[</span><span class="s7">0</span><span class="s4">];</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">.</span><span class="s2">type </span><span class="s4">!== </span><span class="s5">'CERTIFICATE' </span><span class="s4">&amp;&amp;</span>
          <span class="s2">msg</span><span class="s4">.</span><span class="s2">type </span><span class="s4">!== </span><span class="s5">'X509 CERTIFICATE' </span><span class="s4">&amp;&amp;</span>
          <span class="s2">msg</span><span class="s4">.</span><span class="s2">type </span><span class="s4">!== </span><span class="s5">'TRUSTED CERTIFICATE'</span><span class="s4">) {</span>
          <span class="s3">var </span><span class="s2">error </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Could not convert certificate from PEM; PEM ' </span><span class="s4">+</span>
            <span class="s5">'header type is not &quot;CERTIFICATE&quot;, &quot;X509 CERTIFICATE&quot;, or ' </span><span class="s4">+</span>
            <span class="s5">'&quot;TRUSTED CERTIFICATE&quot;.'</span><span class="s4">);</span>
          <span class="s2">error</span><span class="s4">.</span><span class="s2">headerType </span><span class="s4">= </span><span class="s2">msg</span><span class="s4">.</span><span class="s2">type</span><span class="s4">;</span>
          <span class="s3">throw </span><span class="s2">error</span><span class="s4">;</span>
        <span class="s4">}</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">.</span><span class="s2">procType </span><span class="s4">&amp;&amp; </span><span class="s2">msg</span><span class="s4">.</span><span class="s2">procType</span><span class="s4">.</span><span class="s2">type </span><span class="s4">=== </span><span class="s5">'ENCRYPTED'</span><span class="s4">) {</span>
          <span class="s3">throw new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Could not convert certificate from PEM; PEM is encrypted.'</span><span class="s4">);</span>
        <span class="s4">}</span>

        <span class="s3">var </span><span class="s2">der </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">.</span><span class="s2">body</span><span class="s4">);</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s2">asn1 </span><span class="s4">=== </span><span class="s3">null</span><span class="s4">) {</span>
          <span class="s2">asn1 </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">fromDer</span><span class="s4">(</span><span class="s2">der</span><span class="s4">.</span><span class="s2">bytes</span><span class="s4">(), </span><span class="s3">false</span><span class="s4">);</span>
        <span class="s4">}</span>

        <span class="s6">// certificate entry is itself a vector with 3 length bytes</span>
        <span class="s3">var </span><span class="s2">certBuffer </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
        <span class="s2">writeVector</span><span class="s4">(</span><span class="s2">certBuffer</span><span class="s4">, </span><span class="s7">3</span><span class="s4">, </span><span class="s2">der</span><span class="s4">);</span>

        <span class="s6">// add cert vector to cert list vector</span>
        <span class="s2">certList</span><span class="s4">.</span><span class="s2">putBuffer</span><span class="s4">(</span><span class="s2">certBuffer</span><span class="s4">);</span>
      <span class="s4">}</span>

      <span class="s6">// save certificate</span>
      <span class="s2">cert </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateFromAsn1</span><span class="s4">(</span><span class="s2">asn1</span><span class="s4">);</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">client</span><span class="s4">) {</span>
        <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">clientCertificate </span><span class="s4">= </span><span class="s2">cert</span><span class="s4">;</span>
      <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
        <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">serverCertificate </span><span class="s4">= </span><span class="s2">cert</span><span class="s4">;</span>
      <span class="s4">}</span>
    <span class="s4">} </span><span class="s3">catch</span><span class="s4">(</span><span class="s2">ex</span><span class="s4">) {</span>
      <span class="s3">return </span><span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
        <span class="s2">message</span><span class="s4">: </span><span class="s5">'Could not send certificate list.'</span><span class="s4">,</span>
        <span class="s2">cause</span><span class="s4">: </span><span class="s2">ex</span><span class="s4">,</span>
        <span class="s2">send</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
        <span class="s2">alert</span><span class="s4">: {</span>
          <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
          <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">bad_certificate</span>
        <span class="s4">}</span>
      <span class="s4">});</span>
    <span class="s4">}</span>
  <span class="s4">}</span>

  <span class="s6">// determine length of the handshake message</span>
  <span class="s3">var </span><span class="s2">length </span><span class="s4">= </span><span class="s7">3 </span><span class="s4">+ </span><span class="s2">certList</span><span class="s4">.</span><span class="s2">length</span><span class="s4">(); </span><span class="s6">// cert list vector</span>

  <span class="s6">// build record fragment</span>
  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">tls</span><span class="s4">.</span><span class="s2">HandshakeType</span><span class="s4">.</span><span class="s2">certificate</span><span class="s4">);</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt24</span><span class="s4">(</span><span class="s2">length</span><span class="s4">);</span>
  <span class="s2">writeVector</span><span class="s4">(</span><span class="s2">rval</span><span class="s4">, </span><span class="s7">3</span><span class="s4">, </span><span class="s2">certList</span><span class="s4">);</span>
  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Creates a ClientKeyExchange message.</span>
 <span class="s0">*</span>
 <span class="s0">* When this message will be sent:</span>
 <span class="s0">*   This message is always sent by the client. It will immediately follow the</span>
 <span class="s0">*   client certificate message, if it is sent. Otherwise it will be the first</span>
 <span class="s0">*   message sent by the client after it receives the server hello done</span>
 <span class="s0">*   message.</span>
 <span class="s0">*</span>
 <span class="s0">* Meaning of this message:</span>
 <span class="s0">*   With this message, the premaster secret is set, either though direct</span>
 <span class="s0">*   transmission of the RSA-encrypted secret, or by the transmission of</span>
 <span class="s0">*   Diffie-Hellman parameters which will allow each side to agree upon the</span>
 <span class="s0">*   same premaster secret. When the key exchange method is DH_RSA or DH_DSS,</span>
 <span class="s0">*   client certification has been requested, and the client was able to</span>
 <span class="s0">*   respond with a certificate which contained a Diffie-Hellman public key</span>
 <span class="s0">*   whose parameters (group and generator) matched those specified by the</span>
 <span class="s0">*   server in its certificate, this message will not contain any data.</span>
 <span class="s0">*</span>
 <span class="s0">* Meaning of this message:</span>
 <span class="s0">*   If RSA is being used for key agreement and authentication, the client</span>
 <span class="s0">*   generates a 48-byte premaster secret, encrypts it using the public key</span>
 <span class="s0">*   from the server's certificate or the temporary RSA key provided in a</span>
 <span class="s0">*   server key exchange message, and sends the result in an encrypted</span>
 <span class="s0">*   premaster secret message. This structure is a variant of the client</span>
 <span class="s0">*   key exchange message, not a message in itself.</span>
 <span class="s0">*</span>
 <span class="s0">* struct {</span>
 <span class="s0">*   select(KeyExchangeAlgorithm) {</span>
 <span class="s0">*     case rsa: EncryptedPreMasterSecret;</span>
 <span class="s0">*     case diffie_hellman: ClientDiffieHellmanPublic;</span>
 <span class="s0">*   } exchange_keys;</span>
 <span class="s0">* } ClientKeyExchange;</span>
 <span class="s0">*</span>
 <span class="s0">* struct {</span>
 <span class="s0">*   ProtocolVersion client_version;</span>
 <span class="s0">*   opaque random[46];</span>
 <span class="s0">* } PreMasterSecret;</span>
 <span class="s0">*</span>
 <span class="s0">* struct {</span>
 <span class="s0">*   public-key-encrypted PreMasterSecret pre_master_secret;</span>
 <span class="s0">* } EncryptedPreMasterSecret;</span>
 <span class="s0">*</span>
 <span class="s0">* A public-key-encrypted element is encoded as a vector &lt;0..2^16-1&gt;.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the ClientKeyExchange byte buffer.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">createClientKeyExchange </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">) {</span>
  <span class="s6">// create buffer to encrypt</span>
  <span class="s3">var </span><span class="s2">b </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>

  <span class="s6">// add highest client-supported protocol to help server avoid version</span>
  <span class="s6">// rollback attacks</span>
  <span class="s2">b</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">clientHelloVersion</span><span class="s4">.</span><span class="s2">major</span><span class="s4">);</span>
  <span class="s2">b</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">clientHelloVersion</span><span class="s4">.</span><span class="s2">minor</span><span class="s4">);</span>

  <span class="s6">// generate and add 46 random bytes</span>
  <span class="s2">b</span><span class="s4">.</span><span class="s2">putBytes</span><span class="s4">(</span><span class="s2">forge</span><span class="s4">.</span><span class="s2">random</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">(</span><span class="s7">46</span><span class="s4">));</span>

  <span class="s6">// save pre-master secret</span>
  <span class="s3">var </span><span class="s2">sp </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">sp</span><span class="s4">;</span>
  <span class="s2">sp</span><span class="s4">.</span><span class="s2">pre_master_secret </span><span class="s4">= </span><span class="s2">b</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">();</span>

  <span class="s6">// RSA-encrypt the pre-master secret</span>
  <span class="s3">var </span><span class="s2">key </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">serverCertificate</span><span class="s4">.</span><span class="s2">publicKey</span><span class="s4">;</span>
  <span class="s2">b </span><span class="s4">= </span><span class="s2">key</span><span class="s4">.</span><span class="s2">encrypt</span><span class="s4">(</span><span class="s2">sp</span><span class="s4">.</span><span class="s2">pre_master_secret</span><span class="s4">);</span>

  <span class="s6">/* Note: The encrypted pre-master secret will be stored in a 
    public-key-encrypted opaque vector that has the length prefixed using 
    2 bytes, so include those 2 bytes in the handshake message length. This 
    is done as a minor optimization instead of calling writeVector(). */</span>

  <span class="s6">// determine length of the handshake message</span>
  <span class="s3">var </span><span class="s2">length </span><span class="s4">= </span><span class="s2">b</span><span class="s4">.</span><span class="s2">length </span><span class="s4">+ </span><span class="s7">2</span><span class="s4">;</span>

  <span class="s6">// build record fragment</span>
  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">tls</span><span class="s4">.</span><span class="s2">HandshakeType</span><span class="s4">.</span><span class="s2">client_key_exchange</span><span class="s4">);</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt24</span><span class="s4">(</span><span class="s2">length</span><span class="s4">);</span>
  <span class="s6">// add vector length bytes</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt16</span><span class="s4">(</span><span class="s2">b</span><span class="s4">.</span><span class="s2">length</span><span class="s4">);</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putBytes</span><span class="s4">(</span><span class="s2">b</span><span class="s4">);</span>
  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Creates a ServerKeyExchange message.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the ServerKeyExchange byte buffer.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">createServerKeyExchange </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">) {</span>
  <span class="s6">// this implementation only supports RSA, no Diffie-Hellman support,</span>
  <span class="s6">// so this record is empty</span>

  <span class="s6">// determine length of the handshake message</span>
  <span class="s3">var </span><span class="s2">length </span><span class="s4">= </span><span class="s7">0</span><span class="s4">;</span>

  <span class="s6">// build record fragment</span>
  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">length </span><span class="s4">&gt; </span><span class="s7">0</span><span class="s4">) {</span>
    <span class="s2">rval</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">tls</span><span class="s4">.</span><span class="s2">HandshakeType</span><span class="s4">.</span><span class="s2">server_key_exchange</span><span class="s4">);</span>
    <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt24</span><span class="s4">(</span><span class="s2">length</span><span class="s4">);</span>
  <span class="s4">}</span>
  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Gets the signed data used to verify a client-side certificate. See</span>
 <span class="s0">* tls.createCertificateVerify() for details.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">callback the callback to call once the signed data is ready.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">getClientSignature </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">callback</span><span class="s4">) {</span>
  <span class="s6">// generate data to RSA encrypt</span>
  <span class="s3">var </span><span class="s2">b </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
  <span class="s2">b</span><span class="s4">.</span><span class="s2">putBuffer</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">md5</span><span class="s4">.</span><span class="s2">digest</span><span class="s4">());</span>
  <span class="s2">b</span><span class="s4">.</span><span class="s2">putBuffer</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">sha1</span><span class="s4">.</span><span class="s2">digest</span><span class="s4">());</span>
  <span class="s2">b </span><span class="s4">= </span><span class="s2">b</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">();</span>

  <span class="s6">// create default signing function as necessary</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">getSignature </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">getSignature </span><span class="s4">|| </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">b</span><span class="s4">, </span><span class="s2">callback</span><span class="s4">) {</span>
    <span class="s6">// do rsa encryption, call callback</span>
    <span class="s3">var </span><span class="s2">privateKey </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">getPrivateKey</span><span class="s4">) {</span>
      <span class="s3">try </span><span class="s4">{</span>
        <span class="s2">privateKey </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">getPrivateKey</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">clientCertificate</span><span class="s4">);</span>
        <span class="s2">privateKey </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">privateKeyFromPem</span><span class="s4">(</span><span class="s2">privateKey</span><span class="s4">);</span>
      <span class="s4">} </span><span class="s3">catch</span><span class="s4">(</span><span class="s2">ex</span><span class="s4">) {</span>
        <span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
          <span class="s2">message</span><span class="s4">: </span><span class="s5">'Could not get private key.'</span><span class="s4">,</span>
          <span class="s2">cause</span><span class="s4">: </span><span class="s2">ex</span><span class="s4">,</span>
          <span class="s2">send</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
          <span class="s2">alert</span><span class="s4">: {</span>
            <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
            <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">internal_error</span>
          <span class="s4">}</span>
        <span class="s4">});</span>
      <span class="s4">}</span>
    <span class="s4">}</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">privateKey </span><span class="s4">=== </span><span class="s3">null</span><span class="s4">) {</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
        <span class="s2">message</span><span class="s4">: </span><span class="s5">'No private key set.'</span><span class="s4">,</span>
        <span class="s2">send</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
        <span class="s2">alert</span><span class="s4">: {</span>
          <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
          <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">internal_error</span>
        <span class="s4">}</span>
      <span class="s4">});</span>
    <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
      <span class="s2">b </span><span class="s4">= </span><span class="s2">privateKey</span><span class="s4">.</span><span class="s2">sign</span><span class="s4">(</span><span class="s2">b</span><span class="s4">, </span><span class="s3">null</span><span class="s4">);</span>
    <span class="s4">}</span>
    <span class="s2">callback</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">b</span><span class="s4">);</span>
  <span class="s4">};</span>

  <span class="s6">// get client signature</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">getSignature</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">b</span><span class="s4">, </span><span class="s2">callback</span><span class="s4">);</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Creates a CertificateVerify message.</span>
 <span class="s0">*</span>
 <span class="s0">* Meaning of this message:</span>
 <span class="s0">*   This structure conveys the client's Diffie-Hellman public value</span>
 <span class="s0">*   (Yc) if it was not already included in the client's certificate.</span>
 <span class="s0">*   The encoding used for Yc is determined by the enumerated</span>
 <span class="s0">*   PublicValueEncoding. This structure is a variant of the client</span>
 <span class="s0">*   key exchange message, not a message in itself.</span>
 <span class="s0">*</span>
 <span class="s0">* When this message will be sent:</span>
 <span class="s0">*   This message is used to provide explicit verification of a client</span>
 <span class="s0">*   certificate. This message is only sent following a client</span>
 <span class="s0">*   certificate that has signing capability (i.e. all certificates</span>
 <span class="s0">*   except those containing fixed Diffie-Hellman parameters). When</span>
 <span class="s0">*   sent, it will immediately follow the client key exchange message.</span>
 <span class="s0">*</span>
 <span class="s0">* struct {</span>
 <span class="s0">*   Signature signature;</span>
 <span class="s0">* } CertificateVerify;</span>
 <span class="s0">*</span>
 <span class="s0">* CertificateVerify.signature.md5_hash</span>
 <span class="s0">*   MD5(handshake_messages);</span>
 <span class="s0">*</span>
 <span class="s0">* Certificate.signature.sha_hash</span>
 <span class="s0">*   SHA(handshake_messages);</span>
 <span class="s0">*</span>
 <span class="s0">* Here handshake_messages refers to all handshake messages sent or</span>
 <span class="s0">* received starting at client hello up to but not including this</span>
 <span class="s0">* message, including the type and length fields of the handshake</span>
 <span class="s0">* messages.</span>
 <span class="s0">*</span>
 <span class="s0">* select(SignatureAlgorithm) {</span>
 <span class="s0">*   case anonymous: struct { };</span>
 <span class="s0">*   case rsa:</span>
 <span class="s0">*     digitally-signed struct {</span>
 <span class="s0">*       opaque md5_hash[16];</span>
 <span class="s0">*       opaque sha_hash[20];</span>
 <span class="s0">*     };</span>
 <span class="s0">*   case dsa:</span>
 <span class="s0">*     digitally-signed struct {</span>
 <span class="s0">*       opaque sha_hash[20];</span>
 <span class="s0">*     };</span>
 <span class="s0">* } Signature;</span>
 <span class="s0">*</span>
 <span class="s0">* In digital signing, one-way hash functions are used as input for a</span>
 <span class="s0">* signing algorithm. A digitally-signed element is encoded as an opaque</span>
 <span class="s0">* vector &lt;0..2^16-1&gt;, where the length is specified by the signing</span>
 <span class="s0">* algorithm and key.</span>
 <span class="s0">*</span>
 <span class="s0">* In RSA signing, a 36-byte structure of two hashes (one SHA and one</span>
 <span class="s0">* MD5) is signed (encrypted with the private key). It is encoded with</span>
 <span class="s0">* PKCS #1 block type 0 or type 1 as described in [PKCS1].</span>
 <span class="s0">*</span>
 <span class="s0">* In DSS, the 20 bytes of the SHA hash are run directly through the</span>
 <span class="s0">* Digital Signing Algorithm with no additional hashing.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">signature the signature to include in the message.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the CertificateVerify byte buffer.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">createCertificateVerify </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">signature</span><span class="s4">) {</span>
  <span class="s6">/* Note: The signature will be stored in a &quot;digitally-signed&quot; opaque 
    vector that has the length prefixed using 2 bytes, so include those 
    2 bytes in the handshake message length. This is done as a minor 
    optimization instead of calling writeVector(). */</span>

  <span class="s6">// determine length of the handshake message</span>
  <span class="s3">var </span><span class="s2">length </span><span class="s4">= </span><span class="s2">signature</span><span class="s4">.</span><span class="s2">length </span><span class="s4">+ </span><span class="s7">2</span><span class="s4">;</span>

  <span class="s6">// build record fragment</span>
  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">tls</span><span class="s4">.</span><span class="s2">HandshakeType</span><span class="s4">.</span><span class="s2">certificate_verify</span><span class="s4">);</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt24</span><span class="s4">(</span><span class="s2">length</span><span class="s4">);</span>
  <span class="s6">// add vector length bytes</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt16</span><span class="s4">(</span><span class="s2">signature</span><span class="s4">.</span><span class="s2">length</span><span class="s4">);</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putBytes</span><span class="s4">(</span><span class="s2">signature</span><span class="s4">);</span>
  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Creates a CertificateRequest message.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the CertificateRequest byte buffer.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">createCertificateRequest </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">) {</span>
  <span class="s6">// TODO: support other certificate types</span>
  <span class="s3">var </span><span class="s2">certTypes </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>

  <span class="s6">// common RSA certificate type</span>
  <span class="s2">certTypes</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s7">0x01</span><span class="s4">);</span>

  <span class="s6">// add distinguished names from CA store</span>
  <span class="s3">var </span><span class="s2">cAs </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
  <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">key </span><span class="s3">in </span><span class="s2">c</span><span class="s4">.</span><span class="s2">caStore</span><span class="s4">.</span><span class="s2">certs</span><span class="s4">) {</span>
    <span class="s3">var </span><span class="s2">cert </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">caStore</span><span class="s4">.</span><span class="s2">certs</span><span class="s4">[</span><span class="s2">key</span><span class="s4">];</span>
    <span class="s3">var </span><span class="s2">dn </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">distinguishedNameToAsn1</span><span class="s4">(</span><span class="s2">cert</span><span class="s4">.</span><span class="s2">subject</span><span class="s4">);</span>
    <span class="s3">var </span><span class="s2">byteBuffer </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">asn1</span><span class="s4">.</span><span class="s2">toDer</span><span class="s4">(</span><span class="s2">dn</span><span class="s4">);</span>
    <span class="s2">cAs</span><span class="s4">.</span><span class="s2">putInt16</span><span class="s4">(</span><span class="s2">byteBuffer</span><span class="s4">.</span><span class="s2">length</span><span class="s4">());</span>
    <span class="s2">cAs</span><span class="s4">.</span><span class="s2">putBuffer</span><span class="s4">(</span><span class="s2">byteBuffer</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s6">// TODO: TLS 1.2+ has a different format</span>

  <span class="s6">// determine length of the handshake message</span>
  <span class="s3">var </span><span class="s2">length </span><span class="s4">=</span>
    <span class="s7">1 </span><span class="s4">+ </span><span class="s2">certTypes</span><span class="s4">.</span><span class="s2">length</span><span class="s4">() +</span>
    <span class="s7">2 </span><span class="s4">+ </span><span class="s2">cAs</span><span class="s4">.</span><span class="s2">length</span><span class="s4">();</span>

  <span class="s6">// build record fragment</span>
  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">tls</span><span class="s4">.</span><span class="s2">HandshakeType</span><span class="s4">.</span><span class="s2">certificate_request</span><span class="s4">);</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt24</span><span class="s4">(</span><span class="s2">length</span><span class="s4">);</span>
  <span class="s2">writeVector</span><span class="s4">(</span><span class="s2">rval</span><span class="s4">, </span><span class="s7">1</span><span class="s4">, </span><span class="s2">certTypes</span><span class="s4">);</span>
  <span class="s2">writeVector</span><span class="s4">(</span><span class="s2">rval</span><span class="s4">, </span><span class="s7">2</span><span class="s4">, </span><span class="s2">cAs</span><span class="s4">);</span>
  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Creates a ServerHelloDone message.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the ServerHelloDone byte buffer.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">createServerHelloDone </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">) {</span>
  <span class="s6">// build record fragment</span>
  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">tls</span><span class="s4">.</span><span class="s2">HandshakeType</span><span class="s4">.</span><span class="s2">server_hello_done</span><span class="s4">);</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt24</span><span class="s4">(</span><span class="s7">0</span><span class="s4">);</span>
  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Creates a ChangeCipherSpec message.</span>
 <span class="s0">*</span>
 <span class="s0">* The change cipher spec protocol exists to signal transitions in</span>
 <span class="s0">* ciphering strategies. The protocol consists of a single message,</span>
 <span class="s0">* which is encrypted and compressed under the current (not the pending)</span>
 <span class="s0">* connection state. The message consists of a single byte of value 1.</span>
 <span class="s0">*</span>
 <span class="s0">* struct {</span>
 <span class="s0">*   enum { change_cipher_spec(1), (255) } type;</span>
 <span class="s0">* } ChangeCipherSpec;</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the ChangeCipherSpec byte buffer.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">createChangeCipherSpec </span><span class="s4">= </span><span class="s3">function</span><span class="s4">() {</span>
  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s7">0x01</span><span class="s4">);</span>
  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Creates a Finished message.</span>
 <span class="s0">*</span>
 <span class="s0">* struct {</span>
 <span class="s0">*   opaque verify_data[12];</span>
 <span class="s0">* } Finished;</span>
 <span class="s0">*</span>
 <span class="s0">* verify_data</span>
 <span class="s0">*   PRF(master_secret, finished_label, MD5(handshake_messages) +</span>
 <span class="s0">*   SHA-1(handshake_messages)) [0..11];</span>
 <span class="s0">*</span>
 <span class="s0">* finished_label</span>
 <span class="s0">*   For Finished messages sent by the client, the string &quot;client</span>
 <span class="s0">*   finished&quot;. For Finished messages sent by the server, the</span>
 <span class="s0">*   string &quot;server finished&quot;.</span>
 <span class="s0">*</span>
 <span class="s0">* handshake_messages</span>
 <span class="s0">*   All of the data from all handshake messages up to but not</span>
 <span class="s0">*   including this message. This is only data visible at the</span>
 <span class="s0">*   handshake layer and does not include record layer headers.</span>
 <span class="s0">*   This is the concatenation of all the Handshake structures as</span>
 <span class="s0">*   defined in 7.4 exchanged thus far.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the Finished byte buffer.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">createFinished </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">) {</span>
  <span class="s6">// generate verify_data</span>
  <span class="s3">var </span><span class="s2">b </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
  <span class="s2">b</span><span class="s4">.</span><span class="s2">putBuffer</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">md5</span><span class="s4">.</span><span class="s2">digest</span><span class="s4">());</span>
  <span class="s2">b</span><span class="s4">.</span><span class="s2">putBuffer</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">sha1</span><span class="s4">.</span><span class="s2">digest</span><span class="s4">());</span>

  <span class="s6">// TODO: determine prf function and verify length for TLS 1.2</span>
  <span class="s3">var </span><span class="s2">client </span><span class="s4">= (</span><span class="s2">c</span><span class="s4">.</span><span class="s2">entity </span><span class="s4">=== </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ConnectionEnd</span><span class="s4">.</span><span class="s2">client</span><span class="s4">);</span>
  <span class="s3">var </span><span class="s2">sp </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">sp</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">vdl </span><span class="s4">= </span><span class="s7">12</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">prf </span><span class="s4">= </span><span class="s2">prf_TLS1</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">label </span><span class="s4">= </span><span class="s2">client </span><span class="s4">? </span><span class="s5">'client finished' </span><span class="s4">: </span><span class="s5">'server finished'</span><span class="s4">;</span>
  <span class="s2">b </span><span class="s4">= </span><span class="s2">prf</span><span class="s4">(</span><span class="s2">sp</span><span class="s4">.</span><span class="s2">master_secret</span><span class="s4">, </span><span class="s2">label</span><span class="s4">, </span><span class="s2">b</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">(), </span><span class="s2">vdl</span><span class="s4">);</span>

  <span class="s6">// build record fragment</span>
  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">tls</span><span class="s4">.</span><span class="s2">HandshakeType</span><span class="s4">.</span><span class="s2">finished</span><span class="s4">);</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt24</span><span class="s4">(</span><span class="s2">b</span><span class="s4">.</span><span class="s2">length</span><span class="s4">());</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putBuffer</span><span class="s4">(</span><span class="s2">b</span><span class="s4">);</span>
  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Creates a HeartbeatMessage (See RFC 6520).</span>
 <span class="s0">*</span>
 <span class="s0">* struct {</span>
 <span class="s0">*   HeartbeatMessageType type;</span>
 <span class="s0">*   uint16 payload_length;</span>
 <span class="s0">*   opaque payload[HeartbeatMessage.payload_length];</span>
 <span class="s0">*   opaque padding[padding_length];</span>
 <span class="s0">* } HeartbeatMessage;</span>
 <span class="s0">*</span>
 <span class="s0">* The total length of a HeartbeatMessage MUST NOT exceed 2^14 or</span>
 <span class="s0">* max_fragment_length when negotiated as defined in [RFC6066].</span>
 <span class="s0">*</span>
 <span class="s0">* type: The message type, either heartbeat_request or heartbeat_response.</span>
 <span class="s0">*</span>
 <span class="s0">* payload_length: The length of the payload.</span>
 <span class="s0">*</span>
 <span class="s0">* payload: The payload consists of arbitrary content.</span>
 <span class="s0">*</span>
 <span class="s0">* padding: The padding is random content that MUST be ignored by the</span>
 <span class="s0">*   receiver. The length of a HeartbeatMessage is TLSPlaintext.length</span>
 <span class="s0">*   for TLS and DTLSPlaintext.length for DTLS. Furthermore, the</span>
 <span class="s0">*   length of the type field is 1 byte, and the length of the</span>
 <span class="s0">*   payload_length is 2. Therefore, the padding_length is</span>
 <span class="s0">*   TLSPlaintext.length - payload_length - 3 for TLS and</span>
 <span class="s0">*   DTLSPlaintext.length - payload_length - 3 for DTLS. The</span>
 <span class="s0">*   padding_length MUST be at least 16.</span>
 <span class="s0">*</span>
 <span class="s0">* The sender of a HeartbeatMessage MUST use a random padding of at</span>
 <span class="s0">* least 16 bytes. The padding of a received HeartbeatMessage message</span>
 <span class="s0">* MUST be ignored.</span>
 <span class="s0">*</span>
 <span class="s0">* If the payload_length of a received HeartbeatMessage is too large,</span>
 <span class="s0">* the received HeartbeatMessage MUST be discarded silently.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">type the tls.HeartbeatMessageType.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">payload the heartbeat data to send as the payload.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">[payloadLength] the payload length to use, defaults to the</span>
 <span class="s0">*          actual payload length.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the HeartbeatRequest byte buffer.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">createHeartbeat </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">type</span><span class="s4">, </span><span class="s2">payload</span><span class="s4">, </span><span class="s2">payloadLength</span><span class="s4">) {</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s3">typeof </span><span class="s2">payloadLength </span><span class="s4">=== </span><span class="s5">'undefined'</span><span class="s4">) {</span>
    <span class="s2">payloadLength </span><span class="s4">= </span><span class="s2">payload</span><span class="s4">.</span><span class="s2">length</span><span class="s4">;</span>
  <span class="s4">}</span>
  <span class="s6">// build record fragment</span>
  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">type</span><span class="s4">);               </span><span class="s6">// heartbeat message type</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt16</span><span class="s4">(</span><span class="s2">payloadLength</span><span class="s4">);     </span><span class="s6">// payload length</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putBytes</span><span class="s4">(</span><span class="s2">payload</span><span class="s4">);           </span><span class="s6">// payload</span>
  <span class="s6">// padding</span>
  <span class="s3">var </span><span class="s2">plaintextLength </span><span class="s4">= </span><span class="s2">rval</span><span class="s4">.</span><span class="s2">length</span><span class="s4">();</span>
  <span class="s3">var </span><span class="s2">paddingLength </span><span class="s4">= </span><span class="s2">Math</span><span class="s4">.</span><span class="s2">max</span><span class="s4">(</span><span class="s7">16</span><span class="s4">, </span><span class="s2">plaintextLength </span><span class="s4">- </span><span class="s2">payloadLength </span><span class="s4">- </span><span class="s7">3</span><span class="s4">);</span>
  <span class="s2">rval</span><span class="s4">.</span><span class="s2">putBytes</span><span class="s4">(</span><span class="s2">forge</span><span class="s4">.</span><span class="s2">random</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">(</span><span class="s2">paddingLength</span><span class="s4">));</span>
  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Fragments, compresses, encrypts, and queues a record for delivery.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">record the record to queue.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">queue </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">) {</span>
  <span class="s6">// error during record creation</span>
  <span class="s3">if</span><span class="s4">(!</span><span class="s2">record</span><span class="s4">) {</span>
    <span class="s3">return</span><span class="s4">;</span>
  <span class="s4">}</span>

  <span class="s3">if</span><span class="s4">(</span><span class="s2">record</span><span class="s4">.</span><span class="s2">fragment</span><span class="s4">.</span><span class="s2">length</span><span class="s4">() === </span><span class="s7">0</span><span class="s4">) {</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">record</span><span class="s4">.</span><span class="s2">type </span><span class="s4">=== </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ContentType</span><span class="s4">.</span><span class="s2">handshake </span><span class="s4">||</span>
      <span class="s2">record</span><span class="s4">.</span><span class="s2">type </span><span class="s4">=== </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ContentType</span><span class="s4">.</span><span class="s2">alert </span><span class="s4">||</span>
      <span class="s2">record</span><span class="s4">.</span><span class="s2">type </span><span class="s4">=== </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ContentType</span><span class="s4">.</span><span class="s2">change_cipher_spec</span><span class="s4">) {</span>
      <span class="s6">// Empty handshake, alert of change cipher spec messages are not allowed per the TLS specification and should not be sent.</span>
      <span class="s3">return</span><span class="s4">;</span>
    <span class="s4">}</span>
  <span class="s4">}</span>

  <span class="s6">// if the record is a handshake record, update handshake hashes</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">record</span><span class="s4">.</span><span class="s2">type </span><span class="s4">=== </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ContentType</span><span class="s4">.</span><span class="s2">handshake</span><span class="s4">) {</span>
    <span class="s3">var </span><span class="s2">bytes </span><span class="s4">= </span><span class="s2">record</span><span class="s4">.</span><span class="s2">fragment</span><span class="s4">.</span><span class="s2">bytes</span><span class="s4">();</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">md5</span><span class="s4">.</span><span class="s2">update</span><span class="s4">(</span><span class="s2">bytes</span><span class="s4">);</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">sha1</span><span class="s4">.</span><span class="s2">update</span><span class="s4">(</span><span class="s2">bytes</span><span class="s4">);</span>
    <span class="s2">bytes </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
  <span class="s4">}</span>

  <span class="s6">// handle record fragmentation</span>
  <span class="s3">var </span><span class="s2">records</span><span class="s4">;</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">record</span><span class="s4">.</span><span class="s2">fragment</span><span class="s4">.</span><span class="s2">length</span><span class="s4">() &lt;= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">MaxFragment</span><span class="s4">) {</span>
    <span class="s2">records </span><span class="s4">= [</span><span class="s2">record</span><span class="s4">];</span>
  <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
    <span class="s6">// fragment data as long as it is too long</span>
    <span class="s2">records </span><span class="s4">= [];</span>
    <span class="s3">var </span><span class="s2">data </span><span class="s4">= </span><span class="s2">record</span><span class="s4">.</span><span class="s2">fragment</span><span class="s4">.</span><span class="s2">bytes</span><span class="s4">();</span>
    <span class="s3">while</span><span class="s4">(</span><span class="s2">data</span><span class="s4">.</span><span class="s2">length </span><span class="s4">&gt; </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">MaxFragment</span><span class="s4">) {</span>
      <span class="s2">records</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createRecord</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
        <span class="s2">type</span><span class="s4">: </span><span class="s2">record</span><span class="s4">.</span><span class="s2">type</span><span class="s4">,</span>
        <span class="s2">data</span><span class="s4">: </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">(</span><span class="s2">data</span><span class="s4">.</span><span class="s2">slice</span><span class="s4">(</span><span class="s7">0</span><span class="s4">, </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">MaxFragment</span><span class="s4">))</span>
      <span class="s4">}));</span>
      <span class="s2">data </span><span class="s4">= </span><span class="s2">data</span><span class="s4">.</span><span class="s2">slice</span><span class="s4">(</span><span class="s2">tls</span><span class="s4">.</span><span class="s2">MaxFragment</span><span class="s4">);</span>
    <span class="s4">}</span>
    <span class="s6">// add last record</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">data</span><span class="s4">.</span><span class="s2">length </span><span class="s4">&gt; </span><span class="s7">0</span><span class="s4">) {</span>
      <span class="s2">records</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createRecord</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
        <span class="s2">type</span><span class="s4">: </span><span class="s2">record</span><span class="s4">.</span><span class="s2">type</span><span class="s4">,</span>
        <span class="s2">data</span><span class="s4">: </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">(</span><span class="s2">data</span><span class="s4">)</span>
      <span class="s4">}));</span>
    <span class="s4">}</span>
  <span class="s4">}</span>

  <span class="s6">// compress and encrypt all fragmented records</span>
  <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">records</span><span class="s4">.</span><span class="s2">length </span><span class="s4">&amp;&amp; !</span><span class="s2">c</span><span class="s4">.</span><span class="s2">fail</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
    <span class="s6">// update the record using current write state</span>
    <span class="s3">var </span><span class="s2">rec </span><span class="s4">= </span><span class="s2">records</span><span class="s4">[</span><span class="s2">i</span><span class="s4">];</span>
    <span class="s3">var </span><span class="s2">s </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">state</span><span class="s4">.</span><span class="s2">current</span><span class="s4">.</span><span class="s2">write</span><span class="s4">;</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">s</span><span class="s4">.</span><span class="s2">update</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">rec</span><span class="s4">)) {</span>
      <span class="s6">// store record</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">records</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">rec</span><span class="s4">);</span>
    <span class="s4">}</span>
  <span class="s4">}</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Flushes all queued records to the output buffer and calls the</span>
 <span class="s0">* tlsDataReady() handler on the given connection.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the connection.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">true on success, false on failure.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">flush </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">) {</span>
  <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">c</span><span class="s4">.</span><span class="s2">records</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
    <span class="s3">var </span><span class="s2">record </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">records</span><span class="s4">[</span><span class="s2">i</span><span class="s4">];</span>

    <span class="s6">// add record header and fragment</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">tlsData</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">record</span><span class="s4">.</span><span class="s2">type</span><span class="s4">);</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">tlsData</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">record</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">major</span><span class="s4">);</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">tlsData</span><span class="s4">.</span><span class="s2">putByte</span><span class="s4">(</span><span class="s2">record</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">minor</span><span class="s4">);</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">tlsData</span><span class="s4">.</span><span class="s2">putInt16</span><span class="s4">(</span><span class="s2">record</span><span class="s4">.</span><span class="s2">fragment</span><span class="s4">.</span><span class="s2">length</span><span class="s4">());</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">tlsData</span><span class="s4">.</span><span class="s2">putBuffer</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">records</span><span class="s4">[</span><span class="s2">i</span><span class="s4">].</span><span class="s2">fragment</span><span class="s4">);</span>
  <span class="s4">}</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">records </span><span class="s4">= [];</span>
  <span class="s3">return </span><span class="s2">c</span><span class="s4">.</span><span class="s2">tlsDataReady</span><span class="s4">(</span><span class="s2">c</span><span class="s4">);</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Maps a pki.certificateError to a tls.Alert.Description.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">error the error to map.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the alert description.</span>
 <span class="s0">*/</span>
<span class="s3">var </span><span class="s2">_certErrorToAlertDesc </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">error</span><span class="s4">) {</span>
  <span class="s3">switch</span><span class="s4">(</span><span class="s2">error</span><span class="s4">) {</span>
  <span class="s3">case true</span><span class="s4">:</span>
    <span class="s3">return true</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateError</span><span class="s4">.</span><span class="s2">bad_certificate</span><span class="s4">:</span>
    <span class="s3">return </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">bad_certificate</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateError</span><span class="s4">.</span><span class="s2">unsupported_certificate</span><span class="s4">:</span>
    <span class="s3">return </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">unsupported_certificate</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateError</span><span class="s4">.</span><span class="s2">certificate_revoked</span><span class="s4">:</span>
    <span class="s3">return </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">certificate_revoked</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateError</span><span class="s4">.</span><span class="s2">certificate_expired</span><span class="s4">:</span>
    <span class="s3">return </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">certificate_expired</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateError</span><span class="s4">.</span><span class="s2">certificate_unknown</span><span class="s4">:</span>
    <span class="s3">return </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">certificate_unknown</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateError</span><span class="s4">.</span><span class="s2">unknown_ca</span><span class="s4">:</span>
    <span class="s3">return </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">unknown_ca</span><span class="s4">;</span>
  <span class="s3">default</span><span class="s4">:</span>
    <span class="s3">return </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">bad_certificate</span><span class="s4">;</span>
  <span class="s4">}</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Maps a tls.Alert.Description to a pki.certificateError.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">desc the alert description.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the certificate error.</span>
 <span class="s0">*/</span>
<span class="s3">var </span><span class="s2">_alertDescToCertError </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">desc</span><span class="s4">) {</span>
  <span class="s3">switch</span><span class="s4">(</span><span class="s2">desc</span><span class="s4">) {</span>
  <span class="s3">case true</span><span class="s4">:</span>
    <span class="s3">return true</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">bad_certificate</span><span class="s4">:</span>
    <span class="s3">return </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateError</span><span class="s4">.</span><span class="s2">bad_certificate</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">unsupported_certificate</span><span class="s4">:</span>
    <span class="s3">return </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateError</span><span class="s4">.</span><span class="s2">unsupported_certificate</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">certificate_revoked</span><span class="s4">:</span>
    <span class="s3">return </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateError</span><span class="s4">.</span><span class="s2">certificate_revoked</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">certificate_expired</span><span class="s4">:</span>
    <span class="s3">return </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateError</span><span class="s4">.</span><span class="s2">certificate_expired</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">certificate_unknown</span><span class="s4">:</span>
    <span class="s3">return </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateError</span><span class="s4">.</span><span class="s2">certificate_unknown</span><span class="s4">;</span>
  <span class="s3">case </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">unknown_ca</span><span class="s4">:</span>
    <span class="s3">return </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateError</span><span class="s4">.</span><span class="s2">unknown_ca</span><span class="s4">;</span>
  <span class="s3">default</span><span class="s4">:</span>
    <span class="s3">return </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">certificateError</span><span class="s4">.</span><span class="s2">bad_certificate</span><span class="s4">;</span>
  <span class="s4">}</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Verifies a certificate chain against the given connection's</span>
 <span class="s0">* Certificate Authority store.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the TLS connection.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">chain the certificate chain to verify, with the root or highest</span>
 <span class="s0">*          authority at the end.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">true if successful, false if not.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">verifyCertificateChain </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">chain</span><span class="s4">) {</span>
  <span class="s3">try </span><span class="s4">{</span>
    <span class="s6">// Make a copy of c.verifyOptions so that we can modify options.verify</span>
    <span class="s6">// without modifying c.verifyOptions.</span>
    <span class="s3">var </span><span class="s2">options </span><span class="s4">= {};</span>
    <span class="s3">for </span><span class="s4">(</span><span class="s3">var </span><span class="s2">key </span><span class="s3">in </span><span class="s2">c</span><span class="s4">.</span><span class="s2">verifyOptions</span><span class="s4">) {</span>
      <span class="s2">options</span><span class="s4">[</span><span class="s2">key</span><span class="s4">] = </span><span class="s2">c</span><span class="s4">.</span><span class="s2">verifyOptions</span><span class="s4">[</span><span class="s2">key</span><span class="s4">];</span>
    <span class="s4">}</span>

    <span class="s2">options</span><span class="s4">.</span><span class="s2">verify </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">vfd</span><span class="s4">, </span><span class="s2">depth</span><span class="s4">, </span><span class="s2">chain</span><span class="s4">) {</span>
      <span class="s6">// convert pki.certificateError to tls alert description</span>
      <span class="s3">var </span><span class="s2">desc </span><span class="s4">= </span><span class="s2">_certErrorToAlertDesc</span><span class="s4">(</span><span class="s2">vfd</span><span class="s4">);</span>

      <span class="s6">// call application callback</span>
      <span class="s3">var </span><span class="s2">ret </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">verify</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">vfd</span><span class="s4">, </span><span class="s2">depth</span><span class="s4">, </span><span class="s2">chain</span><span class="s4">);</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">ret </span><span class="s4">!== </span><span class="s3">true</span><span class="s4">) {</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s3">typeof </span><span class="s2">ret </span><span class="s4">=== </span><span class="s5">'object' </span><span class="s4">&amp;&amp; !</span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">isArray</span><span class="s4">(</span><span class="s2">ret</span><span class="s4">)) {</span>
          <span class="s6">// throw custom error</span>
          <span class="s3">var </span><span class="s2">error </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'The application rejected the certificate.'</span><span class="s4">);</span>
          <span class="s2">error</span><span class="s4">.</span><span class="s2">send </span><span class="s4">= </span><span class="s3">true</span><span class="s4">;</span>
          <span class="s2">error</span><span class="s4">.</span><span class="s2">alert </span><span class="s4">= {</span>
            <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
            <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">bad_certificate</span>
          <span class="s4">};</span>
          <span class="s3">if</span><span class="s4">(</span><span class="s2">ret</span><span class="s4">.</span><span class="s2">message</span><span class="s4">) {</span>
            <span class="s2">error</span><span class="s4">.</span><span class="s2">message </span><span class="s4">= </span><span class="s2">ret</span><span class="s4">.</span><span class="s2">message</span><span class="s4">;</span>
          <span class="s4">}</span>
          <span class="s3">if</span><span class="s4">(</span><span class="s2">ret</span><span class="s4">.</span><span class="s2">alert</span><span class="s4">) {</span>
            <span class="s2">error</span><span class="s4">.</span><span class="s2">alert</span><span class="s4">.</span><span class="s2">description </span><span class="s4">= </span><span class="s2">ret</span><span class="s4">.</span><span class="s2">alert</span><span class="s4">;</span>
          <span class="s4">}</span>
          <span class="s3">throw </span><span class="s2">error</span><span class="s4">;</span>
        <span class="s4">}</span>

        <span class="s6">// convert tls alert description to pki.certificateError</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s2">ret </span><span class="s4">!== </span><span class="s2">vfd</span><span class="s4">) {</span>
          <span class="s2">ret </span><span class="s4">= </span><span class="s2">_alertDescToCertError</span><span class="s4">(</span><span class="s2">ret</span><span class="s4">);</span>
        <span class="s4">}</span>
      <span class="s4">}</span>

      <span class="s3">return </span><span class="s2">ret</span><span class="s4">;</span>
    <span class="s4">};</span>

    <span class="s6">// verify chain</span>
    <span class="s2">forge</span><span class="s4">.</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">verifyCertificateChain</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">caStore</span><span class="s4">, </span><span class="s2">chain</span><span class="s4">, </span><span class="s2">options</span><span class="s4">);</span>
  <span class="s4">} </span><span class="s3">catch</span><span class="s4">(</span><span class="s2">ex</span><span class="s4">) {</span>
    <span class="s6">// build tls error if not already customized</span>
    <span class="s3">var </span><span class="s2">err </span><span class="s4">= </span><span class="s2">ex</span><span class="s4">;</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s3">typeof </span><span class="s2">err </span><span class="s4">!== </span><span class="s5">'object' </span><span class="s4">|| </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">isArray</span><span class="s4">(</span><span class="s2">err</span><span class="s4">)) {</span>
      <span class="s2">err </span><span class="s4">= {</span>
        <span class="s2">send</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
        <span class="s2">alert</span><span class="s4">: {</span>
          <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
          <span class="s2">description</span><span class="s4">: </span><span class="s2">_certErrorToAlertDesc</span><span class="s4">(</span><span class="s2">ex</span><span class="s4">)</span>
        <span class="s4">}</span>
      <span class="s4">};</span>
    <span class="s4">}</span>
    <span class="s3">if</span><span class="s4">(!(</span><span class="s5">'send' </span><span class="s3">in </span><span class="s2">err</span><span class="s4">)) {</span>
      <span class="s2">err</span><span class="s4">.</span><span class="s2">send </span><span class="s4">= </span><span class="s3">true</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s3">if</span><span class="s4">(!(</span><span class="s5">'alert' </span><span class="s3">in </span><span class="s2">err</span><span class="s4">)) {</span>
      <span class="s2">err</span><span class="s4">.</span><span class="s2">alert </span><span class="s4">= {</span>
        <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
        <span class="s2">description</span><span class="s4">: </span><span class="s2">_certErrorToAlertDesc</span><span class="s4">(</span><span class="s2">err</span><span class="s4">.</span><span class="s2">error</span><span class="s4">)</span>
      <span class="s4">};</span>
    <span class="s4">}</span>

    <span class="s6">// send error</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">err</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s3">return </span><span class="s4">!</span><span class="s2">c</span><span class="s4">.</span><span class="s2">fail</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Creates a new TLS session cache.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">cache optional map of session ID to cached session.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">capacity the maximum size for the cache (default: 100).</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the new TLS session cache.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">createSessionCache </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">cache</span><span class="s4">, </span><span class="s2">capacity</span><span class="s4">) {</span>
  <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>

  <span class="s6">// assume input is already a session cache object</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">cache </span><span class="s4">&amp;&amp; </span><span class="s2">cache</span><span class="s4">.</span><span class="s2">getSession </span><span class="s4">&amp;&amp; </span><span class="s2">cache</span><span class="s4">.</span><span class="s2">setSession </span><span class="s4">&amp;&amp; </span><span class="s2">cache</span><span class="s4">.</span><span class="s2">order</span><span class="s4">) {</span>
    <span class="s2">rval </span><span class="s4">= </span><span class="s2">cache</span><span class="s4">;</span>
  <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
    <span class="s6">// create cache</span>
    <span class="s2">rval </span><span class="s4">= {};</span>
    <span class="s2">rval</span><span class="s4">.</span><span class="s2">cache </span><span class="s4">= </span><span class="s2">cache </span><span class="s4">|| {};</span>
    <span class="s2">rval</span><span class="s4">.</span><span class="s2">capacity </span><span class="s4">= </span><span class="s2">Math</span><span class="s4">.</span><span class="s2">max</span><span class="s4">(</span><span class="s2">capacity </span><span class="s4">|| </span><span class="s7">100</span><span class="s4">, </span><span class="s7">1</span><span class="s4">);</span>
    <span class="s2">rval</span><span class="s4">.</span><span class="s2">order </span><span class="s4">= [];</span>

    <span class="s6">// store order for sessions, delete session overflow</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">key </span><span class="s3">in </span><span class="s2">cache</span><span class="s4">) {</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">rval</span><span class="s4">.</span><span class="s2">order</span><span class="s4">.</span><span class="s2">length </span><span class="s4">&lt;= </span><span class="s2">capacity</span><span class="s4">) {</span>
        <span class="s2">rval</span><span class="s4">.</span><span class="s2">order</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">key</span><span class="s4">);</span>
      <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
        <span class="s3">delete </span><span class="s2">cache</span><span class="s4">[</span><span class="s2">key</span><span class="s4">];</span>
      <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s6">// get a session from a session ID (or get any session)</span>
    <span class="s2">rval</span><span class="s4">.</span><span class="s2">getSession </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">sessionId</span><span class="s4">) {</span>
      <span class="s3">var </span><span class="s2">session </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
      <span class="s3">var </span><span class="s2">key </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>

      <span class="s6">// if session ID provided, use it</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">sessionId</span><span class="s4">) {</span>
        <span class="s2">key </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">bytesToHex</span><span class="s4">(</span><span class="s2">sessionId</span><span class="s4">);</span>
      <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">rval</span><span class="s4">.</span><span class="s2">order</span><span class="s4">.</span><span class="s2">length </span><span class="s4">&gt; </span><span class="s7">0</span><span class="s4">) {</span>
        <span class="s6">// get first session from cache</span>
        <span class="s2">key </span><span class="s4">= </span><span class="s2">rval</span><span class="s4">.</span><span class="s2">order</span><span class="s4">[</span><span class="s7">0</span><span class="s4">];</span>
      <span class="s4">}</span>

      <span class="s3">if</span><span class="s4">(</span><span class="s2">key </span><span class="s4">!== </span><span class="s3">null </span><span class="s4">&amp;&amp; </span><span class="s2">key </span><span class="s3">in </span><span class="s2">rval</span><span class="s4">.</span><span class="s2">cache</span><span class="s4">) {</span>
        <span class="s6">// get cached session and remove from cache</span>
        <span class="s2">session </span><span class="s4">= </span><span class="s2">rval</span><span class="s4">.</span><span class="s2">cache</span><span class="s4">[</span><span class="s2">key</span><span class="s4">];</span>
        <span class="s3">delete </span><span class="s2">rval</span><span class="s4">.</span><span class="s2">cache</span><span class="s4">[</span><span class="s2">key</span><span class="s4">];</span>
        <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s3">in </span><span class="s2">rval</span><span class="s4">.</span><span class="s2">order</span><span class="s4">) {</span>
          <span class="s3">if</span><span class="s4">(</span><span class="s2">rval</span><span class="s4">.</span><span class="s2">order</span><span class="s4">[</span><span class="s2">i</span><span class="s4">] === </span><span class="s2">key</span><span class="s4">) {</span>
            <span class="s2">rval</span><span class="s4">.</span><span class="s2">order</span><span class="s4">.</span><span class="s2">splice</span><span class="s4">(</span><span class="s2">i</span><span class="s4">, </span><span class="s7">1</span><span class="s4">);</span>
            <span class="s3">break</span><span class="s4">;</span>
          <span class="s4">}</span>
        <span class="s4">}</span>
      <span class="s4">}</span>

      <span class="s3">return </span><span class="s2">session</span><span class="s4">;</span>
    <span class="s4">};</span>

    <span class="s6">// set a session in the cache</span>
    <span class="s2">rval</span><span class="s4">.</span><span class="s2">setSession </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">sessionId</span><span class="s4">, </span><span class="s2">session</span><span class="s4">) {</span>
      <span class="s6">// remove session from cache if at capacity</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">rval</span><span class="s4">.</span><span class="s2">order</span><span class="s4">.</span><span class="s2">length </span><span class="s4">=== </span><span class="s2">rval</span><span class="s4">.</span><span class="s2">capacity</span><span class="s4">) {</span>
        <span class="s3">var </span><span class="s2">key </span><span class="s4">= </span><span class="s2">rval</span><span class="s4">.</span><span class="s2">order</span><span class="s4">.</span><span class="s2">shift</span><span class="s4">();</span>
        <span class="s3">delete </span><span class="s2">rval</span><span class="s4">.</span><span class="s2">cache</span><span class="s4">[</span><span class="s2">key</span><span class="s4">];</span>
      <span class="s4">}</span>
      <span class="s6">// add session to cache</span>
      <span class="s3">var </span><span class="s2">key </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">bytesToHex</span><span class="s4">(</span><span class="s2">sessionId</span><span class="s4">);</span>
      <span class="s2">rval</span><span class="s4">.</span><span class="s2">order</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">key</span><span class="s4">);</span>
      <span class="s2">rval</span><span class="s4">.</span><span class="s2">cache</span><span class="s4">[</span><span class="s2">key</span><span class="s4">] = </span><span class="s2">session</span><span class="s4">;</span>
    <span class="s4">};</span>
  <span class="s4">}</span>

  <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s0">/**</span>
 <span class="s0">* Creates a new TLS connection.</span>
 <span class="s0">*</span>
 <span class="s0">* See public createConnection() docs for more details.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">options the options for this connection.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the new TLS connection.</span>
 <span class="s0">*/</span>
<span class="s2">tls</span><span class="s4">.</span><span class="s2">createConnection </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">options</span><span class="s4">) {</span>
  <span class="s3">var </span><span class="s2">caStore </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">options</span><span class="s4">.</span><span class="s2">caStore</span><span class="s4">) {</span>
    <span class="s6">// if CA store is an array, convert it to a CA store object</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">isArray</span><span class="s4">(</span><span class="s2">options</span><span class="s4">.</span><span class="s2">caStore</span><span class="s4">)) {</span>
      <span class="s2">caStore </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">createCaStore</span><span class="s4">(</span><span class="s2">options</span><span class="s4">.</span><span class="s2">caStore</span><span class="s4">);</span>
    <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
      <span class="s2">caStore </span><span class="s4">= </span><span class="s2">options</span><span class="s4">.</span><span class="s2">caStore</span><span class="s4">;</span>
    <span class="s4">}</span>
  <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
    <span class="s6">// create empty CA store</span>
    <span class="s2">caStore </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">pki</span><span class="s4">.</span><span class="s2">createCaStore</span><span class="s4">();</span>
  <span class="s4">}</span>

  <span class="s6">// setup default cipher suites</span>
  <span class="s3">var </span><span class="s2">cipherSuites </span><span class="s4">= </span><span class="s2">options</span><span class="s4">.</span><span class="s2">cipherSuites </span><span class="s4">|| </span><span class="s3">null</span><span class="s4">;</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s2">cipherSuites </span><span class="s4">=== </span><span class="s3">null</span><span class="s4">) {</span>
    <span class="s2">cipherSuites </span><span class="s4">= [];</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">key </span><span class="s3">in </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">CipherSuites</span><span class="s4">) {</span>
      <span class="s2">cipherSuites</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s2">tls</span><span class="s4">.</span><span class="s2">CipherSuites</span><span class="s4">[</span><span class="s2">key</span><span class="s4">]);</span>
    <span class="s4">}</span>
  <span class="s4">}</span>

  <span class="s6">// set default entity</span>
  <span class="s3">var </span><span class="s2">entity </span><span class="s4">= (</span><span class="s2">options</span><span class="s4">.</span><span class="s2">server </span><span class="s4">|| </span><span class="s3">false</span><span class="s4">) ?</span>
    <span class="s2">tls</span><span class="s4">.</span><span class="s2">ConnectionEnd</span><span class="s4">.</span><span class="s2">server </span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ConnectionEnd</span><span class="s4">.</span><span class="s2">client</span><span class="s4">;</span>

  <span class="s6">// create session cache if requested</span>
  <span class="s3">var </span><span class="s2">sessionCache </span><span class="s4">= </span><span class="s2">options</span><span class="s4">.</span><span class="s2">sessionCache </span><span class="s4">?</span>
    <span class="s2">tls</span><span class="s4">.</span><span class="s2">createSessionCache</span><span class="s4">(</span><span class="s2">options</span><span class="s4">.</span><span class="s2">sessionCache</span><span class="s4">) : </span><span class="s3">null</span><span class="s4">;</span>

  <span class="s6">// create TLS connection</span>
  <span class="s3">var </span><span class="s2">c </span><span class="s4">= {</span>
    <span class="s2">version</span><span class="s4">: {</span><span class="s2">major</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Version</span><span class="s4">.</span><span class="s2">major</span><span class="s4">, </span><span class="s2">minor</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Version</span><span class="s4">.</span><span class="s2">minor</span><span class="s4">},</span>
    <span class="s2">entity</span><span class="s4">: </span><span class="s2">entity</span><span class="s4">,</span>
    <span class="s2">sessionId</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">sessionId</span><span class="s4">,</span>
    <span class="s2">caStore</span><span class="s4">: </span><span class="s2">caStore</span><span class="s4">,</span>
    <span class="s2">sessionCache</span><span class="s4">: </span><span class="s2">sessionCache</span><span class="s4">,</span>
    <span class="s2">cipherSuites</span><span class="s4">: </span><span class="s2">cipherSuites</span><span class="s4">,</span>
    <span class="s2">connected</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">connected</span><span class="s4">,</span>
    <span class="s2">virtualHost</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">virtualHost </span><span class="s4">|| </span><span class="s3">null</span><span class="s4">,</span>
    <span class="s2">verifyClient</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">verifyClient </span><span class="s4">|| </span><span class="s3">false</span><span class="s4">,</span>
    <span class="s2">verify</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">verify </span><span class="s4">|| </span><span class="s3">function</span><span class="s4">(</span><span class="s2">cn</span><span class="s4">, </span><span class="s2">vfd</span><span class="s4">, </span><span class="s2">dpth</span><span class="s4">, </span><span class="s2">cts</span><span class="s4">) {</span><span class="s3">return </span><span class="s2">vfd</span><span class="s4">;},</span>
    <span class="s2">verifyOptions</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">verifyOptions </span><span class="s4">|| {},</span>
    <span class="s2">getCertificate</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">getCertificate </span><span class="s4">|| </span><span class="s3">null</span><span class="s4">,</span>
    <span class="s2">getPrivateKey</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">getPrivateKey </span><span class="s4">|| </span><span class="s3">null</span><span class="s4">,</span>
    <span class="s2">getSignature</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">getSignature </span><span class="s4">|| </span><span class="s3">null</span><span class="s4">,</span>
    <span class="s2">input</span><span class="s4">: </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">(),</span>
    <span class="s2">tlsData</span><span class="s4">: </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">(),</span>
    <span class="s2">data</span><span class="s4">: </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">(),</span>
    <span class="s2">tlsDataReady</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">tlsDataReady</span><span class="s4">,</span>
    <span class="s2">dataReady</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">dataReady</span><span class="s4">,</span>
    <span class="s2">heartbeatReceived</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">heartbeatReceived</span><span class="s4">,</span>
    <span class="s2">closed</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">closed</span><span class="s4">,</span>
    <span class="s2">error</span><span class="s4">: </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">ex</span><span class="s4">) {</span>
      <span class="s6">// set origin if not set</span>
      <span class="s2">ex</span><span class="s4">.</span><span class="s2">origin </span><span class="s4">= </span><span class="s2">ex</span><span class="s4">.</span><span class="s2">origin </span><span class="s4">||</span>
        <span class="s4">((</span><span class="s2">c</span><span class="s4">.</span><span class="s2">entity </span><span class="s4">=== </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ConnectionEnd</span><span class="s4">.</span><span class="s2">client</span><span class="s4">) ? </span><span class="s5">'client' </span><span class="s4">: </span><span class="s5">'server'</span><span class="s4">);</span>

      <span class="s6">// send TLS alert</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">ex</span><span class="s4">.</span><span class="s2">send</span><span class="s4">) {</span>
        <span class="s2">tls</span><span class="s4">.</span><span class="s2">queue</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createAlert</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">ex</span><span class="s4">.</span><span class="s2">alert</span><span class="s4">));</span>
        <span class="s2">tls</span><span class="s4">.</span><span class="s2">flush</span><span class="s4">(</span><span class="s2">c</span><span class="s4">);</span>
      <span class="s4">}</span>

      <span class="s6">// error is fatal by default</span>
      <span class="s3">var </span><span class="s2">fatal </span><span class="s4">= (</span><span class="s2">ex</span><span class="s4">.</span><span class="s2">fatal </span><span class="s4">!== </span><span class="s3">false</span><span class="s4">);</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">fatal</span><span class="s4">) {</span>
        <span class="s6">// set fail flag</span>
        <span class="s2">c</span><span class="s4">.</span><span class="s2">fail </span><span class="s4">= </span><span class="s3">true</span><span class="s4">;</span>
      <span class="s4">}</span>

      <span class="s6">// call error handler first</span>
      <span class="s2">options</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">ex</span><span class="s4">);</span>

      <span class="s3">if</span><span class="s4">(</span><span class="s2">fatal</span><span class="s4">) {</span>
        <span class="s6">// fatal error, close connection, do not clear fail</span>
        <span class="s2">c</span><span class="s4">.</span><span class="s2">close</span><span class="s4">(</span><span class="s3">false</span><span class="s4">);</span>
      <span class="s4">}</span>
    <span class="s4">},</span>
    <span class="s2">deflate</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">deflate </span><span class="s4">|| </span><span class="s3">null</span><span class="s4">,</span>
    <span class="s2">inflate</span><span class="s4">: </span><span class="s2">options</span><span class="s4">.</span><span class="s2">inflate </span><span class="s4">|| </span><span class="s3">null</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Resets a closed TLS connection for reuse. Called in c.close().</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">clearFail true to clear the fail flag (default: true).</span>
   <span class="s0">*/</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">reset </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">clearFail</span><span class="s4">) {</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">version </span><span class="s4">= {</span><span class="s2">major</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Version</span><span class="s4">.</span><span class="s2">major</span><span class="s4">, </span><span class="s2">minor</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Version</span><span class="s4">.</span><span class="s2">minor</span><span class="s4">};</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">record </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">session </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">peerCertificate </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">state </span><span class="s4">= {</span>
      <span class="s2">pending</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
      <span class="s2">current</span><span class="s4">: </span><span class="s3">null</span>
    <span class="s4">};</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">expect </span><span class="s4">= (</span><span class="s2">c</span><span class="s4">.</span><span class="s2">entity </span><span class="s4">=== </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ConnectionEnd</span><span class="s4">.</span><span class="s2">client</span><span class="s4">) ? </span><span class="s2">SHE </span><span class="s4">: </span><span class="s2">CHE</span><span class="s4">;</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">fragmented </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">records </span><span class="s4">= [];</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">open </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">handshakes </span><span class="s4">= </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">handshaking </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">isConnected </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">fail </span><span class="s4">= !(</span><span class="s2">clearFail </span><span class="s4">|| </span><span class="s3">typeof</span><span class="s4">(</span><span class="s2">clearFail</span><span class="s4">) === </span><span class="s5">'undefined'</span><span class="s4">);</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">input</span><span class="s4">.</span><span class="s2">clear</span><span class="s4">();</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">tlsData</span><span class="s4">.</span><span class="s2">clear</span><span class="s4">();</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">data</span><span class="s4">.</span><span class="s2">clear</span><span class="s4">();</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">state</span><span class="s4">.</span><span class="s2">current </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createConnectionState</span><span class="s4">(</span><span class="s2">c</span><span class="s4">);</span>
  <span class="s4">};</span>

  <span class="s6">// do initial reset of connection</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">reset</span><span class="s4">();</span>

  <span class="s0">/**</span>
   <span class="s0">* Updates the current TLS engine state based on the given record.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the TLS connection.</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">record the TLS record to act on.</span>
   <span class="s0">*/</span>
  <span class="s3">var </span><span class="s2">_update </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">) {</span>
    <span class="s6">// get record handler (align type in table by subtracting lowest)</span>
    <span class="s3">var </span><span class="s2">aligned </span><span class="s4">= </span><span class="s2">record</span><span class="s4">.</span><span class="s2">type </span><span class="s4">- </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ContentType</span><span class="s4">.</span><span class="s2">change_cipher_spec</span><span class="s4">;</span>
    <span class="s3">var </span><span class="s2">handlers </span><span class="s4">= </span><span class="s2">ctTable</span><span class="s4">[</span><span class="s2">c</span><span class="s4">.</span><span class="s2">entity</span><span class="s4">][</span><span class="s2">c</span><span class="s4">.</span><span class="s2">expect</span><span class="s4">];</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">aligned </span><span class="s3">in </span><span class="s2">handlers</span><span class="s4">) {</span>
      <span class="s2">handlers</span><span class="s4">[</span><span class="s2">aligned</span><span class="s4">](</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">);</span>
    <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
      <span class="s6">// unexpected record</span>
      <span class="s2">tls</span><span class="s4">.</span><span class="s2">handleUnexpected</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">record</span><span class="s4">);</span>
    <span class="s4">}</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Reads the record header and initializes the next record on the given</span>
   <span class="s0">* connection.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the TLS connection with the next record.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@return </span><span class="s0">0 if the input data could be processed, otherwise the</span>
   <span class="s0">*         number of bytes required for data to be processed.</span>
   <span class="s0">*/</span>
  <span class="s3">var </span><span class="s2">_readRecordHeader </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">) {</span>
    <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s7">0</span><span class="s4">;</span>

    <span class="s6">// get input buffer and its length</span>
    <span class="s3">var </span><span class="s2">b </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">input</span><span class="s4">;</span>
    <span class="s3">var </span><span class="s2">len </span><span class="s4">= </span><span class="s2">b</span><span class="s4">.</span><span class="s2">length</span><span class="s4">();</span>

    <span class="s6">// need at least 5 bytes to initialize a record</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">len </span><span class="s4">&lt; </span><span class="s7">5</span><span class="s4">) {</span>
      <span class="s2">rval </span><span class="s4">= </span><span class="s7">5 </span><span class="s4">- </span><span class="s2">len</span><span class="s4">;</span>
    <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
      <span class="s6">// enough bytes for header</span>
      <span class="s6">// initialize record</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">record </span><span class="s4">= {</span>
        <span class="s2">type</span><span class="s4">: </span><span class="s2">b</span><span class="s4">.</span><span class="s2">getByte</span><span class="s4">(),</span>
        <span class="s2">version</span><span class="s4">: {</span>
          <span class="s2">major</span><span class="s4">: </span><span class="s2">b</span><span class="s4">.</span><span class="s2">getByte</span><span class="s4">(),</span>
          <span class="s2">minor</span><span class="s4">: </span><span class="s2">b</span><span class="s4">.</span><span class="s2">getByte</span><span class="s4">()</span>
        <span class="s4">},</span>
        <span class="s2">length</span><span class="s4">: </span><span class="s2">b</span><span class="s4">.</span><span class="s2">getInt16</span><span class="s4">(),</span>
        <span class="s2">fragment</span><span class="s4">: </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">(),</span>
        <span class="s2">ready</span><span class="s4">: </span><span class="s3">false</span>
      <span class="s4">};</span>

      <span class="s6">// check record version</span>
      <span class="s3">var </span><span class="s2">compatibleVersion </span><span class="s4">= (</span><span class="s2">c</span><span class="s4">.</span><span class="s2">record</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">major </span><span class="s4">=== </span><span class="s2">c</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">major</span><span class="s4">);</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">compatibleVersion </span><span class="s4">&amp;&amp; </span><span class="s2">c</span><span class="s4">.</span><span class="s2">session </span><span class="s4">&amp;&amp; </span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">version</span><span class="s4">) {</span>
        <span class="s6">// session version already set, require same minor version</span>
        <span class="s2">compatibleVersion </span><span class="s4">= (</span><span class="s2">c</span><span class="s4">.</span><span class="s2">record</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">minor </span><span class="s4">=== </span><span class="s2">c</span><span class="s4">.</span><span class="s2">version</span><span class="s4">.</span><span class="s2">minor</span><span class="s4">);</span>
      <span class="s4">}</span>
      <span class="s3">if</span><span class="s4">(!</span><span class="s2">compatibleVersion</span><span class="s4">) {</span>
        <span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
          <span class="s2">message</span><span class="s4">: </span><span class="s5">'Incompatible TLS version.'</span><span class="s4">,</span>
          <span class="s2">send</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
          <span class="s2">alert</span><span class="s4">: {</span>
            <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
            <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">protocol_version</span>
          <span class="s4">}</span>
        <span class="s4">});</span>
      <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Reads the next record's contents and appends its message to any</span>
   <span class="s0">* previously fragmented message.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">c the TLS connection with the next record.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@return </span><span class="s0">0 if the input data could be processed, otherwise the</span>
   <span class="s0">*         number of bytes required for data to be processed.</span>
   <span class="s0">*/</span>
  <span class="s3">var </span><span class="s2">_readRecord </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">c</span><span class="s4">) {</span>
    <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s7">0</span><span class="s4">;</span>

    <span class="s6">// ensure there is enough input data to get the entire record</span>
    <span class="s3">var </span><span class="s2">b </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">input</span><span class="s4">;</span>
    <span class="s3">var </span><span class="s2">len </span><span class="s4">= </span><span class="s2">b</span><span class="s4">.</span><span class="s2">length</span><span class="s4">();</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">len </span><span class="s4">&lt; </span><span class="s2">c</span><span class="s4">.</span><span class="s2">record</span><span class="s4">.</span><span class="s2">length</span><span class="s4">) {</span>
      <span class="s6">// not enough data yet, return how much is required</span>
      <span class="s2">rval </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">record</span><span class="s4">.</span><span class="s2">length </span><span class="s4">- </span><span class="s2">len</span><span class="s4">;</span>
    <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
      <span class="s6">// there is enough data to parse the pending record</span>
      <span class="s6">// fill record fragment and compact input buffer</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">record</span><span class="s4">.</span><span class="s2">fragment</span><span class="s4">.</span><span class="s2">putBytes</span><span class="s4">(</span><span class="s2">b</span><span class="s4">.</span><span class="s2">getBytes</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">record</span><span class="s4">.</span><span class="s2">length</span><span class="s4">));</span>
      <span class="s2">b</span><span class="s4">.</span><span class="s2">compact</span><span class="s4">();</span>

      <span class="s6">// update record using current read state</span>
      <span class="s3">var </span><span class="s2">s </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">state</span><span class="s4">.</span><span class="s2">current</span><span class="s4">.</span><span class="s2">read</span><span class="s4">;</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">s</span><span class="s4">.</span><span class="s2">update</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">c</span><span class="s4">.</span><span class="s2">record</span><span class="s4">)) {</span>
        <span class="s6">// see if there is a previously fragmented message that the</span>
        <span class="s6">// new record's message fragment should be appended to</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">fragmented </span><span class="s4">!== </span><span class="s3">null</span><span class="s4">) {</span>
          <span class="s6">// if the record type matches a previously fragmented</span>
          <span class="s6">// record, append the record fragment to it</span>
          <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">fragmented</span><span class="s4">.</span><span class="s2">type </span><span class="s4">=== </span><span class="s2">c</span><span class="s4">.</span><span class="s2">record</span><span class="s4">.</span><span class="s2">type</span><span class="s4">) {</span>
            <span class="s6">// concatenate record fragments</span>
            <span class="s2">c</span><span class="s4">.</span><span class="s2">fragmented</span><span class="s4">.</span><span class="s2">fragment</span><span class="s4">.</span><span class="s2">putBuffer</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">record</span><span class="s4">.</span><span class="s2">fragment</span><span class="s4">);</span>
            <span class="s2">c</span><span class="s4">.</span><span class="s2">record </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">fragmented</span><span class="s4">;</span>
          <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
            <span class="s6">// error, invalid fragmented record</span>
            <span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
              <span class="s2">message</span><span class="s4">: </span><span class="s5">'Invalid fragmented record.'</span><span class="s4">,</span>
              <span class="s2">send</span><span class="s4">: </span><span class="s3">true</span><span class="s4">,</span>
              <span class="s2">alert</span><span class="s4">: {</span>
                <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">fatal</span><span class="s4">,</span>
                <span class="s2">description</span><span class="s4">:</span>
                  <span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">unexpected_message</span>
              <span class="s4">}</span>
            <span class="s4">});</span>
          <span class="s4">}</span>
        <span class="s4">}</span>

        <span class="s6">// record is now ready</span>
        <span class="s2">c</span><span class="s4">.</span><span class="s2">record</span><span class="s4">.</span><span class="s2">ready </span><span class="s4">= </span><span class="s3">true</span><span class="s4">;</span>
      <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Performs a handshake using the TLS Handshake Protocol, as a client.</span>
   <span class="s0">*</span>
   <span class="s0">* This method should only be called if the connection is in client mode.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">sessionId the session ID to use, null to start a new one.</span>
   <span class="s0">*/</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">handshake </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">sessionId</span><span class="s4">) {</span>
    <span class="s6">// error to call this in non-client mode</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">entity </span><span class="s4">!== </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ConnectionEnd</span><span class="s4">.</span><span class="s2">client</span><span class="s4">) {</span>
      <span class="s6">// not fatal error</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
        <span class="s2">message</span><span class="s4">: </span><span class="s5">'Cannot initiate handshake as a server.'</span><span class="s4">,</span>
        <span class="s2">fatal</span><span class="s4">: </span><span class="s3">false</span>
      <span class="s4">});</span>
    <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">handshaking</span><span class="s4">) {</span>
      <span class="s6">// handshake is already in progress, fail but not fatal error</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">error</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
        <span class="s2">message</span><span class="s4">: </span><span class="s5">'Handshake already in progress.'</span><span class="s4">,</span>
        <span class="s2">fatal</span><span class="s4">: </span><span class="s3">false</span>
      <span class="s4">});</span>
    <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
      <span class="s6">// clear fail flag on reuse</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">fail </span><span class="s4">&amp;&amp; !</span><span class="s2">c</span><span class="s4">.</span><span class="s2">open </span><span class="s4">&amp;&amp; </span><span class="s2">c</span><span class="s4">.</span><span class="s2">handshakes </span><span class="s4">=== </span><span class="s7">0</span><span class="s4">) {</span>
        <span class="s2">c</span><span class="s4">.</span><span class="s2">fail </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>
      <span class="s4">}</span>

      <span class="s6">// now handshaking</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">handshaking </span><span class="s4">= </span><span class="s3">true</span><span class="s4">;</span>

      <span class="s6">// default to blank (new session)</span>
      <span class="s2">sessionId </span><span class="s4">= </span><span class="s2">sessionId </span><span class="s4">|| </span><span class="s5">''</span><span class="s4">;</span>

      <span class="s6">// if a session ID was specified, try to find it in the cache</span>
      <span class="s3">var </span><span class="s2">session </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">sessionId</span><span class="s4">.</span><span class="s2">length </span><span class="s4">&gt; </span><span class="s7">0</span><span class="s4">) {</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">sessionCache</span><span class="s4">) {</span>
          <span class="s2">session </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">sessionCache</span><span class="s4">.</span><span class="s2">getSession</span><span class="s4">(</span><span class="s2">sessionId</span><span class="s4">);</span>
        <span class="s4">}</span>

        <span class="s6">// matching session not found in cache, clear session ID</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s2">session </span><span class="s4">=== </span><span class="s3">null</span><span class="s4">) {</span>
          <span class="s2">sessionId </span><span class="s4">= </span><span class="s5">''</span><span class="s4">;</span>
        <span class="s4">}</span>
      <span class="s4">}</span>

      <span class="s6">// no session given, grab a session from the cache, if available</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">sessionId</span><span class="s4">.</span><span class="s2">length </span><span class="s4">=== </span><span class="s7">0 </span><span class="s4">&amp;&amp; </span><span class="s2">c</span><span class="s4">.</span><span class="s2">sessionCache</span><span class="s4">) {</span>
        <span class="s2">session </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">sessionCache</span><span class="s4">.</span><span class="s2">getSession</span><span class="s4">();</span>
        <span class="s3">if</span><span class="s4">(</span><span class="s2">session </span><span class="s4">!== </span><span class="s3">null</span><span class="s4">) {</span>
          <span class="s2">sessionId </span><span class="s4">= </span><span class="s2">session</span><span class="s4">.</span><span class="s2">id</span><span class="s4">;</span>
        <span class="s4">}</span>
      <span class="s4">}</span>

      <span class="s6">// set up session</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">session </span><span class="s4">= {</span>
        <span class="s2">id</span><span class="s4">: </span><span class="s2">sessionId</span><span class="s4">,</span>
        <span class="s2">version</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
        <span class="s2">cipherSuite</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
        <span class="s2">compressionMethod</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
        <span class="s2">serverCertificate</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
        <span class="s2">certificateRequest</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
        <span class="s2">clientCertificate</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
        <span class="s2">sp</span><span class="s4">: {},</span>
        <span class="s2">md5</span><span class="s4">: </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">md5</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(),</span>
        <span class="s2">sha1</span><span class="s4">: </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">sha1</span><span class="s4">.</span><span class="s2">create</span><span class="s4">()</span>
      <span class="s4">};</span>

      <span class="s6">// use existing session information</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">session</span><span class="s4">) {</span>
        <span class="s6">// only update version on connection, session version not yet set</span>
        <span class="s2">c</span><span class="s4">.</span><span class="s2">version </span><span class="s4">= </span><span class="s2">session</span><span class="s4">.</span><span class="s2">version</span><span class="s4">;</span>
        <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">sp </span><span class="s4">= </span><span class="s2">session</span><span class="s4">.</span><span class="s2">sp</span><span class="s4">;</span>
      <span class="s4">}</span>

      <span class="s6">// generate new client random</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">sp</span><span class="s4">.</span><span class="s2">client_random </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createRandom</span><span class="s4">().</span><span class="s2">getBytes</span><span class="s4">();</span>

      <span class="s6">// connection now open</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">open </span><span class="s4">= </span><span class="s3">true</span><span class="s4">;</span>

      <span class="s6">// send hello</span>
      <span class="s2">tls</span><span class="s4">.</span><span class="s2">queue</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createRecord</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
        <span class="s2">type</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ContentType</span><span class="s4">.</span><span class="s2">handshake</span><span class="s4">,</span>
        <span class="s2">data</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createClientHello</span><span class="s4">(</span><span class="s2">c</span><span class="s4">)</span>
      <span class="s4">}));</span>
      <span class="s2">tls</span><span class="s4">.</span><span class="s2">flush</span><span class="s4">(</span><span class="s2">c</span><span class="s4">);</span>
    <span class="s4">}</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Called when TLS protocol data has been received from somewhere and should</span>
   <span class="s0">* be processed by the TLS engine.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">data the TLS protocol data, as a string, to process.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@return </span><span class="s0">0 if the data could be processed, otherwise the number of bytes</span>
   <span class="s0">*         required for data to be processed.</span>
   <span class="s0">*/</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">process </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">data</span><span class="s4">) {</span>
    <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s7">0</span><span class="s4">;</span>

    <span class="s6">// buffer input data</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">data</span><span class="s4">) {</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">input</span><span class="s4">.</span><span class="s2">putBytes</span><span class="s4">(</span><span class="s2">data</span><span class="s4">);</span>
    <span class="s4">}</span>

    <span class="s6">// process next record if no failure, process will be called after</span>
    <span class="s6">// each record is handled (since handling can be asynchronous)</span>
    <span class="s3">if</span><span class="s4">(!</span><span class="s2">c</span><span class="s4">.</span><span class="s2">fail</span><span class="s4">) {</span>
      <span class="s6">// reset record if ready and now empty</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">record </span><span class="s4">!== </span><span class="s3">null </span><span class="s4">&amp;&amp;</span>
        <span class="s2">c</span><span class="s4">.</span><span class="s2">record</span><span class="s4">.</span><span class="s2">ready </span><span class="s4">&amp;&amp; </span><span class="s2">c</span><span class="s4">.</span><span class="s2">record</span><span class="s4">.</span><span class="s2">fragment</span><span class="s4">.</span><span class="s2">isEmpty</span><span class="s4">()) {</span>
        <span class="s2">c</span><span class="s4">.</span><span class="s2">record </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
      <span class="s4">}</span>

      <span class="s6">// if there is no pending record, try to read record header</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">record </span><span class="s4">=== </span><span class="s3">null</span><span class="s4">) {</span>
        <span class="s2">rval </span><span class="s4">= </span><span class="s2">_readRecordHeader</span><span class="s4">(</span><span class="s2">c</span><span class="s4">);</span>
      <span class="s4">}</span>

      <span class="s6">// read the next record (if record not yet ready)</span>
      <span class="s3">if</span><span class="s4">(!</span><span class="s2">c</span><span class="s4">.</span><span class="s2">fail </span><span class="s4">&amp;&amp; </span><span class="s2">c</span><span class="s4">.</span><span class="s2">record </span><span class="s4">!== </span><span class="s3">null </span><span class="s4">&amp;&amp; !</span><span class="s2">c</span><span class="s4">.</span><span class="s2">record</span><span class="s4">.</span><span class="s2">ready</span><span class="s4">) {</span>
        <span class="s2">rval </span><span class="s4">= </span><span class="s2">_readRecord</span><span class="s4">(</span><span class="s2">c</span><span class="s4">);</span>
      <span class="s4">}</span>

      <span class="s6">// record ready to be handled, update engine state</span>
      <span class="s3">if</span><span class="s4">(!</span><span class="s2">c</span><span class="s4">.</span><span class="s2">fail </span><span class="s4">&amp;&amp; </span><span class="s2">c</span><span class="s4">.</span><span class="s2">record </span><span class="s4">!== </span><span class="s3">null </span><span class="s4">&amp;&amp; </span><span class="s2">c</span><span class="s4">.</span><span class="s2">record</span><span class="s4">.</span><span class="s2">ready</span><span class="s4">) {</span>
        <span class="s2">_update</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">c</span><span class="s4">.</span><span class="s2">record</span><span class="s4">);</span>
      <span class="s4">}</span>
    <span class="s4">}</span>

    <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Requests that application data be packaged into a TLS record. The</span>
   <span class="s0">* tlsDataReady handler will be called when the TLS record(s) have been</span>
   <span class="s0">* prepared.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">data the application data, as a raw 'binary' encoded string, to</span>
   <span class="s0">*          be sent; to send utf-16/utf-8 string data, use the return value</span>
   <span class="s0">*          of util.encodeUtf8(str).</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@return </span><span class="s0">true on success, false on failure.</span>
   <span class="s0">*/</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">prepare </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">data</span><span class="s4">) {</span>
    <span class="s2">tls</span><span class="s4">.</span><span class="s2">queue</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createRecord</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ContentType</span><span class="s4">.</span><span class="s2">application_data</span><span class="s4">,</span>
      <span class="s2">data</span><span class="s4">: </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">(</span><span class="s2">data</span><span class="s4">)</span>
    <span class="s4">}));</span>
    <span class="s3">return </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">flush</span><span class="s4">(</span><span class="s2">c</span><span class="s4">);</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Requests that a heartbeat request be packaged into a TLS record for</span>
   <span class="s0">* transmission. The tlsDataReady handler will be called when TLS record(s)</span>
   <span class="s0">* have been prepared.</span>
   <span class="s0">*</span>
   <span class="s0">* When a heartbeat response has been received, the heartbeatReceived</span>
   <span class="s0">* handler will be called with the matching payload. This handler can</span>
   <span class="s0">* be used to clear a retransmission timer, etc.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">payload the heartbeat data to send as the payload in the message.</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">[payloadLength] the payload length to use, defaults to the</span>
   <span class="s0">*          actual payload length.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@return </span><span class="s0">true on success, false on failure.</span>
   <span class="s0">*/</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">prepareHeartbeatRequest </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">payload</span><span class="s4">, </span><span class="s2">payloadLength</span><span class="s4">) {</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">payload </span><span class="s3">instanceof </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">ByteBuffer</span><span class="s4">) {</span>
      <span class="s2">payload </span><span class="s4">= </span><span class="s2">payload</span><span class="s4">.</span><span class="s2">bytes</span><span class="s4">();</span>
    <span class="s4">}</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s3">typeof </span><span class="s2">payloadLength </span><span class="s4">=== </span><span class="s5">'undefined'</span><span class="s4">) {</span>
      <span class="s2">payloadLength </span><span class="s4">= </span><span class="s2">payload</span><span class="s4">.</span><span class="s2">length</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">expectedHeartbeatPayload </span><span class="s4">= </span><span class="s2">payload</span><span class="s4">;</span>
    <span class="s2">tls</span><span class="s4">.</span><span class="s2">queue</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createRecord</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
      <span class="s2">type</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">ContentType</span><span class="s4">.</span><span class="s2">heartbeat</span><span class="s4">,</span>
      <span class="s2">data</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createHeartbeat</span><span class="s4">(</span>
        <span class="s2">tls</span><span class="s4">.</span><span class="s2">HeartbeatMessageType</span><span class="s4">.</span><span class="s2">heartbeat_request</span><span class="s4">, </span><span class="s2">payload</span><span class="s4">, </span><span class="s2">payloadLength</span><span class="s4">)</span>
    <span class="s4">}));</span>
    <span class="s3">return </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">flush</span><span class="s4">(</span><span class="s2">c</span><span class="s4">);</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Closes the connection (sends a close_notify alert).</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">clearFail true to clear the fail flag (default: true).</span>
   <span class="s0">*/</span>
  <span class="s2">c</span><span class="s4">.</span><span class="s2">close </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">clearFail</span><span class="s4">) {</span>
    <span class="s6">// save session if connection didn't fail</span>
    <span class="s3">if</span><span class="s4">(!</span><span class="s2">c</span><span class="s4">.</span><span class="s2">fail </span><span class="s4">&amp;&amp; </span><span class="s2">c</span><span class="s4">.</span><span class="s2">sessionCache </span><span class="s4">&amp;&amp; </span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">) {</span>
      <span class="s6">// only need to preserve session ID, version, and security params</span>
      <span class="s3">var </span><span class="s2">session </span><span class="s4">= {</span>
        <span class="s2">id</span><span class="s4">: </span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">id</span><span class="s4">,</span>
        <span class="s2">version</span><span class="s4">: </span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">version</span><span class="s4">,</span>
        <span class="s2">sp</span><span class="s4">: </span><span class="s2">c</span><span class="s4">.</span><span class="s2">session</span><span class="s4">.</span><span class="s2">sp</span>
      <span class="s4">};</span>
      <span class="s2">session</span><span class="s4">.</span><span class="s2">sp</span><span class="s4">.</span><span class="s2">keys </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">sessionCache</span><span class="s4">.</span><span class="s2">setSession</span><span class="s4">(</span><span class="s2">session</span><span class="s4">.</span><span class="s2">id</span><span class="s4">, </span><span class="s2">session</span><span class="s4">);</span>
    <span class="s4">}</span>

    <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">open</span><span class="s4">) {</span>
      <span class="s6">// connection no longer open, clear input</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">open </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">input</span><span class="s4">.</span><span class="s2">clear</span><span class="s4">();</span>

      <span class="s6">// if connected or handshaking, send an alert</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">c</span><span class="s4">.</span><span class="s2">isConnected </span><span class="s4">|| </span><span class="s2">c</span><span class="s4">.</span><span class="s2">handshaking</span><span class="s4">) {</span>
        <span class="s2">c</span><span class="s4">.</span><span class="s2">isConnected </span><span class="s4">= </span><span class="s2">c</span><span class="s4">.</span><span class="s2">handshaking </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>

        <span class="s6">// send close_notify alert</span>
        <span class="s2">tls</span><span class="s4">.</span><span class="s2">queue</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createAlert</span><span class="s4">(</span><span class="s2">c</span><span class="s4">, {</span>
          <span class="s2">level</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Level</span><span class="s4">.</span><span class="s2">warning</span><span class="s4">,</span>
          <span class="s2">description</span><span class="s4">: </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">Alert</span><span class="s4">.</span><span class="s2">Description</span><span class="s4">.</span><span class="s2">close_notify</span>
        <span class="s4">}));</span>
        <span class="s2">tls</span><span class="s4">.</span><span class="s2">flush</span><span class="s4">(</span><span class="s2">c</span><span class="s4">);</span>
      <span class="s4">}</span>

      <span class="s6">// call handler</span>
      <span class="s2">c</span><span class="s4">.</span><span class="s2">closed</span><span class="s4">(</span><span class="s2">c</span><span class="s4">);</span>
    <span class="s4">}</span>

    <span class="s6">// reset TLS connection, do not clear fail flag</span>
    <span class="s2">c</span><span class="s4">.</span><span class="s2">reset</span><span class="s4">(</span><span class="s2">clearFail</span><span class="s4">);</span>
  <span class="s4">};</span>

  <span class="s3">return </span><span class="s2">c</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s6">/* TLS API */</span>
<span class="s2">module</span><span class="s4">.</span><span class="s2">exports </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">tls </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">tls </span><span class="s4">|| {};</span>

<span class="s6">// expose non-functions</span>
<span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">key </span><span class="s3">in </span><span class="s2">tls</span><span class="s4">) {</span>
  <span class="s3">if</span><span class="s4">(</span><span class="s3">typeof </span><span class="s2">tls</span><span class="s4">[</span><span class="s2">key</span><span class="s4">] !== </span><span class="s5">'function'</span><span class="s4">) {</span>
    <span class="s2">forge</span><span class="s4">.</span><span class="s2">tls</span><span class="s4">[</span><span class="s2">key</span><span class="s4">] = </span><span class="s2">tls</span><span class="s4">[</span><span class="s2">key</span><span class="s4">];</span>
  <span class="s4">}</span>
<span class="s4">}</span>

<span class="s6">// expose prf_tls1 for testing</span>
<span class="s2">forge</span><span class="s4">.</span><span class="s2">tls</span><span class="s4">.</span><span class="s2">prf_tls1 </span><span class="s4">= </span><span class="s2">prf_TLS1</span><span class="s4">;</span>

<span class="s6">// expose sha1 hmac method</span>
<span class="s2">forge</span><span class="s4">.</span><span class="s2">tls</span><span class="s4">.</span><span class="s2">hmac_sha1 </span><span class="s4">= </span><span class="s2">hmac_sha1</span><span class="s4">;</span>

<span class="s6">// expose session cache creation</span>
<span class="s2">forge</span><span class="s4">.</span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createSessionCache </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createSessionCache</span><span class="s4">;</span>

<span class="s0">/**</span>
 <span class="s0">* Creates a new TLS connection. This does not make any assumptions about the</span>
 <span class="s0">* transport layer that TLS is working on top of, ie: it does not assume there</span>
 <span class="s0">* is a TCP/IP connection or establish one. A TLS connection is totally</span>
 <span class="s0">* abstracted away from the layer is runs on top of, it merely establishes a</span>
 <span class="s0">* secure channel between a client&quot; and a &quot;server&quot;.</span>
 <span class="s0">*</span>
 <span class="s0">* A TLS connection contains 4 connection states: pending read and write, and</span>
 <span class="s0">* current read and write.</span>
 <span class="s0">*</span>
 <span class="s0">* At initialization, the current read and write states will be null. Only once</span>
 <span class="s0">* the security parameters have been set and the keys have been generated can</span>
 <span class="s0">* the pending states be converted into current states. Current states will be</span>
 <span class="s0">* updated for each record processed.</span>
 <span class="s0">*</span>
 <span class="s0">* A custom certificate verify callback may be provided to check information</span>
 <span class="s0">* like the common name on the server's certificate. It will be called for</span>
 <span class="s0">* every certificate in the chain. It has the following signature:</span>
 <span class="s0">*</span>
 <span class="s0">* variable func(c, certs, index, preVerify)</span>
 <span class="s0">* Where:</span>
 <span class="s0">* c         The TLS connection</span>
 <span class="s0">* verified  Set to true if certificate was verified, otherwise the alert</span>
 <span class="s0">*           tls.Alert.Description for why the certificate failed.</span>
 <span class="s0">* depth     The current index in the chain, where 0 is the server's cert.</span>
 <span class="s0">* certs     The certificate chain, *NOTE* if the server was anonymous then</span>
 <span class="s0">*           the chain will be empty.</span>
 <span class="s0">*</span>
 <span class="s0">* The function returns true on success and on failure either the appropriate</span>
 <span class="s0">* tls.Alert.Description or an object with 'alert' set to the appropriate</span>
 <span class="s0">* tls.Alert.Description and 'message' set to a custom error message. If true</span>
 <span class="s0">* is not returned then the connection will abort using, in order of</span>
 <span class="s0">* availability, first the returned alert description, second the preVerify</span>
 <span class="s0">* alert description, and lastly the default 'bad_certificate'.</span>
 <span class="s0">*</span>
 <span class="s0">* There are three callbacks that can be used to make use of client-side</span>
 <span class="s0">* certificates where each takes the TLS connection as the first parameter:</span>
 <span class="s0">*</span>
 <span class="s0">* getCertificate(conn, hint)</span>
 <span class="s0">*   The second parameter is a hint as to which certificate should be</span>
 <span class="s0">*   returned. If the connection entity is a client, then the hint will be</span>
 <span class="s0">*   the CertificateRequest message from the server that is part of the</span>
 <span class="s0">*   TLS protocol. If the connection entity is a server, then it will be</span>
 <span class="s0">*   the servername list provided via an SNI extension the ClientHello, if</span>
 <span class="s0">*   one was provided (empty array if not). The hint can be examined to</span>
 <span class="s0">*   determine which certificate to use (advanced). Most implementations</span>
 <span class="s0">*   will just return a certificate. The return value must be a</span>
 <span class="s0">*   PEM-formatted certificate or an array of PEM-formatted certificates</span>
 <span class="s0">*   that constitute a certificate chain, with the first in the array/chain</span>
 <span class="s0">*   being the client's certificate.</span>
 <span class="s0">* getPrivateKey(conn, certificate)</span>
 <span class="s0">*   The second parameter is an forge.pki X.509 certificate object that</span>
 <span class="s0">*   is associated with the requested private key. The return value must</span>
 <span class="s0">*   be a PEM-formatted private key.</span>
 <span class="s0">* getSignature(conn, bytes, callback)</span>
 <span class="s0">*   This callback can be used instead of getPrivateKey if the private key</span>
 <span class="s0">*   is not directly accessible in javascript or should not be. For</span>
 <span class="s0">*   instance, a secure external web service could provide the signature</span>
 <span class="s0">*   in exchange for appropriate credentials. The second parameter is a</span>
 <span class="s0">*   string of bytes to be signed that are part of the TLS protocol. These</span>
 <span class="s0">*   bytes are used to verify that the private key for the previously</span>
 <span class="s0">*   provided client-side certificate is accessible to the client. The</span>
 <span class="s0">*   callback is a function that takes 2 parameters, the TLS connection</span>
 <span class="s0">*   and the RSA encrypted (signed) bytes as a string. This callback must</span>
 <span class="s0">*   be called once the signature is ready.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">options the options for this connection:</span>
 <span class="s0">*   server: true if the connection is server-side, false for client.</span>
 <span class="s0">*   sessionId: a session ID to reuse, null for a new connection.</span>
 <span class="s0">*   caStore: an array of certificates to trust.</span>
 <span class="s0">*   sessionCache: a session cache to use.</span>
 <span class="s0">*   cipherSuites: an optional array of cipher suites to use,</span>
 <span class="s0">*     see tls.CipherSuites.</span>
 <span class="s0">*   connected: function(conn) called when the first handshake completes.</span>
 <span class="s0">*   virtualHost: the virtual server name to use in a TLS SNI extension.</span>
 <span class="s0">*   verifyClient: true to require a client certificate in server mode,</span>
 <span class="s0">*     'optional' to request one, false not to (default: false).</span>
 <span class="s0">*   verify: a handler used to custom verify certificates in the chain.</span>
 <span class="s0">*   verifyOptions: an object with options for the certificate chain validation.</span>
 <span class="s0">*     See documentation of pki.verifyCertificateChain for possible options.</span>
 <span class="s0">*     verifyOptions.verify is ignored. If you wish to specify a verify handler</span>
 <span class="s0">*     use the verify key.</span>
 <span class="s0">*   getCertificate: an optional callback used to get a certificate or</span>
 <span class="s0">*     a chain of certificates (as an array).</span>
 <span class="s0">*   getPrivateKey: an optional callback used to get a private key.</span>
 <span class="s0">*   getSignature: an optional callback used to get a signature.</span>
 <span class="s0">*   tlsDataReady: function(conn) called when TLS protocol data has been</span>
 <span class="s0">*     prepared and is ready to be used (typically sent over a socket</span>
 <span class="s0">*     connection to its destination), read from conn.tlsData buffer.</span>
 <span class="s0">*   dataReady: function(conn) called when application data has</span>
 <span class="s0">*     been parsed from a TLS record and should be consumed by the</span>
 <span class="s0">*     application, read from conn.data buffer.</span>
 <span class="s0">*   closed: function(conn) called when the connection has been closed.</span>
 <span class="s0">*   error: function(conn, error) called when there was an error.</span>
 <span class="s0">*   deflate: function(inBytes) if provided, will deflate TLS records using</span>
 <span class="s0">*     the deflate algorithm if the server supports it.</span>
 <span class="s0">*   inflate: function(inBytes) if provided, will inflate TLS records using</span>
 <span class="s0">*     the deflate algorithm if the server supports it.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">the new TLS connection.</span>
 <span class="s0">*/</span>
<span class="s2">forge</span><span class="s4">.</span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createConnection </span><span class="s4">= </span><span class="s2">tls</span><span class="s4">.</span><span class="s2">createConnection</span><span class="s4">;</span>
</pre>
</body>
</html>