<html>
<head>
<title>sha512.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #67a37c; font-style: italic;}
.s2 { color: #bcbec4;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #7a7e85;}
.s7 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
sha512.js</font>
</center></td></tr></table>
<pre><span class="s0">/**</span>
 <span class="s0">* Secure Hash Algorithm with a 1024-bit block size implementation.</span>
 <span class="s0">*</span>
 <span class="s0">* This includes: SHA-512, SHA-384, SHA-512/224, and SHA-512/256. For</span>
 <span class="s0">* SHA-256 (block size 512 bits), see sha256.js.</span>
 <span class="s0">*</span>
 <span class="s0">* See FIPS 180-4 for details.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@author </span><span class="s0">Dave Longley</span>
 <span class="s0">*</span>
 <span class="s0">* Copyright (c) 2014-2015 Digital Bazaar, Inc.</span>
 <span class="s0">*/</span>
<span class="s3">var </span><span class="s2">forge </span><span class="s4">= </span><span class="s2">require</span><span class="s4">(</span><span class="s5">'./forge'</span><span class="s4">);</span>
<span class="s2">require</span><span class="s4">(</span><span class="s5">'./md'</span><span class="s4">);</span>
<span class="s2">require</span><span class="s4">(</span><span class="s5">'./util'</span><span class="s4">);</span>

<span class="s3">var </span><span class="s2">sha512 </span><span class="s4">= </span><span class="s2">module</span><span class="s4">.</span><span class="s2">exports </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">sha512 </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">sha512 </span><span class="s4">|| {};</span>

<span class="s6">// SHA-512</span>
<span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">sha512 </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">algorithms</span><span class="s4">.</span><span class="s2">sha512 </span><span class="s4">= </span><span class="s2">sha512</span><span class="s4">;</span>

<span class="s6">// SHA-384</span>
<span class="s3">var </span><span class="s2">sha384 </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">sha384 </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">sha512</span><span class="s4">.</span><span class="s2">sha384 </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">sha512</span><span class="s4">.</span><span class="s2">sha384 </span><span class="s4">|| {};</span>
<span class="s2">sha384</span><span class="s4">.</span><span class="s2">create </span><span class="s4">= </span><span class="s3">function</span><span class="s4">() {</span>
  <span class="s3">return </span><span class="s2">sha512</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s5">'SHA-384'</span><span class="s4">);</span>
<span class="s4">};</span>
<span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">sha384 </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">algorithms</span><span class="s4">.</span><span class="s2">sha384 </span><span class="s4">= </span><span class="s2">sha384</span><span class="s4">;</span>

<span class="s6">// SHA-512/256</span>
<span class="s2">forge</span><span class="s4">.</span><span class="s2">sha512</span><span class="s4">.</span><span class="s2">sha256 </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">sha512</span><span class="s4">.</span><span class="s2">sha256 </span><span class="s4">|| {</span>
  <span class="s2">create</span><span class="s4">: </span><span class="s3">function</span><span class="s4">() {</span>
    <span class="s3">return </span><span class="s2">sha512</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s5">'SHA-512/256'</span><span class="s4">);</span>
  <span class="s4">}</span>
<span class="s4">};</span>
<span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">[</span><span class="s5">'sha512/256'</span><span class="s4">] = </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">algorithms</span><span class="s4">[</span><span class="s5">'sha512/256'</span><span class="s4">] =</span>
  <span class="s2">forge</span><span class="s4">.</span><span class="s2">sha512</span><span class="s4">.</span><span class="s2">sha256</span><span class="s4">;</span>

<span class="s6">// SHA-512/224</span>
<span class="s2">forge</span><span class="s4">.</span><span class="s2">sha512</span><span class="s4">.</span><span class="s2">sha224 </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">sha512</span><span class="s4">.</span><span class="s2">sha224 </span><span class="s4">|| {</span>
  <span class="s2">create</span><span class="s4">: </span><span class="s3">function</span><span class="s4">() {</span>
    <span class="s3">return </span><span class="s2">sha512</span><span class="s4">.</span><span class="s2">create</span><span class="s4">(</span><span class="s5">'SHA-512/224'</span><span class="s4">);</span>
  <span class="s4">}</span>
<span class="s4">};</span>
<span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">[</span><span class="s5">'sha512/224'</span><span class="s4">] = </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">algorithms</span><span class="s4">[</span><span class="s5">'sha512/224'</span><span class="s4">] =</span>
  <span class="s2">forge</span><span class="s4">.</span><span class="s2">sha512</span><span class="s4">.</span><span class="s2">sha224</span><span class="s4">;</span>

<span class="s0">/**</span>
 <span class="s0">* Creates a SHA-2 message digest object.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">algorithm the algorithm to use (SHA-512, SHA-384, SHA-512/224,</span>
 <span class="s0">*          SHA-512/256).</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">a message digest object.</span>
 <span class="s0">*/</span>
<span class="s2">sha512</span><span class="s4">.</span><span class="s2">create </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">algorithm</span><span class="s4">) {</span>
  <span class="s6">// do initialization as necessary</span>
  <span class="s3">if</span><span class="s4">(!</span><span class="s2">_initialized</span><span class="s4">) {</span>
    <span class="s2">_init</span><span class="s4">();</span>
  <span class="s4">}</span>

  <span class="s3">if</span><span class="s4">(</span><span class="s3">typeof </span><span class="s2">algorithm </span><span class="s4">=== </span><span class="s5">'undefined'</span><span class="s4">) {</span>
    <span class="s2">algorithm </span><span class="s4">= </span><span class="s5">'SHA-512'</span><span class="s4">;</span>
  <span class="s4">}</span>

  <span class="s3">if</span><span class="s4">(!(</span><span class="s2">algorithm </span><span class="s3">in </span><span class="s2">_states</span><span class="s4">)) {</span>
    <span class="s3">throw new </span><span class="s2">Error</span><span class="s4">(</span><span class="s5">'Invalid SHA-512 algorithm: ' </span><span class="s4">+ </span><span class="s2">algorithm</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s6">// SHA-512 state contains eight 64-bit integers (each as two 32-bit ints)</span>
  <span class="s3">var </span><span class="s2">_state </span><span class="s4">= </span><span class="s2">_states</span><span class="s4">[</span><span class="s2">algorithm</span><span class="s4">];</span>
  <span class="s3">var </span><span class="s2">_h </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>

  <span class="s6">// input buffer</span>
  <span class="s3">var </span><span class="s2">_input </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>

  <span class="s6">// used for 64-bit word storage</span>
  <span class="s3">var </span><span class="s2">_w </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Array</span><span class="s4">(</span><span class="s7">80</span><span class="s4">);</span>
  <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">wi </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">wi </span><span class="s4">&lt; </span><span class="s7">80</span><span class="s4">; ++</span><span class="s2">wi</span><span class="s4">) {</span>
    <span class="s2">_w</span><span class="s4">[</span><span class="s2">wi</span><span class="s4">] = </span><span class="s3">new </span><span class="s2">Array</span><span class="s4">(</span><span class="s7">2</span><span class="s4">);</span>
  <span class="s4">}</span>

  <span class="s6">// determine digest length by algorithm name (default)</span>
  <span class="s3">var </span><span class="s2">digestLength </span><span class="s4">= </span><span class="s7">64</span><span class="s4">;</span>
  <span class="s3">switch</span><span class="s4">(</span><span class="s2">algorithm</span><span class="s4">) {</span>
    <span class="s3">case </span><span class="s5">'SHA-384'</span><span class="s4">:</span>
      <span class="s2">digestLength </span><span class="s4">= </span><span class="s7">48</span><span class="s4">;</span>
      <span class="s3">break</span><span class="s4">;</span>
    <span class="s3">case </span><span class="s5">'SHA-512/256'</span><span class="s4">:</span>
      <span class="s2">digestLength </span><span class="s4">= </span><span class="s7">32</span><span class="s4">;</span>
      <span class="s3">break</span><span class="s4">;</span>
    <span class="s3">case </span><span class="s5">'SHA-512/224'</span><span class="s4">:</span>
      <span class="s2">digestLength </span><span class="s4">= </span><span class="s7">28</span><span class="s4">;</span>
      <span class="s3">break</span><span class="s4">;</span>
  <span class="s4">}</span>

  <span class="s6">// message digest object</span>
  <span class="s3">var </span><span class="s2">md </span><span class="s4">= {</span>
    <span class="s6">// SHA-512 =&gt; sha512</span>
    <span class="s2">algorithm</span><span class="s4">: </span><span class="s2">algorithm</span><span class="s4">.</span><span class="s2">replace</span><span class="s4">(</span><span class="s5">'-'</span><span class="s4">, </span><span class="s5">''</span><span class="s4">).</span><span class="s2">toLowerCase</span><span class="s4">(),</span>
    <span class="s2">blockLength</span><span class="s4">: </span><span class="s7">128</span><span class="s4">,</span>
    <span class="s2">digestLength</span><span class="s4">: </span><span class="s2">digestLength</span><span class="s4">,</span>
    <span class="s6">// 56-bit length of message so far (does not including padding)</span>
    <span class="s2">messageLength</span><span class="s4">: </span><span class="s7">0</span><span class="s4">,</span>
    <span class="s6">// true message length</span>
    <span class="s2">fullMessageLength</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
    <span class="s6">// size of message length in bytes</span>
    <span class="s2">messageLengthSize</span><span class="s4">: </span><span class="s7">16</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Starts the digest.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@return </span><span class="s0">this digest object.</span>
   <span class="s0">*/</span>
  <span class="s2">md</span><span class="s4">.</span><span class="s2">start </span><span class="s4">= </span><span class="s3">function</span><span class="s4">() {</span>
    <span class="s6">// up to 56-bit message length for convenience</span>
    <span class="s2">md</span><span class="s4">.</span><span class="s2">messageLength </span><span class="s4">= </span><span class="s7">0</span><span class="s4">;</span>

    <span class="s6">// full message length (set md.messageLength128 for backwards-compatibility)</span>
    <span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength </span><span class="s4">= </span><span class="s2">md</span><span class="s4">.</span><span class="s2">messageLength128 </span><span class="s4">= [];</span>
    <span class="s3">var </span><span class="s2">int32s </span><span class="s4">= </span><span class="s2">md</span><span class="s4">.</span><span class="s2">messageLengthSize </span><span class="s4">/ </span><span class="s7">4</span><span class="s4">;</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">int32s</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s7">0</span><span class="s4">);</span>
    <span class="s4">}</span>
    <span class="s2">_input </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
    <span class="s2">_h </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Array</span><span class="s4">(</span><span class="s2">_state</span><span class="s4">.</span><span class="s2">length</span><span class="s4">);</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">_state</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s2">_h</span><span class="s4">[</span><span class="s2">i</span><span class="s4">] = </span><span class="s2">_state</span><span class="s4">[</span><span class="s2">i</span><span class="s4">].</span><span class="s2">slice</span><span class="s4">(</span><span class="s7">0</span><span class="s4">);</span>
    <span class="s4">}</span>
    <span class="s3">return </span><span class="s2">md</span><span class="s4">;</span>
  <span class="s4">};</span>
  <span class="s6">// start digest automatically for first time</span>
  <span class="s2">md</span><span class="s4">.</span><span class="s2">start</span><span class="s4">();</span>

  <span class="s0">/**</span>
   <span class="s0">* Updates the digest with the given message input. The given input can</span>
   <span class="s0">* treated as raw input (no encoding will be applied) or an encoding of</span>
   <span class="s0">* 'utf8' maybe given to encode the input using UTF-8.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">msg the message input to update with.</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">encoding the encoding to use (default: 'raw', other: 'utf8').</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@return </span><span class="s0">this digest object.</span>
   <span class="s0">*/</span>
  <span class="s2">md</span><span class="s4">.</span><span class="s2">update </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">, </span><span class="s2">encoding</span><span class="s4">) {</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">encoding </span><span class="s4">=== </span><span class="s5">'utf8'</span><span class="s4">) {</span>
      <span class="s2">msg </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">encodeUtf8</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">);</span>
    <span class="s4">}</span>

    <span class="s6">// update message length</span>
    <span class="s3">var </span><span class="s2">len </span><span class="s4">= </span><span class="s2">msg</span><span class="s4">.</span><span class="s2">length</span><span class="s4">;</span>
    <span class="s2">md</span><span class="s4">.</span><span class="s2">messageLength </span><span class="s4">+= </span><span class="s2">len</span><span class="s4">;</span>
    <span class="s2">len </span><span class="s4">= [(</span><span class="s2">len </span><span class="s4">/ </span><span class="s7">0x100000000</span><span class="s4">) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">, </span><span class="s2">len </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">];</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">.</span><span class="s2">length </span><span class="s4">- </span><span class="s7">1</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&gt;= </span><span class="s7">0</span><span class="s4">; --</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">[</span><span class="s2">i</span><span class="s4">] += </span><span class="s2">len</span><span class="s4">[</span><span class="s7">1</span><span class="s4">];</span>
      <span class="s2">len</span><span class="s4">[</span><span class="s7">1</span><span class="s4">] = </span><span class="s2">len</span><span class="s4">[</span><span class="s7">0</span><span class="s4">] + ((</span><span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">[</span><span class="s2">i</span><span class="s4">] / </span><span class="s7">0x100000000</span><span class="s4">) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">);</span>
      <span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">[</span><span class="s2">i</span><span class="s4">] = </span><span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">[</span><span class="s2">i</span><span class="s4">] &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
      <span class="s2">len</span><span class="s4">[</span><span class="s7">0</span><span class="s4">] = ((</span><span class="s2">len</span><span class="s4">[</span><span class="s7">1</span><span class="s4">] / </span><span class="s7">0x100000000</span><span class="s4">) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">);</span>
    <span class="s4">}</span>

    <span class="s6">// add bytes to input buffer</span>
    <span class="s2">_input</span><span class="s4">.</span><span class="s2">putBytes</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">);</span>

    <span class="s6">// process bytes</span>
    <span class="s2">_update</span><span class="s4">(</span><span class="s2">_h</span><span class="s4">, </span><span class="s2">_w</span><span class="s4">, </span><span class="s2">_input</span><span class="s4">);</span>

    <span class="s6">// compact input buffer every 2K or if empty</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">_input</span><span class="s4">.</span><span class="s2">read </span><span class="s4">&gt; </span><span class="s7">2048 </span><span class="s4">|| </span><span class="s2">_input</span><span class="s4">.</span><span class="s2">length</span><span class="s4">() === </span><span class="s7">0</span><span class="s4">) {</span>
      <span class="s2">_input</span><span class="s4">.</span><span class="s2">compact</span><span class="s4">();</span>
    <span class="s4">}</span>

    <span class="s3">return </span><span class="s2">md</span><span class="s4">;</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Produces the digest.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@return </span><span class="s0">a byte buffer containing the digest value.</span>
   <span class="s0">*/</span>
  <span class="s2">md</span><span class="s4">.</span><span class="s2">digest </span><span class="s4">= </span><span class="s3">function</span><span class="s4">() {</span>
    <span class="s6">/* Note: Here we copy the remaining bytes in the input buffer and 
    add the appropriate SHA-512 padding. Then we do the final update 
    on a copy of the state so that if the user wants to get 
    intermediate digests they can do so. */</span>

    <span class="s6">/* Determine the number of bytes that must be added to the message 
    to ensure its length is congruent to 896 mod 1024. In other words, 
    the data to be digested must be a multiple of 1024 bits (or 128 bytes). 
    This data includes the message, some padding, and the length of the 
    message. Since the length of the message will be encoded as 16 bytes (128 
    bits), that means that the last segment of the data must have 112 bytes 
    (896 bits) of message and padding. Therefore, the length of the message 
    plus the padding must be congruent to 896 mod 1024 because 
    1024 - 128 = 896. 
 
    In order to fill up the message length it must be filled with 
    padding that begins with 1 bit followed by all 0 bits. Padding 
    must *always* be present, so if the message length is already 
    congruent to 896 mod 1024, then 1024 padding bits must be added. */</span>

    <span class="s3">var </span><span class="s2">finalBlock </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
    <span class="s2">finalBlock</span><span class="s4">.</span><span class="s2">putBytes</span><span class="s4">(</span><span class="s2">_input</span><span class="s4">.</span><span class="s2">bytes</span><span class="s4">());</span>

    <span class="s6">// compute remaining size to be digested (include message length size)</span>
    <span class="s3">var </span><span class="s2">remaining </span><span class="s4">= (</span>
      <span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">[</span><span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">.</span><span class="s2">length </span><span class="s4">- </span><span class="s7">1</span><span class="s4">] +</span>
      <span class="s2">md</span><span class="s4">.</span><span class="s2">messageLengthSize</span><span class="s4">);</span>

    <span class="s6">// add padding for overflow blockSize - overflow</span>
    <span class="s6">// _padding starts with 1 byte with first bit is set (byte value 128), then</span>
    <span class="s6">// there may be up to (blockSize - 1) other pad bytes</span>
    <span class="s3">var </span><span class="s2">overflow </span><span class="s4">= </span><span class="s2">remaining </span><span class="s4">&amp; (</span><span class="s2">md</span><span class="s4">.</span><span class="s2">blockLength </span><span class="s4">- </span><span class="s7">1</span><span class="s4">);</span>
    <span class="s2">finalBlock</span><span class="s4">.</span><span class="s2">putBytes</span><span class="s4">(</span><span class="s2">_padding</span><span class="s4">.</span><span class="s2">substr</span><span class="s4">(</span><span class="s7">0</span><span class="s4">, </span><span class="s2">md</span><span class="s4">.</span><span class="s2">blockLength </span><span class="s4">- </span><span class="s2">overflow</span><span class="s4">));</span>

    <span class="s6">// serialize message length in bits in big-endian order; since length</span>
    <span class="s6">// is stored in bytes we multiply by 8 and add carry from next int</span>
    <span class="s3">var </span><span class="s2">next</span><span class="s4">, </span><span class="s2">carry</span><span class="s4">;</span>
    <span class="s3">var </span><span class="s2">bits </span><span class="s4">= </span><span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">[</span><span class="s7">0</span><span class="s4">] * </span><span class="s7">8</span><span class="s4">;</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">.</span><span class="s2">length </span><span class="s4">- </span><span class="s7">1</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s2">next </span><span class="s4">= </span><span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">[</span><span class="s2">i </span><span class="s4">+ </span><span class="s7">1</span><span class="s4">] * </span><span class="s7">8</span><span class="s4">;</span>
      <span class="s2">carry </span><span class="s4">= (</span><span class="s2">next </span><span class="s4">/ </span><span class="s7">0x100000000</span><span class="s4">) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
      <span class="s2">bits </span><span class="s4">+= </span><span class="s2">carry</span><span class="s4">;</span>
      <span class="s2">finalBlock</span><span class="s4">.</span><span class="s2">putInt32</span><span class="s4">(</span><span class="s2">bits </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">);</span>
      <span class="s2">bits </span><span class="s4">= </span><span class="s2">next </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s2">finalBlock</span><span class="s4">.</span><span class="s2">putInt32</span><span class="s4">(</span><span class="s2">bits</span><span class="s4">);</span>

    <span class="s3">var </span><span class="s2">h </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Array</span><span class="s4">(</span><span class="s2">_h</span><span class="s4">.</span><span class="s2">length</span><span class="s4">);</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">_h</span><span class="s4">.</span><span class="s2">length</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s2">h</span><span class="s4">[</span><span class="s2">i</span><span class="s4">] = </span><span class="s2">_h</span><span class="s4">[</span><span class="s2">i</span><span class="s4">].</span><span class="s2">slice</span><span class="s4">(</span><span class="s7">0</span><span class="s4">);</span>
    <span class="s4">}</span>
    <span class="s2">_update</span><span class="s4">(</span><span class="s2">h</span><span class="s4">, </span><span class="s2">_w</span><span class="s4">, </span><span class="s2">finalBlock</span><span class="s4">);</span>
    <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
    <span class="s3">var </span><span class="s2">hlen</span><span class="s4">;</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">algorithm </span><span class="s4">=== </span><span class="s5">'SHA-512'</span><span class="s4">) {</span>
      <span class="s2">hlen </span><span class="s4">= </span><span class="s2">h</span><span class="s4">.</span><span class="s2">length</span><span class="s4">;</span>
    <span class="s4">} </span><span class="s3">else if</span><span class="s4">(</span><span class="s2">algorithm </span><span class="s4">=== </span><span class="s5">'SHA-384'</span><span class="s4">) {</span>
      <span class="s2">hlen </span><span class="s4">= </span><span class="s2">h</span><span class="s4">.</span><span class="s2">length </span><span class="s4">- </span><span class="s7">2</span><span class="s4">;</span>
    <span class="s4">} </span><span class="s3">else </span><span class="s4">{</span>
      <span class="s2">hlen </span><span class="s4">= </span><span class="s2">h</span><span class="s4">.</span><span class="s2">length </span><span class="s4">- </span><span class="s7">4</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">hlen</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt32</span><span class="s4">(</span><span class="s2">h</span><span class="s4">[</span><span class="s2">i</span><span class="s4">][</span><span class="s7">0</span><span class="s4">]);</span>
      <span class="s3">if</span><span class="s4">(</span><span class="s2">i </span><span class="s4">!== </span><span class="s2">hlen </span><span class="s4">- </span><span class="s7">1 </span><span class="s4">|| </span><span class="s2">algorithm </span><span class="s4">!== </span><span class="s5">'SHA-512/224'</span><span class="s4">) {</span>
        <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt32</span><span class="s4">(</span><span class="s2">h</span><span class="s4">[</span><span class="s2">i</span><span class="s4">][</span><span class="s7">1</span><span class="s4">]);</span>
      <span class="s4">}</span>
    <span class="s4">}</span>
    <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
  <span class="s4">};</span>

  <span class="s3">return </span><span class="s2">md</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s6">// sha-512 padding bytes not initialized yet</span>
<span class="s3">var </span><span class="s2">_padding </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">_initialized </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>

<span class="s6">// table of constants</span>
<span class="s3">var </span><span class="s2">_k </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>

<span class="s6">// initial hash states</span>
<span class="s3">var </span><span class="s2">_states </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>

<span class="s0">/**</span>
 <span class="s0">* Initializes the constant tables.</span>
 <span class="s0">*/</span>
<span class="s3">function </span><span class="s2">_init</span><span class="s4">() {</span>
  <span class="s6">// create padding</span>
  <span class="s2">_padding </span><span class="s4">= </span><span class="s2">String</span><span class="s4">.</span><span class="s2">fromCharCode</span><span class="s4">(</span><span class="s7">128</span><span class="s4">);</span>
  <span class="s2">_padding </span><span class="s4">+= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">fillString</span><span class="s4">(</span><span class="s2">String</span><span class="s4">.</span><span class="s2">fromCharCode</span><span class="s4">(</span><span class="s7">0x00</span><span class="s4">), </span><span class="s7">128</span><span class="s4">);</span>

  <span class="s6">// create K table for SHA-512</span>
  <span class="s2">_k </span><span class="s4">= [</span>
    <span class="s4">[</span><span class="s7">0x428a2f98</span><span class="s4">, </span><span class="s7">0xd728ae22</span><span class="s4">], [</span><span class="s7">0x71374491</span><span class="s4">, </span><span class="s7">0x23ef65cd</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0xb5c0fbcf</span><span class="s4">, </span><span class="s7">0xec4d3b2f</span><span class="s4">], [</span><span class="s7">0xe9b5dba5</span><span class="s4">, </span><span class="s7">0x8189dbbc</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x3956c25b</span><span class="s4">, </span><span class="s7">0xf348b538</span><span class="s4">], [</span><span class="s7">0x59f111f1</span><span class="s4">, </span><span class="s7">0xb605d019</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x923f82a4</span><span class="s4">, </span><span class="s7">0xaf194f9b</span><span class="s4">], [</span><span class="s7">0xab1c5ed5</span><span class="s4">, </span><span class="s7">0xda6d8118</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0xd807aa98</span><span class="s4">, </span><span class="s7">0xa3030242</span><span class="s4">], [</span><span class="s7">0x12835b01</span><span class="s4">, </span><span class="s7">0x45706fbe</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x243185be</span><span class="s4">, </span><span class="s7">0x4ee4b28c</span><span class="s4">], [</span><span class="s7">0x550c7dc3</span><span class="s4">, </span><span class="s7">0xd5ffb4e2</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x72be5d74</span><span class="s4">, </span><span class="s7">0xf27b896f</span><span class="s4">], [</span><span class="s7">0x80deb1fe</span><span class="s4">, </span><span class="s7">0x3b1696b1</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x9bdc06a7</span><span class="s4">, </span><span class="s7">0x25c71235</span><span class="s4">], [</span><span class="s7">0xc19bf174</span><span class="s4">, </span><span class="s7">0xcf692694</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0xe49b69c1</span><span class="s4">, </span><span class="s7">0x9ef14ad2</span><span class="s4">], [</span><span class="s7">0xefbe4786</span><span class="s4">, </span><span class="s7">0x384f25e3</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x0fc19dc6</span><span class="s4">, </span><span class="s7">0x8b8cd5b5</span><span class="s4">], [</span><span class="s7">0x240ca1cc</span><span class="s4">, </span><span class="s7">0x77ac9c65</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x2de92c6f</span><span class="s4">, </span><span class="s7">0x592b0275</span><span class="s4">], [</span><span class="s7">0x4a7484aa</span><span class="s4">, </span><span class="s7">0x6ea6e483</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x5cb0a9dc</span><span class="s4">, </span><span class="s7">0xbd41fbd4</span><span class="s4">], [</span><span class="s7">0x76f988da</span><span class="s4">, </span><span class="s7">0x831153b5</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x983e5152</span><span class="s4">, </span><span class="s7">0xee66dfab</span><span class="s4">], [</span><span class="s7">0xa831c66d</span><span class="s4">, </span><span class="s7">0x2db43210</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0xb00327c8</span><span class="s4">, </span><span class="s7">0x98fb213f</span><span class="s4">], [</span><span class="s7">0xbf597fc7</span><span class="s4">, </span><span class="s7">0xbeef0ee4</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0xc6e00bf3</span><span class="s4">, </span><span class="s7">0x3da88fc2</span><span class="s4">], [</span><span class="s7">0xd5a79147</span><span class="s4">, </span><span class="s7">0x930aa725</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x06ca6351</span><span class="s4">, </span><span class="s7">0xe003826f</span><span class="s4">], [</span><span class="s7">0x14292967</span><span class="s4">, </span><span class="s7">0x0a0e6e70</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x27b70a85</span><span class="s4">, </span><span class="s7">0x46d22ffc</span><span class="s4">], [</span><span class="s7">0x2e1b2138</span><span class="s4">, </span><span class="s7">0x5c26c926</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x4d2c6dfc</span><span class="s4">, </span><span class="s7">0x5ac42aed</span><span class="s4">], [</span><span class="s7">0x53380d13</span><span class="s4">, </span><span class="s7">0x9d95b3df</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x650a7354</span><span class="s4">, </span><span class="s7">0x8baf63de</span><span class="s4">], [</span><span class="s7">0x766a0abb</span><span class="s4">, </span><span class="s7">0x3c77b2a8</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x81c2c92e</span><span class="s4">, </span><span class="s7">0x47edaee6</span><span class="s4">], [</span><span class="s7">0x92722c85</span><span class="s4">, </span><span class="s7">0x1482353b</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0xa2bfe8a1</span><span class="s4">, </span><span class="s7">0x4cf10364</span><span class="s4">], [</span><span class="s7">0xa81a664b</span><span class="s4">, </span><span class="s7">0xbc423001</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0xc24b8b70</span><span class="s4">, </span><span class="s7">0xd0f89791</span><span class="s4">], [</span><span class="s7">0xc76c51a3</span><span class="s4">, </span><span class="s7">0x0654be30</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0xd192e819</span><span class="s4">, </span><span class="s7">0xd6ef5218</span><span class="s4">], [</span><span class="s7">0xd6990624</span><span class="s4">, </span><span class="s7">0x5565a910</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0xf40e3585</span><span class="s4">, </span><span class="s7">0x5771202a</span><span class="s4">], [</span><span class="s7">0x106aa070</span><span class="s4">, </span><span class="s7">0x32bbd1b8</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x19a4c116</span><span class="s4">, </span><span class="s7">0xb8d2d0c8</span><span class="s4">], [</span><span class="s7">0x1e376c08</span><span class="s4">, </span><span class="s7">0x5141ab53</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x2748774c</span><span class="s4">, </span><span class="s7">0xdf8eeb99</span><span class="s4">], [</span><span class="s7">0x34b0bcb5</span><span class="s4">, </span><span class="s7">0xe19b48a8</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x391c0cb3</span><span class="s4">, </span><span class="s7">0xc5c95a63</span><span class="s4">], [</span><span class="s7">0x4ed8aa4a</span><span class="s4">, </span><span class="s7">0xe3418acb</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x5b9cca4f</span><span class="s4">, </span><span class="s7">0x7763e373</span><span class="s4">], [</span><span class="s7">0x682e6ff3</span><span class="s4">, </span><span class="s7">0xd6b2b8a3</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x748f82ee</span><span class="s4">, </span><span class="s7">0x5defb2fc</span><span class="s4">], [</span><span class="s7">0x78a5636f</span><span class="s4">, </span><span class="s7">0x43172f60</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x84c87814</span><span class="s4">, </span><span class="s7">0xa1f0ab72</span><span class="s4">], [</span><span class="s7">0x8cc70208</span><span class="s4">, </span><span class="s7">0x1a6439ec</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x90befffa</span><span class="s4">, </span><span class="s7">0x23631e28</span><span class="s4">], [</span><span class="s7">0xa4506ceb</span><span class="s4">, </span><span class="s7">0xde82bde9</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0xbef9a3f7</span><span class="s4">, </span><span class="s7">0xb2c67915</span><span class="s4">], [</span><span class="s7">0xc67178f2</span><span class="s4">, </span><span class="s7">0xe372532b</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0xca273ece</span><span class="s4">, </span><span class="s7">0xea26619c</span><span class="s4">], [</span><span class="s7">0xd186b8c7</span><span class="s4">, </span><span class="s7">0x21c0c207</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0xeada7dd6</span><span class="s4">, </span><span class="s7">0xcde0eb1e</span><span class="s4">], [</span><span class="s7">0xf57d4f7f</span><span class="s4">, </span><span class="s7">0xee6ed178</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x06f067aa</span><span class="s4">, </span><span class="s7">0x72176fba</span><span class="s4">], [</span><span class="s7">0x0a637dc5</span><span class="s4">, </span><span class="s7">0xa2c898a6</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x113f9804</span><span class="s4">, </span><span class="s7">0xbef90dae</span><span class="s4">], [</span><span class="s7">0x1b710b35</span><span class="s4">, </span><span class="s7">0x131c471b</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x28db77f5</span><span class="s4">, </span><span class="s7">0x23047d84</span><span class="s4">], [</span><span class="s7">0x32caab7b</span><span class="s4">, </span><span class="s7">0x40c72493</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x3c9ebe0a</span><span class="s4">, </span><span class="s7">0x15c9bebc</span><span class="s4">], [</span><span class="s7">0x431d67c4</span><span class="s4">, </span><span class="s7">0x9c100d4c</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x4cc5d4be</span><span class="s4">, </span><span class="s7">0xcb3e42b6</span><span class="s4">], [</span><span class="s7">0x597f299c</span><span class="s4">, </span><span class="s7">0xfc657e2a</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x5fcb6fab</span><span class="s4">, </span><span class="s7">0x3ad6faec</span><span class="s4">], [</span><span class="s7">0x6c44198c</span><span class="s4">, </span><span class="s7">0x4a475817</span><span class="s4">]</span>
  <span class="s4">];</span>

  <span class="s6">// initial hash states</span>
  <span class="s2">_states </span><span class="s4">= {};</span>
  <span class="s2">_states</span><span class="s4">[</span><span class="s5">'SHA-512'</span><span class="s4">] = [</span>
    <span class="s4">[</span><span class="s7">0x6a09e667</span><span class="s4">, </span><span class="s7">0xf3bcc908</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0xbb67ae85</span><span class="s4">, </span><span class="s7">0x84caa73b</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x3c6ef372</span><span class="s4">, </span><span class="s7">0xfe94f82b</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0xa54ff53a</span><span class="s4">, </span><span class="s7">0x5f1d36f1</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x510e527f</span><span class="s4">, </span><span class="s7">0xade682d1</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x9b05688c</span><span class="s4">, </span><span class="s7">0x2b3e6c1f</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x1f83d9ab</span><span class="s4">, </span><span class="s7">0xfb41bd6b</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x5be0cd19</span><span class="s4">, </span><span class="s7">0x137e2179</span><span class="s4">]</span>
  <span class="s4">];</span>
  <span class="s2">_states</span><span class="s4">[</span><span class="s5">'SHA-384'</span><span class="s4">] = [</span>
    <span class="s4">[</span><span class="s7">0xcbbb9d5d</span><span class="s4">, </span><span class="s7">0xc1059ed8</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x629a292a</span><span class="s4">, </span><span class="s7">0x367cd507</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x9159015a</span><span class="s4">, </span><span class="s7">0x3070dd17</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x152fecd8</span><span class="s4">, </span><span class="s7">0xf70e5939</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x67332667</span><span class="s4">, </span><span class="s7">0xffc00b31</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x8eb44a87</span><span class="s4">, </span><span class="s7">0x68581511</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0xdb0c2e0d</span><span class="s4">, </span><span class="s7">0x64f98fa7</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x47b5481d</span><span class="s4">, </span><span class="s7">0xbefa4fa4</span><span class="s4">]</span>
  <span class="s4">];</span>
  <span class="s2">_states</span><span class="s4">[</span><span class="s5">'SHA-512/256'</span><span class="s4">] = [</span>
    <span class="s4">[</span><span class="s7">0x22312194</span><span class="s4">, </span><span class="s7">0xFC2BF72C</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x9F555FA3</span><span class="s4">, </span><span class="s7">0xC84C64C2</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x2393B86B</span><span class="s4">, </span><span class="s7">0x6F53B151</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x96387719</span><span class="s4">, </span><span class="s7">0x5940EABD</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x96283EE2</span><span class="s4">, </span><span class="s7">0xA88EFFE3</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0xBE5E1E25</span><span class="s4">, </span><span class="s7">0x53863992</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x2B0199FC</span><span class="s4">, </span><span class="s7">0x2C85B8AA</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x0EB72DDC</span><span class="s4">, </span><span class="s7">0x81C52CA2</span><span class="s4">]</span>
  <span class="s4">];</span>
  <span class="s2">_states</span><span class="s4">[</span><span class="s5">'SHA-512/224'</span><span class="s4">] = [</span>
    <span class="s4">[</span><span class="s7">0x8C3D37C8</span><span class="s4">, </span><span class="s7">0x19544DA2</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x73E19966</span><span class="s4">, </span><span class="s7">0x89DCD4D6</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x1DFAB7AE</span><span class="s4">, </span><span class="s7">0x32FF9C82</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x679DD514</span><span class="s4">, </span><span class="s7">0x582F9FCF</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x0F6D2B69</span><span class="s4">, </span><span class="s7">0x7BD44DA8</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x77E36F73</span><span class="s4">, </span><span class="s7">0x04C48942</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x3F9D85A8</span><span class="s4">, </span><span class="s7">0x6A1D36C8</span><span class="s4">],</span>
    <span class="s4">[</span><span class="s7">0x1112E6AD</span><span class="s4">, </span><span class="s7">0x91D692A1</span><span class="s4">]</span>
  <span class="s4">];</span>

  <span class="s6">// now initialized</span>
  <span class="s2">_initialized </span><span class="s4">= </span><span class="s3">true</span><span class="s4">;</span>
<span class="s4">}</span>

<span class="s0">/**</span>
 <span class="s0">* Updates a SHA-512 state with the given byte buffer.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">s the SHA-512 state to update.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">w the array to use to store words.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">bytes the byte buffer to update with.</span>
 <span class="s0">*/</span>
<span class="s3">function </span><span class="s2">_update</span><span class="s4">(</span><span class="s2">s</span><span class="s4">, </span><span class="s2">w</span><span class="s4">, </span><span class="s2">bytes</span><span class="s4">) {</span>
  <span class="s6">// consume 512 bit (128 byte) chunks</span>
  <span class="s3">var </span><span class="s2">t1_hi</span><span class="s4">, </span><span class="s2">t1_lo</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">t2_hi</span><span class="s4">, </span><span class="s2">t2_lo</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">s0_hi</span><span class="s4">, </span><span class="s2">s0_lo</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">s1_hi</span><span class="s4">, </span><span class="s2">s1_lo</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">ch_hi</span><span class="s4">, </span><span class="s2">ch_lo</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">maj_hi</span><span class="s4">, </span><span class="s2">maj_lo</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">a_hi</span><span class="s4">, </span><span class="s2">a_lo</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">b_hi</span><span class="s4">, </span><span class="s2">b_lo</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">c_hi</span><span class="s4">, </span><span class="s2">c_lo</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">d_hi</span><span class="s4">, </span><span class="s2">d_lo</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">e_hi</span><span class="s4">, </span><span class="s2">e_lo</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">f_hi</span><span class="s4">, </span><span class="s2">f_lo</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">g_hi</span><span class="s4">, </span><span class="s2">g_lo</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">h_hi</span><span class="s4">, </span><span class="s2">h_lo</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">i</span><span class="s4">, </span><span class="s2">hi</span><span class="s4">, </span><span class="s2">lo</span><span class="s4">, </span><span class="s2">w2</span><span class="s4">, </span><span class="s2">w7</span><span class="s4">, </span><span class="s2">w15</span><span class="s4">, </span><span class="s2">w16</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">len </span><span class="s4">= </span><span class="s2">bytes</span><span class="s4">.</span><span class="s2">length</span><span class="s4">();</span>
  <span class="s3">while</span><span class="s4">(</span><span class="s2">len </span><span class="s4">&gt;= </span><span class="s7">128</span><span class="s4">) {</span>
    <span class="s6">// the w array will be populated with sixteen 64-bit big-endian words</span>
    <span class="s6">// and then extended into 64 64-bit words according to SHA-512</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s7">16</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s2">w</span><span class="s4">[</span><span class="s2">i</span><span class="s4">][</span><span class="s7">0</span><span class="s4">] = </span><span class="s2">bytes</span><span class="s4">.</span><span class="s2">getInt32</span><span class="s4">() &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
      <span class="s2">w</span><span class="s4">[</span><span class="s2">i</span><span class="s4">][</span><span class="s7">1</span><span class="s4">] = </span><span class="s2">bytes</span><span class="s4">.</span><span class="s2">getInt32</span><span class="s4">() &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s3">for</span><span class="s4">(; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s7">80</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s6">// for word 2 words ago: ROTR 19(x) ^ ROTR 61(x) ^ SHR 6(x)</span>
      <span class="s2">w2 </span><span class="s4">= </span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">2</span><span class="s4">];</span>
      <span class="s2">hi </span><span class="s4">= </span><span class="s2">w2</span><span class="s4">[</span><span class="s7">0</span><span class="s4">];</span>
      <span class="s2">lo </span><span class="s4">= </span><span class="s2">w2</span><span class="s4">[</span><span class="s7">1</span><span class="s4">];</span>

      <span class="s6">// high bits</span>
      <span class="s2">t1_hi </span><span class="s4">= (</span>
        <span class="s4">((</span><span class="s2">hi </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">19</span><span class="s4">) | (</span><span class="s2">lo </span><span class="s4">&lt;&lt; </span><span class="s7">13</span><span class="s4">)) ^ </span><span class="s6">// ROTR 19</span>
        <span class="s4">((</span><span class="s2">lo </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">29</span><span class="s4">) | (</span><span class="s2">hi </span><span class="s4">&lt;&lt; </span><span class="s7">3</span><span class="s4">)) ^ </span><span class="s6">// ROTR 61/(swap + ROTR 29)</span>
        <span class="s4">(</span><span class="s2">hi </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">6</span><span class="s4">)) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">; </span><span class="s6">// SHR 6</span>
      <span class="s6">// low bits</span>
      <span class="s2">t1_lo </span><span class="s4">= (</span>
        <span class="s4">((</span><span class="s2">hi </span><span class="s4">&lt;&lt; </span><span class="s7">13</span><span class="s4">) | (</span><span class="s2">lo </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">19</span><span class="s4">)) ^ </span><span class="s6">// ROTR 19</span>
        <span class="s4">((</span><span class="s2">lo </span><span class="s4">&lt;&lt; </span><span class="s7">3</span><span class="s4">) | (</span><span class="s2">hi </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">29</span><span class="s4">)) ^ </span><span class="s6">// ROTR 61/(swap + ROTR 29)</span>
        <span class="s4">((</span><span class="s2">hi </span><span class="s4">&lt;&lt; </span><span class="s7">26</span><span class="s4">) | (</span><span class="s2">lo </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">6</span><span class="s4">))) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">; </span><span class="s6">// SHR 6</span>

      <span class="s6">// for word 15 words ago: ROTR 1(x) ^ ROTR 8(x) ^ SHR 7(x)</span>
      <span class="s2">w15 </span><span class="s4">= </span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">15</span><span class="s4">];</span>
      <span class="s2">hi </span><span class="s4">= </span><span class="s2">w15</span><span class="s4">[</span><span class="s7">0</span><span class="s4">];</span>
      <span class="s2">lo </span><span class="s4">= </span><span class="s2">w15</span><span class="s4">[</span><span class="s7">1</span><span class="s4">];</span>

      <span class="s6">// high bits</span>
      <span class="s2">t2_hi </span><span class="s4">= (</span>
        <span class="s4">((</span><span class="s2">hi </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">1</span><span class="s4">) | (</span><span class="s2">lo </span><span class="s4">&lt;&lt; </span><span class="s7">31</span><span class="s4">)) ^ </span><span class="s6">// ROTR 1</span>
        <span class="s4">((</span><span class="s2">hi </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">8</span><span class="s4">) | (</span><span class="s2">lo </span><span class="s4">&lt;&lt; </span><span class="s7">24</span><span class="s4">)) ^ </span><span class="s6">// ROTR 8</span>
        <span class="s4">(</span><span class="s2">hi </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">7</span><span class="s4">)) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">; </span><span class="s6">// SHR 7</span>
      <span class="s6">// low bits</span>
      <span class="s2">t2_lo </span><span class="s4">= (</span>
        <span class="s4">((</span><span class="s2">hi </span><span class="s4">&lt;&lt; </span><span class="s7">31</span><span class="s4">) | (</span><span class="s2">lo </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">1</span><span class="s4">)) ^ </span><span class="s6">// ROTR 1</span>
        <span class="s4">((</span><span class="s2">hi </span><span class="s4">&lt;&lt; </span><span class="s7">24</span><span class="s4">) | (</span><span class="s2">lo </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">8</span><span class="s4">)) ^ </span><span class="s6">// ROTR 8</span>
        <span class="s4">((</span><span class="s2">hi </span><span class="s4">&lt;&lt; </span><span class="s7">25</span><span class="s4">) | (</span><span class="s2">lo </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">7</span><span class="s4">))) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">; </span><span class="s6">// SHR 7</span>

      <span class="s6">// sum(t1, word 7 ago, t2, word 16 ago) modulo 2^64 (carry lo overflow)</span>
      <span class="s2">w7 </span><span class="s4">= </span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">7</span><span class="s4">];</span>
      <span class="s2">w16 </span><span class="s4">= </span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">16</span><span class="s4">];</span>
      <span class="s2">lo </span><span class="s4">= (</span><span class="s2">t1_lo </span><span class="s4">+ </span><span class="s2">w7</span><span class="s4">[</span><span class="s7">1</span><span class="s4">] + </span><span class="s2">t2_lo </span><span class="s4">+ </span><span class="s2">w16</span><span class="s4">[</span><span class="s7">1</span><span class="s4">]);</span>
      <span class="s2">w</span><span class="s4">[</span><span class="s2">i</span><span class="s4">][</span><span class="s7">0</span><span class="s4">] = (</span><span class="s2">t1_hi </span><span class="s4">+ </span><span class="s2">w7</span><span class="s4">[</span><span class="s7">0</span><span class="s4">] + </span><span class="s2">t2_hi </span><span class="s4">+ </span><span class="s2">w16</span><span class="s4">[</span><span class="s7">0</span><span class="s4">] +</span>
        <span class="s4">((</span><span class="s2">lo </span><span class="s4">/ </span><span class="s7">0x100000000</span><span class="s4">) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">)) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
      <span class="s2">w</span><span class="s4">[</span><span class="s2">i</span><span class="s4">][</span><span class="s7">1</span><span class="s4">] = </span><span class="s2">lo </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s4">}</span>

    <span class="s6">// initialize hash value for this chunk</span>
    <span class="s2">a_hi </span><span class="s4">= </span><span class="s2">s</span><span class="s4">[</span><span class="s7">0</span><span class="s4">][</span><span class="s7">0</span><span class="s4">];</span>
    <span class="s2">a_lo </span><span class="s4">= </span><span class="s2">s</span><span class="s4">[</span><span class="s7">0</span><span class="s4">][</span><span class="s7">1</span><span class="s4">];</span>
    <span class="s2">b_hi </span><span class="s4">= </span><span class="s2">s</span><span class="s4">[</span><span class="s7">1</span><span class="s4">][</span><span class="s7">0</span><span class="s4">];</span>
    <span class="s2">b_lo </span><span class="s4">= </span><span class="s2">s</span><span class="s4">[</span><span class="s7">1</span><span class="s4">][</span><span class="s7">1</span><span class="s4">];</span>
    <span class="s2">c_hi </span><span class="s4">= </span><span class="s2">s</span><span class="s4">[</span><span class="s7">2</span><span class="s4">][</span><span class="s7">0</span><span class="s4">];</span>
    <span class="s2">c_lo </span><span class="s4">= </span><span class="s2">s</span><span class="s4">[</span><span class="s7">2</span><span class="s4">][</span><span class="s7">1</span><span class="s4">];</span>
    <span class="s2">d_hi </span><span class="s4">= </span><span class="s2">s</span><span class="s4">[</span><span class="s7">3</span><span class="s4">][</span><span class="s7">0</span><span class="s4">];</span>
    <span class="s2">d_lo </span><span class="s4">= </span><span class="s2">s</span><span class="s4">[</span><span class="s7">3</span><span class="s4">][</span><span class="s7">1</span><span class="s4">];</span>
    <span class="s2">e_hi </span><span class="s4">= </span><span class="s2">s</span><span class="s4">[</span><span class="s7">4</span><span class="s4">][</span><span class="s7">0</span><span class="s4">];</span>
    <span class="s2">e_lo </span><span class="s4">= </span><span class="s2">s</span><span class="s4">[</span><span class="s7">4</span><span class="s4">][</span><span class="s7">1</span><span class="s4">];</span>
    <span class="s2">f_hi </span><span class="s4">= </span><span class="s2">s</span><span class="s4">[</span><span class="s7">5</span><span class="s4">][</span><span class="s7">0</span><span class="s4">];</span>
    <span class="s2">f_lo </span><span class="s4">= </span><span class="s2">s</span><span class="s4">[</span><span class="s7">5</span><span class="s4">][</span><span class="s7">1</span><span class="s4">];</span>
    <span class="s2">g_hi </span><span class="s4">= </span><span class="s2">s</span><span class="s4">[</span><span class="s7">6</span><span class="s4">][</span><span class="s7">0</span><span class="s4">];</span>
    <span class="s2">g_lo </span><span class="s4">= </span><span class="s2">s</span><span class="s4">[</span><span class="s7">6</span><span class="s4">][</span><span class="s7">1</span><span class="s4">];</span>
    <span class="s2">h_hi </span><span class="s4">= </span><span class="s2">s</span><span class="s4">[</span><span class="s7">7</span><span class="s4">][</span><span class="s7">0</span><span class="s4">];</span>
    <span class="s2">h_lo </span><span class="s4">= </span><span class="s2">s</span><span class="s4">[</span><span class="s7">7</span><span class="s4">][</span><span class="s7">1</span><span class="s4">];</span>

    <span class="s6">// round function</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s7">80</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s6">// Sum1(e) = ROTR 14(e) ^ ROTR 18(e) ^ ROTR 41(e)</span>
      <span class="s2">s1_hi </span><span class="s4">= (</span>
        <span class="s4">((</span><span class="s2">e_hi </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">14</span><span class="s4">) | (</span><span class="s2">e_lo </span><span class="s4">&lt;&lt; </span><span class="s7">18</span><span class="s4">)) ^ </span><span class="s6">// ROTR 14</span>
        <span class="s4">((</span><span class="s2">e_hi </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">18</span><span class="s4">) | (</span><span class="s2">e_lo </span><span class="s4">&lt;&lt; </span><span class="s7">14</span><span class="s4">)) ^ </span><span class="s6">// ROTR 18</span>
        <span class="s4">((</span><span class="s2">e_lo </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">9</span><span class="s4">) | (</span><span class="s2">e_hi </span><span class="s4">&lt;&lt; </span><span class="s7">23</span><span class="s4">))) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">; </span><span class="s6">// ROTR 41/(swap + ROTR 9)</span>
      <span class="s2">s1_lo </span><span class="s4">= (</span>
        <span class="s4">((</span><span class="s2">e_hi </span><span class="s4">&lt;&lt; </span><span class="s7">18</span><span class="s4">) | (</span><span class="s2">e_lo </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">14</span><span class="s4">)) ^ </span><span class="s6">// ROTR 14</span>
        <span class="s4">((</span><span class="s2">e_hi </span><span class="s4">&lt;&lt; </span><span class="s7">14</span><span class="s4">) | (</span><span class="s2">e_lo </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">18</span><span class="s4">)) ^ </span><span class="s6">// ROTR 18</span>
        <span class="s4">((</span><span class="s2">e_lo </span><span class="s4">&lt;&lt; </span><span class="s7">23</span><span class="s4">) | (</span><span class="s2">e_hi </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">9</span><span class="s4">))) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">; </span><span class="s6">// ROTR 41/(swap + ROTR 9)</span>

      <span class="s6">// Ch(e, f, g) (optimized the same way as SHA-1)</span>
      <span class="s2">ch_hi </span><span class="s4">= (</span><span class="s2">g_hi </span><span class="s4">^ (</span><span class="s2">e_hi </span><span class="s4">&amp; (</span><span class="s2">f_hi </span><span class="s4">^ </span><span class="s2">g_hi</span><span class="s4">))) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
      <span class="s2">ch_lo </span><span class="s4">= (</span><span class="s2">g_lo </span><span class="s4">^ (</span><span class="s2">e_lo </span><span class="s4">&amp; (</span><span class="s2">f_lo </span><span class="s4">^ </span><span class="s2">g_lo</span><span class="s4">))) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>

      <span class="s6">// Sum0(a) = ROTR 28(a) ^ ROTR 34(a) ^ ROTR 39(a)</span>
      <span class="s2">s0_hi </span><span class="s4">= (</span>
        <span class="s4">((</span><span class="s2">a_hi </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">28</span><span class="s4">) | (</span><span class="s2">a_lo </span><span class="s4">&lt;&lt; </span><span class="s7">4</span><span class="s4">)) ^ </span><span class="s6">// ROTR 28</span>
        <span class="s4">((</span><span class="s2">a_lo </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">2</span><span class="s4">) | (</span><span class="s2">a_hi </span><span class="s4">&lt;&lt; </span><span class="s7">30</span><span class="s4">)) ^ </span><span class="s6">// ROTR 34/(swap + ROTR 2)</span>
        <span class="s4">((</span><span class="s2">a_lo </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">7</span><span class="s4">) | (</span><span class="s2">a_hi </span><span class="s4">&lt;&lt; </span><span class="s7">25</span><span class="s4">))) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">; </span><span class="s6">// ROTR 39/(swap + ROTR 7)</span>
      <span class="s2">s0_lo </span><span class="s4">= (</span>
        <span class="s4">((</span><span class="s2">a_hi </span><span class="s4">&lt;&lt; </span><span class="s7">4</span><span class="s4">) | (</span><span class="s2">a_lo </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">28</span><span class="s4">)) ^ </span><span class="s6">// ROTR 28</span>
        <span class="s4">((</span><span class="s2">a_lo </span><span class="s4">&lt;&lt; </span><span class="s7">30</span><span class="s4">) | (</span><span class="s2">a_hi </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">2</span><span class="s4">)) ^ </span><span class="s6">// ROTR 34/(swap + ROTR 2)</span>
        <span class="s4">((</span><span class="s2">a_lo </span><span class="s4">&lt;&lt; </span><span class="s7">25</span><span class="s4">) | (</span><span class="s2">a_hi </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">7</span><span class="s4">))) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">; </span><span class="s6">// ROTR 39/(swap + ROTR 7)</span>

      <span class="s6">// Maj(a, b, c) (optimized the same way as SHA-1)</span>
      <span class="s2">maj_hi </span><span class="s4">= ((</span><span class="s2">a_hi </span><span class="s4">&amp; </span><span class="s2">b_hi</span><span class="s4">) | (</span><span class="s2">c_hi </span><span class="s4">&amp; (</span><span class="s2">a_hi </span><span class="s4">^ </span><span class="s2">b_hi</span><span class="s4">))) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
      <span class="s2">maj_lo </span><span class="s4">= ((</span><span class="s2">a_lo </span><span class="s4">&amp; </span><span class="s2">b_lo</span><span class="s4">) | (</span><span class="s2">c_lo </span><span class="s4">&amp; (</span><span class="s2">a_lo </span><span class="s4">^ </span><span class="s2">b_lo</span><span class="s4">))) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>

      <span class="s6">// main algorithm</span>
      <span class="s6">// t1 = (h + s1 + ch + _k[i] + _w[i]) modulo 2^64 (carry lo overflow)</span>
      <span class="s2">lo </span><span class="s4">= (</span><span class="s2">h_lo </span><span class="s4">+ </span><span class="s2">s1_lo </span><span class="s4">+ </span><span class="s2">ch_lo </span><span class="s4">+ </span><span class="s2">_k</span><span class="s4">[</span><span class="s2">i</span><span class="s4">][</span><span class="s7">1</span><span class="s4">] + </span><span class="s2">w</span><span class="s4">[</span><span class="s2">i</span><span class="s4">][</span><span class="s7">1</span><span class="s4">]);</span>
      <span class="s2">t1_hi </span><span class="s4">= (</span><span class="s2">h_hi </span><span class="s4">+ </span><span class="s2">s1_hi </span><span class="s4">+ </span><span class="s2">ch_hi </span><span class="s4">+ </span><span class="s2">_k</span><span class="s4">[</span><span class="s2">i</span><span class="s4">][</span><span class="s7">0</span><span class="s4">] + </span><span class="s2">w</span><span class="s4">[</span><span class="s2">i</span><span class="s4">][</span><span class="s7">0</span><span class="s4">] +</span>
        <span class="s4">((</span><span class="s2">lo </span><span class="s4">/ </span><span class="s7">0x100000000</span><span class="s4">) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">)) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
      <span class="s2">t1_lo </span><span class="s4">= </span><span class="s2">lo </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>

      <span class="s6">// t2 = s0 + maj modulo 2^64 (carry lo overflow)</span>
      <span class="s2">lo </span><span class="s4">= </span><span class="s2">s0_lo </span><span class="s4">+ </span><span class="s2">maj_lo</span><span class="s4">;</span>
      <span class="s2">t2_hi </span><span class="s4">= (</span><span class="s2">s0_hi </span><span class="s4">+ </span><span class="s2">maj_hi </span><span class="s4">+ ((</span><span class="s2">lo </span><span class="s4">/ </span><span class="s7">0x100000000</span><span class="s4">) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">)) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
      <span class="s2">t2_lo </span><span class="s4">= </span><span class="s2">lo </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>

      <span class="s2">h_hi </span><span class="s4">= </span><span class="s2">g_hi</span><span class="s4">;</span>
      <span class="s2">h_lo </span><span class="s4">= </span><span class="s2">g_lo</span><span class="s4">;</span>

      <span class="s2">g_hi </span><span class="s4">= </span><span class="s2">f_hi</span><span class="s4">;</span>
      <span class="s2">g_lo </span><span class="s4">= </span><span class="s2">f_lo</span><span class="s4">;</span>

      <span class="s2">f_hi </span><span class="s4">= </span><span class="s2">e_hi</span><span class="s4">;</span>
      <span class="s2">f_lo </span><span class="s4">= </span><span class="s2">e_lo</span><span class="s4">;</span>

      <span class="s6">// e = (d + t1) modulo 2^64 (carry lo overflow)</span>
      <span class="s2">lo </span><span class="s4">= </span><span class="s2">d_lo </span><span class="s4">+ </span><span class="s2">t1_lo</span><span class="s4">;</span>
      <span class="s2">e_hi </span><span class="s4">= (</span><span class="s2">d_hi </span><span class="s4">+ </span><span class="s2">t1_hi </span><span class="s4">+ ((</span><span class="s2">lo </span><span class="s4">/ </span><span class="s7">0x100000000</span><span class="s4">) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">)) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
      <span class="s2">e_lo </span><span class="s4">= </span><span class="s2">lo </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>

      <span class="s2">d_hi </span><span class="s4">= </span><span class="s2">c_hi</span><span class="s4">;</span>
      <span class="s2">d_lo </span><span class="s4">= </span><span class="s2">c_lo</span><span class="s4">;</span>

      <span class="s2">c_hi </span><span class="s4">= </span><span class="s2">b_hi</span><span class="s4">;</span>
      <span class="s2">c_lo </span><span class="s4">= </span><span class="s2">b_lo</span><span class="s4">;</span>

      <span class="s2">b_hi </span><span class="s4">= </span><span class="s2">a_hi</span><span class="s4">;</span>
      <span class="s2">b_lo </span><span class="s4">= </span><span class="s2">a_lo</span><span class="s4">;</span>

      <span class="s6">// a = (t1 + t2) modulo 2^64 (carry lo overflow)</span>
      <span class="s2">lo </span><span class="s4">= </span><span class="s2">t1_lo </span><span class="s4">+ </span><span class="s2">t2_lo</span><span class="s4">;</span>
      <span class="s2">a_hi </span><span class="s4">= (</span><span class="s2">t1_hi </span><span class="s4">+ </span><span class="s2">t2_hi </span><span class="s4">+ ((</span><span class="s2">lo </span><span class="s4">/ </span><span class="s7">0x100000000</span><span class="s4">) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">)) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
      <span class="s2">a_lo </span><span class="s4">= </span><span class="s2">lo </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s4">}</span>

    <span class="s6">// update hash state (additional modulo 2^64)</span>
    <span class="s2">lo </span><span class="s4">= </span><span class="s2">s</span><span class="s4">[</span><span class="s7">0</span><span class="s4">][</span><span class="s7">1</span><span class="s4">] + </span><span class="s2">a_lo</span><span class="s4">;</span>
    <span class="s2">s</span><span class="s4">[</span><span class="s7">0</span><span class="s4">][</span><span class="s7">0</span><span class="s4">] = (</span><span class="s2">s</span><span class="s4">[</span><span class="s7">0</span><span class="s4">][</span><span class="s7">0</span><span class="s4">] + </span><span class="s2">a_hi </span><span class="s4">+ ((</span><span class="s2">lo </span><span class="s4">/ </span><span class="s7">0x100000000</span><span class="s4">) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">)) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s2">s</span><span class="s4">[</span><span class="s7">0</span><span class="s4">][</span><span class="s7">1</span><span class="s4">] = </span><span class="s2">lo </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>

    <span class="s2">lo </span><span class="s4">= </span><span class="s2">s</span><span class="s4">[</span><span class="s7">1</span><span class="s4">][</span><span class="s7">1</span><span class="s4">] + </span><span class="s2">b_lo</span><span class="s4">;</span>
    <span class="s2">s</span><span class="s4">[</span><span class="s7">1</span><span class="s4">][</span><span class="s7">0</span><span class="s4">] = (</span><span class="s2">s</span><span class="s4">[</span><span class="s7">1</span><span class="s4">][</span><span class="s7">0</span><span class="s4">] + </span><span class="s2">b_hi </span><span class="s4">+ ((</span><span class="s2">lo </span><span class="s4">/ </span><span class="s7">0x100000000</span><span class="s4">) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">)) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s2">s</span><span class="s4">[</span><span class="s7">1</span><span class="s4">][</span><span class="s7">1</span><span class="s4">] = </span><span class="s2">lo </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>

    <span class="s2">lo </span><span class="s4">= </span><span class="s2">s</span><span class="s4">[</span><span class="s7">2</span><span class="s4">][</span><span class="s7">1</span><span class="s4">] + </span><span class="s2">c_lo</span><span class="s4">;</span>
    <span class="s2">s</span><span class="s4">[</span><span class="s7">2</span><span class="s4">][</span><span class="s7">0</span><span class="s4">] = (</span><span class="s2">s</span><span class="s4">[</span><span class="s7">2</span><span class="s4">][</span><span class="s7">0</span><span class="s4">] + </span><span class="s2">c_hi </span><span class="s4">+ ((</span><span class="s2">lo </span><span class="s4">/ </span><span class="s7">0x100000000</span><span class="s4">) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">)) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s2">s</span><span class="s4">[</span><span class="s7">2</span><span class="s4">][</span><span class="s7">1</span><span class="s4">] = </span><span class="s2">lo </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>

    <span class="s2">lo </span><span class="s4">= </span><span class="s2">s</span><span class="s4">[</span><span class="s7">3</span><span class="s4">][</span><span class="s7">1</span><span class="s4">] + </span><span class="s2">d_lo</span><span class="s4">;</span>
    <span class="s2">s</span><span class="s4">[</span><span class="s7">3</span><span class="s4">][</span><span class="s7">0</span><span class="s4">] = (</span><span class="s2">s</span><span class="s4">[</span><span class="s7">3</span><span class="s4">][</span><span class="s7">0</span><span class="s4">] + </span><span class="s2">d_hi </span><span class="s4">+ ((</span><span class="s2">lo </span><span class="s4">/ </span><span class="s7">0x100000000</span><span class="s4">) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">)) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s2">s</span><span class="s4">[</span><span class="s7">3</span><span class="s4">][</span><span class="s7">1</span><span class="s4">] = </span><span class="s2">lo </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>

    <span class="s2">lo </span><span class="s4">= </span><span class="s2">s</span><span class="s4">[</span><span class="s7">4</span><span class="s4">][</span><span class="s7">1</span><span class="s4">] + </span><span class="s2">e_lo</span><span class="s4">;</span>
    <span class="s2">s</span><span class="s4">[</span><span class="s7">4</span><span class="s4">][</span><span class="s7">0</span><span class="s4">] = (</span><span class="s2">s</span><span class="s4">[</span><span class="s7">4</span><span class="s4">][</span><span class="s7">0</span><span class="s4">] + </span><span class="s2">e_hi </span><span class="s4">+ ((</span><span class="s2">lo </span><span class="s4">/ </span><span class="s7">0x100000000</span><span class="s4">) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">)) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s2">s</span><span class="s4">[</span><span class="s7">4</span><span class="s4">][</span><span class="s7">1</span><span class="s4">] = </span><span class="s2">lo </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>

    <span class="s2">lo </span><span class="s4">= </span><span class="s2">s</span><span class="s4">[</span><span class="s7">5</span><span class="s4">][</span><span class="s7">1</span><span class="s4">] + </span><span class="s2">f_lo</span><span class="s4">;</span>
    <span class="s2">s</span><span class="s4">[</span><span class="s7">5</span><span class="s4">][</span><span class="s7">0</span><span class="s4">] = (</span><span class="s2">s</span><span class="s4">[</span><span class="s7">5</span><span class="s4">][</span><span class="s7">0</span><span class="s4">] + </span><span class="s2">f_hi </span><span class="s4">+ ((</span><span class="s2">lo </span><span class="s4">/ </span><span class="s7">0x100000000</span><span class="s4">) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">)) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s2">s</span><span class="s4">[</span><span class="s7">5</span><span class="s4">][</span><span class="s7">1</span><span class="s4">] = </span><span class="s2">lo </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>

    <span class="s2">lo </span><span class="s4">= </span><span class="s2">s</span><span class="s4">[</span><span class="s7">6</span><span class="s4">][</span><span class="s7">1</span><span class="s4">] + </span><span class="s2">g_lo</span><span class="s4">;</span>
    <span class="s2">s</span><span class="s4">[</span><span class="s7">6</span><span class="s4">][</span><span class="s7">0</span><span class="s4">] = (</span><span class="s2">s</span><span class="s4">[</span><span class="s7">6</span><span class="s4">][</span><span class="s7">0</span><span class="s4">] + </span><span class="s2">g_hi </span><span class="s4">+ ((</span><span class="s2">lo </span><span class="s4">/ </span><span class="s7">0x100000000</span><span class="s4">) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">)) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s2">s</span><span class="s4">[</span><span class="s7">6</span><span class="s4">][</span><span class="s7">1</span><span class="s4">] = </span><span class="s2">lo </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>

    <span class="s2">lo </span><span class="s4">= </span><span class="s2">s</span><span class="s4">[</span><span class="s7">7</span><span class="s4">][</span><span class="s7">1</span><span class="s4">] + </span><span class="s2">h_lo</span><span class="s4">;</span>
    <span class="s2">s</span><span class="s4">[</span><span class="s7">7</span><span class="s4">][</span><span class="s7">0</span><span class="s4">] = (</span><span class="s2">s</span><span class="s4">[</span><span class="s7">7</span><span class="s4">][</span><span class="s7">0</span><span class="s4">] + </span><span class="s2">h_hi </span><span class="s4">+ ((</span><span class="s2">lo </span><span class="s4">/ </span><span class="s7">0x100000000</span><span class="s4">) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">)) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s2">s</span><span class="s4">[</span><span class="s7">7</span><span class="s4">][</span><span class="s7">1</span><span class="s4">] = </span><span class="s2">lo </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>

    <span class="s2">len </span><span class="s4">-= </span><span class="s7">128</span><span class="s4">;</span>
  <span class="s4">}</span>
<span class="s4">}</span>
</pre>
</body>
</html>