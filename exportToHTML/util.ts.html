<html>
<head>
<title>util.ts</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
.s6 { color: #42c3d4;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
util.ts</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">type </span><span class="s2">{</span><span class="s1">AnySchema</span><span class="s2">, </span><span class="s1">EvaluatedProperties</span><span class="s2">, </span><span class="s1">EvaluatedItems</span><span class="s2">} </span><span class="s1">from </span><span class="s3">&quot;../types&quot;</span>
<span class="s0">import </span><span class="s1">type </span><span class="s2">{</span><span class="s1">SchemaCxt</span><span class="s2">, </span><span class="s1">SchemaObjCxt</span><span class="s2">} </span><span class="s1">from </span><span class="s3">&quot;.&quot;</span>
<span class="s0">import </span><span class="s2">{</span><span class="s1">_</span><span class="s2">, </span><span class="s1">getProperty</span><span class="s2">, </span><span class="s1">Code</span><span class="s2">, </span><span class="s1">Name</span><span class="s2">, </span><span class="s1">CodeGen</span><span class="s2">} </span><span class="s1">from </span><span class="s3">&quot;./codegen&quot;</span>
<span class="s0">import </span><span class="s2">{</span><span class="s1">_Code</span><span class="s2">} </span><span class="s1">from </span><span class="s3">&quot;./codegen/code&quot;</span>
<span class="s0">import </span><span class="s1">type </span><span class="s2">{</span><span class="s1">Rule</span><span class="s2">, </span><span class="s1">ValidationRules</span><span class="s2">} </span><span class="s1">from </span><span class="s3">&quot;./rules&quot;</span>

<span class="s4">// TODO refactor to use Set</span>
<span class="s0">export function </span><span class="s1">toHash</span><span class="s2">&lt;</span><span class="s1">T </span><span class="s0">extends </span><span class="s1">string </span><span class="s2">= </span><span class="s1">string</span><span class="s2">&gt;(</span><span class="s1">arr</span><span class="s2">: </span><span class="s1">T</span><span class="s2">[]): {[</span><span class="s1">K </span><span class="s0">in </span><span class="s1">T</span><span class="s2">]?: </span><span class="s0">true</span><span class="s2">} {</span>
  <span class="s0">const </span><span class="s1">hash</span><span class="s2">: {[</span><span class="s1">K </span><span class="s0">in </span><span class="s1">T</span><span class="s2">]?: </span><span class="s0">true</span><span class="s2">} = {}</span>
  <span class="s0">for </span><span class="s2">(</span><span class="s0">const </span><span class="s1">item of arr</span><span class="s2">) </span><span class="s1">hash</span><span class="s2">[</span><span class="s1">item</span><span class="s2">] = </span><span class="s0">true</span>
  <span class="s0">return </span><span class="s1">hash</span>
<span class="s2">}</span>

<span class="s0">export function </span><span class="s1">alwaysValidSchema</span><span class="s2">(</span><span class="s1">it</span><span class="s2">: </span><span class="s1">SchemaCxt</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">: </span><span class="s1">AnySchema</span><span class="s2">): </span><span class="s1">boolean </span><span class="s2">| </span><span class="s0">void </span><span class="s2">{</span>
  <span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">schema </span><span class="s2">== </span><span class="s3">&quot;boolean&quot;</span><span class="s2">) </span><span class="s0">return </span><span class="s1">schema</span>
  <span class="s0">if </span><span class="s2">(</span><span class="s1">Object</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">(</span><span class="s1">schema</span><span class="s2">).</span><span class="s1">length </span><span class="s2">=== </span><span class="s5">0</span><span class="s2">) </span><span class="s0">return true</span>
  <span class="s1">checkUnknownRules</span><span class="s2">(</span><span class="s1">it</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">)</span>
  <span class="s0">return </span><span class="s2">!</span><span class="s1">schemaHasRules</span><span class="s2">(</span><span class="s1">schema</span><span class="s2">, </span><span class="s1">it</span><span class="s2">.</span><span class="s1">self</span><span class="s2">.</span><span class="s1">RULES</span><span class="s2">.</span><span class="s1">all</span><span class="s2">)</span>
<span class="s2">}</span>

<span class="s0">export function </span><span class="s1">checkUnknownRules</span><span class="s2">(</span><span class="s1">it</span><span class="s2">: </span><span class="s1">SchemaCxt</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">: </span><span class="s1">AnySchema </span><span class="s2">= </span><span class="s1">it</span><span class="s2">.</span><span class="s1">schema</span><span class="s2">): </span><span class="s0">void </span><span class="s2">{</span>
  <span class="s0">const </span><span class="s2">{</span><span class="s1">opts</span><span class="s2">, </span><span class="s1">self</span><span class="s2">} = </span><span class="s1">it</span>
  <span class="s0">if </span><span class="s2">(!</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">strictSchema</span><span class="s2">) </span><span class="s0">return</span>
  <span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">schema </span><span class="s2">=== </span><span class="s3">&quot;boolean&quot;</span><span class="s2">) </span><span class="s0">return</span>
  <span class="s0">const </span><span class="s1">rules </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">RULES</span><span class="s2">.</span><span class="s1">keywords</span>
  <span class="s0">for </span><span class="s2">(</span><span class="s0">const </span><span class="s1">key </span><span class="s0">in </span><span class="s1">schema</span><span class="s2">) {</span>
    <span class="s0">if </span><span class="s2">(!</span><span class="s1">rules</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]) </span><span class="s1">checkStrictMode</span><span class="s2">(</span><span class="s1">it</span><span class="s2">, </span><span class="s3">`unknown keyword: &quot;</span><span class="s1">$</span><span class="s2">{</span><span class="s1">key</span><span class="s2">}</span><span class="s3">&quot;`</span><span class="s2">)</span>
  <span class="s2">}</span>
<span class="s2">}</span>

<span class="s0">export function </span><span class="s1">schemaHasRules</span><span class="s2">(</span>
  <span class="s1">schema</span><span class="s2">: </span><span class="s1">AnySchema</span><span class="s2">,</span>
  <span class="s1">rules</span><span class="s2">: {[</span><span class="s1">Key </span><span class="s0">in </span><span class="s1">string</span><span class="s2">]?: </span><span class="s1">boolean </span><span class="s2">| </span><span class="s1">Rule</span><span class="s2">}</span>
<span class="s2">): </span><span class="s1">boolean </span><span class="s2">{</span>
  <span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">schema </span><span class="s2">== </span><span class="s3">&quot;boolean&quot;</span><span class="s2">) </span><span class="s0">return </span><span class="s2">!</span><span class="s1">schema</span>
  <span class="s0">for </span><span class="s2">(</span><span class="s0">const </span><span class="s1">key </span><span class="s0">in </span><span class="s1">schema</span><span class="s2">) </span><span class="s0">if </span><span class="s2">(</span><span class="s1">rules</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]) </span><span class="s0">return true</span>
  <span class="s0">return false</span>
<span class="s2">}</span>

<span class="s0">export function </span><span class="s1">schemaHasRulesButRef</span><span class="s2">(</span><span class="s1">schema</span><span class="s2">: </span><span class="s1">AnySchema</span><span class="s2">, </span><span class="s1">RULES</span><span class="s2">: </span><span class="s1">ValidationRules</span><span class="s2">): </span><span class="s1">boolean </span><span class="s2">{</span>
  <span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">schema </span><span class="s2">== </span><span class="s3">&quot;boolean&quot;</span><span class="s2">) </span><span class="s0">return </span><span class="s2">!</span><span class="s1">schema</span>
  <span class="s0">for </span><span class="s2">(</span><span class="s0">const </span><span class="s1">key </span><span class="s0">in </span><span class="s1">schema</span><span class="s2">) </span><span class="s0">if </span><span class="s2">(</span><span class="s1">key </span><span class="s2">!== </span><span class="s3">&quot;$ref&quot; </span><span class="s2">&amp;&amp; </span><span class="s1">RULES</span><span class="s2">.</span><span class="s1">all</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]) </span><span class="s0">return true</span>
  <span class="s0">return false</span>
<span class="s2">}</span>

<span class="s0">export function </span><span class="s1">schemaRefOrVal</span><span class="s2">(</span>
  <span class="s2">{</span><span class="s1">topSchemaRef</span><span class="s2">, </span><span class="s1">schemaPath</span><span class="s2">}: </span><span class="s1">SchemaObjCxt</span><span class="s2">,</span>
  <span class="s1">schema</span><span class="s2">: </span><span class="s1">unknown</span><span class="s2">,</span>
  <span class="s1">keyword</span><span class="s2">: </span><span class="s1">string</span><span class="s2">,</span>
  <span class="s1">$data</span><span class="s2">?: </span><span class="s1">string </span><span class="s2">| </span><span class="s0">false</span>
<span class="s2">): </span><span class="s1">Code </span><span class="s2">| </span><span class="s1">number </span><span class="s2">| </span><span class="s1">boolean </span><span class="s2">{</span>
  <span class="s0">if </span><span class="s2">(!</span><span class="s1">$data</span><span class="s2">) {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">schema </span><span class="s2">== </span><span class="s3">&quot;number&quot; </span><span class="s2">|| </span><span class="s0">typeof </span><span class="s1">schema </span><span class="s2">== </span><span class="s3">&quot;boolean&quot;</span><span class="s2">) </span><span class="s0">return </span><span class="s1">schema</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">schema </span><span class="s2">== </span><span class="s3">&quot;string&quot;</span><span class="s2">) </span><span class="s0">return </span><span class="s1">_</span><span class="s3">`</span><span class="s1">$</span><span class="s2">{</span><span class="s1">schema</span><span class="s2">}</span><span class="s3">`</span>
  <span class="s2">}</span>
  <span class="s0">return </span><span class="s1">_</span><span class="s3">`</span><span class="s1">$</span><span class="s2">{</span><span class="s1">topSchemaRef</span><span class="s2">}</span><span class="s1">$</span><span class="s2">{</span><span class="s1">schemaPath</span><span class="s2">}</span><span class="s1">$</span><span class="s2">{</span><span class="s1">getProperty</span><span class="s2">(</span><span class="s1">keyword</span><span class="s2">)}</span><span class="s3">`</span>
<span class="s2">}</span>

<span class="s0">export function </span><span class="s1">unescapeFragment</span><span class="s2">(</span><span class="s1">str</span><span class="s2">: </span><span class="s1">string</span><span class="s2">): </span><span class="s1">string </span><span class="s2">{</span>
  <span class="s0">return </span><span class="s1">unescapeJsonPointer</span><span class="s2">(</span><span class="s1">decodeURIComponent</span><span class="s2">(</span><span class="s1">str</span><span class="s2">))</span>
<span class="s2">}</span>

<span class="s0">export function </span><span class="s1">escapeFragment</span><span class="s2">(</span><span class="s1">str</span><span class="s2">: </span><span class="s1">string </span><span class="s2">| </span><span class="s1">number</span><span class="s2">): </span><span class="s1">string </span><span class="s2">{</span>
  <span class="s0">return </span><span class="s1">encodeURIComponent</span><span class="s2">(</span><span class="s1">escapeJsonPointer</span><span class="s2">(</span><span class="s1">str</span><span class="s2">))</span>
<span class="s2">}</span>

<span class="s0">export function </span><span class="s1">escapeJsonPointer</span><span class="s2">(</span><span class="s1">str</span><span class="s2">: </span><span class="s1">string </span><span class="s2">| </span><span class="s1">number</span><span class="s2">): </span><span class="s1">string </span><span class="s2">{</span>
  <span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">str </span><span class="s2">== </span><span class="s3">&quot;number&quot;</span><span class="s2">) </span><span class="s0">return </span><span class="s3">`</span><span class="s1">$</span><span class="s2">{</span><span class="s1">str</span><span class="s2">}</span><span class="s3">`</span>
  <span class="s0">return </span><span class="s1">str</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s6">/~/g</span><span class="s2">, </span><span class="s3">&quot;~0&quot;</span><span class="s2">).</span><span class="s1">replace</span><span class="s2">(</span><span class="s6">/\//g</span><span class="s2">, </span><span class="s3">&quot;~1&quot;</span><span class="s2">)</span>
<span class="s2">}</span>

<span class="s0">export function </span><span class="s1">unescapeJsonPointer</span><span class="s2">(</span><span class="s1">str</span><span class="s2">: </span><span class="s1">string</span><span class="s2">): </span><span class="s1">string </span><span class="s2">{</span>
  <span class="s0">return </span><span class="s1">str</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s6">/~1/g</span><span class="s2">, </span><span class="s3">&quot;/&quot;</span><span class="s2">).</span><span class="s1">replace</span><span class="s2">(</span><span class="s6">/~0/g</span><span class="s2">, </span><span class="s3">&quot;~&quot;</span><span class="s2">)</span>
<span class="s2">}</span>

<span class="s0">export function </span><span class="s1">eachItem</span><span class="s2">&lt;</span><span class="s1">T</span><span class="s2">&gt;(</span><span class="s1">xs</span><span class="s2">: </span><span class="s1">T </span><span class="s2">| </span><span class="s1">T</span><span class="s2">[], </span><span class="s1">f</span><span class="s2">: (</span><span class="s1">x</span><span class="s2">: </span><span class="s1">T</span><span class="s2">) =&gt; </span><span class="s0">void</span><span class="s2">): </span><span class="s0">void </span><span class="s2">{</span>
  <span class="s0">if </span><span class="s2">(</span><span class="s1">Array</span><span class="s2">.</span><span class="s1">isArray</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">)) {</span>
    <span class="s0">for </span><span class="s2">(</span><span class="s0">const </span><span class="s1">x of xs</span><span class="s2">) </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
  <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
    <span class="s1">f</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">)</span>
  <span class="s2">}</span>
<span class="s2">}</span>

<span class="s1">type SomeEvaluated </span><span class="s2">= </span><span class="s1">EvaluatedProperties </span><span class="s2">| </span><span class="s1">EvaluatedItems</span>

<span class="s1">type MergeEvaluatedFunc</span><span class="s2">&lt;</span><span class="s1">T </span><span class="s0">extends </span><span class="s1">SomeEvaluated</span><span class="s2">&gt; = (</span>
  <span class="s1">gen</span><span class="s2">: </span><span class="s1">CodeGen</span><span class="s2">,</span>
  <span class="s1">from</span><span class="s2">: </span><span class="s1">Name </span><span class="s2">| </span><span class="s1">T</span><span class="s2">,</span>
  <span class="s1">to</span><span class="s2">: </span><span class="s1">Name </span><span class="s2">| </span><span class="s1">Exclude</span><span class="s2">&lt;</span><span class="s1">T</span><span class="s2">, </span><span class="s0">true</span><span class="s2">&gt; | </span><span class="s1">undefined</span><span class="s2">,</span>
  <span class="s1">toName</span><span class="s2">?: </span><span class="s0">typeof </span><span class="s1">Name</span>
<span class="s2">) =&gt; </span><span class="s1">Name </span><span class="s2">| </span><span class="s1">T</span>

<span class="s0">interface </span><span class="s1">MakeMergeFuncArgs</span><span class="s2">&lt;</span><span class="s1">T </span><span class="s0">extends </span><span class="s1">SomeEvaluated</span><span class="s2">&gt; {</span>
  <span class="s1">mergeNames</span><span class="s2">: (</span><span class="s1">gen</span><span class="s2">: </span><span class="s1">CodeGen</span><span class="s2">, </span><span class="s1">from</span><span class="s2">: </span><span class="s1">Name</span><span class="s2">, </span><span class="s1">to</span><span class="s2">: </span><span class="s1">Name</span><span class="s2">) =&gt; </span><span class="s0">void</span>
  <span class="s1">mergeToName</span><span class="s2">: (</span><span class="s1">gen</span><span class="s2">: </span><span class="s1">CodeGen</span><span class="s2">, </span><span class="s1">from</span><span class="s2">: </span><span class="s1">T</span><span class="s2">, </span><span class="s1">to</span><span class="s2">: </span><span class="s1">Name</span><span class="s2">) =&gt; </span><span class="s0">void</span>
  <span class="s1">mergeValues</span><span class="s2">: (</span><span class="s1">from</span><span class="s2">: </span><span class="s1">T</span><span class="s2">, </span><span class="s1">to</span><span class="s2">: </span><span class="s1">Exclude</span><span class="s2">&lt;</span><span class="s1">T</span><span class="s2">, </span><span class="s0">true</span><span class="s2">&gt;) =&gt; </span><span class="s1">T</span>
  <span class="s1">resultToName</span><span class="s2">: (</span><span class="s1">gen</span><span class="s2">: </span><span class="s1">CodeGen</span><span class="s2">, </span><span class="s1">res</span><span class="s2">?: </span><span class="s1">T</span><span class="s2">) =&gt; </span><span class="s1">Name</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">makeMergeEvaluated</span><span class="s2">&lt;</span><span class="s1">T </span><span class="s0">extends </span><span class="s1">SomeEvaluated</span><span class="s2">&gt;({</span>
  <span class="s1">mergeNames</span><span class="s2">,</span>
  <span class="s1">mergeToName</span><span class="s2">,</span>
  <span class="s1">mergeValues</span><span class="s2">,</span>
  <span class="s1">resultToName</span><span class="s2">,</span>
<span class="s2">}: </span><span class="s1">MakeMergeFuncArgs</span><span class="s2">&lt;</span><span class="s1">T</span><span class="s2">&gt;): </span><span class="s1">MergeEvaluatedFunc</span><span class="s2">&lt;</span><span class="s1">T</span><span class="s2">&gt; {</span>
  <span class="s0">return </span><span class="s2">(</span><span class="s1">gen</span><span class="s2">, </span><span class="s1">from</span><span class="s2">, </span><span class="s1">to</span><span class="s2">, </span><span class="s1">toName</span><span class="s2">) =&gt; {</span>
    <span class="s0">const </span><span class="s1">res </span><span class="s2">=</span>
      <span class="s1">to </span><span class="s2">=== </span><span class="s1">undefined</span>
        <span class="s2">? </span><span class="s1">from</span>
        <span class="s2">: </span><span class="s1">to </span><span class="s0">instanceof </span><span class="s1">Name</span>
        <span class="s2">? (</span><span class="s1">from </span><span class="s0">instanceof </span><span class="s1">Name </span><span class="s2">? </span><span class="s1">mergeNames</span><span class="s2">(</span><span class="s1">gen</span><span class="s2">, </span><span class="s1">from</span><span class="s2">, </span><span class="s1">to</span><span class="s2">) : </span><span class="s1">mergeToName</span><span class="s2">(</span><span class="s1">gen</span><span class="s2">, </span><span class="s1">from</span><span class="s2">, </span><span class="s1">to</span><span class="s2">), </span><span class="s1">to</span><span class="s2">)</span>
        <span class="s2">: </span><span class="s1">from </span><span class="s0">instanceof </span><span class="s1">Name</span>
        <span class="s2">? (</span><span class="s1">mergeToName</span><span class="s2">(</span><span class="s1">gen</span><span class="s2">, </span><span class="s1">to</span><span class="s2">, </span><span class="s1">from</span><span class="s2">), </span><span class="s1">from</span><span class="s2">)</span>
        <span class="s2">: </span><span class="s1">mergeValues</span><span class="s2">(</span><span class="s1">from</span><span class="s2">, </span><span class="s1">to</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">toName </span><span class="s2">=== </span><span class="s1">Name </span><span class="s2">&amp;&amp; !(</span><span class="s1">res </span><span class="s0">instanceof </span><span class="s1">Name</span><span class="s2">) ? </span><span class="s1">resultToName</span><span class="s2">(</span><span class="s1">gen</span><span class="s2">, </span><span class="s1">res</span><span class="s2">) : </span><span class="s1">res</span>
  <span class="s2">}</span>
<span class="s2">}</span>

<span class="s0">interface </span><span class="s1">MergeEvaluated </span><span class="s2">{</span>
  <span class="s1">props</span><span class="s2">: </span><span class="s1">MergeEvaluatedFunc</span><span class="s2">&lt;</span><span class="s1">EvaluatedProperties</span><span class="s2">&gt;</span>
  <span class="s1">items</span><span class="s2">: </span><span class="s1">MergeEvaluatedFunc</span><span class="s2">&lt;</span><span class="s1">EvaluatedItems</span><span class="s2">&gt;</span>
<span class="s2">}</span>

<span class="s0">export const </span><span class="s1">mergeEvaluated</span><span class="s2">: </span><span class="s1">MergeEvaluated </span><span class="s2">= {</span>
  <span class="s1">props</span><span class="s2">: </span><span class="s1">makeMergeEvaluated</span><span class="s2">({</span>
    <span class="s1">mergeNames</span><span class="s2">: (</span><span class="s1">gen</span><span class="s2">, </span><span class="s1">from</span><span class="s2">, </span><span class="s1">to</span><span class="s2">) =&gt;</span>
      <span class="s1">gen</span><span class="s2">.</span><span class="s1">if</span><span class="s2">(</span><span class="s1">_</span><span class="s3">`</span><span class="s1">$</span><span class="s2">{</span><span class="s1">to</span><span class="s2">} </span><span class="s3">!== true &amp;&amp; </span><span class="s1">$</span><span class="s2">{</span><span class="s1">from</span><span class="s2">} </span><span class="s3">!== undefined`</span><span class="s2">, () =&gt; {</span>
        <span class="s1">gen</span><span class="s2">.</span><span class="s1">if</span><span class="s2">(</span>
          <span class="s1">_</span><span class="s3">`</span><span class="s1">$</span><span class="s2">{</span><span class="s1">from</span><span class="s2">} </span><span class="s3">=== true`</span><span class="s2">,</span>
          <span class="s2">() =&gt; </span><span class="s1">gen</span><span class="s2">.</span><span class="s1">assign</span><span class="s2">(</span><span class="s1">to</span><span class="s2">, </span><span class="s0">true</span><span class="s2">),</span>
          <span class="s2">() =&gt; </span><span class="s1">gen</span><span class="s2">.</span><span class="s1">assign</span><span class="s2">(</span><span class="s1">to</span><span class="s2">, </span><span class="s1">_</span><span class="s3">`</span><span class="s1">$</span><span class="s2">{</span><span class="s1">to</span><span class="s2">} </span><span class="s3">|| {}`</span><span class="s2">).</span><span class="s1">code</span><span class="s2">(</span><span class="s1">_</span><span class="s3">`Object.assign(</span><span class="s1">$</span><span class="s2">{</span><span class="s1">to</span><span class="s2">}</span><span class="s3">, </span><span class="s1">$</span><span class="s2">{</span><span class="s1">from</span><span class="s2">}</span><span class="s3">)`</span><span class="s2">)</span>
        <span class="s2">)</span>
      <span class="s2">}),</span>
    <span class="s1">mergeToName</span><span class="s2">: (</span><span class="s1">gen</span><span class="s2">, </span><span class="s1">from</span><span class="s2">, </span><span class="s1">to</span><span class="s2">) =&gt;</span>
      <span class="s1">gen</span><span class="s2">.</span><span class="s1">if</span><span class="s2">(</span><span class="s1">_</span><span class="s3">`</span><span class="s1">$</span><span class="s2">{</span><span class="s1">to</span><span class="s2">} </span><span class="s3">!== true`</span><span class="s2">, () =&gt; {</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">from </span><span class="s2">=== </span><span class="s0">true</span><span class="s2">) {</span>
          <span class="s1">gen</span><span class="s2">.</span><span class="s1">assign</span><span class="s2">(</span><span class="s1">to</span><span class="s2">, </span><span class="s0">true</span><span class="s2">)</span>
        <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
          <span class="s1">gen</span><span class="s2">.</span><span class="s1">assign</span><span class="s2">(</span><span class="s1">to</span><span class="s2">, </span><span class="s1">_</span><span class="s3">`</span><span class="s1">$</span><span class="s2">{</span><span class="s1">to</span><span class="s2">} </span><span class="s3">|| {}`</span><span class="s2">)</span>
          <span class="s1">setEvaluated</span><span class="s2">(</span><span class="s1">gen</span><span class="s2">, </span><span class="s1">to</span><span class="s2">, </span><span class="s1">from</span><span class="s2">)</span>
        <span class="s2">}</span>
      <span class="s2">}),</span>
    <span class="s1">mergeValues</span><span class="s2">: (</span><span class="s1">from</span><span class="s2">, </span><span class="s1">to</span><span class="s2">) =&gt; (</span><span class="s1">from </span><span class="s2">=== </span><span class="s0">true </span><span class="s2">? </span><span class="s0">true </span><span class="s2">: {</span><span class="s1">...from</span><span class="s2">, </span><span class="s1">...to</span><span class="s2">}),</span>
    <span class="s1">resultToName</span><span class="s2">: </span><span class="s1">evaluatedPropsToName</span><span class="s2">,</span>
  <span class="s2">}),</span>
  <span class="s1">items</span><span class="s2">: </span><span class="s1">makeMergeEvaluated</span><span class="s2">({</span>
    <span class="s1">mergeNames</span><span class="s2">: (</span><span class="s1">gen</span><span class="s2">, </span><span class="s1">from</span><span class="s2">, </span><span class="s1">to</span><span class="s2">) =&gt;</span>
      <span class="s1">gen</span><span class="s2">.</span><span class="s1">if</span><span class="s2">(</span><span class="s1">_</span><span class="s3">`</span><span class="s1">$</span><span class="s2">{</span><span class="s1">to</span><span class="s2">} </span><span class="s3">!== true &amp;&amp; </span><span class="s1">$</span><span class="s2">{</span><span class="s1">from</span><span class="s2">} </span><span class="s3">!== undefined`</span><span class="s2">, () =&gt;</span>
        <span class="s1">gen</span><span class="s2">.</span><span class="s1">assign</span><span class="s2">(</span><span class="s1">to</span><span class="s2">, </span><span class="s1">_</span><span class="s3">`</span><span class="s1">$</span><span class="s2">{</span><span class="s1">from</span><span class="s2">} </span><span class="s3">=== true ? true : </span><span class="s1">$</span><span class="s2">{</span><span class="s1">to</span><span class="s2">} </span><span class="s3">&gt; </span><span class="s1">$</span><span class="s2">{</span><span class="s1">from</span><span class="s2">} </span><span class="s3">? </span><span class="s1">$</span><span class="s2">{</span><span class="s1">to</span><span class="s2">} </span><span class="s3">: </span><span class="s1">$</span><span class="s2">{</span><span class="s1">from</span><span class="s2">}</span><span class="s3">`</span><span class="s2">)</span>
      <span class="s2">),</span>
    <span class="s1">mergeToName</span><span class="s2">: (</span><span class="s1">gen</span><span class="s2">, </span><span class="s1">from</span><span class="s2">, </span><span class="s1">to</span><span class="s2">) =&gt;</span>
      <span class="s1">gen</span><span class="s2">.</span><span class="s1">if</span><span class="s2">(</span><span class="s1">_</span><span class="s3">`</span><span class="s1">$</span><span class="s2">{</span><span class="s1">to</span><span class="s2">} </span><span class="s3">!== true`</span><span class="s2">, () =&gt;</span>
        <span class="s1">gen</span><span class="s2">.</span><span class="s1">assign</span><span class="s2">(</span><span class="s1">to</span><span class="s2">, </span><span class="s1">from </span><span class="s2">=== </span><span class="s0">true </span><span class="s2">? </span><span class="s0">true </span><span class="s2">: </span><span class="s1">_</span><span class="s3">`</span><span class="s1">$</span><span class="s2">{</span><span class="s1">to</span><span class="s2">} </span><span class="s3">&gt; </span><span class="s1">$</span><span class="s2">{</span><span class="s1">from</span><span class="s2">} </span><span class="s3">? </span><span class="s1">$</span><span class="s2">{</span><span class="s1">to</span><span class="s2">} </span><span class="s3">: </span><span class="s1">$</span><span class="s2">{</span><span class="s1">from</span><span class="s2">}</span><span class="s3">`</span><span class="s2">)</span>
      <span class="s2">),</span>
    <span class="s1">mergeValues</span><span class="s2">: (</span><span class="s1">from</span><span class="s2">, </span><span class="s1">to</span><span class="s2">) =&gt; (</span><span class="s1">from </span><span class="s2">=== </span><span class="s0">true </span><span class="s2">? </span><span class="s0">true </span><span class="s2">: </span><span class="s1">Math</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">from</span><span class="s2">, </span><span class="s1">to</span><span class="s2">)),</span>
    <span class="s1">resultToName</span><span class="s2">: (</span><span class="s1">gen</span><span class="s2">, </span><span class="s1">items</span><span class="s2">) =&gt; </span><span class="s1">gen</span><span class="s2">.</span><span class="s1">var</span><span class="s2">(</span><span class="s3">&quot;items&quot;</span><span class="s2">, </span><span class="s1">items</span><span class="s2">),</span>
  <span class="s2">}),</span>
<span class="s2">}</span>

<span class="s0">export function </span><span class="s1">evaluatedPropsToName</span><span class="s2">(</span><span class="s1">gen</span><span class="s2">: </span><span class="s1">CodeGen</span><span class="s2">, </span><span class="s1">ps</span><span class="s2">?: </span><span class="s1">EvaluatedProperties</span><span class="s2">): </span><span class="s1">Name </span><span class="s2">{</span>
  <span class="s0">if </span><span class="s2">(</span><span class="s1">ps </span><span class="s2">=== </span><span class="s0">true</span><span class="s2">) </span><span class="s0">return </span><span class="s1">gen</span><span class="s2">.</span><span class="s1">var</span><span class="s2">(</span><span class="s3">&quot;props&quot;</span><span class="s2">, </span><span class="s0">true</span><span class="s2">)</span>
  <span class="s0">const </span><span class="s1">props </span><span class="s2">= </span><span class="s1">gen</span><span class="s2">.</span><span class="s1">var</span><span class="s2">(</span><span class="s3">&quot;props&quot;</span><span class="s2">, </span><span class="s1">_</span><span class="s3">`{}`</span><span class="s2">)</span>
  <span class="s0">if </span><span class="s2">(</span><span class="s1">ps </span><span class="s2">!== </span><span class="s1">undefined</span><span class="s2">) </span><span class="s1">setEvaluated</span><span class="s2">(</span><span class="s1">gen</span><span class="s2">, </span><span class="s1">props</span><span class="s2">, </span><span class="s1">ps</span><span class="s2">)</span>
  <span class="s0">return </span><span class="s1">props</span>
<span class="s2">}</span>

<span class="s0">export function </span><span class="s1">setEvaluated</span><span class="s2">(</span><span class="s1">gen</span><span class="s2">: </span><span class="s1">CodeGen</span><span class="s2">, </span><span class="s1">props</span><span class="s2">: </span><span class="s1">Name</span><span class="s2">, </span><span class="s1">ps</span><span class="s2">: {[</span><span class="s1">K </span><span class="s0">in </span><span class="s1">string</span><span class="s2">]?: </span><span class="s0">true</span><span class="s2">}): </span><span class="s0">void </span><span class="s2">{</span>
  <span class="s1">Object</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">(</span><span class="s1">ps</span><span class="s2">).</span><span class="s1">forEach</span><span class="s2">((</span><span class="s1">p</span><span class="s2">) =&gt; </span><span class="s1">gen</span><span class="s2">.</span><span class="s1">assign</span><span class="s2">(</span><span class="s1">_</span><span class="s3">`</span><span class="s1">$</span><span class="s2">{</span><span class="s1">props</span><span class="s2">}</span><span class="s1">$</span><span class="s2">{</span><span class="s1">getProperty</span><span class="s2">(</span><span class="s1">p</span><span class="s2">)}</span><span class="s3">`</span><span class="s2">, </span><span class="s0">true</span><span class="s2">))</span>
<span class="s2">}</span>

<span class="s0">const </span><span class="s1">snippets</span><span class="s2">: {[</span><span class="s1">S </span><span class="s0">in </span><span class="s1">string</span><span class="s2">]?: </span><span class="s1">_Code</span><span class="s2">} = {}</span>

<span class="s0">export function </span><span class="s1">useFunc</span><span class="s2">(</span><span class="s1">gen</span><span class="s2">: </span><span class="s1">CodeGen</span><span class="s2">, </span><span class="s1">f</span><span class="s2">: {</span><span class="s1">code</span><span class="s2">: </span><span class="s1">string</span><span class="s2">}): </span><span class="s1">Name </span><span class="s2">{</span>
  <span class="s0">return </span><span class="s1">gen</span><span class="s2">.</span><span class="s1">scopeValue</span><span class="s2">(</span><span class="s3">&quot;func&quot;</span><span class="s2">, {</span>
    <span class="s1">ref</span><span class="s2">: </span><span class="s1">f</span><span class="s2">,</span>
    <span class="s1">code</span><span class="s2">: </span><span class="s1">snippets</span><span class="s2">[</span><span class="s1">f</span><span class="s2">.</span><span class="s1">code</span><span class="s2">] || (</span><span class="s1">snippets</span><span class="s2">[</span><span class="s1">f</span><span class="s2">.</span><span class="s1">code</span><span class="s2">] = </span><span class="s0">new </span><span class="s1">_Code</span><span class="s2">(</span><span class="s1">f</span><span class="s2">.</span><span class="s1">code</span><span class="s2">)),</span>
  <span class="s2">})</span>
<span class="s2">}</span>

<span class="s0">export enum </span><span class="s1">Type </span><span class="s2">{</span>
  <span class="s1">Num</span><span class="s2">,</span>
  <span class="s1">Str</span><span class="s2">,</span>
<span class="s2">}</span>

<span class="s0">export function </span><span class="s1">getErrorPath</span><span class="s2">(</span>
  <span class="s1">dataProp</span><span class="s2">: </span><span class="s1">Name </span><span class="s2">| </span><span class="s1">string </span><span class="s2">| </span><span class="s1">number</span><span class="s2">,</span>
  <span class="s1">dataPropType</span><span class="s2">?: </span><span class="s1">Type</span><span class="s2">,</span>
  <span class="s1">jsPropertySyntax</span><span class="s2">?: </span><span class="s1">boolean</span>
<span class="s2">): </span><span class="s1">Code </span><span class="s2">| </span><span class="s1">string </span><span class="s2">{</span>
  <span class="s4">// let path</span>
  <span class="s0">if </span><span class="s2">(</span><span class="s1">dataProp </span><span class="s0">instanceof </span><span class="s1">Name</span><span class="s2">) {</span>
    <span class="s0">const </span><span class="s1">isNumber </span><span class="s2">= </span><span class="s1">dataPropType </span><span class="s2">=== </span><span class="s1">Type</span><span class="s2">.</span><span class="s1">Num</span>
    <span class="s0">return </span><span class="s1">jsPropertySyntax</span>
      <span class="s2">? </span><span class="s1">isNumber</span>
        <span class="s2">? </span><span class="s1">_</span><span class="s3">`&quot;[&quot; + </span><span class="s1">$</span><span class="s2">{</span><span class="s1">dataProp</span><span class="s2">} </span><span class="s3">+ &quot;]&quot;`</span>
        <span class="s2">: </span><span class="s1">_</span><span class="s3">`&quot;['&quot; + </span><span class="s1">$</span><span class="s2">{</span><span class="s1">dataProp</span><span class="s2">} </span><span class="s3">+ &quot;']&quot;`</span>
      <span class="s2">: </span><span class="s1">isNumber</span>
      <span class="s2">? </span><span class="s1">_</span><span class="s3">`&quot;/&quot; + </span><span class="s1">$</span><span class="s2">{</span><span class="s1">dataProp</span><span class="s2">}</span><span class="s3">`</span>
      <span class="s2">: </span><span class="s1">_</span><span class="s3">`&quot;/&quot; + </span><span class="s1">$</span><span class="s2">{</span><span class="s1">dataProp</span><span class="s2">}</span><span class="s3">.replace(/~/g, &quot;~0&quot;).replace(/</span><span class="s0">\\</span><span class="s3">//g, &quot;~1&quot;)` </span><span class="s4">// TODO maybe use global escapePointer</span>
  <span class="s2">}</span>
  <span class="s0">return </span><span class="s1">jsPropertySyntax </span><span class="s2">? </span><span class="s1">getProperty</span><span class="s2">(</span><span class="s1">dataProp</span><span class="s2">).</span><span class="s1">toString</span><span class="s2">() : </span><span class="s3">&quot;/&quot; </span><span class="s2">+ </span><span class="s1">escapeJsonPointer</span><span class="s2">(</span><span class="s1">dataProp</span><span class="s2">)</span>
<span class="s2">}</span>

<span class="s0">export function </span><span class="s1">checkStrictMode</span><span class="s2">(</span>
  <span class="s1">it</span><span class="s2">: </span><span class="s1">SchemaCxt</span><span class="s2">,</span>
  <span class="s1">msg</span><span class="s2">: </span><span class="s1">string</span><span class="s2">,</span>
  <span class="s1">mode</span><span class="s2">: </span><span class="s1">boolean </span><span class="s2">| </span><span class="s3">&quot;log&quot; </span><span class="s2">= </span><span class="s1">it</span><span class="s2">.</span><span class="s1">opts</span><span class="s2">.</span><span class="s1">strictSchema</span>
<span class="s2">): </span><span class="s0">void </span><span class="s2">{</span>
  <span class="s0">if </span><span class="s2">(!</span><span class="s1">mode</span><span class="s2">) </span><span class="s0">return</span>
  <span class="s1">msg </span><span class="s2">= </span><span class="s3">`strict mode: </span><span class="s1">$</span><span class="s2">{</span><span class="s1">msg</span><span class="s2">}</span><span class="s3">`</span>
  <span class="s0">if </span><span class="s2">(</span><span class="s1">mode </span><span class="s2">=== </span><span class="s0">true</span><span class="s2">) </span><span class="s0">throw new </span><span class="s1">Error</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)</span>
  <span class="s1">it</span><span class="s2">.</span><span class="s1">self</span><span class="s2">.</span><span class="s1">logger</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)</span>
<span class="s2">}</span>
</pre>
</body>
</html>