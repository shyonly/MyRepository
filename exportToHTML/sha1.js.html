<html>
<head>
<title>sha1.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #67a37c; font-style: italic;}
.s2 { color: #bcbec4;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #7a7e85;}
.s7 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
sha1.js</font>
</center></td></tr></table>
<pre><span class="s0">/**</span>
 <span class="s0">* Secure Hash Algorithm with 160-bit digest (SHA-1) implementation.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@author </span><span class="s0">Dave Longley</span>
 <span class="s0">*</span>
 <span class="s0">* Copyright (c) 2010-2015 Digital Bazaar, Inc.</span>
 <span class="s0">*/</span>
<span class="s3">var </span><span class="s2">forge </span><span class="s4">= </span><span class="s2">require</span><span class="s4">(</span><span class="s5">'./forge'</span><span class="s4">);</span>
<span class="s2">require</span><span class="s4">(</span><span class="s5">'./md'</span><span class="s4">);</span>
<span class="s2">require</span><span class="s4">(</span><span class="s5">'./util'</span><span class="s4">);</span>

<span class="s3">var </span><span class="s2">sha1 </span><span class="s4">= </span><span class="s2">module</span><span class="s4">.</span><span class="s2">exports </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">sha1 </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">sha1 </span><span class="s4">|| {};</span>
<span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">sha1 </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">md</span><span class="s4">.</span><span class="s2">algorithms</span><span class="s4">.</span><span class="s2">sha1 </span><span class="s4">= </span><span class="s2">sha1</span><span class="s4">;</span>

<span class="s0">/**</span>
 <span class="s0">* Creates a SHA-1 message digest object.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@return </span><span class="s0">a message digest object.</span>
 <span class="s0">*/</span>
<span class="s2">sha1</span><span class="s4">.</span><span class="s2">create </span><span class="s4">= </span><span class="s3">function</span><span class="s4">() {</span>
  <span class="s6">// do initialization as necessary</span>
  <span class="s3">if</span><span class="s4">(!</span><span class="s2">_initialized</span><span class="s4">) {</span>
    <span class="s2">_init</span><span class="s4">();</span>
  <span class="s4">}</span>

  <span class="s6">// SHA-1 state contains five 32-bit integers</span>
  <span class="s3">var </span><span class="s2">_state </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>

  <span class="s6">// input buffer</span>
  <span class="s3">var </span><span class="s2">_input </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>

  <span class="s6">// used for word storage</span>
  <span class="s3">var </span><span class="s2">_w </span><span class="s4">= </span><span class="s3">new </span><span class="s2">Array</span><span class="s4">(</span><span class="s7">80</span><span class="s4">);</span>

  <span class="s6">// message digest object</span>
  <span class="s3">var </span><span class="s2">md </span><span class="s4">= {</span>
    <span class="s2">algorithm</span><span class="s4">: </span><span class="s5">'sha1'</span><span class="s4">,</span>
    <span class="s2">blockLength</span><span class="s4">: </span><span class="s7">64</span><span class="s4">,</span>
    <span class="s2">digestLength</span><span class="s4">: </span><span class="s7">20</span><span class="s4">,</span>
    <span class="s6">// 56-bit length of message so far (does not including padding)</span>
    <span class="s2">messageLength</span><span class="s4">: </span><span class="s7">0</span><span class="s4">,</span>
    <span class="s6">// true message length</span>
    <span class="s2">fullMessageLength</span><span class="s4">: </span><span class="s3">null</span><span class="s4">,</span>
    <span class="s6">// size of message length in bytes</span>
    <span class="s2">messageLengthSize</span><span class="s4">: </span><span class="s7">8</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Starts the digest.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@return </span><span class="s0">this digest object.</span>
   <span class="s0">*/</span>
  <span class="s2">md</span><span class="s4">.</span><span class="s2">start </span><span class="s4">= </span><span class="s3">function</span><span class="s4">() {</span>
    <span class="s6">// up to 56-bit message length for convenience</span>
    <span class="s2">md</span><span class="s4">.</span><span class="s2">messageLength </span><span class="s4">= </span><span class="s7">0</span><span class="s4">;</span>

    <span class="s6">// full message length (set md.messageLength64 for backwards-compatibility)</span>
    <span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength </span><span class="s4">= </span><span class="s2">md</span><span class="s4">.</span><span class="s2">messageLength64 </span><span class="s4">= [];</span>
    <span class="s3">var </span><span class="s2">int32s </span><span class="s4">= </span><span class="s2">md</span><span class="s4">.</span><span class="s2">messageLengthSize </span><span class="s4">/ </span><span class="s7">4</span><span class="s4">;</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">int32s</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">.</span><span class="s2">push</span><span class="s4">(</span><span class="s7">0</span><span class="s4">);</span>
    <span class="s4">}</span>
    <span class="s2">_input </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
    <span class="s2">_state </span><span class="s4">= {</span>
      <span class="s2">h0</span><span class="s4">: </span><span class="s7">0x67452301</span><span class="s4">,</span>
      <span class="s2">h1</span><span class="s4">: </span><span class="s7">0xEFCDAB89</span><span class="s4">,</span>
      <span class="s2">h2</span><span class="s4">: </span><span class="s7">0x98BADCFE</span><span class="s4">,</span>
      <span class="s2">h3</span><span class="s4">: </span><span class="s7">0x10325476</span><span class="s4">,</span>
      <span class="s2">h4</span><span class="s4">: </span><span class="s7">0xC3D2E1F0</span>
    <span class="s4">};</span>
    <span class="s3">return </span><span class="s2">md</span><span class="s4">;</span>
  <span class="s4">};</span>
  <span class="s6">// start digest automatically for first time</span>
  <span class="s2">md</span><span class="s4">.</span><span class="s2">start</span><span class="s4">();</span>

  <span class="s0">/**</span>
   <span class="s0">* Updates the digest with the given message input. The given input can</span>
   <span class="s0">* treated as raw input (no encoding will be applied) or an encoding of</span>
   <span class="s0">* 'utf8' maybe given to encode the input using UTF-8.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">msg the message input to update with.</span>
   <span class="s0">* </span><span class="s1">@param </span><span class="s0">encoding the encoding to use (default: 'raw', other: 'utf8').</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@return </span><span class="s0">this digest object.</span>
   <span class="s0">*/</span>
  <span class="s2">md</span><span class="s4">.</span><span class="s2">update </span><span class="s4">= </span><span class="s3">function</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">, </span><span class="s2">encoding</span><span class="s4">) {</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">encoding </span><span class="s4">=== </span><span class="s5">'utf8'</span><span class="s4">) {</span>
      <span class="s2">msg </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">encodeUtf8</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">);</span>
    <span class="s4">}</span>

    <span class="s6">// update message length</span>
    <span class="s3">var </span><span class="s2">len </span><span class="s4">= </span><span class="s2">msg</span><span class="s4">.</span><span class="s2">length</span><span class="s4">;</span>
    <span class="s2">md</span><span class="s4">.</span><span class="s2">messageLength </span><span class="s4">+= </span><span class="s2">len</span><span class="s4">;</span>
    <span class="s2">len </span><span class="s4">= [(</span><span class="s2">len </span><span class="s4">/ </span><span class="s7">0x100000000</span><span class="s4">) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">, </span><span class="s2">len </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">];</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">.</span><span class="s2">length </span><span class="s4">- </span><span class="s7">1</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&gt;= </span><span class="s7">0</span><span class="s4">; --</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">[</span><span class="s2">i</span><span class="s4">] += </span><span class="s2">len</span><span class="s4">[</span><span class="s7">1</span><span class="s4">];</span>
      <span class="s2">len</span><span class="s4">[</span><span class="s7">1</span><span class="s4">] = </span><span class="s2">len</span><span class="s4">[</span><span class="s7">0</span><span class="s4">] + ((</span><span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">[</span><span class="s2">i</span><span class="s4">] / </span><span class="s7">0x100000000</span><span class="s4">) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">);</span>
      <span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">[</span><span class="s2">i</span><span class="s4">] = </span><span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">[</span><span class="s2">i</span><span class="s4">] &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
      <span class="s2">len</span><span class="s4">[</span><span class="s7">0</span><span class="s4">] = ((</span><span class="s2">len</span><span class="s4">[</span><span class="s7">1</span><span class="s4">] / </span><span class="s7">0x100000000</span><span class="s4">) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">);</span>
    <span class="s4">}</span>

    <span class="s6">// add bytes to input buffer</span>
    <span class="s2">_input</span><span class="s4">.</span><span class="s2">putBytes</span><span class="s4">(</span><span class="s2">msg</span><span class="s4">);</span>

    <span class="s6">// process bytes</span>
    <span class="s2">_update</span><span class="s4">(</span><span class="s2">_state</span><span class="s4">, </span><span class="s2">_w</span><span class="s4">, </span><span class="s2">_input</span><span class="s4">);</span>

    <span class="s6">// compact input buffer every 2K or if empty</span>
    <span class="s3">if</span><span class="s4">(</span><span class="s2">_input</span><span class="s4">.</span><span class="s2">read </span><span class="s4">&gt; </span><span class="s7">2048 </span><span class="s4">|| </span><span class="s2">_input</span><span class="s4">.</span><span class="s2">length</span><span class="s4">() === </span><span class="s7">0</span><span class="s4">) {</span>
      <span class="s2">_input</span><span class="s4">.</span><span class="s2">compact</span><span class="s4">();</span>
    <span class="s4">}</span>

    <span class="s3">return </span><span class="s2">md</span><span class="s4">;</span>
  <span class="s4">};</span>

  <span class="s0">/**</span>
   <span class="s0">* Produces the digest.</span>
   <span class="s0">*</span>
   <span class="s0">* </span><span class="s1">@return </span><span class="s0">a byte buffer containing the digest value.</span>
   <span class="s0">*/</span>
  <span class="s2">md</span><span class="s4">.</span><span class="s2">digest </span><span class="s4">= </span><span class="s3">function</span><span class="s4">() {</span>
    <span class="s6">/* Note: Here we copy the remaining bytes in the input buffer and 
    add the appropriate SHA-1 padding. Then we do the final update 
    on a copy of the state so that if the user wants to get 
    intermediate digests they can do so. */</span>

    <span class="s6">/* Determine the number of bytes that must be added to the message 
    to ensure its length is congruent to 448 mod 512. In other words, 
    the data to be digested must be a multiple of 512 bits (or 128 bytes). 
    This data includes the message, some padding, and the length of the 
    message. Since the length of the message will be encoded as 8 bytes (64 
    bits), that means that the last segment of the data must have 56 bytes 
    (448 bits) of message and padding. Therefore, the length of the message 
    plus the padding must be congruent to 448 mod 512 because 
    512 - 128 = 448. 
 
    In order to fill up the message length it must be filled with 
    padding that begins with 1 bit followed by all 0 bits. Padding 
    must *always* be present, so if the message length is already 
    congruent to 448 mod 512, then 512 padding bits must be added. */</span>

    <span class="s3">var </span><span class="s2">finalBlock </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
    <span class="s2">finalBlock</span><span class="s4">.</span><span class="s2">putBytes</span><span class="s4">(</span><span class="s2">_input</span><span class="s4">.</span><span class="s2">bytes</span><span class="s4">());</span>

    <span class="s6">// compute remaining size to be digested (include message length size)</span>
    <span class="s3">var </span><span class="s2">remaining </span><span class="s4">= (</span>
      <span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">[</span><span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">.</span><span class="s2">length </span><span class="s4">- </span><span class="s7">1</span><span class="s4">] +</span>
      <span class="s2">md</span><span class="s4">.</span><span class="s2">messageLengthSize</span><span class="s4">);</span>

    <span class="s6">// add padding for overflow blockSize - overflow</span>
    <span class="s6">// _padding starts with 1 byte with first bit is set (byte value 128), then</span>
    <span class="s6">// there may be up to (blockSize - 1) other pad bytes</span>
    <span class="s3">var </span><span class="s2">overflow </span><span class="s4">= </span><span class="s2">remaining </span><span class="s4">&amp; (</span><span class="s2">md</span><span class="s4">.</span><span class="s2">blockLength </span><span class="s4">- </span><span class="s7">1</span><span class="s4">);</span>
    <span class="s2">finalBlock</span><span class="s4">.</span><span class="s2">putBytes</span><span class="s4">(</span><span class="s2">_padding</span><span class="s4">.</span><span class="s2">substr</span><span class="s4">(</span><span class="s7">0</span><span class="s4">, </span><span class="s2">md</span><span class="s4">.</span><span class="s2">blockLength </span><span class="s4">- </span><span class="s2">overflow</span><span class="s4">));</span>

    <span class="s6">// serialize message length in bits in big-endian order; since length</span>
    <span class="s6">// is stored in bytes we multiply by 8 and add carry from next int</span>
    <span class="s3">var </span><span class="s2">next</span><span class="s4">, </span><span class="s2">carry</span><span class="s4">;</span>
    <span class="s3">var </span><span class="s2">bits </span><span class="s4">= </span><span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">[</span><span class="s7">0</span><span class="s4">] * </span><span class="s7">8</span><span class="s4">;</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s3">var </span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">.</span><span class="s2">length </span><span class="s4">- </span><span class="s7">1</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s2">next </span><span class="s4">= </span><span class="s2">md</span><span class="s4">.</span><span class="s2">fullMessageLength</span><span class="s4">[</span><span class="s2">i </span><span class="s4">+ </span><span class="s7">1</span><span class="s4">] * </span><span class="s7">8</span><span class="s4">;</span>
      <span class="s2">carry </span><span class="s4">= (</span><span class="s2">next </span><span class="s4">/ </span><span class="s7">0x100000000</span><span class="s4">) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
      <span class="s2">bits </span><span class="s4">+= </span><span class="s2">carry</span><span class="s4">;</span>
      <span class="s2">finalBlock</span><span class="s4">.</span><span class="s2">putInt32</span><span class="s4">(</span><span class="s2">bits </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">);</span>
      <span class="s2">bits </span><span class="s4">= </span><span class="s2">next </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s2">finalBlock</span><span class="s4">.</span><span class="s2">putInt32</span><span class="s4">(</span><span class="s2">bits</span><span class="s4">);</span>

    <span class="s3">var </span><span class="s2">s2 </span><span class="s4">= {</span>
      <span class="s2">h0</span><span class="s4">: </span><span class="s2">_state</span><span class="s4">.</span><span class="s2">h0</span><span class="s4">,</span>
      <span class="s2">h1</span><span class="s4">: </span><span class="s2">_state</span><span class="s4">.</span><span class="s2">h1</span><span class="s4">,</span>
      <span class="s2">h2</span><span class="s4">: </span><span class="s2">_state</span><span class="s4">.</span><span class="s2">h2</span><span class="s4">,</span>
      <span class="s2">h3</span><span class="s4">: </span><span class="s2">_state</span><span class="s4">.</span><span class="s2">h3</span><span class="s4">,</span>
      <span class="s2">h4</span><span class="s4">: </span><span class="s2">_state</span><span class="s4">.</span><span class="s2">h4</span>
    <span class="s4">};</span>
    <span class="s2">_update</span><span class="s4">(</span><span class="s2">s2</span><span class="s4">, </span><span class="s2">_w</span><span class="s4">, </span><span class="s2">finalBlock</span><span class="s4">);</span>
    <span class="s3">var </span><span class="s2">rval </span><span class="s4">= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">createBuffer</span><span class="s4">();</span>
    <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt32</span><span class="s4">(</span><span class="s2">s2</span><span class="s4">.</span><span class="s2">h0</span><span class="s4">);</span>
    <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt32</span><span class="s4">(</span><span class="s2">s2</span><span class="s4">.</span><span class="s2">h1</span><span class="s4">);</span>
    <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt32</span><span class="s4">(</span><span class="s2">s2</span><span class="s4">.</span><span class="s2">h2</span><span class="s4">);</span>
    <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt32</span><span class="s4">(</span><span class="s2">s2</span><span class="s4">.</span><span class="s2">h3</span><span class="s4">);</span>
    <span class="s2">rval</span><span class="s4">.</span><span class="s2">putInt32</span><span class="s4">(</span><span class="s2">s2</span><span class="s4">.</span><span class="s2">h4</span><span class="s4">);</span>
    <span class="s3">return </span><span class="s2">rval</span><span class="s4">;</span>
  <span class="s4">};</span>

  <span class="s3">return </span><span class="s2">md</span><span class="s4">;</span>
<span class="s4">};</span>

<span class="s6">// sha-1 padding bytes not initialized yet</span>
<span class="s3">var </span><span class="s2">_padding </span><span class="s4">= </span><span class="s3">null</span><span class="s4">;</span>
<span class="s3">var </span><span class="s2">_initialized </span><span class="s4">= </span><span class="s3">false</span><span class="s4">;</span>

<span class="s0">/**</span>
 <span class="s0">* Initializes the constant tables.</span>
 <span class="s0">*/</span>
<span class="s3">function </span><span class="s2">_init</span><span class="s4">() {</span>
  <span class="s6">// create padding</span>
  <span class="s2">_padding </span><span class="s4">= </span><span class="s2">String</span><span class="s4">.</span><span class="s2">fromCharCode</span><span class="s4">(</span><span class="s7">128</span><span class="s4">);</span>
  <span class="s2">_padding </span><span class="s4">+= </span><span class="s2">forge</span><span class="s4">.</span><span class="s2">util</span><span class="s4">.</span><span class="s2">fillString</span><span class="s4">(</span><span class="s2">String</span><span class="s4">.</span><span class="s2">fromCharCode</span><span class="s4">(</span><span class="s7">0x00</span><span class="s4">), </span><span class="s7">64</span><span class="s4">);</span>

  <span class="s6">// now initialized</span>
  <span class="s2">_initialized </span><span class="s4">= </span><span class="s3">true</span><span class="s4">;</span>
<span class="s4">}</span>

<span class="s0">/**</span>
 <span class="s0">* Updates a SHA-1 state with the given byte buffer.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">s the SHA-1 state to update.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">w the array to use to store words.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">bytes the byte buffer to update with.</span>
 <span class="s0">*/</span>
<span class="s3">function </span><span class="s2">_update</span><span class="s4">(</span><span class="s2">s</span><span class="s4">, </span><span class="s2">w</span><span class="s4">, </span><span class="s2">bytes</span><span class="s4">) {</span>
  <span class="s6">// consume 512 bit (64 byte) chunks</span>
  <span class="s3">var </span><span class="s2">t</span><span class="s4">, </span><span class="s2">a</span><span class="s4">, </span><span class="s2">b</span><span class="s4">, </span><span class="s2">c</span><span class="s4">, </span><span class="s2">d</span><span class="s4">, </span><span class="s2">e</span><span class="s4">, </span><span class="s2">f</span><span class="s4">, </span><span class="s2">i</span><span class="s4">;</span>
  <span class="s3">var </span><span class="s2">len </span><span class="s4">= </span><span class="s2">bytes</span><span class="s4">.</span><span class="s2">length</span><span class="s4">();</span>
  <span class="s3">while</span><span class="s4">(</span><span class="s2">len </span><span class="s4">&gt;= </span><span class="s7">64</span><span class="s4">) {</span>
    <span class="s6">// the w array will be populated with sixteen 32-bit big-endian words</span>
    <span class="s6">// and then extended into 80 32-bit words according to SHA-1 algorithm</span>
    <span class="s6">// and for 32-79 using Max Locktyukhin's optimization</span>

    <span class="s6">// initialize hash value for this chunk</span>
    <span class="s2">a </span><span class="s4">= </span><span class="s2">s</span><span class="s4">.</span><span class="s2">h0</span><span class="s4">;</span>
    <span class="s2">b </span><span class="s4">= </span><span class="s2">s</span><span class="s4">.</span><span class="s2">h1</span><span class="s4">;</span>
    <span class="s2">c </span><span class="s4">= </span><span class="s2">s</span><span class="s4">.</span><span class="s2">h2</span><span class="s4">;</span>
    <span class="s2">d </span><span class="s4">= </span><span class="s2">s</span><span class="s4">.</span><span class="s2">h3</span><span class="s4">;</span>
    <span class="s2">e </span><span class="s4">= </span><span class="s2">s</span><span class="s4">.</span><span class="s2">h4</span><span class="s4">;</span>

    <span class="s6">// round 1</span>
    <span class="s3">for</span><span class="s4">(</span><span class="s2">i </span><span class="s4">= </span><span class="s7">0</span><span class="s4">; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s7">16</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s2">t </span><span class="s4">= </span><span class="s2">bytes</span><span class="s4">.</span><span class="s2">getInt32</span><span class="s4">();</span>
      <span class="s2">w</span><span class="s4">[</span><span class="s2">i</span><span class="s4">] = </span><span class="s2">t</span><span class="s4">;</span>
      <span class="s2">f </span><span class="s4">= </span><span class="s2">d </span><span class="s4">^ (</span><span class="s2">b </span><span class="s4">&amp; (</span><span class="s2">c </span><span class="s4">^ </span><span class="s2">d</span><span class="s4">));</span>
      <span class="s2">t </span><span class="s4">= ((</span><span class="s2">a </span><span class="s4">&lt;&lt; </span><span class="s7">5</span><span class="s4">) | (</span><span class="s2">a </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">27</span><span class="s4">)) + </span><span class="s2">f </span><span class="s4">+ </span><span class="s2">e </span><span class="s4">+ </span><span class="s7">0x5A827999 </span><span class="s4">+ </span><span class="s2">t</span><span class="s4">;</span>
      <span class="s2">e </span><span class="s4">= </span><span class="s2">d</span><span class="s4">;</span>
      <span class="s2">d </span><span class="s4">= </span><span class="s2">c</span><span class="s4">;</span>
      <span class="s6">// `&gt;&gt;&gt; 0` necessary to avoid iOS/Safari 10 optimization bug</span>
      <span class="s2">c </span><span class="s4">= ((</span><span class="s2">b </span><span class="s4">&lt;&lt; </span><span class="s7">30</span><span class="s4">) | (</span><span class="s2">b </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">2</span><span class="s4">)) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
      <span class="s2">b </span><span class="s4">= </span><span class="s2">a</span><span class="s4">;</span>
      <span class="s2">a </span><span class="s4">= </span><span class="s2">t</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s3">for</span><span class="s4">(; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s7">20</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s2">t </span><span class="s4">= (</span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">3</span><span class="s4">] ^ </span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">8</span><span class="s4">] ^ </span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">14</span><span class="s4">] ^ </span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">16</span><span class="s4">]);</span>
      <span class="s2">t </span><span class="s4">= (</span><span class="s2">t </span><span class="s4">&lt;&lt; </span><span class="s7">1</span><span class="s4">) | (</span><span class="s2">t </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">31</span><span class="s4">);</span>
      <span class="s2">w</span><span class="s4">[</span><span class="s2">i</span><span class="s4">] = </span><span class="s2">t</span><span class="s4">;</span>
      <span class="s2">f </span><span class="s4">= </span><span class="s2">d </span><span class="s4">^ (</span><span class="s2">b </span><span class="s4">&amp; (</span><span class="s2">c </span><span class="s4">^ </span><span class="s2">d</span><span class="s4">));</span>
      <span class="s2">t </span><span class="s4">= ((</span><span class="s2">a </span><span class="s4">&lt;&lt; </span><span class="s7">5</span><span class="s4">) | (</span><span class="s2">a </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">27</span><span class="s4">)) + </span><span class="s2">f </span><span class="s4">+ </span><span class="s2">e </span><span class="s4">+ </span><span class="s7">0x5A827999 </span><span class="s4">+ </span><span class="s2">t</span><span class="s4">;</span>
      <span class="s2">e </span><span class="s4">= </span><span class="s2">d</span><span class="s4">;</span>
      <span class="s2">d </span><span class="s4">= </span><span class="s2">c</span><span class="s4">;</span>
      <span class="s6">// `&gt;&gt;&gt; 0` necessary to avoid iOS/Safari 10 optimization bug</span>
      <span class="s2">c </span><span class="s4">= ((</span><span class="s2">b </span><span class="s4">&lt;&lt; </span><span class="s7">30</span><span class="s4">) | (</span><span class="s2">b </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">2</span><span class="s4">)) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
      <span class="s2">b </span><span class="s4">= </span><span class="s2">a</span><span class="s4">;</span>
      <span class="s2">a </span><span class="s4">= </span><span class="s2">t</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s6">// round 2</span>
    <span class="s3">for</span><span class="s4">(; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s7">32</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s2">t </span><span class="s4">= (</span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">3</span><span class="s4">] ^ </span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">8</span><span class="s4">] ^ </span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">14</span><span class="s4">] ^ </span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">16</span><span class="s4">]);</span>
      <span class="s2">t </span><span class="s4">= (</span><span class="s2">t </span><span class="s4">&lt;&lt; </span><span class="s7">1</span><span class="s4">) | (</span><span class="s2">t </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">31</span><span class="s4">);</span>
      <span class="s2">w</span><span class="s4">[</span><span class="s2">i</span><span class="s4">] = </span><span class="s2">t</span><span class="s4">;</span>
      <span class="s2">f </span><span class="s4">= </span><span class="s2">b </span><span class="s4">^ </span><span class="s2">c </span><span class="s4">^ </span><span class="s2">d</span><span class="s4">;</span>
      <span class="s2">t </span><span class="s4">= ((</span><span class="s2">a </span><span class="s4">&lt;&lt; </span><span class="s7">5</span><span class="s4">) | (</span><span class="s2">a </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">27</span><span class="s4">)) + </span><span class="s2">f </span><span class="s4">+ </span><span class="s2">e </span><span class="s4">+ </span><span class="s7">0x6ED9EBA1 </span><span class="s4">+ </span><span class="s2">t</span><span class="s4">;</span>
      <span class="s2">e </span><span class="s4">= </span><span class="s2">d</span><span class="s4">;</span>
      <span class="s2">d </span><span class="s4">= </span><span class="s2">c</span><span class="s4">;</span>
      <span class="s6">// `&gt;&gt;&gt; 0` necessary to avoid iOS/Safari 10 optimization bug</span>
      <span class="s2">c </span><span class="s4">= ((</span><span class="s2">b </span><span class="s4">&lt;&lt; </span><span class="s7">30</span><span class="s4">) | (</span><span class="s2">b </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">2</span><span class="s4">)) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
      <span class="s2">b </span><span class="s4">= </span><span class="s2">a</span><span class="s4">;</span>
      <span class="s2">a </span><span class="s4">= </span><span class="s2">t</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s3">for</span><span class="s4">(; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s7">40</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s2">t </span><span class="s4">= (</span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">6</span><span class="s4">] ^ </span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">16</span><span class="s4">] ^ </span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">28</span><span class="s4">] ^ </span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">32</span><span class="s4">]);</span>
      <span class="s2">t </span><span class="s4">= (</span><span class="s2">t </span><span class="s4">&lt;&lt; </span><span class="s7">2</span><span class="s4">) | (</span><span class="s2">t </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">30</span><span class="s4">);</span>
      <span class="s2">w</span><span class="s4">[</span><span class="s2">i</span><span class="s4">] = </span><span class="s2">t</span><span class="s4">;</span>
      <span class="s2">f </span><span class="s4">= </span><span class="s2">b </span><span class="s4">^ </span><span class="s2">c </span><span class="s4">^ </span><span class="s2">d</span><span class="s4">;</span>
      <span class="s2">t </span><span class="s4">= ((</span><span class="s2">a </span><span class="s4">&lt;&lt; </span><span class="s7">5</span><span class="s4">) | (</span><span class="s2">a </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">27</span><span class="s4">)) + </span><span class="s2">f </span><span class="s4">+ </span><span class="s2">e </span><span class="s4">+ </span><span class="s7">0x6ED9EBA1 </span><span class="s4">+ </span><span class="s2">t</span><span class="s4">;</span>
      <span class="s2">e </span><span class="s4">= </span><span class="s2">d</span><span class="s4">;</span>
      <span class="s2">d </span><span class="s4">= </span><span class="s2">c</span><span class="s4">;</span>
      <span class="s6">// `&gt;&gt;&gt; 0` necessary to avoid iOS/Safari 10 optimization bug</span>
      <span class="s2">c </span><span class="s4">= ((</span><span class="s2">b </span><span class="s4">&lt;&lt; </span><span class="s7">30</span><span class="s4">) | (</span><span class="s2">b </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">2</span><span class="s4">)) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
      <span class="s2">b </span><span class="s4">= </span><span class="s2">a</span><span class="s4">;</span>
      <span class="s2">a </span><span class="s4">= </span><span class="s2">t</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s6">// round 3</span>
    <span class="s3">for</span><span class="s4">(; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s7">60</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s2">t </span><span class="s4">= (</span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">6</span><span class="s4">] ^ </span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">16</span><span class="s4">] ^ </span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">28</span><span class="s4">] ^ </span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">32</span><span class="s4">]);</span>
      <span class="s2">t </span><span class="s4">= (</span><span class="s2">t </span><span class="s4">&lt;&lt; </span><span class="s7">2</span><span class="s4">) | (</span><span class="s2">t </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">30</span><span class="s4">);</span>
      <span class="s2">w</span><span class="s4">[</span><span class="s2">i</span><span class="s4">] = </span><span class="s2">t</span><span class="s4">;</span>
      <span class="s2">f </span><span class="s4">= (</span><span class="s2">b </span><span class="s4">&amp; </span><span class="s2">c</span><span class="s4">) | (</span><span class="s2">d </span><span class="s4">&amp; (</span><span class="s2">b </span><span class="s4">^ </span><span class="s2">c</span><span class="s4">));</span>
      <span class="s2">t </span><span class="s4">= ((</span><span class="s2">a </span><span class="s4">&lt;&lt; </span><span class="s7">5</span><span class="s4">) | (</span><span class="s2">a </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">27</span><span class="s4">)) + </span><span class="s2">f </span><span class="s4">+ </span><span class="s2">e </span><span class="s4">+ </span><span class="s7">0x8F1BBCDC </span><span class="s4">+ </span><span class="s2">t</span><span class="s4">;</span>
      <span class="s2">e </span><span class="s4">= </span><span class="s2">d</span><span class="s4">;</span>
      <span class="s2">d </span><span class="s4">= </span><span class="s2">c</span><span class="s4">;</span>
      <span class="s6">// `&gt;&gt;&gt; 0` necessary to avoid iOS/Safari 10 optimization bug</span>
      <span class="s2">c </span><span class="s4">= ((</span><span class="s2">b </span><span class="s4">&lt;&lt; </span><span class="s7">30</span><span class="s4">) | (</span><span class="s2">b </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">2</span><span class="s4">)) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
      <span class="s2">b </span><span class="s4">= </span><span class="s2">a</span><span class="s4">;</span>
      <span class="s2">a </span><span class="s4">= </span><span class="s2">t</span><span class="s4">;</span>
    <span class="s4">}</span>
    <span class="s6">// round 4</span>
    <span class="s3">for</span><span class="s4">(; </span><span class="s2">i </span><span class="s4">&lt; </span><span class="s7">80</span><span class="s4">; ++</span><span class="s2">i</span><span class="s4">) {</span>
      <span class="s2">t </span><span class="s4">= (</span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">6</span><span class="s4">] ^ </span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">16</span><span class="s4">] ^ </span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">28</span><span class="s4">] ^ </span><span class="s2">w</span><span class="s4">[</span><span class="s2">i </span><span class="s4">- </span><span class="s7">32</span><span class="s4">]);</span>
      <span class="s2">t </span><span class="s4">= (</span><span class="s2">t </span><span class="s4">&lt;&lt; </span><span class="s7">2</span><span class="s4">) | (</span><span class="s2">t </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">30</span><span class="s4">);</span>
      <span class="s2">w</span><span class="s4">[</span><span class="s2">i</span><span class="s4">] = </span><span class="s2">t</span><span class="s4">;</span>
      <span class="s2">f </span><span class="s4">= </span><span class="s2">b </span><span class="s4">^ </span><span class="s2">c </span><span class="s4">^ </span><span class="s2">d</span><span class="s4">;</span>
      <span class="s2">t </span><span class="s4">= ((</span><span class="s2">a </span><span class="s4">&lt;&lt; </span><span class="s7">5</span><span class="s4">) | (</span><span class="s2">a </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">27</span><span class="s4">)) + </span><span class="s2">f </span><span class="s4">+ </span><span class="s2">e </span><span class="s4">+ </span><span class="s7">0xCA62C1D6 </span><span class="s4">+ </span><span class="s2">t</span><span class="s4">;</span>
      <span class="s2">e </span><span class="s4">= </span><span class="s2">d</span><span class="s4">;</span>
      <span class="s2">d </span><span class="s4">= </span><span class="s2">c</span><span class="s4">;</span>
      <span class="s6">// `&gt;&gt;&gt; 0` necessary to avoid iOS/Safari 10 optimization bug</span>
      <span class="s2">c </span><span class="s4">= ((</span><span class="s2">b </span><span class="s4">&lt;&lt; </span><span class="s7">30</span><span class="s4">) | (</span><span class="s2">b </span><span class="s4">&gt;&gt;&gt; </span><span class="s7">2</span><span class="s4">)) &gt;&gt;&gt; </span><span class="s7">0</span><span class="s4">;</span>
      <span class="s2">b </span><span class="s4">= </span><span class="s2">a</span><span class="s4">;</span>
      <span class="s2">a </span><span class="s4">= </span><span class="s2">t</span><span class="s4">;</span>
    <span class="s4">}</span>

    <span class="s6">// update hash state</span>
    <span class="s2">s</span><span class="s4">.</span><span class="s2">h0 </span><span class="s4">= (</span><span class="s2">s</span><span class="s4">.</span><span class="s2">h0 </span><span class="s4">+ </span><span class="s2">a</span><span class="s4">) | </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s2">s</span><span class="s4">.</span><span class="s2">h1 </span><span class="s4">= (</span><span class="s2">s</span><span class="s4">.</span><span class="s2">h1 </span><span class="s4">+ </span><span class="s2">b</span><span class="s4">) | </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s2">s</span><span class="s4">.</span><span class="s2">h2 </span><span class="s4">= (</span><span class="s2">s</span><span class="s4">.</span><span class="s2">h2 </span><span class="s4">+ </span><span class="s2">c</span><span class="s4">) | </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s2">s</span><span class="s4">.</span><span class="s2">h3 </span><span class="s4">= (</span><span class="s2">s</span><span class="s4">.</span><span class="s2">h3 </span><span class="s4">+ </span><span class="s2">d</span><span class="s4">) | </span><span class="s7">0</span><span class="s4">;</span>
    <span class="s2">s</span><span class="s4">.</span><span class="s2">h4 </span><span class="s4">= (</span><span class="s2">s</span><span class="s4">.</span><span class="s2">h4 </span><span class="s4">+ </span><span class="s2">e</span><span class="s4">) | </span><span class="s7">0</span><span class="s4">;</span>

    <span class="s2">len </span><span class="s4">-= </span><span class="s7">64</span><span class="s4">;</span>
  <span class="s4">}</span>
<span class="s4">}</span>
</pre>
</body>
</html>