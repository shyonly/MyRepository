<html>
<head>
<title>form_data.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #67a37c; font-style: italic;}
.s7 { color: #2aacb8;}
.s8 { color: #42c3d4;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
form_data.js</font>
</center></td></tr></table>
<pre><span class="s0">var </span><span class="s1">CombinedStream </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'combined-stream'</span><span class="s2">);</span>
<span class="s0">var </span><span class="s1">util </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'util'</span><span class="s2">);</span>
<span class="s0">var </span><span class="s1">path </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'path'</span><span class="s2">);</span>
<span class="s0">var </span><span class="s1">http </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'http'</span><span class="s2">);</span>
<span class="s0">var </span><span class="s1">https </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'https'</span><span class="s2">);</span>
<span class="s0">var </span><span class="s1">parseUrl </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'url'</span><span class="s2">).</span><span class="s1">parse</span><span class="s2">;</span>
<span class="s0">var </span><span class="s1">fs </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'fs'</span><span class="s2">);</span>
<span class="s0">var </span><span class="s1">Stream </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'stream'</span><span class="s2">).</span><span class="s1">Stream</span><span class="s2">;</span>
<span class="s0">var </span><span class="s1">mime </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'mime-types'</span><span class="s2">);</span>
<span class="s0">var </span><span class="s1">asynckit </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'asynckit'</span><span class="s2">);</span>
<span class="s0">var </span><span class="s1">populate </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'./populate.js'</span><span class="s2">);</span>

<span class="s4">// Public API</span>
<span class="s1">module</span><span class="s2">.</span><span class="s1">exports </span><span class="s2">= </span><span class="s1">FormData</span><span class="s2">;</span>

<span class="s4">// make it a Stream</span>
<span class="s1">util</span><span class="s2">.</span><span class="s1">inherits</span><span class="s2">(</span><span class="s1">FormData</span><span class="s2">, </span><span class="s1">CombinedStream</span><span class="s2">);</span>

<span class="s5">/**</span>
 <span class="s5">* Create readable &quot;multipart/form-data&quot; streams.</span>
 <span class="s5">* Can be used to submit forms</span>
 <span class="s5">* and file uploads to other web applications.</span>
 <span class="s5">*</span>
 <span class="s5">* </span><span class="s6">@constructor</span>
 <span class="s5">* </span><span class="s6">@param </span><span class="s5">{Object} options - Properties to be added/overriden for FormData and CombinedStream</span>
 <span class="s5">*/</span>
<span class="s0">function </span><span class="s1">FormData</span><span class="s2">(</span><span class="s1">options</span><span class="s2">) {</span>
  <span class="s0">if </span><span class="s2">(!(</span><span class="s0">this instanceof </span><span class="s1">FormData</span><span class="s2">)) {</span>
    <span class="s0">return new </span><span class="s1">FormData</span><span class="s2">(</span><span class="s1">options</span><span class="s2">);</span>
  <span class="s2">}</span>

  <span class="s0">this</span><span class="s2">.</span><span class="s1">_overheadLength </span><span class="s2">= </span><span class="s7">0</span><span class="s2">;</span>
  <span class="s0">this</span><span class="s2">.</span><span class="s1">_valueLength </span><span class="s2">= </span><span class="s7">0</span><span class="s2">;</span>
  <span class="s0">this</span><span class="s2">.</span><span class="s1">_valuesToMeasure </span><span class="s2">= [];</span>

  <span class="s1">CombinedStream</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s0">this</span><span class="s2">);</span>

  <span class="s1">options </span><span class="s2">= </span><span class="s1">options </span><span class="s2">|| {};</span>
  <span class="s0">for </span><span class="s2">(</span><span class="s0">var </span><span class="s1">option </span><span class="s0">in </span><span class="s1">options</span><span class="s2">) {</span>
    <span class="s0">this</span><span class="s2">[</span><span class="s1">option</span><span class="s2">] = </span><span class="s1">options</span><span class="s2">[</span><span class="s1">option</span><span class="s2">];</span>
  <span class="s2">}</span>
<span class="s2">}</span>

<span class="s1">FormData</span><span class="s2">.</span><span class="s1">LINE_BREAK </span><span class="s2">= </span><span class="s3">'</span><span class="s0">\r\n</span><span class="s3">'</span><span class="s2">;</span>
<span class="s1">FormData</span><span class="s2">.</span><span class="s1">DEFAULT_CONTENT_TYPE </span><span class="s2">= </span><span class="s3">'application/octet-stream'</span><span class="s2">;</span>

<span class="s1">FormData</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">append </span><span class="s2">= </span><span class="s0">function</span><span class="s2">(</span><span class="s1">field</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">options</span><span class="s2">) {</span>

  <span class="s1">options </span><span class="s2">= </span><span class="s1">options </span><span class="s2">|| {};</span>

  <span class="s4">// allow filename as single option</span>
  <span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">options </span><span class="s2">== </span><span class="s3">'string'</span><span class="s2">) {</span>
    <span class="s1">options </span><span class="s2">= {</span><span class="s1">filename</span><span class="s2">: </span><span class="s1">options</span><span class="s2">};</span>
  <span class="s2">}</span>

  <span class="s0">var </span><span class="s1">append </span><span class="s2">= </span><span class="s1">CombinedStream</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">append</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s0">this</span><span class="s2">);</span>

  <span class="s4">// all that streamy business can't handle numbers</span>
  <span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">value </span><span class="s2">== </span><span class="s3">'number'</span><span class="s2">) {</span>
    <span class="s1">value </span><span class="s2">= </span><span class="s3">'' </span><span class="s2">+ </span><span class="s1">value</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s4">// https://github.com/felixge/node-form-data/issues/38</span>
  <span class="s0">if </span><span class="s2">(</span><span class="s1">util</span><span class="s2">.</span><span class="s1">isArray</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)) {</span>
    <span class="s4">// Please convert your array into string</span>
    <span class="s4">// the way web server expects it</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_error</span><span class="s2">(</span><span class="s0">new </span><span class="s1">Error</span><span class="s2">(</span><span class="s3">'Arrays are not supported.'</span><span class="s2">));</span>
    <span class="s0">return</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s0">var </span><span class="s1">header </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_multiPartHeader</span><span class="s2">(</span><span class="s1">field</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">options</span><span class="s2">);</span>
  <span class="s0">var </span><span class="s1">footer </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_multiPartFooter</span><span class="s2">();</span>

  <span class="s1">append</span><span class="s2">(</span><span class="s1">header</span><span class="s2">);</span>
  <span class="s1">append</span><span class="s2">(</span><span class="s1">value</span><span class="s2">);</span>
  <span class="s1">append</span><span class="s2">(</span><span class="s1">footer</span><span class="s2">);</span>

  <span class="s4">// pass along options.knownLength</span>
  <span class="s0">this</span><span class="s2">.</span><span class="s1">_trackLength</span><span class="s2">(</span><span class="s1">header</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">options</span><span class="s2">);</span>
<span class="s2">};</span>

<span class="s1">FormData</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">_trackLength </span><span class="s2">= </span><span class="s0">function</span><span class="s2">(</span><span class="s1">header</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">options</span><span class="s2">) {</span>
  <span class="s0">var </span><span class="s1">valueLength </span><span class="s2">= </span><span class="s7">0</span><span class="s2">;</span>

  <span class="s4">// used w/ getLengthSync(), when length is known.</span>
  <span class="s4">// e.g. for streaming directly from a remote server,</span>
  <span class="s4">// w/ a known file a size, and not wanting to wait for</span>
  <span class="s4">// incoming file to finish to get its size.</span>
  <span class="s0">if </span><span class="s2">(</span><span class="s1">options</span><span class="s2">.</span><span class="s1">knownLength </span><span class="s2">!= </span><span class="s0">null</span><span class="s2">) {</span>
    <span class="s1">valueLength </span><span class="s2">+= +</span><span class="s1">options</span><span class="s2">.</span><span class="s1">knownLength</span><span class="s2">;</span>
  <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">Buffer</span><span class="s2">.</span><span class="s1">isBuffer</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)) {</span>
    <span class="s1">valueLength </span><span class="s2">= </span><span class="s1">value</span><span class="s2">.</span><span class="s1">length</span><span class="s2">;</span>
  <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">value </span><span class="s2">=== </span><span class="s3">'string'</span><span class="s2">) {</span>
    <span class="s1">valueLength </span><span class="s2">= </span><span class="s1">Buffer</span><span class="s2">.</span><span class="s1">byteLength</span><span class="s2">(</span><span class="s1">value</span><span class="s2">);</span>
  <span class="s2">}</span>

  <span class="s0">this</span><span class="s2">.</span><span class="s1">_valueLength </span><span class="s2">+= </span><span class="s1">valueLength</span><span class="s2">;</span>

  <span class="s4">// @check why add CRLF? does this account for custom/multiple CRLFs?</span>
  <span class="s0">this</span><span class="s2">.</span><span class="s1">_overheadLength </span><span class="s2">+=</span>
    <span class="s1">Buffer</span><span class="s2">.</span><span class="s1">byteLength</span><span class="s2">(</span><span class="s1">header</span><span class="s2">) +</span>
    <span class="s1">FormData</span><span class="s2">.</span><span class="s1">LINE_BREAK</span><span class="s2">.</span><span class="s1">length</span><span class="s2">;</span>

  <span class="s4">// empty or either doesn't have path or not an http response or not a stream</span>
  <span class="s0">if </span><span class="s2">(!</span><span class="s1">value </span><span class="s2">|| ( !</span><span class="s1">value</span><span class="s2">.</span><span class="s1">path </span><span class="s2">&amp;&amp; !(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">readable </span><span class="s2">&amp;&amp; </span><span class="s1">value</span><span class="s2">.</span><span class="s1">hasOwnProperty</span><span class="s2">(</span><span class="s3">'httpVersion'</span><span class="s2">)) &amp;&amp; !(</span><span class="s1">value </span><span class="s0">instanceof </span><span class="s1">Stream</span><span class="s2">))) {</span>
    <span class="s0">return</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s4">// no need to bother with the length</span>
  <span class="s0">if </span><span class="s2">(!</span><span class="s1">options</span><span class="s2">.</span><span class="s1">knownLength</span><span class="s2">) {</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_valuesToMeasure</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">value</span><span class="s2">);</span>
  <span class="s2">}</span>
<span class="s2">};</span>

<span class="s1">FormData</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">_lengthRetriever </span><span class="s2">= </span><span class="s0">function</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">) {</span>

  <span class="s0">if </span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">hasOwnProperty</span><span class="s2">(</span><span class="s3">'fd'</span><span class="s2">)) {</span>

    <span class="s4">// take read range into a account</span>
    <span class="s4">// `end` = Infinity â€“&gt; read file till the end</span>
    <span class="s4">//</span>
    <span class="s4">// TODO: Looks like there is bug in Node fs.createReadStream</span>
    <span class="s4">// it doesn't respect `end` options without `start` options</span>
    <span class="s4">// Fix it when node fixes it.</span>
    <span class="s4">// https://github.com/joyent/node/issues/7819</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">end </span><span class="s2">!= </span><span class="s1">undefined </span><span class="s2">&amp;&amp; </span><span class="s1">value</span><span class="s2">.</span><span class="s1">end </span><span class="s2">!= </span><span class="s1">Infinity </span><span class="s2">&amp;&amp; </span><span class="s1">value</span><span class="s2">.</span><span class="s1">start </span><span class="s2">!= </span><span class="s1">undefined</span><span class="s2">) {</span>

      <span class="s4">// when end specified</span>
      <span class="s4">// no need to calculate range</span>
      <span class="s4">// inclusive, starts with 0</span>
      <span class="s1">callback</span><span class="s2">(</span><span class="s0">null</span><span class="s2">, </span><span class="s1">value</span><span class="s2">.</span><span class="s1">end </span><span class="s2">+ </span><span class="s7">1 </span><span class="s2">- (</span><span class="s1">value</span><span class="s2">.</span><span class="s1">start </span><span class="s2">? </span><span class="s1">value</span><span class="s2">.</span><span class="s1">start </span><span class="s2">: </span><span class="s7">0</span><span class="s2">));</span>

    <span class="s4">// not that fast snoopy</span>
    <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
      <span class="s4">// still need to fetch file size from fs</span>
      <span class="s1">fs</span><span class="s2">.</span><span class="s1">stat</span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">path</span><span class="s2">, </span><span class="s0">function</span><span class="s2">(</span><span class="s1">err</span><span class="s2">, </span><span class="s1">stat</span><span class="s2">) {</span>

        <span class="s0">var </span><span class="s1">fileSize</span><span class="s2">;</span>

        <span class="s0">if </span><span class="s2">(</span><span class="s1">err</span><span class="s2">) {</span>
          <span class="s1">callback</span><span class="s2">(</span><span class="s1">err</span><span class="s2">);</span>
          <span class="s0">return</span><span class="s2">;</span>
        <span class="s2">}</span>

        <span class="s4">// update final size based on the range options</span>
        <span class="s1">fileSize </span><span class="s2">= </span><span class="s1">stat</span><span class="s2">.</span><span class="s1">size </span><span class="s2">- (</span><span class="s1">value</span><span class="s2">.</span><span class="s1">start </span><span class="s2">? </span><span class="s1">value</span><span class="s2">.</span><span class="s1">start </span><span class="s2">: </span><span class="s7">0</span><span class="s2">);</span>
        <span class="s1">callback</span><span class="s2">(</span><span class="s0">null</span><span class="s2">, </span><span class="s1">fileSize</span><span class="s2">);</span>
      <span class="s2">});</span>
    <span class="s2">}</span>

  <span class="s4">// or http response</span>
  <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">hasOwnProperty</span><span class="s2">(</span><span class="s3">'httpVersion'</span><span class="s2">)) {</span>
    <span class="s1">callback</span><span class="s2">(</span><span class="s0">null</span><span class="s2">, +</span><span class="s1">value</span><span class="s2">.</span><span class="s1">headers</span><span class="s2">[</span><span class="s3">'content-length'</span><span class="s2">]);</span>

  <span class="s4">// or request stream http://github.com/mikeal/request</span>
  <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">hasOwnProperty</span><span class="s2">(</span><span class="s3">'httpModule'</span><span class="s2">)) {</span>
    <span class="s4">// wait till response come back</span>
    <span class="s1">value</span><span class="s2">.</span><span class="s1">on</span><span class="s2">(</span><span class="s3">'response'</span><span class="s2">, </span><span class="s0">function</span><span class="s2">(</span><span class="s1">response</span><span class="s2">) {</span>
      <span class="s1">value</span><span class="s2">.</span><span class="s1">pause</span><span class="s2">();</span>
      <span class="s1">callback</span><span class="s2">(</span><span class="s0">null</span><span class="s2">, +</span><span class="s1">response</span><span class="s2">.</span><span class="s1">headers</span><span class="s2">[</span><span class="s3">'content-length'</span><span class="s2">]);</span>
    <span class="s2">});</span>
    <span class="s1">value</span><span class="s2">.</span><span class="s1">resume</span><span class="s2">();</span>

  <span class="s4">// something else</span>
  <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
    <span class="s1">callback</span><span class="s2">(</span><span class="s3">'Unknown stream'</span><span class="s2">);</span>
  <span class="s2">}</span>
<span class="s2">};</span>

<span class="s1">FormData</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">_multiPartHeader </span><span class="s2">= </span><span class="s0">function</span><span class="s2">(</span><span class="s1">field</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">options</span><span class="s2">) {</span>
  <span class="s4">// custom header specified (as string)?</span>
  <span class="s4">// it becomes responsible for boundary</span>
  <span class="s4">// (e.g. to handle extra CRLFs on .NET servers)</span>
  <span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">options</span><span class="s2">.</span><span class="s1">header </span><span class="s2">== </span><span class="s3">'string'</span><span class="s2">) {</span>
    <span class="s0">return </span><span class="s1">options</span><span class="s2">.</span><span class="s1">header</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s0">var </span><span class="s1">contentDisposition </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_getContentDisposition</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">options</span><span class="s2">);</span>
  <span class="s0">var </span><span class="s1">contentType </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_getContentType</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">options</span><span class="s2">);</span>

  <span class="s0">var </span><span class="s1">contents </span><span class="s2">= </span><span class="s3">''</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">headers  </span><span class="s2">= {</span>
    <span class="s4">// add custom disposition as third element or keep it two elements if not</span>
    <span class="s3">'Content-Disposition'</span><span class="s2">: [</span><span class="s3">'form-data'</span><span class="s2">, </span><span class="s3">'name=&quot;' </span><span class="s2">+ </span><span class="s1">field </span><span class="s2">+ </span><span class="s3">'&quot;'</span><span class="s2">].</span><span class="s1">concat</span><span class="s2">(</span><span class="s1">contentDisposition </span><span class="s2">|| []),</span>
    <span class="s4">// if no content type. allow it to be empty array</span>
    <span class="s3">'Content-Type'</span><span class="s2">: [].</span><span class="s1">concat</span><span class="s2">(</span><span class="s1">contentType </span><span class="s2">|| [])</span>
  <span class="s2">};</span>

  <span class="s4">// allow custom headers.</span>
  <span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">options</span><span class="s2">.</span><span class="s1">header </span><span class="s2">== </span><span class="s3">'object'</span><span class="s2">) {</span>
    <span class="s1">populate</span><span class="s2">(</span><span class="s1">headers</span><span class="s2">, </span><span class="s1">options</span><span class="s2">.</span><span class="s1">header</span><span class="s2">);</span>
  <span class="s2">}</span>

  <span class="s0">var </span><span class="s1">header</span><span class="s2">;</span>
  <span class="s0">for </span><span class="s2">(</span><span class="s0">var </span><span class="s1">prop </span><span class="s0">in </span><span class="s1">headers</span><span class="s2">) {</span>
    <span class="s0">if </span><span class="s2">(!</span><span class="s1">headers</span><span class="s2">.</span><span class="s1">hasOwnProperty</span><span class="s2">(</span><span class="s1">prop</span><span class="s2">)) </span><span class="s0">continue</span><span class="s2">;</span>
    <span class="s1">header </span><span class="s2">= </span><span class="s1">headers</span><span class="s2">[</span><span class="s1">prop</span><span class="s2">];</span>

    <span class="s4">// skip nullish headers.</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">header </span><span class="s2">== </span><span class="s0">null</span><span class="s2">) {</span>
      <span class="s0">continue</span><span class="s2">;</span>
    <span class="s2">}</span>

    <span class="s4">// convert all headers to arrays.</span>
    <span class="s0">if </span><span class="s2">(!</span><span class="s1">Array</span><span class="s2">.</span><span class="s1">isArray</span><span class="s2">(</span><span class="s1">header</span><span class="s2">)) {</span>
      <span class="s1">header </span><span class="s2">= [</span><span class="s1">header</span><span class="s2">];</span>
    <span class="s2">}</span>

    <span class="s4">// add non-empty headers.</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">header</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) {</span>
      <span class="s1">contents </span><span class="s2">+= </span><span class="s1">prop </span><span class="s2">+ </span><span class="s3">': ' </span><span class="s2">+ </span><span class="s1">header</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s3">'; '</span><span class="s2">) + </span><span class="s1">FormData</span><span class="s2">.</span><span class="s1">LINE_BREAK</span><span class="s2">;</span>
    <span class="s2">}</span>
  <span class="s2">}</span>

  <span class="s0">return </span><span class="s3">'--' </span><span class="s2">+ </span><span class="s0">this</span><span class="s2">.</span><span class="s1">getBoundary</span><span class="s2">() + </span><span class="s1">FormData</span><span class="s2">.</span><span class="s1">LINE_BREAK </span><span class="s2">+ </span><span class="s1">contents </span><span class="s2">+ </span><span class="s1">FormData</span><span class="s2">.</span><span class="s1">LINE_BREAK</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">FormData</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">_getContentDisposition </span><span class="s2">= </span><span class="s0">function</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">options</span><span class="s2">) {</span>

  <span class="s0">var </span><span class="s1">filename</span>
    <span class="s2">, </span><span class="s1">contentDisposition</span>
    <span class="s2">;</span>

  <span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">options</span><span class="s2">.</span><span class="s1">filepath </span><span class="s2">=== </span><span class="s3">'string'</span><span class="s2">) {</span>
    <span class="s4">// custom filepath for relative paths</span>
    <span class="s1">filename </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">normalize</span><span class="s2">(</span><span class="s1">options</span><span class="s2">.</span><span class="s1">filepath</span><span class="s2">).</span><span class="s1">replace</span><span class="s2">(</span><span class="s8">/\\/g</span><span class="s2">, </span><span class="s3">'/'</span><span class="s2">);</span>
  <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">options</span><span class="s2">.</span><span class="s1">filename </span><span class="s2">|| </span><span class="s1">value</span><span class="s2">.</span><span class="s1">name </span><span class="s2">|| </span><span class="s1">value</span><span class="s2">.</span><span class="s1">path</span><span class="s2">) {</span>
    <span class="s4">// custom filename take precedence</span>
    <span class="s4">// formidable and the browser add a name property</span>
    <span class="s4">// fs- and request- streams have path property</span>
    <span class="s1">filename </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">basename</span><span class="s2">(</span><span class="s1">options</span><span class="s2">.</span><span class="s1">filename </span><span class="s2">|| </span><span class="s1">value</span><span class="s2">.</span><span class="s1">name </span><span class="s2">|| </span><span class="s1">value</span><span class="s2">.</span><span class="s1">path</span><span class="s2">);</span>
  <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">readable </span><span class="s2">&amp;&amp; </span><span class="s1">value</span><span class="s2">.</span><span class="s1">hasOwnProperty</span><span class="s2">(</span><span class="s3">'httpVersion'</span><span class="s2">)) {</span>
    <span class="s4">// or try http response</span>
    <span class="s1">filename </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">basename</span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">client</span><span class="s2">.</span><span class="s1">_httpMessage</span><span class="s2">.</span><span class="s1">path </span><span class="s2">|| </span><span class="s3">''</span><span class="s2">);</span>
  <span class="s2">}</span>

  <span class="s0">if </span><span class="s2">(</span><span class="s1">filename</span><span class="s2">) {</span>
    <span class="s1">contentDisposition </span><span class="s2">= </span><span class="s3">'filename=&quot;' </span><span class="s2">+ </span><span class="s1">filename </span><span class="s2">+ </span><span class="s3">'&quot;'</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s0">return </span><span class="s1">contentDisposition</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">FormData</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">_getContentType </span><span class="s2">= </span><span class="s0">function</span><span class="s2">(</span><span class="s1">value</span><span class="s2">, </span><span class="s1">options</span><span class="s2">) {</span>

  <span class="s4">// use custom content-type above all</span>
  <span class="s0">var </span><span class="s1">contentType </span><span class="s2">= </span><span class="s1">options</span><span class="s2">.</span><span class="s1">contentType</span><span class="s2">;</span>

  <span class="s4">// or try `name` from formidable, browser</span>
  <span class="s0">if </span><span class="s2">(!</span><span class="s1">contentType </span><span class="s2">&amp;&amp; </span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">) {</span>
    <span class="s1">contentType </span><span class="s2">= </span><span class="s1">mime</span><span class="s2">.</span><span class="s1">lookup</span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">name</span><span class="s2">);</span>
  <span class="s2">}</span>

  <span class="s4">// or try `path` from fs-, request- streams</span>
  <span class="s0">if </span><span class="s2">(!</span><span class="s1">contentType </span><span class="s2">&amp;&amp; </span><span class="s1">value</span><span class="s2">.</span><span class="s1">path</span><span class="s2">) {</span>
    <span class="s1">contentType </span><span class="s2">= </span><span class="s1">mime</span><span class="s2">.</span><span class="s1">lookup</span><span class="s2">(</span><span class="s1">value</span><span class="s2">.</span><span class="s1">path</span><span class="s2">);</span>
  <span class="s2">}</span>

  <span class="s4">// or if it's http-reponse</span>
  <span class="s0">if </span><span class="s2">(!</span><span class="s1">contentType </span><span class="s2">&amp;&amp; </span><span class="s1">value</span><span class="s2">.</span><span class="s1">readable </span><span class="s2">&amp;&amp; </span><span class="s1">value</span><span class="s2">.</span><span class="s1">hasOwnProperty</span><span class="s2">(</span><span class="s3">'httpVersion'</span><span class="s2">)) {</span>
    <span class="s1">contentType </span><span class="s2">= </span><span class="s1">value</span><span class="s2">.</span><span class="s1">headers</span><span class="s2">[</span><span class="s3">'content-type'</span><span class="s2">];</span>
  <span class="s2">}</span>

  <span class="s4">// or guess it from the filepath or filename</span>
  <span class="s0">if </span><span class="s2">(!</span><span class="s1">contentType </span><span class="s2">&amp;&amp; (</span><span class="s1">options</span><span class="s2">.</span><span class="s1">filepath </span><span class="s2">|| </span><span class="s1">options</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">)) {</span>
    <span class="s1">contentType </span><span class="s2">= </span><span class="s1">mime</span><span class="s2">.</span><span class="s1">lookup</span><span class="s2">(</span><span class="s1">options</span><span class="s2">.</span><span class="s1">filepath </span><span class="s2">|| </span><span class="s1">options</span><span class="s2">.</span><span class="s1">filename</span><span class="s2">);</span>
  <span class="s2">}</span>

  <span class="s4">// fallback to the default content type if `value` is not simple value</span>
  <span class="s0">if </span><span class="s2">(!</span><span class="s1">contentType </span><span class="s2">&amp;&amp; </span><span class="s0">typeof </span><span class="s1">value </span><span class="s2">== </span><span class="s3">'object'</span><span class="s2">) {</span>
    <span class="s1">contentType </span><span class="s2">= </span><span class="s1">FormData</span><span class="s2">.</span><span class="s1">DEFAULT_CONTENT_TYPE</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s0">return </span><span class="s1">contentType</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">FormData</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">_multiPartFooter </span><span class="s2">= </span><span class="s0">function</span><span class="s2">() {</span>
  <span class="s0">return function</span><span class="s2">(</span><span class="s1">next</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">footer </span><span class="s2">= </span><span class="s1">FormData</span><span class="s2">.</span><span class="s1">LINE_BREAK</span><span class="s2">;</span>

    <span class="s0">var </span><span class="s1">lastPart </span><span class="s2">= (</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_streams</span><span class="s2">.</span><span class="s1">length </span><span class="s2">=== </span><span class="s7">0</span><span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">lastPart</span><span class="s2">) {</span>
      <span class="s1">footer </span><span class="s2">+= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_lastBoundary</span><span class="s2">();</span>
    <span class="s2">}</span>

    <span class="s1">next</span><span class="s2">(</span><span class="s1">footer</span><span class="s2">);</span>
  <span class="s2">}.</span><span class="s1">bind</span><span class="s2">(</span><span class="s0">this</span><span class="s2">);</span>
<span class="s2">};</span>

<span class="s1">FormData</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">_lastBoundary </span><span class="s2">= </span><span class="s0">function</span><span class="s2">() {</span>
  <span class="s0">return </span><span class="s3">'--' </span><span class="s2">+ </span><span class="s0">this</span><span class="s2">.</span><span class="s1">getBoundary</span><span class="s2">() + </span><span class="s3">'--' </span><span class="s2">+ </span><span class="s1">FormData</span><span class="s2">.</span><span class="s1">LINE_BREAK</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">FormData</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">getHeaders </span><span class="s2">= </span><span class="s0">function</span><span class="s2">(</span><span class="s1">userHeaders</span><span class="s2">) {</span>
  <span class="s0">var </span><span class="s1">header</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">formHeaders </span><span class="s2">= {</span>
    <span class="s3">'content-type'</span><span class="s2">: </span><span class="s3">'multipart/form-data; boundary=' </span><span class="s2">+ </span><span class="s0">this</span><span class="s2">.</span><span class="s1">getBoundary</span><span class="s2">()</span>
  <span class="s2">};</span>

  <span class="s0">for </span><span class="s2">(</span><span class="s1">header </span><span class="s0">in </span><span class="s1">userHeaders</span><span class="s2">) {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">userHeaders</span><span class="s2">.</span><span class="s1">hasOwnProperty</span><span class="s2">(</span><span class="s1">header</span><span class="s2">)) {</span>
      <span class="s1">formHeaders</span><span class="s2">[</span><span class="s1">header</span><span class="s2">.</span><span class="s1">toLowerCase</span><span class="s2">()] = </span><span class="s1">userHeaders</span><span class="s2">[</span><span class="s1">header</span><span class="s2">];</span>
    <span class="s2">}</span>
  <span class="s2">}</span>

  <span class="s0">return </span><span class="s1">formHeaders</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">FormData</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">setBoundary </span><span class="s2">= </span><span class="s0">function</span><span class="s2">(</span><span class="s1">boundary</span><span class="s2">) {</span>
  <span class="s0">this</span><span class="s2">.</span><span class="s1">_boundary </span><span class="s2">= </span><span class="s1">boundary</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">FormData</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">getBoundary </span><span class="s2">= </span><span class="s0">function</span><span class="s2">() {</span>
  <span class="s0">if </span><span class="s2">(!</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_boundary</span><span class="s2">) {</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_generateBoundary</span><span class="s2">();</span>
  <span class="s2">}</span>

  <span class="s0">return this</span><span class="s2">.</span><span class="s1">_boundary</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">FormData</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">getBuffer </span><span class="s2">= </span><span class="s0">function</span><span class="s2">() {</span>
  <span class="s0">var </span><span class="s1">dataBuffer </span><span class="s2">= </span><span class="s0">new </span><span class="s1">Buffer</span><span class="s2">.</span><span class="s1">alloc</span><span class="s2">( </span><span class="s7">0 </span><span class="s2">);</span>
  <span class="s0">var </span><span class="s1">boundary </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">getBoundary</span><span class="s2">();</span>

  <span class="s4">// Create the form content. Add Line breaks to the end of data.</span>
  <span class="s0">for </span><span class="s2">(</span><span class="s0">var </span><span class="s1">i </span><span class="s2">= </span><span class="s7">0</span><span class="s2">, </span><span class="s1">len </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_streams</span><span class="s2">.</span><span class="s1">length</span><span class="s2">; </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">; </span><span class="s1">i</span><span class="s2">++) {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">typeof this</span><span class="s2">.</span><span class="s1">_streams</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] !== </span><span class="s3">'function'</span><span class="s2">) {</span>

      <span class="s4">// Add content to the buffer.</span>
      <span class="s0">if</span><span class="s2">(</span><span class="s1">Buffer</span><span class="s2">.</span><span class="s1">isBuffer</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_streams</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])) {</span>
        <span class="s1">dataBuffer </span><span class="s2">= </span><span class="s1">Buffer</span><span class="s2">.</span><span class="s1">concat</span><span class="s2">( [</span><span class="s1">dataBuffer</span><span class="s2">, </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_streams</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]]);</span>
      <span class="s2">}</span><span class="s0">else </span><span class="s2">{</span>
        <span class="s1">dataBuffer </span><span class="s2">= </span><span class="s1">Buffer</span><span class="s2">.</span><span class="s1">concat</span><span class="s2">( [</span><span class="s1">dataBuffer</span><span class="s2">, </span><span class="s1">Buffer</span><span class="s2">.</span><span class="s1">from</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_streams</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])]);</span>
      <span class="s2">}</span>

      <span class="s4">// Add break after content.</span>
      <span class="s0">if </span><span class="s2">(</span><span class="s0">typeof this</span><span class="s2">.</span><span class="s1">_streams</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] !== </span><span class="s3">'string' </span><span class="s2">|| </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_streams</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">substring</span><span class="s2">( </span><span class="s7">2</span><span class="s2">, </span><span class="s1">boundary</span><span class="s2">.</span><span class="s1">length </span><span class="s2">+ </span><span class="s7">2 </span><span class="s2">) !== </span><span class="s1">boundary</span><span class="s2">) {</span>
        <span class="s1">dataBuffer </span><span class="s2">= </span><span class="s1">Buffer</span><span class="s2">.</span><span class="s1">concat</span><span class="s2">( [</span><span class="s1">dataBuffer</span><span class="s2">, </span><span class="s1">Buffer</span><span class="s2">.</span><span class="s1">from</span><span class="s2">(</span><span class="s1">FormData</span><span class="s2">.</span><span class="s1">LINE_BREAK</span><span class="s2">)] );</span>
      <span class="s2">}</span>
    <span class="s2">}</span>
  <span class="s2">}</span>

  <span class="s4">// Add the footer and return the Buffer object.</span>
  <span class="s0">return </span><span class="s1">Buffer</span><span class="s2">.</span><span class="s1">concat</span><span class="s2">( [</span><span class="s1">dataBuffer</span><span class="s2">, </span><span class="s1">Buffer</span><span class="s2">.</span><span class="s1">from</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_lastBoundary</span><span class="s2">())] );</span>
<span class="s2">};</span>

<span class="s1">FormData</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">_generateBoundary </span><span class="s2">= </span><span class="s0">function</span><span class="s2">() {</span>
  <span class="s4">// This generates a 50 character boundary similar to those used by Firefox.</span>
  <span class="s4">// They are optimized for boyer-moore parsing.</span>
  <span class="s0">var </span><span class="s1">boundary </span><span class="s2">= </span><span class="s3">'--------------------------'</span><span class="s2">;</span>
  <span class="s0">for </span><span class="s2">(</span><span class="s0">var </span><span class="s1">i </span><span class="s2">= </span><span class="s7">0</span><span class="s2">; </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s7">24</span><span class="s2">; </span><span class="s1">i</span><span class="s2">++) {</span>
    <span class="s1">boundary </span><span class="s2">+= </span><span class="s1">Math</span><span class="s2">.</span><span class="s1">floor</span><span class="s2">(</span><span class="s1">Math</span><span class="s2">.</span><span class="s1">random</span><span class="s2">() * </span><span class="s7">10</span><span class="s2">).</span><span class="s1">toString</span><span class="s2">(</span><span class="s7">16</span><span class="s2">);</span>
  <span class="s2">}</span>

  <span class="s0">this</span><span class="s2">.</span><span class="s1">_boundary </span><span class="s2">= </span><span class="s1">boundary</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s4">// Note: getLengthSync DOESN'T calculate streams length</span>
<span class="s4">// As workaround one can calculate file size manually</span>
<span class="s4">// and add it as knownLength option</span>
<span class="s1">FormData</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">getLengthSync </span><span class="s2">= </span><span class="s0">function</span><span class="s2">() {</span>
  <span class="s0">var </span><span class="s1">knownLength </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_overheadLength </span><span class="s2">+ </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_valueLength</span><span class="s2">;</span>

  <span class="s4">// Don't get confused, there are 3 &quot;internal&quot; streams for each keyval pair</span>
  <span class="s4">// so it basically checks if there is any value added to the form</span>
  <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_streams</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) {</span>
    <span class="s1">knownLength </span><span class="s2">+= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_lastBoundary</span><span class="s2">().</span><span class="s1">length</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s4">// https://github.com/form-data/form-data/issues/40</span>
  <span class="s0">if </span><span class="s2">(!</span><span class="s0">this</span><span class="s2">.</span><span class="s1">hasKnownLength</span><span class="s2">()) {</span>
    <span class="s4">// Some async length retrievers are present</span>
    <span class="s4">// therefore synchronous length calculation is false.</span>
    <span class="s4">// Please use getLength(callback) to get proper length</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">_error</span><span class="s2">(</span><span class="s0">new </span><span class="s1">Error</span><span class="s2">(</span><span class="s3">'Cannot calculate proper length in synchronous way.'</span><span class="s2">));</span>
  <span class="s2">}</span>

  <span class="s0">return </span><span class="s1">knownLength</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s4">// Public API to check if length of added values is known</span>
<span class="s4">// https://github.com/form-data/form-data/issues/196</span>
<span class="s4">// https://github.com/form-data/form-data/issues/262</span>
<span class="s1">FormData</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">hasKnownLength </span><span class="s2">= </span><span class="s0">function</span><span class="s2">() {</span>
  <span class="s0">var </span><span class="s1">hasKnownLength </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>

  <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_valuesToMeasure</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) {</span>
    <span class="s1">hasKnownLength </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s0">return </span><span class="s1">hasKnownLength</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">FormData</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">getLength </span><span class="s2">= </span><span class="s0">function</span><span class="s2">(</span><span class="s1">cb</span><span class="s2">) {</span>
  <span class="s0">var </span><span class="s1">knownLength </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_overheadLength </span><span class="s2">+ </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_valueLength</span><span class="s2">;</span>

  <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_streams</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) {</span>
    <span class="s1">knownLength </span><span class="s2">+= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_lastBoundary</span><span class="s2">().</span><span class="s1">length</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s0">if </span><span class="s2">(!</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_valuesToMeasure</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) {</span>
    <span class="s1">process</span><span class="s2">.</span><span class="s1">nextTick</span><span class="s2">(</span><span class="s1">cb</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s0">this</span><span class="s2">, </span><span class="s0">null</span><span class="s2">, </span><span class="s1">knownLength</span><span class="s2">));</span>
    <span class="s0">return</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s1">asynckit</span><span class="s2">.</span><span class="s1">parallel</span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">_valuesToMeasure</span><span class="s2">, </span><span class="s0">this</span><span class="s2">.</span><span class="s1">_lengthRetriever</span><span class="s2">, </span><span class="s0">function</span><span class="s2">(</span><span class="s1">err</span><span class="s2">, </span><span class="s1">values</span><span class="s2">) {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">err</span><span class="s2">) {</span>
      <span class="s1">cb</span><span class="s2">(</span><span class="s1">err</span><span class="s2">);</span>
      <span class="s0">return</span><span class="s2">;</span>
    <span class="s2">}</span>

    <span class="s1">values</span><span class="s2">.</span><span class="s1">forEach</span><span class="s2">(</span><span class="s0">function</span><span class="s2">(</span><span class="s1">length</span><span class="s2">) {</span>
      <span class="s1">knownLength </span><span class="s2">+= </span><span class="s1">length</span><span class="s2">;</span>
    <span class="s2">});</span>

    <span class="s1">cb</span><span class="s2">(</span><span class="s0">null</span><span class="s2">, </span><span class="s1">knownLength</span><span class="s2">);</span>
  <span class="s2">});</span>
<span class="s2">};</span>

<span class="s1">FormData</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">submit </span><span class="s2">= </span><span class="s0">function</span><span class="s2">(</span><span class="s1">params</span><span class="s2">, </span><span class="s1">cb</span><span class="s2">) {</span>
  <span class="s0">var </span><span class="s1">request</span>
    <span class="s2">, </span><span class="s1">options</span>
    <span class="s2">, </span><span class="s1">defaults </span><span class="s2">= {</span><span class="s1">method</span><span class="s2">: </span><span class="s3">'post'</span><span class="s2">}</span>
    <span class="s2">;</span>

  <span class="s4">// parse provided url if it's string</span>
  <span class="s4">// or treat it as options object</span>
  <span class="s0">if </span><span class="s2">(</span><span class="s0">typeof </span><span class="s1">params </span><span class="s2">== </span><span class="s3">'string'</span><span class="s2">) {</span>

    <span class="s1">params </span><span class="s2">= </span><span class="s1">parseUrl</span><span class="s2">(</span><span class="s1">params</span><span class="s2">);</span>
    <span class="s1">options </span><span class="s2">= </span><span class="s1">populate</span><span class="s2">({</span>
      <span class="s1">port</span><span class="s2">: </span><span class="s1">params</span><span class="s2">.</span><span class="s1">port</span><span class="s2">,</span>
      <span class="s1">path</span><span class="s2">: </span><span class="s1">params</span><span class="s2">.</span><span class="s1">pathname</span><span class="s2">,</span>
      <span class="s1">host</span><span class="s2">: </span><span class="s1">params</span><span class="s2">.</span><span class="s1">hostname</span><span class="s2">,</span>
      <span class="s1">protocol</span><span class="s2">: </span><span class="s1">params</span><span class="s2">.</span><span class="s1">protocol</span>
    <span class="s2">}, </span><span class="s1">defaults</span><span class="s2">);</span>

  <span class="s4">// use custom params</span>
  <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>

    <span class="s1">options </span><span class="s2">= </span><span class="s1">populate</span><span class="s2">(</span><span class="s1">params</span><span class="s2">, </span><span class="s1">defaults</span><span class="s2">);</span>
    <span class="s4">// if no port provided use default one</span>
    <span class="s0">if </span><span class="s2">(!</span><span class="s1">options</span><span class="s2">.</span><span class="s1">port</span><span class="s2">) {</span>
      <span class="s1">options</span><span class="s2">.</span><span class="s1">port </span><span class="s2">= </span><span class="s1">options</span><span class="s2">.</span><span class="s1">protocol </span><span class="s2">== </span><span class="s3">'https:' </span><span class="s2">? </span><span class="s7">443 </span><span class="s2">: </span><span class="s7">80</span><span class="s2">;</span>
    <span class="s2">}</span>
  <span class="s2">}</span>

  <span class="s4">// put that good code in getHeaders to some use</span>
  <span class="s1">options</span><span class="s2">.</span><span class="s1">headers </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">getHeaders</span><span class="s2">(</span><span class="s1">params</span><span class="s2">.</span><span class="s1">headers</span><span class="s2">);</span>

  <span class="s4">// https if specified, fallback to http in any other case</span>
  <span class="s0">if </span><span class="s2">(</span><span class="s1">options</span><span class="s2">.</span><span class="s1">protocol </span><span class="s2">== </span><span class="s3">'https:'</span><span class="s2">) {</span>
    <span class="s1">request </span><span class="s2">= </span><span class="s1">https</span><span class="s2">.</span><span class="s1">request</span><span class="s2">(</span><span class="s1">options</span><span class="s2">);</span>
  <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
    <span class="s1">request </span><span class="s2">= </span><span class="s1">http</span><span class="s2">.</span><span class="s1">request</span><span class="s2">(</span><span class="s1">options</span><span class="s2">);</span>
  <span class="s2">}</span>

  <span class="s4">// get content length and fire away</span>
  <span class="s0">this</span><span class="s2">.</span><span class="s1">getLength</span><span class="s2">(</span><span class="s0">function</span><span class="s2">(</span><span class="s1">err</span><span class="s2">, </span><span class="s1">length</span><span class="s2">) {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">err </span><span class="s2">&amp;&amp; </span><span class="s1">err </span><span class="s2">!== </span><span class="s3">'Unknown stream'</span><span class="s2">) {</span>
      <span class="s0">this</span><span class="s2">.</span><span class="s1">_error</span><span class="s2">(</span><span class="s1">err</span><span class="s2">);</span>
      <span class="s0">return</span><span class="s2">;</span>
    <span class="s2">}</span>

    <span class="s4">// add content length</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">length</span><span class="s2">) {</span>
      <span class="s1">request</span><span class="s2">.</span><span class="s1">setHeader</span><span class="s2">(</span><span class="s3">'Content-Length'</span><span class="s2">, </span><span class="s1">length</span><span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s0">this</span><span class="s2">.</span><span class="s1">pipe</span><span class="s2">(</span><span class="s1">request</span><span class="s2">);</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">cb</span><span class="s2">) {</span>
      <span class="s0">var </span><span class="s1">onResponse</span><span class="s2">;</span>

      <span class="s0">var </span><span class="s1">callback </span><span class="s2">= </span><span class="s0">function </span><span class="s2">(</span><span class="s1">error</span><span class="s2">, </span><span class="s1">responce</span><span class="s2">) {</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">removeListener</span><span class="s2">(</span><span class="s3">'error'</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">);</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">removeListener</span><span class="s2">(</span><span class="s3">'response'</span><span class="s2">, </span><span class="s1">onResponse</span><span class="s2">);</span>

        <span class="s0">return </span><span class="s1">cb</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s0">this</span><span class="s2">, </span><span class="s1">error</span><span class="s2">, </span><span class="s1">responce</span><span class="s2">);</span>
      <span class="s2">};</span>

      <span class="s1">onResponse </span><span class="s2">= </span><span class="s1">callback</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s0">this</span><span class="s2">, </span><span class="s0">null</span><span class="s2">);</span>

      <span class="s1">request</span><span class="s2">.</span><span class="s1">on</span><span class="s2">(</span><span class="s3">'error'</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">);</span>
      <span class="s1">request</span><span class="s2">.</span><span class="s1">on</span><span class="s2">(</span><span class="s3">'response'</span><span class="s2">, </span><span class="s1">onResponse</span><span class="s2">);</span>
    <span class="s2">}</span>
  <span class="s2">}.</span><span class="s1">bind</span><span class="s2">(</span><span class="s0">this</span><span class="s2">));</span>

  <span class="s0">return </span><span class="s1">request</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">FormData</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">_error </span><span class="s2">= </span><span class="s0">function</span><span class="s2">(</span><span class="s1">err</span><span class="s2">) {</span>
  <span class="s0">if </span><span class="s2">(!</span><span class="s0">this</span><span class="s2">.</span><span class="s1">error</span><span class="s2">) {</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">error </span><span class="s2">= </span><span class="s1">err</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">pause</span><span class="s2">();</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">emit</span><span class="s2">(</span><span class="s3">'error'</span><span class="s2">, </span><span class="s1">err</span><span class="s2">);</span>
  <span class="s2">}</span>
<span class="s2">};</span>

<span class="s1">FormData</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">toString </span><span class="s2">= </span><span class="s0">function </span><span class="s2">() {</span>
  <span class="s0">return </span><span class="s3">'[object FormData]'</span><span class="s2">;</span>
<span class="s2">};</span>
</pre>
</body>
</html>