<html>
<head>
<title>4-restructShorthand.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
4-restructShorthand.js</font>
</center></td></tr></table>
<pre><span class="s0">var </span><span class="s1">List </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'css-tree'</span><span class="s2">).</span><span class="s1">List</span><span class="s2">;</span>
<span class="s0">var </span><span class="s1">generate </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'css-tree'</span><span class="s2">).</span><span class="s1">generate</span><span class="s2">;</span>
<span class="s0">var </span><span class="s1">walk </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'css-tree'</span><span class="s2">).</span><span class="s1">walk</span><span class="s2">;</span>

<span class="s0">var </span><span class="s1">REPLACE </span><span class="s2">= </span><span class="s4">1</span><span class="s2">;</span>
<span class="s0">var </span><span class="s1">REMOVE </span><span class="s2">= </span><span class="s4">2</span><span class="s2">;</span>
<span class="s0">var </span><span class="s1">TOP </span><span class="s2">= </span><span class="s4">0</span><span class="s2">;</span>
<span class="s0">var </span><span class="s1">RIGHT </span><span class="s2">= </span><span class="s4">1</span><span class="s2">;</span>
<span class="s0">var </span><span class="s1">BOTTOM </span><span class="s2">= </span><span class="s4">2</span><span class="s2">;</span>
<span class="s0">var </span><span class="s1">LEFT </span><span class="s2">= </span><span class="s4">3</span><span class="s2">;</span>
<span class="s0">var </span><span class="s1">SIDES </span><span class="s2">= [</span><span class="s3">'top'</span><span class="s2">, </span><span class="s3">'right'</span><span class="s2">, </span><span class="s3">'bottom'</span><span class="s2">, </span><span class="s3">'left'</span><span class="s2">];</span>
<span class="s0">var </span><span class="s1">SIDE </span><span class="s2">= {</span>
    <span class="s3">'margin-top'</span><span class="s2">: </span><span class="s3">'top'</span><span class="s2">,</span>
    <span class="s3">'margin-right'</span><span class="s2">: </span><span class="s3">'right'</span><span class="s2">,</span>
    <span class="s3">'margin-bottom'</span><span class="s2">: </span><span class="s3">'bottom'</span><span class="s2">,</span>
    <span class="s3">'margin-left'</span><span class="s2">: </span><span class="s3">'left'</span><span class="s2">,</span>

    <span class="s3">'padding-top'</span><span class="s2">: </span><span class="s3">'top'</span><span class="s2">,</span>
    <span class="s3">'padding-right'</span><span class="s2">: </span><span class="s3">'right'</span><span class="s2">,</span>
    <span class="s3">'padding-bottom'</span><span class="s2">: </span><span class="s3">'bottom'</span><span class="s2">,</span>
    <span class="s3">'padding-left'</span><span class="s2">: </span><span class="s3">'left'</span><span class="s2">,</span>

    <span class="s3">'border-top-color'</span><span class="s2">: </span><span class="s3">'top'</span><span class="s2">,</span>
    <span class="s3">'border-right-color'</span><span class="s2">: </span><span class="s3">'right'</span><span class="s2">,</span>
    <span class="s3">'border-bottom-color'</span><span class="s2">: </span><span class="s3">'bottom'</span><span class="s2">,</span>
    <span class="s3">'border-left-color'</span><span class="s2">: </span><span class="s3">'left'</span><span class="s2">,</span>
    <span class="s3">'border-top-width'</span><span class="s2">: </span><span class="s3">'top'</span><span class="s2">,</span>
    <span class="s3">'border-right-width'</span><span class="s2">: </span><span class="s3">'right'</span><span class="s2">,</span>
    <span class="s3">'border-bottom-width'</span><span class="s2">: </span><span class="s3">'bottom'</span><span class="s2">,</span>
    <span class="s3">'border-left-width'</span><span class="s2">: </span><span class="s3">'left'</span><span class="s2">,</span>
    <span class="s3">'border-top-style'</span><span class="s2">: </span><span class="s3">'top'</span><span class="s2">,</span>
    <span class="s3">'border-right-style'</span><span class="s2">: </span><span class="s3">'right'</span><span class="s2">,</span>
    <span class="s3">'border-bottom-style'</span><span class="s2">: </span><span class="s3">'bottom'</span><span class="s2">,</span>
    <span class="s3">'border-left-style'</span><span class="s2">: </span><span class="s3">'left'</span>
<span class="s2">};</span>
<span class="s0">var </span><span class="s1">MAIN_PROPERTY </span><span class="s2">= {</span>
    <span class="s3">'margin'</span><span class="s2">: </span><span class="s3">'margin'</span><span class="s2">,</span>
    <span class="s3">'margin-top'</span><span class="s2">: </span><span class="s3">'margin'</span><span class="s2">,</span>
    <span class="s3">'margin-right'</span><span class="s2">: </span><span class="s3">'margin'</span><span class="s2">,</span>
    <span class="s3">'margin-bottom'</span><span class="s2">: </span><span class="s3">'margin'</span><span class="s2">,</span>
    <span class="s3">'margin-left'</span><span class="s2">: </span><span class="s3">'margin'</span><span class="s2">,</span>

    <span class="s3">'padding'</span><span class="s2">: </span><span class="s3">'padding'</span><span class="s2">,</span>
    <span class="s3">'padding-top'</span><span class="s2">: </span><span class="s3">'padding'</span><span class="s2">,</span>
    <span class="s3">'padding-right'</span><span class="s2">: </span><span class="s3">'padding'</span><span class="s2">,</span>
    <span class="s3">'padding-bottom'</span><span class="s2">: </span><span class="s3">'padding'</span><span class="s2">,</span>
    <span class="s3">'padding-left'</span><span class="s2">: </span><span class="s3">'padding'</span><span class="s2">,</span>

    <span class="s3">'border-color'</span><span class="s2">: </span><span class="s3">'border-color'</span><span class="s2">,</span>
    <span class="s3">'border-top-color'</span><span class="s2">: </span><span class="s3">'border-color'</span><span class="s2">,</span>
    <span class="s3">'border-right-color'</span><span class="s2">: </span><span class="s3">'border-color'</span><span class="s2">,</span>
    <span class="s3">'border-bottom-color'</span><span class="s2">: </span><span class="s3">'border-color'</span><span class="s2">,</span>
    <span class="s3">'border-left-color'</span><span class="s2">: </span><span class="s3">'border-color'</span><span class="s2">,</span>
    <span class="s3">'border-width'</span><span class="s2">: </span><span class="s3">'border-width'</span><span class="s2">,</span>
    <span class="s3">'border-top-width'</span><span class="s2">: </span><span class="s3">'border-width'</span><span class="s2">,</span>
    <span class="s3">'border-right-width'</span><span class="s2">: </span><span class="s3">'border-width'</span><span class="s2">,</span>
    <span class="s3">'border-bottom-width'</span><span class="s2">: </span><span class="s3">'border-width'</span><span class="s2">,</span>
    <span class="s3">'border-left-width'</span><span class="s2">: </span><span class="s3">'border-width'</span><span class="s2">,</span>
    <span class="s3">'border-style'</span><span class="s2">: </span><span class="s3">'border-style'</span><span class="s2">,</span>
    <span class="s3">'border-top-style'</span><span class="s2">: </span><span class="s3">'border-style'</span><span class="s2">,</span>
    <span class="s3">'border-right-style'</span><span class="s2">: </span><span class="s3">'border-style'</span><span class="s2">,</span>
    <span class="s3">'border-bottom-style'</span><span class="s2">: </span><span class="s3">'border-style'</span><span class="s2">,</span>
    <span class="s3">'border-left-style'</span><span class="s2">: </span><span class="s3">'border-style'</span>
<span class="s2">};</span>

<span class="s0">function </span><span class="s1">TRBL</span><span class="s2">(</span><span class="s1">name</span><span class="s2">) {</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">iehack </span><span class="s2">= </span><span class="s1">undefined</span><span class="s2">;</span>
    <span class="s0">this</span><span class="s2">.</span><span class="s1">sides </span><span class="s2">= {</span>
        <span class="s3">'top'</span><span class="s2">: </span><span class="s0">null</span><span class="s2">,</span>
        <span class="s3">'right'</span><span class="s2">: </span><span class="s0">null</span><span class="s2">,</span>
        <span class="s3">'bottom'</span><span class="s2">: </span><span class="s0">null</span><span class="s2">,</span>
        <span class="s3">'left'</span><span class="s2">: </span><span class="s0">null</span>
    <span class="s2">};</span>
<span class="s2">}</span>

<span class="s1">TRBL</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">getValueSequence </span><span class="s2">= </span><span class="s0">function</span><span class="s2">(</span><span class="s1">declaration</span><span class="s2">, </span><span class="s1">count</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">values </span><span class="s2">= [];</span>
    <span class="s0">var </span><span class="s1">iehack </span><span class="s2">= </span><span class="s3">''</span><span class="s2">;</span>
    <span class="s0">var </span><span class="s1">hasBadValues </span><span class="s2">= </span><span class="s1">declaration</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">type </span><span class="s2">!== </span><span class="s3">'Value' </span><span class="s2">|| </span><span class="s1">declaration</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">children</span><span class="s2">.</span><span class="s1">some</span><span class="s2">(</span><span class="s0">function</span><span class="s2">(</span><span class="s1">child</span><span class="s2">) {</span>
        <span class="s0">var </span><span class="s1">special </span><span class="s2">= </span><span class="s0">false</span><span class="s2">;</span>

        <span class="s0">switch </span><span class="s2">(</span><span class="s1">child</span><span class="s2">.</span><span class="s1">type</span><span class="s2">) {</span>
            <span class="s0">case </span><span class="s3">'Identifier'</span><span class="s2">:</span>
                <span class="s0">switch </span><span class="s2">(</span><span class="s1">child</span><span class="s2">.</span><span class="s1">name</span><span class="s2">) {</span>
                    <span class="s0">case </span><span class="s3">'</span><span class="s0">\\</span><span class="s3">0'</span><span class="s2">:</span>
                    <span class="s0">case </span><span class="s3">'</span><span class="s0">\\</span><span class="s3">9'</span><span class="s2">:</span>
                        <span class="s1">iehack </span><span class="s2">= </span><span class="s1">child</span><span class="s2">.</span><span class="s1">name</span><span class="s2">;</span>
                        <span class="s0">return</span><span class="s2">;</span>

                    <span class="s0">case </span><span class="s3">'inherit'</span><span class="s2">:</span>
                    <span class="s0">case </span><span class="s3">'initial'</span><span class="s2">:</span>
                    <span class="s0">case </span><span class="s3">'unset'</span><span class="s2">:</span>
                    <span class="s0">case </span><span class="s3">'revert'</span><span class="s2">:</span>
                        <span class="s1">special </span><span class="s2">= </span><span class="s1">child</span><span class="s2">.</span><span class="s1">name</span><span class="s2">;</span>
                        <span class="s0">break</span><span class="s2">;</span>
                <span class="s2">}</span>
                <span class="s0">break</span><span class="s2">;</span>

            <span class="s0">case </span><span class="s3">'Dimension'</span><span class="s2">:</span>
                <span class="s0">switch </span><span class="s2">(</span><span class="s1">child</span><span class="s2">.</span><span class="s1">unit</span><span class="s2">) {</span>
                    <span class="s5">// is not supported until IE11</span>
                    <span class="s0">case </span><span class="s3">'rem'</span><span class="s2">:</span>

                    <span class="s5">// v* units is too buggy across browsers and better</span>
                    <span class="s5">// don't merge values with those units</span>
                    <span class="s0">case </span><span class="s3">'vw'</span><span class="s2">:</span>
                    <span class="s0">case </span><span class="s3">'vh'</span><span class="s2">:</span>
                    <span class="s0">case </span><span class="s3">'vmin'</span><span class="s2">:</span>
                    <span class="s0">case </span><span class="s3">'vmax'</span><span class="s2">:</span>
                    <span class="s0">case </span><span class="s3">'vm'</span><span class="s2">: </span><span class="s5">// IE9 supporting &quot;vm&quot; instead of &quot;vmin&quot;.</span>
                        <span class="s1">special </span><span class="s2">= </span><span class="s1">child</span><span class="s2">.</span><span class="s1">unit</span><span class="s2">;</span>
                        <span class="s0">break</span><span class="s2">;</span>
                <span class="s2">}</span>
                <span class="s0">break</span><span class="s2">;</span>

            <span class="s0">case </span><span class="s3">'Hash'</span><span class="s2">: </span><span class="s5">// color</span>
            <span class="s0">case </span><span class="s3">'Number'</span><span class="s2">:</span>
            <span class="s0">case </span><span class="s3">'Percentage'</span><span class="s2">:</span>
                <span class="s0">break</span><span class="s2">;</span>

            <span class="s0">case </span><span class="s3">'Function'</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s2">(</span><span class="s1">child</span><span class="s2">.</span><span class="s1">name </span><span class="s2">=== </span><span class="s3">'var'</span><span class="s2">) {</span>
                    <span class="s0">return true</span><span class="s2">;</span>
                <span class="s2">}</span>

                <span class="s1">special </span><span class="s2">= </span><span class="s1">child</span><span class="s2">.</span><span class="s1">name</span><span class="s2">;</span>
                <span class="s0">break</span><span class="s2">;</span>

            <span class="s0">case </span><span class="s3">'WhiteSpace'</span><span class="s2">:</span>
                <span class="s0">return false</span><span class="s2">; </span><span class="s5">// ignore space</span>

            <span class="s0">default</span><span class="s2">:</span>
                <span class="s0">return true</span><span class="s2">;  </span><span class="s5">// bad value</span>
        <span class="s2">}</span>

        <span class="s1">values</span><span class="s2">.</span><span class="s1">push</span><span class="s2">({</span>
            <span class="s1">node</span><span class="s2">: </span><span class="s1">child</span><span class="s2">,</span>
            <span class="s1">special</span><span class="s2">: </span><span class="s1">special</span><span class="s2">,</span>
            <span class="s1">important</span><span class="s2">: </span><span class="s1">declaration</span><span class="s2">.</span><span class="s1">important</span>
        <span class="s2">});</span>
    <span class="s2">});</span>

    <span class="s0">if </span><span class="s2">(</span><span class="s1">hasBadValues </span><span class="s2">|| </span><span class="s1">values</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s1">count</span><span class="s2">) {</span>
        <span class="s0">return false</span><span class="s2">;</span>
    <span class="s2">}</span>

    <span class="s0">if </span><span class="s2">(</span><span class="s0">typeof this</span><span class="s2">.</span><span class="s1">iehack </span><span class="s2">=== </span><span class="s3">'string' </span><span class="s2">&amp;&amp; </span><span class="s0">this</span><span class="s2">.</span><span class="s1">iehack </span><span class="s2">!== </span><span class="s1">iehack</span><span class="s2">) {</span>
        <span class="s0">return false</span><span class="s2">;</span>
    <span class="s2">}</span>

    <span class="s0">this</span><span class="s2">.</span><span class="s1">iehack </span><span class="s2">= </span><span class="s1">iehack</span><span class="s2">; </span><span class="s5">// move outside</span>

    <span class="s0">return </span><span class="s1">values</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">TRBL</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">canOverride </span><span class="s2">= </span><span class="s0">function</span><span class="s2">(</span><span class="s1">side</span><span class="s2">, </span><span class="s1">value</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">currentValue </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">sides</span><span class="s2">[</span><span class="s1">side</span><span class="s2">];</span>

    <span class="s0">return </span><span class="s2">!</span><span class="s1">currentValue </span><span class="s2">|| (</span><span class="s1">value</span><span class="s2">.</span><span class="s1">important </span><span class="s2">&amp;&amp; !</span><span class="s1">currentValue</span><span class="s2">.</span><span class="s1">important</span><span class="s2">);</span>
<span class="s2">};</span>

<span class="s1">TRBL</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">add </span><span class="s2">= </span><span class="s0">function</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">declaration</span><span class="s2">) {</span>
    <span class="s0">function </span><span class="s1">attemptToAdd</span><span class="s2">() {</span>
        <span class="s0">var </span><span class="s1">sides </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">sides</span><span class="s2">;</span>
        <span class="s0">var </span><span class="s1">side </span><span class="s2">= </span><span class="s1">SIDE</span><span class="s2">[</span><span class="s1">name</span><span class="s2">];</span>

        <span class="s0">if </span><span class="s2">(</span><span class="s1">side</span><span class="s2">) {</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">side </span><span class="s0">in </span><span class="s1">sides </span><span class="s2">=== </span><span class="s0">false</span><span class="s2">) {</span>
                <span class="s0">return false</span><span class="s2">;</span>
            <span class="s2">}</span>

            <span class="s0">var </span><span class="s1">values </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">getValueSequence</span><span class="s2">(</span><span class="s1">declaration</span><span class="s2">, </span><span class="s4">1</span><span class="s2">);</span>

            <span class="s0">if </span><span class="s2">(!</span><span class="s1">values </span><span class="s2">|| !</span><span class="s1">values</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) {</span>
                <span class="s0">return false</span><span class="s2">;</span>
            <span class="s2">}</span>

            <span class="s5">// can mix only if specials are equal</span>
            <span class="s0">for </span><span class="s2">(</span><span class="s0">var </span><span class="s1">key </span><span class="s0">in </span><span class="s1">sides</span><span class="s2">) {</span>
                <span class="s0">if </span><span class="s2">(</span><span class="s1">sides</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] !== </span><span class="s0">null </span><span class="s2">&amp;&amp; </span><span class="s1">sides</span><span class="s2">[</span><span class="s1">key</span><span class="s2">].</span><span class="s1">special </span><span class="s2">!== </span><span class="s1">values</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">special</span><span class="s2">) {</span>
                    <span class="s0">return false</span><span class="s2">;</span>
                <span class="s2">}</span>
            <span class="s2">}</span>

            <span class="s0">if </span><span class="s2">(!</span><span class="s0">this</span><span class="s2">.</span><span class="s1">canOverride</span><span class="s2">(</span><span class="s1">side</span><span class="s2">, </span><span class="s1">values</span><span class="s2">[</span><span class="s4">0</span><span class="s2">])) {</span>
                <span class="s0">return true</span><span class="s2">;</span>
            <span class="s2">}</span>

            <span class="s1">sides</span><span class="s2">[</span><span class="s1">side</span><span class="s2">] = </span><span class="s1">values</span><span class="s2">[</span><span class="s4">0</span><span class="s2">];</span>
            <span class="s0">return true</span><span class="s2">;</span>
        <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">name </span><span class="s2">=== </span><span class="s0">this</span><span class="s2">.</span><span class="s1">name</span><span class="s2">) {</span>
            <span class="s0">var </span><span class="s1">values </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">getValueSequence</span><span class="s2">(</span><span class="s1">declaration</span><span class="s2">, </span><span class="s4">4</span><span class="s2">);</span>

            <span class="s0">if </span><span class="s2">(!</span><span class="s1">values </span><span class="s2">|| !</span><span class="s1">values</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) {</span>
                <span class="s0">return false</span><span class="s2">;</span>
            <span class="s2">}</span>

            <span class="s0">switch </span><span class="s2">(</span><span class="s1">values</span><span class="s2">.</span><span class="s1">length</span><span class="s2">) {</span>
                <span class="s0">case </span><span class="s4">1</span><span class="s2">:</span>
                    <span class="s1">values</span><span class="s2">[</span><span class="s1">RIGHT</span><span class="s2">] = </span><span class="s1">values</span><span class="s2">[</span><span class="s1">TOP</span><span class="s2">];</span>
                    <span class="s1">values</span><span class="s2">[</span><span class="s1">BOTTOM</span><span class="s2">] = </span><span class="s1">values</span><span class="s2">[</span><span class="s1">TOP</span><span class="s2">];</span>
                    <span class="s1">values</span><span class="s2">[</span><span class="s1">LEFT</span><span class="s2">] = </span><span class="s1">values</span><span class="s2">[</span><span class="s1">TOP</span><span class="s2">];</span>
                    <span class="s0">break</span><span class="s2">;</span>

                <span class="s0">case </span><span class="s4">2</span><span class="s2">:</span>
                    <span class="s1">values</span><span class="s2">[</span><span class="s1">BOTTOM</span><span class="s2">] = </span><span class="s1">values</span><span class="s2">[</span><span class="s1">TOP</span><span class="s2">];</span>
                    <span class="s1">values</span><span class="s2">[</span><span class="s1">LEFT</span><span class="s2">] = </span><span class="s1">values</span><span class="s2">[</span><span class="s1">RIGHT</span><span class="s2">];</span>
                    <span class="s0">break</span><span class="s2">;</span>

                <span class="s0">case </span><span class="s4">3</span><span class="s2">:</span>
                    <span class="s1">values</span><span class="s2">[</span><span class="s1">LEFT</span><span class="s2">] = </span><span class="s1">values</span><span class="s2">[</span><span class="s1">RIGHT</span><span class="s2">];</span>
                    <span class="s0">break</span><span class="s2">;</span>
            <span class="s2">}</span>

            <span class="s5">// can mix only if specials are equal</span>
            <span class="s0">for </span><span class="s2">(</span><span class="s0">var </span><span class="s1">i </span><span class="s2">= </span><span class="s4">0</span><span class="s2">; </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s4">4</span><span class="s2">; </span><span class="s1">i</span><span class="s2">++) {</span>
                <span class="s0">for </span><span class="s2">(</span><span class="s0">var </span><span class="s1">key </span><span class="s0">in </span><span class="s1">sides</span><span class="s2">) {</span>
                    <span class="s0">if </span><span class="s2">(</span><span class="s1">sides</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] !== </span><span class="s0">null </span><span class="s2">&amp;&amp; </span><span class="s1">sides</span><span class="s2">[</span><span class="s1">key</span><span class="s2">].</span><span class="s1">special </span><span class="s2">!== </span><span class="s1">values</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">special</span><span class="s2">) {</span>
                        <span class="s0">return false</span><span class="s2">;</span>
                    <span class="s2">}</span>
                <span class="s2">}</span>
            <span class="s2">}</span>

            <span class="s0">for </span><span class="s2">(</span><span class="s0">var </span><span class="s1">i </span><span class="s2">= </span><span class="s4">0</span><span class="s2">; </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s4">4</span><span class="s2">; </span><span class="s1">i</span><span class="s2">++) {</span>
                <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">canOverride</span><span class="s2">(</span><span class="s1">SIDES</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">values</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])) {</span>
                    <span class="s1">sides</span><span class="s2">[</span><span class="s1">SIDES</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]] = </span><span class="s1">values</span><span class="s2">[</span><span class="s1">i</span><span class="s2">];</span>
                <span class="s2">}</span>
            <span class="s2">}</span>

            <span class="s0">return true</span><span class="s2">;</span>
        <span class="s2">}</span>
    <span class="s2">}</span>

    <span class="s0">if </span><span class="s2">(!</span><span class="s1">attemptToAdd</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s0">this</span><span class="s2">)) {</span>
        <span class="s0">return false</span><span class="s2">;</span>
    <span class="s2">}</span>

    <span class="s5">// TODO: use it when we can refer to several points in source</span>
    <span class="s5">// if (this.loc) {</span>
    <span class="s5">//     this.loc = {</span>
    <span class="s5">//         primary: this.loc,</span>
    <span class="s5">//         merged: declaration.loc</span>
    <span class="s5">//     };</span>
    <span class="s5">// } else {</span>
    <span class="s5">//     this.loc = declaration.loc;</span>
    <span class="s5">// }</span>
    <span class="s0">if </span><span class="s2">(!</span><span class="s0">this</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">) {</span>
        <span class="s0">this</span><span class="s2">.</span><span class="s1">loc </span><span class="s2">= </span><span class="s1">declaration</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">;</span>
    <span class="s2">}</span>

    <span class="s0">return true</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">TRBL</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">isOkToMinimize </span><span class="s2">= </span><span class="s0">function</span><span class="s2">() {</span>
    <span class="s0">var </span><span class="s1">top </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">sides</span><span class="s2">.</span><span class="s1">top</span><span class="s2">;</span>
    <span class="s0">var </span><span class="s1">right </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">sides</span><span class="s2">.</span><span class="s1">right</span><span class="s2">;</span>
    <span class="s0">var </span><span class="s1">bottom </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">sides</span><span class="s2">.</span><span class="s1">bottom</span><span class="s2">;</span>
    <span class="s0">var </span><span class="s1">left </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">sides</span><span class="s2">.</span><span class="s1">left</span><span class="s2">;</span>

    <span class="s0">if </span><span class="s2">(</span><span class="s1">top </span><span class="s2">&amp;&amp; </span><span class="s1">right </span><span class="s2">&amp;&amp; </span><span class="s1">bottom </span><span class="s2">&amp;&amp; </span><span class="s1">left</span><span class="s2">) {</span>
        <span class="s0">var </span><span class="s1">important </span><span class="s2">=</span>
            <span class="s1">top</span><span class="s2">.</span><span class="s1">important </span><span class="s2">+</span>
            <span class="s1">right</span><span class="s2">.</span><span class="s1">important </span><span class="s2">+</span>
            <span class="s1">bottom</span><span class="s2">.</span><span class="s1">important </span><span class="s2">+</span>
            <span class="s1">left</span><span class="s2">.</span><span class="s1">important</span><span class="s2">;</span>

        <span class="s0">return </span><span class="s1">important </span><span class="s2">=== </span><span class="s4">0 </span><span class="s2">|| </span><span class="s1">important </span><span class="s2">=== </span><span class="s4">4</span><span class="s2">;</span>
    <span class="s2">}</span>

    <span class="s0">return false</span><span class="s2">;</span>
<span class="s2">};</span>

<span class="s1">TRBL</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">getValue </span><span class="s2">= </span><span class="s0">function</span><span class="s2">() {</span>
    <span class="s0">var </span><span class="s1">result </span><span class="s2">= </span><span class="s0">new </span><span class="s1">List</span><span class="s2">();</span>
    <span class="s0">var </span><span class="s1">sides </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">sides</span><span class="s2">;</span>
    <span class="s0">var </span><span class="s1">values </span><span class="s2">= [</span>
        <span class="s1">sides</span><span class="s2">.</span><span class="s1">top</span><span class="s2">,</span>
        <span class="s1">sides</span><span class="s2">.</span><span class="s1">right</span><span class="s2">,</span>
        <span class="s1">sides</span><span class="s2">.</span><span class="s1">bottom</span><span class="s2">,</span>
        <span class="s1">sides</span><span class="s2">.</span><span class="s1">left</span>
    <span class="s2">];</span>
    <span class="s0">var </span><span class="s1">stringValues </span><span class="s2">= [</span>
        <span class="s1">generate</span><span class="s2">(</span><span class="s1">sides</span><span class="s2">.</span><span class="s1">top</span><span class="s2">.</span><span class="s1">node</span><span class="s2">),</span>
        <span class="s1">generate</span><span class="s2">(</span><span class="s1">sides</span><span class="s2">.</span><span class="s1">right</span><span class="s2">.</span><span class="s1">node</span><span class="s2">),</span>
        <span class="s1">generate</span><span class="s2">(</span><span class="s1">sides</span><span class="s2">.</span><span class="s1">bottom</span><span class="s2">.</span><span class="s1">node</span><span class="s2">),</span>
        <span class="s1">generate</span><span class="s2">(</span><span class="s1">sides</span><span class="s2">.</span><span class="s1">left</span><span class="s2">.</span><span class="s1">node</span><span class="s2">)</span>
    <span class="s2">];</span>

    <span class="s0">if </span><span class="s2">(</span><span class="s1">stringValues</span><span class="s2">[</span><span class="s1">LEFT</span><span class="s2">] === </span><span class="s1">stringValues</span><span class="s2">[</span><span class="s1">RIGHT</span><span class="s2">]) {</span>
        <span class="s1">values</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">();</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">stringValues</span><span class="s2">[</span><span class="s1">BOTTOM</span><span class="s2">] === </span><span class="s1">stringValues</span><span class="s2">[</span><span class="s1">TOP</span><span class="s2">]) {</span>
            <span class="s1">values</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">();</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">stringValues</span><span class="s2">[</span><span class="s1">RIGHT</span><span class="s2">] === </span><span class="s1">stringValues</span><span class="s2">[</span><span class="s1">TOP</span><span class="s2">]) {</span>
                <span class="s1">values</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">();</span>
            <span class="s2">}</span>
        <span class="s2">}</span>
    <span class="s2">}</span>

    <span class="s0">for </span><span class="s2">(</span><span class="s0">var </span><span class="s1">i </span><span class="s2">= </span><span class="s4">0</span><span class="s2">; </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">values</span><span class="s2">.</span><span class="s1">length</span><span class="s2">; </span><span class="s1">i</span><span class="s2">++) {</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">i</span><span class="s2">) {</span>
            <span class="s1">result</span><span class="s2">.</span><span class="s1">appendData</span><span class="s2">({ </span><span class="s1">type</span><span class="s2">: </span><span class="s3">'WhiteSpace'</span><span class="s2">, </span><span class="s1">value</span><span class="s2">: </span><span class="s3">' ' </span><span class="s2">});</span>
        <span class="s2">}</span>

        <span class="s1">result</span><span class="s2">.</span><span class="s1">appendData</span><span class="s2">(</span><span class="s1">values</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">node</span><span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s0">if </span><span class="s2">(</span><span class="s0">this</span><span class="s2">.</span><span class="s1">iehack</span><span class="s2">) {</span>
        <span class="s1">result</span><span class="s2">.</span><span class="s1">appendData</span><span class="s2">({ </span><span class="s1">type</span><span class="s2">: </span><span class="s3">'WhiteSpace'</span><span class="s2">, </span><span class="s1">value</span><span class="s2">: </span><span class="s3">' ' </span><span class="s2">});</span>
        <span class="s1">result</span><span class="s2">.</span><span class="s1">appendData</span><span class="s2">({</span>
            <span class="s1">type</span><span class="s2">: </span><span class="s3">'Identifier'</span><span class="s2">,</span>
            <span class="s1">loc</span><span class="s2">: </span><span class="s0">null</span><span class="s2">,</span>
            <span class="s1">name</span><span class="s2">: </span><span class="s0">this</span><span class="s2">.</span><span class="s1">iehack</span>
        <span class="s2">});</span>
    <span class="s2">}</span>

    <span class="s0">return </span><span class="s2">{</span>
        <span class="s1">type</span><span class="s2">: </span><span class="s3">'Value'</span><span class="s2">,</span>
        <span class="s1">loc</span><span class="s2">: </span><span class="s0">null</span><span class="s2">,</span>
        <span class="s1">children</span><span class="s2">: </span><span class="s1">result</span>
    <span class="s2">};</span>
<span class="s2">};</span>

<span class="s1">TRBL</span><span class="s2">.</span><span class="s1">prototype</span><span class="s2">.</span><span class="s1">getDeclaration </span><span class="s2">= </span><span class="s0">function</span><span class="s2">() {</span>
    <span class="s0">return </span><span class="s2">{</span>
        <span class="s1">type</span><span class="s2">: </span><span class="s3">'Declaration'</span><span class="s2">,</span>
        <span class="s1">loc</span><span class="s2">: </span><span class="s0">this</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">,</span>
        <span class="s1">important</span><span class="s2">: </span><span class="s0">this</span><span class="s2">.</span><span class="s1">sides</span><span class="s2">.</span><span class="s1">top</span><span class="s2">.</span><span class="s1">important</span><span class="s2">,</span>
        <span class="s1">property</span><span class="s2">: </span><span class="s0">this</span><span class="s2">.</span><span class="s1">name</span><span class="s2">,</span>
        <span class="s1">value</span><span class="s2">: </span><span class="s0">this</span><span class="s2">.</span><span class="s1">getValue</span><span class="s2">()</span>
    <span class="s2">};</span>
<span class="s2">};</span>

<span class="s0">function </span><span class="s1">processRule</span><span class="s2">(</span><span class="s1">rule</span><span class="s2">, </span><span class="s1">shorts</span><span class="s2">, </span><span class="s1">shortDeclarations</span><span class="s2">, </span><span class="s1">lastShortSelector</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">declarations </span><span class="s2">= </span><span class="s1">rule</span><span class="s2">.</span><span class="s1">block</span><span class="s2">.</span><span class="s1">children</span><span class="s2">;</span>
    <span class="s0">var </span><span class="s1">selector </span><span class="s2">= </span><span class="s1">rule</span><span class="s2">.</span><span class="s1">prelude</span><span class="s2">.</span><span class="s1">children</span><span class="s2">.</span><span class="s1">first</span><span class="s2">().</span><span class="s1">id</span><span class="s2">;</span>

    <span class="s1">rule</span><span class="s2">.</span><span class="s1">block</span><span class="s2">.</span><span class="s1">children</span><span class="s2">.</span><span class="s1">eachRight</span><span class="s2">(</span><span class="s0">function</span><span class="s2">(</span><span class="s1">declaration</span><span class="s2">, </span><span class="s1">item</span><span class="s2">) {</span>
        <span class="s0">var </span><span class="s1">property </span><span class="s2">= </span><span class="s1">declaration</span><span class="s2">.</span><span class="s1">property</span><span class="s2">;</span>

        <span class="s0">if </span><span class="s2">(!</span><span class="s1">MAIN_PROPERTY</span><span class="s2">.</span><span class="s1">hasOwnProperty</span><span class="s2">(</span><span class="s1">property</span><span class="s2">)) {</span>
            <span class="s0">return</span><span class="s2">;</span>
        <span class="s2">}</span>

        <span class="s0">var </span><span class="s1">key </span><span class="s2">= </span><span class="s1">MAIN_PROPERTY</span><span class="s2">[</span><span class="s1">property</span><span class="s2">];</span>
        <span class="s0">var </span><span class="s1">shorthand</span><span class="s2">;</span>
        <span class="s0">var </span><span class="s1">operation</span><span class="s2">;</span>

        <span class="s0">if </span><span class="s2">(!</span><span class="s1">lastShortSelector </span><span class="s2">|| </span><span class="s1">selector </span><span class="s2">=== </span><span class="s1">lastShortSelector</span><span class="s2">) {</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">key </span><span class="s0">in </span><span class="s1">shorts</span><span class="s2">) {</span>
                <span class="s1">operation </span><span class="s2">= </span><span class="s1">REMOVE</span><span class="s2">;</span>
                <span class="s1">shorthand </span><span class="s2">= </span><span class="s1">shorts</span><span class="s2">[</span><span class="s1">key</span><span class="s2">];</span>
            <span class="s2">}</span>
        <span class="s2">}</span>

        <span class="s0">if </span><span class="s2">(!</span><span class="s1">shorthand </span><span class="s2">|| !</span><span class="s1">shorthand</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">property</span><span class="s2">, </span><span class="s1">declaration</span><span class="s2">)) {</span>
            <span class="s1">operation </span><span class="s2">= </span><span class="s1">REPLACE</span><span class="s2">;</span>
            <span class="s1">shorthand </span><span class="s2">= </span><span class="s0">new </span><span class="s1">TRBL</span><span class="s2">(</span><span class="s1">key</span><span class="s2">);</span>

            <span class="s5">// if can't parse value ignore it and break shorthand children</span>
            <span class="s0">if </span><span class="s2">(!</span><span class="s1">shorthand</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">property</span><span class="s2">, </span><span class="s1">declaration</span><span class="s2">)) {</span>
                <span class="s1">lastShortSelector </span><span class="s2">= </span><span class="s0">null</span><span class="s2">;</span>
                <span class="s0">return</span><span class="s2">;</span>
            <span class="s2">}</span>
        <span class="s2">}</span>

        <span class="s1">shorts</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">shorthand</span><span class="s2">;</span>
        <span class="s1">shortDeclarations</span><span class="s2">.</span><span class="s1">push</span><span class="s2">({</span>
            <span class="s1">operation</span><span class="s2">: </span><span class="s1">operation</span><span class="s2">,</span>
            <span class="s1">block</span><span class="s2">: </span><span class="s1">declarations</span><span class="s2">,</span>
            <span class="s1">item</span><span class="s2">: </span><span class="s1">item</span><span class="s2">,</span>
            <span class="s1">shorthand</span><span class="s2">: </span><span class="s1">shorthand</span>
        <span class="s2">});</span>

        <span class="s1">lastShortSelector </span><span class="s2">= </span><span class="s1">selector</span><span class="s2">;</span>
    <span class="s2">});</span>

    <span class="s0">return </span><span class="s1">lastShortSelector</span><span class="s2">;</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">processShorthands</span><span class="s2">(</span><span class="s1">shortDeclarations</span><span class="s2">, </span><span class="s1">markDeclaration</span><span class="s2">) {</span>
    <span class="s1">shortDeclarations</span><span class="s2">.</span><span class="s1">forEach</span><span class="s2">(</span><span class="s0">function</span><span class="s2">(</span><span class="s1">item</span><span class="s2">) {</span>
        <span class="s0">var </span><span class="s1">shorthand </span><span class="s2">= </span><span class="s1">item</span><span class="s2">.</span><span class="s1">shorthand</span><span class="s2">;</span>

        <span class="s0">if </span><span class="s2">(!</span><span class="s1">shorthand</span><span class="s2">.</span><span class="s1">isOkToMinimize</span><span class="s2">()) {</span>
            <span class="s0">return</span><span class="s2">;</span>
        <span class="s2">}</span>

        <span class="s0">if </span><span class="s2">(</span><span class="s1">item</span><span class="s2">.</span><span class="s1">operation </span><span class="s2">=== </span><span class="s1">REPLACE</span><span class="s2">) {</span>
            <span class="s1">item</span><span class="s2">.</span><span class="s1">item</span><span class="s2">.</span><span class="s1">data </span><span class="s2">= </span><span class="s1">markDeclaration</span><span class="s2">(</span><span class="s1">shorthand</span><span class="s2">.</span><span class="s1">getDeclaration</span><span class="s2">());</span>
        <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
            <span class="s1">item</span><span class="s2">.</span><span class="s1">block</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">item</span><span class="s2">.</span><span class="s1">item</span><span class="s2">);</span>
        <span class="s2">}</span>
    <span class="s2">});</span>
<span class="s2">}</span>

<span class="s1">module</span><span class="s2">.</span><span class="s1">exports </span><span class="s2">= </span><span class="s0">function </span><span class="s1">restructBlock</span><span class="s2">(</span><span class="s1">ast</span><span class="s2">, </span><span class="s1">indexer</span><span class="s2">) {</span>
    <span class="s0">var </span><span class="s1">stylesheetMap </span><span class="s2">= {};</span>
    <span class="s0">var </span><span class="s1">shortDeclarations </span><span class="s2">= [];</span>

    <span class="s1">walk</span><span class="s2">(</span><span class="s1">ast</span><span class="s2">, {</span>
        <span class="s1">visit</span><span class="s2">: </span><span class="s3">'Rule'</span><span class="s2">,</span>
        <span class="s1">reverse</span><span class="s2">: </span><span class="s0">true</span><span class="s2">,</span>
        <span class="s1">enter</span><span class="s2">: </span><span class="s0">function</span><span class="s2">(</span><span class="s1">node</span><span class="s2">) {</span>
            <span class="s0">var </span><span class="s1">stylesheet </span><span class="s2">= </span><span class="s0">this</span><span class="s2">.</span><span class="s1">block </span><span class="s2">|| </span><span class="s0">this</span><span class="s2">.</span><span class="s1">stylesheet</span><span class="s2">;</span>
            <span class="s0">var </span><span class="s1">ruleId </span><span class="s2">= (</span><span class="s1">node</span><span class="s2">.</span><span class="s1">pseudoSignature </span><span class="s2">|| </span><span class="s3">''</span><span class="s2">) + </span><span class="s3">'|' </span><span class="s2">+ </span><span class="s1">node</span><span class="s2">.</span><span class="s1">prelude</span><span class="s2">.</span><span class="s1">children</span><span class="s2">.</span><span class="s1">first</span><span class="s2">().</span><span class="s1">id</span><span class="s2">;</span>
            <span class="s0">var </span><span class="s1">ruleMap</span><span class="s2">;</span>
            <span class="s0">var </span><span class="s1">shorts</span><span class="s2">;</span>

            <span class="s0">if </span><span class="s2">(!</span><span class="s1">stylesheetMap</span><span class="s2">.</span><span class="s1">hasOwnProperty</span><span class="s2">(</span><span class="s1">stylesheet</span><span class="s2">.</span><span class="s1">id</span><span class="s2">)) {</span>
                <span class="s1">ruleMap </span><span class="s2">= {</span>
                    <span class="s1">lastShortSelector</span><span class="s2">: </span><span class="s0">null</span>
                <span class="s2">};</span>
                <span class="s1">stylesheetMap</span><span class="s2">[</span><span class="s1">stylesheet</span><span class="s2">.</span><span class="s1">id</span><span class="s2">] = </span><span class="s1">ruleMap</span><span class="s2">;</span>
            <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
                <span class="s1">ruleMap </span><span class="s2">= </span><span class="s1">stylesheetMap</span><span class="s2">[</span><span class="s1">stylesheet</span><span class="s2">.</span><span class="s1">id</span><span class="s2">];</span>
            <span class="s2">}</span>

            <span class="s0">if </span><span class="s2">(</span><span class="s1">ruleMap</span><span class="s2">.</span><span class="s1">hasOwnProperty</span><span class="s2">(</span><span class="s1">ruleId</span><span class="s2">)) {</span>
                <span class="s1">shorts </span><span class="s2">= </span><span class="s1">ruleMap</span><span class="s2">[</span><span class="s1">ruleId</span><span class="s2">];</span>
            <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
                <span class="s1">shorts </span><span class="s2">= {};</span>
                <span class="s1">ruleMap</span><span class="s2">[</span><span class="s1">ruleId</span><span class="s2">] = </span><span class="s1">shorts</span><span class="s2">;</span>
            <span class="s2">}</span>

            <span class="s1">ruleMap</span><span class="s2">.</span><span class="s1">lastShortSelector </span><span class="s2">= </span><span class="s1">processRule</span><span class="s2">.</span><span class="s1">call</span><span class="s2">(</span><span class="s0">this</span><span class="s2">, </span><span class="s1">node</span><span class="s2">, </span><span class="s1">shorts</span><span class="s2">, </span><span class="s1">shortDeclarations</span><span class="s2">, </span><span class="s1">ruleMap</span><span class="s2">.</span><span class="s1">lastShortSelector</span><span class="s2">);</span>
        <span class="s2">}</span>
    <span class="s2">});</span>

    <span class="s1">processShorthands</span><span class="s2">(</span><span class="s1">shortDeclarations</span><span class="s2">, </span><span class="s1">indexer</span><span class="s2">.</span><span class="s1">declaration</span><span class="s2">);</span>
<span class="s2">};</span>
</pre>
</body>
</html>