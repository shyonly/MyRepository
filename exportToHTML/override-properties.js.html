<html>
<head>
<title>override-properties.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
override-properties.js</font>
</center></td></tr></table>
<pre><span class="s0">var </span><span class="s1">hasInherit </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'./has-inherit'</span><span class="s2">);</span>
<span class="s0">var </span><span class="s1">hasUnset </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'./has-unset'</span><span class="s2">);</span>
<span class="s0">var </span><span class="s1">everyValuesPair </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'./every-values-pair'</span><span class="s2">);</span>
<span class="s0">var </span><span class="s1">findComponentIn </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'./find-component-in'</span><span class="s2">);</span>
<span class="s0">var </span><span class="s1">isComponentOf </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'./is-component-of'</span><span class="s2">);</span>
<span class="s0">var </span><span class="s1">isMergeableShorthand </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'./is-mergeable-shorthand'</span><span class="s2">);</span>
<span class="s0">var </span><span class="s1">overridesNonComponentShorthand </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'./overrides-non-component-shorthand'</span><span class="s2">);</span>
<span class="s0">var </span><span class="s1">sameVendorPrefixesIn </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'./../../vendor-prefixes'</span><span class="s2">).</span><span class="s1">same</span><span class="s2">;</span>

<span class="s0">var </span><span class="s1">configuration </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'../../configuration'</span><span class="s2">);</span>
<span class="s0">var </span><span class="s1">deepClone </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'../../clone'</span><span class="s2">).</span><span class="s1">deep</span><span class="s2">;</span>
<span class="s0">var </span><span class="s1">restoreWithComponents </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'../restore-with-components'</span><span class="s2">);</span>
<span class="s0">var </span><span class="s1">shallowClone </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'../../clone'</span><span class="s2">).</span><span class="s1">shallow</span><span class="s2">;</span>

<span class="s0">var </span><span class="s1">restoreFromOptimizing </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'../../restore-from-optimizing'</span><span class="s2">);</span>

<span class="s0">var </span><span class="s1">Token </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'../../../tokenizer/token'</span><span class="s2">);</span>
<span class="s0">var </span><span class="s1">Marker </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'../../../tokenizer/marker'</span><span class="s2">);</span>

<span class="s0">var </span><span class="s1">serializeProperty </span><span class="s2">= </span><span class="s1">require</span><span class="s2">(</span><span class="s3">'../../../writer/one-time'</span><span class="s2">).</span><span class="s1">property</span><span class="s2">;</span>

<span class="s0">function </span><span class="s1">sameValue</span><span class="s2">(</span><span class="s1">_validator</span><span class="s2">, </span><span class="s1">value1</span><span class="s2">, </span><span class="s1">value2</span><span class="s2">) {</span>
  <span class="s0">return </span><span class="s1">value1 </span><span class="s2">=== </span><span class="s1">value2</span><span class="s2">;</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">wouldBreakCompatibility</span><span class="s2">(</span><span class="s1">property</span><span class="s2">, </span><span class="s1">validator</span><span class="s2">) {</span>
  <span class="s0">for </span><span class="s2">(</span><span class="s0">var </span><span class="s1">i </span><span class="s2">= </span><span class="s4">0</span><span class="s2">; </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">property</span><span class="s2">.</span><span class="s1">components</span><span class="s2">.</span><span class="s1">length</span><span class="s2">; </span><span class="s1">i</span><span class="s2">++) {</span>
    <span class="s0">var </span><span class="s1">component </span><span class="s2">= </span><span class="s1">property</span><span class="s2">.</span><span class="s1">components</span><span class="s2">[</span><span class="s1">i</span><span class="s2">];</span>
    <span class="s0">var </span><span class="s1">descriptor </span><span class="s2">= </span><span class="s1">configuration</span><span class="s2">[</span><span class="s1">component</span><span class="s2">.</span><span class="s1">name</span><span class="s2">];</span>
    <span class="s0">var </span><span class="s1">canOverride </span><span class="s2">= </span><span class="s1">descriptor </span><span class="s2">&amp;&amp; </span><span class="s1">descriptor</span><span class="s2">.</span><span class="s1">canOverride </span><span class="s2">|| </span><span class="s1">sameValue</span><span class="s2">;</span>

    <span class="s0">var </span><span class="s1">_component </span><span class="s2">= </span><span class="s1">shallowClone</span><span class="s2">(</span><span class="s1">component</span><span class="s2">);</span>
    <span class="s1">_component</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= [[</span><span class="s1">Token</span><span class="s2">.</span><span class="s1">PROPERTY_VALUE</span><span class="s2">, </span><span class="s1">descriptor</span><span class="s2">.</span><span class="s1">defaultValue</span><span class="s2">]];</span>

    <span class="s0">if </span><span class="s2">(!</span><span class="s1">everyValuesPair</span><span class="s2">(</span><span class="s1">canOverride</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s0">null</span><span class="s2">, </span><span class="s1">validator</span><span class="s2">), </span><span class="s1">_component</span><span class="s2">, </span><span class="s1">component</span><span class="s2">)) {</span>
      <span class="s0">return true</span><span class="s2">;</span>
    <span class="s2">}</span>
  <span class="s2">}</span>

  <span class="s0">return false</span><span class="s2">;</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">overrideIntoMultiplex</span><span class="s2">(</span><span class="s1">property</span><span class="s2">, </span><span class="s1">by</span><span class="s2">) {</span>
  <span class="s1">by</span><span class="s2">.</span><span class="s1">unused </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>

  <span class="s1">turnIntoMultiplex</span><span class="s2">(</span><span class="s1">by</span><span class="s2">, </span><span class="s1">multiplexSize</span><span class="s2">(</span><span class="s1">property</span><span class="s2">));</span>
  <span class="s1">property</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">by</span><span class="s2">.</span><span class="s1">value</span><span class="s2">;</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">overrideByMultiplex</span><span class="s2">(</span><span class="s1">property</span><span class="s2">, </span><span class="s1">by</span><span class="s2">) {</span>
  <span class="s1">by</span><span class="s2">.</span><span class="s1">unused </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
  <span class="s1">property</span><span class="s2">.</span><span class="s1">multiplex </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
  <span class="s1">property</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">by</span><span class="s2">.</span><span class="s1">value</span><span class="s2">;</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">overrideSimple</span><span class="s2">(</span><span class="s1">property</span><span class="s2">, </span><span class="s1">by</span><span class="s2">) {</span>
  <span class="s1">by</span><span class="s2">.</span><span class="s1">unused </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
  <span class="s1">property</span><span class="s2">.</span><span class="s1">value </span><span class="s2">= </span><span class="s1">by</span><span class="s2">.</span><span class="s1">value</span><span class="s2">;</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">override</span><span class="s2">(</span><span class="s1">property</span><span class="s2">, </span><span class="s1">by</span><span class="s2">) {</span>
  <span class="s0">if </span><span class="s2">(</span><span class="s1">by</span><span class="s2">.</span><span class="s1">multiplex</span><span class="s2">) {</span>
    <span class="s1">overrideByMultiplex</span><span class="s2">(</span><span class="s1">property</span><span class="s2">, </span><span class="s1">by</span><span class="s2">);</span>
  <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">property</span><span class="s2">.</span><span class="s1">multiplex</span><span class="s2">) {</span>
    <span class="s1">overrideIntoMultiplex</span><span class="s2">(</span><span class="s1">property</span><span class="s2">, </span><span class="s1">by</span><span class="s2">);</span>
  <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
    <span class="s1">overrideSimple</span><span class="s2">(</span><span class="s1">property</span><span class="s2">, </span><span class="s1">by</span><span class="s2">);</span>
  <span class="s2">}</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">overrideShorthand</span><span class="s2">(</span><span class="s1">property</span><span class="s2">, </span><span class="s1">by</span><span class="s2">) {</span>
  <span class="s1">by</span><span class="s2">.</span><span class="s1">unused </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>

  <span class="s0">for </span><span class="s2">(</span><span class="s0">var </span><span class="s1">i </span><span class="s2">= </span><span class="s4">0</span><span class="s2">, </span><span class="s1">l </span><span class="s2">= </span><span class="s1">property</span><span class="s2">.</span><span class="s1">components</span><span class="s2">.</span><span class="s1">length</span><span class="s2">; </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">l</span><span class="s2">; </span><span class="s1">i</span><span class="s2">++) {</span>
    <span class="s1">override</span><span class="s2">(</span><span class="s1">property</span><span class="s2">.</span><span class="s1">components</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">by</span><span class="s2">.</span><span class="s1">components</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]);</span>
  <span class="s2">}</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">turnIntoMultiplex</span><span class="s2">(</span><span class="s1">property</span><span class="s2">, </span><span class="s1">size</span><span class="s2">) {</span>
  <span class="s1">property</span><span class="s2">.</span><span class="s1">multiplex </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>

  <span class="s0">if </span><span class="s2">(</span><span class="s1">configuration</span><span class="s2">[</span><span class="s1">property</span><span class="s2">.</span><span class="s1">name</span><span class="s2">].</span><span class="s1">shorthand</span><span class="s2">) {</span>
    <span class="s1">turnShorthandValueIntoMultiplex</span><span class="s2">(</span><span class="s1">property</span><span class="s2">, </span><span class="s1">size</span><span class="s2">);</span>
  <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
    <span class="s1">turnLonghandValueIntoMultiplex</span><span class="s2">(</span><span class="s1">property</span><span class="s2">, </span><span class="s1">size</span><span class="s2">);</span>
  <span class="s2">}</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">turnShorthandValueIntoMultiplex</span><span class="s2">(</span><span class="s1">property</span><span class="s2">, </span><span class="s1">size</span><span class="s2">) {</span>
  <span class="s0">var </span><span class="s1">component</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">i</span><span class="s2">, </span><span class="s1">l</span><span class="s2">;</span>

  <span class="s0">for </span><span class="s2">(</span><span class="s1">i </span><span class="s2">= </span><span class="s4">0</span><span class="s2">, </span><span class="s1">l </span><span class="s2">= </span><span class="s1">property</span><span class="s2">.</span><span class="s1">components</span><span class="s2">.</span><span class="s1">length</span><span class="s2">; </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">l</span><span class="s2">; </span><span class="s1">i</span><span class="s2">++) {</span>
    <span class="s1">component </span><span class="s2">= </span><span class="s1">property</span><span class="s2">.</span><span class="s1">components</span><span class="s2">[</span><span class="s1">i</span><span class="s2">];</span>

    <span class="s0">if </span><span class="s2">(!</span><span class="s1">component</span><span class="s2">.</span><span class="s1">multiplex</span><span class="s2">) {</span>
      <span class="s1">turnLonghandValueIntoMultiplex</span><span class="s2">(</span><span class="s1">component</span><span class="s2">, </span><span class="s1">size</span><span class="s2">);</span>
    <span class="s2">}</span>
  <span class="s2">}</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">turnLonghandValueIntoMultiplex</span><span class="s2">(</span><span class="s1">property</span><span class="s2">, </span><span class="s1">size</span><span class="s2">) {</span>
  <span class="s0">var </span><span class="s1">descriptor </span><span class="s2">= </span><span class="s1">configuration</span><span class="s2">[</span><span class="s1">property</span><span class="s2">.</span><span class="s1">name</span><span class="s2">];</span>
  <span class="s0">var </span><span class="s1">withRealValue </span><span class="s2">= </span><span class="s1">descriptor</span><span class="s2">.</span><span class="s1">intoMultiplexMode </span><span class="s2">== </span><span class="s3">'real'</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">withValue </span><span class="s2">= </span><span class="s1">descriptor</span><span class="s2">.</span><span class="s1">intoMultiplexMode </span><span class="s2">== </span><span class="s3">'real'</span>
    <span class="s2">? </span><span class="s1">property</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">slice</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s2">: (</span><span class="s1">descriptor</span><span class="s2">.</span><span class="s1">intoMultiplexMode </span><span class="s2">== </span><span class="s3">'placeholder' </span><span class="s2">? </span><span class="s1">descriptor</span><span class="s2">.</span><span class="s1">placeholderValue </span><span class="s2">: </span><span class="s1">descriptor</span><span class="s2">.</span><span class="s1">defaultValue</span><span class="s2">);</span>
  <span class="s0">var </span><span class="s1">i </span><span class="s2">= </span><span class="s1">multiplexSize</span><span class="s2">(</span><span class="s1">property</span><span class="s2">);</span>
  <span class="s0">var </span><span class="s1">j</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">m </span><span class="s2">= </span><span class="s1">withValue</span><span class="s2">.</span><span class="s1">length</span><span class="s2">;</span>

  <span class="s0">for </span><span class="s2">(; </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">size</span><span class="s2">; </span><span class="s1">i</span><span class="s2">++) {</span>
    <span class="s1">property</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">push</span><span class="s2">([</span><span class="s1">Token</span><span class="s2">.</span><span class="s1">PROPERTY_VALUE</span><span class="s2">, </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">COMMA</span><span class="s2">]);</span>

    <span class="s0">if </span><span class="s2">(</span><span class="s1">Array</span><span class="s2">.</span><span class="s1">isArray</span><span class="s2">(</span><span class="s1">withValue</span><span class="s2">)) {</span>
      <span class="s0">for </span><span class="s2">(</span><span class="s1">j </span><span class="s2">= </span><span class="s4">0</span><span class="s2">; </span><span class="s1">j </span><span class="s2">&lt; </span><span class="s1">m</span><span class="s2">; </span><span class="s1">j</span><span class="s2">++) {</span>
        <span class="s1">property</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">withRealValue </span><span class="s2">? </span><span class="s1">withValue</span><span class="s2">[</span><span class="s1">j</span><span class="s2">] : [</span><span class="s1">Token</span><span class="s2">.</span><span class="s1">PROPERTY_VALUE</span><span class="s2">, </span><span class="s1">withValue</span><span class="s2">[</span><span class="s1">j</span><span class="s2">]]);</span>
      <span class="s2">}</span>
    <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
      <span class="s1">property</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">withRealValue </span><span class="s2">? </span><span class="s1">withValue </span><span class="s2">: [</span><span class="s1">Token</span><span class="s2">.</span><span class="s1">PROPERTY_VALUE</span><span class="s2">, </span><span class="s1">withValue</span><span class="s2">]);</span>
    <span class="s2">}</span>
  <span class="s2">}</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">multiplexSize</span><span class="s2">(</span><span class="s1">component</span><span class="s2">) {</span>
  <span class="s0">var </span><span class="s1">size </span><span class="s2">= </span><span class="s4">0</span><span class="s2">;</span>

  <span class="s0">for </span><span class="s2">(</span><span class="s0">var </span><span class="s1">i </span><span class="s2">= </span><span class="s4">0</span><span class="s2">, </span><span class="s1">l </span><span class="s2">= </span><span class="s1">component</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">length</span><span class="s2">; </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">l</span><span class="s2">; </span><span class="s1">i</span><span class="s2">++) {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">component</span><span class="s2">.</span><span class="s1">value</span><span class="s2">[</span><span class="s1">i</span><span class="s2">][</span><span class="s4">1</span><span class="s2">] == </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">COMMA</span><span class="s2">) { </span><span class="s1">size</span><span class="s2">++; }</span>
  <span class="s2">}</span>

  <span class="s0">return </span><span class="s1">size </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">;</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">lengthOf</span><span class="s2">(</span><span class="s1">property</span><span class="s2">) {</span>
  <span class="s0">var </span><span class="s1">fakeAsArray </span><span class="s2">= [</span>
    <span class="s1">Token</span><span class="s2">.</span><span class="s1">PROPERTY</span><span class="s2">,</span>
    <span class="s2">[</span><span class="s1">Token</span><span class="s2">.</span><span class="s1">PROPERTY_NAME</span><span class="s2">, </span><span class="s1">property</span><span class="s2">.</span><span class="s1">name</span><span class="s2">]</span>
  <span class="s2">].</span><span class="s1">concat</span><span class="s2">(</span><span class="s1">property</span><span class="s2">.</span><span class="s1">value</span><span class="s2">);</span>
  <span class="s0">return </span><span class="s1">serializeProperty</span><span class="s2">([</span><span class="s1">fakeAsArray</span><span class="s2">], </span><span class="s4">0</span><span class="s2">).</span><span class="s1">length</span><span class="s2">;</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">moreSameShorthands</span><span class="s2">(</span><span class="s1">properties</span><span class="s2">, </span><span class="s1">startAt</span><span class="s2">, </span><span class="s1">name</span><span class="s2">) {</span>
  <span class="s5">// Since we run the main loop in `compactOverrides` backwards, at this point some</span>
  <span class="s5">// properties may not be marked as unused.</span>
  <span class="s5">// We should consider reverting the order if possible</span>
  <span class="s0">var </span><span class="s1">count </span><span class="s2">= </span><span class="s4">0</span><span class="s2">;</span>

  <span class="s0">for </span><span class="s2">(</span><span class="s0">var </span><span class="s1">i </span><span class="s2">= </span><span class="s1">startAt</span><span class="s2">; </span><span class="s1">i </span><span class="s2">&gt;= </span><span class="s4">0</span><span class="s2">; </span><span class="s1">i</span><span class="s2">--) {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">properties</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">name </span><span class="s2">== </span><span class="s1">name </span><span class="s2">&amp;&amp; !</span><span class="s1">properties</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">unused</span><span class="s2">) { </span><span class="s1">count</span><span class="s2">++; }</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">count </span><span class="s2">&gt; </span><span class="s4">1</span><span class="s2">) { </span><span class="s0">break</span><span class="s2">; }</span>
  <span class="s2">}</span>

  <span class="s0">return </span><span class="s1">count </span><span class="s2">&gt; </span><span class="s4">1</span><span class="s2">;</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">overridingFunction</span><span class="s2">(</span><span class="s1">shorthand</span><span class="s2">, </span><span class="s1">validator</span><span class="s2">) {</span>
  <span class="s0">for </span><span class="s2">(</span><span class="s0">var </span><span class="s1">i </span><span class="s2">= </span><span class="s4">0</span><span class="s2">, </span><span class="s1">l </span><span class="s2">= </span><span class="s1">shorthand</span><span class="s2">.</span><span class="s1">components</span><span class="s2">.</span><span class="s1">length</span><span class="s2">; </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">l</span><span class="s2">; </span><span class="s1">i</span><span class="s2">++) {</span>
    <span class="s0">if </span><span class="s2">(!</span><span class="s1">anyValue</span><span class="s2">(</span><span class="s1">validator</span><span class="s2">.</span><span class="s1">isUrl</span><span class="s2">, </span><span class="s1">shorthand</span><span class="s2">.</span><span class="s1">components</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>
      <span class="s2">&amp;&amp; </span><span class="s1">anyValue</span><span class="s2">(</span><span class="s1">validator</span><span class="s2">.</span><span class="s1">isFunction</span><span class="s2">, </span><span class="s1">shorthand</span><span class="s2">.</span><span class="s1">components</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])) { </span><span class="s0">return true</span><span class="s2">; }</span>
  <span class="s2">}</span>

  <span class="s0">return false</span><span class="s2">;</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">anyValue</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">property</span><span class="s2">) {</span>
  <span class="s0">for </span><span class="s2">(</span><span class="s0">var </span><span class="s1">i </span><span class="s2">= </span><span class="s4">0</span><span class="s2">, </span><span class="s1">l </span><span class="s2">= </span><span class="s1">property</span><span class="s2">.</span><span class="s1">value</span><span class="s2">.</span><span class="s1">length</span><span class="s2">; </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">l</span><span class="s2">; </span><span class="s1">i</span><span class="s2">++) {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">property</span><span class="s2">.</span><span class="s1">value</span><span class="s2">[</span><span class="s1">i</span><span class="s2">][</span><span class="s4">1</span><span class="s2">] == </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">COMMA</span><span class="s2">) { </span><span class="s0">continue</span><span class="s2">; }</span>

    <span class="s0">if </span><span class="s2">(</span><span class="s1">fn</span><span class="s2">(</span><span class="s1">property</span><span class="s2">.</span><span class="s1">value</span><span class="s2">[</span><span class="s1">i</span><span class="s2">][</span><span class="s4">1</span><span class="s2">])) { </span><span class="s0">return true</span><span class="s2">; }</span>
  <span class="s2">}</span>

  <span class="s0">return false</span><span class="s2">;</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">wouldResultInLongerValue</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">) {</span>
  <span class="s0">if </span><span class="s2">(!</span><span class="s1">left</span><span class="s2">.</span><span class="s1">multiplex </span><span class="s2">&amp;&amp; !</span><span class="s1">right</span><span class="s2">.</span><span class="s1">multiplex </span><span class="s2">|| </span><span class="s1">left</span><span class="s2">.</span><span class="s1">multiplex </span><span class="s2">&amp;&amp; </span><span class="s1">right</span><span class="s2">.</span><span class="s1">multiplex</span><span class="s2">) { </span><span class="s0">return false</span><span class="s2">; }</span>

  <span class="s0">var </span><span class="s1">multiplex </span><span class="s2">= </span><span class="s1">left</span><span class="s2">.</span><span class="s1">multiplex </span><span class="s2">? </span><span class="s1">left </span><span class="s2">: </span><span class="s1">right</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">simple </span><span class="s2">= </span><span class="s1">left</span><span class="s2">.</span><span class="s1">multiplex </span><span class="s2">? </span><span class="s1">right </span><span class="s2">: </span><span class="s1">left</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">component</span><span class="s2">;</span>

  <span class="s0">var </span><span class="s1">multiplexClone </span><span class="s2">= </span><span class="s1">deepClone</span><span class="s2">(</span><span class="s1">multiplex</span><span class="s2">);</span>
  <span class="s1">restoreFromOptimizing</span><span class="s2">([</span><span class="s1">multiplexClone</span><span class="s2">], </span><span class="s1">restoreWithComponents</span><span class="s2">);</span>

  <span class="s0">var </span><span class="s1">simpleClone </span><span class="s2">= </span><span class="s1">deepClone</span><span class="s2">(</span><span class="s1">simple</span><span class="s2">);</span>
  <span class="s1">restoreFromOptimizing</span><span class="s2">([</span><span class="s1">simpleClone</span><span class="s2">], </span><span class="s1">restoreWithComponents</span><span class="s2">);</span>

  <span class="s0">var </span><span class="s1">lengthBefore </span><span class="s2">= </span><span class="s1">lengthOf</span><span class="s2">(</span><span class="s1">multiplexClone</span><span class="s2">) + </span><span class="s4">1 </span><span class="s2">+ </span><span class="s1">lengthOf</span><span class="s2">(</span><span class="s1">simpleClone</span><span class="s2">);</span>

  <span class="s0">if </span><span class="s2">(</span><span class="s1">left</span><span class="s2">.</span><span class="s1">multiplex</span><span class="s2">) {</span>
    <span class="s1">component </span><span class="s2">= </span><span class="s1">findComponentIn</span><span class="s2">(</span><span class="s1">multiplexClone</span><span class="s2">, </span><span class="s1">simpleClone</span><span class="s2">);</span>
    <span class="s1">overrideIntoMultiplex</span><span class="s2">(</span><span class="s1">component</span><span class="s2">, </span><span class="s1">simpleClone</span><span class="s2">);</span>
  <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
    <span class="s1">component </span><span class="s2">= </span><span class="s1">findComponentIn</span><span class="s2">(</span><span class="s1">simpleClone</span><span class="s2">, </span><span class="s1">multiplexClone</span><span class="s2">);</span>
    <span class="s1">turnIntoMultiplex</span><span class="s2">(</span><span class="s1">simpleClone</span><span class="s2">, </span><span class="s1">multiplexSize</span><span class="s2">(</span><span class="s1">multiplexClone</span><span class="s2">));</span>
    <span class="s1">overrideByMultiplex</span><span class="s2">(</span><span class="s1">component</span><span class="s2">, </span><span class="s1">multiplexClone</span><span class="s2">);</span>
  <span class="s2">}</span>

  <span class="s1">restoreFromOptimizing</span><span class="s2">([</span><span class="s1">simpleClone</span><span class="s2">], </span><span class="s1">restoreWithComponents</span><span class="s2">);</span>

  <span class="s0">var </span><span class="s1">lengthAfter </span><span class="s2">= </span><span class="s1">lengthOf</span><span class="s2">(</span><span class="s1">simpleClone</span><span class="s2">);</span>

  <span class="s0">return </span><span class="s1">lengthBefore </span><span class="s2">&lt;= </span><span class="s1">lengthAfter</span><span class="s2">;</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">isCompactable</span><span class="s2">(</span><span class="s1">property</span><span class="s2">) {</span>
  <span class="s0">return </span><span class="s1">property</span><span class="s2">.</span><span class="s1">name </span><span class="s0">in </span><span class="s1">configuration</span><span class="s2">;</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">noneOverrideHack</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">) {</span>
  <span class="s0">return </span><span class="s2">!</span><span class="s1">left</span><span class="s2">.</span><span class="s1">multiplex</span>
    <span class="s2">&amp;&amp; (</span><span class="s1">left</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s3">'background' </span><span class="s2">|| </span><span class="s1">left</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s3">'background-image'</span><span class="s2">)</span>
    <span class="s2">&amp;&amp; </span><span class="s1">right</span><span class="s2">.</span><span class="s1">multiplex</span>
    <span class="s2">&amp;&amp; (</span><span class="s1">right</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s3">'background' </span><span class="s2">|| </span><span class="s1">right</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s3">'background-image'</span><span class="s2">)</span>
    <span class="s2">&amp;&amp; </span><span class="s1">anyLayerIsNone</span><span class="s2">(</span><span class="s1">right</span><span class="s2">.</span><span class="s1">value</span><span class="s2">);</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">anyLayerIsNone</span><span class="s2">(</span><span class="s1">values</span><span class="s2">) {</span>
  <span class="s0">var </span><span class="s1">layers </span><span class="s2">= </span><span class="s1">intoLayers</span><span class="s2">(</span><span class="s1">values</span><span class="s2">);</span>

  <span class="s0">for </span><span class="s2">(</span><span class="s0">var </span><span class="s1">i </span><span class="s2">= </span><span class="s4">0</span><span class="s2">, </span><span class="s1">l </span><span class="s2">= </span><span class="s1">layers</span><span class="s2">.</span><span class="s1">length</span><span class="s2">; </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">l</span><span class="s2">; </span><span class="s1">i</span><span class="s2">++) {</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">layers</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">length </span><span class="s2">== </span><span class="s4">1 </span><span class="s2">&amp;&amp; </span><span class="s1">layers</span><span class="s2">[</span><span class="s1">i</span><span class="s2">][</span><span class="s4">0</span><span class="s2">][</span><span class="s4">1</span><span class="s2">] == </span><span class="s3">'none'</span><span class="s2">) { </span><span class="s0">return true</span><span class="s2">; }</span>
  <span class="s2">}</span>

  <span class="s0">return false</span><span class="s2">;</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">intoLayers</span><span class="s2">(</span><span class="s1">values</span><span class="s2">) {</span>
  <span class="s0">var </span><span class="s1">layers </span><span class="s2">= [];</span>

  <span class="s0">for </span><span class="s2">(</span><span class="s0">var </span><span class="s1">i </span><span class="s2">= </span><span class="s4">0</span><span class="s2">, </span><span class="s1">layer </span><span class="s2">= [], </span><span class="s1">l </span><span class="s2">= </span><span class="s1">values</span><span class="s2">.</span><span class="s1">length</span><span class="s2">; </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">l</span><span class="s2">; </span><span class="s1">i</span><span class="s2">++) {</span>
    <span class="s0">var </span><span class="s1">value </span><span class="s2">= </span><span class="s1">values</span><span class="s2">[</span><span class="s1">i</span><span class="s2">];</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">value</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] == </span><span class="s1">Marker</span><span class="s2">.</span><span class="s1">COMMA</span><span class="s2">) {</span>
      <span class="s1">layers</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">layer</span><span class="s2">);</span>
      <span class="s1">layer </span><span class="s2">= [];</span>
    <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
      <span class="s1">layer</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">value</span><span class="s2">);</span>
    <span class="s2">}</span>
  <span class="s2">}</span>

  <span class="s1">layers</span><span class="s2">.</span><span class="s1">push</span><span class="s2">(</span><span class="s1">layer</span><span class="s2">);</span>
  <span class="s0">return </span><span class="s1">layers</span><span class="s2">;</span>
<span class="s2">}</span>

<span class="s0">function </span><span class="s1">overrideProperties</span><span class="s2">(</span><span class="s1">properties</span><span class="s2">, </span><span class="s1">withMerging</span><span class="s2">, </span><span class="s1">compatibility</span><span class="s2">, </span><span class="s1">validator</span><span class="s2">) {</span>
  <span class="s0">var </span><span class="s1">mayOverride</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s1">left</span><span class="s2">, </span><span class="s1">component</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">overriddenComponents</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">overriddenComponent</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">overridingComponent</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">overridable</span><span class="s2">;</span>
  <span class="s0">var </span><span class="s1">i</span><span class="s2">, </span><span class="s1">j</span><span class="s2">, </span><span class="s1">k</span><span class="s2">;</span>

  <span class="s1">propertyLoop</span><span class="s2">:</span>
  <span class="s0">for </span><span class="s2">(</span><span class="s1">i </span><span class="s2">= </span><span class="s1">properties</span><span class="s2">.</span><span class="s1">length </span><span class="s2">- </span><span class="s4">1</span><span class="s2">; </span><span class="s1">i </span><span class="s2">&gt;= </span><span class="s4">0</span><span class="s2">; </span><span class="s1">i</span><span class="s2">--) {</span>
    <span class="s1">right </span><span class="s2">= </span><span class="s1">properties</span><span class="s2">[</span><span class="s1">i</span><span class="s2">];</span>

    <span class="s0">if </span><span class="s2">(!</span><span class="s1">isCompactable</span><span class="s2">(</span><span class="s1">right</span><span class="s2">)) { </span><span class="s0">continue</span><span class="s2">; }</span>

    <span class="s0">if </span><span class="s2">(</span><span class="s1">right</span><span class="s2">.</span><span class="s1">block</span><span class="s2">) { </span><span class="s0">continue</span><span class="s2">; }</span>

    <span class="s1">mayOverride </span><span class="s2">= </span><span class="s1">configuration</span><span class="s2">[</span><span class="s1">right</span><span class="s2">.</span><span class="s1">name</span><span class="s2">].</span><span class="s1">canOverride </span><span class="s2">|| </span><span class="s1">sameValue</span><span class="s2">;</span>

    <span class="s1">traverseLoop</span><span class="s2">:</span>
    <span class="s0">for </span><span class="s2">(</span><span class="s1">j </span><span class="s2">= </span><span class="s1">i </span><span class="s2">- </span><span class="s4">1</span><span class="s2">; </span><span class="s1">j </span><span class="s2">&gt;= </span><span class="s4">0</span><span class="s2">; </span><span class="s1">j</span><span class="s2">--) {</span>
      <span class="s1">left </span><span class="s2">= </span><span class="s1">properties</span><span class="s2">[</span><span class="s1">j</span><span class="s2">];</span>

      <span class="s0">if </span><span class="s2">(!</span><span class="s1">isCompactable</span><span class="s2">(</span><span class="s1">left</span><span class="s2">)) { </span><span class="s0">continue</span><span class="s2">; }</span>

      <span class="s0">if </span><span class="s2">(</span><span class="s1">left</span><span class="s2">.</span><span class="s1">block</span><span class="s2">) { </span><span class="s0">continue</span><span class="s2">; }</span>

      <span class="s0">if </span><span class="s2">(</span><span class="s1">left</span><span class="s2">.</span><span class="s1">dynamic </span><span class="s2">|| </span><span class="s1">right</span><span class="s2">.</span><span class="s1">dynamic</span><span class="s2">) { </span><span class="s0">continue</span><span class="s2">; }</span>

      <span class="s0">if </span><span class="s2">(</span><span class="s1">left</span><span class="s2">.</span><span class="s1">unused </span><span class="s2">|| </span><span class="s1">right</span><span class="s2">.</span><span class="s1">unused</span><span class="s2">) { </span><span class="s0">continue</span><span class="s2">; }</span>

      <span class="s0">if </span><span class="s2">(</span><span class="s1">left</span><span class="s2">.</span><span class="s1">hack </span><span class="s2">&amp;&amp; !</span><span class="s1">right</span><span class="s2">.</span><span class="s1">hack </span><span class="s2">&amp;&amp; !</span><span class="s1">right</span><span class="s2">.</span><span class="s1">important </span><span class="s2">|| !</span><span class="s1">left</span><span class="s2">.</span><span class="s1">hack </span><span class="s2">&amp;&amp; !</span><span class="s1">left</span><span class="s2">.</span><span class="s1">important </span><span class="s2">&amp;&amp; </span><span class="s1">right</span><span class="s2">.</span><span class="s1">hack</span><span class="s2">) { </span><span class="s0">continue</span><span class="s2">; }</span>

      <span class="s0">if </span><span class="s2">(</span><span class="s1">left</span><span class="s2">.</span><span class="s1">important </span><span class="s2">== </span><span class="s1">right</span><span class="s2">.</span><span class="s1">important </span><span class="s2">&amp;&amp; </span><span class="s1">left</span><span class="s2">.</span><span class="s1">hack</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] != </span><span class="s1">right</span><span class="s2">.</span><span class="s1">hack</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]) { </span><span class="s0">continue</span><span class="s2">; }</span>

      <span class="s0">if </span><span class="s2">(</span><span class="s1">left</span><span class="s2">.</span><span class="s1">important </span><span class="s2">== </span><span class="s1">right</span><span class="s2">.</span><span class="s1">important</span>
        <span class="s2">&amp;&amp; (</span><span class="s1">left</span><span class="s2">.</span><span class="s1">hack</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] != </span><span class="s1">right</span><span class="s2">.</span><span class="s1">hack</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] || (</span><span class="s1">left</span><span class="s2">.</span><span class="s1">hack</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] &amp;&amp; </span><span class="s1">left</span><span class="s2">.</span><span class="s1">hack</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] != </span><span class="s1">right</span><span class="s2">.</span><span class="s1">hack</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]))) { </span><span class="s0">continue</span><span class="s2">; }</span>

      <span class="s0">if </span><span class="s2">(</span><span class="s1">hasInherit</span><span class="s2">(</span><span class="s1">right</span><span class="s2">)) { </span><span class="s0">continue</span><span class="s2">; }</span>

      <span class="s0">if </span><span class="s2">(</span><span class="s1">noneOverrideHack</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">)) { </span><span class="s0">continue</span><span class="s2">; }</span>

      <span class="s0">if </span><span class="s2">(</span><span class="s1">right</span><span class="s2">.</span><span class="s1">shorthand </span><span class="s2">&amp;&amp; </span><span class="s1">isComponentOf</span><span class="s2">(</span><span class="s1">right</span><span class="s2">, </span><span class="s1">left</span><span class="s2">)) {</span>
        <span class="s5">// maybe `left` can be overridden by `right` which is a shorthand?</span>
        <span class="s0">if </span><span class="s2">(!</span><span class="s1">right</span><span class="s2">.</span><span class="s1">important </span><span class="s2">&amp;&amp; </span><span class="s1">left</span><span class="s2">.</span><span class="s1">important</span><span class="s2">) { </span><span class="s0">continue</span><span class="s2">; }</span>

        <span class="s0">if </span><span class="s2">(!</span><span class="s1">sameVendorPrefixesIn</span><span class="s2">([</span><span class="s1">left</span><span class="s2">], </span><span class="s1">right</span><span class="s2">.</span><span class="s1">components</span><span class="s2">)) { </span><span class="s0">continue</span><span class="s2">; }</span>

        <span class="s0">if </span><span class="s2">(!</span><span class="s1">anyValue</span><span class="s2">(</span><span class="s1">validator</span><span class="s2">.</span><span class="s1">isFunction</span><span class="s2">, </span><span class="s1">left</span><span class="s2">) &amp;&amp; </span><span class="s1">overridingFunction</span><span class="s2">(</span><span class="s1">right</span><span class="s2">, </span><span class="s1">validator</span><span class="s2">)) { </span><span class="s0">continue</span><span class="s2">; }</span>

        <span class="s0">if </span><span class="s2">(!</span><span class="s1">isMergeableShorthand</span><span class="s2">(</span><span class="s1">right</span><span class="s2">)) {</span>
          <span class="s1">left</span><span class="s2">.</span><span class="s1">unused </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
          <span class="s0">continue</span><span class="s2">;</span>
        <span class="s2">}</span>

        <span class="s1">component </span><span class="s2">= </span><span class="s1">findComponentIn</span><span class="s2">(</span><span class="s1">right</span><span class="s2">, </span><span class="s1">left</span><span class="s2">);</span>
        <span class="s1">mayOverride </span><span class="s2">= </span><span class="s1">configuration</span><span class="s2">[</span><span class="s1">left</span><span class="s2">.</span><span class="s1">name</span><span class="s2">].</span><span class="s1">canOverride </span><span class="s2">|| </span><span class="s1">sameValue</span><span class="s2">;</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">everyValuesPair</span><span class="s2">(</span><span class="s1">mayOverride</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s0">null</span><span class="s2">, </span><span class="s1">validator</span><span class="s2">), </span><span class="s1">left</span><span class="s2">, </span><span class="s1">component</span><span class="s2">)) {</span>
          <span class="s1">left</span><span class="s2">.</span><span class="s1">unused </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
        <span class="s2">}</span>
      <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">right</span><span class="s2">.</span><span class="s1">shorthand </span><span class="s2">&amp;&amp; </span><span class="s1">overridesNonComponentShorthand</span><span class="s2">(</span><span class="s1">right</span><span class="s2">, </span><span class="s1">left</span><span class="s2">)) {</span>
        <span class="s5">// `right` is a shorthand while `left` can be overriden by it, think `border` and `border-top`</span>
        <span class="s0">if </span><span class="s2">(!</span><span class="s1">right</span><span class="s2">.</span><span class="s1">important </span><span class="s2">&amp;&amp; </span><span class="s1">left</span><span class="s2">.</span><span class="s1">important</span><span class="s2">) {</span>
          <span class="s0">continue</span><span class="s2">;</span>
        <span class="s2">}</span>

        <span class="s0">if </span><span class="s2">(!</span><span class="s1">sameVendorPrefixesIn</span><span class="s2">([</span><span class="s1">left</span><span class="s2">], </span><span class="s1">right</span><span class="s2">.</span><span class="s1">components</span><span class="s2">)) {</span>
          <span class="s0">continue</span><span class="s2">;</span>
        <span class="s2">}</span>

        <span class="s0">if </span><span class="s2">(!</span><span class="s1">anyValue</span><span class="s2">(</span><span class="s1">validator</span><span class="s2">.</span><span class="s1">isFunction</span><span class="s2">, </span><span class="s1">left</span><span class="s2">) &amp;&amp; </span><span class="s1">overridingFunction</span><span class="s2">(</span><span class="s1">right</span><span class="s2">, </span><span class="s1">validator</span><span class="s2">)) {</span>
          <span class="s0">continue</span><span class="s2">;</span>
        <span class="s2">}</span>

        <span class="s1">overriddenComponents </span><span class="s2">= </span><span class="s1">left</span><span class="s2">.</span><span class="s1">shorthand</span>
          <span class="s2">? </span><span class="s1">left</span><span class="s2">.</span><span class="s1">components</span>
          <span class="s2">: [</span><span class="s1">left</span><span class="s2">];</span>

        <span class="s0">for </span><span class="s2">(</span><span class="s1">k </span><span class="s2">= </span><span class="s1">overriddenComponents</span><span class="s2">.</span><span class="s1">length </span><span class="s2">- </span><span class="s4">1</span><span class="s2">; </span><span class="s1">k </span><span class="s2">&gt;= </span><span class="s4">0</span><span class="s2">; </span><span class="s1">k</span><span class="s2">--) {</span>
          <span class="s1">overriddenComponent </span><span class="s2">= </span><span class="s1">overriddenComponents</span><span class="s2">[</span><span class="s1">k</span><span class="s2">];</span>
          <span class="s1">overridingComponent </span><span class="s2">= </span><span class="s1">findComponentIn</span><span class="s2">(</span><span class="s1">right</span><span class="s2">, </span><span class="s1">overriddenComponent</span><span class="s2">);</span>
          <span class="s1">mayOverride </span><span class="s2">= </span><span class="s1">configuration</span><span class="s2">[</span><span class="s1">overriddenComponent</span><span class="s2">.</span><span class="s1">name</span><span class="s2">].</span><span class="s1">canOverride </span><span class="s2">|| </span><span class="s1">sameValue</span><span class="s2">;</span>

          <span class="s0">if </span><span class="s2">(!</span><span class="s1">everyValuesPair</span><span class="s2">(</span><span class="s1">mayOverride</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s0">null</span><span class="s2">, </span><span class="s1">validator</span><span class="s2">), </span><span class="s1">left</span><span class="s2">, </span><span class="s1">overridingComponent</span><span class="s2">)) {</span>
            <span class="s0">continue </span><span class="s1">traverseLoop</span><span class="s2">;</span>
          <span class="s2">}</span>
        <span class="s2">}</span>

        <span class="s1">left</span><span class="s2">.</span><span class="s1">unused </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
      <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">withMerging </span><span class="s2">&amp;&amp; </span><span class="s1">left</span><span class="s2">.</span><span class="s1">shorthand </span><span class="s2">&amp;&amp; !</span><span class="s1">right</span><span class="s2">.</span><span class="s1">shorthand </span><span class="s2">&amp;&amp; </span><span class="s1">isComponentOf</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">, </span><span class="s0">true</span><span class="s2">)) {</span>
        <span class="s5">// maybe `right` can be pulled into `left` which is a shorthand?</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">right</span><span class="s2">.</span><span class="s1">important </span><span class="s2">&amp;&amp; !</span><span class="s1">left</span><span class="s2">.</span><span class="s1">important</span><span class="s2">) { </span><span class="s0">continue</span><span class="s2">; }</span>

        <span class="s0">if </span><span class="s2">(!</span><span class="s1">right</span><span class="s2">.</span><span class="s1">important </span><span class="s2">&amp;&amp; </span><span class="s1">left</span><span class="s2">.</span><span class="s1">important</span><span class="s2">) {</span>
          <span class="s1">right</span><span class="s2">.</span><span class="s1">unused </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
          <span class="s0">continue</span><span class="s2">;</span>
        <span class="s2">}</span>

        <span class="s5">// Pending more clever algorithm in #527</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">moreSameShorthands</span><span class="s2">(</span><span class="s1">properties</span><span class="s2">, </span><span class="s1">i </span><span class="s2">- </span><span class="s4">1</span><span class="s2">, </span><span class="s1">left</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)) { </span><span class="s0">continue</span><span class="s2">; }</span>

        <span class="s0">if </span><span class="s2">(</span><span class="s1">overridingFunction</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">validator</span><span class="s2">)) { </span><span class="s0">continue</span><span class="s2">; }</span>

        <span class="s0">if </span><span class="s2">(!</span><span class="s1">isMergeableShorthand</span><span class="s2">(</span><span class="s1">left</span><span class="s2">)) { </span><span class="s0">continue</span><span class="s2">; }</span>

        <span class="s0">if </span><span class="s2">(</span><span class="s1">hasUnset</span><span class="s2">(</span><span class="s1">left</span><span class="s2">) || </span><span class="s1">hasUnset</span><span class="s2">(</span><span class="s1">right</span><span class="s2">)) { </span><span class="s0">continue</span><span class="s2">; }</span>

        <span class="s1">component </span><span class="s2">= </span><span class="s1">findComponentIn</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">);</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">everyValuesPair</span><span class="s2">(</span><span class="s1">mayOverride</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s0">null</span><span class="s2">, </span><span class="s1">validator</span><span class="s2">), </span><span class="s1">component</span><span class="s2">, </span><span class="s1">right</span><span class="s2">)) {</span>
          <span class="s0">var </span><span class="s1">disabledBackgroundMerging </span><span class="s2">= !</span><span class="s1">compatibility</span><span class="s2">.</span><span class="s1">properties</span><span class="s2">.</span><span class="s1">backgroundClipMerging </span><span class="s2">&amp;&amp; </span><span class="s1">component</span><span class="s2">.</span><span class="s1">name</span><span class="s2">.</span><span class="s1">indexOf</span><span class="s2">(</span><span class="s3">'background-clip'</span><span class="s2">) &gt; -</span><span class="s4">1</span>
            <span class="s2">|| !</span><span class="s1">compatibility</span><span class="s2">.</span><span class="s1">properties</span><span class="s2">.</span><span class="s1">backgroundOriginMerging </span><span class="s2">&amp;&amp; </span><span class="s1">component</span><span class="s2">.</span><span class="s1">name</span><span class="s2">.</span><span class="s1">indexOf</span><span class="s2">(</span><span class="s3">'background-origin'</span><span class="s2">) &gt; -</span><span class="s4">1</span>
            <span class="s2">|| !</span><span class="s1">compatibility</span><span class="s2">.</span><span class="s1">properties</span><span class="s2">.</span><span class="s1">backgroundSizeMerging </span><span class="s2">&amp;&amp; </span><span class="s1">component</span><span class="s2">.</span><span class="s1">name</span><span class="s2">.</span><span class="s1">indexOf</span><span class="s2">(</span><span class="s3">'background-size'</span><span class="s2">) &gt; -</span><span class="s4">1</span><span class="s2">;</span>
          <span class="s0">var </span><span class="s1">nonMergeableValue </span><span class="s2">= </span><span class="s1">configuration</span><span class="s2">[</span><span class="s1">right</span><span class="s2">.</span><span class="s1">name</span><span class="s2">].</span><span class="s1">nonMergeableValue </span><span class="s2">=== </span><span class="s1">right</span><span class="s2">.</span><span class="s1">value</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s4">1</span><span class="s2">];</span>

          <span class="s0">if </span><span class="s2">(</span><span class="s1">disabledBackgroundMerging </span><span class="s2">|| </span><span class="s1">nonMergeableValue</span><span class="s2">) { </span><span class="s0">continue</span><span class="s2">; }</span>

          <span class="s0">if </span><span class="s2">(!</span><span class="s1">compatibility</span><span class="s2">.</span><span class="s1">properties</span><span class="s2">.</span><span class="s1">merging </span><span class="s2">&amp;&amp; </span><span class="s1">wouldBreakCompatibility</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">validator</span><span class="s2">)) { </span><span class="s0">continue</span><span class="s2">; }</span>

          <span class="s0">if </span><span class="s2">(</span><span class="s1">component</span><span class="s2">.</span><span class="s1">value</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s4">1</span><span class="s2">] != </span><span class="s1">right</span><span class="s2">.</span><span class="s1">value</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s4">1</span><span class="s2">] &amp;&amp; (</span><span class="s1">hasInherit</span><span class="s2">(</span><span class="s1">left</span><span class="s2">) || </span><span class="s1">hasInherit</span><span class="s2">(</span><span class="s1">right</span><span class="s2">))) { </span><span class="s0">continue</span><span class="s2">; }</span>

          <span class="s0">if </span><span class="s2">(</span><span class="s1">wouldResultInLongerValue</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">)) { </span><span class="s0">continue</span><span class="s2">; }</span>

          <span class="s0">if </span><span class="s2">(!</span><span class="s1">left</span><span class="s2">.</span><span class="s1">multiplex </span><span class="s2">&amp;&amp; </span><span class="s1">right</span><span class="s2">.</span><span class="s1">multiplex</span><span class="s2">) { </span><span class="s1">turnIntoMultiplex</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">multiplexSize</span><span class="s2">(</span><span class="s1">right</span><span class="s2">)); }</span>

          <span class="s1">override</span><span class="s2">(</span><span class="s1">component</span><span class="s2">, </span><span class="s1">right</span><span class="s2">);</span>
          <span class="s1">left</span><span class="s2">.</span><span class="s1">dirty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
        <span class="s2">}</span>
      <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">withMerging </span><span class="s2">&amp;&amp; </span><span class="s1">left</span><span class="s2">.</span><span class="s1">shorthand </span><span class="s2">&amp;&amp; </span><span class="s1">right</span><span class="s2">.</span><span class="s1">shorthand </span><span class="s2">&amp;&amp; </span><span class="s1">left</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s1">right</span><span class="s2">.</span><span class="s1">name</span><span class="s2">) {</span>
        <span class="s5">// merge if all components can be merged</span>

        <span class="s0">if </span><span class="s2">(!</span><span class="s1">left</span><span class="s2">.</span><span class="s1">multiplex </span><span class="s2">&amp;&amp; </span><span class="s1">right</span><span class="s2">.</span><span class="s1">multiplex</span><span class="s2">) { </span><span class="s0">continue</span><span class="s2">; }</span>

        <span class="s0">if </span><span class="s2">(!</span><span class="s1">right</span><span class="s2">.</span><span class="s1">important </span><span class="s2">&amp;&amp; </span><span class="s1">left</span><span class="s2">.</span><span class="s1">important</span><span class="s2">) {</span>
          <span class="s1">right</span><span class="s2">.</span><span class="s1">unused </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
          <span class="s0">continue </span><span class="s1">propertyLoop</span><span class="s2">;</span>
        <span class="s2">}</span>

        <span class="s0">if </span><span class="s2">(</span><span class="s1">right</span><span class="s2">.</span><span class="s1">important </span><span class="s2">&amp;&amp; !</span><span class="s1">left</span><span class="s2">.</span><span class="s1">important</span><span class="s2">) {</span>
          <span class="s1">left</span><span class="s2">.</span><span class="s1">unused </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
          <span class="s0">continue</span><span class="s2">;</span>
        <span class="s2">}</span>

        <span class="s0">if </span><span class="s2">(!</span><span class="s1">isMergeableShorthand</span><span class="s2">(</span><span class="s1">right</span><span class="s2">)) {</span>
          <span class="s1">left</span><span class="s2">.</span><span class="s1">unused </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
          <span class="s0">continue</span><span class="s2">;</span>
        <span class="s2">}</span>

        <span class="s0">for </span><span class="s2">(</span><span class="s1">k </span><span class="s2">= </span><span class="s1">left</span><span class="s2">.</span><span class="s1">components</span><span class="s2">.</span><span class="s1">length </span><span class="s2">- </span><span class="s4">1</span><span class="s2">; </span><span class="s1">k </span><span class="s2">&gt;= </span><span class="s4">0</span><span class="s2">; </span><span class="s1">k</span><span class="s2">--) {</span>
          <span class="s0">var </span><span class="s1">leftComponent </span><span class="s2">= </span><span class="s1">left</span><span class="s2">.</span><span class="s1">components</span><span class="s2">[</span><span class="s1">k</span><span class="s2">];</span>
          <span class="s0">var </span><span class="s1">rightComponent </span><span class="s2">= </span><span class="s1">right</span><span class="s2">.</span><span class="s1">components</span><span class="s2">[</span><span class="s1">k</span><span class="s2">];</span>

          <span class="s1">mayOverride </span><span class="s2">= </span><span class="s1">configuration</span><span class="s2">[</span><span class="s1">leftComponent</span><span class="s2">.</span><span class="s1">name</span><span class="s2">].</span><span class="s1">canOverride </span><span class="s2">|| </span><span class="s1">sameValue</span><span class="s2">;</span>
          <span class="s0">if </span><span class="s2">(!</span><span class="s1">everyValuesPair</span><span class="s2">(</span><span class="s1">mayOverride</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s0">null</span><span class="s2">, </span><span class="s1">validator</span><span class="s2">), </span><span class="s1">leftComponent</span><span class="s2">, </span><span class="s1">rightComponent</span><span class="s2">)) {</span>
            <span class="s0">continue </span><span class="s1">propertyLoop</span><span class="s2">;</span>
          <span class="s2">}</span>
        <span class="s2">}</span>

        <span class="s1">overrideShorthand</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">);</span>
        <span class="s1">left</span><span class="s2">.</span><span class="s1">dirty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
      <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">withMerging </span><span class="s2">&amp;&amp; </span><span class="s1">left</span><span class="s2">.</span><span class="s1">shorthand </span><span class="s2">&amp;&amp; </span><span class="s1">right</span><span class="s2">.</span><span class="s1">shorthand </span><span class="s2">&amp;&amp; </span><span class="s1">isComponentOf</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">)) {</span>
        <span class="s5">// border is a shorthand but any of its components is a shorthand too</span>

        <span class="s0">if </span><span class="s2">(!</span><span class="s1">left</span><span class="s2">.</span><span class="s1">important </span><span class="s2">&amp;&amp; </span><span class="s1">right</span><span class="s2">.</span><span class="s1">important</span><span class="s2">) { </span><span class="s0">continue</span><span class="s2">; }</span>

        <span class="s1">component </span><span class="s2">= </span><span class="s1">findComponentIn</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">);</span>
        <span class="s1">mayOverride </span><span class="s2">= </span><span class="s1">configuration</span><span class="s2">[</span><span class="s1">right</span><span class="s2">.</span><span class="s1">name</span><span class="s2">].</span><span class="s1">canOverride </span><span class="s2">|| </span><span class="s1">sameValue</span><span class="s2">;</span>
        <span class="s0">if </span><span class="s2">(!</span><span class="s1">everyValuesPair</span><span class="s2">(</span><span class="s1">mayOverride</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s0">null</span><span class="s2">, </span><span class="s1">validator</span><span class="s2">), </span><span class="s1">component</span><span class="s2">, </span><span class="s1">right</span><span class="s2">)) { </span><span class="s0">continue</span><span class="s2">; }</span>

        <span class="s0">if </span><span class="s2">(</span><span class="s1">left</span><span class="s2">.</span><span class="s1">important </span><span class="s2">&amp;&amp; !</span><span class="s1">right</span><span class="s2">.</span><span class="s1">important</span><span class="s2">) {</span>
          <span class="s1">right</span><span class="s2">.</span><span class="s1">unused </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
          <span class="s0">continue</span><span class="s2">;</span>
        <span class="s2">}</span>

        <span class="s0">var </span><span class="s1">rightRestored </span><span class="s2">= </span><span class="s1">configuration</span><span class="s2">[</span><span class="s1">right</span><span class="s2">.</span><span class="s1">name</span><span class="s2">].</span><span class="s1">restore</span><span class="s2">(</span><span class="s1">right</span><span class="s2">, </span><span class="s1">configuration</span><span class="s2">);</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">rightRestored</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s4">1</span><span class="s2">) { </span><span class="s0">continue</span><span class="s2">; }</span>

        <span class="s1">component </span><span class="s2">= </span><span class="s1">findComponentIn</span><span class="s2">(</span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">);</span>
        <span class="s1">override</span><span class="s2">(</span><span class="s1">component</span><span class="s2">, </span><span class="s1">right</span><span class="s2">);</span>
        <span class="s1">right</span><span class="s2">.</span><span class="s1">dirty </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
      <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">left</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s1">right</span><span class="s2">.</span><span class="s1">name</span><span class="s2">) {</span>
        <span class="s5">// two non-shorthands should be merged based on understandability</span>
        <span class="s1">overridable </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>

        <span class="s0">if </span><span class="s2">(</span><span class="s1">right</span><span class="s2">.</span><span class="s1">shorthand</span><span class="s2">) {</span>
          <span class="s0">for </span><span class="s2">(</span><span class="s1">k </span><span class="s2">= </span><span class="s1">right</span><span class="s2">.</span><span class="s1">components</span><span class="s2">.</span><span class="s1">length </span><span class="s2">- </span><span class="s4">1</span><span class="s2">; </span><span class="s1">k </span><span class="s2">&gt;= </span><span class="s4">0 </span><span class="s2">&amp;&amp; </span><span class="s1">overridable</span><span class="s2">; </span><span class="s1">k</span><span class="s2">--) {</span>
            <span class="s1">overriddenComponent </span><span class="s2">= </span><span class="s1">left</span><span class="s2">.</span><span class="s1">components</span><span class="s2">[</span><span class="s1">k</span><span class="s2">];</span>
            <span class="s1">overridingComponent </span><span class="s2">= </span><span class="s1">right</span><span class="s2">.</span><span class="s1">components</span><span class="s2">[</span><span class="s1">k</span><span class="s2">];</span>
            <span class="s1">mayOverride </span><span class="s2">= </span><span class="s1">configuration</span><span class="s2">[</span><span class="s1">overridingComponent</span><span class="s2">.</span><span class="s1">name</span><span class="s2">].</span><span class="s1">canOverride </span><span class="s2">|| </span><span class="s1">sameValue</span><span class="s2">;</span>

            <span class="s1">overridable </span><span class="s2">= </span><span class="s1">everyValuesPair</span><span class="s2">(</span><span class="s1">mayOverride</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s0">null</span><span class="s2">, </span><span class="s1">validator</span><span class="s2">), </span><span class="s1">overriddenComponent</span><span class="s2">, </span><span class="s1">overridingComponent</span><span class="s2">);</span>
          <span class="s2">}</span>
        <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
          <span class="s1">mayOverride </span><span class="s2">= </span><span class="s1">configuration</span><span class="s2">[</span><span class="s1">right</span><span class="s2">.</span><span class="s1">name</span><span class="s2">].</span><span class="s1">canOverride </span><span class="s2">|| </span><span class="s1">sameValue</span><span class="s2">;</span>
          <span class="s1">overridable </span><span class="s2">= </span><span class="s1">everyValuesPair</span><span class="s2">(</span><span class="s1">mayOverride</span><span class="s2">.</span><span class="s1">bind</span><span class="s2">(</span><span class="s0">null</span><span class="s2">, </span><span class="s1">validator</span><span class="s2">), </span><span class="s1">left</span><span class="s2">, </span><span class="s1">right</span><span class="s2">);</span>
        <span class="s2">}</span>

        <span class="s0">if </span><span class="s2">(</span><span class="s1">left</span><span class="s2">.</span><span class="s1">important </span><span class="s2">&amp;&amp; !</span><span class="s1">right</span><span class="s2">.</span><span class="s1">important </span><span class="s2">&amp;&amp; </span><span class="s1">overridable</span><span class="s2">) {</span>
          <span class="s1">right</span><span class="s2">.</span><span class="s1">unused </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
          <span class="s0">continue</span><span class="s2">;</span>
        <span class="s2">}</span>

        <span class="s0">if </span><span class="s2">(!</span><span class="s1">left</span><span class="s2">.</span><span class="s1">important </span><span class="s2">&amp;&amp; </span><span class="s1">right</span><span class="s2">.</span><span class="s1">important </span><span class="s2">&amp;&amp; </span><span class="s1">overridable</span><span class="s2">) {</span>
          <span class="s1">left</span><span class="s2">.</span><span class="s1">unused </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
          <span class="s0">continue</span><span class="s2">;</span>
        <span class="s2">}</span>

        <span class="s0">if </span><span class="s2">(!</span><span class="s1">overridable</span><span class="s2">) {</span>
          <span class="s0">continue</span><span class="s2">;</span>
        <span class="s2">}</span>

        <span class="s1">left</span><span class="s2">.</span><span class="s1">unused </span><span class="s2">= </span><span class="s0">true</span><span class="s2">;</span>
      <span class="s2">}</span>
    <span class="s2">}</span>
  <span class="s2">}</span>
<span class="s2">}</span>

<span class="s1">module</span><span class="s2">.</span><span class="s1">exports </span><span class="s2">= </span><span class="s1">overrideProperties</span><span class="s2">;</span>
</pre>
</body>
</html>