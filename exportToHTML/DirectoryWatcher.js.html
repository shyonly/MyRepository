<html>
<head>
<title>DirectoryWatcher.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #6aab73;}
.s3 { color: #bcbec4;}
.s4 { color: #cf8e6d;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
.s7 { color: #67a37c; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
DirectoryWatcher.js</font>
</center></td></tr></table>
<pre><span class="s0">/* 
    MIT License http://www.opensource.org/licenses/mit-license.php 
    Author Tobias Koppers @sokra 
*/</span>
<span class="s2">&quot;use strict&quot;</span><span class="s3">;</span>

<span class="s4">const </span><span class="s1">EventEmitter </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">&quot;events&quot;</span><span class="s3">).</span><span class="s1">EventEmitter</span><span class="s3">;</span>
<span class="s4">const </span><span class="s1">fs </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">&quot;graceful-fs&quot;</span><span class="s3">);</span>
<span class="s4">const </span><span class="s1">path </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">&quot;path&quot;</span><span class="s3">);</span>

<span class="s4">const </span><span class="s1">watchEventSource </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">&quot;./watchEventSource&quot;</span><span class="s3">);</span>

<span class="s4">const </span><span class="s1">EXISTANCE_ONLY_TIME_ENTRY </span><span class="s3">= </span><span class="s1">Object</span><span class="s3">.</span><span class="s1">freeze</span><span class="s3">({});</span>

<span class="s4">let </span><span class="s1">FS_ACCURACY </span><span class="s3">= </span><span class="s5">2000</span><span class="s3">;</span>

<span class="s4">const </span><span class="s1">IS_OSX </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">&quot;os&quot;</span><span class="s3">).</span><span class="s1">platform</span><span class="s3">() === </span><span class="s2">&quot;darwin&quot;</span><span class="s3">;</span>
<span class="s4">const </span><span class="s1">WATCHPACK_POLLING </span><span class="s3">= </span><span class="s1">process</span><span class="s3">.</span><span class="s1">env</span><span class="s3">.</span><span class="s1">WATCHPACK_POLLING</span><span class="s3">;</span>
<span class="s4">const </span><span class="s1">FORCE_POLLING </span><span class="s3">=</span>
	<span class="s2">`</span><span class="s1">$</span><span class="s3">{+</span><span class="s1">WATCHPACK_POLLING</span><span class="s3">}</span><span class="s2">` </span><span class="s3">=== </span><span class="s1">WATCHPACK_POLLING</span>
		<span class="s3">? +</span><span class="s1">WATCHPACK_POLLING</span>
		<span class="s3">: !!</span><span class="s1">WATCHPACK_POLLING </span><span class="s3">&amp;&amp; </span><span class="s1">WATCHPACK_POLLING </span><span class="s3">!== </span><span class="s2">&quot;false&quot;</span><span class="s3">;</span>

<span class="s4">function </span><span class="s1">withoutCase</span><span class="s3">(</span><span class="s1">str</span><span class="s3">) {</span>
	<span class="s4">return </span><span class="s1">str</span><span class="s3">.</span><span class="s1">toLowerCase</span><span class="s3">();</span>
<span class="s3">}</span>

<span class="s4">function </span><span class="s1">needCalls</span><span class="s3">(</span><span class="s1">times</span><span class="s3">, </span><span class="s1">callback</span><span class="s3">) {</span>
	<span class="s4">return function</span><span class="s3">() {</span>
		<span class="s4">if </span><span class="s3">(--</span><span class="s1">times </span><span class="s3">=== </span><span class="s5">0</span><span class="s3">) {</span>
			<span class="s4">return </span><span class="s1">callback</span><span class="s3">();</span>
		<span class="s3">}</span>
	<span class="s3">};</span>
<span class="s3">}</span>

<span class="s4">class </span><span class="s1">Watcher </span><span class="s4">extends </span><span class="s1">EventEmitter </span><span class="s3">{</span>
	<span class="s1">constructor</span><span class="s3">(</span><span class="s1">directoryWatcher</span><span class="s3">, </span><span class="s1">filePath</span><span class="s3">, </span><span class="s1">startTime</span><span class="s3">) {</span>
		<span class="s4">super</span><span class="s3">();</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">directoryWatcher </span><span class="s3">= </span><span class="s1">directoryWatcher</span><span class="s3">;</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">path </span><span class="s3">= </span><span class="s1">filePath</span><span class="s3">;</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">startTime </span><span class="s3">= </span><span class="s1">startTime </span><span class="s3">&amp;&amp; +</span><span class="s1">startTime</span><span class="s3">;</span>
	<span class="s3">}</span>

	<span class="s1">checkStartTime</span><span class="s3">(</span><span class="s1">mtime</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">) {</span>
		<span class="s4">const </span><span class="s1">startTime </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">startTime</span><span class="s3">;</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s4">typeof </span><span class="s1">startTime </span><span class="s3">!== </span><span class="s2">&quot;number&quot;</span><span class="s3">) </span><span class="s4">return </span><span class="s3">!</span><span class="s1">initial</span><span class="s3">;</span>
		<span class="s4">return </span><span class="s1">startTime </span><span class="s3">&lt;= </span><span class="s1">mtime</span><span class="s3">;</span>
	<span class="s3">}</span>

	<span class="s1">close</span><span class="s3">() {</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s2">&quot;closed&quot;</span><span class="s3">);</span>
	<span class="s3">}</span>
<span class="s3">}</span>

<span class="s4">class </span><span class="s1">DirectoryWatcher </span><span class="s4">extends </span><span class="s1">EventEmitter </span><span class="s3">{</span>
	<span class="s1">constructor</span><span class="s3">(</span><span class="s1">watcherManager</span><span class="s3">, </span><span class="s1">directoryPath</span><span class="s3">, </span><span class="s1">options</span><span class="s3">) {</span>
		<span class="s4">super</span><span class="s3">();</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s1">FORCE_POLLING</span><span class="s3">) {</span>
			<span class="s1">options</span><span class="s3">.</span><span class="s1">poll </span><span class="s3">= </span><span class="s1">FORCE_POLLING</span><span class="s3">;</span>
		<span class="s3">}</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">watcherManager </span><span class="s3">= </span><span class="s1">watcherManager</span><span class="s3">;</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">options </span><span class="s3">= </span><span class="s1">options</span><span class="s3">;</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">path </span><span class="s3">= </span><span class="s1">directoryPath</span><span class="s3">;</span>
		<span class="s0">// safeTime is the point in time after which reading is safe to be unchanged</span>
		<span class="s0">// timestamp is a value that should be compared with another timestamp (mtime)</span>
		<span class="s6">/** </span><span class="s7">@type </span><span class="s6">{Map&lt;string, { safeTime: number, timestamp: number }} */</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">files </span><span class="s3">= </span><span class="s4">new </span><span class="s1">Map</span><span class="s3">();</span>
		<span class="s6">/** </span><span class="s7">@type </span><span class="s6">{Map&lt;string, number&gt;} */</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">filesWithoutCase </span><span class="s3">= </span><span class="s4">new </span><span class="s1">Map</span><span class="s3">();</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">directories </span><span class="s3">= </span><span class="s4">new </span><span class="s1">Map</span><span class="s3">();</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">lastWatchEvent </span><span class="s3">= </span><span class="s5">0</span><span class="s3">;</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">initialScan </span><span class="s3">= </span><span class="s4">true</span><span class="s3">;</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">ignored </span><span class="s3">= </span><span class="s1">options</span><span class="s3">.</span><span class="s1">ignored </span><span class="s3">|| (() =&gt; </span><span class="s4">false</span><span class="s3">);</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">nestedWatching </span><span class="s3">= </span><span class="s4">false</span><span class="s3">;</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">polledWatching </span><span class="s3">=</span>
			<span class="s4">typeof </span><span class="s1">options</span><span class="s3">.</span><span class="s1">poll </span><span class="s3">=== </span><span class="s2">&quot;number&quot;</span>
				<span class="s3">? </span><span class="s1">options</span><span class="s3">.</span><span class="s1">poll</span>
				<span class="s3">: </span><span class="s1">options</span><span class="s3">.</span><span class="s1">poll</span>
				<span class="s3">? </span><span class="s5">5007</span>
				<span class="s3">: </span><span class="s4">false</span><span class="s3">;</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">timeout </span><span class="s3">= </span><span class="s1">undefined</span><span class="s3">;</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">initialScanRemoved </span><span class="s3">= </span><span class="s4">new </span><span class="s1">Set</span><span class="s3">();</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">initialScanFinished </span><span class="s3">= </span><span class="s1">undefined</span><span class="s3">;</span>
		<span class="s6">/** </span><span class="s7">@type </span><span class="s6">{Map&lt;string, Set&lt;Watcher&gt;&gt;} */</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">watchers </span><span class="s3">= </span><span class="s4">new </span><span class="s1">Map</span><span class="s3">();</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">parentWatcher </span><span class="s3">= </span><span class="s4">null</span><span class="s3">;</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">refs </span><span class="s3">= </span><span class="s5">0</span><span class="s3">;</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">_activeEvents </span><span class="s3">= </span><span class="s4">new </span><span class="s1">Map</span><span class="s3">();</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">closed </span><span class="s3">= </span><span class="s4">false</span><span class="s3">;</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">scanning </span><span class="s3">= </span><span class="s4">false</span><span class="s3">;</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">scanAgain </span><span class="s3">= </span><span class="s4">false</span><span class="s3">;</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">scanAgainInitial </span><span class="s3">= </span><span class="s4">false</span><span class="s3">;</span>

		<span class="s4">this</span><span class="s3">.</span><span class="s1">createWatcher</span><span class="s3">();</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">doScan</span><span class="s3">(</span><span class="s4">true</span><span class="s3">);</span>
	<span class="s3">}</span>

	<span class="s1">createWatcher</span><span class="s3">() {</span>
		<span class="s4">try </span><span class="s3">{</span>
			<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">polledWatching</span><span class="s3">) {</span>
				<span class="s4">this</span><span class="s3">.</span><span class="s1">watcher </span><span class="s3">= {</span>
					<span class="s1">close</span><span class="s3">: () =&gt; {</span>
						<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">timeout</span><span class="s3">) {</span>
							<span class="s1">clearTimeout</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">timeout</span><span class="s3">);</span>
							<span class="s4">this</span><span class="s3">.</span><span class="s1">timeout </span><span class="s3">= </span><span class="s1">undefined</span><span class="s3">;</span>
						<span class="s3">}</span>
					<span class="s3">}</span>
				<span class="s3">};</span>
			<span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
				<span class="s4">if </span><span class="s3">(</span><span class="s1">IS_OSX</span><span class="s3">) {</span>
					<span class="s4">this</span><span class="s3">.</span><span class="s1">watchInParentDirectory</span><span class="s3">();</span>
				<span class="s3">}</span>
				<span class="s4">this</span><span class="s3">.</span><span class="s1">watcher </span><span class="s3">= </span><span class="s1">watchEventSource</span><span class="s3">.</span><span class="s1">watch</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">path</span><span class="s3">);</span>
				<span class="s4">this</span><span class="s3">.</span><span class="s1">watcher</span><span class="s3">.</span><span class="s1">on</span><span class="s3">(</span><span class="s2">&quot;change&quot;</span><span class="s3">, </span><span class="s4">this</span><span class="s3">.</span><span class="s1">onWatchEvent</span><span class="s3">.</span><span class="s1">bind</span><span class="s3">(</span><span class="s4">this</span><span class="s3">));</span>
				<span class="s4">this</span><span class="s3">.</span><span class="s1">watcher</span><span class="s3">.</span><span class="s1">on</span><span class="s3">(</span><span class="s2">&quot;error&quot;</span><span class="s3">, </span><span class="s4">this</span><span class="s3">.</span><span class="s1">onWatcherError</span><span class="s3">.</span><span class="s1">bind</span><span class="s3">(</span><span class="s4">this</span><span class="s3">));</span>
			<span class="s3">}</span>
		<span class="s3">} </span><span class="s4">catch </span><span class="s3">(</span><span class="s1">err</span><span class="s3">) {</span>
			<span class="s4">this</span><span class="s3">.</span><span class="s1">onWatcherError</span><span class="s3">(</span><span class="s1">err</span><span class="s3">);</span>
		<span class="s3">}</span>
	<span class="s3">}</span>

	<span class="s1">forEachWatcher</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">fn</span><span class="s3">) {</span>
		<span class="s4">const </span><span class="s1">watchers </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">watchers</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">withoutCase</span><span class="s3">(</span><span class="s1">path</span><span class="s3">));</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s1">watchers </span><span class="s3">!== </span><span class="s1">undefined</span><span class="s3">) {</span>
			<span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s1">w of watchers</span><span class="s3">) {</span>
				<span class="s1">fn</span><span class="s3">(</span><span class="s1">w</span><span class="s3">);</span>
			<span class="s3">}</span>
		<span class="s3">}</span>
	<span class="s3">}</span>

	<span class="s1">setMissing</span><span class="s3">(</span><span class="s1">itemPath</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">, </span><span class="s1">type</span><span class="s3">) {</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">initialScan</span><span class="s3">) {</span>
			<span class="s4">this</span><span class="s3">.</span><span class="s1">initialScanRemoved</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">itemPath</span><span class="s3">);</span>
		<span class="s3">}</span>

		<span class="s4">const </span><span class="s1">oldDirectory </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">directories</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">itemPath</span><span class="s3">);</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s1">oldDirectory</span><span class="s3">) {</span>
			<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">nestedWatching</span><span class="s3">) </span><span class="s1">oldDirectory</span><span class="s3">.</span><span class="s1">close</span><span class="s3">();</span>
			<span class="s4">this</span><span class="s3">.</span><span class="s1">directories</span><span class="s3">.</span><span class="s1">delete</span><span class="s3">(</span><span class="s1">itemPath</span><span class="s3">);</span>

			<span class="s4">this</span><span class="s3">.</span><span class="s1">forEachWatcher</span><span class="s3">(</span><span class="s1">itemPath</span><span class="s3">, </span><span class="s1">w </span><span class="s3">=&gt; </span><span class="s1">w</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s2">&quot;remove&quot;</span><span class="s3">, </span><span class="s1">type</span><span class="s3">));</span>
			<span class="s4">if </span><span class="s3">(!</span><span class="s1">initial</span><span class="s3">) {</span>
				<span class="s4">this</span><span class="s3">.</span><span class="s1">forEachWatcher</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">path</span><span class="s3">, </span><span class="s1">w </span><span class="s3">=&gt;</span>
					<span class="s1">w</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s2">&quot;change&quot;</span><span class="s3">, </span><span class="s1">itemPath</span><span class="s3">, </span><span class="s4">null</span><span class="s3">, </span><span class="s1">type</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">)</span>
				<span class="s3">);</span>
			<span class="s3">}</span>
		<span class="s3">}</span>

		<span class="s4">const </span><span class="s1">oldFile </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">files</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">itemPath</span><span class="s3">);</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s1">oldFile</span><span class="s3">) {</span>
			<span class="s4">this</span><span class="s3">.</span><span class="s1">files</span><span class="s3">.</span><span class="s1">delete</span><span class="s3">(</span><span class="s1">itemPath</span><span class="s3">);</span>
			<span class="s4">const </span><span class="s1">key </span><span class="s3">= </span><span class="s1">withoutCase</span><span class="s3">(</span><span class="s1">itemPath</span><span class="s3">);</span>
			<span class="s4">const </span><span class="s1">count </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">filesWithoutCase</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">key</span><span class="s3">) - </span><span class="s5">1</span><span class="s3">;</span>
			<span class="s4">if </span><span class="s3">(</span><span class="s1">count </span><span class="s3">&lt;= </span><span class="s5">0</span><span class="s3">) {</span>
				<span class="s4">this</span><span class="s3">.</span><span class="s1">filesWithoutCase</span><span class="s3">.</span><span class="s1">delete</span><span class="s3">(</span><span class="s1">key</span><span class="s3">);</span>
				<span class="s4">this</span><span class="s3">.</span><span class="s1">forEachWatcher</span><span class="s3">(</span><span class="s1">itemPath</span><span class="s3">, </span><span class="s1">w </span><span class="s3">=&gt; </span><span class="s1">w</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s2">&quot;remove&quot;</span><span class="s3">, </span><span class="s1">type</span><span class="s3">));</span>
			<span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
				<span class="s4">this</span><span class="s3">.</span><span class="s1">filesWithoutCase</span><span class="s3">.</span><span class="s1">set</span><span class="s3">(</span><span class="s1">key</span><span class="s3">, </span><span class="s1">count</span><span class="s3">);</span>
			<span class="s3">}</span>

			<span class="s4">if </span><span class="s3">(!</span><span class="s1">initial</span><span class="s3">) {</span>
				<span class="s4">this</span><span class="s3">.</span><span class="s1">forEachWatcher</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">path</span><span class="s3">, </span><span class="s1">w </span><span class="s3">=&gt;</span>
					<span class="s1">w</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s2">&quot;change&quot;</span><span class="s3">, </span><span class="s1">itemPath</span><span class="s3">, </span><span class="s4">null</span><span class="s3">, </span><span class="s1">type</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">)</span>
				<span class="s3">);</span>
			<span class="s3">}</span>
		<span class="s3">}</span>
	<span class="s3">}</span>

	<span class="s1">setFileTime</span><span class="s3">(</span><span class="s1">filePath</span><span class="s3">, </span><span class="s1">mtime</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">, </span><span class="s1">ignoreWhenEqual</span><span class="s3">, </span><span class="s1">type</span><span class="s3">) {</span>
		<span class="s4">const </span><span class="s1">now </span><span class="s3">= </span><span class="s1">Date</span><span class="s3">.</span><span class="s1">now</span><span class="s3">();</span>

		<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">ignored</span><span class="s3">(</span><span class="s1">filePath</span><span class="s3">)) </span><span class="s4">return</span><span class="s3">;</span>

		<span class="s4">const </span><span class="s1">old </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">files</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">filePath</span><span class="s3">);</span>

		<span class="s4">let </span><span class="s1">safeTime</span><span class="s3">, </span><span class="s1">accuracy</span><span class="s3">;</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s1">initial</span><span class="s3">) {</span>
			<span class="s1">safeTime </span><span class="s3">= </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(</span><span class="s1">now</span><span class="s3">, </span><span class="s1">mtime</span><span class="s3">) + </span><span class="s1">FS_ACCURACY</span><span class="s3">;</span>
			<span class="s1">accuracy </span><span class="s3">= </span><span class="s1">FS_ACCURACY</span><span class="s3">;</span>
		<span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
			<span class="s1">safeTime </span><span class="s3">= </span><span class="s1">now</span><span class="s3">;</span>
			<span class="s1">accuracy </span><span class="s3">= </span><span class="s5">0</span><span class="s3">;</span>

			<span class="s4">if </span><span class="s3">(</span><span class="s1">old </span><span class="s3">&amp;&amp; </span><span class="s1">old</span><span class="s3">.</span><span class="s1">timestamp </span><span class="s3">=== </span><span class="s1">mtime </span><span class="s3">&amp;&amp; </span><span class="s1">mtime </span><span class="s3">+ </span><span class="s1">FS_ACCURACY </span><span class="s3">&lt; </span><span class="s1">now</span><span class="s3">) {</span>
				<span class="s0">// We are sure that mtime is untouched</span>
				<span class="s0">// This can be caused by some file attribute change</span>
				<span class="s0">// e. g. when access time has been changed</span>
				<span class="s0">// but the file content is untouched</span>
				<span class="s4">return</span><span class="s3">;</span>
			<span class="s3">}</span>
		<span class="s3">}</span>

		<span class="s4">if </span><span class="s3">(</span><span class="s1">ignoreWhenEqual </span><span class="s3">&amp;&amp; </span><span class="s1">old </span><span class="s3">&amp;&amp; </span><span class="s1">old</span><span class="s3">.</span><span class="s1">timestamp </span><span class="s3">=== </span><span class="s1">mtime</span><span class="s3">) </span><span class="s4">return</span><span class="s3">;</span>

		<span class="s4">this</span><span class="s3">.</span><span class="s1">files</span><span class="s3">.</span><span class="s1">set</span><span class="s3">(</span><span class="s1">filePath</span><span class="s3">, {</span>
			<span class="s1">safeTime</span><span class="s3">,</span>
			<span class="s1">accuracy</span><span class="s3">,</span>
			<span class="s1">timestamp</span><span class="s3">: </span><span class="s1">mtime</span>
		<span class="s3">});</span>

		<span class="s4">if </span><span class="s3">(!</span><span class="s1">old</span><span class="s3">) {</span>
			<span class="s4">const </span><span class="s1">key </span><span class="s3">= </span><span class="s1">withoutCase</span><span class="s3">(</span><span class="s1">filePath</span><span class="s3">);</span>
			<span class="s4">const </span><span class="s1">count </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">filesWithoutCase</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">key</span><span class="s3">);</span>
			<span class="s4">this</span><span class="s3">.</span><span class="s1">filesWithoutCase</span><span class="s3">.</span><span class="s1">set</span><span class="s3">(</span><span class="s1">key</span><span class="s3">, (</span><span class="s1">count </span><span class="s3">|| </span><span class="s5">0</span><span class="s3">) + </span><span class="s5">1</span><span class="s3">);</span>
			<span class="s4">if </span><span class="s3">(</span><span class="s1">count </span><span class="s3">!== </span><span class="s1">undefined</span><span class="s3">) {</span>
				<span class="s0">// There is already a file with case-insensitive-equal name</span>
				<span class="s0">// On a case-insensitive filesystem we may miss the renaming</span>
				<span class="s0">// when only casing is changed.</span>
				<span class="s0">// To be sure that our information is correct</span>
				<span class="s0">// we trigger a rescan here</span>
				<span class="s4">this</span><span class="s3">.</span><span class="s1">doScan</span><span class="s3">(</span><span class="s4">false</span><span class="s3">);</span>
			<span class="s3">}</span>

			<span class="s4">this</span><span class="s3">.</span><span class="s1">forEachWatcher</span><span class="s3">(</span><span class="s1">filePath</span><span class="s3">, </span><span class="s1">w </span><span class="s3">=&gt; {</span>
				<span class="s4">if </span><span class="s3">(!</span><span class="s1">initial </span><span class="s3">|| </span><span class="s1">w</span><span class="s3">.</span><span class="s1">checkStartTime</span><span class="s3">(</span><span class="s1">safeTime</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">)) {</span>
					<span class="s1">w</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s2">&quot;change&quot;</span><span class="s3">, </span><span class="s1">mtime</span><span class="s3">, </span><span class="s1">type</span><span class="s3">);</span>
				<span class="s3">}</span>
			<span class="s3">});</span>
		<span class="s3">} </span><span class="s4">else if </span><span class="s3">(!</span><span class="s1">initial</span><span class="s3">) {</span>
			<span class="s4">this</span><span class="s3">.</span><span class="s1">forEachWatcher</span><span class="s3">(</span><span class="s1">filePath</span><span class="s3">, </span><span class="s1">w </span><span class="s3">=&gt; </span><span class="s1">w</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s2">&quot;change&quot;</span><span class="s3">, </span><span class="s1">mtime</span><span class="s3">, </span><span class="s1">type</span><span class="s3">));</span>
		<span class="s3">}</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">forEachWatcher</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">path</span><span class="s3">, </span><span class="s1">w </span><span class="s3">=&gt; {</span>
			<span class="s4">if </span><span class="s3">(!</span><span class="s1">initial </span><span class="s3">|| </span><span class="s1">w</span><span class="s3">.</span><span class="s1">checkStartTime</span><span class="s3">(</span><span class="s1">safeTime</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">)) {</span>
				<span class="s1">w</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s2">&quot;change&quot;</span><span class="s3">, </span><span class="s1">filePath</span><span class="s3">, </span><span class="s1">safeTime</span><span class="s3">, </span><span class="s1">type</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">);</span>
			<span class="s3">}</span>
		<span class="s3">});</span>
	<span class="s3">}</span>

	<span class="s1">setDirectory</span><span class="s3">(</span><span class="s1">directoryPath</span><span class="s3">, </span><span class="s1">birthtime</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">, </span><span class="s1">type</span><span class="s3">) {</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">ignored</span><span class="s3">(</span><span class="s1">directoryPath</span><span class="s3">)) </span><span class="s4">return</span><span class="s3">;</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s1">directoryPath </span><span class="s3">=== </span><span class="s4">this</span><span class="s3">.</span><span class="s1">path</span><span class="s3">) {</span>
			<span class="s4">if </span><span class="s3">(!</span><span class="s1">initial</span><span class="s3">) {</span>
				<span class="s4">this</span><span class="s3">.</span><span class="s1">forEachWatcher</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">path</span><span class="s3">, </span><span class="s1">w </span><span class="s3">=&gt;</span>
					<span class="s1">w</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s2">&quot;change&quot;</span><span class="s3">, </span><span class="s1">directoryPath</span><span class="s3">, </span><span class="s1">birthtime</span><span class="s3">, </span><span class="s1">type</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">)</span>
				<span class="s3">);</span>
			<span class="s3">}</span>
		<span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
			<span class="s4">const </span><span class="s1">old </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">directories</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">directoryPath</span><span class="s3">);</span>
			<span class="s4">if </span><span class="s3">(!</span><span class="s1">old</span><span class="s3">) {</span>
				<span class="s4">const </span><span class="s1">now </span><span class="s3">= </span><span class="s1">Date</span><span class="s3">.</span><span class="s1">now</span><span class="s3">();</span>

				<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">nestedWatching</span><span class="s3">) {</span>
					<span class="s4">this</span><span class="s3">.</span><span class="s1">createNestedWatcher</span><span class="s3">(</span><span class="s1">directoryPath</span><span class="s3">);</span>
				<span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
					<span class="s4">this</span><span class="s3">.</span><span class="s1">directories</span><span class="s3">.</span><span class="s1">set</span><span class="s3">(</span><span class="s1">directoryPath</span><span class="s3">, </span><span class="s4">true</span><span class="s3">);</span>
				<span class="s3">}</span>

				<span class="s4">let </span><span class="s1">safeTime</span><span class="s3">;</span>
				<span class="s4">if </span><span class="s3">(</span><span class="s1">initial</span><span class="s3">) {</span>
					<span class="s1">safeTime </span><span class="s3">= </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(</span><span class="s1">now</span><span class="s3">, </span><span class="s1">birthtime</span><span class="s3">) + </span><span class="s1">FS_ACCURACY</span><span class="s3">;</span>
				<span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
					<span class="s1">safeTime </span><span class="s3">= </span><span class="s1">now</span><span class="s3">;</span>
				<span class="s3">}</span>

				<span class="s4">this</span><span class="s3">.</span><span class="s1">forEachWatcher</span><span class="s3">(</span><span class="s1">directoryPath</span><span class="s3">, </span><span class="s1">w </span><span class="s3">=&gt; {</span>
					<span class="s4">if </span><span class="s3">(!</span><span class="s1">initial </span><span class="s3">|| </span><span class="s1">w</span><span class="s3">.</span><span class="s1">checkStartTime</span><span class="s3">(</span><span class="s1">safeTime</span><span class="s3">, </span><span class="s4">false</span><span class="s3">)) {</span>
						<span class="s1">w</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s2">&quot;change&quot;</span><span class="s3">, </span><span class="s1">birthtime</span><span class="s3">, </span><span class="s1">type</span><span class="s3">);</span>
					<span class="s3">}</span>
				<span class="s3">});</span>
				<span class="s4">this</span><span class="s3">.</span><span class="s1">forEachWatcher</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">path</span><span class="s3">, </span><span class="s1">w </span><span class="s3">=&gt; {</span>
					<span class="s4">if </span><span class="s3">(!</span><span class="s1">initial </span><span class="s3">|| </span><span class="s1">w</span><span class="s3">.</span><span class="s1">checkStartTime</span><span class="s3">(</span><span class="s1">safeTime</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">)) {</span>
						<span class="s1">w</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s2">&quot;change&quot;</span><span class="s3">, </span><span class="s1">directoryPath</span><span class="s3">, </span><span class="s1">safeTime</span><span class="s3">, </span><span class="s1">type</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">);</span>
					<span class="s3">}</span>
				<span class="s3">});</span>
			<span class="s3">}</span>
		<span class="s3">}</span>
	<span class="s3">}</span>

	<span class="s1">createNestedWatcher</span><span class="s3">(</span><span class="s1">directoryPath</span><span class="s3">) {</span>
		<span class="s4">const </span><span class="s1">watcher </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">watcherManager</span><span class="s3">.</span><span class="s1">watchDirectory</span><span class="s3">(</span><span class="s1">directoryPath</span><span class="s3">, </span><span class="s5">1</span><span class="s3">);</span>
		<span class="s1">watcher</span><span class="s3">.</span><span class="s1">on</span><span class="s3">(</span><span class="s2">&quot;change&quot;</span><span class="s3">, (</span><span class="s1">filePath</span><span class="s3">, </span><span class="s1">mtime</span><span class="s3">, </span><span class="s1">type</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">) =&gt; {</span>
			<span class="s4">this</span><span class="s3">.</span><span class="s1">forEachWatcher</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">path</span><span class="s3">, </span><span class="s1">w </span><span class="s3">=&gt; {</span>
				<span class="s4">if </span><span class="s3">(!</span><span class="s1">initial </span><span class="s3">|| </span><span class="s1">w</span><span class="s3">.</span><span class="s1">checkStartTime</span><span class="s3">(</span><span class="s1">mtime</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">)) {</span>
					<span class="s1">w</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s2">&quot;change&quot;</span><span class="s3">, </span><span class="s1">filePath</span><span class="s3">, </span><span class="s1">mtime</span><span class="s3">, </span><span class="s1">type</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">);</span>
				<span class="s3">}</span>
			<span class="s3">});</span>
		<span class="s3">});</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">directories</span><span class="s3">.</span><span class="s1">set</span><span class="s3">(</span><span class="s1">directoryPath</span><span class="s3">, </span><span class="s1">watcher</span><span class="s3">);</span>
	<span class="s3">}</span>

	<span class="s1">setNestedWatching</span><span class="s3">(</span><span class="s1">flag</span><span class="s3">) {</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">nestedWatching </span><span class="s3">!== !!</span><span class="s1">flag</span><span class="s3">) {</span>
			<span class="s4">this</span><span class="s3">.</span><span class="s1">nestedWatching </span><span class="s3">= !!</span><span class="s1">flag</span><span class="s3">;</span>
			<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">nestedWatching</span><span class="s3">) {</span>
				<span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s1">directory of </span><span class="s4">this</span><span class="s3">.</span><span class="s1">directories</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">()) {</span>
					<span class="s4">this</span><span class="s3">.</span><span class="s1">createNestedWatcher</span><span class="s3">(</span><span class="s1">directory</span><span class="s3">);</span>
				<span class="s3">}</span>
			<span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
				<span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s3">[</span><span class="s1">directory</span><span class="s3">, </span><span class="s1">watcher</span><span class="s3">] </span><span class="s1">of </span><span class="s4">this</span><span class="s3">.</span><span class="s1">directories</span><span class="s3">) {</span>
					<span class="s1">watcher</span><span class="s3">.</span><span class="s1">close</span><span class="s3">();</span>
					<span class="s4">this</span><span class="s3">.</span><span class="s1">directories</span><span class="s3">.</span><span class="s1">set</span><span class="s3">(</span><span class="s1">directory</span><span class="s3">, </span><span class="s4">true</span><span class="s3">);</span>
				<span class="s3">}</span>
			<span class="s3">}</span>
		<span class="s3">}</span>
	<span class="s3">}</span>

	<span class="s1">watch</span><span class="s3">(</span><span class="s1">filePath</span><span class="s3">, </span><span class="s1">startTime</span><span class="s3">) {</span>
		<span class="s4">const </span><span class="s1">key </span><span class="s3">= </span><span class="s1">withoutCase</span><span class="s3">(</span><span class="s1">filePath</span><span class="s3">);</span>
		<span class="s4">let </span><span class="s1">watchers </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">watchers</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">key</span><span class="s3">);</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s1">watchers </span><span class="s3">=== </span><span class="s1">undefined</span><span class="s3">) {</span>
			<span class="s1">watchers </span><span class="s3">= </span><span class="s4">new </span><span class="s1">Set</span><span class="s3">();</span>
			<span class="s4">this</span><span class="s3">.</span><span class="s1">watchers</span><span class="s3">.</span><span class="s1">set</span><span class="s3">(</span><span class="s1">key</span><span class="s3">, </span><span class="s1">watchers</span><span class="s3">);</span>
		<span class="s3">}</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">refs</span><span class="s3">++;</span>
		<span class="s4">const </span><span class="s1">watcher </span><span class="s3">= </span><span class="s4">new </span><span class="s1">Watcher</span><span class="s3">(</span><span class="s4">this</span><span class="s3">, </span><span class="s1">filePath</span><span class="s3">, </span><span class="s1">startTime</span><span class="s3">);</span>
		<span class="s1">watcher</span><span class="s3">.</span><span class="s1">on</span><span class="s3">(</span><span class="s2">&quot;closed&quot;</span><span class="s3">, () =&gt; {</span>
			<span class="s4">if </span><span class="s3">(--</span><span class="s4">this</span><span class="s3">.</span><span class="s1">refs </span><span class="s3">&lt;= </span><span class="s5">0</span><span class="s3">) {</span>
				<span class="s4">this</span><span class="s3">.</span><span class="s1">close</span><span class="s3">();</span>
				<span class="s4">return</span><span class="s3">;</span>
			<span class="s3">}</span>
			<span class="s1">watchers</span><span class="s3">.</span><span class="s1">delete</span><span class="s3">(</span><span class="s1">watcher</span><span class="s3">);</span>
			<span class="s4">if </span><span class="s3">(</span><span class="s1">watchers</span><span class="s3">.</span><span class="s1">size </span><span class="s3">=== </span><span class="s5">0</span><span class="s3">) {</span>
				<span class="s4">this</span><span class="s3">.</span><span class="s1">watchers</span><span class="s3">.</span><span class="s1">delete</span><span class="s3">(</span><span class="s1">key</span><span class="s3">);</span>
				<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">path </span><span class="s3">=== </span><span class="s1">filePath</span><span class="s3">) </span><span class="s4">this</span><span class="s3">.</span><span class="s1">setNestedWatching</span><span class="s3">(</span><span class="s4">false</span><span class="s3">);</span>
			<span class="s3">}</span>
		<span class="s3">});</span>
		<span class="s1">watchers</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">watcher</span><span class="s3">);</span>
		<span class="s4">let </span><span class="s1">safeTime</span><span class="s3">;</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s1">filePath </span><span class="s3">=== </span><span class="s4">this</span><span class="s3">.</span><span class="s1">path</span><span class="s3">) {</span>
			<span class="s4">this</span><span class="s3">.</span><span class="s1">setNestedWatching</span><span class="s3">(</span><span class="s4">true</span><span class="s3">);</span>
			<span class="s1">safeTime </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">lastWatchEvent</span><span class="s3">;</span>
			<span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s1">entry of </span><span class="s4">this</span><span class="s3">.</span><span class="s1">files</span><span class="s3">.</span><span class="s1">values</span><span class="s3">()) {</span>
				<span class="s1">fixupEntryAccuracy</span><span class="s3">(</span><span class="s1">entry</span><span class="s3">);</span>
				<span class="s1">safeTime </span><span class="s3">= </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">safeTime</span><span class="s3">, </span><span class="s1">entry</span><span class="s3">.</span><span class="s1">safeTime</span><span class="s3">);</span>
			<span class="s3">}</span>
		<span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
			<span class="s4">const </span><span class="s1">entry </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">files</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">filePath</span><span class="s3">);</span>
			<span class="s4">if </span><span class="s3">(</span><span class="s1">entry</span><span class="s3">) {</span>
				<span class="s1">fixupEntryAccuracy</span><span class="s3">(</span><span class="s1">entry</span><span class="s3">);</span>
				<span class="s1">safeTime </span><span class="s3">= </span><span class="s1">entry</span><span class="s3">.</span><span class="s1">safeTime</span><span class="s3">;</span>
			<span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
				<span class="s1">safeTime </span><span class="s3">= </span><span class="s5">0</span><span class="s3">;</span>
			<span class="s3">}</span>
		<span class="s3">}</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s1">safeTime</span><span class="s3">) {</span>
			<span class="s4">if </span><span class="s3">(</span><span class="s1">safeTime </span><span class="s3">&gt;= </span><span class="s1">startTime</span><span class="s3">) {</span>
				<span class="s1">process</span><span class="s3">.</span><span class="s1">nextTick</span><span class="s3">(() =&gt; {</span>
					<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">closed</span><span class="s3">) </span><span class="s4">return</span><span class="s3">;</span>
					<span class="s4">if </span><span class="s3">(</span><span class="s1">filePath </span><span class="s3">=== </span><span class="s4">this</span><span class="s3">.</span><span class="s1">path</span><span class="s3">) {</span>
						<span class="s1">watcher</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span>
							<span class="s2">&quot;change&quot;</span><span class="s3">,</span>
							<span class="s1">filePath</span><span class="s3">,</span>
							<span class="s1">safeTime</span><span class="s3">,</span>
							<span class="s2">&quot;watch (outdated on attach)&quot;</span><span class="s3">,</span>
							<span class="s4">true</span>
						<span class="s3">);</span>
					<span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
						<span class="s1">watcher</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span>
							<span class="s2">&quot;change&quot;</span><span class="s3">,</span>
							<span class="s1">safeTime</span><span class="s3">,</span>
							<span class="s2">&quot;watch (outdated on attach)&quot;</span><span class="s3">,</span>
							<span class="s4">true</span>
						<span class="s3">);</span>
					<span class="s3">}</span>
				<span class="s3">});</span>
			<span class="s3">}</span>
		<span class="s3">} </span><span class="s4">else if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">initialScan</span><span class="s3">) {</span>
			<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">initialScanRemoved</span><span class="s3">.</span><span class="s1">has</span><span class="s3">(</span><span class="s1">filePath</span><span class="s3">)) {</span>
				<span class="s1">process</span><span class="s3">.</span><span class="s1">nextTick</span><span class="s3">(() =&gt; {</span>
					<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">closed</span><span class="s3">) </span><span class="s4">return</span><span class="s3">;</span>
					<span class="s1">watcher</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s2">&quot;remove&quot;</span><span class="s3">);</span>
				<span class="s3">});</span>
			<span class="s3">}</span>
		<span class="s3">} </span><span class="s4">else if </span><span class="s3">(</span>
			<span class="s3">!</span><span class="s4">this</span><span class="s3">.</span><span class="s1">directories</span><span class="s3">.</span><span class="s1">has</span><span class="s3">(</span><span class="s1">filePath</span><span class="s3">) &amp;&amp;</span>
			<span class="s1">watcher</span><span class="s3">.</span><span class="s1">checkStartTime</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">initialScanFinished</span><span class="s3">, </span><span class="s4">false</span><span class="s3">)</span>
		<span class="s3">) {</span>
			<span class="s1">process</span><span class="s3">.</span><span class="s1">nextTick</span><span class="s3">(() =&gt; {</span>
				<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">closed</span><span class="s3">) </span><span class="s4">return</span><span class="s3">;</span>
				<span class="s1">watcher</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s2">&quot;initial-missing&quot;</span><span class="s3">, </span><span class="s2">&quot;watch (missing on attach)&quot;</span><span class="s3">);</span>
			<span class="s3">});</span>
		<span class="s3">}</span>
		<span class="s4">return </span><span class="s1">watcher</span><span class="s3">;</span>
	<span class="s3">}</span>

	<span class="s1">onWatchEvent</span><span class="s3">(</span><span class="s1">eventType</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">) {</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">closed</span><span class="s3">) </span><span class="s4">return</span><span class="s3">;</span>
		<span class="s4">if </span><span class="s3">(!</span><span class="s1">filename</span><span class="s3">) {</span>
			<span class="s0">// In some cases no filename is provided</span>
			<span class="s0">// This seem to happen on windows</span>
			<span class="s0">// So some event happened but we don't know which file is affected</span>
			<span class="s0">// We have to do a full scan of the directory</span>
			<span class="s4">this</span><span class="s3">.</span><span class="s1">doScan</span><span class="s3">(</span><span class="s4">false</span><span class="s3">);</span>
			<span class="s4">return</span><span class="s3">;</span>
		<span class="s3">}</span>

		<span class="s4">const </span><span class="s1">filePath </span><span class="s3">= </span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">path</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">);</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">ignored</span><span class="s3">(</span><span class="s1">filePath</span><span class="s3">)) </span><span class="s4">return</span><span class="s3">;</span>

		<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">_activeEvents</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">) === </span><span class="s1">undefined</span><span class="s3">) {</span>
			<span class="s4">this</span><span class="s3">.</span><span class="s1">_activeEvents</span><span class="s3">.</span><span class="s1">set</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">, </span><span class="s4">false</span><span class="s3">);</span>
			<span class="s4">const </span><span class="s1">checkStats </span><span class="s3">= () =&gt; {</span>
				<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">closed</span><span class="s3">) </span><span class="s4">return</span><span class="s3">;</span>
				<span class="s4">this</span><span class="s3">.</span><span class="s1">_activeEvents</span><span class="s3">.</span><span class="s1">set</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">, </span><span class="s4">false</span><span class="s3">);</span>
				<span class="s1">fs</span><span class="s3">.</span><span class="s1">lstat</span><span class="s3">(</span><span class="s1">filePath</span><span class="s3">, (</span><span class="s1">err</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">) =&gt; {</span>
					<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">closed</span><span class="s3">) </span><span class="s4">return</span><span class="s3">;</span>
					<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">_activeEvents</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">) === </span><span class="s4">true</span><span class="s3">) {</span>
						<span class="s1">process</span><span class="s3">.</span><span class="s1">nextTick</span><span class="s3">(</span><span class="s1">checkStats</span><span class="s3">);</span>
						<span class="s4">return</span><span class="s3">;</span>
					<span class="s3">}</span>
					<span class="s4">this</span><span class="s3">.</span><span class="s1">_activeEvents</span><span class="s3">.</span><span class="s1">delete</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">);</span>
					<span class="s0">// ENOENT happens when the file/directory doesn't exist</span>
					<span class="s0">// EPERM happens when the containing directory doesn't exist</span>
					<span class="s4">if </span><span class="s3">(</span><span class="s1">err</span><span class="s3">) {</span>
						<span class="s4">if </span><span class="s3">(</span>
							<span class="s1">err</span><span class="s3">.</span><span class="s1">code </span><span class="s3">!== </span><span class="s2">&quot;ENOENT&quot; </span><span class="s3">&amp;&amp;</span>
							<span class="s1">err</span><span class="s3">.</span><span class="s1">code </span><span class="s3">!== </span><span class="s2">&quot;EPERM&quot; </span><span class="s3">&amp;&amp;</span>
							<span class="s1">err</span><span class="s3">.</span><span class="s1">code </span><span class="s3">!== </span><span class="s2">&quot;EBUSY&quot;</span>
						<span class="s3">) {</span>
							<span class="s4">this</span><span class="s3">.</span><span class="s1">onStatsError</span><span class="s3">(</span><span class="s1">err</span><span class="s3">);</span>
						<span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
							<span class="s4">if </span><span class="s3">(</span><span class="s1">filename </span><span class="s3">=== </span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">path</span><span class="s3">)) {</span>
								<span class="s0">// This may indicate that the directory itself was removed</span>
								<span class="s4">if </span><span class="s3">(!</span><span class="s1">fs</span><span class="s3">.</span><span class="s1">existsSync</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">path</span><span class="s3">)) {</span>
									<span class="s4">this</span><span class="s3">.</span><span class="s1">onDirectoryRemoved</span><span class="s3">(</span><span class="s2">&quot;stat failed&quot;</span><span class="s3">);</span>
								<span class="s3">}</span>
							<span class="s3">}</span>
						<span class="s3">}</span>
					<span class="s3">}</span>
					<span class="s4">this</span><span class="s3">.</span><span class="s1">lastWatchEvent </span><span class="s3">= </span><span class="s1">Date</span><span class="s3">.</span><span class="s1">now</span><span class="s3">();</span>
					<span class="s4">if </span><span class="s3">(!</span><span class="s1">stats</span><span class="s3">) {</span>
						<span class="s4">this</span><span class="s3">.</span><span class="s1">setMissing</span><span class="s3">(</span><span class="s1">filePath</span><span class="s3">, </span><span class="s4">false</span><span class="s3">, </span><span class="s1">eventType</span><span class="s3">);</span>
					<span class="s3">} </span><span class="s4">else if </span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">isDirectory</span><span class="s3">()) {</span>
						<span class="s4">this</span><span class="s3">.</span><span class="s1">setDirectory</span><span class="s3">(</span>
							<span class="s1">filePath</span><span class="s3">,</span>
							<span class="s3">+</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">birthtime </span><span class="s3">|| </span><span class="s5">1</span><span class="s3">,</span>
							<span class="s4">false</span><span class="s3">,</span>
							<span class="s1">eventType</span>
						<span class="s3">);</span>
					<span class="s3">} </span><span class="s4">else if </span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">isFile</span><span class="s3">() || </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">isSymbolicLink</span><span class="s3">()) {</span>
						<span class="s4">if </span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">mtime</span><span class="s3">) {</span>
							<span class="s1">ensureFsAccuracy</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">mtime</span><span class="s3">);</span>
						<span class="s3">}</span>
						<span class="s4">this</span><span class="s3">.</span><span class="s1">setFileTime</span><span class="s3">(</span>
							<span class="s1">filePath</span><span class="s3">,</span>
							<span class="s3">+</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">mtime </span><span class="s3">|| +</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ctime </span><span class="s3">|| </span><span class="s5">1</span><span class="s3">,</span>
							<span class="s4">false</span><span class="s3">,</span>
							<span class="s4">false</span><span class="s3">,</span>
							<span class="s1">eventType</span>
						<span class="s3">);</span>
					<span class="s3">}</span>
				<span class="s3">});</span>
			<span class="s3">};</span>
			<span class="s1">process</span><span class="s3">.</span><span class="s1">nextTick</span><span class="s3">(</span><span class="s1">checkStats</span><span class="s3">);</span>
		<span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
			<span class="s4">this</span><span class="s3">.</span><span class="s1">_activeEvents</span><span class="s3">.</span><span class="s1">set</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">, </span><span class="s4">true</span><span class="s3">);</span>
		<span class="s3">}</span>
	<span class="s3">}</span>

	<span class="s1">onWatcherError</span><span class="s3">(</span><span class="s1">err</span><span class="s3">) {</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">closed</span><span class="s3">) </span><span class="s4">return</span><span class="s3">;</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s1">err</span><span class="s3">) {</span>
			<span class="s4">if </span><span class="s3">(</span><span class="s1">err</span><span class="s3">.</span><span class="s1">code </span><span class="s3">!== </span><span class="s2">&quot;EPERM&quot; </span><span class="s3">&amp;&amp; </span><span class="s1">err</span><span class="s3">.</span><span class="s1">code </span><span class="s3">!== </span><span class="s2">&quot;ENOENT&quot;</span><span class="s3">) {</span>
				<span class="s1">console</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s2">&quot;Watchpack Error (watcher): &quot; </span><span class="s3">+ </span><span class="s1">err</span><span class="s3">);</span>
			<span class="s3">}</span>
			<span class="s4">this</span><span class="s3">.</span><span class="s1">onDirectoryRemoved</span><span class="s3">(</span><span class="s2">&quot;watch error&quot;</span><span class="s3">);</span>
		<span class="s3">}</span>
	<span class="s3">}</span>

	<span class="s1">onStatsError</span><span class="s3">(</span><span class="s1">err</span><span class="s3">) {</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s1">err</span><span class="s3">) {</span>
			<span class="s1">console</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s2">&quot;Watchpack Error (stats): &quot; </span><span class="s3">+ </span><span class="s1">err</span><span class="s3">);</span>
		<span class="s3">}</span>
	<span class="s3">}</span>

	<span class="s1">onScanError</span><span class="s3">(</span><span class="s1">err</span><span class="s3">) {</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s1">err</span><span class="s3">) {</span>
			<span class="s1">console</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s2">&quot;Watchpack Error (initial scan): &quot; </span><span class="s3">+ </span><span class="s1">err</span><span class="s3">);</span>
		<span class="s3">}</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">onScanFinished</span><span class="s3">();</span>
	<span class="s3">}</span>

	<span class="s1">onScanFinished</span><span class="s3">() {</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">polledWatching</span><span class="s3">) {</span>
			<span class="s4">this</span><span class="s3">.</span><span class="s1">timeout </span><span class="s3">= </span><span class="s1">setTimeout</span><span class="s3">(() =&gt; {</span>
				<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">closed</span><span class="s3">) </span><span class="s4">return</span><span class="s3">;</span>
				<span class="s4">this</span><span class="s3">.</span><span class="s1">doScan</span><span class="s3">(</span><span class="s4">false</span><span class="s3">);</span>
			<span class="s3">}, </span><span class="s4">this</span><span class="s3">.</span><span class="s1">polledWatching</span><span class="s3">);</span>
		<span class="s3">}</span>
	<span class="s3">}</span>

	<span class="s1">onDirectoryRemoved</span><span class="s3">(</span><span class="s1">reason</span><span class="s3">) {</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">watcher</span><span class="s3">) {</span>
			<span class="s4">this</span><span class="s3">.</span><span class="s1">watcher</span><span class="s3">.</span><span class="s1">close</span><span class="s3">();</span>
			<span class="s4">this</span><span class="s3">.</span><span class="s1">watcher </span><span class="s3">= </span><span class="s4">null</span><span class="s3">;</span>
		<span class="s3">}</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">watchInParentDirectory</span><span class="s3">();</span>
		<span class="s4">const </span><span class="s1">type </span><span class="s3">= </span><span class="s2">`directory-removed (</span><span class="s1">$</span><span class="s3">{</span><span class="s1">reason</span><span class="s3">}</span><span class="s2">)`</span><span class="s3">;</span>
		<span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s1">directory of </span><span class="s4">this</span><span class="s3">.</span><span class="s1">directories</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">()) {</span>
			<span class="s4">this</span><span class="s3">.</span><span class="s1">setMissing</span><span class="s3">(</span><span class="s1">directory</span><span class="s3">, </span><span class="s4">null</span><span class="s3">, </span><span class="s1">type</span><span class="s3">);</span>
		<span class="s3">}</span>
		<span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s1">file of </span><span class="s4">this</span><span class="s3">.</span><span class="s1">files</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">()) {</span>
			<span class="s4">this</span><span class="s3">.</span><span class="s1">setMissing</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s4">null</span><span class="s3">, </span><span class="s1">type</span><span class="s3">);</span>
		<span class="s3">}</span>
	<span class="s3">}</span>

	<span class="s1">watchInParentDirectory</span><span class="s3">() {</span>
		<span class="s4">if </span><span class="s3">(!</span><span class="s4">this</span><span class="s3">.</span><span class="s1">parentWatcher</span><span class="s3">) {</span>
			<span class="s4">const </span><span class="s1">parentDir </span><span class="s3">= </span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">path</span><span class="s3">);</span>
			<span class="s0">// avoid watching in the root directory</span>
			<span class="s0">// removing directories in the root directory is not supported</span>
			<span class="s4">if </span><span class="s3">(</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">parentDir</span><span class="s3">) === </span><span class="s1">parentDir</span><span class="s3">) </span><span class="s4">return</span><span class="s3">;</span>

			<span class="s4">this</span><span class="s3">.</span><span class="s1">parentWatcher </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">watcherManager</span><span class="s3">.</span><span class="s1">watchFile</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">path</span><span class="s3">, </span><span class="s5">1</span><span class="s3">);</span>
			<span class="s4">this</span><span class="s3">.</span><span class="s1">parentWatcher</span><span class="s3">.</span><span class="s1">on</span><span class="s3">(</span><span class="s2">&quot;change&quot;</span><span class="s3">, (</span><span class="s1">mtime</span><span class="s3">, </span><span class="s1">type</span><span class="s3">) =&gt; {</span>
				<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">closed</span><span class="s3">) </span><span class="s4">return</span><span class="s3">;</span>

				<span class="s0">// On non-osx platforms we don't need this watcher to detect</span>
				<span class="s0">// directory removal, as an EPERM error indicates that</span>
				<span class="s4">if </span><span class="s3">((!</span><span class="s1">IS_OSX </span><span class="s3">|| </span><span class="s4">this</span><span class="s3">.</span><span class="s1">polledWatching</span><span class="s3">) &amp;&amp; </span><span class="s4">this</span><span class="s3">.</span><span class="s1">parentWatcher</span><span class="s3">) {</span>
					<span class="s4">this</span><span class="s3">.</span><span class="s1">parentWatcher</span><span class="s3">.</span><span class="s1">close</span><span class="s3">();</span>
					<span class="s4">this</span><span class="s3">.</span><span class="s1">parentWatcher </span><span class="s3">= </span><span class="s4">null</span><span class="s3">;</span>
				<span class="s3">}</span>
				<span class="s0">// Try to create the watcher when parent directory is found</span>
				<span class="s4">if </span><span class="s3">(!</span><span class="s4">this</span><span class="s3">.</span><span class="s1">watcher</span><span class="s3">) {</span>
					<span class="s4">this</span><span class="s3">.</span><span class="s1">createWatcher</span><span class="s3">();</span>
					<span class="s4">this</span><span class="s3">.</span><span class="s1">doScan</span><span class="s3">(</span><span class="s4">false</span><span class="s3">);</span>

					<span class="s0">// directory was created so we emit an event</span>
					<span class="s4">this</span><span class="s3">.</span><span class="s1">forEachWatcher</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">path</span><span class="s3">, </span><span class="s1">w </span><span class="s3">=&gt;</span>
						<span class="s1">w</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s2">&quot;change&quot;</span><span class="s3">, </span><span class="s4">this</span><span class="s3">.</span><span class="s1">path</span><span class="s3">, </span><span class="s1">mtime</span><span class="s3">, </span><span class="s1">type</span><span class="s3">, </span><span class="s4">false</span><span class="s3">)</span>
					<span class="s3">);</span>
				<span class="s3">}</span>
			<span class="s3">});</span>
			<span class="s4">this</span><span class="s3">.</span><span class="s1">parentWatcher</span><span class="s3">.</span><span class="s1">on</span><span class="s3">(</span><span class="s2">&quot;remove&quot;</span><span class="s3">, () =&gt; {</span>
				<span class="s4">this</span><span class="s3">.</span><span class="s1">onDirectoryRemoved</span><span class="s3">(</span><span class="s2">&quot;parent directory removed&quot;</span><span class="s3">);</span>
			<span class="s3">});</span>
		<span class="s3">}</span>
	<span class="s3">}</span>

	<span class="s1">doScan</span><span class="s3">(</span><span class="s1">initial</span><span class="s3">) {</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">scanning</span><span class="s3">) {</span>
			<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">scanAgain</span><span class="s3">) {</span>
				<span class="s4">if </span><span class="s3">(!</span><span class="s1">initial</span><span class="s3">) </span><span class="s4">this</span><span class="s3">.</span><span class="s1">scanAgainInitial </span><span class="s3">= </span><span class="s4">false</span><span class="s3">;</span>
			<span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
				<span class="s4">this</span><span class="s3">.</span><span class="s1">scanAgain </span><span class="s3">= </span><span class="s4">true</span><span class="s3">;</span>
				<span class="s4">this</span><span class="s3">.</span><span class="s1">scanAgainInitial </span><span class="s3">= </span><span class="s1">initial</span><span class="s3">;</span>
			<span class="s3">}</span>
			<span class="s4">return</span><span class="s3">;</span>
		<span class="s3">}</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">scanning </span><span class="s3">= </span><span class="s4">true</span><span class="s3">;</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">timeout</span><span class="s3">) {</span>
			<span class="s1">clearTimeout</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">timeout</span><span class="s3">);</span>
			<span class="s4">this</span><span class="s3">.</span><span class="s1">timeout </span><span class="s3">= </span><span class="s1">undefined</span><span class="s3">;</span>
		<span class="s3">}</span>
		<span class="s1">process</span><span class="s3">.</span><span class="s1">nextTick</span><span class="s3">(() =&gt; {</span>
			<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">closed</span><span class="s3">) </span><span class="s4">return</span><span class="s3">;</span>
			<span class="s1">fs</span><span class="s3">.</span><span class="s1">readdir</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">path</span><span class="s3">, (</span><span class="s1">err</span><span class="s3">, </span><span class="s1">items</span><span class="s3">) =&gt; {</span>
				<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">closed</span><span class="s3">) </span><span class="s4">return</span><span class="s3">;</span>
				<span class="s4">if </span><span class="s3">(</span><span class="s1">err</span><span class="s3">) {</span>
					<span class="s4">if </span><span class="s3">(</span><span class="s1">err</span><span class="s3">.</span><span class="s1">code </span><span class="s3">=== </span><span class="s2">&quot;ENOENT&quot; </span><span class="s3">|| </span><span class="s1">err</span><span class="s3">.</span><span class="s1">code </span><span class="s3">=== </span><span class="s2">&quot;EPERM&quot;</span><span class="s3">) {</span>
						<span class="s4">this</span><span class="s3">.</span><span class="s1">onDirectoryRemoved</span><span class="s3">(</span><span class="s2">&quot;scan readdir failed&quot;</span><span class="s3">);</span>
					<span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
						<span class="s4">this</span><span class="s3">.</span><span class="s1">onScanError</span><span class="s3">(</span><span class="s1">err</span><span class="s3">);</span>
					<span class="s3">}</span>
					<span class="s4">this</span><span class="s3">.</span><span class="s1">initialScan </span><span class="s3">= </span><span class="s4">false</span><span class="s3">;</span>
					<span class="s4">this</span><span class="s3">.</span><span class="s1">initialScanFinished </span><span class="s3">= </span><span class="s1">Date</span><span class="s3">.</span><span class="s1">now</span><span class="s3">();</span>
					<span class="s4">if </span><span class="s3">(</span><span class="s1">initial</span><span class="s3">) {</span>
						<span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s1">watchers of </span><span class="s4">this</span><span class="s3">.</span><span class="s1">watchers</span><span class="s3">.</span><span class="s1">values</span><span class="s3">()) {</span>
							<span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s1">watcher of watchers</span><span class="s3">) {</span>
								<span class="s4">if </span><span class="s3">(</span><span class="s1">watcher</span><span class="s3">.</span><span class="s1">checkStartTime</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">initialScanFinished</span><span class="s3">, </span><span class="s4">false</span><span class="s3">)) {</span>
									<span class="s1">watcher</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span>
										<span class="s2">&quot;initial-missing&quot;</span><span class="s3">,</span>
										<span class="s2">&quot;scan (parent directory missing in initial scan)&quot;</span>
									<span class="s3">);</span>
								<span class="s3">}</span>
							<span class="s3">}</span>
						<span class="s3">}</span>
					<span class="s3">}</span>
					<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">scanAgain</span><span class="s3">) {</span>
						<span class="s4">this</span><span class="s3">.</span><span class="s1">scanAgain </span><span class="s3">= </span><span class="s4">false</span><span class="s3">;</span>
						<span class="s4">this</span><span class="s3">.</span><span class="s1">doScan</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">scanAgainInitial</span><span class="s3">);</span>
					<span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
						<span class="s4">this</span><span class="s3">.</span><span class="s1">scanning </span><span class="s3">= </span><span class="s4">false</span><span class="s3">;</span>
					<span class="s3">}</span>
					<span class="s4">return</span><span class="s3">;</span>
				<span class="s3">}</span>
				<span class="s4">const </span><span class="s1">itemPaths </span><span class="s3">= </span><span class="s4">new </span><span class="s1">Set</span><span class="s3">(</span>
					<span class="s1">items</span><span class="s3">.</span><span class="s1">map</span><span class="s3">(</span><span class="s1">item </span><span class="s3">=&gt; </span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">path</span><span class="s3">, </span><span class="s1">item</span><span class="s3">.</span><span class="s1">normalize</span><span class="s3">(</span><span class="s2">&quot;NFC&quot;</span><span class="s3">)))</span>
				<span class="s3">);</span>
				<span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s1">file of </span><span class="s4">this</span><span class="s3">.</span><span class="s1">files</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">()) {</span>
					<span class="s4">if </span><span class="s3">(!</span><span class="s1">itemPaths</span><span class="s3">.</span><span class="s1">has</span><span class="s3">(</span><span class="s1">file</span><span class="s3">)) {</span>
						<span class="s4">this</span><span class="s3">.</span><span class="s1">setMissing</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">, </span><span class="s2">&quot;scan (missing)&quot;</span><span class="s3">);</span>
					<span class="s3">}</span>
				<span class="s3">}</span>
				<span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s1">directory of </span><span class="s4">this</span><span class="s3">.</span><span class="s1">directories</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">()) {</span>
					<span class="s4">if </span><span class="s3">(!</span><span class="s1">itemPaths</span><span class="s3">.</span><span class="s1">has</span><span class="s3">(</span><span class="s1">directory</span><span class="s3">)) {</span>
						<span class="s4">this</span><span class="s3">.</span><span class="s1">setMissing</span><span class="s3">(</span><span class="s1">directory</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">, </span><span class="s2">&quot;scan (missing)&quot;</span><span class="s3">);</span>
					<span class="s3">}</span>
				<span class="s3">}</span>
				<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">scanAgain</span><span class="s3">) {</span>
					<span class="s0">// Early repeat of scan</span>
					<span class="s4">this</span><span class="s3">.</span><span class="s1">scanAgain </span><span class="s3">= </span><span class="s4">false</span><span class="s3">;</span>
					<span class="s4">this</span><span class="s3">.</span><span class="s1">doScan</span><span class="s3">(</span><span class="s1">initial</span><span class="s3">);</span>
					<span class="s4">return</span><span class="s3">;</span>
				<span class="s3">}</span>
				<span class="s4">const </span><span class="s1">itemFinished </span><span class="s3">= </span><span class="s1">needCalls</span><span class="s3">(</span><span class="s1">itemPaths</span><span class="s3">.</span><span class="s1">size </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">, () =&gt; {</span>
					<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">closed</span><span class="s3">) </span><span class="s4">return</span><span class="s3">;</span>
					<span class="s4">this</span><span class="s3">.</span><span class="s1">initialScan </span><span class="s3">= </span><span class="s4">false</span><span class="s3">;</span>
					<span class="s4">this</span><span class="s3">.</span><span class="s1">initialScanRemoved </span><span class="s3">= </span><span class="s4">null</span><span class="s3">;</span>
					<span class="s4">this</span><span class="s3">.</span><span class="s1">initialScanFinished </span><span class="s3">= </span><span class="s1">Date</span><span class="s3">.</span><span class="s1">now</span><span class="s3">();</span>
					<span class="s4">if </span><span class="s3">(</span><span class="s1">initial</span><span class="s3">) {</span>
						<span class="s4">const </span><span class="s1">missingWatchers </span><span class="s3">= </span><span class="s4">new </span><span class="s1">Map</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">watchers</span><span class="s3">);</span>
						<span class="s1">missingWatchers</span><span class="s3">.</span><span class="s1">delete</span><span class="s3">(</span><span class="s1">withoutCase</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">path</span><span class="s3">));</span>
						<span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s1">item of itemPaths</span><span class="s3">) {</span>
							<span class="s1">missingWatchers</span><span class="s3">.</span><span class="s1">delete</span><span class="s3">(</span><span class="s1">withoutCase</span><span class="s3">(</span><span class="s1">item</span><span class="s3">));</span>
						<span class="s3">}</span>
						<span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s1">watchers of missingWatchers</span><span class="s3">.</span><span class="s1">values</span><span class="s3">()) {</span>
							<span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s1">watcher of watchers</span><span class="s3">) {</span>
								<span class="s4">if </span><span class="s3">(</span><span class="s1">watcher</span><span class="s3">.</span><span class="s1">checkStartTime</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">initialScanFinished</span><span class="s3">, </span><span class="s4">false</span><span class="s3">)) {</span>
									<span class="s1">watcher</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span>
										<span class="s2">&quot;initial-missing&quot;</span><span class="s3">,</span>
										<span class="s2">&quot;scan (missing in initial scan)&quot;</span>
									<span class="s3">);</span>
								<span class="s3">}</span>
							<span class="s3">}</span>
						<span class="s3">}</span>
					<span class="s3">}</span>
					<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">scanAgain</span><span class="s3">) {</span>
						<span class="s4">this</span><span class="s3">.</span><span class="s1">scanAgain </span><span class="s3">= </span><span class="s4">false</span><span class="s3">;</span>
						<span class="s4">this</span><span class="s3">.</span><span class="s1">doScan</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">scanAgainInitial</span><span class="s3">);</span>
					<span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
						<span class="s4">this</span><span class="s3">.</span><span class="s1">scanning </span><span class="s3">= </span><span class="s4">false</span><span class="s3">;</span>
						<span class="s4">this</span><span class="s3">.</span><span class="s1">onScanFinished</span><span class="s3">();</span>
					<span class="s3">}</span>
				<span class="s3">});</span>
				<span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s1">itemPath of itemPaths</span><span class="s3">) {</span>
					<span class="s1">fs</span><span class="s3">.</span><span class="s1">lstat</span><span class="s3">(</span><span class="s1">itemPath</span><span class="s3">, (</span><span class="s1">err2</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">) =&gt; {</span>
						<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">closed</span><span class="s3">) </span><span class="s4">return</span><span class="s3">;</span>
						<span class="s4">if </span><span class="s3">(</span><span class="s1">err2</span><span class="s3">) {</span>
							<span class="s4">if </span><span class="s3">(</span>
								<span class="s1">err2</span><span class="s3">.</span><span class="s1">code </span><span class="s3">=== </span><span class="s2">&quot;ENOENT&quot; </span><span class="s3">||</span>
								<span class="s1">err2</span><span class="s3">.</span><span class="s1">code </span><span class="s3">=== </span><span class="s2">&quot;EPERM&quot; </span><span class="s3">||</span>
								<span class="s1">err2</span><span class="s3">.</span><span class="s1">code </span><span class="s3">=== </span><span class="s2">&quot;EACCES&quot; </span><span class="s3">||</span>
								<span class="s1">err2</span><span class="s3">.</span><span class="s1">code </span><span class="s3">=== </span><span class="s2">&quot;EBUSY&quot;</span>
							<span class="s3">) {</span>
								<span class="s4">this</span><span class="s3">.</span><span class="s1">setMissing</span><span class="s3">(</span><span class="s1">itemPath</span><span class="s3">, </span><span class="s1">initial</span><span class="s3">, </span><span class="s2">&quot;scan (&quot; </span><span class="s3">+ </span><span class="s1">err2</span><span class="s3">.</span><span class="s1">code </span><span class="s3">+ </span><span class="s2">&quot;)&quot;</span><span class="s3">);</span>
							<span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
								<span class="s4">this</span><span class="s3">.</span><span class="s1">onScanError</span><span class="s3">(</span><span class="s1">err2</span><span class="s3">);</span>
							<span class="s3">}</span>
							<span class="s1">itemFinished</span><span class="s3">();</span>
							<span class="s4">return</span><span class="s3">;</span>
						<span class="s3">}</span>
						<span class="s4">if </span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">isFile</span><span class="s3">() || </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">isSymbolicLink</span><span class="s3">()) {</span>
							<span class="s4">if </span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">mtime</span><span class="s3">) {</span>
								<span class="s1">ensureFsAccuracy</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">mtime</span><span class="s3">);</span>
							<span class="s3">}</span>
							<span class="s4">this</span><span class="s3">.</span><span class="s1">setFileTime</span><span class="s3">(</span>
								<span class="s1">itemPath</span><span class="s3">,</span>
								<span class="s3">+</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">mtime </span><span class="s3">|| +</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ctime </span><span class="s3">|| </span><span class="s5">1</span><span class="s3">,</span>
								<span class="s1">initial</span><span class="s3">,</span>
								<span class="s4">true</span><span class="s3">,</span>
								<span class="s2">&quot;scan (file)&quot;</span>
							<span class="s3">);</span>
						<span class="s3">} </span><span class="s4">else if </span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">isDirectory</span><span class="s3">()) {</span>
							<span class="s4">if </span><span class="s3">(!</span><span class="s1">initial </span><span class="s3">|| !</span><span class="s4">this</span><span class="s3">.</span><span class="s1">directories</span><span class="s3">.</span><span class="s1">has</span><span class="s3">(</span><span class="s1">itemPath</span><span class="s3">))</span>
								<span class="s4">this</span><span class="s3">.</span><span class="s1">setDirectory</span><span class="s3">(</span>
									<span class="s1">itemPath</span><span class="s3">,</span>
									<span class="s3">+</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">birthtime </span><span class="s3">|| </span><span class="s5">1</span><span class="s3">,</span>
									<span class="s1">initial</span><span class="s3">,</span>
									<span class="s2">&quot;scan (dir)&quot;</span>
								<span class="s3">);</span>
						<span class="s3">}</span>
						<span class="s1">itemFinished</span><span class="s3">();</span>
					<span class="s3">});</span>
				<span class="s3">}</span>
				<span class="s1">itemFinished</span><span class="s3">();</span>
			<span class="s3">});</span>
		<span class="s3">});</span>
	<span class="s3">}</span>

	<span class="s1">getTimes</span><span class="s3">() {</span>
		<span class="s4">const </span><span class="s1">obj </span><span class="s3">= </span><span class="s1">Object</span><span class="s3">.</span><span class="s1">create</span><span class="s3">(</span><span class="s4">null</span><span class="s3">);</span>
		<span class="s4">let </span><span class="s1">safeTime </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">lastWatchEvent</span><span class="s3">;</span>
		<span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s3">[</span><span class="s1">file</span><span class="s3">, </span><span class="s1">entry</span><span class="s3">] </span><span class="s1">of </span><span class="s4">this</span><span class="s3">.</span><span class="s1">files</span><span class="s3">) {</span>
			<span class="s1">fixupEntryAccuracy</span><span class="s3">(</span><span class="s1">entry</span><span class="s3">);</span>
			<span class="s1">safeTime </span><span class="s3">= </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">safeTime</span><span class="s3">, </span><span class="s1">entry</span><span class="s3">.</span><span class="s1">safeTime</span><span class="s3">);</span>
			<span class="s1">obj</span><span class="s3">[</span><span class="s1">file</span><span class="s3">] = </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">entry</span><span class="s3">.</span><span class="s1">safeTime</span><span class="s3">, </span><span class="s1">entry</span><span class="s3">.</span><span class="s1">timestamp</span><span class="s3">);</span>
		<span class="s3">}</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">nestedWatching</span><span class="s3">) {</span>
			<span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s1">w of </span><span class="s4">this</span><span class="s3">.</span><span class="s1">directories</span><span class="s3">.</span><span class="s1">values</span><span class="s3">()) {</span>
				<span class="s4">const </span><span class="s1">times </span><span class="s3">= </span><span class="s1">w</span><span class="s3">.</span><span class="s1">directoryWatcher</span><span class="s3">.</span><span class="s1">getTimes</span><span class="s3">();</span>
				<span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s1">file of Object</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">(</span><span class="s1">times</span><span class="s3">)) {</span>
					<span class="s4">const </span><span class="s1">time </span><span class="s3">= </span><span class="s1">times</span><span class="s3">[</span><span class="s1">file</span><span class="s3">];</span>
					<span class="s1">safeTime </span><span class="s3">= </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">safeTime</span><span class="s3">, </span><span class="s1">time</span><span class="s3">);</span>
					<span class="s1">obj</span><span class="s3">[</span><span class="s1">file</span><span class="s3">] = </span><span class="s1">time</span><span class="s3">;</span>
				<span class="s3">}</span>
			<span class="s3">}</span>
			<span class="s1">obj</span><span class="s3">[</span><span class="s4">this</span><span class="s3">.</span><span class="s1">path</span><span class="s3">] = </span><span class="s1">safeTime</span><span class="s3">;</span>
		<span class="s3">}</span>
		<span class="s4">if </span><span class="s3">(!</span><span class="s4">this</span><span class="s3">.</span><span class="s1">initialScan</span><span class="s3">) {</span>
			<span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s1">watchers of </span><span class="s4">this</span><span class="s3">.</span><span class="s1">watchers</span><span class="s3">.</span><span class="s1">values</span><span class="s3">()) {</span>
				<span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s1">watcher of watchers</span><span class="s3">) {</span>
					<span class="s4">const </span><span class="s1">path </span><span class="s3">= </span><span class="s1">watcher</span><span class="s3">.</span><span class="s1">path</span><span class="s3">;</span>
					<span class="s4">if </span><span class="s3">(!</span><span class="s1">Object</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">.</span><span class="s1">hasOwnProperty</span><span class="s3">.</span><span class="s1">call</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">path</span><span class="s3">)) {</span>
						<span class="s1">obj</span><span class="s3">[</span><span class="s1">path</span><span class="s3">] = </span><span class="s4">null</span><span class="s3">;</span>
					<span class="s3">}</span>
				<span class="s3">}</span>
			<span class="s3">}</span>
		<span class="s3">}</span>
		<span class="s4">return </span><span class="s1">obj</span><span class="s3">;</span>
	<span class="s3">}</span>

	<span class="s1">collectTimeInfoEntries</span><span class="s3">(</span><span class="s1">fileTimestamps</span><span class="s3">, </span><span class="s1">directoryTimestamps</span><span class="s3">) {</span>
		<span class="s4">let </span><span class="s1">safeTime </span><span class="s3">= </span><span class="s4">this</span><span class="s3">.</span><span class="s1">lastWatchEvent</span><span class="s3">;</span>
		<span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s3">[</span><span class="s1">file</span><span class="s3">, </span><span class="s1">entry</span><span class="s3">] </span><span class="s1">of </span><span class="s4">this</span><span class="s3">.</span><span class="s1">files</span><span class="s3">) {</span>
			<span class="s1">fixupEntryAccuracy</span><span class="s3">(</span><span class="s1">entry</span><span class="s3">);</span>
			<span class="s1">safeTime </span><span class="s3">= </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">safeTime</span><span class="s3">, </span><span class="s1">entry</span><span class="s3">.</span><span class="s1">safeTime</span><span class="s3">);</span>
			<span class="s1">fileTimestamps</span><span class="s3">.</span><span class="s1">set</span><span class="s3">(</span><span class="s1">file</span><span class="s3">, </span><span class="s1">entry</span><span class="s3">);</span>
		<span class="s3">}</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">nestedWatching</span><span class="s3">) {</span>
			<span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s1">w of </span><span class="s4">this</span><span class="s3">.</span><span class="s1">directories</span><span class="s3">.</span><span class="s1">values</span><span class="s3">()) {</span>
				<span class="s1">safeTime </span><span class="s3">= </span><span class="s1">Math</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span>
					<span class="s1">safeTime</span><span class="s3">,</span>
					<span class="s1">w</span><span class="s3">.</span><span class="s1">directoryWatcher</span><span class="s3">.</span><span class="s1">collectTimeInfoEntries</span><span class="s3">(</span>
						<span class="s1">fileTimestamps</span><span class="s3">,</span>
						<span class="s1">directoryTimestamps</span>
					<span class="s3">)</span>
				<span class="s3">);</span>
			<span class="s3">}</span>
			<span class="s1">fileTimestamps</span><span class="s3">.</span><span class="s1">set</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">path</span><span class="s3">, </span><span class="s1">EXISTANCE_ONLY_TIME_ENTRY</span><span class="s3">);</span>
			<span class="s1">directoryTimestamps</span><span class="s3">.</span><span class="s1">set</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">path</span><span class="s3">, {</span>
				<span class="s1">safeTime</span>
			<span class="s3">});</span>
		<span class="s3">} </span><span class="s4">else </span><span class="s3">{</span>
			<span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s1">dir of </span><span class="s4">this</span><span class="s3">.</span><span class="s1">directories</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">()) {</span>
				<span class="s0">// No additional info about this directory</span>
				<span class="s0">// but maybe another DirectoryWatcher has info</span>
				<span class="s1">fileTimestamps</span><span class="s3">.</span><span class="s1">set</span><span class="s3">(</span><span class="s1">dir</span><span class="s3">, </span><span class="s1">EXISTANCE_ONLY_TIME_ENTRY</span><span class="s3">);</span>
				<span class="s4">if </span><span class="s3">(!</span><span class="s1">directoryTimestamps</span><span class="s3">.</span><span class="s1">has</span><span class="s3">(</span><span class="s1">dir</span><span class="s3">))</span>
					<span class="s1">directoryTimestamps</span><span class="s3">.</span><span class="s1">set</span><span class="s3">(</span><span class="s1">dir</span><span class="s3">, </span><span class="s1">EXISTANCE_ONLY_TIME_ENTRY</span><span class="s3">);</span>
			<span class="s3">}</span>
			<span class="s1">fileTimestamps</span><span class="s3">.</span><span class="s1">set</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">path</span><span class="s3">, </span><span class="s1">EXISTANCE_ONLY_TIME_ENTRY</span><span class="s3">);</span>
			<span class="s1">directoryTimestamps</span><span class="s3">.</span><span class="s1">set</span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">path</span><span class="s3">, </span><span class="s1">EXISTANCE_ONLY_TIME_ENTRY</span><span class="s3">);</span>
		<span class="s3">}</span>
		<span class="s4">if </span><span class="s3">(!</span><span class="s4">this</span><span class="s3">.</span><span class="s1">initialScan</span><span class="s3">) {</span>
			<span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s1">watchers of </span><span class="s4">this</span><span class="s3">.</span><span class="s1">watchers</span><span class="s3">.</span><span class="s1">values</span><span class="s3">()) {</span>
				<span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s1">watcher of watchers</span><span class="s3">) {</span>
					<span class="s4">const </span><span class="s1">path </span><span class="s3">= </span><span class="s1">watcher</span><span class="s3">.</span><span class="s1">path</span><span class="s3">;</span>
					<span class="s4">if </span><span class="s3">(!</span><span class="s1">fileTimestamps</span><span class="s3">.</span><span class="s1">has</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)) {</span>
						<span class="s1">fileTimestamps</span><span class="s3">.</span><span class="s1">set</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s4">null</span><span class="s3">);</span>
					<span class="s3">}</span>
				<span class="s3">}</span>
			<span class="s3">}</span>
		<span class="s3">}</span>
		<span class="s4">return </span><span class="s1">safeTime</span><span class="s3">;</span>
	<span class="s3">}</span>

	<span class="s1">close</span><span class="s3">() {</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">closed </span><span class="s3">= </span><span class="s4">true</span><span class="s3">;</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">initialScan </span><span class="s3">= </span><span class="s4">false</span><span class="s3">;</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">watcher</span><span class="s3">) {</span>
			<span class="s4">this</span><span class="s3">.</span><span class="s1">watcher</span><span class="s3">.</span><span class="s1">close</span><span class="s3">();</span>
			<span class="s4">this</span><span class="s3">.</span><span class="s1">watcher </span><span class="s3">= </span><span class="s4">null</span><span class="s3">;</span>
		<span class="s3">}</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">nestedWatching</span><span class="s3">) {</span>
			<span class="s4">for </span><span class="s3">(</span><span class="s4">const </span><span class="s1">w of </span><span class="s4">this</span><span class="s3">.</span><span class="s1">directories</span><span class="s3">.</span><span class="s1">values</span><span class="s3">()) {</span>
				<span class="s1">w</span><span class="s3">.</span><span class="s1">close</span><span class="s3">();</span>
			<span class="s3">}</span>
			<span class="s4">this</span><span class="s3">.</span><span class="s1">directories</span><span class="s3">.</span><span class="s1">clear</span><span class="s3">();</span>
		<span class="s3">}</span>
		<span class="s4">if </span><span class="s3">(</span><span class="s4">this</span><span class="s3">.</span><span class="s1">parentWatcher</span><span class="s3">) {</span>
			<span class="s4">this</span><span class="s3">.</span><span class="s1">parentWatcher</span><span class="s3">.</span><span class="s1">close</span><span class="s3">();</span>
			<span class="s4">this</span><span class="s3">.</span><span class="s1">parentWatcher </span><span class="s3">= </span><span class="s4">null</span><span class="s3">;</span>
		<span class="s3">}</span>
		<span class="s4">this</span><span class="s3">.</span><span class="s1">emit</span><span class="s3">(</span><span class="s2">&quot;closed&quot;</span><span class="s3">);</span>
	<span class="s3">}</span>
<span class="s3">}</span>

<span class="s1">module</span><span class="s3">.</span><span class="s1">exports </span><span class="s3">= </span><span class="s1">DirectoryWatcher</span><span class="s3">;</span>
<span class="s1">module</span><span class="s3">.</span><span class="s1">exports</span><span class="s3">.</span><span class="s1">EXISTANCE_ONLY_TIME_ENTRY </span><span class="s3">= </span><span class="s1">EXISTANCE_ONLY_TIME_ENTRY</span><span class="s3">;</span>

<span class="s4">function </span><span class="s1">fixupEntryAccuracy</span><span class="s3">(</span><span class="s1">entry</span><span class="s3">) {</span>
	<span class="s4">if </span><span class="s3">(</span><span class="s1">entry</span><span class="s3">.</span><span class="s1">accuracy </span><span class="s3">&gt; </span><span class="s1">FS_ACCURACY</span><span class="s3">) {</span>
		<span class="s1">entry</span><span class="s3">.</span><span class="s1">safeTime </span><span class="s3">= </span><span class="s1">entry</span><span class="s3">.</span><span class="s1">safeTime </span><span class="s3">- </span><span class="s1">entry</span><span class="s3">.</span><span class="s1">accuracy </span><span class="s3">+ </span><span class="s1">FS_ACCURACY</span><span class="s3">;</span>
		<span class="s1">entry</span><span class="s3">.</span><span class="s1">accuracy </span><span class="s3">= </span><span class="s1">FS_ACCURACY</span><span class="s3">;</span>
	<span class="s3">}</span>
<span class="s3">}</span>

<span class="s4">function </span><span class="s1">ensureFsAccuracy</span><span class="s3">(</span><span class="s1">mtime</span><span class="s3">) {</span>
	<span class="s4">if </span><span class="s3">(!</span><span class="s1">mtime</span><span class="s3">) </span><span class="s4">return</span><span class="s3">;</span>
	<span class="s4">if </span><span class="s3">(</span><span class="s1">FS_ACCURACY </span><span class="s3">&gt; </span><span class="s5">1 </span><span class="s3">&amp;&amp; </span><span class="s1">mtime </span><span class="s3">% </span><span class="s5">1 </span><span class="s3">!== </span><span class="s5">0</span><span class="s3">) </span><span class="s1">FS_ACCURACY </span><span class="s3">= </span><span class="s5">1</span><span class="s3">;</span>
	<span class="s4">else if </span><span class="s3">(</span><span class="s1">FS_ACCURACY </span><span class="s3">&gt; </span><span class="s5">10 </span><span class="s3">&amp;&amp; </span><span class="s1">mtime </span><span class="s3">% </span><span class="s5">10 </span><span class="s3">!== </span><span class="s5">0</span><span class="s3">) </span><span class="s1">FS_ACCURACY </span><span class="s3">= </span><span class="s5">10</span><span class="s3">;</span>
	<span class="s4">else if </span><span class="s3">(</span><span class="s1">FS_ACCURACY </span><span class="s3">&gt; </span><span class="s5">100 </span><span class="s3">&amp;&amp; </span><span class="s1">mtime </span><span class="s3">% </span><span class="s5">100 </span><span class="s3">!== </span><span class="s5">0</span><span class="s3">) </span><span class="s1">FS_ACCURACY </span><span class="s3">= </span><span class="s5">100</span><span class="s3">;</span>
	<span class="s4">else if </span><span class="s3">(</span><span class="s1">FS_ACCURACY </span><span class="s3">&gt; </span><span class="s5">1000 </span><span class="s3">&amp;&amp; </span><span class="s1">mtime </span><span class="s3">% </span><span class="s5">1000 </span><span class="s3">!== </span><span class="s5">0</span><span class="s3">) </span><span class="s1">FS_ACCURACY </span><span class="s3">= </span><span class="s5">1000</span><span class="s3">;</span>
<span class="s3">}</span>
</pre>
</body>
</html>