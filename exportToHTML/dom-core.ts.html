<html>
<head>
<title>dom-core.ts</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #67a37c; font-style: italic;}
.s2 { color: #bcbec4;}
.s3 { color: #cf8e6d;}
.s4 { color: #6aab73;}
.s5 { color: #bcbec4;}
.s6 { color: #7a7e85;}
.s7 { color: #2aacb8;}
.s8 { color: #42c3d4;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
dom-core.ts</font>
</center></td></tr></table>
<pre><span class="s0">/**</span>
 <span class="s0">* </span><span class="s1">@description </span><span class="s0">封装 DOM 操作</span>
 <span class="s0">* </span><span class="s1">@wangfupeng</span>
 <span class="s0">*/</span>

<span class="s3">import </span><span class="s2">Editor from </span><span class="s4">'../editor/index'</span>
<span class="s3">import </span><span class="s5">{ </span><span class="s2">toArray </span><span class="s5">} </span><span class="s2">from </span><span class="s4">'./util'</span>

<span class="s6">// 记录元素基于上一个相对&amp;绝对定位的位置信息</span>
<span class="s2">type OffsetDataType </span><span class="s5">= {</span>
    <span class="s2">top</span><span class="s5">: </span><span class="s2">number</span>
    <span class="s2">left</span><span class="s5">: </span><span class="s2">number</span>
    <span class="s2">width</span><span class="s5">: </span><span class="s2">number</span>
    <span class="s2">height</span><span class="s5">: </span><span class="s2">number</span>
    <span class="s2">parent</span><span class="s5">: </span><span class="s2">Element </span><span class="s5">| </span><span class="s3">null</span>
<span class="s5">}</span>

<span class="s6">// 记录代理事件绑定</span>
<span class="s2">type listener </span><span class="s5">= (</span><span class="s2">e</span><span class="s5">: </span><span class="s2">Event</span><span class="s5">) =&gt; </span><span class="s3">void</span>
<span class="s2">type EventItem </span><span class="s5">= {</span>
    <span class="s2">elem</span><span class="s5">: </span><span class="s2">HTMLElement</span>
    <span class="s2">selector</span><span class="s5">: </span><span class="s2">string</span>
    <span class="s2">fn</span><span class="s5">: </span><span class="s2">listener</span>
    <span class="s2">agentFn</span><span class="s5">: </span><span class="s2">listener</span>
<span class="s5">}</span>
<span class="s3">const </span><span class="s2">AGENT_EVENTS</span><span class="s5">: </span><span class="s2">EventItem</span><span class="s5">[] = []</span>

<span class="s0">/**</span>
 <span class="s0">* 根据 html 字符串创建 elem</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">{String} html html</span>
 <span class="s0">*/</span>
<span class="s3">function </span><span class="s2">_createElemByHTML</span><span class="s5">(</span><span class="s2">html</span><span class="s5">: </span><span class="s2">string</span><span class="s5">): </span><span class="s2">HTMLElement</span><span class="s5">[] {</span>
    <span class="s3">const </span><span class="s2">div </span><span class="s5">= </span><span class="s2">document</span><span class="s5">.</span><span class="s2">createElement</span><span class="s5">(</span><span class="s4">'div'</span><span class="s5">)</span>
    <span class="s2">div</span><span class="s5">.</span><span class="s2">innerHTML </span><span class="s5">= </span><span class="s2">html</span>
    <span class="s3">const </span><span class="s2">elems </span><span class="s5">= </span><span class="s2">div</span><span class="s5">.</span><span class="s2">children</span>
    <span class="s3">return </span><span class="s2">toArray</span><span class="s5">(</span><span class="s2">elems</span><span class="s5">)</span>
<span class="s5">}</span>

<span class="s0">/**</span>
 <span class="s0">* 判断是否是 DOM List</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">selector DOM 元素或列表</span>
 <span class="s0">*/</span>
<span class="s3">function </span><span class="s2">_isDOMList</span><span class="s5">&lt;</span><span class="s2">T </span><span class="s3">extends </span><span class="s2">HTMLCollection </span><span class="s5">| </span><span class="s2">NodeList</span><span class="s5">&gt;(</span><span class="s2">selector</span><span class="s5">: </span><span class="s2">unknown</span><span class="s5">): </span><span class="s2">selector </span><span class="s5">is </span><span class="s2">T </span><span class="s5">{</span>
    <span class="s3">if </span><span class="s5">(!</span><span class="s2">selector</span><span class="s5">) {</span>
        <span class="s3">return false</span>
    <span class="s5">}</span>
    <span class="s3">if </span><span class="s5">(</span><span class="s2">selector </span><span class="s3">instanceof </span><span class="s2">HTMLCollection </span><span class="s5">|| </span><span class="s2">selector </span><span class="s3">instanceof </span><span class="s2">NodeList</span><span class="s5">) {</span>
        <span class="s3">return true</span>
    <span class="s5">}</span>
    <span class="s3">return false</span>
<span class="s5">}</span>

<span class="s0">/**</span>
 <span class="s0">* 封装 querySelectorAll</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">selector css 选择器</span>
 <span class="s0">*/</span>
<span class="s3">function </span><span class="s2">_querySelectorAll</span><span class="s5">(</span><span class="s2">selector</span><span class="s5">: </span><span class="s2">string</span><span class="s5">): </span><span class="s2">HTMLElement</span><span class="s5">[] {</span>
    <span class="s3">const </span><span class="s2">elems </span><span class="s5">= </span><span class="s2">document</span><span class="s5">.</span><span class="s2">querySelectorAll</span><span class="s5">(</span><span class="s2">selector</span><span class="s5">)</span>
    <span class="s3">return </span><span class="s2">toArray</span><span class="s5">(</span><span class="s2">elems</span><span class="s5">)</span>
<span class="s5">}</span>

<span class="s0">/**</span>
 <span class="s0">* 封装 _styleArrTrim</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">styleArr css</span>
 <span class="s0">*/</span>
<span class="s3">function </span><span class="s2">_styleArrTrim</span><span class="s5">(</span><span class="s2">style</span><span class="s5">: </span><span class="s2">string </span><span class="s5">| </span><span class="s2">string</span><span class="s5">[]): </span><span class="s2">string</span><span class="s5">[] {</span>
    <span class="s3">let </span><span class="s2">styleArr</span><span class="s5">: </span><span class="s2">string</span><span class="s5">[] = []</span>
    <span class="s3">let </span><span class="s2">resultArr</span><span class="s5">: </span><span class="s2">string</span><span class="s5">[] = []</span>

    <span class="s3">if </span><span class="s5">(!</span><span class="s2">Array</span><span class="s5">.</span><span class="s2">isArray</span><span class="s5">(</span><span class="s2">style</span><span class="s5">)) {</span>
        <span class="s6">// 有 style，将 style 按照 `;` 拆分为数组</span>
        <span class="s2">styleArr </span><span class="s5">= </span><span class="s2">style</span><span class="s5">.</span><span class="s2">split</span><span class="s5">(</span><span class="s4">';'</span><span class="s5">)</span>
    <span class="s5">} </span><span class="s3">else </span><span class="s5">{</span>
        <span class="s2">styleArr </span><span class="s5">= </span><span class="s2">style</span>
    <span class="s5">}</span>

    <span class="s2">styleArr</span><span class="s5">.</span><span class="s2">forEach</span><span class="s5">(</span><span class="s2">item </span><span class="s5">=&gt; {</span>
        <span class="s6">// 对每项样式，按照 : 拆分为 key 和 value</span>
        <span class="s3">let </span><span class="s2">arr </span><span class="s5">= </span><span class="s2">item</span><span class="s5">.</span><span class="s2">split</span><span class="s5">(</span><span class="s4">':'</span><span class="s5">).</span><span class="s2">map</span><span class="s5">(</span><span class="s2">i </span><span class="s5">=&gt; {</span>
            <span class="s3">return </span><span class="s2">i</span><span class="s5">.</span><span class="s2">trim</span><span class="s5">()</span>
        <span class="s5">})</span>
        <span class="s3">if </span><span class="s5">(</span><span class="s2">arr</span><span class="s5">.</span><span class="s2">length </span><span class="s5">=== </span><span class="s7">2</span><span class="s5">) {</span>
            <span class="s2">resultArr</span><span class="s5">.</span><span class="s2">push</span><span class="s5">(</span><span class="s2">arr</span><span class="s5">[</span><span class="s7">0</span><span class="s5">] + </span><span class="s4">':' </span><span class="s5">+ </span><span class="s2">arr</span><span class="s5">[</span><span class="s7">1</span><span class="s5">])</span>
        <span class="s5">}</span>
    <span class="s5">})</span>
    <span class="s3">return </span><span class="s2">resultArr</span>
<span class="s5">}</span>

<span class="s3">export </span><span class="s2">type DomElementSelector </span><span class="s5">=</span>
    <span class="s5">| </span><span class="s2">string</span>
    <span class="s5">| </span><span class="s2">DomElement</span>
    <span class="s5">| </span><span class="s2">Document</span>
    <span class="s5">| </span><span class="s2">Node</span>
    <span class="s5">| </span><span class="s2">NodeList</span>
    <span class="s5">| </span><span class="s2">ChildNode</span>
    <span class="s5">| </span><span class="s2">ChildNode</span><span class="s5">[]</span>
    <span class="s5">| </span><span class="s2">Element</span>
    <span class="s5">| </span><span class="s2">HTMLElement</span>
    <span class="s5">| </span><span class="s2">HTMLElement</span><span class="s5">[]</span>
    <span class="s5">| </span><span class="s2">HTMLCollection</span>
    <span class="s5">| </span><span class="s2">EventTarget</span>
    <span class="s5">| </span><span class="s3">null</span>
    <span class="s5">| </span><span class="s2">undefined</span>

<span class="s6">// 构造函数</span>
<span class="s3">export class </span><span class="s2">DomElement</span><span class="s5">&lt;</span><span class="s2">T </span><span class="s3">extends </span><span class="s2">DomElementSelector </span><span class="s5">= </span><span class="s2">DomElementSelector</span><span class="s5">&gt; {</span>
    <span class="s6">// 定义属性</span>
    <span class="s2">selector</span><span class="s5">!: </span><span class="s2">T</span>
    <span class="s2">length</span><span class="s5">: </span><span class="s2">number</span>
    <span class="s2">elems</span><span class="s5">: </span><span class="s2">HTMLElement</span><span class="s5">[]</span>
    <span class="s2">dataSource</span><span class="s5">: </span><span class="s2">Map</span><span class="s5">&lt;</span><span class="s2">string</span><span class="s5">, </span><span class="s2">any</span><span class="s5">&gt;</span>
    <span class="s2">prior</span><span class="s5">?: </span><span class="s2">DomElement </span><span class="s6">// 通过 getNodeTop 获取顶级段落的时候，可以通过 prior 去回溯来源的子节点</span>

    <span class="s0">/**</span>
     <span class="s0">* 构造函数</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">selector 任一类型的选择器</span>
     <span class="s0">*/</span>
    <span class="s2">constructor</span><span class="s5">(</span><span class="s2">selector</span><span class="s5">: </span><span class="s2">T</span><span class="s5">) {</span>
        <span class="s6">// 初始化属性</span>
        <span class="s3">this</span><span class="s5">.</span><span class="s2">elems </span><span class="s5">= []</span>
        <span class="s3">this</span><span class="s5">.</span><span class="s2">length </span><span class="s5">= </span><span class="s3">this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">.</span><span class="s2">length</span>
        <span class="s3">this</span><span class="s5">.</span><span class="s2">dataSource </span><span class="s5">= </span><span class="s3">new </span><span class="s2">Map</span><span class="s5">()</span>

        <span class="s3">if </span><span class="s5">(!</span><span class="s2">selector</span><span class="s5">) {</span>
            <span class="s3">return</span>
        <span class="s5">}</span>

        <span class="s6">// 原本就是 DomElement 实例，则直接返回</span>
        <span class="s3">if </span><span class="s5">(</span><span class="s2">selector </span><span class="s3">instanceof </span><span class="s2">DomElement</span><span class="s5">) {</span>
            <span class="s3">return </span><span class="s2">selector </span><span class="s5">as </span><span class="s2">DomElement</span><span class="s5">&lt;</span><span class="s2">T</span><span class="s5">&gt;</span>
        <span class="s5">}</span>

        <span class="s3">let </span><span class="s2">selectorResult</span><span class="s5">: </span><span class="s2">HTMLElement</span><span class="s5">[] = [] </span><span class="s6">// 存储查询结果</span>
        <span class="s3">const </span><span class="s2">nodeType </span><span class="s5">= </span><span class="s2">selector </span><span class="s3">instanceof </span><span class="s2">Node </span><span class="s5">? </span><span class="s2">selector</span><span class="s5">.</span><span class="s2">nodeType </span><span class="s5">: -</span><span class="s7">1</span>
        <span class="s3">this</span><span class="s5">.</span><span class="s2">selector </span><span class="s5">= </span><span class="s2">selector</span>

        <span class="s3">if </span><span class="s5">(</span><span class="s2">nodeType </span><span class="s5">=== </span><span class="s7">1 </span><span class="s5">|| </span><span class="s2">nodeType </span><span class="s5">=== </span><span class="s7">9</span><span class="s5">) {</span>
            <span class="s2">selectorResult </span><span class="s5">= [</span><span class="s2">selector </span><span class="s5">as </span><span class="s2">HTMLElement</span><span class="s5">]</span>
        <span class="s5">} </span><span class="s3">else if </span><span class="s5">(</span><span class="s2">_isDOMList</span><span class="s5">(</span><span class="s2">selector</span><span class="s5">)) {</span>
            <span class="s6">// DOM List</span>
            <span class="s2">selectorResult </span><span class="s5">= </span><span class="s2">toArray</span><span class="s5">(</span><span class="s2">selector</span><span class="s5">)</span>
        <span class="s5">} </span><span class="s3">else if </span><span class="s5">(</span><span class="s2">selector </span><span class="s3">instanceof </span><span class="s2">Array</span><span class="s5">) {</span>
            <span class="s6">// Element 数组（其他数据类型，暂时忽略）</span>
            <span class="s2">selectorResult </span><span class="s5">= </span><span class="s2">selector </span><span class="s5">as </span><span class="s2">HTMLElement</span><span class="s5">[]</span>
        <span class="s5">} </span><span class="s3">else if </span><span class="s5">(</span><span class="s3">typeof </span><span class="s2">selector </span><span class="s5">=== </span><span class="s4">'string'</span><span class="s5">) {</span>
            <span class="s6">// 字符串</span>
            <span class="s3">const </span><span class="s2">tmpSelector </span><span class="s5">= </span><span class="s2">selector</span><span class="s5">.</span><span class="s2">replace</span><span class="s5">(</span><span class="s4">'/</span><span class="s3">\n</span><span class="s4">/mg'</span><span class="s5">, </span><span class="s4">''</span><span class="s5">).</span><span class="s2">trim</span><span class="s5">()</span>
            <span class="s3">if </span><span class="s5">(</span><span class="s2">tmpSelector</span><span class="s5">.</span><span class="s2">indexOf</span><span class="s5">(</span><span class="s4">'&lt;'</span><span class="s5">) === </span><span class="s7">0</span><span class="s5">) {</span>
                <span class="s6">// 如 &lt;div&gt;</span>
                <span class="s2">selectorResult </span><span class="s5">= </span><span class="s2">_createElemByHTML</span><span class="s5">(</span><span class="s2">tmpSelector</span><span class="s5">)</span>
            <span class="s5">} </span><span class="s3">else </span><span class="s5">{</span>
                <span class="s6">// 如 #id .class</span>
                <span class="s2">selectorResult </span><span class="s5">= </span><span class="s2">_querySelectorAll</span><span class="s5">(</span><span class="s2">tmpSelector</span><span class="s5">)</span>
            <span class="s5">}</span>
        <span class="s5">}</span>

        <span class="s3">const </span><span class="s2">length </span><span class="s5">= </span><span class="s2">selectorResult</span><span class="s5">.</span><span class="s2">length</span>
        <span class="s3">if </span><span class="s5">(!</span><span class="s2">length</span><span class="s5">) {</span>
            <span class="s6">// 空数组</span>
            <span class="s3">return this</span>
        <span class="s5">}</span>

        <span class="s6">// 加入 DOM 节点</span>
        <span class="s3">let </span><span class="s2">i </span><span class="s5">= </span><span class="s7">0</span>
        <span class="s3">for </span><span class="s5">(; </span><span class="s2">i </span><span class="s5">&lt; </span><span class="s2">length</span><span class="s5">; </span><span class="s2">i</span><span class="s5">++) {</span>
            <span class="s3">this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">.</span><span class="s2">push</span><span class="s5">(</span><span class="s2">selectorResult</span><span class="s5">[</span><span class="s2">i</span><span class="s5">])</span>
        <span class="s5">}</span>
        <span class="s3">this</span><span class="s5">.</span><span class="s2">length </span><span class="s5">= </span><span class="s2">length</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 获取元素 id</span>
     <span class="s0">*/</span>
    <span class="s2">get id</span><span class="s5">(): </span><span class="s2">string </span><span class="s5">{</span>
        <span class="s3">return this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s7">0</span><span class="s5">].</span><span class="s2">id</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 遍历所有元素，执行回调函数</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">fn 回调函数</span>
     <span class="s0">*/</span>
    <span class="s2">forEach</span><span class="s5">(</span><span class="s2">fn</span><span class="s5">: (</span><span class="s2">ele</span><span class="s5">: </span><span class="s2">HTMLElement</span><span class="s5">, </span><span class="s2">index</span><span class="s5">?: </span><span class="s2">number</span><span class="s5">) =&gt; </span><span class="s2">boolean </span><span class="s5">| </span><span class="s2">unknown</span><span class="s5">): </span><span class="s2">DomElement </span><span class="s5">{</span>
        <span class="s3">for </span><span class="s5">(</span><span class="s3">let </span><span class="s2">i </span><span class="s5">= </span><span class="s7">0</span><span class="s5">; </span><span class="s2">i </span><span class="s5">&lt; </span><span class="s3">this</span><span class="s5">.</span><span class="s2">length</span><span class="s5">; </span><span class="s2">i</span><span class="s5">++) {</span>
            <span class="s3">const </span><span class="s2">elem </span><span class="s5">= </span><span class="s3">this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s2">i</span><span class="s5">]</span>
            <span class="s3">const </span><span class="s2">result </span><span class="s5">= </span><span class="s2">fn</span><span class="s5">.</span><span class="s2">call</span><span class="s5">(</span><span class="s2">elem</span><span class="s5">, </span><span class="s2">elem</span><span class="s5">, </span><span class="s2">i</span><span class="s5">)</span>
            <span class="s3">if </span><span class="s5">(</span><span class="s2">result </span><span class="s5">=== </span><span class="s3">false</span><span class="s5">) {</span>
                <span class="s3">break</span>
            <span class="s5">}</span>
        <span class="s5">}</span>
        <span class="s3">return this</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 克隆元素</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">deep 是否深度克隆</span>
     <span class="s0">*/</span>
    <span class="s2">clone</span><span class="s5">(</span><span class="s2">deep</span><span class="s5">: </span><span class="s2">boolean </span><span class="s5">= </span><span class="s3">false</span><span class="s5">): </span><span class="s2">DomElement </span><span class="s5">{</span>
        <span class="s3">const </span><span class="s2">cloneList</span><span class="s5">: </span><span class="s2">HTMLElement</span><span class="s5">[] = []</span>
        <span class="s3">this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">.</span><span class="s2">forEach</span><span class="s5">(</span><span class="s2">elem </span><span class="s5">=&gt; {</span>
            <span class="s2">cloneList</span><span class="s5">.</span><span class="s2">push</span><span class="s5">(</span><span class="s2">elem</span><span class="s5">.</span><span class="s2">cloneNode</span><span class="s5">(!!</span><span class="s2">deep</span><span class="s5">) as </span><span class="s2">HTMLElement</span><span class="s5">)</span>
        <span class="s5">})</span>
        <span class="s3">return </span><span class="s2">$</span><span class="s5">(</span><span class="s2">cloneList</span><span class="s5">)</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 获取第几个元素</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">index index</span>
     <span class="s0">*/</span>
    <span class="s2">get</span><span class="s5">(</span><span class="s2">index</span><span class="s5">: </span><span class="s2">number </span><span class="s5">= </span><span class="s7">0</span><span class="s5">): </span><span class="s2">DomElement </span><span class="s5">{</span>
        <span class="s3">const </span><span class="s2">length </span><span class="s5">= </span><span class="s3">this</span><span class="s5">.</span><span class="s2">length</span>
        <span class="s3">if </span><span class="s5">(</span><span class="s2">index </span><span class="s5">&gt;= </span><span class="s2">length</span><span class="s5">) {</span>
            <span class="s2">index </span><span class="s5">= </span><span class="s2">index </span><span class="s5">% </span><span class="s2">length</span>
        <span class="s5">}</span>
        <span class="s3">return </span><span class="s2">$</span><span class="s5">(</span><span class="s3">this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s2">index</span><span class="s5">])</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 获取第一个元素</span>
     <span class="s0">*/</span>
    <span class="s2">first</span><span class="s5">(): </span><span class="s2">DomElement </span><span class="s5">{</span>
        <span class="s3">return this</span><span class="s5">.</span><span class="s2">get</span><span class="s5">(</span><span class="s7">0</span><span class="s5">)</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 获取最后一个元素</span>
     <span class="s0">*/</span>
    <span class="s2">last</span><span class="s5">(): </span><span class="s2">DomElement </span><span class="s5">{</span>
        <span class="s3">const </span><span class="s2">length </span><span class="s5">= </span><span class="s3">this</span><span class="s5">.</span><span class="s2">length</span>
        <span class="s3">return this</span><span class="s5">.</span><span class="s2">get</span><span class="s5">(</span><span class="s2">length </span><span class="s5">- </span><span class="s7">1</span><span class="s5">)</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 绑定事件</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">type 事件类型</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">selector DOM 选择器</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">fn 事件函数</span>
     <span class="s0">*/</span>
    <span class="s2">on</span><span class="s5">(</span><span class="s2">type</span><span class="s5">: </span><span class="s2">string</span><span class="s5">, </span><span class="s2">fn</span><span class="s5">: </span><span class="s2">Function</span><span class="s5">): </span><span class="s2">DomElement</span>
    <span class="s2">on</span><span class="s5">(</span><span class="s2">type</span><span class="s5">: </span><span class="s2">string</span><span class="s5">, </span><span class="s2">selector</span><span class="s5">: </span><span class="s2">string</span><span class="s5">, </span><span class="s2">fn</span><span class="s5">: </span><span class="s2">Function</span><span class="s5">): </span><span class="s2">DomElement</span>
    <span class="s2">on</span><span class="s5">(</span><span class="s2">type</span><span class="s5">: </span><span class="s2">string</span><span class="s5">, </span><span class="s2">selector</span><span class="s5">: </span><span class="s2">string </span><span class="s5">| </span><span class="s2">Function</span><span class="s5">, </span><span class="s2">fn</span><span class="s5">?: </span><span class="s2">Function</span><span class="s5">): </span><span class="s2">DomElement </span><span class="s5">{</span>
        <span class="s3">if </span><span class="s5">(!</span><span class="s2">type</span><span class="s5">) </span><span class="s3">return this</span>

        <span class="s6">// 没有 selector ，只有 type 和 fn</span>
        <span class="s3">if </span><span class="s5">(</span><span class="s3">typeof </span><span class="s2">selector </span><span class="s5">=== </span><span class="s4">'function'</span><span class="s5">) {</span>
            <span class="s2">fn </span><span class="s5">= </span><span class="s2">selector</span>
            <span class="s2">selector </span><span class="s5">= </span><span class="s4">''</span>
        <span class="s5">}</span>

        <span class="s3">return this</span><span class="s5">.</span><span class="s2">forEach</span><span class="s5">(</span><span class="s2">elem </span><span class="s5">=&gt; {</span>
            <span class="s6">// 没有事件代理</span>
            <span class="s3">if </span><span class="s5">(!</span><span class="s2">selector</span><span class="s5">) {</span>
                <span class="s6">// 无代理</span>
                <span class="s2">elem</span><span class="s5">.</span><span class="s2">addEventListener</span><span class="s5">(</span><span class="s2">type</span><span class="s5">, </span><span class="s2">fn </span><span class="s5">as </span><span class="s2">listener</span><span class="s5">)</span>
                <span class="s3">return</span>
            <span class="s5">}</span>

            <span class="s6">// 有事件代理</span>
            <span class="s3">const </span><span class="s2">agentFn</span><span class="s5">: </span><span class="s2">listener </span><span class="s5">= </span><span class="s3">function </span><span class="s5">(</span><span class="s2">e</span><span class="s5">) {</span>
                <span class="s3">const </span><span class="s2">target </span><span class="s5">= </span><span class="s2">e</span><span class="s5">.</span><span class="s2">target </span><span class="s5">as </span><span class="s2">HTMLElement</span>
                <span class="s3">if </span><span class="s5">(</span><span class="s2">target</span><span class="s5">.</span><span class="s2">matches</span><span class="s5">(</span><span class="s2">selector </span><span class="s5">as </span><span class="s2">string</span><span class="s5">)) {</span>
                    <span class="s5">;(</span><span class="s2">fn </span><span class="s5">as </span><span class="s2">listener</span><span class="s5">).</span><span class="s2">call</span><span class="s5">(</span><span class="s2">target</span><span class="s5">, </span><span class="s2">e</span><span class="s5">)</span>
                <span class="s5">}</span>
            <span class="s5">}</span>
            <span class="s2">elem</span><span class="s5">.</span><span class="s2">addEventListener</span><span class="s5">(</span><span class="s2">type</span><span class="s5">, </span><span class="s2">agentFn</span><span class="s5">)</span>

            <span class="s6">// 缓存代理事件</span>
            <span class="s2">AGENT_EVENTS</span><span class="s5">.</span><span class="s2">push</span><span class="s5">({</span>
                <span class="s2">elem</span><span class="s5">: </span><span class="s2">elem</span><span class="s5">,</span>
                <span class="s2">selector</span><span class="s5">: </span><span class="s2">selector </span><span class="s5">as </span><span class="s2">string</span><span class="s5">,</span>
                <span class="s2">fn</span><span class="s5">: </span><span class="s2">fn </span><span class="s5">as </span><span class="s2">listener</span><span class="s5">,</span>
                <span class="s2">agentFn</span><span class="s5">,</span>
            <span class="s5">})</span>
        <span class="s5">})</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 解绑事件</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">type 事件类型</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">selector DOM 选择器</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">fn 事件函数</span>
     <span class="s0">*/</span>
    <span class="s2">off</span><span class="s5">(</span><span class="s2">type</span><span class="s5">: </span><span class="s2">string</span><span class="s5">, </span><span class="s2">fn</span><span class="s5">: </span><span class="s2">Function</span><span class="s5">): </span><span class="s2">DomElement</span>
    <span class="s2">off</span><span class="s5">(</span><span class="s2">type</span><span class="s5">: </span><span class="s2">string</span><span class="s5">, </span><span class="s2">selector</span><span class="s5">: </span><span class="s2">string</span><span class="s5">, </span><span class="s2">fn</span><span class="s5">: </span><span class="s2">Function</span><span class="s5">): </span><span class="s2">DomElement</span>
    <span class="s2">off</span><span class="s5">(</span><span class="s2">type</span><span class="s5">: </span><span class="s2">string</span><span class="s5">, </span><span class="s2">selector</span><span class="s5">: </span><span class="s2">string </span><span class="s5">| </span><span class="s2">Function</span><span class="s5">, </span><span class="s2">fn</span><span class="s5">?: </span><span class="s2">Function</span><span class="s5">): </span><span class="s2">DomElement </span><span class="s5">{</span>
        <span class="s3">if </span><span class="s5">(!</span><span class="s2">type</span><span class="s5">) </span><span class="s3">return this</span>

        <span class="s6">// 没有 selector ，只有 type 和 fn</span>
        <span class="s3">if </span><span class="s5">(</span><span class="s3">typeof </span><span class="s2">selector </span><span class="s5">=== </span><span class="s4">'function'</span><span class="s5">) {</span>
            <span class="s2">fn </span><span class="s5">= </span><span class="s2">selector</span>
            <span class="s2">selector </span><span class="s5">= </span><span class="s4">''</span>
        <span class="s5">}</span>

        <span class="s3">return this</span><span class="s5">.</span><span class="s2">forEach</span><span class="s5">(</span><span class="s3">function </span><span class="s5">(</span><span class="s2">elem</span><span class="s5">: </span><span class="s2">HTMLElement</span><span class="s5">) {</span>
            <span class="s6">// 解绑事件代理</span>
            <span class="s3">if </span><span class="s5">(</span><span class="s2">selector</span><span class="s5">) {</span>
                <span class="s3">let </span><span class="s2">idx </span><span class="s5">= -</span><span class="s7">1</span>
                <span class="s3">for </span><span class="s5">(</span><span class="s3">let </span><span class="s2">i </span><span class="s5">= </span><span class="s7">0</span><span class="s5">; </span><span class="s2">i </span><span class="s5">&lt; </span><span class="s2">AGENT_EVENTS</span><span class="s5">.</span><span class="s2">length</span><span class="s5">; </span><span class="s2">i</span><span class="s5">++) {</span>
                    <span class="s3">let </span><span class="s2">item </span><span class="s5">= </span><span class="s2">AGENT_EVENTS</span><span class="s5">[</span><span class="s2">i</span><span class="s5">]</span>
                    <span class="s3">if </span><span class="s5">(</span><span class="s2">item</span><span class="s5">.</span><span class="s2">selector </span><span class="s5">=== </span><span class="s2">selector </span><span class="s5">&amp;&amp; </span><span class="s2">item</span><span class="s5">.</span><span class="s2">fn </span><span class="s5">=== </span><span class="s2">fn </span><span class="s5">&amp;&amp; </span><span class="s2">item</span><span class="s5">.</span><span class="s2">elem </span><span class="s5">=== </span><span class="s2">elem</span><span class="s5">) {</span>
                        <span class="s2">idx </span><span class="s5">= </span><span class="s2">i</span>
                        <span class="s3">break</span>
                    <span class="s5">}</span>
                <span class="s5">}</span>
                <span class="s3">if </span><span class="s5">(</span><span class="s2">idx </span><span class="s5">!== -</span><span class="s7">1</span><span class="s5">) {</span>
                    <span class="s3">const </span><span class="s5">{ </span><span class="s2">agentFn </span><span class="s5">} = </span><span class="s2">AGENT_EVENTS</span><span class="s5">.</span><span class="s2">splice</span><span class="s5">(</span><span class="s2">idx</span><span class="s5">, </span><span class="s7">1</span><span class="s5">)[</span><span class="s7">0</span><span class="s5">]</span>
                    <span class="s2">elem</span><span class="s5">.</span><span class="s2">removeEventListener</span><span class="s5">(</span><span class="s2">type</span><span class="s5">, </span><span class="s2">agentFn</span><span class="s5">)</span>
                <span class="s5">}</span>
            <span class="s5">} </span><span class="s3">else </span><span class="s5">{</span>
                <span class="s6">// @ts-ignore</span>
                <span class="s2">elem</span><span class="s5">.</span><span class="s2">removeEventListener</span><span class="s5">(</span><span class="s2">type</span><span class="s5">, </span><span class="s2">fn</span><span class="s5">)</span>
            <span class="s5">}</span>
        <span class="s5">})</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 设置/获取 属性</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">key key</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">val value</span>
     <span class="s0">*/</span>
    <span class="s2">attr</span><span class="s5">(</span><span class="s2">key</span><span class="s5">: </span><span class="s2">string</span><span class="s5">): </span><span class="s2">string</span>
    <span class="s2">attr</span><span class="s5">(</span><span class="s2">key</span><span class="s5">: </span><span class="s2">string</span><span class="s5">, </span><span class="s2">val</span><span class="s5">: </span><span class="s2">string</span><span class="s5">): </span><span class="s2">DomElement</span>
    <span class="s2">attr</span><span class="s5">(</span><span class="s2">key</span><span class="s5">: </span><span class="s2">string</span><span class="s5">, </span><span class="s2">val</span><span class="s5">?: </span><span class="s2">string</span><span class="s5">): </span><span class="s2">DomElement </span><span class="s5">| </span><span class="s2">string </span><span class="s5">{</span>
        <span class="s3">if </span><span class="s5">(</span><span class="s2">val </span><span class="s5">== </span><span class="s3">null</span><span class="s5">) {</span>
            <span class="s6">// 获取数据</span>
            <span class="s3">return this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s7">0</span><span class="s5">].</span><span class="s2">getAttribute</span><span class="s5">(</span><span class="s2">key</span><span class="s5">) || </span><span class="s4">''</span>
        <span class="s5">}</span>

        <span class="s6">// 否则，设置属性</span>
        <span class="s3">return this</span><span class="s5">.</span><span class="s2">forEach</span><span class="s5">(</span><span class="s3">function </span><span class="s5">(</span><span class="s2">elem</span><span class="s5">: </span><span class="s2">HTMLElement</span><span class="s5">) {</span>
            <span class="s2">elem</span><span class="s5">.</span><span class="s2">setAttribute</span><span class="s5">(</span><span class="s2">key</span><span class="s5">, </span><span class="s2">val</span><span class="s5">)</span>
        <span class="s5">})</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 删除 属性</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">key key</span>
     <span class="s0">*/</span>
    <span class="s2">removeAttr</span><span class="s5">(</span><span class="s2">key</span><span class="s5">: </span><span class="s2">string</span><span class="s5">): </span><span class="s3">void </span><span class="s5">{</span>
        <span class="s3">this</span><span class="s5">.</span><span class="s2">forEach</span><span class="s5">(</span><span class="s3">function </span><span class="s5">(</span><span class="s2">elem</span><span class="s5">: </span><span class="s2">HTMLElement</span><span class="s5">) {</span>
            <span class="s2">elem</span><span class="s5">.</span><span class="s2">removeAttribute</span><span class="s5">(</span><span class="s2">key</span><span class="s5">)</span>
        <span class="s5">})</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 添加 css class</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">className css class</span>
     <span class="s0">*/</span>
    <span class="s2">addClass</span><span class="s5">(</span><span class="s2">className</span><span class="s5">?: </span><span class="s2">string</span><span class="s5">): </span><span class="s2">DomElement </span><span class="s5">{</span>
        <span class="s3">if </span><span class="s5">(!</span><span class="s2">className</span><span class="s5">) {</span>
            <span class="s3">return this</span>
        <span class="s5">}</span>

        <span class="s3">return this</span><span class="s5">.</span><span class="s2">forEach</span><span class="s5">(</span><span class="s3">function </span><span class="s5">(</span><span class="s2">elem</span><span class="s5">: </span><span class="s2">HTMLElement</span><span class="s5">) {</span>
            <span class="s3">if </span><span class="s5">(</span><span class="s2">elem</span><span class="s5">.</span><span class="s2">className</span><span class="s5">) {</span>
                <span class="s6">// 当前有 class</span>
                <span class="s3">let </span><span class="s2">arr</span><span class="s5">: </span><span class="s2">string</span><span class="s5">[] = </span><span class="s2">elem</span><span class="s5">.</span><span class="s2">className</span><span class="s5">.</span><span class="s2">split</span><span class="s5">(</span><span class="s8">/\s/</span><span class="s5">)</span>
                <span class="s2">arr </span><span class="s5">= </span><span class="s2">arr</span><span class="s5">.</span><span class="s2">filter</span><span class="s5">(</span><span class="s2">item </span><span class="s5">=&gt; {</span>
                    <span class="s3">return </span><span class="s5">!!</span><span class="s2">item</span><span class="s5">.</span><span class="s2">trim</span><span class="s5">()</span>
                <span class="s5">})</span>
                <span class="s6">// 添加 class</span>
                <span class="s3">if </span><span class="s5">(</span><span class="s2">arr</span><span class="s5">.</span><span class="s2">indexOf</span><span class="s5">(</span><span class="s2">className</span><span class="s5">) &lt; </span><span class="s7">0</span><span class="s5">) {</span>
                    <span class="s2">arr</span><span class="s5">.</span><span class="s2">push</span><span class="s5">(</span><span class="s2">className</span><span class="s5">)</span>
                <span class="s5">}</span>
                <span class="s6">// 修改 elem.class</span>
                <span class="s2">elem</span><span class="s5">.</span><span class="s2">className </span><span class="s5">= </span><span class="s2">arr</span><span class="s5">.</span><span class="s2">join</span><span class="s5">(</span><span class="s4">' '</span><span class="s5">)</span>
            <span class="s5">} </span><span class="s3">else </span><span class="s5">{</span>
                <span class="s6">// 当前没有 class</span>
                <span class="s2">elem</span><span class="s5">.</span><span class="s2">className </span><span class="s5">= </span><span class="s2">className</span>
            <span class="s5">}</span>
        <span class="s5">})</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 添加 css class</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">className css class</span>
     <span class="s0">*/</span>
    <span class="s2">removeClass</span><span class="s5">(</span><span class="s2">className</span><span class="s5">?: </span><span class="s2">string</span><span class="s5">): </span><span class="s2">DomElement </span><span class="s5">{</span>
        <span class="s3">if </span><span class="s5">(!</span><span class="s2">className</span><span class="s5">) {</span>
            <span class="s3">return this</span>
        <span class="s5">}</span>
        <span class="s3">return this</span><span class="s5">.</span><span class="s2">forEach</span><span class="s5">(</span><span class="s3">function </span><span class="s5">(</span><span class="s2">elem</span><span class="s5">: </span><span class="s2">HTMLElement</span><span class="s5">) {</span>
            <span class="s3">if </span><span class="s5">(!</span><span class="s2">elem</span><span class="s5">.</span><span class="s2">className</span><span class="s5">) {</span>
                <span class="s6">// 当前无 class</span>
                <span class="s3">return</span>
            <span class="s5">}</span>

            <span class="s3">let </span><span class="s2">arr</span><span class="s5">: </span><span class="s2">string</span><span class="s5">[] = </span><span class="s2">elem</span><span class="s5">.</span><span class="s2">className</span><span class="s5">.</span><span class="s2">split</span><span class="s5">(</span><span class="s8">/\s/</span><span class="s5">)</span>
            <span class="s2">arr </span><span class="s5">= </span><span class="s2">arr</span><span class="s5">.</span><span class="s2">filter</span><span class="s5">(</span><span class="s2">item </span><span class="s5">=&gt; {</span>
                <span class="s2">item </span><span class="s5">= </span><span class="s2">item</span><span class="s5">.</span><span class="s2">trim</span><span class="s5">()</span>
                <span class="s6">// 删除 class</span>
                <span class="s3">if </span><span class="s5">(!</span><span class="s2">item </span><span class="s5">|| </span><span class="s2">item </span><span class="s5">=== </span><span class="s2">className</span><span class="s5">) {</span>
                    <span class="s3">return false</span>
                <span class="s5">}</span>
                <span class="s3">return true</span>
            <span class="s5">})</span>
            <span class="s6">// 修改 elem.class</span>
            <span class="s2">elem</span><span class="s5">.</span><span class="s2">className </span><span class="s5">= </span><span class="s2">arr</span><span class="s5">.</span><span class="s2">join</span><span class="s5">(</span><span class="s4">' '</span><span class="s5">)</span>
        <span class="s5">})</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 是否有传入的 css class</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">className css class</span>
     <span class="s0">*/</span>
    <span class="s2">hasClass</span><span class="s5">(</span><span class="s2">className</span><span class="s5">?: </span><span class="s2">string</span><span class="s5">): </span><span class="s2">boolean </span><span class="s5">{</span>
        <span class="s3">if </span><span class="s5">(!</span><span class="s2">className</span><span class="s5">) {</span>
            <span class="s3">return false</span>
        <span class="s5">}</span>
        <span class="s3">const </span><span class="s2">elem </span><span class="s5">= </span><span class="s3">this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span>
        <span class="s3">if </span><span class="s5">(!</span><span class="s2">elem</span><span class="s5">.</span><span class="s2">className</span><span class="s5">) {</span>
            <span class="s6">// 当前无 class</span>
            <span class="s3">return false</span>
        <span class="s5">}</span>
        <span class="s3">let </span><span class="s2">arr</span><span class="s5">: </span><span class="s2">string</span><span class="s5">[] = </span><span class="s2">elem</span><span class="s5">.</span><span class="s2">className</span><span class="s5">.</span><span class="s2">split</span><span class="s5">(</span><span class="s8">/\s/</span><span class="s5">)</span>
        <span class="s3">return </span><span class="s2">arr</span><span class="s5">.</span><span class="s2">includes</span><span class="s5">(</span><span class="s2">className</span><span class="s5">) </span><span class="s6">// 是否包含</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 修改 css</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">key css key</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">val css value</span>
     <span class="s0">*/</span>
    <span class="s6">// css(key: string): string</span>
    <span class="s2">css</span><span class="s5">(</span><span class="s2">key</span><span class="s5">: </span><span class="s2">string</span><span class="s5">, </span><span class="s2">val</span><span class="s5">?: </span><span class="s2">string </span><span class="s5">| </span><span class="s2">number</span><span class="s5">): </span><span class="s2">DomElement </span><span class="s5">{</span>
        <span class="s3">let </span><span class="s2">currentStyle</span><span class="s5">: </span><span class="s2">string</span>
        <span class="s3">if </span><span class="s5">(</span><span class="s2">val </span><span class="s5">== </span><span class="s4">''</span><span class="s5">) {</span>
            <span class="s2">currentStyle </span><span class="s5">= </span><span class="s4">''</span>
        <span class="s5">} </span><span class="s3">else </span><span class="s5">{</span>
            <span class="s2">currentStyle </span><span class="s5">= </span><span class="s4">`</span><span class="s2">$</span><span class="s5">{</span><span class="s2">key</span><span class="s5">}</span><span class="s4">:</span><span class="s2">$</span><span class="s5">{</span><span class="s2">val</span><span class="s5">}</span><span class="s4">;`</span>
        <span class="s5">}</span>
        <span class="s3">return this</span><span class="s5">.</span><span class="s2">forEach</span><span class="s5">(</span><span class="s2">elem </span><span class="s5">=&gt; {</span>
            <span class="s3">const </span><span class="s2">style </span><span class="s5">= (</span><span class="s2">elem</span><span class="s5">.</span><span class="s2">getAttribute</span><span class="s5">(</span><span class="s4">'style'</span><span class="s5">) || </span><span class="s4">''</span><span class="s5">).</span><span class="s2">trim</span><span class="s5">()</span>
            <span class="s3">if </span><span class="s5">(</span><span class="s2">style</span><span class="s5">) {</span>
                <span class="s6">// 有 style，将 style 按照 `;` 拆分为数组</span>
                <span class="s3">let </span><span class="s2">resultArr</span><span class="s5">: </span><span class="s2">string</span><span class="s5">[] = </span><span class="s2">_styleArrTrim</span><span class="s5">(</span><span class="s2">style</span><span class="s5">)</span>

                <span class="s6">// 替换现有的 style</span>
                <span class="s2">resultArr </span><span class="s5">= </span><span class="s2">resultArr</span><span class="s5">.</span><span class="s2">map</span><span class="s5">(</span><span class="s2">item </span><span class="s5">=&gt; {</span>
                    <span class="s3">if </span><span class="s5">(</span><span class="s2">item</span><span class="s5">.</span><span class="s2">indexOf</span><span class="s5">(</span><span class="s2">key</span><span class="s5">) === </span><span class="s7">0</span><span class="s5">) {</span>
                        <span class="s3">return </span><span class="s2">currentStyle</span>
                    <span class="s5">} </span><span class="s3">else </span><span class="s5">{</span>
                        <span class="s3">return </span><span class="s2">item</span>
                    <span class="s5">}</span>
                <span class="s5">})</span>
                <span class="s6">// 新增 style</span>
                <span class="s3">if </span><span class="s5">(</span><span class="s2">currentStyle </span><span class="s5">!= </span><span class="s4">'' </span><span class="s5">&amp;&amp; </span><span class="s2">resultArr</span><span class="s5">.</span><span class="s2">indexOf</span><span class="s5">(</span><span class="s2">currentStyle</span><span class="s5">) &lt; </span><span class="s7">0</span><span class="s5">) {</span>
                    <span class="s2">resultArr</span><span class="s5">.</span><span class="s2">push</span><span class="s5">(</span><span class="s2">currentStyle</span><span class="s5">)</span>
                <span class="s5">}</span>

                <span class="s6">// 去掉 空白</span>
                <span class="s3">if </span><span class="s5">(</span><span class="s2">currentStyle </span><span class="s5">== </span><span class="s4">''</span><span class="s5">) {</span>
                    <span class="s2">resultArr </span><span class="s5">= </span><span class="s2">_styleArrTrim</span><span class="s5">(</span><span class="s2">resultArr</span><span class="s5">)</span>
                <span class="s5">}</span>

                <span class="s6">// 重新设置 style</span>
                <span class="s2">elem</span><span class="s5">.</span><span class="s2">setAttribute</span><span class="s5">(</span><span class="s4">'style'</span><span class="s5">, </span><span class="s2">resultArr</span><span class="s5">.</span><span class="s2">join</span><span class="s5">(</span><span class="s4">'; '</span><span class="s5">))</span>
            <span class="s5">} </span><span class="s3">else </span><span class="s5">{</span>
                <span class="s6">// 当前没有 style</span>
                <span class="s2">elem</span><span class="s5">.</span><span class="s2">setAttribute</span><span class="s5">(</span><span class="s4">'style'</span><span class="s5">, </span><span class="s2">currentStyle</span><span class="s5">)</span>
            <span class="s5">}</span>
        <span class="s5">})</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 封装 getBoundingClientRect</span>
     <span class="s0">*/</span>
    <span class="s2">getBoundingClientRect</span><span class="s5">(): </span><span class="s2">DOMRect </span><span class="s5">{</span>
        <span class="s3">const </span><span class="s2">elem </span><span class="s5">= </span><span class="s3">this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span>
        <span class="s3">return </span><span class="s2">elem</span><span class="s5">.</span><span class="s2">getBoundingClientRect</span><span class="s5">()</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 显示</span>
     <span class="s0">*/</span>
    <span class="s2">show</span><span class="s5">(): </span><span class="s2">DomElement </span><span class="s5">{</span>
        <span class="s3">return this</span><span class="s5">.</span><span class="s2">css</span><span class="s5">(</span><span class="s4">'display'</span><span class="s5">, </span><span class="s4">'block'</span><span class="s5">)</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 隐藏</span>
     <span class="s0">*/</span>
    <span class="s2">hide</span><span class="s5">(): </span><span class="s2">DomElement </span><span class="s5">{</span>
        <span class="s3">return this</span><span class="s5">.</span><span class="s2">css</span><span class="s5">(</span><span class="s4">'display'</span><span class="s5">, </span><span class="s4">'none'</span><span class="s5">)</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 获取子节点（只有 DOM 元素）</span>
     <span class="s0">*/</span>
    <span class="s2">children</span><span class="s5">(): </span><span class="s2">DomElement </span><span class="s5">| </span><span class="s3">null </span><span class="s5">{</span>
        <span class="s3">const </span><span class="s2">elem </span><span class="s5">= </span><span class="s3">this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span>
        <span class="s3">if </span><span class="s5">(!</span><span class="s2">elem</span><span class="s5">) {</span>
            <span class="s3">return null</span>
        <span class="s5">}</span>

        <span class="s3">return </span><span class="s2">$</span><span class="s5">(</span><span class="s2">elem</span><span class="s5">.</span><span class="s2">children</span><span class="s5">)</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 获取子节点（包括文本节点）</span>
     <span class="s0">*/</span>
    <span class="s2">childNodes</span><span class="s5">(): </span><span class="s2">DomElement </span><span class="s5">| </span><span class="s3">null </span><span class="s5">{</span>
        <span class="s3">const </span><span class="s2">elem </span><span class="s5">= </span><span class="s3">this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span>
        <span class="s3">if </span><span class="s5">(!</span><span class="s2">elem</span><span class="s5">) {</span>
            <span class="s3">return null</span>
        <span class="s5">}</span>

        <span class="s3">return </span><span class="s2">$</span><span class="s5">(</span><span class="s2">elem</span><span class="s5">.</span><span class="s2">childNodes</span><span class="s5">)</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 将子元素全部替换</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">$children 新的child节点</span>
     <span class="s0">*/</span>
    <span class="s2">replaceChildAll</span><span class="s5">(</span><span class="s2">$children</span><span class="s5">: </span><span class="s2">DomElement</span><span class="s5">): </span><span class="s3">void </span><span class="s5">{</span>
        <span class="s3">const </span><span class="s2">parent </span><span class="s5">= </span><span class="s3">this</span><span class="s5">.</span><span class="s2">getNode</span><span class="s5">()</span>
        <span class="s3">const </span><span class="s2">elem </span><span class="s5">= </span><span class="s3">this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span>
        <span class="s3">while </span><span class="s5">(</span><span class="s2">elem</span><span class="s5">.</span><span class="s2">hasChildNodes</span><span class="s5">()) {</span>
            <span class="s2">parent</span><span class="s5">.</span><span class="s2">firstChild </span><span class="s5">&amp;&amp; </span><span class="s2">elem</span><span class="s5">.</span><span class="s2">removeChild</span><span class="s5">(</span><span class="s2">parent</span><span class="s5">.</span><span class="s2">firstChild</span><span class="s5">)</span>
        <span class="s5">}</span>
        <span class="s3">this</span><span class="s5">.</span><span class="s2">append</span><span class="s5">(</span><span class="s2">$children</span><span class="s5">)</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 增加子节点</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">$children 子节点</span>
     <span class="s0">*/</span>
    <span class="s2">append</span><span class="s5">(</span><span class="s2">$children</span><span class="s5">: </span><span class="s2">DomElement</span><span class="s5">): </span><span class="s2">DomElement </span><span class="s5">{</span>
        <span class="s3">return this</span><span class="s5">.</span><span class="s2">forEach</span><span class="s5">(</span><span class="s2">elem </span><span class="s5">=&gt; {</span>
            <span class="s2">$children</span><span class="s5">.</span><span class="s2">forEach</span><span class="s5">(</span><span class="s3">function </span><span class="s5">(</span><span class="s2">child</span><span class="s5">: </span><span class="s2">HTMLElement</span><span class="s5">) {</span>
                <span class="s2">elem</span><span class="s5">.</span><span class="s2">appendChild</span><span class="s5">(</span><span class="s2">child</span><span class="s5">)</span>
            <span class="s5">})</span>
        <span class="s5">})</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 移除当前节点</span>
     <span class="s0">*/</span>
    <span class="s2">remove</span><span class="s5">(): </span><span class="s2">DomElement </span><span class="s5">{</span>
        <span class="s3">return this</span><span class="s5">.</span><span class="s2">forEach</span><span class="s5">(</span><span class="s2">elem </span><span class="s5">=&gt; {</span>
            <span class="s3">if </span><span class="s5">(</span><span class="s2">elem</span><span class="s5">.</span><span class="s2">remove</span><span class="s5">) {</span>
                <span class="s2">elem</span><span class="s5">.</span><span class="s2">remove</span><span class="s5">()</span>
            <span class="s5">} </span><span class="s3">else </span><span class="s5">{</span>
                <span class="s3">const </span><span class="s2">parent </span><span class="s5">= </span><span class="s2">elem</span><span class="s5">.</span><span class="s2">parentElement</span>
                <span class="s2">parent </span><span class="s5">&amp;&amp; </span><span class="s2">parent</span><span class="s5">.</span><span class="s2">removeChild</span><span class="s5">(</span><span class="s2">elem</span><span class="s5">)</span>
            <span class="s5">}</span>
        <span class="s5">})</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 当前元素，是否包含某个子元素</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">$child 子元素</span>
     <span class="s0">*/</span>
    <span class="s2">isContain</span><span class="s5">(</span><span class="s2">$child</span><span class="s5">: </span><span class="s2">DomElement</span><span class="s5">): </span><span class="s2">boolean </span><span class="s5">{</span>
        <span class="s3">const </span><span class="s2">elem </span><span class="s5">= </span><span class="s3">this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span>
        <span class="s3">const </span><span class="s2">child </span><span class="s5">= </span><span class="s2">$child</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span>
        <span class="s3">return </span><span class="s2">elem</span><span class="s5">.</span><span class="s2">contains</span><span class="s5">(</span><span class="s2">child</span><span class="s5">)</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 获取当前元素 nodeName</span>
     <span class="s0">*/</span>
    <span class="s2">getNodeName</span><span class="s5">(): </span><span class="s2">string </span><span class="s5">{</span>
        <span class="s3">const </span><span class="s2">elem </span><span class="s5">= </span><span class="s3">this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span>
        <span class="s3">return </span><span class="s2">elem</span><span class="s5">.</span><span class="s2">nodeName</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 根据元素位置获取元素节点（默认获取0位置的节点）</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">n 元素节点位置</span>
     <span class="s0">*/</span>
    <span class="s2">getNode</span><span class="s5">(</span><span class="s2">n</span><span class="s5">: </span><span class="s2">number </span><span class="s5">= </span><span class="s7">0</span><span class="s5">): </span><span class="s2">Node </span><span class="s5">{</span>
        <span class="s3">let </span><span class="s2">elem</span><span class="s5">: </span><span class="s2">Node</span>
        <span class="s2">elem </span><span class="s5">= </span><span class="s3">this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s2">n</span><span class="s5">]</span>
        <span class="s3">return </span><span class="s2">elem</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 查询</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">selector css 选择器</span>
     <span class="s0">*/</span>
    <span class="s2">find</span><span class="s5">(</span><span class="s2">selector</span><span class="s5">: </span><span class="s2">string</span><span class="s5">): </span><span class="s2">DomElement </span><span class="s5">{</span>
        <span class="s3">const </span><span class="s2">elem </span><span class="s5">= </span><span class="s3">this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span>
        <span class="s3">return </span><span class="s2">$</span><span class="s5">(</span><span class="s2">elem</span><span class="s5">.</span><span class="s2">querySelectorAll</span><span class="s5">(</span><span class="s2">selector</span><span class="s5">))</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 获取/设置 元素 text</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">val text 值</span>
     <span class="s0">*/</span>
    <span class="s2">text</span><span class="s5">(): </span><span class="s2">string</span>
    <span class="s2">text</span><span class="s5">(</span><span class="s2">val</span><span class="s5">: </span><span class="s2">string</span><span class="s5">): </span><span class="s2">DomElement</span>
    <span class="s2">text</span><span class="s5">(</span><span class="s2">val</span><span class="s5">?: </span><span class="s2">string</span><span class="s5">): </span><span class="s2">DomElement </span><span class="s5">| </span><span class="s2">string </span><span class="s5">{</span>
        <span class="s3">if </span><span class="s5">(!</span><span class="s2">val</span><span class="s5">) {</span>
            <span class="s6">// 获取 text</span>
            <span class="s3">const </span><span class="s2">elem </span><span class="s5">= </span><span class="s3">this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span>

            <span class="s3">return </span><span class="s2">elem</span><span class="s5">.</span><span class="s2">innerHTML</span><span class="s5">.</span><span class="s2">replace</span><span class="s5">(</span><span class="s8">/&lt;[^&gt;]+&gt;/g</span><span class="s5">, () =&gt; </span><span class="s4">''</span><span class="s5">)</span>
        <span class="s5">} </span><span class="s3">else </span><span class="s5">{</span>
            <span class="s6">// 设置 text</span>
            <span class="s3">return this</span><span class="s5">.</span><span class="s2">forEach</span><span class="s5">(</span><span class="s3">function </span><span class="s5">(</span><span class="s2">elem</span><span class="s5">: </span><span class="s2">HTMLElement</span><span class="s5">) {</span>
                <span class="s2">elem</span><span class="s5">.</span><span class="s2">innerHTML </span><span class="s5">= </span><span class="s2">val</span>
            <span class="s5">})</span>
        <span class="s5">}</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 设置/获取 元素 html</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">val html 值</span>
     <span class="s0">*/</span>
    <span class="s2">html</span><span class="s5">(): </span><span class="s2">string</span>
    <span class="s2">html</span><span class="s5">(</span><span class="s2">val</span><span class="s5">: </span><span class="s2">string</span><span class="s5">): </span><span class="s2">DomElement</span>
    <span class="s2">html</span><span class="s5">(</span><span class="s2">val</span><span class="s5">?: </span><span class="s2">string</span><span class="s5">): </span><span class="s2">DomElement </span><span class="s5">| </span><span class="s2">string </span><span class="s5">{</span>
        <span class="s3">const </span><span class="s2">elem </span><span class="s5">= </span><span class="s3">this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span>
        <span class="s3">if </span><span class="s5">(!</span><span class="s2">val</span><span class="s5">) {</span>
            <span class="s6">// 获取 html</span>
            <span class="s3">return </span><span class="s2">elem</span><span class="s5">.</span><span class="s2">innerHTML</span>
        <span class="s5">} </span><span class="s3">else </span><span class="s5">{</span>
            <span class="s6">// 设置 html</span>
            <span class="s2">elem</span><span class="s5">.</span><span class="s2">innerHTML </span><span class="s5">= </span><span class="s2">val</span>
            <span class="s3">return this</span>
        <span class="s5">}</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 获取元素 value</span>
     <span class="s0">*/</span>
    <span class="s2">val</span><span class="s5">(): </span><span class="s2">string </span><span class="s5">{</span>
        <span class="s3">const </span><span class="s2">elem </span><span class="s5">= </span><span class="s3">this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span>
        <span class="s3">return </span><span class="s5">(</span><span class="s2">elem </span><span class="s5">as </span><span class="s2">any</span><span class="s5">).</span><span class="s2">value</span><span class="s5">.</span><span class="s2">trim</span><span class="s5">() </span><span class="s6">// 暂用 any</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* focus 到当前元素</span>
     <span class="s0">*/</span>
    <span class="s2">focus</span><span class="s5">(): </span><span class="s2">DomElement </span><span class="s5">{</span>
        <span class="s3">return this</span><span class="s5">.</span><span class="s2">forEach</span><span class="s5">(</span><span class="s2">elem </span><span class="s5">=&gt; {</span>
            <span class="s2">elem</span><span class="s5">.</span><span class="s2">focus</span><span class="s5">()</span>
        <span class="s5">})</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 当前元素前一个兄弟节点</span>
     <span class="s0">*/</span>
    <span class="s2">prev</span><span class="s5">(): </span><span class="s2">DomElement </span><span class="s5">{</span>
        <span class="s3">const </span><span class="s2">elem </span><span class="s5">= </span><span class="s3">this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span>
        <span class="s3">return </span><span class="s2">$</span><span class="s5">(</span><span class="s2">elem</span><span class="s5">.</span><span class="s2">previousElementSibling</span><span class="s5">)</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 当前元素后一个兄弟节点</span>
     <span class="s0">* 不包括文本节点、注释节点）</span>
     <span class="s0">*/</span>
    <span class="s2">next</span><span class="s5">(): </span><span class="s2">DomElement </span><span class="s5">{</span>
        <span class="s3">const </span><span class="s2">elem </span><span class="s5">= </span><span class="s3">this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span>
        <span class="s3">return </span><span class="s2">$</span><span class="s5">(</span><span class="s2">elem</span><span class="s5">.</span><span class="s2">nextElementSibling</span><span class="s5">)</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 获取当前节点的下一个兄弟节点</span>
     <span class="s0">* 包括文本节点、注释节点即回车、换行、空格、文本等等）</span>
     <span class="s0">*/</span>
    <span class="s2">getNextSibling</span><span class="s5">(): </span><span class="s2">DomElement </span><span class="s5">{</span>
        <span class="s3">const </span><span class="s2">elem </span><span class="s5">= </span><span class="s3">this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span>
        <span class="s3">return </span><span class="s2">$</span><span class="s5">(</span><span class="s2">elem</span><span class="s5">.</span><span class="s2">nextSibling</span><span class="s5">)</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 获取父元素</span>
     <span class="s0">*/</span>
    <span class="s2">parent</span><span class="s5">(): </span><span class="s2">DomElement </span><span class="s5">{</span>
        <span class="s3">const </span><span class="s2">elem </span><span class="s5">= </span><span class="s3">this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span>
        <span class="s3">return </span><span class="s2">$</span><span class="s5">(</span><span class="s2">elem</span><span class="s5">.</span><span class="s2">parentElement</span><span class="s5">)</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 查找父元素，直到满足 selector 条件</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">selector css 选择器</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">curElem 从哪个元素开始查找，默认为当前元素</span>
     <span class="s0">*/</span>
    <span class="s2">parentUntil</span><span class="s5">(</span><span class="s2">selector</span><span class="s5">: </span><span class="s2">string</span><span class="s5">, </span><span class="s2">curElem</span><span class="s5">?: </span><span class="s2">HTMLElement</span><span class="s5">): </span><span class="s2">DomElement </span><span class="s5">| </span><span class="s3">null </span><span class="s5">{</span>
        <span class="s3">const </span><span class="s2">elem </span><span class="s5">= </span><span class="s2">curElem </span><span class="s5">|| </span><span class="s3">this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span>
        <span class="s3">if </span><span class="s5">(</span><span class="s2">elem</span><span class="s5">.</span><span class="s2">nodeName </span><span class="s5">=== </span><span class="s4">'BODY'</span><span class="s5">) {</span>
            <span class="s3">return null</span>
        <span class="s5">}</span>

        <span class="s3">const </span><span class="s2">parent </span><span class="s5">= </span><span class="s2">elem</span><span class="s5">.</span><span class="s2">parentElement</span>
        <span class="s3">if </span><span class="s5">(</span><span class="s2">parent </span><span class="s5">=== </span><span class="s3">null</span><span class="s5">) {</span>
            <span class="s3">return null</span>
        <span class="s5">}</span>

        <span class="s3">if </span><span class="s5">(</span><span class="s2">parent</span><span class="s5">.</span><span class="s2">matches</span><span class="s5">(</span><span class="s2">selector</span><span class="s5">)) {</span>
            <span class="s6">// 找到，并返回</span>
            <span class="s3">return </span><span class="s2">$</span><span class="s5">(</span><span class="s2">parent</span><span class="s5">)</span>
        <span class="s5">}</span>

        <span class="s6">// 继续查找，递归</span>
        <span class="s3">return this</span><span class="s5">.</span><span class="s2">parentUntil</span><span class="s5">(</span><span class="s2">selector</span><span class="s5">, </span><span class="s2">parent</span><span class="s5">)</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 查找父元素，直到满足 selector 条件,或者 到达 编辑区域容器以及菜单栏容器</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">selector css 选择器</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">curElem 从哪个元素开始查找，默认为当前元素</span>
     <span class="s0">*/</span>
    <span class="s2">parentUntilEditor</span><span class="s5">(</span><span class="s2">selector</span><span class="s5">: </span><span class="s2">string</span><span class="s5">, </span><span class="s2">editor</span><span class="s5">: </span><span class="s2">Editor</span><span class="s5">, </span><span class="s2">curElem</span><span class="s5">?: </span><span class="s2">HTMLElement</span><span class="s5">): </span><span class="s2">DomElement </span><span class="s5">| </span><span class="s3">null </span><span class="s5">{</span>
        <span class="s3">const </span><span class="s2">elem </span><span class="s5">= </span><span class="s2">curElem </span><span class="s5">|| </span><span class="s3">this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span>
        <span class="s3">if </span><span class="s5">(</span><span class="s2">$</span><span class="s5">(</span><span class="s2">elem</span><span class="s5">).</span><span class="s2">equal</span><span class="s5">(</span><span class="s2">editor</span><span class="s5">.</span><span class="s2">$textContainerElem</span><span class="s5">) || </span><span class="s2">$</span><span class="s5">(</span><span class="s2">elem</span><span class="s5">).</span><span class="s2">equal</span><span class="s5">(</span><span class="s2">editor</span><span class="s5">.</span><span class="s2">$toolbarElem</span><span class="s5">)) {</span>
            <span class="s3">return null</span>
        <span class="s5">}</span>

        <span class="s3">const </span><span class="s2">parent </span><span class="s5">= </span><span class="s2">elem</span><span class="s5">.</span><span class="s2">parentElement</span>
        <span class="s3">if </span><span class="s5">(</span><span class="s2">parent </span><span class="s5">=== </span><span class="s3">null</span><span class="s5">) {</span>
            <span class="s3">return null</span>
        <span class="s5">}</span>

        <span class="s3">if </span><span class="s5">(</span><span class="s2">parent</span><span class="s5">.</span><span class="s2">matches</span><span class="s5">(</span><span class="s2">selector</span><span class="s5">)) {</span>
            <span class="s6">// 找到，并返回</span>
            <span class="s3">return </span><span class="s2">$</span><span class="s5">(</span><span class="s2">parent</span><span class="s5">)</span>
        <span class="s5">}</span>

        <span class="s6">// 继续查找，递归</span>
        <span class="s3">return this</span><span class="s5">.</span><span class="s2">parentUntilEditor</span><span class="s5">(</span><span class="s2">selector</span><span class="s5">, </span><span class="s2">editor</span><span class="s5">, </span><span class="s2">parent</span><span class="s5">)</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 判读是否相等</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">$elem 元素</span>
     <span class="s0">*/</span>
    <span class="s2">equal</span><span class="s5">(</span><span class="s2">$elem</span><span class="s5">: </span><span class="s2">DomElement </span><span class="s5">| </span><span class="s2">HTMLElement</span><span class="s5">): </span><span class="s2">boolean </span><span class="s5">{</span>
        <span class="s3">if </span><span class="s5">(</span><span class="s2">$elem </span><span class="s3">instanceof </span><span class="s2">DomElement</span><span class="s5">) {</span>
            <span class="s3">return this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s7">0</span><span class="s5">] === </span><span class="s2">$elem</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span>
        <span class="s5">} </span><span class="s3">else if </span><span class="s5">(</span><span class="s2">$elem </span><span class="s3">instanceof </span><span class="s2">HTMLElement</span><span class="s5">) {</span>
            <span class="s3">return this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s7">0</span><span class="s5">] === </span><span class="s2">$elem</span>
        <span class="s5">} </span><span class="s3">else </span><span class="s5">{</span>
            <span class="s3">return false</span>
        <span class="s5">}</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 将该元素插入到某个元素前面</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">selector css 选择器</span>
     <span class="s0">*/</span>
    <span class="s2">insertBefore</span><span class="s5">(</span><span class="s2">selector</span><span class="s5">: </span><span class="s2">string </span><span class="s5">| </span><span class="s2">DomElement</span><span class="s5">): </span><span class="s2">DomElement </span><span class="s5">{</span>
        <span class="s3">const </span><span class="s2">$referenceNode </span><span class="s5">= </span><span class="s2">$</span><span class="s5">(</span><span class="s2">selector</span><span class="s5">)</span>
        <span class="s3">const </span><span class="s2">referenceNode </span><span class="s5">= </span><span class="s2">$referenceNode</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span>
        <span class="s3">if </span><span class="s5">(!</span><span class="s2">referenceNode</span><span class="s5">) {</span>
            <span class="s3">return this</span>
        <span class="s5">}</span>
        <span class="s3">return this</span><span class="s5">.</span><span class="s2">forEach</span><span class="s5">(</span><span class="s2">elem </span><span class="s5">=&gt; {</span>
            <span class="s3">const </span><span class="s2">parent </span><span class="s5">= </span><span class="s2">referenceNode</span><span class="s5">.</span><span class="s2">parentNode </span><span class="s5">as </span><span class="s2">Node</span>
            <span class="s2">parent</span><span class="s5">?.</span><span class="s2">insertBefore</span><span class="s5">(</span><span class="s2">elem</span><span class="s5">, </span><span class="s2">referenceNode</span><span class="s5">)</span>
        <span class="s5">})</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 将该元素插入到selector元素后面</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">selector css 选择器</span>
     <span class="s0">*/</span>
    <span class="s2">insertAfter</span><span class="s5">(</span><span class="s2">selector</span><span class="s5">: </span><span class="s2">string </span><span class="s5">| </span><span class="s2">DomElement</span><span class="s5">): </span><span class="s2">DomElement </span><span class="s5">{</span>
        <span class="s3">const </span><span class="s2">$referenceNode </span><span class="s5">= </span><span class="s2">$</span><span class="s5">(</span><span class="s2">selector</span><span class="s5">)</span>
        <span class="s3">const </span><span class="s2">referenceNode </span><span class="s5">= </span><span class="s2">$referenceNode</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span>
        <span class="s3">const </span><span class="s2">anchorNode </span><span class="s5">= </span><span class="s2">referenceNode </span><span class="s5">&amp;&amp; </span><span class="s2">referenceNode</span><span class="s5">.</span><span class="s2">nextSibling</span>
        <span class="s3">if </span><span class="s5">(!</span><span class="s2">referenceNode</span><span class="s5">) {</span>
            <span class="s3">return this</span>
        <span class="s5">}</span>
        <span class="s3">return this</span><span class="s5">.</span><span class="s2">forEach</span><span class="s5">(</span><span class="s3">function </span><span class="s5">(</span><span class="s2">elem</span><span class="s5">: </span><span class="s2">HTMLElement</span><span class="s5">) {</span>
            <span class="s3">const </span><span class="s2">parent </span><span class="s5">= </span><span class="s2">referenceNode</span><span class="s5">.</span><span class="s2">parentNode </span><span class="s5">as </span><span class="s2">Node</span>
            <span class="s3">if </span><span class="s5">(</span><span class="s2">anchorNode</span><span class="s5">) {</span>
                <span class="s2">parent</span><span class="s5">.</span><span class="s2">insertBefore</span><span class="s5">(</span><span class="s2">elem</span><span class="s5">, </span><span class="s2">anchorNode</span><span class="s5">)</span>
            <span class="s5">} </span><span class="s3">else </span><span class="s5">{</span>
                <span class="s2">parent</span><span class="s5">.</span><span class="s2">appendChild</span><span class="s5">(</span><span class="s2">elem</span><span class="s5">)</span>
            <span class="s5">}</span>
        <span class="s5">})</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 设置/获取 数据</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">key key</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">value value</span>
     <span class="s0">*/</span>
    <span class="s2">data</span><span class="s5">&lt;</span><span class="s2">T</span><span class="s5">&gt;(</span><span class="s2">key</span><span class="s5">: </span><span class="s2">string</span><span class="s5">, </span><span class="s2">value</span><span class="s5">?: </span><span class="s2">T</span><span class="s5">): </span><span class="s2">T </span><span class="s5">| </span><span class="s2">undefined </span><span class="s5">{</span>
        <span class="s3">if </span><span class="s5">(</span><span class="s2">value </span><span class="s5">!= </span><span class="s3">null</span><span class="s5">) {</span>
            <span class="s6">// 设置数据</span>
            <span class="s3">this</span><span class="s5">.</span><span class="s2">dataSource</span><span class="s5">.</span><span class="s2">set</span><span class="s5">(</span><span class="s2">key</span><span class="s5">, </span><span class="s2">value</span><span class="s5">)</span>
        <span class="s5">} </span><span class="s3">else </span><span class="s5">{</span>
            <span class="s6">// 获取数据</span>
            <span class="s3">return this</span><span class="s5">.</span><span class="s2">dataSource</span><span class="s5">.</span><span class="s2">get</span><span class="s5">(</span><span class="s2">key</span><span class="s5">)</span>
        <span class="s5">}</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 获取当前节点的顶级(段落)</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">editor 富文本实例</span>
     <span class="s0">*/</span>
    <span class="s2">getNodeTop</span><span class="s5">(</span><span class="s2">editor</span><span class="s5">: </span><span class="s2">Editor</span><span class="s5">): </span><span class="s2">DomElement </span><span class="s5">{</span>
        <span class="s6">// 异常抛出，空的 DomElement 直接返回</span>
        <span class="s3">if </span><span class="s5">(</span><span class="s3">this</span><span class="s5">.</span><span class="s2">length </span><span class="s5">&lt; </span><span class="s7">1</span><span class="s5">) {</span>
            <span class="s3">return this</span>
        <span class="s5">}</span>

        <span class="s6">// 获取父级元素，并判断是否是 编辑区域</span>
        <span class="s6">// 如果是则返回当前节点</span>
        <span class="s3">const </span><span class="s2">$parent </span><span class="s5">= </span><span class="s3">this</span><span class="s5">.</span><span class="s2">parent</span><span class="s5">()</span>

        <span class="s6">// fix：添加当前元素与编辑区元素的比较，防止传入的当前元素就是编辑区元素而造成的获取顶级元素为空的情况</span>
        <span class="s3">if </span><span class="s5">(</span><span class="s2">editor</span><span class="s5">.</span><span class="s2">$textElem</span><span class="s5">.</span><span class="s2">equal</span><span class="s5">(</span><span class="s3">this</span><span class="s5">) || </span><span class="s2">editor</span><span class="s5">.</span><span class="s2">$textElem</span><span class="s5">.</span><span class="s2">equal</span><span class="s5">(</span><span class="s2">$parent</span><span class="s5">)) {</span>
            <span class="s3">return this</span>
        <span class="s5">}</span>

        <span class="s6">// 到了此处，即代表当前节点不是顶级段落</span>
        <span class="s6">// 将当前节点存放于父节点的 prior 字段下</span>
        <span class="s6">// 主要用于 回溯 子节点</span>
        <span class="s6">// 例如：ul ol 等标签</span>
        <span class="s6">// 实际操作的节点是 li 但是一个 ul ol 的子节点可能有多个</span>
        <span class="s6">// 所以需要对其进行 回溯 找到对应的子节点</span>
        <span class="s2">$parent</span><span class="s5">.</span><span class="s2">prior </span><span class="s5">= </span><span class="s3">this</span>
        <span class="s3">return </span><span class="s2">$parent</span><span class="s5">.</span><span class="s2">getNodeTop</span><span class="s5">(</span><span class="s2">editor</span><span class="s5">)</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 获取当前 节点 基与上一个拥有相对或者解决定位的父容器的位置</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">editor 富文本实例</span>
     <span class="s0">*/</span>
    <span class="s2">getOffsetData</span><span class="s5">(): </span><span class="s2">OffsetDataType </span><span class="s5">{</span>
        <span class="s3">const </span><span class="s2">$node </span><span class="s5">= </span><span class="s3">this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span>
        <span class="s3">return </span><span class="s5">{</span>
            <span class="s2">top</span><span class="s5">: </span><span class="s2">$node</span><span class="s5">.</span><span class="s2">offsetTop</span><span class="s5">,</span>
            <span class="s2">left</span><span class="s5">: </span><span class="s2">$node</span><span class="s5">.</span><span class="s2">offsetLeft</span><span class="s5">,</span>
            <span class="s2">width</span><span class="s5">: </span><span class="s2">$node</span><span class="s5">.</span><span class="s2">offsetWidth</span><span class="s5">,</span>
            <span class="s2">height</span><span class="s5">: </span><span class="s2">$node</span><span class="s5">.</span><span class="s2">offsetHeight</span><span class="s5">,</span>
            <span class="s2">parent</span><span class="s5">: </span><span class="s2">$node</span><span class="s5">.</span><span class="s2">offsetParent</span><span class="s5">,</span>
        <span class="s5">}</span>
    <span class="s5">}</span>

    <span class="s0">/**</span>
     <span class="s0">* 从上至下进行滚动</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">top 滚动的值</span>
     <span class="s0">*/</span>
    <span class="s2">scrollTop</span><span class="s5">(</span><span class="s2">top</span><span class="s5">: </span><span class="s2">number</span><span class="s5">): </span><span class="s3">void </span><span class="s5">{</span>
        <span class="s3">const </span><span class="s2">$node </span><span class="s5">= </span><span class="s3">this</span><span class="s5">.</span><span class="s2">elems</span><span class="s5">[</span><span class="s7">0</span><span class="s5">]</span>
        <span class="s2">$node</span><span class="s5">.</span><span class="s2">scrollTo</span><span class="s5">({ </span><span class="s2">top </span><span class="s5">})</span>
    <span class="s5">}</span>
<span class="s5">}</span>

<span class="s6">// new 一个对象</span>
<span class="s3">function </span><span class="s2">$</span><span class="s5">(</span><span class="s2">...arg</span><span class="s5">: </span><span class="s2">ConstructorParameters</span><span class="s5">&lt;</span><span class="s3">typeof </span><span class="s2">DomElement</span><span class="s5">&gt;): </span><span class="s2">DomElement </span><span class="s5">{</span>
    <span class="s3">return new </span><span class="s2">DomElement</span><span class="s5">(</span><span class="s2">...arg</span><span class="s5">)</span>
<span class="s5">}</span>

<span class="s3">export default </span><span class="s2">$</span>
</pre>
</body>
</html>