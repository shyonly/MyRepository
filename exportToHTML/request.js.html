<html>
<head>
<title>request.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #6aab73;}
.s3 { color: #bcbec4;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #67a37c; font-style: italic;}
.s6 { color: #cf8e6d;}
.s7 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
request.js</font>
</center></td></tr></table>
<pre><span class="s0">/*! 
 * express 
 * Copyright(c) 2009-2013 TJ Holowaychuk 
 * Copyright(c) 2013 Roman Shtylman 
 * Copyright(c) 2014-2015 Douglas Christopher Wilson 
 * MIT Licensed 
 */</span>

<span class="s2">'use strict'</span><span class="s3">;</span>

<span class="s4">/**</span>
 <span class="s4">* Module dependencies.</span>
 <span class="s4">* </span><span class="s5">@private</span>
 <span class="s4">*/</span>

<span class="s6">var </span><span class="s1">accepts </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'accepts'</span><span class="s3">);</span>
<span class="s6">var </span><span class="s1">deprecate </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'depd'</span><span class="s3">)(</span><span class="s2">'express'</span><span class="s3">);</span>
<span class="s6">var </span><span class="s1">isIP </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'net'</span><span class="s3">).</span><span class="s1">isIP</span><span class="s3">;</span>
<span class="s6">var </span><span class="s1">typeis </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'type-is'</span><span class="s3">);</span>
<span class="s6">var </span><span class="s1">http </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'http'</span><span class="s3">);</span>
<span class="s6">var </span><span class="s1">fresh </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'fresh'</span><span class="s3">);</span>
<span class="s6">var </span><span class="s1">parseRange </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'range-parser'</span><span class="s3">);</span>
<span class="s6">var </span><span class="s1">parse </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'parseurl'</span><span class="s3">);</span>
<span class="s6">var </span><span class="s1">proxyaddr </span><span class="s3">= </span><span class="s1">require</span><span class="s3">(</span><span class="s2">'proxy-addr'</span><span class="s3">);</span>

<span class="s4">/**</span>
 <span class="s4">* Request prototype.</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s6">var </span><span class="s1">req </span><span class="s3">= </span><span class="s1">Object</span><span class="s3">.</span><span class="s1">create</span><span class="s3">(</span><span class="s1">http</span><span class="s3">.</span><span class="s1">IncomingMessage</span><span class="s3">.</span><span class="s1">prototype</span><span class="s3">)</span>

<span class="s4">/**</span>
 <span class="s4">* Module exports.</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s1">module</span><span class="s3">.</span><span class="s1">exports </span><span class="s3">= </span><span class="s1">req</span>

<span class="s4">/**</span>
 <span class="s4">* Return request header.</span>
 <span class="s4">*</span>
 <span class="s4">* The `Referrer` header field is special-cased,</span>
 <span class="s4">* both `Referrer` and `Referer` are interchangeable.</span>
 <span class="s4">*</span>
 <span class="s4">* Examples:</span>
 <span class="s4">*</span>
 <span class="s4">*     req.get('Content-Type');</span>
 <span class="s4">*     // =&gt; &quot;text/plain&quot;</span>
 <span class="s4">*</span>
 <span class="s4">*     req.get('content-type');</span>
 <span class="s4">*     // =&gt; &quot;text/plain&quot;</span>
 <span class="s4">*</span>
 <span class="s4">*     req.get('Something');</span>
 <span class="s4">*     // =&gt; undefined</span>
 <span class="s4">*</span>
 <span class="s4">* Aliased as `req.header()`.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{String} name</span>
 <span class="s4">* </span><span class="s5">@return </span><span class="s4">{String}</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s1">req</span><span class="s3">.</span><span class="s1">get </span><span class="s3">=</span>
<span class="s1">req</span><span class="s3">.</span><span class="s1">header </span><span class="s3">= </span><span class="s6">function </span><span class="s1">header</span><span class="s3">(</span><span class="s1">name</span><span class="s3">) {</span>
  <span class="s6">if </span><span class="s3">(!</span><span class="s1">name</span><span class="s3">) {</span>
    <span class="s6">throw new </span><span class="s1">TypeError</span><span class="s3">(</span><span class="s2">'name argument is required to req.get'</span><span class="s3">);</span>
  <span class="s3">}</span>

  <span class="s6">if </span><span class="s3">(</span><span class="s6">typeof </span><span class="s1">name </span><span class="s3">!== </span><span class="s2">'string'</span><span class="s3">) {</span>
    <span class="s6">throw new </span><span class="s1">TypeError</span><span class="s3">(</span><span class="s2">'name must be a string to req.get'</span><span class="s3">);</span>
  <span class="s3">}</span>

  <span class="s6">var </span><span class="s1">lc </span><span class="s3">= </span><span class="s1">name</span><span class="s3">.</span><span class="s1">toLowerCase</span><span class="s3">();</span>

  <span class="s6">switch </span><span class="s3">(</span><span class="s1">lc</span><span class="s3">) {</span>
    <span class="s6">case </span><span class="s2">'referer'</span><span class="s3">:</span>
    <span class="s6">case </span><span class="s2">'referrer'</span><span class="s3">:</span>
      <span class="s6">return this</span><span class="s3">.</span><span class="s1">headers</span><span class="s3">.</span><span class="s1">referrer</span>
        <span class="s3">|| </span><span class="s6">this</span><span class="s3">.</span><span class="s1">headers</span><span class="s3">.</span><span class="s1">referer</span><span class="s3">;</span>
    <span class="s6">default</span><span class="s3">:</span>
      <span class="s6">return this</span><span class="s3">.</span><span class="s1">headers</span><span class="s3">[</span><span class="s1">lc</span><span class="s3">];</span>
  <span class="s3">}</span>
<span class="s3">};</span>

<span class="s4">/**</span>
 <span class="s4">* To do: update docs.</span>
 <span class="s4">*</span>
 <span class="s4">* Check if the given `type(s)` is acceptable, returning</span>
 <span class="s4">* the best match when true, otherwise `undefined`, in which</span>
 <span class="s4">* case you should respond with 406 &quot;Not Acceptable&quot;.</span>
 <span class="s4">*</span>
 <span class="s4">* The `type` value may be a single MIME type string</span>
 <span class="s4">* such as &quot;application/json&quot;, an extension name</span>
 <span class="s4">* such as &quot;json&quot;, a comma-delimited list such as &quot;json, html, text/plain&quot;,</span>
 <span class="s4">* an argument list such as `&quot;json&quot;, &quot;html&quot;, &quot;text/plain&quot;`,</span>
 <span class="s4">* or an array `[&quot;json&quot;, &quot;html&quot;, &quot;text/plain&quot;]`. When a list</span>
 <span class="s4">* or array is given, the _best_ match, if any is returned.</span>
 <span class="s4">*</span>
 <span class="s4">* Examples:</span>
 <span class="s4">*</span>
 <span class="s4">*     // Accept: text/html</span>
 <span class="s4">*     req.accepts('html');</span>
 <span class="s4">*     // =&gt; &quot;html&quot;</span>
 <span class="s4">*</span>
 <span class="s4">*     // Accept: text/*, application/json</span>
 <span class="s4">*     req.accepts('html');</span>
 <span class="s4">*     // =&gt; &quot;html&quot;</span>
 <span class="s4">*     req.accepts('text/html');</span>
 <span class="s4">*     // =&gt; &quot;text/html&quot;</span>
 <span class="s4">*     req.accepts('json, text');</span>
 <span class="s4">*     // =&gt; &quot;json&quot;</span>
 <span class="s4">*     req.accepts('application/json');</span>
 <span class="s4">*     // =&gt; &quot;application/json&quot;</span>
 <span class="s4">*</span>
 <span class="s4">*     // Accept: text/*, application/json</span>
 <span class="s4">*     req.accepts('image/png');</span>
 <span class="s4">*     req.accepts('png');</span>
 <span class="s4">*     // =&gt; undefined</span>
 <span class="s4">*</span>
 <span class="s4">*     // Accept: text/*;q=.5, application/json</span>
 <span class="s4">*     req.accepts(['html', 'json']);</span>
 <span class="s4">*     req.accepts('html', 'json');</span>
 <span class="s4">*     req.accepts('html, json');</span>
 <span class="s4">*     // =&gt; &quot;json&quot;</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{String|Array} type(s)</span>
 <span class="s4">* </span><span class="s5">@return </span><span class="s4">{String|Array|Boolean}</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s1">req</span><span class="s3">.</span><span class="s1">accepts </span><span class="s3">= </span><span class="s6">function</span><span class="s3">(){</span>
  <span class="s6">var </span><span class="s1">accept </span><span class="s3">= </span><span class="s1">accepts</span><span class="s3">(</span><span class="s6">this</span><span class="s3">);</span>
  <span class="s6">return </span><span class="s1">accept</span><span class="s3">.</span><span class="s1">types</span><span class="s3">.</span><span class="s1">apply</span><span class="s3">(</span><span class="s1">accept</span><span class="s3">, </span><span class="s1">arguments</span><span class="s3">);</span>
<span class="s3">};</span>

<span class="s4">/**</span>
 <span class="s4">* Check if the given `encoding`s are accepted.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{String} ...encoding</span>
 <span class="s4">* </span><span class="s5">@return </span><span class="s4">{String|Array}</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s1">req</span><span class="s3">.</span><span class="s1">acceptsEncodings </span><span class="s3">= </span><span class="s6">function</span><span class="s3">(){</span>
  <span class="s6">var </span><span class="s1">accept </span><span class="s3">= </span><span class="s1">accepts</span><span class="s3">(</span><span class="s6">this</span><span class="s3">);</span>
  <span class="s6">return </span><span class="s1">accept</span><span class="s3">.</span><span class="s1">encodings</span><span class="s3">.</span><span class="s1">apply</span><span class="s3">(</span><span class="s1">accept</span><span class="s3">, </span><span class="s1">arguments</span><span class="s3">);</span>
<span class="s3">};</span>

<span class="s1">req</span><span class="s3">.</span><span class="s1">acceptsEncoding </span><span class="s3">= </span><span class="s1">deprecate</span><span class="s3">.</span><span class="s1">function</span><span class="s3">(</span><span class="s1">req</span><span class="s3">.</span><span class="s1">acceptsEncodings</span><span class="s3">,</span>
  <span class="s2">'req.acceptsEncoding: Use acceptsEncodings instead'</span><span class="s3">);</span>

<span class="s4">/**</span>
 <span class="s4">* Check if the given `charset`s are acceptable,</span>
 <span class="s4">* otherwise you should respond with 406 &quot;Not Acceptable&quot;.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{String} ...charset</span>
 <span class="s4">* </span><span class="s5">@return </span><span class="s4">{String|Array}</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s1">req</span><span class="s3">.</span><span class="s1">acceptsCharsets </span><span class="s3">= </span><span class="s6">function</span><span class="s3">(){</span>
  <span class="s6">var </span><span class="s1">accept </span><span class="s3">= </span><span class="s1">accepts</span><span class="s3">(</span><span class="s6">this</span><span class="s3">);</span>
  <span class="s6">return </span><span class="s1">accept</span><span class="s3">.</span><span class="s1">charsets</span><span class="s3">.</span><span class="s1">apply</span><span class="s3">(</span><span class="s1">accept</span><span class="s3">, </span><span class="s1">arguments</span><span class="s3">);</span>
<span class="s3">};</span>

<span class="s1">req</span><span class="s3">.</span><span class="s1">acceptsCharset </span><span class="s3">= </span><span class="s1">deprecate</span><span class="s3">.</span><span class="s1">function</span><span class="s3">(</span><span class="s1">req</span><span class="s3">.</span><span class="s1">acceptsCharsets</span><span class="s3">,</span>
  <span class="s2">'req.acceptsCharset: Use acceptsCharsets instead'</span><span class="s3">);</span>

<span class="s4">/**</span>
 <span class="s4">* Check if the given `lang`s are acceptable,</span>
 <span class="s4">* otherwise you should respond with 406 &quot;Not Acceptable&quot;.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{String} ...lang</span>
 <span class="s4">* </span><span class="s5">@return </span><span class="s4">{String|Array}</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s1">req</span><span class="s3">.</span><span class="s1">acceptsLanguages </span><span class="s3">= </span><span class="s6">function</span><span class="s3">(){</span>
  <span class="s6">var </span><span class="s1">accept </span><span class="s3">= </span><span class="s1">accepts</span><span class="s3">(</span><span class="s6">this</span><span class="s3">);</span>
  <span class="s6">return </span><span class="s1">accept</span><span class="s3">.</span><span class="s1">languages</span><span class="s3">.</span><span class="s1">apply</span><span class="s3">(</span><span class="s1">accept</span><span class="s3">, </span><span class="s1">arguments</span><span class="s3">);</span>
<span class="s3">};</span>

<span class="s1">req</span><span class="s3">.</span><span class="s1">acceptsLanguage </span><span class="s3">= </span><span class="s1">deprecate</span><span class="s3">.</span><span class="s1">function</span><span class="s3">(</span><span class="s1">req</span><span class="s3">.</span><span class="s1">acceptsLanguages</span><span class="s3">,</span>
  <span class="s2">'req.acceptsLanguage: Use acceptsLanguages instead'</span><span class="s3">);</span>

<span class="s4">/**</span>
 <span class="s4">* Parse Range header field, capping to the given `size`.</span>
 <span class="s4">*</span>
 <span class="s4">* Unspecified ranges such as &quot;0-&quot; require knowledge of your resource length. In</span>
 <span class="s4">* the case of a byte range this is of course the total number of bytes. If the</span>
 <span class="s4">* Range header field is not given `undefined` is returned, `-1` when unsatisfiable,</span>
 <span class="s4">* and `-2` when syntactically invalid.</span>
 <span class="s4">*</span>
 <span class="s4">* When ranges are returned, the array has a &quot;type&quot; property which is the type of</span>
 <span class="s4">* range that is required (most commonly, &quot;bytes&quot;). Each array element is an object</span>
 <span class="s4">* with a &quot;start&quot; and &quot;end&quot; property for the portion of the range.</span>
 <span class="s4">*</span>
 <span class="s4">* The &quot;combine&quot; option can be set to `true` and overlapping &amp; adjacent ranges</span>
 <span class="s4">* will be combined into a single range.</span>
 <span class="s4">*</span>
 <span class="s4">* NOTE: remember that ranges are inclusive, so for example &quot;Range: users=0-3&quot;</span>
 <span class="s4">* should respond with 4 users when available, not 3.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{number} size</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{object} [options]</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{boolean} [options.combine=false]</span>
 <span class="s4">* </span><span class="s5">@return </span><span class="s4">{number|array}</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s1">req</span><span class="s3">.</span><span class="s1">range </span><span class="s3">= </span><span class="s6">function </span><span class="s1">range</span><span class="s3">(</span><span class="s1">size</span><span class="s3">, </span><span class="s1">options</span><span class="s3">) {</span>
  <span class="s6">var </span><span class="s1">range </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s2">'Range'</span><span class="s3">);</span>
  <span class="s6">if </span><span class="s3">(!</span><span class="s1">range</span><span class="s3">) </span><span class="s6">return</span><span class="s3">;</span>
  <span class="s6">return </span><span class="s1">parseRange</span><span class="s3">(</span><span class="s1">size</span><span class="s3">, </span><span class="s1">range</span><span class="s3">, </span><span class="s1">options</span><span class="s3">);</span>
<span class="s3">};</span>

<span class="s4">/**</span>
 <span class="s4">* Return the value of param `name` when present or `defaultValue`.</span>
 <span class="s4">*</span>
 <span class="s4">*  - Checks route placeholders, ex: _/user/:id_</span>
 <span class="s4">*  - Checks body params, ex: id=12, {&quot;id&quot;:12}</span>
 <span class="s4">*  - Checks query string params, ex: ?id=12</span>
 <span class="s4">*</span>
 <span class="s4">* To utilize request bodies, `req.body`</span>
 <span class="s4">* should be an object. This can be done by using</span>
 <span class="s4">* the `bodyParser()` middleware.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{String} name</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Mixed} [defaultValue]</span>
 <span class="s4">* </span><span class="s5">@return </span><span class="s4">{String}</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s1">req</span><span class="s3">.</span><span class="s1">param </span><span class="s3">= </span><span class="s6">function </span><span class="s1">param</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">defaultValue</span><span class="s3">) {</span>
  <span class="s6">var </span><span class="s1">params </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">params </span><span class="s3">|| {};</span>
  <span class="s6">var </span><span class="s1">body </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">body </span><span class="s3">|| {};</span>
  <span class="s6">var </span><span class="s1">query </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">query </span><span class="s3">|| {};</span>

  <span class="s6">var </span><span class="s1">args </span><span class="s3">= </span><span class="s1">arguments</span><span class="s3">.</span><span class="s1">length </span><span class="s3">=== </span><span class="s7">1</span>
    <span class="s3">? </span><span class="s2">'name'</span>
    <span class="s3">: </span><span class="s2">'name, default'</span><span class="s3">;</span>
  <span class="s1">deprecate</span><span class="s3">(</span><span class="s2">'req.param(' </span><span class="s3">+ </span><span class="s1">args </span><span class="s3">+ </span><span class="s2">'): Use req.params, req.body, or req.query instead'</span><span class="s3">);</span>

  <span class="s6">if </span><span class="s3">(</span><span class="s6">null </span><span class="s3">!= </span><span class="s1">params</span><span class="s3">[</span><span class="s1">name</span><span class="s3">] &amp;&amp; </span><span class="s1">params</span><span class="s3">.</span><span class="s1">hasOwnProperty</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)) </span><span class="s6">return </span><span class="s1">params</span><span class="s3">[</span><span class="s1">name</span><span class="s3">];</span>
  <span class="s6">if </span><span class="s3">(</span><span class="s6">null </span><span class="s3">!= </span><span class="s1">body</span><span class="s3">[</span><span class="s1">name</span><span class="s3">]) </span><span class="s6">return </span><span class="s1">body</span><span class="s3">[</span><span class="s1">name</span><span class="s3">];</span>
  <span class="s6">if </span><span class="s3">(</span><span class="s6">null </span><span class="s3">!= </span><span class="s1">query</span><span class="s3">[</span><span class="s1">name</span><span class="s3">]) </span><span class="s6">return </span><span class="s1">query</span><span class="s3">[</span><span class="s1">name</span><span class="s3">];</span>

  <span class="s6">return </span><span class="s1">defaultValue</span><span class="s3">;</span>
<span class="s3">};</span>

<span class="s4">/**</span>
 <span class="s4">* Check if the incoming request contains the &quot;Content-Type&quot;</span>
 <span class="s4">* header field, and it contains the given mime `type`.</span>
 <span class="s4">*</span>
 <span class="s4">* Examples:</span>
 <span class="s4">*</span>
 <span class="s4">*      // With Content-Type: text/html; charset=utf-8</span>
 <span class="s4">*      req.is('html');</span>
 <span class="s4">*      req.is('text/html');</span>
 <span class="s4">*      req.is('text/*');</span>
 <span class="s4">*      // =&gt; true</span>
 <span class="s4">*</span>
 <span class="s4">*      // When Content-Type is application/json</span>
 <span class="s4">*      req.is('json');</span>
 <span class="s4">*      req.is('application/json');</span>
 <span class="s4">*      req.is('application/*');</span>
 <span class="s4">*      // =&gt; true</span>
 <span class="s4">*</span>
 <span class="s4">*      req.is('html');</span>
 <span class="s4">*      // =&gt; false</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{String|Array} types...</span>
 <span class="s4">* </span><span class="s5">@return </span><span class="s4">{String|false|null}</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s1">req</span><span class="s3">.</span><span class="s1">is </span><span class="s3">= </span><span class="s6">function </span><span class="s1">is</span><span class="s3">(</span><span class="s1">types</span><span class="s3">) {</span>
  <span class="s6">var </span><span class="s1">arr </span><span class="s3">= </span><span class="s1">types</span><span class="s3">;</span>

  <span class="s0">// support flattened arguments</span>
  <span class="s6">if </span><span class="s3">(!</span><span class="s1">Array</span><span class="s3">.</span><span class="s1">isArray</span><span class="s3">(</span><span class="s1">types</span><span class="s3">)) {</span>
    <span class="s1">arr </span><span class="s3">= </span><span class="s6">new </span><span class="s1">Array</span><span class="s3">(</span><span class="s1">arguments</span><span class="s3">.</span><span class="s1">length</span><span class="s3">);</span>
    <span class="s6">for </span><span class="s3">(</span><span class="s6">var </span><span class="s1">i </span><span class="s3">= </span><span class="s7">0</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">arr</span><span class="s3">.</span><span class="s1">length</span><span class="s3">; </span><span class="s1">i</span><span class="s3">++) {</span>
      <span class="s1">arr</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s1">arguments</span><span class="s3">[</span><span class="s1">i</span><span class="s3">];</span>
    <span class="s3">}</span>
  <span class="s3">}</span>

  <span class="s6">return </span><span class="s1">typeis</span><span class="s3">(</span><span class="s6">this</span><span class="s3">, </span><span class="s1">arr</span><span class="s3">);</span>
<span class="s3">};</span>

<span class="s4">/**</span>
 <span class="s4">* Return the protocol string &quot;http&quot; or &quot;https&quot;</span>
 <span class="s4">* when requested with TLS. When the &quot;trust proxy&quot;</span>
 <span class="s4">* setting trusts the socket address, the</span>
 <span class="s4">* &quot;X-Forwarded-Proto&quot; header field will be trusted</span>
 <span class="s4">* and used if present.</span>
 <span class="s4">*</span>
 <span class="s4">* If you're running behind a reverse proxy that</span>
 <span class="s4">* supplies https for you this may be enabled.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@return </span><span class="s4">{String}</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s1">defineGetter</span><span class="s3">(</span><span class="s1">req</span><span class="s3">, </span><span class="s2">'protocol'</span><span class="s3">, </span><span class="s6">function </span><span class="s1">protocol</span><span class="s3">(){</span>
  <span class="s6">var </span><span class="s1">proto </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">connection</span><span class="s3">.</span><span class="s1">encrypted</span>
    <span class="s3">? </span><span class="s2">'https'</span>
    <span class="s3">: </span><span class="s2">'http'</span><span class="s3">;</span>
  <span class="s6">var </span><span class="s1">trust </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">app</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s2">'trust proxy fn'</span><span class="s3">);</span>

  <span class="s6">if </span><span class="s3">(!</span><span class="s1">trust</span><span class="s3">(</span><span class="s6">this</span><span class="s3">.</span><span class="s1">connection</span><span class="s3">.</span><span class="s1">remoteAddress</span><span class="s3">, </span><span class="s7">0</span><span class="s3">)) {</span>
    <span class="s6">return </span><span class="s1">proto</span><span class="s3">;</span>
  <span class="s3">}</span>

  <span class="s0">// Note: X-Forwarded-Proto is normally only ever a</span>
  <span class="s0">//       single value, but this is to be safe.</span>
  <span class="s6">var </span><span class="s1">header </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s2">'X-Forwarded-Proto'</span><span class="s3">) || </span><span class="s1">proto</span>
  <span class="s6">var </span><span class="s1">index </span><span class="s3">= </span><span class="s1">header</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s2">','</span><span class="s3">)</span>

  <span class="s6">return </span><span class="s1">index </span><span class="s3">!== -</span><span class="s7">1</span>
    <span class="s3">? </span><span class="s1">header</span><span class="s3">.</span><span class="s1">substring</span><span class="s3">(</span><span class="s7">0</span><span class="s3">, </span><span class="s1">index</span><span class="s3">).</span><span class="s1">trim</span><span class="s3">()</span>
    <span class="s3">: </span><span class="s1">header</span><span class="s3">.</span><span class="s1">trim</span><span class="s3">()</span>
<span class="s3">});</span>

<span class="s4">/**</span>
 <span class="s4">* Short-hand for:</span>
 <span class="s4">*</span>
 <span class="s4">*    req.protocol === 'https'</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@return </span><span class="s4">{Boolean}</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s1">defineGetter</span><span class="s3">(</span><span class="s1">req</span><span class="s3">, </span><span class="s2">'secure'</span><span class="s3">, </span><span class="s6">function </span><span class="s1">secure</span><span class="s3">(){</span>
  <span class="s6">return this</span><span class="s3">.</span><span class="s1">protocol </span><span class="s3">=== </span><span class="s2">'https'</span><span class="s3">;</span>
<span class="s3">});</span>

<span class="s4">/**</span>
 <span class="s4">* Return the remote address from the trusted proxy.</span>
 <span class="s4">*</span>
 <span class="s4">* The is the remote address on the socket unless</span>
 <span class="s4">* &quot;trust proxy&quot; is set.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@return </span><span class="s4">{String}</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s1">defineGetter</span><span class="s3">(</span><span class="s1">req</span><span class="s3">, </span><span class="s2">'ip'</span><span class="s3">, </span><span class="s6">function </span><span class="s1">ip</span><span class="s3">(){</span>
  <span class="s6">var </span><span class="s1">trust </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">app</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s2">'trust proxy fn'</span><span class="s3">);</span>
  <span class="s6">return </span><span class="s1">proxyaddr</span><span class="s3">(</span><span class="s6">this</span><span class="s3">, </span><span class="s1">trust</span><span class="s3">);</span>
<span class="s3">});</span>

<span class="s4">/**</span>
 <span class="s4">* When &quot;trust proxy&quot; is set, trusted proxy addresses + client.</span>
 <span class="s4">*</span>
 <span class="s4">* For example if the value were &quot;client, proxy1, proxy2&quot;</span>
 <span class="s4">* you would receive the array `[&quot;client&quot;, &quot;proxy1&quot;, &quot;proxy2&quot;]`</span>
 <span class="s4">* where &quot;proxy2&quot; is the furthest down-stream and &quot;proxy1&quot; and</span>
 <span class="s4">* &quot;proxy2&quot; were trusted.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@return </span><span class="s4">{Array}</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s1">defineGetter</span><span class="s3">(</span><span class="s1">req</span><span class="s3">, </span><span class="s2">'ips'</span><span class="s3">, </span><span class="s6">function </span><span class="s1">ips</span><span class="s3">() {</span>
  <span class="s6">var </span><span class="s1">trust </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">app</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s2">'trust proxy fn'</span><span class="s3">);</span>
  <span class="s6">var </span><span class="s1">addrs </span><span class="s3">= </span><span class="s1">proxyaddr</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s6">this</span><span class="s3">, </span><span class="s1">trust</span><span class="s3">);</span>

  <span class="s0">// reverse the order (to farthest -&gt; closest)</span>
  <span class="s0">// and remove socket address</span>
  <span class="s1">addrs</span><span class="s3">.</span><span class="s1">reverse</span><span class="s3">().</span><span class="s1">pop</span><span class="s3">()</span>

  <span class="s6">return </span><span class="s1">addrs</span>
<span class="s3">});</span>

<span class="s4">/**</span>
 <span class="s4">* Return subdomains as an array.</span>
 <span class="s4">*</span>
 <span class="s4">* Subdomains are the dot-separated parts of the host before the main domain of</span>
 <span class="s4">* the app. By default, the domain of the app is assumed to be the last two</span>
 <span class="s4">* parts of the host. This can be changed by setting &quot;subdomain offset&quot;.</span>
 <span class="s4">*</span>
 <span class="s4">* For example, if the domain is &quot;tobi.ferrets.example.com&quot;:</span>
 <span class="s4">* If &quot;subdomain offset&quot; is not set, req.subdomains is `[&quot;ferrets&quot;, &quot;tobi&quot;]`.</span>
 <span class="s4">* If &quot;subdomain offset&quot; is 3, req.subdomains is `[&quot;tobi&quot;]`.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@return </span><span class="s4">{Array}</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s1">defineGetter</span><span class="s3">(</span><span class="s1">req</span><span class="s3">, </span><span class="s2">'subdomains'</span><span class="s3">, </span><span class="s6">function </span><span class="s1">subdomains</span><span class="s3">() {</span>
  <span class="s6">var </span><span class="s1">hostname </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">hostname</span><span class="s3">;</span>

  <span class="s6">if </span><span class="s3">(!</span><span class="s1">hostname</span><span class="s3">) </span><span class="s6">return </span><span class="s3">[];</span>

  <span class="s6">var </span><span class="s1">offset </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">app</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s2">'subdomain offset'</span><span class="s3">);</span>
  <span class="s6">var </span><span class="s1">subdomains </span><span class="s3">= !</span><span class="s1">isIP</span><span class="s3">(</span><span class="s1">hostname</span><span class="s3">)</span>
    <span class="s3">? </span><span class="s1">hostname</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s2">'.'</span><span class="s3">).</span><span class="s1">reverse</span><span class="s3">()</span>
    <span class="s3">: [</span><span class="s1">hostname</span><span class="s3">];</span>

  <span class="s6">return </span><span class="s1">subdomains</span><span class="s3">.</span><span class="s1">slice</span><span class="s3">(</span><span class="s1">offset</span><span class="s3">);</span>
<span class="s3">});</span>

<span class="s4">/**</span>
 <span class="s4">* Short-hand for `url.parse(req.url).pathname`.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@return </span><span class="s4">{String}</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s1">defineGetter</span><span class="s3">(</span><span class="s1">req</span><span class="s3">, </span><span class="s2">'path'</span><span class="s3">, </span><span class="s6">function </span><span class="s1">path</span><span class="s3">() {</span>
  <span class="s6">return </span><span class="s1">parse</span><span class="s3">(</span><span class="s6">this</span><span class="s3">).</span><span class="s1">pathname</span><span class="s3">;</span>
<span class="s3">});</span>

<span class="s4">/**</span>
 <span class="s4">* Parse the &quot;Host&quot; header field to a hostname.</span>
 <span class="s4">*</span>
 <span class="s4">* When the &quot;trust proxy&quot; setting trusts the socket</span>
 <span class="s4">* address, the &quot;X-Forwarded-Host&quot; header field will</span>
 <span class="s4">* be trusted.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@return </span><span class="s4">{String}</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s1">defineGetter</span><span class="s3">(</span><span class="s1">req</span><span class="s3">, </span><span class="s2">'hostname'</span><span class="s3">, </span><span class="s6">function </span><span class="s1">hostname</span><span class="s3">(){</span>
  <span class="s6">var </span><span class="s1">trust </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">app</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s2">'trust proxy fn'</span><span class="s3">);</span>
  <span class="s6">var </span><span class="s1">host </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s2">'X-Forwarded-Host'</span><span class="s3">);</span>

  <span class="s6">if </span><span class="s3">(!</span><span class="s1">host </span><span class="s3">|| !</span><span class="s1">trust</span><span class="s3">(</span><span class="s6">this</span><span class="s3">.</span><span class="s1">connection</span><span class="s3">.</span><span class="s1">remoteAddress</span><span class="s3">, </span><span class="s7">0</span><span class="s3">)) {</span>
    <span class="s1">host </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s2">'Host'</span><span class="s3">);</span>
  <span class="s3">} </span><span class="s6">else if </span><span class="s3">(</span><span class="s1">host</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s2">','</span><span class="s3">) !== -</span><span class="s7">1</span><span class="s3">) {</span>
    <span class="s0">// Note: X-Forwarded-Host is normally only ever a</span>
    <span class="s0">//       single value, but this is to be safe.</span>
    <span class="s1">host </span><span class="s3">= </span><span class="s1">host</span><span class="s3">.</span><span class="s1">substring</span><span class="s3">(</span><span class="s7">0</span><span class="s3">, </span><span class="s1">host</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s2">','</span><span class="s3">)).</span><span class="s1">trimRight</span><span class="s3">()</span>
  <span class="s3">}</span>

  <span class="s6">if </span><span class="s3">(!</span><span class="s1">host</span><span class="s3">) </span><span class="s6">return</span><span class="s3">;</span>

  <span class="s0">// IPv6 literal support</span>
  <span class="s6">var </span><span class="s1">offset </span><span class="s3">= </span><span class="s1">host</span><span class="s3">[</span><span class="s7">0</span><span class="s3">] === </span><span class="s2">'['</span>
    <span class="s3">? </span><span class="s1">host</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s2">']'</span><span class="s3">) + </span><span class="s7">1</span>
    <span class="s3">: </span><span class="s7">0</span><span class="s3">;</span>
  <span class="s6">var </span><span class="s1">index </span><span class="s3">= </span><span class="s1">host</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s2">':'</span><span class="s3">, </span><span class="s1">offset</span><span class="s3">);</span>

  <span class="s6">return </span><span class="s1">index </span><span class="s3">!== -</span><span class="s7">1</span>
    <span class="s3">? </span><span class="s1">host</span><span class="s3">.</span><span class="s1">substring</span><span class="s3">(</span><span class="s7">0</span><span class="s3">, </span><span class="s1">index</span><span class="s3">)</span>
    <span class="s3">: </span><span class="s1">host</span><span class="s3">;</span>
<span class="s3">});</span>

<span class="s0">// TODO: change req.host to return host in next major</span>

<span class="s1">defineGetter</span><span class="s3">(</span><span class="s1">req</span><span class="s3">, </span><span class="s2">'host'</span><span class="s3">, </span><span class="s1">deprecate</span><span class="s3">.</span><span class="s1">function</span><span class="s3">(</span><span class="s6">function </span><span class="s1">host</span><span class="s3">(){</span>
  <span class="s6">return this</span><span class="s3">.</span><span class="s1">hostname</span><span class="s3">;</span>
<span class="s3">}, </span><span class="s2">'req.host: Use req.hostname instead'</span><span class="s3">));</span>

<span class="s4">/**</span>
 <span class="s4">* Check if the request is fresh, aka</span>
 <span class="s4">* Last-Modified and/or the ETag</span>
 <span class="s4">* still match.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@return </span><span class="s4">{Boolean}</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s1">defineGetter</span><span class="s3">(</span><span class="s1">req</span><span class="s3">, </span><span class="s2">'fresh'</span><span class="s3">, </span><span class="s6">function</span><span class="s3">(){</span>
  <span class="s6">var </span><span class="s1">method </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">method</span><span class="s3">;</span>
  <span class="s6">var </span><span class="s1">res </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">res</span>
  <span class="s6">var </span><span class="s1">status </span><span class="s3">= </span><span class="s1">res</span><span class="s3">.</span><span class="s1">statusCode</span>

  <span class="s0">// GET or HEAD for weak freshness validation only</span>
  <span class="s6">if </span><span class="s3">(</span><span class="s2">'GET' </span><span class="s3">!== </span><span class="s1">method </span><span class="s3">&amp;&amp; </span><span class="s2">'HEAD' </span><span class="s3">!== </span><span class="s1">method</span><span class="s3">) </span><span class="s6">return false</span><span class="s3">;</span>

  <span class="s0">// 2xx or 304 as per rfc2616 14.26</span>
  <span class="s6">if </span><span class="s3">((</span><span class="s1">status </span><span class="s3">&gt;= </span><span class="s7">200 </span><span class="s3">&amp;&amp; </span><span class="s1">status </span><span class="s3">&lt; </span><span class="s7">300</span><span class="s3">) || </span><span class="s7">304 </span><span class="s3">=== </span><span class="s1">status</span><span class="s3">) {</span>
    <span class="s6">return </span><span class="s1">fresh</span><span class="s3">(</span><span class="s6">this</span><span class="s3">.</span><span class="s1">headers</span><span class="s3">, {</span>
      <span class="s2">'etag'</span><span class="s3">: </span><span class="s1">res</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s2">'ETag'</span><span class="s3">),</span>
      <span class="s2">'last-modified'</span><span class="s3">: </span><span class="s1">res</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s2">'Last-Modified'</span><span class="s3">)</span>
    <span class="s3">})</span>
  <span class="s3">}</span>

  <span class="s6">return false</span><span class="s3">;</span>
<span class="s3">});</span>

<span class="s4">/**</span>
 <span class="s4">* Check if the request is stale, aka</span>
 <span class="s4">* &quot;Last-Modified&quot; and / or the &quot;ETag&quot; for the</span>
 <span class="s4">* resource has changed.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@return </span><span class="s4">{Boolean}</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s1">defineGetter</span><span class="s3">(</span><span class="s1">req</span><span class="s3">, </span><span class="s2">'stale'</span><span class="s3">, </span><span class="s6">function </span><span class="s1">stale</span><span class="s3">(){</span>
  <span class="s6">return </span><span class="s3">!</span><span class="s6">this</span><span class="s3">.</span><span class="s1">fresh</span><span class="s3">;</span>
<span class="s3">});</span>

<span class="s4">/**</span>
 <span class="s4">* Check if the request was an _XMLHttpRequest_.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@return </span><span class="s4">{Boolean}</span>
 <span class="s4">* </span><span class="s5">@public</span>
 <span class="s4">*/</span>

<span class="s1">defineGetter</span><span class="s3">(</span><span class="s1">req</span><span class="s3">, </span><span class="s2">'xhr'</span><span class="s3">, </span><span class="s6">function </span><span class="s1">xhr</span><span class="s3">(){</span>
  <span class="s6">var </span><span class="s1">val </span><span class="s3">= </span><span class="s6">this</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s2">'X-Requested-With'</span><span class="s3">) || </span><span class="s2">''</span><span class="s3">;</span>
  <span class="s6">return </span><span class="s1">val</span><span class="s3">.</span><span class="s1">toLowerCase</span><span class="s3">() === </span><span class="s2">'xmlhttprequest'</span><span class="s3">;</span>
<span class="s3">});</span>

<span class="s4">/**</span>
 <span class="s4">* Helper function for creating a getter on an object.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Object} obj</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{String} name</span>
 <span class="s4">* </span><span class="s5">@param </span><span class="s4">{Function} getter</span>
 <span class="s4">* </span><span class="s5">@private</span>
 <span class="s4">*/</span>
<span class="s6">function </span><span class="s1">defineGetter</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">getter</span><span class="s3">) {</span>
  <span class="s1">Object</span><span class="s3">.</span><span class="s1">defineProperty</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, {</span>
    <span class="s1">configurable</span><span class="s3">: </span><span class="s6">true</span><span class="s3">,</span>
    <span class="s1">enumerable</span><span class="s3">: </span><span class="s6">true</span><span class="s3">,</span>
    <span class="s1">get</span><span class="s3">: </span><span class="s1">getter</span>
  <span class="s3">});</span>
<span class="s3">}</span>
</pre>
</body>
</html>